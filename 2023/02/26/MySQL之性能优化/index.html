<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/themes/blue/pace-theme-minimal.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.0.2/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xiaguyangdie.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="MySQL提升篇">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL提升篇">
<meta property="og:url" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/index.html">
<meta property="og:site_name" content="峡谷杨爹的个人博客">
<meta property="og:description" content="MySQL提升篇">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013190815655.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013192301690.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013192453985.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013192711937.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013212922600.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014142535800.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014144023543.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014144952866.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014145025233.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014145148694.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014145105046.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014145700192.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014145722016.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014150122360.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014150241215.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014150524467.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221014155513382.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015150918198.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151121435.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151407725.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151517670.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151434681.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151605979.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151650097.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015151844547-16658184793351.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152154609.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152230681.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152308340.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152444960.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152519218.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152631505.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015152924832.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015153244828.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015153502877.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015153641389.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015154310303.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015154608516.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015154719858.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015194228445.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015194402069.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015194324301.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015194508009.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195244396.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195329278.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195403473.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195540148.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195730217.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015195850429.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015200055465.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015200329785.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015200656519.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015200818953.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015201018668.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015201049819.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015201130083.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015200922169.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015203350293.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015203449088.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015203659112.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015203803067.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015203901765.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015204307122.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015204928863.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015205008943.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015205045048.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221015205605464.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016225533392.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016231340323.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016231303026.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016231618032.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016232221966.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016232249706.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016232318206.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221016233053531.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134213282.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134306022.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134402096.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134458131.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134546656.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134711002.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017134747423.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017142854189.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143038581.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143147180.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143240609.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143347787.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143458976.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143547166.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143625870.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143706735.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017143740253.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017160328624.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017161554061.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017161634006.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017180525663.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017180611415.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017180651414.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017180907833.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017180944969.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181124151-16660014859301.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181202163.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181321085.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181406135.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181444132.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017151825075.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181543392.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181624307.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017152011435.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181717225.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181746984.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017181901921.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017153318416.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182121058.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182213614.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182240479.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182303546.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017183025980.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017183138754.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017183241950.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182418009.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017185212485.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182455733.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182530785.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182601773.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182625921.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182649654.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017182717560.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017190305789.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017190326247.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017190424653.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017190452348.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017201209929.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017212008013.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017212133270.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221017212209225.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221018133011491.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221018133044570.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221018134857657.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221018134933092.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221020140220340.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221020141845067.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736718-1767374266.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736483-1854082855.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736269-113188414.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221020231406773.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013735094-2026977128.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221101195450488.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221101225235963.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221104162007491.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110211904104-16680863687081.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110211933295.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110212037886.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110212243970.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110212418063.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110212904697.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110213106043.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110213334534.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110214004910.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110231237263.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110232354941.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110231605795.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110231909383.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110232016329.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221110233004330.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111125950470.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111130108956.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111130140046.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111130217820.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111130338316.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111130408341.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111000125169.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111000142712.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221111211632477.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221112124713746.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221112142049242.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221112142120028.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221112174656304.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221112174745396.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221113210451607.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221114165606939.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115202538135.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115202849458.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115202746642.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115202942712.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203053748.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203208318.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203430082.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203349545.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203535275.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203626010.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115203656245.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221115214516086.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221116145136711.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E7%9A%84%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E8%AF%B4%E6%98%8E.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/connectors.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221116155754346.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AE%80%E5%8C%96%E7%89%88MySQL%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%A7%A3%E6%9E%90%E5%99%A8.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%AF%AD%E6%B3%95%E6%A0%91.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BC%98%E5%8C%96%E5%99%A8.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E6%89%A7%E8%A1%8C%E5%99%A8.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/MySQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221117144231350.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/SQL%E8%AF%AD%E6%B3%95%E9%A1%BA%E5%BA%8F.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%9E%B6%E6%9E%84%E5%9B%BE.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%9E%B6%E6%9E%84%E5%9B%BE%E7%AE%80%E5%9B%BE.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%BC%93%E5%86%B2%E6%B1%A0.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E4%BD%9C%E7%94%A8.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E9%BB%91%E7%9B%92%E4%B8%8B%E7%9A%84%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BA%8C%E5%8F%89%E6%A0%91.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BA%8C%E5%8F%89%E6%A0%91%E6%96%87%E5%AD%97.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125135047152.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125135401382.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125135435664.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125143825892.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125144315455.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125145227224.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125150014804.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125143225533.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125174429599.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125205359476.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125211436009.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125212126795.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125222805959.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125223512909.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125223648404.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125223715177.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125223834861.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125224140120.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221125224229862.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126150705142.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126152432398.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126154641774.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126154752128.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126155001288.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126155034671.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126160053220.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221126160109505.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128095132392.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128095309295.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128095358536.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128100238559.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128100927058.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128101014882.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128101511285.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128101644383.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128101847061.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128102555811.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128102834945.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128141510370.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128142327953.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221128143210208.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221129161453822.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221129205043413.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201151921091.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201152621193.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201154417352.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201155707219.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201160825236.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221201161128834.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221202134307759.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221202134549176.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221205171138154.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221206154234789.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221206154325641.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/QQ%E6%88%AA%E5%9B%BE20221206163721.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221206210449631.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221206210842894.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221206212521714.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208140141162.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208140159657.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208170936996.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208213932349.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208214026963.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208214122375.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208214154244.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208215518466.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208215604030.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208230221865.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221208230510678.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209150809581.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209150839138.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209150913205.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209151518348.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209151558644.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209160649192.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209224224867.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221209231303743.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210164115069.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210164445509.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210164844392.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210165234750.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210170305362.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210193204029.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210193318107.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210193355235.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210193504905.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210193541614.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221210213744166.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211195815164.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211200237867.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211201810557.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211202621151.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211202707200.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211203039274.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211203410983.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211203543705.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210202947.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210309690.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210352982.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210440697.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210605042.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211210637414.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211212531222.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211212709196.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211212744097.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211213616332.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211220138069.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211220714286.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211220822732.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211221012802.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211221106858.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211221214571.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221211214046983.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221212173030228.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221212173300984.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221212173411360.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221212173449748.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221212212643923.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213114824973.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213115201237.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213153354537.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213145238246.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213145636771.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213145758290.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213155727207.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213160505504.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213162123516.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213162050744.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213165716908.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213203902215.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213204012588.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213205547251.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221213205841242.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214211411508.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214211504868.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214212057046.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214212713433.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214213212941.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221214213739544.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215162610380.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215162852815.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215163159618.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215163411336.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215163626736.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215163829177.png">
<meta property="og:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221215163940901.png">
<meta property="article:published_time" content="2023-02-26T08:27:31.084Z">
<meta property="article:modified_time" content="2025-04-02T13:51:34.519Z">
<meta property="article:author" content="峡谷杨爹">
<meta property="article:tag" content="数据库">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/image-20221013190815655.png">

<link rel="canonical" href="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MySQL提升篇 | 峡谷杨爹的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">峡谷杨爹的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">学习使我快乐，游戏使我疯狂</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    

  <a href="https://github.com/xiaguyangdie" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/%E5%8D%9A%E5%AE%A2.webp">
      <meta itemprop="name" content="峡谷杨爹">
      <meta itemprop="description" content="write less, do more">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="峡谷杨爹的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL提升篇
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-26 16:27:31" itemprop="dateCreated datePublished" datetime="2023-02-26T16:27:31+08:00">2023-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-04-02 21:51:34" itemprop="dateModified" datetime="2025-04-02T21:51:34+08:00">2025-04-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
                </span>
            </span>

          
            <span id="/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="post-meta-item leancloud_visitors" data-flag-title="MySQL提升篇" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">评论次数：</span>
    
    <a title="valine" href="/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>511k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7:45</span>
            </span>
            <div class="post-description">MySQL提升篇</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="1-数据库概述与安装"><a href="#1-数据库概述与安装" class="headerlink" title="1.数据库概述与安装"></a>1.数据库概述与安装</h1><h2 id="1-1-数据库概述"><a href="#1-1-数据库概述" class="headerlink" title="1.1 数据库概述"></a>1.1 数据库概述</h2><blockquote>
<p>为什么需要使用数据库</p>
</blockquote>
<ul>
<li>持久化(persistence)：把数据保存到可掉电式存储设备中以供之后使用。数据持久化意味着将内存中的数据保存到硬盘上加以”固化”，<strong>而持久化的实现过程大多通过各种关系数据库来完成</strong></li>
<li><strong>持久化的主要作用是将内存中的数据存储在关系型数据库中，当然也可以存储在磁盘文件、XML数 据文件中</strong></li>
</ul>
<p><img src="image-20221013190815655.png" alt="MySQL之性能优化/image-20221013190815655"></p>
<h2 id="1-2-DB与DBMS"><a href="#1-2-DB与DBMS" class="headerlink" title="1.2 DB与DBMS"></a>1.2 DB与DBMS</h2><blockquote>
<p>数据库相关概念</p>
</blockquote>
<p><strong>DB：数据库（Database）</strong>即存储数据的<strong>仓库</strong>，其本质是一个文件系统。它保存了一系列有组织的数据</p>
<p><strong>DBMS：数据库管理系统（Database Management System）</strong>是一种操纵和管理数据库的大型软件，用于建立、使用和维护数据库，对数据库进行统一管理和控 制。用户通过数据库管理系统访问数据库中表内的数据</p>
<p><strong>SQL：结构化查询语言（Structured Query Language）</strong>专门用来与数据库通信的语言</p>
<blockquote>
<p>数据库与数据库管理系统的关系</p>
</blockquote>
<ul>
<li><p>数据库管理系统(DBMS)可以管理多个数据库，一般开发人员会针对每一个应用创建一个数据库</p>
</li>
<li><p>数据库管理系统、数据库和表的关系如图所示：</p>
</li>
</ul>
<p><img src="image-20221013192301690.png" alt="MySQL之性能优化/image-20221013192301690"></p>
<p><img src="image-20221013192453985.png" alt="MySQL之性能优化/image-20221013192453985"></p>
<h2 id="1-3-常见数据库管理系统（DBMS）"><a href="#1-3-常见数据库管理系统（DBMS）" class="headerlink" title="1.3 常见数据库管理系统（DBMS）"></a>1.3 常见数据库管理系统（DBMS）</h2><p><img src="image-20221013192711937.png" alt="MySQL之性能优化/image-20221013192711937"></p>
<blockquote>
<p>Oracle  VS  MySQL</p>
</blockquote>
<ul>
<li><p>Oracle 更适合大型跨国企业的使用，因为他们对费用不敏感，但是对性能要求以及安全性有更高的要求</p>
</li>
<li><p><strong>MySQL 由于其体积小、速度快、总体拥有成本低，可处理上千万条记录的大型数据库，尤其是开放源码 这一特点，使得很多互联网公司、中小型网站选择了MySQL作为网站数据库</strong></p>
</li>
</ul>
<h2 id="1-4-MySQL介绍"><a href="#1-4-MySQL介绍" class="headerlink" title="1.4 MySQL介绍"></a>1.4 MySQL介绍</h2><blockquote>
<p>概述 </p>
</blockquote>
<ul>
<li><p>MySQL是一个<strong>开放源代码的关系型数据库管理系统</strong>，由瑞典MySQL AB（创始人Michael Widenius）公 司1995年开发，迅速成为开源数据库的 No.1</p>
</li>
<li><p>2008被<strong>Sun</strong>收购（10亿美金），2009年Sun被<strong>Oracle</strong>收购。 <strong>MariaDB</strong>应运而生。（MySQL 的创 造者担心 MySQL 有闭源的风险，因此创建了 MySQL 的分支项目 MariaDB）</p>
</li>
<li><p>MySQL6.x 版本之后分为<strong>社区版</strong>和<strong>商业版</strong></p>
</li>
<li><p>MySQL是一种关联数据库管理系统，将数据保存在不同的表中，而不是将所有数据放在一个大仓库 内，这样就增加了速度并提高了灵活性</p>
</li>
<li><p>MySQL是开源的，所以你不需要支付额外的费用</p>
</li>
<li><p>MySQL是可以定制的，采用了<strong>GPL（GNU General Public License）协议</strong>，你可以修改源码来 开发自己的MySQL系统</p>
</li>
<li><p>MySQL支持大型的数据库。可以处理拥有上千万条记录的大型数据库。 MySQL支持大型数据库，支持5000万条记录的数据仓库，32位系统表文件最大可支持<strong>4GB</strong>，64位系 统支持最大的表文件为 <strong>8TB</strong></p>
</li>
<li><p>MySQL使用<strong>标准的SQL数据语言形式</strong></p>
</li>
<li><p>MySQL可以允许运行于多个系统上，并且支持多种语言。这些编程语言包括C、C++、Python、 Java、Perl、PHP和Ruby等</p>
</li>
</ul>
<h2 id="1-5-RDBMS-与-非RDBMS"><a href="#1-5-RDBMS-与-非RDBMS" class="headerlink" title="1.5 RDBMS 与 非RDBMS"></a>1.5 RDBMS 与 非RDBMS</h2><p>从排名中我们能看出来，关系型数据库绝对是 DBMS 的主流，其中使用最多的 DBMS 分别是 Oracle、 MySQL 和 SQL Server。这些都是关系型数据库（RDBMS）</p>
<blockquote>
<p>关系型数据库（RDBMS）</p>
</blockquote>
<ul>
<li>关系型数据库模型是把复杂的数据结构归结为简单的<strong>二元关系</strong>（即二维表格形式）</li>
<li>关系型数据库以<strong>行(row) 和 列(column)<strong>的形式存储数据。这一系列的行和列被称为</strong>表（table）</strong>，一组表组成了一个<strong>库（database）</strong></li>
<li>表与表之间的数据记录有关系（relationship）。现实世界中的各种实体以及实体之间的各种联系均用<strong>关系模型</strong>来表示。关系型数据库，就是建立在<strong>关系模型</strong>基础上的数据库</li>
<li>SQL就是关系型数据库的查询语言</li>
<li>优势：<ul>
<li><strong>复杂查询</strong>可以用SQL语句方便的在一个表以及多个表之间做非常复杂的数据查询</li>
<li><strong>事务支持</strong>使得对于安全性能很高的数据访问要求得以实现</li>
</ul>
</li>
</ul>
<blockquote>
<p>非关系型数据库(非RDBMS)</p>
</blockquote>
<ul>
<li><p><strong>非关系型数据库</strong>，可看成传统关系型数据库的功能 阉割版本 ，基于键值对存储数据，不需要经过SQL层 的解析， 性能非常高 。同时，通过减少不常用的功能，进一步提高性能</p>
</li>
<li><p>目前基本上大部分主流的非关系型数据库都是免费的</p>
</li>
<li><p><strong>Redis，Elasticsearch</strong>等</p>
</li>
</ul>
<blockquote>
<p>关系型数据库设计规则</p>
</blockquote>
<ul>
<li><p>关系型数据库的典型数据结构为数据表,这些数据表的组成都是结构化的(Structured)</p>
</li>
<li><p>使用时将数据存放在表之中,再将表存放在数据库中</p>
</li>
<li><p>一个数据库可以有多个表,每一个表都有一个名字,用来标识,表名具有唯一性</p>
</li>
<li><p>表具有一些特性,特性定义了数据在表中是如何存储的,类似于java和Python中的”类”</p>
</li>
<li><p><strong>E-R（entity-relationship，实体-联系）模型</strong>中有三个主要概念是： 实体集 、 属性 、 联系集 </p>
</li>
<li><p>一个实体集（class）对应于数据库中的一个表（table），一个实体（instance）则对应于数据库表 中的一行（row），也称为一条记录（record）。一个属性（attribute）对应于数据库表中的一列 （column），也称为一个字段（field）</p>
</li>
<li><p>**ORM思想 (Object Relational Mapping)**体现： </p>
<ul>
<li>数据库中的一个表 &lt;—&gt; Java或Python中的一个类 </li>
<li>表中的一条数据 &lt;—&gt; 类中的一个对象（或实体） </li>
<li>表中的一个列 &lt;—-&gt; 类中的一个字段、属性(field)</li>
</ul>
</li>
<li><p>表的关联关系</p>
<ul>
<li>表与表之间的数据记录有关系(relationship)。现实世界中的各种实体以及实体之间的各种联系均用 关系模型来表示</li>
<li>四种：一对一关联、一对多关联、多对多关联、自我引用</li>
</ul>
</li>
</ul>
<h2 id="1-6-MySQL环境搭建"><a href="#1-6-MySQL环境搭建" class="headerlink" title="1.6 MySQL环境搭建"></a>1.6 MySQL环境搭建</h2><p><a href="https://xiaguyangdie.github.io/2022/06/13/MySQL%E5%AE%89%E8%A3%85/">https://xiaguyangdie.github.io/2022/06/13/MySQL%E5%AE%89%E8%A3%85/</a></p>
<h2 id="1-7-MySQL目录结构"><a href="#1-7-MySQL目录结构" class="headerlink" title="1.7 MySQL目录结构"></a>1.7 MySQL目录结构</h2><table>
<thead>
<tr>
<th>MySQL的目录结构</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>bin目录</td>
<td>所有MySQL的可执行文件。如：mysql.exe</td>
</tr>
<tr>
<td>data目录</td>
<td>系统数据库所在的目录</td>
</tr>
<tr>
<td>my.ini文件</td>
<td>MySQL的主要配置文件</td>
</tr>
<tr>
<td>F:\Environment\mysql-5.7.19\data</td>
<td>用户创建的数据库所在的目录</td>
</tr>
</tbody></table>
<p><img src="image-20221013212922600.png" alt="MySQL之性能优化/image-20221013212922600"></p>
<h2 id="1-8-cmd使用MySQL"><a href="#1-8-cmd使用MySQL" class="headerlink" title="1.8 cmd使用MySQL"></a>1.8 cmd使用MySQL</h2><h1 id="2-SQL之SELECT"><a href="#2-SQL之SELECT" class="headerlink" title="2.SQL之SELECT"></a>2.SQL之SELECT</h1><blockquote>
<p>SQL分类</p>
</blockquote>
<ul>
<li><strong>DDL（Data Definition Languages、数据定义语言）</strong>，这些语句定义了不同的数据库、表、视图、索 引等数据库对象，还可以用来创建、删除、修改数据库和数据表的结构<ul>
<li>主要的语句关键字包括 CREATE 、 DROP 、 ALTER 、RENAME、TRUNCATE等</li>
</ul>
</li>
<li><strong>DML（Data Manipulation Language、数据操作语言）</strong>，用于添加、删除、更新和查询数据库记 录，并检查数据完整性。<ul>
<li>主要的语句关键字包括 INSERT 、 DELETE 、 UPDATE 、 SELECT 等</li>
<li>SELECT是SQL语言的基础，最为重要</li>
</ul>
</li>
<li><strong>DCL（Data Control Language、数据控制语言）</strong>，用于定义数据库、表、字段、用户的访问权限和 安全级别<ul>
<li>主要的语句关键字包括 GRANT 、 REVOKE 、 COMMIT 、 ROLLBACK 、 SAVEPOINT 等</li>
</ul>
</li>
</ul>
<blockquote>
<p>基本规则</p>
</blockquote>
<ul>
<li>SQL 可以写在一行或者多行。为了提高可读性，各子句分行写，必要时使用缩进</li>
<li>每条命令以 ; 或 \g 或 \G 结束</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">C:\WINDOWS\system32<span class="operator">&gt;</span>mysql <span class="operator">-</span>uroot <span class="operator">-</span>p123456</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">14</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use test;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> ploy;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Table</span> <span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                                                                                                                                                                                                                                                                                                                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> ploy  <span class="operator">|</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ploy` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;工号&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `degree` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;学历&#x27;</span>,</span><br><span class="line">  `entryDate` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span>,</span><br><span class="line">  `contact` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系电话&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.09</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> ploy\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: ploy</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ploy` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;工号&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `degree` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;学历&#x27;</span>,</span><br><span class="line">  `entryDate` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span>,</span><br><span class="line">  `contact` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系电话&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line"><span class="keyword">No</span> query specified</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> ploy\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: ploy</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ploy` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;工号&#x27;</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  `sex` <span class="type">varchar</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;性别&#x27;</span>,</span><br><span class="line">  `degree` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;学历&#x27;</span>,</span><br><span class="line">  `entryDate` <span class="type">date</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;入职日期&#x27;</span>,</span><br><span class="line">  `contact` <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;联系电话&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>关键字不能被缩写也不能分行</li>
<li>关于标点符号<ul>
<li>必须保证所有的()、单引号、双引号是成对结束的</li>
<li>必须使用英文状态下的半角输入方式</li>
<li>字符串型和日期时间类型的数据可以使用单引号（’ ‘）表示</li>
<li>列的别名，尽量使用双引号（” “），而且不建议省略as</li>
</ul>
</li>
</ul>
<blockquote>
<p>SQL大小写规范</p>
</blockquote>
<ul>
<li><p><strong>MySQL 在 Windows 环境下是大小写不敏感的</strong></p>
</li>
<li><p><strong>MySQL 在 Linux 环境下是大小写敏感的</strong></p>
</li>
<li><p>数据库名、表名、表的别名、变量名是严格区分大小写的</p>
</li>
<li><p>关键字、函数名、列名(或字段名)、列的别名(字段的别名) 是忽略大小写的。</p>
</li>
<li><p><strong>推荐采用统一的书写规范：</strong></p>
<ul>
<li>数据库名、表名、表别名、字段名、字段别名等都小写</li>
<li>SQL 关键字、函数名、绑定变量等都大写</li>
</ul>
</li>
</ul>
<blockquote>
<p>命名规则</p>
</blockquote>
<ul>
<li>数据库、表名不得超过30个字符，变量名限制为29个</li>
<li>必须只能包含 A–Z, a–z, 0–9, _共63个字符</li>
<li>数据库名、表名、字段名等对象名中间不要包含空格</li>
<li>同一个MySQL软件中，数据库不能同名；同一个库中，表不能重名同一个表中，字段不能重名</li>
<li>必须保证你的字段没有和保留字、数据库系统或常用方法冲突。如果坚持使用，请在SQL语句中使 用&#96;（着重号）引起来</li>
<li>保持字段名和类型的一致性，在命名字段并为其指定数据类型的时候一定要保证一致性。假如数据 类型在一个表里是整数，那在另一个表里可就别变成字符型了</li>
</ul>
<blockquote>
<p>注释</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">单行注释：#注释文字(MySQL特有的方式)</span><br><span class="line">单行注释：<span class="comment">-- 注释文字(--后面必须包含一个空格)</span></span><br><span class="line">多行注释：<span class="comment">/* 注释文字  *</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>导入现有的数据表以及数据</p>
</blockquote>
<ul>
<li>方式1：source 文件的全路径名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cjcx               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> irpms              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jdbc               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jdbcstudy          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lu_tale            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> menhu              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mybatis            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mybatis_plus       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> myfirstdb          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> python             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> reggie             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> school             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> shop               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> smbms              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssmbuild           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">20</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> source F:\atguigudb.sql</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">1</span> <span class="type">row</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.22</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">25</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line">Records: <span class="number">25</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.37</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">27</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">27</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.39</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">107</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line">Records: <span class="number">107</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.19</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">6</span> <span class="keyword">rows</span> affected (<span class="number">0.05</span> sec)</span><br><span class="line">Records: <span class="number">6</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.30</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">10</span> <span class="keyword">rows</span> affected (<span class="number">0.07</span> sec)</span><br><span class="line">Records: <span class="number">10</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.19</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">19</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">19</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.48</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">23</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line">Records: <span class="number">23</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.21</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">3</span> <span class="keyword">rows</span> affected (<span class="number">0.06</span> sec)</span><br><span class="line">Records: <span class="number">3</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.33</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">4</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line">Records: <span class="number">4</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.43</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.10</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> atguigudb          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cjcx               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> irpms              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jdbc               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jdbcstudy          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> lu_tale            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> menhu              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mybatis            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mybatis_plus       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> myfirstdb          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> python             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> reggie             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> school             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> shop               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> smbms              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ssmbuild           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> test               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">21</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use atguigudb;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_atguigudb <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> countries           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> departments         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> emp_details_view    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> job_grades          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> job_history         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jobs                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> locations           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">order</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> regions             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>方式2：基于具体的图形化界面的工具可以导入数据</p>
<ul>
<li>比如：SQLyog中 选择 “工具” – “执行sql脚本” – 选中xxx.sql即可</li>
</ul>
<p><img src="image-20221014142535800.png" alt="MySQL之性能优化/image-20221014142535800"></p>
</li>
</ul>
<h2 id="2-1-基本的SELECT语句"><a href="#2-1-基本的SELECT语句" class="headerlink" title="2.1 基本的SELECT语句"></a>2.1 基本的SELECT语句</h2><ul>
<li>最基本的SELECT语句： SELECT 字段1,字段2,… FROM 表名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">+</span> <span class="number">1</span>,<span class="number">3</span> <span class="operator">*</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">+</span> <span class="number">1</span>,<span class="number">3</span> <span class="operator">*</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL; #dual：伪表</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014144023543.png" alt="MySQL之性能优化/image-20221014144023543"></p>
<ul>
<li>语法</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 标识选择哪些列 <span class="keyword">FROM</span> 标识从哪个表中选择</span><br><span class="line"></span><br><span class="line"># <span class="operator">*</span>:表中的所有的字段（或列）</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> departments</span><br></pre></td></tr></table></figure>

<ul>
<li>列的别名<ul>
<li>as（全称：alias）：(别名),可以省略</li>
<li><strong>列的别名可以使用一对””引起来，不要使用’’</strong></li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id emp_id,last_name <span class="keyword">AS</span> lname,department_id &quot;部门id&quot;,salary <span class="operator">*</span> <span class="number">12</span> <span class="keyword">AS</span> &quot;annual sal&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<ul>
<li>去除重复行</li>
</ul>
<p>查询员工表中一共有哪些部门id</p>
<blockquote>
<p>错误的:没有去重的情况</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> department_id</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014144952866.png" alt="MySQL之性能优化/image-20221014144952866"></p>
<blockquote>
<p>正确的：去重的情况</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> department_id</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014145025233.png" alt="MySQL之性能优化/image-20221014145025233"></p>
<blockquote>
<p>错误的</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> salary,<span class="keyword">DISTINCT</span> department_id</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014145148694.png" alt="MySQL之性能优化/image-20221014145148694"></p>
<blockquote>
<p>仅仅是没有报错，但是没有实际意义</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> department_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014145105046.png" alt="MySQL之性能优化/image-20221014145105046"></p>
<ul>
<li><p>空值参与运算</p>
<ul>
<li>空值：null</li>
<li><strong>null不等同于0，’’，’null’</strong></li>
<li>空值参与运算：结果一定也为空</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,salary &quot;月工资&quot;,salary <span class="operator">*</span> (<span class="number">1</span> <span class="operator">+</span> commission_pct) <span class="operator">*</span> <span class="number">12</span> &quot;年工资&quot;,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014145700192.png" alt="MySQL之性能优化/image-20221014145700192"></p>
<ul>
<li>实际问题的解决方案：引入IFNULL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,salary &quot;月工资&quot;,salary <span class="operator">*</span> (<span class="number">1</span> <span class="operator">+</span> IFNULL(commission_pct,<span class="number">0</span>)) <span class="operator">*</span> <span class="number">12</span> &quot;年工资&quot;,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> `employees`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014145722016.png" alt="MySQL之性能优化/image-20221014145722016"></p>
</li>
<li><p>着重号 &#96;&#96;</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `<span class="keyword">order</span>`;</span><br></pre></td></tr></table></figure>

<ul>
<li>查询常数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;尚硅谷&#x27;</span>,<span class="number">123</span>,employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014150122360.png" alt="MySQL之性能优化/image-20221014150122360"></p>
<ul>
<li>显示表结构</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#显示了表中字段的详细信息</span><br><span class="line"><span class="keyword">DESCRIBE</span> employees; </span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014150241215.png" alt="MySQL之性能优化/image-20221014150241215"></p>
<ul>
<li>过滤数据：<strong>WHERE</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> </span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line">#过滤条件,声明在<span class="keyword">FROM</span>结构的后面</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">90</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221014150524467.png" alt="MySQL之性能优化/image-20221014150524467"></p>
<h2 id="2-2-运算符"><a href="#2-2-运算符" class="headerlink" title="2.2 运算符"></a>2.2 运算符</h2><h3 id="2-2-1-算术运算符"><a href="#2-2-1-算术运算符" class="headerlink" title="2.2.1 算术运算符"></a>2.2.1 算术运算符</h3><ul>
<li>算术运算符主要用于数学运算，其可以连接运算符前后的两个数值或表达式，对数值或表达式进行加 （+）、减（-）、乘（*）、除（&#x2F;）和取模（%）运算</li>
</ul>
<p><img src="image-20221014155513382.png" alt="MySQL之性能优化/image-20221014155513382"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span>, <span class="number">100</span> <span class="operator">+</span> <span class="number">0</span>, <span class="number">100</span> <span class="operator">-</span> <span class="number">0</span>, <span class="number">100</span> <span class="operator">+</span> <span class="number">50</span>, <span class="number">100</span> <span class="operator">+</span> <span class="number">50</span> <span class="operator">*</span> <span class="number">30</span>, <span class="number">100</span> <span class="operator">+</span> <span class="number">35.5</span>, <span class="number">100</span> <span class="operator">-</span> <span class="number">35.5</span> </span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015150918198.png" alt="MySQL之性能优化/image-20221015150918198"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在<span class="keyword">SQL</span>中，<span class="operator">+</span>没有连接的作用，就表示加法运算。此时，会将字符串转换为数值（隐式转换）</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span> <span class="operator">+</span> <span class="string">&#x27;1&#x27;</span>  # 在Java语言中，结果是：<span class="number">1001</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151121435.png" alt="MySQL之性能优化/image-20221015151121435"></p>
<ul>
<li>在Java中，+的左右两边如果有字符串，那么表示字符串的拼接。<strong>但是在MySQL中+只表示数值相加</strong>。如果遇到非数值类型，先尝试转成数值，<strong>如果转失败，就按0计算</strong>。（补充：MySQL 中字符串拼接要使用字符串函数CONCAT()实现）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span> <span class="operator">+</span> <span class="string">&#x27;a&#x27;</span> #此时将<span class="string">&#x27;a&#x27;</span>看做<span class="number">0</span>处理</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151407725.png" alt="MySQL之性能优化/image-20221015151407725"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span> <span class="operator">+</span> &quot;NULL&quot; </span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151517670.png" alt="MySQL之性能优化/image-20221015151517670"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span> <span class="operator">+</span> <span class="keyword">NULL</span>  # <span class="keyword">null</span>值参与运算，结果为<span class="keyword">null</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151434681.png" alt="MySQL之性能优化/image-20221015151434681"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">100</span>, <span class="number">100</span> <span class="operator">*</span> <span class="number">1</span>, <span class="number">100</span> <span class="operator">*</span> <span class="number">1.0</span>, <span class="number">100</span> <span class="operator">/</span> <span class="number">1.0</span>, <span class="number">100</span> <span class="operator">/</span> <span class="number">2</span>,</span><br><span class="line"><span class="number">100</span> <span class="operator">+</span> <span class="number">2</span> <span class="operator">*</span> <span class="number">5</span> <span class="operator">/</span> <span class="number">2</span>,<span class="number">100</span> <span class="operator">/</span> <span class="number">3</span>, <span class="number">100</span> DIV <span class="number">0</span>  # 分母如果为<span class="number">0</span>，则结果为<span class="keyword">null</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151605979.png" alt="MySQL之性能优化/image-20221015151605979"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#取模运算： <span class="operator">%</span> mod</span><br><span class="line">#模的结果符号和被模数一致</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">12</span> <span class="operator">%</span> <span class="number">3</span>,<span class="number">12</span> <span class="operator">%</span> <span class="number">5</span>, <span class="number">12</span> MOD <span class="number">-5</span>,<span class="number">-12</span> <span class="operator">%</span> <span class="number">5</span>,<span class="number">-12</span> <span class="operator">%</span> <span class="number">-5</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015151650097.png" alt="MySQL之性能优化/image-20221015151650097"></p>
<h3 id="2-2-2-比较运算符"><a href="#2-2-2-比较运算符" class="headerlink" title="2.2.2 比较运算符"></a>2.2.2 比较运算符</h3><ul>
<li><p><strong>比较运算符用来对表达式左边的操作数和右边的操作数进行比较，比较的结果为真则返回1，比较的结果 为假则返回0，其他情况则返回NULL</strong></p>
</li>
<li><p>比较运算符经常被用来作为SELECT查询语句的条件来使用，返回符合条件的结果记录</p>
</li>
</ul>
<p><img src="image-20221015151844547-16658184793351.png" alt="MySQL之性能优化/image-20221015151844547"></p>
<ul>
<li>&#x3D; 的使用</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">=</span> <span class="number">2</span>,<span class="number">1</span> <span class="operator">!=</span> <span class="number">2</span>,<span class="number">1</span> <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span>,<span class="number">1</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>,<span class="number">0</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> #字符串存在隐式转换。如果转换数值不成功，则看做<span class="number">0</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152154609.png" alt="MySQL之性能优化/image-20221015152154609"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;a&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;ab&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;ab&#x27;</span>,<span class="string">&#x27;a&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;b&#x27;</span> #两边都是字符串的话，则按照ANSI的比较规则进行比较</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152230681.png" alt="MySQL之性能优化/image-20221015152230681"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">=</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span> <span class="operator">=</span> <span class="keyword">NULL</span> # 只要有<span class="keyword">null</span>参与判断，结果就为<span class="keyword">null</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152308340.png" alt="MySQL之性能优化/image-20221015152308340"></p>
<ul>
<li><strong>&lt;&#x3D;&gt; ：安全等于；记忆技巧：为NULL而生</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">&lt;=&gt;</span> <span class="number">2</span>,<span class="number">1</span> <span class="operator">&lt;=&gt;</span> <span class="string">&#x27;1&#x27;</span>,<span class="number">1</span> <span class="operator">&lt;=&gt;</span> <span class="string">&#x27;a&#x27;</span>,<span class="number">0</span> <span class="operator">&lt;=&gt;</span> <span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152444960.png" alt="MySQL之性能优化/image-20221015152444960"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="operator">&lt;=&gt;</span> <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="operator">&lt;=&gt;</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152519218.png" alt="MySQL之性能优化/image-20221015152519218"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查询表中commission_pct为<span class="keyword">null</span>的数据有哪些</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="operator">&lt;=&gt;</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152631505.png" alt="MySQL之性能优化/image-20221015152631505"></p>
<ul>
<li>&lt;&gt; !&#x3D;<ul>
<li>不等于运算符（&lt;&gt;和!&#x3D;）用于判断两边的数字、字符串或者表达式的值是否不相等， 如果不相等则返回1，相等则返回0。不等于运算符不能判断NULL值。如果两边的值有任意一个为NULL， 或两边都为NULL，则结果为NULL</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">3</span> <span class="operator">&lt;&gt;</span> <span class="number">2</span>,<span class="string">&#x27;4&#x27;</span> <span class="operator">&lt;&gt;</span> <span class="keyword">NULL</span>, <span class="string">&#x27;&#x27;</span> <span class="operator">!=</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span> <span class="operator">!=</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015152924832.png" alt="MySQL之性能优化/image-20221015152924832"></p>
<blockquote>
<p>非符号类型的比较运算符</p>
</blockquote>
<p><img src="image-20221015153244828.png" alt="MySQL之性能优化/image-20221015153244828"></p>
<ul>
<li>空运算符（IS NULL或者ISNULL）判断一个值是否为NULL，如果为NULL则返回1，否则返回 0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#练习：查询表中commission_pct为<span class="keyword">null</span>的数据有哪些</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> ISNULL(commission_pct);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015153502877.png" alt="MySQL之性能优化/image-20221015153502877"></p>
<ul>
<li>非空运算符（IS NOT NULL）判断一个值是否不为NULL，如果不为NULL则返回1，否则返 回0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#练习：查询表中commission_pct不为<span class="keyword">null</span>的数据有哪些</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,commission_pct</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> commission_pct <span class="operator">&lt;=&gt;</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015153641389.png" alt="MySQL之性能优化/image-20221015153641389"></p>
<ul>
<li>LEAST() \ GREATEST <ul>
<li>最小值运算符语法格式为：LEAST(值1，值2，…，值n)。其中，“值n”表示参数列表中有n个值。在有两个或多个参数的情况下，返回最小值</li>
<li>最小值运算符：当参数是整数或者浮点数时，LEAST将返回其中最小的值；当参数为字符串时，返回字 母表中顺序最靠前的字符；当比较值列表中有NULL时，不能判断大小，返回值为NULL</li>
<li>最大值运算符语法格式为：GREATEST(值1，值2，…，值n)。其中，n表示参数列表中有n个值。当有两个或多个参数时，返回值为最大值。假如任意一个自变量为NULL，则GREATEST()的返回值为NULL</li>
<li>最大值运算符：当参数中是整数或者浮点数时，GREATEST将返回其中最大的值；当参数为字符串时， 返回字母表中顺序最靠后的字符；当比较值列表中有NULL时，不能判断大小，返回值为NULL</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> LEAST(<span class="number">1</span>,<span class="string">&#x27;3&#x27;</span>,<span class="number">4</span>,<span class="number">0</span>),LEAST(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;m&#x27;</span>),LEAST(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="keyword">NULL</span>),GREATEST(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;m&#x27;</span>),GREATEST(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;null&#x27;</span>),GREATEST(<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="keyword">NULL</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015154310303.png" alt="MySQL之性能优化/image-20221015154310303"></p>
<ul>
<li>BETWEEN运算符使用的格式通常为SELECT D FROM TABLE WHERE C BETWEEN A AND B，此时，当C大于或等于A，并且C小于或等于B时，结果为1，否则结果为0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#交换<span class="number">6000</span> 和 <span class="number">8000</span>之后，查询不到数据</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">BETWEEN</span> <span class="number">8000</span> <span class="keyword">AND</span> <span class="number">6000</span>;</span><br><span class="line"></span><br><span class="line">#查询工资不在<span class="number">6000</span> 到 <span class="number">8000</span>的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="number">6000</span> <span class="keyword">AND</span> <span class="number">8000</span>;</span><br><span class="line">#<span class="keyword">where</span> salary <span class="operator">&lt;</span> <span class="number">6000</span> <span class="keyword">or</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>IN运算符用于判断给定的值是否是IN列表中的一个值，如果是则返回1，否则返回0。如果给 定的值为NULL，或者IN列表中存在NULL，则结果为NULL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>), <span class="number">1</span> <span class="keyword">IN</span> (<span class="number">2</span>,<span class="number">3</span>), <span class="keyword">NULL</span> <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>), <span class="string">&#x27;a&#x27;</span> <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015154608516.png" alt="MySQL之性能优化/image-20221015154608516"></p>
<ul>
<li>符 NOT IN运算符用于判断给定的值是否不是IN列表中的一个值，如果不是IN列表中的一 个值，则返回1，否则返回0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>), <span class="number">1</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="number">2</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015154719858.png" alt="MySQL之性能优化/image-20221015154719858"></p>
<ul>
<li>LIKE运算符主要用来匹配字符串，通常用于模糊匹配，如果满足条件则返回1，否则返回 0。如果给定的值或者匹配条件为NULL，则返回结果为NULL<ul>
<li>“%”：匹配0个或多个字符</li>
<li>“_”：只能匹配一个字符</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#查询第<span class="number">3</span>个字符是<span class="string">&#x27;a&#x27;</span>的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;__a%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015194228445.png" alt="MySQL之性能优化/image-20221015194228445"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查询last_name中包含字符<span class="string">&#x27;a&#x27;</span>的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> last_name </span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%a%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#查询last_name中以字符<span class="string">&#x27;a&#x27;</span>开头的员工信息</span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;a%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015194402069.png" alt="MySQL之性能优化/image-20221015194402069"></p>
<p><img src="image-20221015194324301.png" alt="MySQL之性能优化/image-20221015194324301"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查询last_name中包含字符<span class="string">&#x27;a&#x27;</span>且包含字符<span class="string">&#x27;e&#x27;</span>的员工信息</span><br><span class="line">#写法<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%a%&#x27;</span> <span class="keyword">AND</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%e%&#x27;</span>;</span><br><span class="line">#写法<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%a%e%&#x27;</span> <span class="keyword">OR</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;%e%a%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015194508009.png" alt="MySQL之性能优化/image-20221015194508009"></p>
<ul>
<li><strong>如果使用\表示转义，要省略ESCAPE。如果不是\，则要加上ESCAPE</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#查询第<span class="number">2</span>个字符是_且第<span class="number">3</span>个字符是<span class="string">&#x27;a&#x27;</span>的员工信息</span><br><span class="line">#需要使用转义字符: \ </span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;_\_a%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#或者  (了解)</span><br><span class="line"><span class="keyword">SELECT</span> last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="keyword">LIKE</span> <span class="string">&#x27;_$_a%&#x27;</span> <span class="keyword">ESCAPE</span> <span class="string">&#x27;$&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>REGEXP \ RLIKE：正则表达式</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REGEXP运算符用来匹配字符串，语法格式为： expr REGEXP 匹配条件 。如果expr满足匹配条件，返回</span><br><span class="line"><span class="number">1</span>；如果不满足，则返回<span class="number">0</span>。若expr或匹配条件任意一个为<span class="keyword">NULL</span>，则结果为<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;shkstart&#x27;</span> REGEXP <span class="string">&#x27;^shk&#x27;</span>, <span class="string">&#x27;shkstart&#x27;</span> REGEXP <span class="string">&#x27;t$&#x27;</span>, <span class="string">&#x27;shkstart&#x27;</span> REGEXP <span class="string">&#x27;hk&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015195244396.png" alt="MySQL之性能优化/image-20221015195244396"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;atguigu&#x27;</span> REGEXP <span class="string">&#x27;gu.gu&#x27;</span>,<span class="string">&#x27;atguigu&#x27;</span> REGEXP <span class="string">&#x27;[ab]&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015195329278.png" alt="MySQL之性能优化/image-20221015195329278"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;atguigu&#x27;</span> RLIKE <span class="string">&#x27;gu.gu&#x27;</span>,<span class="string">&#x27;atguigu&#x27;</span> RLIKE <span class="string">&#x27;[ab]&#x27;</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015195403473.png" alt="MySQL之性能优化/image-20221015195403473"></p>
<h3 id="2-2-3-逻辑运算符"><a href="#2-2-3-逻辑运算符" class="headerlink" title="2.2.3 逻辑运算符"></a>2.2.3 逻辑运算符</h3><ul>
<li>逻辑运算符主要用来判断表达式的真假，在MySQL中，逻辑运算符的返回结果为1、0或者NULL</li>
<li><strong>AND的优先级高于OR</strong></li>
</ul>
<p><img src="image-20221015195540148.png" alt="MySQL之性能优化/image-20221015195540148"></p>
<ul>
<li>逻辑非（NOT或!）运算符表示当给定的值为0时返回1；当给定的值为非0值时返回0； <strong>当给定的值为NULL时，返回NULL</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NOT</span> <span class="number">1</span>, <span class="keyword">NOT</span> <span class="number">0</span>, <span class="keyword">NOT</span>(<span class="number">1</span><span class="operator">+</span><span class="number">1</span>), <span class="keyword">NOT</span> <span class="operator">!</span><span class="number">1</span>, <span class="keyword">NOT</span> <span class="keyword">NULL</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NOT</span> <span class="number">1</span>, <span class="keyword">NOT</span> <span class="number">0</span>, <span class="keyword">NOT</span>(<span class="number">1</span><span class="operator">+</span><span class="number">1</span>), <span class="keyword">NOT</span> <span class="operator">!</span><span class="number">1</span>, <span class="keyword">NOT</span> <span class="keyword">NULL</span>,<span class="keyword">NOT</span> &quot;NULL&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015195730217.png" alt="MySQL之性能优化/image-20221015195730217"></p>
<p><img src="image-20221015195850429.png" alt="MySQL之性能优化/image-20221015195850429"></p>
<ul>
<li><strong>逻辑与（AND或&amp;&amp;）运算符是当给定的所有值均为非0值，并且都不为NULL时，返回 1；当给定的一个值或者多个值为0时则返回0；否则返回NULL</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">-1</span>, <span class="number">0</span> <span class="keyword">AND</span> <span class="number">1</span>, <span class="number">0</span> <span class="keyword">AND</span> <span class="keyword">NULL</span>, <span class="number">1</span> <span class="keyword">AND</span> <span class="keyword">NULL</span>,<span class="number">1</span> <span class="operator">&amp;&amp;</span> &quot;NULL&quot;;#&quot;NULL&quot;被转换为<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><img src="image-20221015200055465.png" alt="MySQL之性能优化/image-20221015200055465"></p>
<ul>
<li><strong>逻辑或（OR或||）运算符是当给定的值都不为NULL，并且任何一个值为非0值时，则返 回1，否则返回0；当一个值为NULL，并且另一个值为非0值时，返回1，否则返回NULL；当两个值都为 NULL时，返回NULL</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> <span class="keyword">OR</span> <span class="number">-1</span>, <span class="number">1</span> <span class="keyword">OR</span> <span class="number">0</span>, <span class="number">1</span> <span class="keyword">OR</span> <span class="keyword">NULL</span>, <span class="number">0</span> <span class="operator">||</span> <span class="keyword">NULL</span>, <span class="keyword">NULL</span> <span class="operator">||</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015200329785.png" alt="MySQL之性能优化/image-20221015200329785"></p>
<ul>
<li>逻辑异或（XOR）运算符是当给定的值中任意一个值为NULL时，则返回NULL；如果两个非NULL的值都是0或者都不等于0时，则返回0；如果一个值为0，另一个值不为0时，则返回1</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">1</span> XOR <span class="number">-1</span>, <span class="number">1</span> XOR <span class="number">0</span>, <span class="number">0</span> XOR <span class="number">0</span>, <span class="number">1</span> XOR <span class="keyword">NULL</span>, <span class="number">1</span> XOR <span class="number">1</span> XOR <span class="number">1</span>, <span class="number">0</span> XOR <span class="number">0</span> XOR <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015200656519.png" alt="MySQL之性能优化/image-20221015200656519"></p>
<h3 id="2-2-4-位运算符"><a href="#2-2-4-位运算符" class="headerlink" title="2.2.4 位运算符"></a>2.2.4 位运算符</h3><ul>
<li>位运算符是在二进制数上进行计算的运算符。位运算符会先将操作数变成二进制数，然后进行位运算， 最后将计算结果从二进制变回十进制数</li>
</ul>
<p><img src="image-20221015200818953.png" alt="MySQL之性能优化/image-20221015200818953"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">12</span> <span class="operator">&amp;</span> <span class="number">5</span>, <span class="number">12</span> <span class="operator">|</span> <span class="number">5</span>,<span class="number">12</span> <span class="operator">^</span> <span class="number">5</span> </span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015201018668.png" alt="MySQL之性能优化/image-20221015201018668"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="number">10</span> <span class="operator">&amp;</span> <span class="operator">~</span><span class="number">1</span> <span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015201049819.png" alt="MySQL之性能优化/image-20221015201049819"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#在一定范围内满足：每向左移动<span class="number">1</span>位，相当于乘以<span class="number">2</span>；每向右移动一位，相当于除以<span class="number">2</span>。</span><br><span class="line"><span class="keyword">SELECT</span> <span class="number">4</span> <span class="operator">&lt;&lt;</span> <span class="number">1</span> , <span class="number">8</span> <span class="operator">&gt;&gt;</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015201130083.png" alt="MySQL之性能优化/image-20221015201130083"></p>
<h3 id="2-2-5-运算符优先级"><a href="#2-2-5-运算符优先级" class="headerlink" title="2.2.5 运算符优先级"></a>2.2.5 运算符优先级</h3><p><img src="image-20221015200922169.png" alt="MySQL之性能优化/image-20221015200922169"></p>
<h2 id="2-3-排序与分页"><a href="#2-3-排序与分页" class="headerlink" title="2.3 排序与分页"></a>2.3 排序与分页</h2><h3 id="2-3-1-排序"><a href="#2-3-1-排序" class="headerlink" title="2.3.1 排序"></a>2.3.1 排序</h3><ul>
<li><p>如果没有使用排序操作，默认情况下查询返回的数据是按照添加数据的顺序显示的</p>
</li>
<li><p>使用 ORDER BY 对查询到的数据进行排序操作</p>
<ul>
<li>升序：ASC (ascend)</li>
<li>降序：DESC (descend)</li>
</ul>
</li>
<li><p>如果在ORDER BY 后没有显式指名排序的方式的话，则默认按照升序排列</p>
</li>
</ul>
<blockquote>
<p>基本排序</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 按照salary从高到低的顺序显示员工信息</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015203350293.png" alt="MySQL之性能优化/image-20221015203350293"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 按照salary从低到高的顺序显示员工信息</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">ASC</span>;</span><br><span class="line"># 或者</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary; # 如果在<span class="keyword">ORDER</span> <span class="keyword">BY</span> 后没有显式指名排序的方式的话，则默认按照升序排列</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015203449088.png" alt="MySQL之性能优化/image-20221015203449088"></p>
<blockquote>
<p>使用列的别名，进行排序</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,salary,salary <span class="operator">*</span> <span class="number">12</span> annual_sal</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> annual_sal;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015203659112.png" alt="MySQL之性能优化/image-20221015203659112"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#列的别名只能在 <span class="keyword">ORDER</span> <span class="keyword">BY</span> 中使用，不能在<span class="keyword">WHERE</span>中使用</span><br><span class="line">#如下操作报错！</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,salary,salary <span class="operator">*</span> <span class="number">12</span> annual_sal</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> annual_sal <span class="operator">&gt;</span> <span class="number">81600</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015203803067.png" alt="MySQL之性能优化/image-20221015203803067"></p>
<ul>
<li><strong>强调格式：WHERE 需要声明在FROM后，ORDER BY之前</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IN</span> (<span class="number">50</span>,<span class="number">60</span>,<span class="number">70</span>)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> department_id <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015203901765.png" alt="MySQL之性能优化/image-20221015203901765"></p>
<blockquote>
<p>二级排序</p>
</blockquote>
<ul>
<li><p>可以使用不在SELECT列表中的列排序</p>
</li>
<li><p>在对多列进行排序的时候，首先排序的第一列必须有相同的列值，才会对第二列进行排序。如果第 一列数据中所有值都是唯一的，将不再对第二列进行排序</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 显示员工信息，按照department_id的降序排列，salary的升序排列</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,salary,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> department_id <span class="keyword">DESC</span>,salary <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015204307122.png" alt="MySQL之性能优化/image-20221015204307122"></p>
<h3 id="2-3-2-分页"><a href="#2-3-2-分页" class="headerlink" title="2.3.2 分页"></a>2.3.2 分页</h3><ul>
<li><p>MySQL中使用 LIMIT 实现分页 </p>
</li>
<li><p>格式： LIMIT [位置偏移量,] 条目数</p>
</li>
<li><p>结构”LIMIT 0,条目数” 等价于 “LIMIT 条目数”</p>
</li>
<li><p>需求：每页显示<code>pageSize</code>条记录，此时显示第<code>pageNo</code>页：公式：<code>LIMIT (pageNo-1) * pageSize,pageSize;</code></p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 每页显示<span class="number">20</span>条记录，此时显示第<span class="number">1</span>页</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line">LIMIT <span class="number">0</span>,<span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015204928863.png" alt="MySQL之性能优化/image-20221015204928863"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 每页显示<span class="number">20</span>条记录，此时显示第<span class="number">2</span>页</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line">LIMIT <span class="number">20</span>,<span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015205008943.png" alt="MySQL之性能优化/image-20221015205008943"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 每页显示<span class="number">20</span>条记录，此时显示第<span class="number">3</span>页</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line">LIMIT <span class="number">40</span>,<span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015205045048.png" alt="MySQL之性能优化/image-20221015205045048"></p>
<h3 id="2-3-3-排序与分页声明顺序"><a href="#2-3-3-排序与分页声明顺序" class="headerlink" title="2.3.3 排序与分页声明顺序"></a>2.3.3 排序与分页声明顺序</h3><ul>
<li>WHERE … ORDER BY …LIMIT 声明顺序</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">6000</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span></span><br><span class="line">#limit <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221015205605464.png" alt="MySQL之性能优化/image-20221015205605464"></p>
<h2 id="2-4-多表查询"><a href="#2-4-多表查询" class="headerlink" title="2.4 多表查询"></a>2.4 多表查询</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ...,....,....</span><br><span class="line"><span class="keyword">FROM</span> ....</span><br><span class="line"><span class="keyword">WHERE</span> .... <span class="keyword">AND</span> <span class="operator">/</span> <span class="keyword">OR</span> <span class="operator">/</span> NOT....</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> .... (<span class="keyword">ASC</span><span class="operator">/</span><span class="keyword">DESC</span>),....,...</span><br><span class="line">LIMIT ...,...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>多表查询</p>
</blockquote>
<ul>
<li>笛卡尔积（cross join）<ul>
<li>省略多个表的连接条件（或关联条件） </li>
<li>连接条件（或关联条件）无效 </li>
<li>所有表中的所有行互相连接</li>
<li>为了避免笛卡尔积，可以在WHERE加入有效的连接条件</li>
</ul>
</li>
<li>降低每张表的冗余度，便于表的维护</li>
<li>每次访问数据库时，降低对IO资源的浪费</li>
<li><strong>如果查询语句中出现了多个表中都存在的字段，则必须指明此字段所在的表</strong></li>
<li><strong>如果给表起了别名，一旦在SELECT或WHERE中使用表名的话，则必须使用表的别名，而不能再使用表的原名</strong></li>
<li><strong>如果有n个表实现多表的查询，则需要至少n-1个连接条件</strong></li>
</ul>
<h3 id="2-4-1-等值连接与非等值连接"><a href="#2-4-1-等值连接与非等值连接" class="headerlink" title="2.4.1 等值连接与非等值连接"></a>2.4.1 等值连接与非等值连接</h3><ul>
<li>连接条件为’&#x3D;’，即为<strong>等值连接</strong>，不为等值的统称为得<strong>非等值连接</strong>。如!&#x3D; ，&lt;，&gt;等</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#非等值连接</span><br><span class="line"><span class="keyword">SELECT</span> e.last_name,e.salary,j.grade_level</span><br><span class="line"><span class="keyword">FROM</span> employees e,job_grades j</span><br><span class="line">#<span class="keyword">where</span> e.`salary` <span class="keyword">between</span> j.`lowest_sal` <span class="keyword">and</span> j.`highest_sal`;</span><br><span class="line"><span class="keyword">WHERE</span> e.`salary` <span class="operator">&gt;=</span> j.`lowest_sal` <span class="keyword">AND</span> e.`salary` <span class="operator">&lt;=</span> j.`highest_sal`;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-2-自连接与非自连接"><a href="#2-4-2-自连接与非自连接" class="headerlink" title="2.4.2 自连接与非自连接"></a>2.4.2 自连接与非自连接</h3><ul>
<li>实现自己与自己的连接,即称为<strong>自连接</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> emp.employee_id,emp.last_name,mgr.employee_id,mgr.last_name</span><br><span class="line"><span class="keyword">FROM</span> employees emp ,employees mgr</span><br><span class="line"><span class="keyword">WHERE</span> emp.`manager_id` <span class="operator">=</span> mgr.`employee_id`;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-3-内连接与外连接"><a href="#2-4-3-内连接与外连接" class="headerlink" title="2.4.3  内连接与外连接"></a>2.4.3  内连接与外连接</h3><blockquote>
<p>语法格式</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">table1 </span><br><span class="line">[<span class="keyword">inner</span><span class="operator">/</span><span class="keyword">left</span><span class="operator">/</span><span class="keyword">left</span> <span class="keyword">outer</span><span class="operator">/</span><span class="keyword">right</span><span class="operator">/</span><span class="keyword">right</span> <span class="keyword">outer</span><span class="operator">/</span><span class="keyword">full</span> <span class="keyword">outer</span><span class="operator">/</span><span class="keyword">full</span>] <span class="keyword">join</span> table2</span><br><span class="line"><span class="keyword">ON</span> 条件</span><br></pre></td></tr></table></figure>

<blockquote>
<p>内连接：inner join &#x2F; join</p>
</blockquote>
<ul>
<li>内连接：合并具有同一列的两个以上的表的行, 结果集中不包含一个表与另一个表不匹配的行</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e,departments d</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="operator">=</span> d.department_id; </span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.department_id; </span><br><span class="line"></span><br><span class="line"># 或者</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e </span><br><span class="line"><span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.department_id; </span><br></pre></td></tr></table></figure>

<p><img src="image-20221016225533392.png" alt="MySQL之性能优化/image-20221016225533392"></p>
<blockquote>
<p>外连接</p>
</blockquote>
<ul>
<li><p>外连接：合并具有同一列的两个以上的表的行, 结果集中除了包含一个表与另一个表匹配的行之外，还查询到了左表 或 右表中不匹配的行</p>
</li>
<li><p><strong>外连接的分类：左外连接、右外连接、满外连接（mysql不支持，oracle支持）</strong></p>
</li>
<li><p>左外连接：两个表在连接过程中除了返回满足连接条件的行以外还返回左表中不满足条件的行，这种连接称为左外连接</p>
</li>
<li><p>右外连接：两个表在连接过程中除了返回满足连接条件的行以外还返回右表中不满足条件的行，这种连接称为右外连接</p>
</li>
</ul>
<blockquote>
<p>左外连接：left outer join &#x2F; left join</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016231340323.png" alt="MySQL之性能优化/image-20221016231340323"></p>
<blockquote>
<p>右外连接：</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016231303026.png" alt="MySQL之性能优化/image-20221016231303026"></p>
<blockquote>
<p>满外连接：mysql不支持FULL OUTER JOIN</p>
</blockquote>
<ul>
<li><strong>MySQL不支持FULL JOIN，但是可以用 LEFT JOIN UNION RIGHT join代替</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016231618032.png" alt="MySQL之性能优化/image-20221016231618032"></p>
<h3 id="2-4-4-UNION与UNION-ALL"><a href="#2-4-4-UNION与UNION-ALL" class="headerlink" title="2.4.4 UNION与UNION ALL"></a>2.4.4 UNION与UNION ALL</h3><ul>
<li><p>UNION：会执行去重操作</p>
</li>
<li><p>UNION ALL:不会执行去重操作</p>
</li>
<li><p><strong>结论：如果明确知道合并数据后的结果数据不存在重复数据，或者不需要去除重复的数据，</strong><br><strong>则尽量使用UNION ALL语句，以提高数据查询的效率</strong></p>
</li>
<li><p>合并查询结果，合并时，<strong>两个表对应的列数和数据类型必须相同</strong>，并且相互对应。各个SELECT语句之间使用UNION或UNION ALL关键字分隔</p>
</li>
</ul>
<blockquote>
<p>语法格式</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT column,... FROM table1</span><br><span class="line">UNION [ALL]</span><br><span class="line">SELECT column,... FROM table2</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> job_grades</span><br><span class="line"><span class="keyword">WHERE</span> grade_level<span class="operator">=</span><span class="string">&#x27;A&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016232221966.png" alt="MySQL之性能优化/image-20221016232221966"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> job_grades</span><br><span class="line"><span class="keyword">WHERE</span> grade_level<span class="operator">=</span><span class="string">&#x27;C&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016232249706.png" alt="MySQL之性能优化/image-20221016232249706"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> job_grades</span><br><span class="line"><span class="keyword">WHERE</span> grade_level<span class="operator">=</span><span class="string">&#x27;A&#x27;</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> job_grades</span><br><span class="line"><span class="keyword">WHERE</span> grade_level<span class="operator">=</span><span class="string">&#x27;C&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221016232318206.png" alt="MySQL之性能优化/image-20221016232318206"></p>
<h3 id="2-4-5-7种JOIN实现"><a href="#2-4-5-7种JOIN实现" class="headerlink" title="2.4.5 7种JOIN实现"></a>2.4.5 7种JOIN实现</h3><p><img src="image-20221016233053531.png" alt="MySQL之性能优化/image-20221016233053531"></p>
<blockquote>
<p>代码实现</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 中图：内连接</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134213282.png" alt="MySQL之性能优化/image-20221017134213282"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 左上图：左外连接</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134306022.png" alt="MySQL之性能优化/image-20221017134306022"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 右上图：右外连接</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134402096.png" alt="MySQL之性能优化/image-20221017134402096"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 左中图：</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> d.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134458131.png" alt="MySQL之性能优化/image-20221017134458131"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 右中图：</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134546656.png" alt="MySQL之性能优化/image-20221017134546656"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 左下图：满外连接</span><br><span class="line"># 方式<span class="number">1</span>：左上图 <span class="keyword">UNION</span> <span class="keyword">ALL</span> 右中图</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 方式<span class="number">2</span>：左中图 <span class="keyword">UNION</span> <span class="keyword">ALL</span> 右上图</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> d.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134711002.png" alt="MySQL之性能优化/image-20221017134711002"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 右下图：左中图  <span class="keyword">UNION</span> <span class="keyword">ALL</span> 右中图</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> d.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017134747423.png" alt="MySQL之性能优化/image-20221017134747423"></p>
<h3 id="2-4-6-SQL99新特性"><a href="#2-4-6-SQL99新特性" class="headerlink" title="2.4.6 SQL99新特性"></a>2.4.6 SQL99新特性</h3><ul>
<li>NATURE JOIN：自动查询两张连接表中<code>所有相同的字段</code>，然后进行<code>等值连接</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">AND</span> e.`manager_id` <span class="operator">=</span> d.`manager_id`;</span><br><span class="line"></span><br><span class="line"># <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> : 它会帮你自动查询两张连接表中`所有相同的字段`，然后进行`等值连接`</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">NATURAL</span> <span class="keyword">JOIN</span> departments d;</span><br></pre></td></tr></table></figure>

<ul>
<li>USING：使用 USING 指定数据表里的<strong>同名字段</strong>进行等值连接</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.department_id <span class="operator">=</span> d.department_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">USING</span> (department_id);</span><br></pre></td></tr></table></figure>

<h3 id="2-4-7-扩展"><a href="#2-4-7-扩展" class="headerlink" title="2.4.7 扩展"></a>2.4.7 扩展</h3><ul>
<li>2张以上的表连接查询</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,job_title,department_name </span><br><span class="line"><span class="keyword">FROM</span> employees <span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments <span class="keyword">INNER</span> <span class="keyword">JOIN</span> jobs </span><br><span class="line"><span class="keyword">ON</span> employees.department_id <span class="operator">=</span> departments.department_id </span><br><span class="line"><span class="keyword">AND</span> employees.job_id <span class="operator">=</span> jobs.job_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,job_title,department_name </span><br><span class="line"><span class="keyword">FROM</span> employees </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> departments </span><br><span class="line"><span class="keyword">ON</span> employees.department_id <span class="operator">=</span> departments.department_id </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> jobs </span><br><span class="line"><span class="keyword">ON</span> employees.job_id <span class="operator">=</span> jobs.job_id;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-单行函数"><a href="#2-5-单行函数" class="headerlink" title="2.5 单行函数"></a>2.5 单行函数</h2><ul>
<li><p>SQL 语言中，包括了<strong>内置函数</strong>和<strong>自定义函数</strong></p>
</li>
<li><p>在 SQL 中使用函数对检索出来的数据进行函数操作。使用这些函数，可以极大地<strong>提高用户对数据库的管理效率</strong></p>
</li>
<li><p>MySQL提供的<strong>内置函数</strong>从实现的功能角度可以分为<strong>数值函数、字符串函数、日期和时间函数、流程控制 函数、加密与解密函数、获取MySQL信息函数、聚合函数</strong>等</p>
</li>
<li><p>内置函数再分为两类： 单行函数 、 聚合函数（或分组函数）</p>
</li>
<li><p>单行函数 </p>
<ul>
<li>操作数据对象 </li>
<li>接受参数返回一个结果 </li>
<li>只对一行进行变换 </li>
<li>每行返回一个结果 </li>
<li>可以嵌套 </li>
<li>参数可以是一列或一个值</li>
</ul>
</li>
</ul>
<h3 id="2-5-1-数值函数"><a href="#2-5-1-数值函数" class="headerlink" title="2.5.1 数值函数"></a>2.5.1 数值函数</h3><blockquote>
<p>基本函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>ABS(x)</td>
<td>返回x的绝对值</td>
</tr>
<tr>
<td>SIGN(X)</td>
<td>返回X的符号。正数返回1，负数返回-1，0返回0</td>
</tr>
<tr>
<td>PI()</td>
<td>返回圆周率的值</td>
</tr>
<tr>
<td>CEIL(x)，CEILING(x)</td>
<td>返回大于或等于某个值的最小整数</td>
</tr>
<tr>
<td>FLOOR(x)</td>
<td>返回小于或等于某个值的最大整数</td>
</tr>
<tr>
<td>LEAST(e1,e2,e3…)</td>
<td>返回列表中的最小值</td>
</tr>
<tr>
<td>GREATEST(e1,e2,e3…)</td>
<td>返回列表中的最大值</td>
</tr>
<tr>
<td>MOD(x,y)</td>
<td>返回X除以Y后的余数</td>
</tr>
<tr>
<td>RAND()</td>
<td>返回0~1的随机值</td>
</tr>
<tr>
<td>RAND(x)</td>
<td>返回0~1的随机值，其中x的值用作种子值，相同的X值会产生相同的随机数</td>
</tr>
<tr>
<td>ROUND(x)</td>
<td>返回一个对x的值进行四舍五入后，最接近于X的整数</td>
</tr>
<tr>
<td>ROUND(x,y)</td>
<td>返回一个对x的值进行四舍五入后最接近X的值，并保留到小数点后面Y位</td>
</tr>
<tr>
<td>TRUNCATE(x,y)</td>
<td>返回数字x截断为y位小数的结果</td>
</tr>
<tr>
<td>SQRT(x)</td>
<td>返回x的平方根。当X的值为负数时，返回NULL</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">ABS</span>(<span class="number">-123</span>),<span class="built_in">ABS</span>(<span class="number">32</span>),SIGN(<span class="number">-23</span>),SIGN(<span class="number">43</span>),PI(),<span class="built_in">CEIL</span>(<span class="number">32.32</span>),<span class="built_in">CEILING</span>(<span class="number">-43.23</span>),<span class="built_in">FLOOR</span>(<span class="number">32.32</span>),</span><br><span class="line"><span class="built_in">FLOOR</span>(<span class="number">-43.23</span>),<span class="built_in">MOD</span>(<span class="number">12</span>,<span class="number">5</span>),<span class="number">12</span> MOD <span class="number">5</span>,<span class="number">12</span> <span class="operator">%</span> <span class="number">5</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017142854189.png" alt="MySQL之性能优化/image-20221017142854189"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#取随机数</span><br><span class="line"><span class="keyword">SELECT</span> RAND(),RAND(),RAND(<span class="number">10</span>),RAND(<span class="number">10</span>),RAND(<span class="number">-1</span>),RAND(<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143038581.png" alt="MySQL之性能优化/image-20221017143038581"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#四舍五入，截断操作</span><br><span class="line"><span class="keyword">SELECT</span> ROUND(<span class="number">123.556</span>),ROUND(<span class="number">123.456</span>,<span class="number">0</span>),ROUND(<span class="number">123.456</span>,<span class="number">1</span>),ROUND(<span class="number">123.456</span>,<span class="number">2</span>),</span><br><span class="line">ROUND(<span class="number">123.456</span>,<span class="number">-1</span>),ROUND(<span class="number">153.456</span>,<span class="number">-2</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143147180.png" alt="MySQL之性能优化/image-20221017143147180"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">TRUNCATE</span>(<span class="number">123.456</span>,<span class="number">0</span>),<span class="keyword">TRUNCATE</span>(<span class="number">123.496</span>,<span class="number">1</span>),<span class="keyword">TRUNCATE</span>(<span class="number">129.45</span>,<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143240609.png" alt="MySQL之性能优化/image-20221017143240609"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#单行函数可以嵌套</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">TRUNCATE</span>(ROUND(<span class="number">123.456</span>,<span class="number">2</span>),<span class="number">0</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143347787.png" alt="MySQL之性能优化/image-20221017143347787"></p>
<blockquote>
<p>角度和弧度互换函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>RADIANS(x)</td>
<td>将角度转化为弧度，其中，参数x为角度值</td>
</tr>
<tr>
<td>DEGREES(x)</td>
<td>将弧度转化为角度，其中，参数x为弧度值</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> RADIANS(<span class="number">30</span>),RADIANS(<span class="number">45</span>),RADIANS(<span class="number">60</span>),RADIANS(<span class="number">90</span>),</span><br><span class="line">DEGREES(<span class="number">2</span><span class="operator">*</span>PI()),DEGREES(RADIANS(<span class="number">60</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143458976.png" alt="MySQL之性能优化/image-20221017143458976"></p>
<blockquote>
<p>三角函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>SIN(x)</td>
<td>返回x的正弦值，其中，参数x为弧度值</td>
</tr>
<tr>
<td>ASIN(x)</td>
<td>返回x的反正弦值，即获取正弦为x的值。如果x的值不在-1到1之间，则返回NULL</td>
</tr>
<tr>
<td>COS(x)</td>
<td>返回x的余弦值，其中，参数x为弧度值</td>
</tr>
<tr>
<td>ACOS(x)</td>
<td>返回x的反余弦值，即获取余弦为x的值。如果x的值不在-1到1之间，则返回NULL</td>
</tr>
<tr>
<td>TAN(x)</td>
<td>返回x的正切值，其中，参数x为弧度值</td>
</tr>
<tr>
<td>ATAN(x)</td>
<td>返回x的反正切值，即返回正切值为x的值</td>
</tr>
<tr>
<td>ATAN2(m,n)</td>
<td>返回两个参数的反正切值</td>
</tr>
<tr>
<td>COT(x)</td>
<td>返回x的余切值，其中，X为弧度值</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SIN</span>(RADIANS(<span class="number">30</span>)),DEGREES(<span class="built_in">ASIN</span>(<span class="number">1</span>)),<span class="built_in">TAN</span>(RADIANS(<span class="number">45</span>)),DEGREES(<span class="built_in">ATAN</span>(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143547166.png" alt="MySQL之性能优化/image-20221017143547166"></p>
<blockquote>
<p>指数与对数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>POW(x,y)，POWER(X,Y)</td>
<td>返回x的y次方</td>
</tr>
<tr>
<td>EXP(X)</td>
<td>返回e的X次方，其中e是一个常数，2.718281828459045</td>
</tr>
<tr>
<td>LN(X)，LOG(X)</td>
<td>返回以e为底的X的对数，当X &lt;&#x3D; 0 时，返回的结果为NULL</td>
</tr>
<tr>
<td>LOG10(X)</td>
<td>返回以10为底的X的对数，当X &lt;&#x3D; 0 时，返回的结果为NULL</td>
</tr>
<tr>
<td>LOG2(X)</td>
<td>返回以2为底的X的对数，当X &lt;&#x3D; 0 时，返回NULL</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> POW(<span class="number">2</span>,<span class="number">5</span>),<span class="built_in">POWER</span>(<span class="number">2</span>,<span class="number">4</span>),<span class="built_in">EXP</span>(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143625870.png" alt="MySQL之性能优化/image-20221017143625870"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">LN</span>(<span class="built_in">EXP</span>(<span class="number">2</span>)),<span class="built_in">LOG</span>(<span class="built_in">EXP</span>(<span class="number">2</span>)),<span class="built_in">LOG10</span>(<span class="number">10</span>),LOG2(<span class="number">4</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143706735.png" alt="MySQL之性能优化/image-20221017143706735"></p>
<blockquote>
<p>进制间的转换</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>BIN(x)</td>
<td>返回x的二进制编码</td>
</tr>
<tr>
<td>HEX(x)</td>
<td>返回x的十六进制编码</td>
</tr>
<tr>
<td>OCT(x)</td>
<td>返回x的八进制编码</td>
</tr>
<tr>
<td>CONV(x,f1,f2)</td>
<td>返回f1进制数变成f2进制数</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> BIN(<span class="number">10</span>),HEX(<span class="number">10</span>),OCT(<span class="number">10</span>),CONV(<span class="number">10</span>,<span class="number">10</span>,<span class="number">8</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017143740253.png" alt="MySQL之性能优化/image-20221017143740253"></p>
<h3 id="2-5-2-字符串函数"><a href="#2-5-2-字符串函数" class="headerlink" title="2.5.2 字符串函数"></a>2.5.2 字符串函数</h3><ul>
<li><strong>注意：MySQL中，字符串的位置是从1开始的</strong></li>
</ul>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>ASCII(S)</td>
<td>返回字符串S中的第一个字符的ASCII码值</td>
</tr>
<tr>
<td>CHAR_LENGTH(s)</td>
<td>返回字符串s的字符数。作用与CHARACTER_LENGTH(s)相同</td>
</tr>
<tr>
<td>LENGTH(s)</td>
<td>返回字符串s的字节数，和字符集有关</td>
</tr>
<tr>
<td>CONCAT(s1,s2,……,sn)</td>
<td>连接s1,s2,……,sn为一个字符串</td>
</tr>
<tr>
<td>CONCAT_WS(x, s1,s2,……,sn)</td>
<td>同CONCAT(s1,s2,…)函数，但是每个字符串之间要加上x</td>
</tr>
<tr>
<td>INSERT(str, idx, len, replacestr)</td>
<td>将字符串str从第idx位置开始，len个字符长的子串替换为字符串replacestr</td>
</tr>
<tr>
<td>REPLACE(str, a, b)</td>
<td>用字符串b替换字符串str中所有出现的字符串a</td>
</tr>
<tr>
<td>UPPER(s) 或 UCASE(s)</td>
<td>将字符串s的所有字母转成大写字母</td>
</tr>
<tr>
<td>LOWER(s) 或LCASE(s)</td>
<td>将字符串s的所有字母转成小写字母</td>
</tr>
<tr>
<td>LEFT(str,n)</td>
<td>返回字符串str最左边的n个字符</td>
</tr>
<tr>
<td>RIGHT(str,n)</td>
<td>返回字符串str最右边的n个字符</td>
</tr>
<tr>
<td>LPAD(str, len, pad)</td>
<td>用字符串pad对str最左边进行填充，直到str的长度为len个字符</td>
</tr>
<tr>
<td>RPAD(str ,len, pad)</td>
<td>用字符串pad对str最右边进行填充，直到str的长度为len个字符</td>
</tr>
<tr>
<td>LTRIM(s)</td>
<td>去掉字符串s左侧的空格</td>
</tr>
<tr>
<td>RTRIM(s)</td>
<td>去掉字符串s右侧的空格</td>
</tr>
<tr>
<td>TRIM(s)</td>
<td>去掉字符串s开始与结尾的空格</td>
</tr>
<tr>
<td>TRIM(s1 FROM s)</td>
<td>去掉字符串s开始与结尾的s1</td>
</tr>
<tr>
<td>TRIM(LEADING s1 FROM s)</td>
<td>去掉字符串s开始处的s1</td>
</tr>
<tr>
<td>TRIM(TRAILING s1 FROM s)</td>
<td>去掉字符串s结尾处的s1</td>
</tr>
<tr>
<td>REPEAT(str, n)</td>
<td>返回str重复n次的结果</td>
</tr>
<tr>
<td>SPACE(n)</td>
<td>返回n个空格</td>
</tr>
<tr>
<td>STRCMP(s1,s2)</td>
<td>比较字符串s1,s2的ASCII码值的大小</td>
</tr>
<tr>
<td>SUBSTR(s,index,len)</td>
<td>返回从字符串s的index位置其len个字符，作用与SUBSTRING(s,n,len)、 MID(s,n,len)相同</td>
</tr>
<tr>
<td>LOCATE(substr,str)</td>
<td>返回字符串substr在字符串str中首次出现的位置，作用于POSITION(substr IN str)、INSTR(str,substr)相同。未找到，返回0</td>
</tr>
<tr>
<td>ELT(m,s1,s2,…,sn)</td>
<td>返回指定位置的字符串，如果m&#x3D;1，则返回s1，如果m&#x3D;2，则返回s2，如 果m&#x3D;n，则返回sn</td>
</tr>
<tr>
<td>FIELD(s,s1,s2,…,sn)</td>
<td>返回字符串s在字符串列表中第一次出现的位置</td>
</tr>
<tr>
<td>FIND_IN_SET(s1,s2)</td>
<td>返回字符串s1在字符串s2中出现的位置。其中，字符串s2是一个以逗号分 隔的字符串</td>
</tr>
<tr>
<td>REVERSE(s)</td>
<td>返回s反转后的字符串</td>
</tr>
<tr>
<td>NULLIF(value1,value2)</td>
<td>比较两个字符串，如果value1与value2相等，则返回NULL，否则返回 value1</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ASCII(<span class="string">&#x27;Abcdfsf&#x27;</span>),<span class="keyword">CHAR_LENGTH</span>(<span class="string">&#x27;hello&#x27;</span>),<span class="keyword">CHAR_LENGTH</span>(<span class="string">&#x27;我们&#x27;</span>),</span><br><span class="line">LENGTH(<span class="string">&#x27;hello&#x27;</span>),LENGTH(<span class="string">&#x27;我们&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017160328624.png" alt="MySQL之性能优化/image-20221017160328624"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># xxx worked <span class="keyword">for</span> yyy</span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(emp.last_name,<span class="string">&#x27; worked for &#x27;</span>,mgr.last_name) &quot;details&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees emp <span class="keyword">JOIN</span> employees mgr</span><br><span class="line"><span class="keyword">WHERE</span> emp.`manager_id` <span class="operator">=</span> mgr.employee_id;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017161554061.png" alt="MySQL之性能优化/image-20221017161554061"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONCAT_WS(<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;world&#x27;</span>,<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;beijing&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017161634006.png" alt="MySQL之性能优化/image-20221017161634006"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#字符串的索引是从<span class="number">1</span>开始的！</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">INSERT</span>(<span class="string">&#x27;helloworld&#x27;</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;aaaaa&#x27;</span>),REPLACE(<span class="string">&#x27;hello&#x27;</span>,<span class="string">&#x27;lol&#x27;</span>,<span class="string">&#x27;mmm&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017180525663.png" alt="MySQL之性能优化/image-20221017180525663"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">UPPER</span>(<span class="string">&#x27;HelLo&#x27;</span>),<span class="built_in">LOWER</span>(<span class="string">&#x27;HelLo&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017180611415.png" alt="MySQL之性能优化/image-20221017180611415"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">LEFT</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="number">2</span>),<span class="keyword">RIGHT</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="number">3</span>),<span class="keyword">RIGHT</span>(<span class="string">&#x27;hello&#x27;</span>,<span class="number">13</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017180651414.png" alt="MySQL之性能优化/image-20221017180651414"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ELT(<span class="number">2</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>),FIELD(<span class="string">&#x27;mm&#x27;</span>,<span class="string">&#x27;gg&#x27;</span>,<span class="string">&#x27;jj&#x27;</span>,<span class="string">&#x27;mm&#x27;</span>,<span class="string">&#x27;dd&#x27;</span>,<span class="string">&#x27;mm&#x27;</span>),</span><br><span class="line">FIND_IN_SET(<span class="string">&#x27;mm&#x27;</span>,<span class="string">&#x27;gg,mm,jj,dd,mm,gg&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017180907833.png" alt="MySQL之性能优化/image-20221017180907833"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,<span class="built_in">NULLIF</span>(LENGTH(first_name),LENGTH(last_name)) &quot;compare&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017180944969.png" alt="MySQL之性能优化/image-20221017180944969"></p>
<h3 id="2-5-3-日期和时间函数"><a href="#2-5-3-日期和时间函数" class="headerlink" title="2.5.3 日期和时间函数"></a>2.5.3 日期和时间函数</h3><blockquote>
<p>获取日期和时间</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>CURDATE() ，CURRENT_DATE()</td>
<td>返回当前日期，只包含年、 月、日</td>
</tr>
<tr>
<td>CURTIME() ， CURRENT_TIME()</td>
<td>返回当前时间，只包含时、 分、秒</td>
</tr>
<tr>
<td>NOW() &#x2F; SYSDATE() &#x2F; CURRENT_TIMESTAMP() &#x2F; LOCALTIME() &#x2F; LOCALTIMESTAMP()</td>
<td>返回当前系统日期和时间</td>
</tr>
<tr>
<td>UTC_DATE()</td>
<td>返回UTC（世界标准时间） 日期</td>
</tr>
<tr>
<td>UTC_TIME()</td>
<td>返回UTC（世界标准时间） 时间</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CURDATE(),<span class="built_in">CURRENT_DATE</span>(),CURTIME(),NOW(),SYSDATE(),</span><br><span class="line">UTC_DATE(),UTC_TIME()</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181124151-16660014859301.png" alt="MySQL之性能优化/image-20221017181124151"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CURDATE(),CURDATE() <span class="operator">+</span> <span class="number">0</span>,CURTIME() <span class="operator">+</span> <span class="number">0</span>,NOW() <span class="operator">+</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181202163.png" alt="MySQL之性能优化/image-20221017181202163"></p>
<blockquote>
<p>日期与时间戳的转换</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>UNIX_TIMESTAMP()</td>
<td>以UNIX时间戳的形式返回当前时间。SELECT UNIX_TIMESTAMP() - &gt;1634348884</td>
</tr>
<tr>
<td>UNIX_TIMESTAMP(date)</td>
<td>将时间date以UNIX时间戳的形式返回</td>
</tr>
<tr>
<td>FROM_UNIXTIME(timestamp)</td>
<td>将UNIX时间戳的时间转换为普通格式的时间</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> UNIX_TIMESTAMP(),UNIX_TIMESTAMP(<span class="string">&#x27;2021-10-01 12:12:32&#x27;</span>),</span><br><span class="line">FROM_UNIXTIME(<span class="number">1635173853</span>),FROM_UNIXTIME(<span class="number">1633061552</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181321085.png" alt="MySQL之性能优化/image-20221017181321085"></p>
<blockquote>
<p>获取月份、星期、星期数、天数等函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>YEAR(date) &#x2F; MONTH(date) &#x2F; DAY(date)</td>
<td>返回具体的日期值</td>
</tr>
<tr>
<td>HOUR(time) &#x2F; MINUTE(time) &#x2F; SECOND(time)</td>
<td>返回具体的时间值</td>
</tr>
<tr>
<td>MONTHNAME(date)</td>
<td>返回月份：January，…</td>
</tr>
<tr>
<td>DAYNAME(date)</td>
<td>返回星期几：MONDAY，TUESDAY…..SUNDAY</td>
</tr>
<tr>
<td>WEEKDAY(date)</td>
<td>返回周几，注意，周1是0，周2是1，。。。周日是6</td>
</tr>
<tr>
<td>QUARTER(date)</td>
<td>返回日期对应的季度，范围为1～4</td>
</tr>
<tr>
<td>WEEK(date) ， WEEKOFYEAR(date)</td>
<td>返回一年中的第几周</td>
</tr>
<tr>
<td>DAYOFYEAR(date)</td>
<td>返回日期是一年中的第几天</td>
</tr>
<tr>
<td>DAYOFMONTH(date)</td>
<td>返回日期位于所在月份的第几天</td>
</tr>
<tr>
<td>DAYOFWEEK(date)</td>
<td>返回周几，注意：周日是1，周一是2，。。。周六是 7</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">YEAR</span>(CURDATE()),<span class="keyword">MONTH</span>(CURDATE()),<span class="keyword">DAY</span>(CURDATE()),</span><br><span class="line"><span class="keyword">HOUR</span>(CURTIME()),<span class="keyword">MINUTE</span>(NOW()),<span class="keyword">SECOND</span>(SYSDATE())</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181406135.png" alt="MySQL之性能优化/image-20221017181406135"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> MONTHNAME(<span class="string">&#x27;2021-10-26&#x27;</span>),DAYNAME(<span class="string">&#x27;2021-10-26&#x27;</span>),WEEKDAY(<span class="string">&#x27;2021-10-26&#x27;</span>),</span><br><span class="line">QUARTER(CURDATE()),WEEK(CURDATE()),DAYOFYEAR(NOW()),</span><br><span class="line">DAYOFMONTH(NOW()),DAYOFWEEK(NOW())</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181444132.png" alt="MySQL之性能优化/image-20221017181444132"></p>
<blockquote>
<p>日期的操作函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>EXTRACT(type FROM date)</td>
<td>返回指定日期中特定的部分，type指定返回的值</td>
</tr>
</tbody></table>
<p><img src="image-20221017151825075.png" alt="MySQL之性能优化/image-20221017151825075"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">EXTRACT</span>(<span class="keyword">SECOND</span> <span class="keyword">FROM</span> NOW()),<span class="built_in">EXTRACT</span>(<span class="keyword">DAY</span> <span class="keyword">FROM</span> NOW()),</span><br><span class="line"><span class="built_in">EXTRACT</span>(HOUR_MINUTE <span class="keyword">FROM</span> NOW()),<span class="built_in">EXTRACT</span>(QUARTER <span class="keyword">FROM</span> <span class="string">&#x27;2021-05-12&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181543392.png" alt="MySQL之性能优化/image-20221017181543392"></p>
<blockquote>
<p>时间和秒针转换的函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>TIME_TO_SEC(time)</td>
<td>将 time 转化为秒并返回结果值。转化的公式为： 小时*3600+分钟 *60+秒</td>
</tr>
<tr>
<td>SEC_TO_TIME(seconds)</td>
<td>将 seconds 描述转化为包含小时、分钟和秒的时间</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TIME_TO_SEC(CURTIME()),</span><br><span class="line">SEC_TO_TIME(<span class="number">83355</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181624307.png" alt="MySQL之性能优化/image-20221017181624307"></p>
<blockquote>
<p>计算日期和时间的函数</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>DATE_ADD(datetime, INTERVAL expr type)， ADDDATE(date,INTERVAL expr type)</td>
<td>返回与给定日期时间相差INTERVAL时 间段的日期时间</td>
</tr>
<tr>
<td>DATE_SUB(date,INTERVAL expr type)， SUBDATE(date,INTERVAL expr type)</td>
<td>返回与date相差INTERVAL时间间隔的 日期</td>
</tr>
</tbody></table>
<p><img src="image-20221017152011435.png" alt="MySQL之性能优化/image-20221017152011435"></p>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>ADDTIME(time1,time2)</td>
<td>返回time1加上time2的时间。当time2为一个数字时，代表的是 秒 ，可以为负数</td>
</tr>
<tr>
<td>SUBTIME(time1,time2)</td>
<td>返回time1减去time2后的时间。当time2为一个数字时，代表的 是 秒 ，可以为负数</td>
</tr>
<tr>
<td>DATEDIFF(date1,date2)</td>
<td>返回date1 - date2的日期间隔天数</td>
</tr>
<tr>
<td>TIMEDIFF(time1, time2)</td>
<td>返回time1 - time2的时间间隔</td>
</tr>
<tr>
<td>FROM_DAYS(N)</td>
<td>返回从0000年1月1日起，N天以后的日期</td>
</tr>
<tr>
<td>TO_DAYS(date)</td>
<td>返回日期date距离0000年1月1日的天数</td>
</tr>
<tr>
<td>LAST_DAY(date)</td>
<td>返回date所在月份的最后一天的日期</td>
</tr>
<tr>
<td>MAKEDATE(year,n)</td>
<td>针对给定年份与所在年份中的天数返回一个日期</td>
</tr>
<tr>
<td>MAKETIME(hour,minute,second)</td>
<td>将给定的小时、分钟和秒组合成时间并返回</td>
</tr>
<tr>
<td>PERIOD_ADD(time,n)</td>
<td>返回time加上n后的时间</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> NOW(),DATE_ADD(NOW(),<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">YEAR</span>),</span><br><span class="line">DATE_ADD(NOW(),<span class="type">INTERVAL</span> <span class="number">-1</span> <span class="keyword">YEAR</span>),</span><br><span class="line">DATE_SUB(NOW(),<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">YEAR</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181717225.png" alt="MySQL之性能优化/image-20221017181717225"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATE_ADD(NOW(), <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>) <span class="keyword">AS</span> col1,DATE_ADD(<span class="string">&#x27;2021-10-21 23:32:12&#x27;</span>,<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">SECOND</span>) <span class="keyword">AS</span> col2,</span><br><span class="line">ADDDATE(<span class="string">&#x27;2021-10-21 23:32:12&#x27;</span>,<span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">SECOND</span>) <span class="keyword">AS</span> col3,</span><br><span class="line">DATE_ADD(<span class="string">&#x27;2021-10-21 23:32:12&#x27;</span>,<span class="type">INTERVAL</span> <span class="string">&#x27;1_1&#x27;</span> MINUTE_SECOND) <span class="keyword">AS</span> col4,</span><br><span class="line">DATE_ADD(NOW(), <span class="type">INTERVAL</span> <span class="number">-1</span> <span class="keyword">YEAR</span>) <span class="keyword">AS</span> col5, #可以是负数</span><br><span class="line">DATE_ADD(NOW(), <span class="type">INTERVAL</span> <span class="string">&#x27;1_1&#x27;</span> YEAR_MONTH) <span class="keyword">AS</span> col6 #需要单引号</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181746984.png" alt="MySQL之性能优化/image-20221017181746984"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ADDTIME(NOW(),<span class="number">20</span>),SUBTIME(NOW(),<span class="number">30</span>),SUBTIME(NOW(),<span class="string">&#x27;1:1:3&#x27;</span>),DATEDIFF(NOW(),<span class="string">&#x27;2021-10-01&#x27;</span>),</span><br><span class="line">TIMEDIFF(NOW(),<span class="string">&#x27;2021-10-25 22:10:10&#x27;</span>),FROM_DAYS(<span class="number">366</span>),TO_DAYS(<span class="string">&#x27;0000-12-25&#x27;</span>),</span><br><span class="line">LAST_DAY(NOW()),MAKEDATE(<span class="keyword">YEAR</span>(NOW()),<span class="number">32</span>),MAKETIME(<span class="number">10</span>,<span class="number">21</span>,<span class="number">23</span>),PERIOD_ADD(<span class="number">20200101010101</span>,<span class="number">10</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017181901921.png" alt="MySQL之性能优化/image-20221017181901921"></p>
<blockquote>
<p>日期的格式化和解析</p>
</blockquote>
<table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>DATE_FORMAT(date,fmt)</td>
<td>按照字符串fmt格式化日期date值</td>
</tr>
<tr>
<td>TIME_FORMAT(time,fmt)</td>
<td>按照字符串fmt格式化时间time值</td>
</tr>
<tr>
<td>GET_FORMAT(date_type,format_type)</td>
<td>返回日期字符串的显示格式</td>
</tr>
<tr>
<td>STR_TO_DATE(str, fmt)</td>
<td>按照字符串fmt对str进行解析，解析为一个日期</td>
</tr>
</tbody></table>
<ul>
<li>函数中fmt参数常用的格式符：</li>
</ul>
<table>
<thead>
<tr>
<th>格式符</th>
<th>说明</th>
<th>格式符</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>%Y</td>
<td>4位数字表示年份</td>
<td>%y</td>
<td>表示两位数字表示年份</td>
</tr>
<tr>
<td>%M</td>
<td>月名表示月份（January,….）</td>
<td>%m</td>
<td>两位数字表示月份 （01,02,03…）</td>
</tr>
<tr>
<td>%b</td>
<td>缩写的月名（Jan.，Feb.，….）</td>
<td>%c</td>
<td>数字表示月份（1,2,3,…）</td>
</tr>
<tr>
<td>%D</td>
<td>英文后缀表示月中的天数 （1st,2nd,3rd,…）</td>
<td>%d</td>
<td>两位数字表示月中的天数(01,02…)</td>
</tr>
<tr>
<td>%e</td>
<td>数字形式表示月中的天数 （1,2,3,4,5…..）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>%H</td>
<td>两位数字表示小数，24小时制 （01,02..）</td>
<td>%h 和%I</td>
<td>两位数字表示小时，12小时制 （01,02..）</td>
</tr>
<tr>
<td>%k</td>
<td>数字形式的小时，24小时制(1,2,3)</td>
<td>%l</td>
<td>数字形式表示小时，12小时制 （1,2,3,4….）</td>
</tr>
<tr>
<td>%i</td>
<td>两位数字表示分钟（00,01,02）</td>
<td>%S 和%s</td>
<td>两位数字表示秒(00,01,02…)</td>
</tr>
<tr>
<td>%W</td>
<td>一周中的星期名称（Sunday…）</td>
<td>%a</td>
<td>一周中的星期缩写（Sun.， Mon.,Tues.，..）</td>
</tr>
<tr>
<td>%w</td>
<td>以数字表示周中的天数 (0&#x3D;Sunday,1&#x3D;Monday….)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>%j</td>
<td>以3位数字表示年中的天数(001,002…)</td>
<td>%U</td>
<td>以数字表示年中的第几周， （1,2,3..）其中Sunday为周中第一 天</td>
</tr>
<tr>
<td>%u</td>
<td>以数字表示年中的第几周， （1,2,3..）其中Monday为周中第一 天</td>
<td></td>
<td></td>
</tr>
<tr>
<td>%T</td>
<td>24小时制</td>
<td>%r</td>
<td>12小时制</td>
</tr>
<tr>
<td>%p</td>
<td>AM或PM</td>
<td>%%</td>
<td>表示%</td>
</tr>
</tbody></table>
<ul>
<li>函数中date_type和format_type参数取值如下：</li>
</ul>
<p><img src="image-20221017153318416.png" alt="MySQL之性能优化/image-20221017153318416"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 日期的格式化与解析</span><br><span class="line"># 格式化：日期 <span class="comment">---&gt; 字符串</span></span><br><span class="line"># 解析：  字符串 <span class="comment">----&gt; 日期</span></span><br><span class="line"></span><br><span class="line"># 隐式的格式化或解析</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> hire_date <span class="operator">=</span> <span class="string">&#x27;1993-01-13&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>格式化</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATE_FORMAT(CURDATE(),<span class="string">&#x27;%Y-%M-%D&#x27;</span>),</span><br><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%Y-%m-%d&#x27;</span>),TIME_FORMAT(CURTIME(),<span class="string">&#x27;%h:%i:%S&#x27;</span>),</span><br><span class="line">DATE_FORMAT(NOW(),<span class="string">&#x27;%Y-%M-%D %h:%i:%S %W %w %T %r&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182121058.png" alt="MySQL之性能优化/image-20221017182121058"></p>
<blockquote>
<p>解析：格式化的逆过程</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> STR_TO_DATE(<span class="string">&#x27;2021-October-25th 11:37:30 Monday 1&#x27;</span>,<span class="string">&#x27;%Y-%M-%D %h:%i:%S %W %w&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182213614.png" alt="MySQL之性能优化/image-20221017182213614"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GET_FORMAT(<span class="type">DATE</span>,<span class="string">&#x27;USA&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182240479.png" alt="MySQL之性能优化/image-20221017182240479"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATE_FORMAT(CURDATE(),GET_FORMAT(<span class="type">DATE</span>,<span class="string">&#x27;USA&#x27;</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182303546.png" alt="MySQL之性能优化/image-20221017182303546"></p>
<h3 id="2-5-4-流程控制函数"><a href="#2-5-4-流程控制函数" class="headerlink" title="2.5.4 流程控制函数"></a>2.5.4 流程控制函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>IF(value,value1,value2)</td>
<td>如果value的值为TRUE，返回value1， 否则返回value2</td>
</tr>
<tr>
<td>IFNULL(value1, value2)</td>
<td>如果value1不为NULL，返回value1，否 则返回value2</td>
</tr>
<tr>
<td>CASE WHEN 条件1 THEN 结果1 WHEN 条件2 THEN 结果2 …. [ELSE resultn] END</td>
<td>相当于Java的if…else if…else…</td>
</tr>
<tr>
<td>CASE expr WHEN 常量值1 THEN 值1 WHEN 常量值1 THEN 值1 …. [ELSE 值n] END</td>
<td>相当于Java的switch…case…</td>
</tr>
</tbody></table>
<blockquote>
<p>IF(VALUE,VALUE1,VALUE2)</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,salary,IF(salary <span class="operator">&gt;=</span> <span class="number">6000</span>,<span class="string">&#x27;高工资&#x27;</span>,<span class="string">&#x27;低工资&#x27;</span>) &quot;details&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017183025980.png" alt="MySQL之性能优化/image-20221017183025980"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,commission_pct,IF(commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,commission_pct,<span class="number">0</span>) &quot;details&quot;,</span><br><span class="line">salary <span class="operator">*</span> <span class="number">12</span> <span class="operator">*</span> (<span class="number">1</span> <span class="operator">+</span> IF(commission_pct <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,commission_pct,<span class="number">0</span>)) &quot;annual_sal&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017183138754.png" alt="MySQL之性能优化/image-20221017183138754"></p>
<blockquote>
<p>IFNULL(VALUE1,VALUE2)：看做是IF(VALUE,VALUE1,VALUE2)的特殊情况</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,commission_pct,IFNULL(commission_pct,<span class="number">0</span>) &quot;details&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017183241950.png" alt="MySQL之性能优化/image-20221017183241950"></p>
<blockquote>
<p>CASE WHEN … THEN …WHEN … THEN … ELSE … END</p>
</blockquote>
<ul>
<li>类似于java的if … else if … else if … else</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,salary,<span class="keyword">CASE</span> <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">15000</span> <span class="keyword">THEN</span> <span class="string">&#x27;白骨精&#x27;</span> </span><br><span class="line">			     <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span> <span class="string">&#x27;潜力股&#x27;</span></span><br><span class="line">			     <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">8000</span> <span class="keyword">THEN</span> <span class="string">&#x27;小屌丝&#x27;</span></span><br><span class="line">			     <span class="keyword">ELSE</span> <span class="string">&#x27;草根&#x27;</span> <span class="keyword">END</span> &quot;details&quot;,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p>![MySQL之性能优化&#x2F;image-20221017183402483]MySQL之性能优化&#x2F;image-20221017183402483.png)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> last_name,salary,<span class="keyword">CASE</span> <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">15000</span> <span class="keyword">THEN</span> <span class="string">&#x27;白骨精&#x27;</span> </span><br><span class="line">			     <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span> <span class="string">&#x27;潜力股&#x27;</span></span><br><span class="line">			     <span class="keyword">WHEN</span> salary <span class="operator">&gt;=</span> <span class="number">8000</span> <span class="keyword">THEN</span> <span class="string">&#x27;小屌丝&#x27;</span></span><br><span class="line">			     <span class="keyword">END</span> &quot;details&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p>![MySQL之性能优化&#x2F;image-20221017183430589]MySQL之性能优化&#x2F;image-20221017183430589.png)</p>
<blockquote>
<p>CASE … WHEN … THEN … WHEN … THEN … ELSE … END</p>
</blockquote>
<ul>
<li>类似于java的swich … case…</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,department_id,salary,<span class="keyword">CASE</span> department_id <span class="keyword">WHEN</span> <span class="number">10</span> <span class="keyword">THEN</span> salary <span class="operator">*</span> <span class="number">1.1</span></span><br><span class="line">								     <span class="keyword">WHEN</span> <span class="number">20</span> <span class="keyword">THEN</span> salary <span class="operator">*</span> <span class="number">1.2</span></span><br><span class="line">								     <span class="keyword">WHEN</span> <span class="number">30</span> <span class="keyword">THEN</span> salary <span class="operator">*</span> <span class="number">1.3</span></span><br><span class="line">								     <span class="keyword">END</span> &quot;details&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IN</span> (<span class="number">10</span>,<span class="number">20</span>,<span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<p>![MySQL之性能优化&#x2F;image-20221017183605719]MySQL之性能优化&#x2F;image-20221017183605719.png)</p>
<h3 id="2-5-5-加密和解密函数"><a href="#2-5-5-加密和解密函数" class="headerlink" title="2.5.5 加密和解密函数"></a>2.5.5 加密和解密函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>PASSWORD(str)</td>
<td>返回字符串str的加密版本，41位长的字符串。加密结果 不可 逆 ，常用于用户的密码加密</td>
</tr>
<tr>
<td>MD5(str)</td>
<td>返回字符串str的md5加密后的值，也是一种加密方式。若参数为 NULL，则会返回NULL</td>
</tr>
<tr>
<td>SHA(str)</td>
<td>从原明文密码str计算并返回加密后的密码字符串，当参数为 NULL时，返回NULL。 SHA加密算法比MD5更加安全</td>
</tr>
<tr>
<td>ENCODE(value,password_seed)</td>
<td>返回使用password_seed作为加密密码加密value</td>
</tr>
<tr>
<td>DECODE(value,password_seed)</td>
<td>返回使用password_seed作为加密密码解密value</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> MD5(<span class="string">&#x27;mysql&#x27;</span>),SHA(<span class="string">&#x27;mysql&#x27;</span>),MD5(MD5(<span class="string">&#x27;mysql&#x27;</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182418009.png" alt="MySQL之性能优化/image-20221017182418009"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ENCODE(<span class="string">&#x27;atguigu&#x27;</span>,<span class="string">&#x27;mysql&#x27;</span>),DECODE(ENCODE(<span class="string">&#x27;atguigu&#x27;</span>,<span class="string">&#x27;mysql&#x27;</span>),<span class="string">&#x27;mysql&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017185212485.png" alt="MySQL之性能优化/image-20221017185212485"></p>
<h3 id="2-5-6-MySQL信息函数"><a href="#2-5-6-MySQL信息函数" class="headerlink" title="2.5.6 MySQL信息函数"></a>2.5.6 MySQL信息函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>VERSION()</td>
<td>返回当前MySQL的版本号</td>
</tr>
<tr>
<td>CONNECTION_ID()</td>
<td>返回当前MySQL服务器的连接数</td>
</tr>
<tr>
<td>DATABASE()，SCHEMA()</td>
<td>返回MySQL命令行当前所在的数据库</td>
</tr>
<tr>
<td>USER()，CURRENT_USER()、SYSTEM_USER()， SESSION_USER()</td>
<td>返回当前连接MySQL的用户名，返回结果格式为 “主机名@用户名”</td>
</tr>
<tr>
<td>CHARSET(value)</td>
<td>返回字符串value自变量的字符集</td>
</tr>
<tr>
<td>COLLATION(value)</td>
<td>返回字符串value的比较规则</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> VERSION(),CONNECTION_ID(),DATABASE(),SCHEMA(),</span><br><span class="line"><span class="keyword">USER</span>(),<span class="built_in">CURRENT_USER</span>(),CHARSET(<span class="string">&#x27;尚硅谷&#x27;</span>),<span class="keyword">COLLATION</span>(<span class="string">&#x27;尚硅谷&#x27;</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182455733.png" alt="MySQL之性能优化/image-20221017182455733"></p>
<h3 id="2-5-7-其它函数"><a href="#2-5-7-其它函数" class="headerlink" title="2.5.7 其它函数"></a>2.5.7 其它函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>用法</th>
</tr>
</thead>
<tbody><tr>
<td>FORMAT(value,n)</td>
<td>返回对数字value进行格式化后的结果数据。n表示 四舍五入 后保留 到小数点后n位</td>
</tr>
<tr>
<td>CONV(value,from,to)</td>
<td>将value的值进行不同进制之间的转换</td>
</tr>
<tr>
<td>INET_ATON(ipvalue)</td>
<td>将以点分隔的IP地址转化为一个数字</td>
</tr>
<tr>
<td>INET_NTOA(value)</td>
<td>将数字形式的IP地址转化为以点分隔的IP地址</td>
</tr>
<tr>
<td>BENCHMARK(n,expr)</td>
<td>将表达式expr重复执行n次。用于测试MySQL处理expr表达式所耗费 的时间</td>
</tr>
<tr>
<td>CONVERT(value USING char_code)</td>
<td>将value所使用的字符编码修改为char_code</td>
</tr>
</tbody></table>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#如果n的值小于或者等于<span class="number">0</span>，则只保留整数部分</span><br><span class="line"><span class="keyword">SELECT</span> FORMAT(<span class="number">123.125</span>,<span class="number">2</span>),FORMAT(<span class="number">123.125</span>,<span class="number">0</span>),FORMAT(<span class="number">123.125</span>,<span class="number">-2</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182530785.png" alt="MySQL之性能优化/image-20221017182530785"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> CONV(<span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>), CONV(<span class="number">8888</span>,<span class="number">10</span>,<span class="number">16</span>), CONV(<span class="keyword">NULL</span>, <span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182601773.png" alt="MySQL之性能优化/image-20221017182601773"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#以“<span class="number">192.168</span><span class="number">.1</span><span class="number">.100</span>”为例，计算方式为<span class="number">192</span>乘以<span class="number">256</span>的<span class="number">3</span>次方，加上<span class="number">168</span>乘以<span class="number">256</span>的<span class="number">2</span>次方，加上<span class="number">1</span>乘以<span class="number">256</span>，再加上<span class="number">100</span>。</span><br><span class="line"><span class="keyword">SELECT</span> INET_ATON(<span class="string">&#x27;192.168.1.100&#x27;</span>),INET_NTOA(<span class="number">3232235876</span>)</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182625921.png" alt="MySQL之性能优化/image-20221017182625921"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#BENCHMARK()用于测试表达式的执行效率</span><br><span class="line"><span class="keyword">SELECT</span> BENCHMARK(<span class="number">100000</span>,MD5(<span class="string">&#x27;mysql&#x27;</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182649654.png" alt="MySQL之性能优化/image-20221017182649654"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">CONVERT</span>():可以实现字符集的转换</span><br><span class="line"><span class="keyword">SELECT</span> CHARSET(<span class="string">&#x27;atguigu&#x27;</span>),CHARSET(<span class="keyword">CONVERT</span>(<span class="string">&#x27;atguigu&#x27;</span> <span class="keyword">USING</span> <span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"><span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017182717560.png" alt="MySQL之性能优化/image-20221017182717560"></p>
<h2 id="2-6-聚合函数"><a href="#2-6-聚合函数" class="headerlink" title="2.6 聚合函数"></a>2.6 聚合函数</h2><ul>
<li><p>聚合函数作用于一组数据，并对一组数据返回一个值</p>
</li>
<li><p>聚合函数类型 </p>
<ul>
<li>AVG() </li>
<li>SUM() </li>
<li>MAX() </li>
<li>MIN() </li>
<li>COUNT()</li>
</ul>
</li>
<li><p><strong>聚合函数不能嵌套调用。比如不能出现类似“AVG(SUM(字段名称))”形式的调用</strong></p>
</li>
</ul>
<blockquote>
<p>AVG &#x2F; SUM ：只适用于数值类型的字段（或变量）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary),<span class="built_in">SUM</span>(salary),<span class="built_in">AVG</span>(salary) <span class="operator">*</span> <span class="number">107</span></span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017190305789.png" alt="MySQL之性能优化/image-20221017190305789"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#如下的操作没有意义</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(last_name),<span class="built_in">AVG</span>(last_name),<span class="built_in">SUM</span>(hire_date)</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017190326247.png" alt="MySQL之性能优化/image-20221017190326247"></p>
<blockquote>
<p>MAX &#x2F; MIN：适用于数值类型、字符串类型、日期时间类型的字段（或变量）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary),<span class="built_in">MIN</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017190424653.png" alt="MySQL之性能优化/image-20221017190424653"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MAX</span>(last_name),<span class="built_in">MIN</span>(last_name),<span class="built_in">MAX</span>(hire_date),<span class="built_in">MIN</span>(hire_date)</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017190452348.png" alt="MySQL之性能优化/image-20221017190452348"></p>
<blockquote>
<p>COUNT函数</p>
</blockquote>
<ul>
<li><p>COUNT(*)返回表中记录总数，适用于任意数据类型</p>
</li>
<li><p>COUNT(expr) 返回expr不为空的记录总数</p>
</li>
<li><p>计算指定字段在查询结构中出现的个数（不包含NULL值的）</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(employee_id),<span class="built_in">COUNT</span>(salary),<span class="built_in">COUNT</span>(<span class="number">2</span> <span class="operator">*</span> salary),<span class="built_in">COUNT</span>(<span class="number">1</span>),<span class="built_in">COUNT</span>(<span class="number">2</span>),<span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line"><span class="keyword">FROM</span> employees ;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017201209929.png" alt="MySQL之性能优化/image-20221017201209929"></p>
<ul>
<li>问题：用count(*)，count(1)，count(列名)谁好呢?</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">其实，对于MyISAM引擎的表是没有区别的。这种引擎内部有一计数器在维护着行数。 Innodb引擎的表用<span class="built_in">count</span>(<span class="operator">*</span>),<span class="built_in">count</span>(<span class="number">1</span>)直接读行数，复杂度是O(n)，因为innodb真的要去数一遍。但好于具体的<span class="built_in">count</span>(列名)。</span><br></pre></td></tr></table></figure>

<ul>
<li>如何需要统计表中的记录数，使用COUNT(*)、COUNT(1)、COUNT(具体字段) 哪个效率更高呢？</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果使用的是MyISAM 存储引擎，则三者效率相同，都是O(<span class="number">1</span>)</span><br><span class="line">如果使用的是InnoDB 存储引擎，则三者效率：<span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="number">1</span>)<span class="operator">&gt;</span> <span class="built_in">COUNT</span>(字段)</span><br></pre></td></tr></table></figure>

<ul>
<li>问题：能不能使用count(列名)替换count(*)?</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不要使用 <span class="built_in">count</span>(列名)来替代 <span class="built_in">count</span>(<span class="operator">*</span>) ， <span class="built_in">count</span>(<span class="operator">*</span>) 是 SQL92 定义的标准统计行数的语法，跟数 据库无关，跟 <span class="keyword">NULL</span> 和非 <span class="keyword">NULL</span> 无关。 说明：<span class="built_in">count</span>(<span class="operator">*</span>)会统计值为 <span class="keyword">NULL</span> 的行，而 <span class="built_in">count</span>(列名)不会统计此列为 <span class="keyword">NULL</span> 值的行</span><br></pre></td></tr></table></figure>

<h2 id="2-7-group-by"><a href="#2-7-group-by" class="headerlink" title="2.7 group by"></a>2.7 group by</h2><ul>
<li><p>结论1<strong>：SELECT中出现的非组函数的字段必须声明在GROUP BY 中；反之，GROUP BY中声明的字段可以不出现在SELECT中</strong></p>
</li>
<li><p>结论2：GROUP BY 声明在FROM后面、WHERE后面，ORDER BY 前面、LIMIT前面</p>
</li>
<li><p>结论3：MySQL中GROUP BY中使用WITH ROLLUP</p>
</li>
<li><p>结论4：当使用ROLLUP时，不能同时使用ORDER BY子句进行结果排序，<strong>即ROLLUP和ORDER BY是互相排斥的</strong></p>
</li>
<li><p>使用 WITH ROLLUP 关键字之后，在所有查询出的分组记录之后增加一条记录，该记录计算查询出的所 有记录的总和，即统计记录数量</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> department_id,<span class="built_in">AVG</span>(salary) avg_sal</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> avg_sal <span class="keyword">ASC</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017212008013.png" alt="MySQL之性能优化/image-20221017212008013"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> department_id,job_id,<span class="built_in">AVG</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span>  department_id,job_id;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017212133270.png" alt="MySQL之性能优化/image-20221017212133270"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> job_id,department_id,<span class="built_in">AVG</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> job_id,department_id;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221017212209225.png" alt="MySQL之性能优化/image-20221017212209225"></p>
<h2 id="2-8-having"><a href="#2-8-having" class="headerlink" title="2.8 having"></a>2.8 having</h2><ul>
<li>如果过滤条件中使用了<strong>聚合函数</strong>，则必须使用HAVING来替换WHERE。否则，报错</li>
<li>HAVING 必须声明在 GROUP BY 的后面</li>
<li><strong>开发中，使用HAVING的前提是SQL中使用了GROUP BY</strong></li>
<li><strong>当过滤条件中没有聚合函数时，则此过滤条件声明在WHERE中或HAVING中都可以。但是，建议声明在WHERE中</strong></li>
<li>WHERE 与 HAVING 的对比</li>
<li>从适用范围上来讲，HAVING的适用范围更广</li>
<li><strong>如果过滤条件中没有聚合函数：这种情况下，WHERE的执行效率要高于HAVING</strong></li>
</ul>
<h2 id="2-9-SQL执行过程"><a href="#2-9-SQL执行过程" class="headerlink" title="2.9 SQL执行过程"></a>2.9 SQL执行过程</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ....,....,....(存在聚合函数)</span><br><span class="line"><span class="keyword">FROM</span> ... (<span class="keyword">LEFT</span> <span class="operator">/</span> <span class="keyword">RIGHT</span> <span class="operator">/</span> <span class="keyword">INNER</span>)<span class="keyword">JOIN</span> ....<span class="keyword">ON</span> 多表的连接条件 </span><br><span class="line">(<span class="keyword">LEFT</span> <span class="operator">/</span> <span class="keyword">RIGHT</span> <span class="operator">/</span> <span class="keyword">INNER</span>)<span class="keyword">JOIN</span> ... <span class="keyword">ON</span> ....</span><br><span class="line"><span class="keyword">WHERE</span> 不包含聚合函数的过滤条件</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> ...,....</span><br><span class="line"><span class="keyword">HAVING</span> 包含聚合函数的过滤条件</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> ....,...(<span class="keyword">ASC</span> <span class="operator">/</span> <span class="keyword">DESC</span> )</span><br><span class="line">LIMIT ...,....</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- SQL语句的执行过程：</span></span><br><span class="line"><span class="keyword">FROM</span> ...,...<span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">ON</span> <span class="operator">-</span><span class="operator">&gt;</span> (<span class="keyword">LEFT</span><span class="operator">/</span>RIGNT<span class="operator">/</span><span class="keyword">INNER</span>  <span class="keyword">JOIN</span>) <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">WHERE</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">HAVING</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">DISTINCT</span> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="operator">-</span><span class="operator">&gt;</span> LIMIT</span><br></pre></td></tr></table></figure>

<h2 id="2-9-子查询"><a href="#2-9-子查询" class="headerlink" title="2.9 子查询"></a>2.9 子查询</h2><blockquote>
<p>子查询基本使用</p>
</blockquote>
<ul>
<li><p><strong>在SELECT中，除了GROUP BY 和 LIMIT之外，其他位置都可以声明子查询！</strong></p>
</li>
<li><p>子查询语法结构</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>(子查询) form 表 <span class="keyword">where</span> 条件</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> 返回值 form (子查询) <span class="keyword">where</span> 条件</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> 返回值 form 表 <span class="keyword">where</span> (子查询)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> select_list</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">table</span></span><br><span class="line"><span class="keyword">where</span> expr operator (</span><br><span class="line">	<span class="keyword">select</span> select_list</span><br><span class="line">    <span class="keyword">from</span> <span class="keyword">table</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>子查询在主查询之前一次执行完成</li>
<li>子查询的结果被主查询使用 </li>
<li>注意事项 <ul>
<li>子查询要包含在括号内 </li>
<li>将子查询放在比较条件的右侧 </li>
<li><strong>单行操作符对应单行子查询，多行操作符对应多行子查询</strong></li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#由一个具体的需求，引入子查询</span><br><span class="line">#需求：谁的工资比Abel的高？</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">11000</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：自连接</span><br><span class="line"><span class="keyword">SELECT</span> e2.last_name,e2.salary</span><br><span class="line"><span class="keyword">FROM</span> employees e1,employees e2</span><br><span class="line"><span class="keyword">WHERE</span> e2.`salary` <span class="operator">&gt;</span> e1.`salary` #多表的连接条件</span><br><span class="line"><span class="keyword">AND</span> e1.last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">3</span>：子查询</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> salary</span><br><span class="line">		<span class="keyword">FROM</span> employees</span><br><span class="line">		<span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span></span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>子查询的编写技巧（或步骤）：① 从里往外写  ② 从外往里写</strong></li>
</ul>
<blockquote>
<p>select中嵌套子查询</p>
</blockquote>
<blockquote>
<p>from中嵌套子查询</p>
</blockquote>
<blockquote>
<p>where中嵌套子查询</p>
</blockquote>
<h3 id="2-9-1-单行子查询"><a href="#2-9-1-单行子查询" class="headerlink" title="2.9.1 单行子查询"></a>2.9.1 单行子查询</h3><blockquote>
<p>单行比较操作符</p>
</blockquote>
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>&#x3D;</td>
<td>equal to</td>
</tr>
<tr>
<td>&gt;</td>
<td>greater than</td>
</tr>
<tr>
<td>&gt;&#x3D;</td>
<td>greater than or equal to</td>
</tr>
<tr>
<td>&lt;</td>
<td>less than</td>
</tr>
<tr>
<td>&lt;&#x3D;</td>
<td>less than or equal to</td>
</tr>
<tr>
<td>&lt;&gt;  !&#x3D;</td>
<td>not equal to</td>
</tr>
</tbody></table>
<ul>
<li><strong>子查询返回的结果的条目数只有一条</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">149</span></span><br></pre></td></tr></table></figure>

<p><img src="image-20221018133011491.png" alt="MySQL之性能优化/image-20221018133011491"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> salary</span><br><span class="line">		<span class="keyword">FROM</span> employees</span><br><span class="line">		<span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">149</span></span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221018133044570.png" alt="MySQL之性能优化/image-20221018133044570"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询与<span class="number">141</span>号员工的manager_id和department_id相同的其他员工</span><br><span class="line">#的employee_id，manager_id，department_id。</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,manager_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> manager_id <span class="operator">=</span> (</span><br><span class="line">		    <span class="keyword">SELECT</span> manager_id</span><br><span class="line">		    <span class="keyword">FROM</span> employees</span><br><span class="line">		    <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">141</span></span><br><span class="line">		   )</span><br><span class="line"><span class="keyword">AND</span> department_id <span class="operator">=</span> (</span><br><span class="line">		    <span class="keyword">SELECT</span> department_id</span><br><span class="line">		    <span class="keyword">FROM</span> employees</span><br><span class="line">		    <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">141</span></span><br><span class="line">		   )</span><br><span class="line"><span class="keyword">AND</span> employee_id <span class="operator">&lt;&gt;</span> <span class="number">141</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：了解</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,manager_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> (manager_id,department_id) <span class="operator">=</span> (</span><br><span class="line">				    <span class="keyword">SELECT</span> manager_id,department_id</span><br><span class="line">			        <span class="keyword">FROM</span> employees</span><br><span class="line">				    <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">141</span></span><br><span class="line">				   )</span><br><span class="line"><span class="keyword">AND</span> employee_id <span class="operator">&lt;&gt;</span> <span class="number">141</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>HAVING 中的子查询 </p>
</blockquote>
<ul>
<li>首先执行子查询</li>
<li>向主查询中的HAVING子句返回结果</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> department_id,<span class="built_in">MIN</span>(salary)</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">MIN</span>(salary) <span class="operator">&gt;</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary)</span><br><span class="line">			<span class="keyword">FROM</span> employees</span><br><span class="line">			<span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">110</span></span><br><span class="line">		     );</span><br></pre></td></tr></table></figure>

<blockquote>
<p> CASE中的子查询</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#题目：显式员工的employee_id,last_name和location。</span><br><span class="line">#其中，若员工department_id与location_id为<span class="number">1800</span>的department_id相同，</span><br><span class="line">#则location为’Canada’，其余则为’USA’。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,<span class="keyword">CASE</span> department_id <span class="keyword">WHEN</span> (<span class="keyword">SELECT</span> department_id <span class="keyword">FROM</span> departments <span class="keyword">WHERE</span> location_id <span class="operator">=</span> <span class="number">1800</span>) <span class="keyword">THEN</span> <span class="string">&#x27;Canada&#x27;</span></span><br><span class="line">						<span class="keyword">ELSE</span> <span class="string">&#x27;USA&#x27;</span> <span class="keyword">END</span> &quot;location&quot;</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>子查询中的空值问题</p>
</blockquote>
<ul>
<li>子查询不返回任何行</li>
<li>最后结果为空</li>
</ul>
<blockquote>
<p>非法使用子查询</p>
</blockquote>
<ul>
<li>错误：Subquery returns more than 1 row</li>
</ul>
<h3 id="2-9-2-多行子查询"><a href="#2-9-2-多行子查询" class="headerlink" title="2.9.2 多行子查询"></a>2.9.2 多行子查询</h3><ul>
<li>也称为集合比较子查询 </li>
<li>内查询返回多行 </li>
<li>使用多行比较操作符</li>
</ul>
<blockquote>
<p>多行比较操作符</p>
</blockquote>
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>IN</td>
<td>等于列表中的<strong>任意一个</strong></td>
</tr>
<tr>
<td>ANY</td>
<td>需要和单行比较操作符一起使用，和子查询返回的<strong>某一个</strong>值比较</td>
</tr>
<tr>
<td>ALL</td>
<td>需要和单行比较操作符一起使用，和子查询返回的<strong>所有</strong>值比较</td>
</tr>
<tr>
<td>SOME</td>
<td>实际上是ANY的别名，作用相同，一般常使用ANY</td>
</tr>
</tbody></table>
<blockquote>
<p>IN</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) <span class="keyword">FROM</span> employees <span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221018134857657.png" alt="MySQL之性能优化/image-20221018134857657"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id, last_name</span><br><span class="line"><span class="keyword">FROM</span>   employees</span><br><span class="line"><span class="keyword">WHERE</span>  salary <span class="keyword">IN</span></span><br><span class="line">                (<span class="keyword">SELECT</span>   <span class="built_in">MIN</span>(salary)</span><br><span class="line">                 <span class="keyword">FROM</span>     employees</span><br><span class="line">                 <span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id); </span><br></pre></td></tr></table></figure>

<p><img src="image-20221018134933092.png" alt="MySQL之性能优化/image-20221018134933092"></p>
<blockquote>
<p>ANY &#x2F; ALL</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#题目：返回其它job_id中比job_id为‘IT_PROG’部门任一工资低的员工的员工号、</span><br><span class="line">#姓名、job_id 以及salary</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> job_id <span class="operator">&lt;&gt;</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> salary <span class="operator">&lt;</span> <span class="keyword">ANY</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> salary</span><br><span class="line">		<span class="keyword">FROM</span> employees</span><br><span class="line">		<span class="keyword">WHERE</span> job_id <span class="operator">=</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">#题目：返回其它job_id中比job_id为‘IT_PROG’部门所有工资低的员工的员工号、</span><br><span class="line">#姓名、job_id 以及salary</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> job_id <span class="operator">&lt;&gt;</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> salary <span class="operator">&lt;</span> <span class="keyword">ALL</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> salary</span><br><span class="line">		<span class="keyword">FROM</span> employees</span><br><span class="line">		<span class="keyword">WHERE</span> job_id <span class="operator">=</span> <span class="string">&#x27;IT_PROG&#x27;</span></span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询平均工资最低的部门id</span><br><span class="line">#MySQL中聚合函数是不能嵌套使用的。</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">AVG</span>(salary) <span class="operator">=</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(avg_sal)</span><br><span class="line">			<span class="keyword">FROM</span>(</span><br><span class="line">				<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) avg_sal</span><br><span class="line">				<span class="keyword">FROM</span> employees</span><br><span class="line">				<span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line">				) t_dept_avg_sal</span><br><span class="line">			);</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SELECT</span> department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="built_in">AVG</span>(salary) <span class="operator">&lt;=</span> <span class="keyword">ALL</span>(	</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) avg_sal</span><br><span class="line">			<span class="keyword">FROM</span> employees</span><br><span class="line">			<span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line">			) </span><br></pre></td></tr></table></figure>

<blockquote>
<p>空值问题</p>
</blockquote>
<ul>
<li>子查询结果中包含NULL值</li>
</ul>
<h3 id="2-9-3-相关子查询"><a href="#2-9-3-相关子查询" class="headerlink" title="2.9.3 相关子查询"></a>2.9.3 相关子查询</h3><ul>
<li><p>如果子查询的执行依赖于外部查询，通常情况下都是因为子查询中的表用到了外部的表，并进行了条件 关联，因此每执行一次外部查询，子查询都要重新计算一次，这样的子查询就称之为<strong>关联子查询</strong></p>
</li>
<li><p>相关子查询按照一行接一行的顺序执行，主查询的每一行都执行一次子查询</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询员工中工资大于本部门平均工资的员工的last_name,salary和其department_id</span><br><span class="line">#使用相关子查询</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary)</span><br><span class="line">		<span class="keyword">FROM</span> employees e2</span><br><span class="line">		<span class="keyword">WHERE</span> department_id <span class="operator">=</span> e1.`department_id` #使用了主查询的 e1.`department_id`</span><br><span class="line">        #主查询影响子查询的查询结果</span><br><span class="line">		);</span><br><span class="line">#查询步骤</span><br><span class="line">#<span class="number">1.</span>主查询遍历employees表的记录，得到每一条记录的last_name,salary,department_id</span><br><span class="line">#<span class="number">2.</span>每条记录的结果都进入子查询，得到当前记录department_id的<span class="built_in">AVG</span>(salary)</span><br><span class="line">#<span class="number">3.</span>主查询当前记录的salary和子查询的<span class="built_in">AVG</span>(salary)比较，结果为真，则输出last_name,salary,department_id</span><br></pre></td></tr></table></figure>

<p><img src="image-20221020140220340.png" alt="MySQL之性能优化/image-20221020140220340"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询员工的id,salary,按照department_name 排序</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,salary</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (</span><br><span class="line">	 <span class="keyword">SELECT</span> department_name</span><br><span class="line">	 <span class="keyword">FROM</span> departments d</span><br><span class="line">	 <span class="keyword">WHERE</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line">	) <span class="keyword">ASC</span>;</span><br><span class="line">#查询步骤：</span><br><span class="line">#<span class="number">1.</span>主查询查询遍历 employees 表的每一条记录，将查询得到的每条记录的 `department_id` 字段给子查询</span><br><span class="line">#<span class="number">2.</span>子查询根据主查询的 `department_id` 字段值得到当前记录的 `department_name` 字段值</span><br><span class="line">#<span class="number">3.</span>通过 `department_name` 字段值排序</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#题目：若employees表中employee_id与job_history表中employee_id相同的数目不小于<span class="number">2</span>，</span><br><span class="line">#输出这些相同id的员工的employee_id,last_name和其job_id</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id</span><br><span class="line"><span class="keyword">FROM</span> employees e</span><br><span class="line"><span class="keyword">WHERE</span> <span class="number">2</span> <span class="operator">&lt;=</span> (</span><br><span class="line">	    <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>)</span><br><span class="line">	    <span class="keyword">FROM</span> job_history j</span><br><span class="line">	    <span class="keyword">WHERE</span> e.`employee_id` <span class="operator">=</span> j.`employee_id`</span><br><span class="line">		)</span><br></pre></td></tr></table></figure>

<p><img src="image-20221020141845067.png" alt="MySQL之性能优化/image-20221020141845067"></p>
<blockquote>
<p>EXISTS 与 NOT EXISTS关键字</p>
</blockquote>
<ul>
<li><p><strong>关联子查询</strong>通常也会和 EXISTS操作符一起来使用，用来检查在子查询中是否存在满足条件的行。 </p>
</li>
<li><p><strong>如果在子查询中不存在满足条件的行：</strong> </p>
<ul>
<li>条件返回 FALSE </li>
<li>继续在子查询中查找</li>
</ul>
</li>
<li><p><strong>如果在子查询中存在满足条件的行：</strong> </p>
<ul>
<li>不在子查询中继续查找 </li>
<li>条件返回 TRUE</li>
</ul>
</li>
<li><p>NOT EXISTS关键字表示如果不存在某种条件，则返回TRUE，否则返回FALSE</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询公司管理者的employee_id，last_name，job_id，department_id信息</span><br><span class="line">#方式<span class="number">1</span>：自连接</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> mgr.employee_id,mgr.last_name,mgr.job_id,mgr.department_id</span><br><span class="line"><span class="keyword">FROM</span> employees emp <span class="keyword">JOIN</span> employees mgr</span><br><span class="line"><span class="keyword">ON</span> emp.manager_id <span class="operator">=</span> mgr.employee_id;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：子查询</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="keyword">IN</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> manager_id</span><br><span class="line">			<span class="keyword">FROM</span> employees</span><br><span class="line">			);</span><br><span class="line"></span><br><span class="line">#方式<span class="number">3</span>：使用<span class="keyword">EXISTS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,job_id,department_id</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">	       <span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">	       <span class="keyword">FROM</span> employees e2</span><br><span class="line">	       <span class="keyword">WHERE</span> e1.`employee_id` <span class="operator">=</span> e2.`manager_id`</span><br><span class="line">	     );</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#题目：查询departments表中，不存在于employees表中的部门的department_id和department_name</span><br><span class="line"></span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SELECT</span> d.department_id,d.department_name</span><br><span class="line"><span class="keyword">FROM</span> employees e <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> departments d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`</span><br><span class="line"><span class="keyword">WHERE</span> e.`department_id` <span class="keyword">IS</span> <span class="keyword">NULL</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SELECT</span> department_id,department_name</span><br><span class="line"><span class="keyword">FROM</span> departments d</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> (</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line">		<span class="keyword">FROM</span> employees e</span><br><span class="line">		<span class="keyword">WHERE</span> d.`department_id` <span class="operator">=</span> e.`department_id`</span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<h1 id="3-SQL之DDL、DML、DCL"><a href="#3-SQL之DDL、DML、DCL" class="headerlink" title="3.SQL之DDL、DML、DCL"></a>3.SQL之DDL、DML、DCL</h1><h2 id="3-1-基础知识"><a href="#3-1-基础知识" class="headerlink" title="3.1 基础知识"></a>3.1 基础知识</h2><blockquote>
<p>一条数据存储的过程</p>
</blockquote>
<ul>
<li><p><code>存储数据是处理数据的第一步</code>。只有正确地把数据存储起来，我们才能进行有效的处理和分析。否则，只能是一团乱麻，无从下手</p>
</li>
<li><p>那么，怎样才能把用户各种经营相关的、纷繁复杂的数据，有序、高效地存储起来呢？ 在 MySQL 中，一个完整的数据存储过程总共有 4 步，分别是创建数据库、确认字段、创建数据表、插入数据</p>
</li>
</ul>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736718-1767374266.png" alt="MySQL之性能优化/image-20211007155810920"></p>
<ul>
<li><p>我们要先创建一个数据库，而不是直接创建数据表</p>
</li>
<li><p>因为从系统架构的层次上看，MySQL 数据库系统从大到小依次是<code>数据库服务器</code>、<code>数据库</code>、<code>数据表</code>、数据表的<code>行与列</code></p>
</li>
</ul>
<blockquote>
<p>标识符命名规则</p>
</blockquote>
<ul>
<li>数据库名、表名不得超过30个字符，变量名限制为29个</li>
<li>必须只能包含 A–Z, a–z, 0–9, _共63个字符</li>
<li>数据库名、表名、字段名等对象名中间不要包含空格</li>
<li>同一个MySQL软件中，数据库不能同名；同一个库中，表不能重名；同一个表中，字段不能重名</li>
<li>必须保证你的字段没有和保留字、数据库系统或常用方法冲突。如果坚持使用，请在SQL语句中使用&#96;（着重号）引起来</li>
<li>保持字段名和类型的一致性：在命名字段并为其指定数据类型的时候一定要保证一致性，假如数据类型在一个表里是整数，那在另一个表里可就别变成字符型了</li>
</ul>
<blockquote>
<p>MySQL中的数据类型</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">类型举例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">整数类型</td>
<td align="left">TINYINT、SMALLINT、MEDIUMINT、**INT(或INTEGER)**、BIGINT</td>
</tr>
<tr>
<td align="left">浮点类型</td>
<td align="left">FLOAT、DOUBLE</td>
</tr>
<tr>
<td align="left">定点数类型</td>
<td align="left"><strong>DECIMAL</strong></td>
</tr>
<tr>
<td align="left">位类型</td>
<td align="left">BIT</td>
</tr>
<tr>
<td align="left">日期时间类型</td>
<td align="left">YEAR、TIME、<strong>DATE</strong>、DATETIME、TIMESTAMP</td>
</tr>
<tr>
<td align="left">文本字符串类型</td>
<td align="left">CHAR、<strong>VARCHAR</strong>、TINYTEXT、TEXT、MEDIUMTEXT、LONGTEXT</td>
</tr>
<tr>
<td align="left">枚举类型</td>
<td align="left">ENUM</td>
</tr>
<tr>
<td align="left">集合类型</td>
<td align="left">SET</td>
</tr>
<tr>
<td align="left">二进制字符串类型</td>
<td align="left">BINARY、VARBINARY、TINYBLOB、BLOB、MEDIUMBLOB、LONGBLOB</td>
</tr>
<tr>
<td align="left">JSON类型</td>
<td align="left">JSON对象、JSON数组</td>
</tr>
<tr>
<td align="left">空间数据类型</td>
<td align="left">单值：GEOMETRY、POINT、LINESTRING、POLYGON； 集合：MULTIPOINT、MULTILINESTRING、MULTIPOLYGON、GEOMETRYCOLLECTION</td>
</tr>
</tbody></table>
<p><strong>其中，常用的几类类型介绍如下：</strong></p>
<table>
<thead>
<tr>
<th align="left">数据类型</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">INT</td>
<td align="left">从-231到231-1的整型数据。存储大小为 4个字节</td>
</tr>
<tr>
<td align="left">CHAR(size)</td>
<td align="left">定长字符数据。若未指定，默认为1个字符，最大长度255</td>
</tr>
<tr>
<td align="left">VARCHAR(size)</td>
<td align="left">可变长字符数据，根据字符串实际长度保存，<strong>必须指定长度</strong></td>
</tr>
<tr>
<td align="left">FLOAT(M,D)</td>
<td align="left">单精度，占用4个字节，M&#x3D;整数位+小数位，D&#x3D;小数位。 D&lt;&#x3D;M&lt;&#x3D;255,0&lt;&#x3D;D&lt;&#x3D;30，默认M+D&lt;&#x3D;6</td>
</tr>
<tr>
<td align="left">DOUBLE(M,D)</td>
<td align="left">双精度，占用8个字节，D&lt;&#x3D;M&lt;&#x3D;255,0&lt;&#x3D;D&lt;&#x3D;30，默认M+D&lt;&#x3D;15</td>
</tr>
<tr>
<td align="left">DECIMAL(M,D)</td>
<td align="left">高精度小数，占用M+2个字节，D&lt;&#x3D;M&lt;&#x3D;65，0&lt;&#x3D;D&lt;&#x3D;30，最大取值范围与DOUBLE相同。</td>
</tr>
<tr>
<td align="left">DATE</td>
<td align="left">日期型数据，格式’YYYY-MM-DD’</td>
</tr>
<tr>
<td align="left">BLOB</td>
<td align="left">二进制形式的长文本数据，最大可达4G</td>
</tr>
<tr>
<td align="left">TEXT</td>
<td align="left">长文本数据，最大可达4G</td>
</tr>
</tbody></table>
<h2 id="3-2-数据库处理之增删改"><a href="#3-2-数据库处理之增删改" class="headerlink" title="3.2 数据库处理之增删改"></a>3.2 数据库处理之增删改</h2><blockquote>
<p>1.创建数据库</p>
</blockquote>
<ul>
<li>方式1：创建数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE 数据库名; </span><br></pre></td></tr></table></figure>

<ul>
<li>方式2：创建数据库并指定字符集</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE 数据库名 <span class="type">CHARACTER</span> <span class="keyword">SET</span> 字符集;</span><br></pre></td></tr></table></figure>

<ul>
<li>方式3：判断数据库是否已经存在，不存在则创建数据库（<code>推荐</code>）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> 数据库名; </span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果MySQL中已经存在相关的数据库，则忽略创建语句，不再创建数据库</p>
</li>
<li><p><strong>注意：DATABASE 不能改名。一些可视化工具可以改名，它是建新库，把所有表复制到新库，再删旧库完成的</strong></p>
</li>
</ul>
<blockquote>
<p>2.使用数据库</p>
</blockquote>
<ul>
<li>查看当前所有的数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> DATABASES; #有一个S，代表多个数据库</span><br></pre></td></tr></table></figure>

<ul>
<li>查看当前正在使用的数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> DATABASE();  #使用的一个 mysql 中的全局函数</span><br></pre></td></tr></table></figure>

<ul>
<li>查看指定库下所有的表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TABLES <span class="keyword">FROM</span> 数据库名;</span><br><span class="line">#查看当前使用的数据库</span><br><span class="line"><span class="keyword">SELECT</span> DATABASE() <span class="keyword">FROM</span> DUAL;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看数据库的创建信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE 数据库名;</span><br><span class="line">或者：</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> DATABASE 数据库名\G</span><br></pre></td></tr></table></figure>

<ul>
<li>使用&#x2F;切换数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE 数据库名;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意：要操作表格和数据之前必须先说明是对哪个数据库进行操作，否则就要对所有对象加上“数据库名.”</li>
</ul>
<blockquote>
<p>3.修改数据库</p>
</blockquote>
<ul>
<li>更改数据库字符集</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE 数据库名 <span class="type">CHARACTER</span> <span class="keyword">SET</span> 字符集;  #比如：gbk、utf8等</span><br></pre></td></tr></table></figure>

<blockquote>
<p>4.删除数据库</p>
</blockquote>
<ul>
<li>方式1：删除指定的数据库</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE 数据库名;</span><br></pre></td></tr></table></figure>

<ul>
<li>方式2：删除指定的数据库（<code>推荐</code>）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> DATABASE IF <span class="keyword">EXISTS</span> 数据库名;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-创建和管理表"><a href="#3-3-创建和管理表" class="headerlink" title="3.3 创建和管理表"></a>3.3 创建和管理表</h2><blockquote>
<p>创建方式1</p>
</blockquote>
<ul>
<li>必须具备：<ul>
<li>CREATE TABLE权限</li>
<li>存储空间</li>
</ul>
</li>
<li><strong>语法格式：</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] 表名(</span><br><span class="line">	字段<span class="number">1</span>, 数据类型 [约束条件] [默认值],</span><br><span class="line">	字段<span class="number">2</span>, 数据类型 [约束条件] [默认值],</span><br><span class="line">	字段<span class="number">3</span>, 数据类型 [约束条件] [默认值],</span><br><span class="line">	……</span><br><span class="line">	[表约束条件]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>加上了IF NOT EXISTS关键字，则表示：如果当前数据库中不存在要创建的数据表，则创建数据表；如果当前数据库中已经存在要创建的数据表，则忽略建表语句，不再创建数据表</p>
</li>
<li><p>必须指定：</p>
<ul>
<li>表名</li>
<li>列名(或字段名)，数据类型，<strong>长度</strong></li>
</ul>
</li>
<li><p>可选指定：</p>
<ul>
<li>约束条件</li>
<li>默认值</li>
</ul>
</li>
<li><p>创建表举例1：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp (</span><br><span class="line">  <span class="comment">-- int类型</span></span><br><span class="line">  emp_id <span class="type">INT</span>,</span><br><span class="line">  <span class="comment">-- 最多保存20个中英文字符</span></span><br><span class="line">  emp_name <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">  <span class="comment">-- 总位数不超过15位</span></span><br><span class="line">  salary <span class="keyword">DOUBLE</span>,</span><br><span class="line">  <span class="comment">-- 日期类型</span></span><br><span class="line">  birthday <span class="type">DATE</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> emp;</span><br></pre></td></tr></table></figure>

<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736483-1854082855.png" alt="MySQL之性能优化/image-20211016160557995"></p>
<ul>
<li><p>MySQL在执行建表语句时，将id字段的类型设置为<code>int(11)</code>，这里的11实际上是<code>int</code>类型指定的显示宽度，默认的显示宽度为11。也可以在创建数据表的时候指定数据的显示宽度</p>
</li>
<li><p>创建表举例2：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept(</span><br><span class="line">    <span class="comment">-- int类型，自增</span></span><br><span class="line">	deptno <span class="type">INT</span>(<span class="number">2</span>) AUTO_INCREMENT,</span><br><span class="line">	dname <span class="type">VARCHAR</span>(<span class="number">14</span>),</span><br><span class="line">	loc <span class="type">VARCHAR</span>(<span class="number">13</span>),</span><br><span class="line">    <span class="comment">-- 主键</span></span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (deptno)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESCRIBE</span> dept;</span><br></pre></td></tr></table></figure>

<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013736269-113188414.png" alt="MySQL之性能优化/image-20211016160643445"></p>
<ul>
<li><strong>在MySQL 8.x版本中，不再推荐为INT类型指定显示长度，并在未来的版本中可能去掉这样的语法</strong></li>
</ul>
<blockquote>
<p>查询数据表结构</p>
</blockquote>
<ul>
<li>在MySQL中创建好数据表之后，可以查看数据表的结构。MySQL支持使用<code>DESCRIBE/DESC</code>语句查看数据表结构，也支持使用<code>SHOW CREATE TABLE</code>语句查看数据表结构</li>
</ul>
<p>语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名\G</span><br></pre></td></tr></table></figure>

<ul>
<li>使用SHOW CREATE TABLE语句不仅可以查看表创建时的详细语句，还可以查看存储引擎和字符编码</li>
</ul>
<blockquote>
<p>创建方式2：将查询的结果作为新建表的数据</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#基于现有的表，同时导入数据</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> myemp2</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> myemp2;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221020231406773.png" alt="MySQL之性能优化/image-20221020231406773"></p>
<blockquote>
<p>修改表</p>
</blockquote>
<ul>
<li>修改表指的是修改数据库中已经存在的数据表的结构</li>
</ul>
<p><strong>使用 ALTER TABLE 语句可以实现：</strong></p>
<ul>
<li>向已有的表中添加列</li>
<li>修改现有表中的列</li>
<li>删除现有表中的列</li>
<li>重命名现有表中的列</li>
</ul>
<blockquote>
<blockquote>
<p>追加一个列 ADD</p>
</blockquote>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span> [COLUM] 字段名 字段类型 [<span class="keyword">FIRST</span><span class="operator">|</span>AFTER 字段名];</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line"><span class="keyword">ADD</span> salary <span class="keyword">DOUBLE</span>(<span class="number">10</span>,<span class="number">2</span>); #默认添加到表中的最后一个字段的位置</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line"><span class="keyword">ADD</span> phone_number <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">FIRST</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line"><span class="keyword">ADD</span> email <span class="type">VARCHAR</span>(<span class="number">45</span>) AFTER emp_name;</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<p>修改一个列 MODIFY</p>
</blockquote>
</blockquote>
<ul>
<li>可以修改列的数据类型，长度、默认值和位置</li>
<li>修改字段数据类型、长度、默认值、位置的语法格式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 MODIFY [<span class="keyword">COLUMN</span>] 字段名<span class="number">1</span> 字段类型 [<span class="keyword">DEFAULT</span> 默认值][<span class="keyword">FIRST</span><span class="operator">|</span>AFTER 字段名</span><br><span class="line"><span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line">MODIFY emp_name <span class="type">VARCHAR</span>(<span class="number">25</span>) ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line">MODIFY emp_name <span class="type">VARCHAR</span>(<span class="number">35</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;aaa&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<p>重命名一个列 CHANGE</p>
</blockquote>
</blockquote>
<ul>
<li>使用 CHANGE old_column new_column dataType子句重命名列。语法格式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 CHANGE [<span class="keyword">column</span>] 列名 新列名 新数据类型;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line">CHANGE salary monthly_salary <span class="keyword">DOUBLE</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> myemp1</span><br><span class="line">CHANGE email my_email <span class="type">VARCHAR</span>(<span class="number">50</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<blockquote>
<p>删除一个列 DROP</p>
</blockquote>
</blockquote>
<ul>
<li>删除表中某个字段的语法格式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">DROP</span> [COLUM]字段名</span><br></pre></td></tr></table></figure>

<blockquote>
<p>重命名表</p>
</blockquote>
<ul>
<li>方式一：使用RENAME</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RENAME <span class="keyword">TABLE</span> emp</span><br><span class="line"><span class="keyword">TO</span> myemp;</span><br></pre></td></tr></table></figure>

<ul>
<li>方式二：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">table</span> emp</span><br><span class="line">RENAME [<span class="keyword">TO</span>] myemp;  <span class="comment">-- [TO]可以省略</span></span><br></pre></td></tr></table></figure>

<ul>
<li>必须是对象的拥有者</li>
</ul>
<blockquote>
<p>删除表</p>
</blockquote>
<ul>
<li>在MySQL中，当一张数据表<code>没有与其他任何数据表形成关联关系</code>时，<strong>可以将当前数据表直接删除</strong></li>
<li>数据和结构都被删除</li>
<li>所有正在运行的相关事务被提交</li>
<li>所有相关索引被删除</li>
<li>语法格式：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [IF <span class="keyword">EXISTS</span>] 数据表<span class="number">1</span> [, 数据表<span class="number">2</span>, …, 数据表n];</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>IF EXISTS</code>的含义为：如果当前数据库中存在相应的数据表，则删除数据表；如果当前数据库中不存在相应的数据表，则忽略删除语句，不再执行删除数据表的操作</p>
</li>
<li><p>举例：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE dept80;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>DROP TABLE 语句不能回滚</strong></li>
</ul>
<blockquote>
<p>清空表</p>
</blockquote>
<ul>
<li>TRUNCATE TABLE语句：<ul>
<li>删除表中所有的数据</li>
<li>释放表的存储空间</li>
</ul>
</li>
<li>举例：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> myemp;</span><br></pre></td></tr></table></figure>

<ul>
<li>TRUNCATE语句<strong>不能回滚</strong>，而<strong>使用 DELETE 语句删除数据，可以回滚</strong></li>
<li>对比：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="literal">FALSE</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> emp2; </span><br><span class="line">#<span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> emp2;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp2;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emp2;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>阿里开发规范：TRUNCATE TABLE 比 DELETE 速度快，且使用的系统和事务日志资源少，但 TRUNCATE 无事务且不触发 TRIGGER，有可能造成事故，故不建议在开发代码中使用此语句</p>
</li>
<li><p>说明：TRUNCATE TABLE 在功能上与不带 WHERE 子句的 DELETE 语句相同</p>
</li>
</ul>
<blockquote>
<p>commit 与 rollback</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># DCL 中 <span class="keyword">COMMIT</span> 和 <span class="keyword">ROLLBACK</span></span><br><span class="line"># <span class="keyword">COMMIT</span>:提交数据。一旦执行<span class="keyword">COMMIT</span>，则数据就被永久的保存在了数据库中，意味着数据不可以回滚。</span><br><span class="line"># <span class="keyword">ROLLBACK</span>:回滚数据。一旦执行<span class="keyword">ROLLBACK</span>,则可以实现数据的回滚。回滚到最近的一次<span class="keyword">COMMIT</span>之后。</span><br><span class="line"></span><br><span class="line"># 对比 <span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> 和 <span class="keyword">DELETE</span> <span class="keyword">FROM</span> </span><br><span class="line"># 相同点：都可以实现对表中所有数据的删除，同时保留表结构。</span><br><span class="line"># 不同点：</span><br><span class="line">#	<span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span>：一旦执行此操作，表数据全部清除。同时，数据是不可以回滚的。</span><br><span class="line">#	<span class="keyword">DELETE</span> <span class="keyword">FROM</span>：一旦执行此操作，表数据可以全部清除（不带<span class="keyword">WHERE</span>）。同时，数据是可以实现回滚的。</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  DDL 和 DML 的说明</span></span><br><span class="line"><span class="comment">  ① DDL的操作一旦执行，就不可回滚。指令SET autocommit = FALSE对DDL操作失效。(因为在执行完DDL</span></span><br><span class="line"><span class="comment">    操作之后，一定会执行一次COMMIT。而此COMMIT操作不受SET autocommit = FALSE影响的。)</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  ② DML的操作默认情况，一旦执行，也是不可回滚的。但是，如果在执行DML之前，执行了 </span></span><br><span class="line"><span class="comment">    SET autocommit = FALSE，则执行的DML操作就可以实现回滚。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 演示：<span class="keyword">DELETE</span> <span class="keyword">FROM</span> </span><br><span class="line">#<span class="number">1</span>)</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">#<span class="number">2</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br><span class="line">#<span class="number">3</span>)</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="literal">FALSE</span>;</span><br><span class="line">#<span class="number">4</span>)</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> myemp3;</span><br><span class="line">#<span class="number">5</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br><span class="line">#<span class="number">6</span>)</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line">#<span class="number">7</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br><span class="line"></span><br><span class="line"># 演示：<span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span></span><br><span class="line">#<span class="number">1</span>)</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">#<span class="number">2</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br><span class="line">#<span class="number">3</span>)</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="literal">FALSE</span>;</span><br><span class="line">#<span class="number">4</span>)</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> myemp3;</span><br><span class="line">#<span class="number">5</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br><span class="line">#<span class="number">6</span>)</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line">#<span class="number">7</span>)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> myemp3;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>扩展</p>
</blockquote>
<p><strong>拓展1：阿里巴巴《Java开发手册》之MySQL字段命名</strong></p>
<ul>
<li><p>【<code>强制</code>】表名、字段名必须使用小写字母或数字，禁止出现数字开头，禁止两个下划线中间只出现数字。数据库字段名的修改代价很大，因为无法进行预发布，所以字段名称需要慎重考虑。</p>
<ul>
<li>正例：aliyun_admin，rdc_config，level3_name</li>
<li>反例：AliyunAdmin，rdcConfig，level_3_name</li>
</ul>
</li>
<li><p>【<code>强制</code>】禁用保留字，如 desc、range、match、delayed 等，请参考 MySQL 官方保留字。</p>
</li>
<li><p>【<code>强制</code>】表必备三字段：id, gmt_create, gmt_modified。</p>
<ul>
<li>说明：其中 id 必为主键，类型为BIGINT UNSIGNED、单表时自增、步长为 1。gmt_create, gmt_modified 的类型均为 DATETIME 类型，前者现在时表示主动式创建，后者过去分词表示被动式更新</li>
</ul>
</li>
<li><p>【<code>推荐</code>】表的命名最好是遵循 “业务名称_表的作用”。</p>
<ul>
<li>正例：alipay_task 、 force_project、 trade_config</li>
</ul>
</li>
<li><p>【<code>推荐</code>】库名与应用名称尽量一致。</p>
</li>
<li><p>【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。</p>
<ul>
<li>正例：无符号值可以避免误存负数，且扩大了表示范围。</li>
</ul>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/1451970-20220422013735094-2026977128.png" alt="MySQL之性能优化/image-20211024012735469"></p>
</li>
</ul>
<p><strong>拓展2：如何理解清空表、删除表等操作需谨慎？！</strong></p>
<p><code>表删除</code>操作将把表的定义和表中的数据一起删除，并且MySQL在执行删除操作时，不会有任何的确认信息提示，因此执行删除操时应当慎重。在删除表前，最好对表中的数据进行<code>备份</code>，这样当操作失误时可以对数据进行恢复，以免造成无法挽回的后果。</p>
<p>同样的，在使用 <code>ALTER TABLE</code> 进行表的基本修改操作时，在执行操作过程之前，也应该确保对数据进行完整的<code>备份</code>，因为数据库的改变是<code>无法撤销</code>的，如果添加了一个不需要的字段，可以将其删除；相同的，如果删除了一个需要的列，该列下面的所有数据都将会丢失。</p>
<p><strong>拓展3：MySQL8新特性—DDL的原子化</strong></p>
<p>在MySQL 8.0版本中，InnoDB表的DDL支持事务完整性，即<code>DDL操作要么成功要么回滚</code>。DDL操作回滚日志写入到data dictionary数据字典表mysql.innodb_ddl_log（该表是隐藏的表，通过show tables无法看到）中，用于回滚操作。通过设置参数，可将DDL操作日志打印输出到MySQL错误日志中。</p>
<p>分别在MySQL 5.7版本和MySQL 8.0版本中创建数据库和数据表，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE mytest;</span><br><span class="line"></span><br><span class="line">USE mytest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book1(</span><br><span class="line">book_id <span class="type">INT</span> ,</span><br><span class="line">book_name <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br></pre></td></tr></table></figure>

<p>（1）在MySQL 5.7版本中，测试步骤如下：<br>删除数据表book1和数据表book2，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DROP</span> <span class="keyword">TABLE</span> book1,book2;</span><br><span class="line">ERROR <span class="number">1051</span> (<span class="number">42</span>S02): <span class="literal">Unknown</span> <span class="keyword">table</span> <span class="string">&#x27;mytest.book2&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再次查询数据库中的数据表名称，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> TABLES;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>从结果可以看出，虽然删除操作时报错了，但是仍然删除了数据表book1。</p>
<p>（2）在MySQL 8.0版本中，测试步骤如下：<br>删除数据表book1和数据表book2，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DROP</span> <span class="keyword">TABLE</span> book1,book2;</span><br><span class="line">ERROR <span class="number">1051</span> (<span class="number">42</span>S02): <span class="literal">Unknown</span> <span class="keyword">table</span> <span class="string">&#x27;mytest.book2&#x27;</span></span><br></pre></td></tr></table></figure>

<p>再次查询数据库中的数据表名称，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_mytest <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="operator">|</span> book1            <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>从结果可以看出，数据表book1并没有被删除</p>
<h2 id="3-4-DML之insert"><a href="#3-4-DML之insert" class="headerlink" title="3.4 DML之insert"></a>3.4 DML之insert</h2><blockquote>
<p>方式1：一条一条的添加数据</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># ① 没有指明添加的字段</span><br><span class="line">#正确的</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;2000-12-21&#x27;</span>,<span class="number">3400</span>); #注意：一定要按照声明的字段的先后顺序添加</span><br><span class="line">#错误的</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1</span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="number">3400</span>,<span class="string">&#x27;2000-12-21&#x27;</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># ② 指明要添加的字段 （推荐）</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1(id,hire_date,salary,`name`)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">&#x27;1999-09-09&#x27;</span>,<span class="number">4000</span>,<span class="string">&#x27;Jerry&#x27;</span>);</span><br><span class="line"># 说明：没有进行赋值的hire_date 的值为 <span class="keyword">null</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1(id,salary,`name`)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">4500</span>,<span class="string">&#x27;shk&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># ③ 同时插入多条记录 （推荐）</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1(id,NAME,salary)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">4</span>,<span class="string">&#x27;Jim&#x27;</span>,<span class="number">5000</span>),</span><br><span class="line">(<span class="number">5</span>,<span class="string">&#x27;张俊杰&#x27;</span>,<span class="number">5500</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>方式2：将查询结果插入到表中</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> emp1(id,NAME,salary,hire_date)</span><br><span class="line">#查询语句</span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary,hire_date  # 查询的字段一定要与添加到的表的字段一一对应</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IN</span> (<span class="number">70</span>,<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">#说明：emp1表中要添加数据的字段的长度不能低于employees表中查询的字段的长度。</span><br><span class="line">#如果emp1表中要添加数据的字段的长度低于employees表中查询的字段的长度的话，就有添加不成功的风险。</span><br></pre></td></tr></table></figure>

<h2 id="3-5-DML之delete"><a href="#3-5-DML之delete" class="headerlink" title="3.5 DML之delete"></a>3.5 DML之delete</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#删除数据 <span class="keyword">DELETE</span> <span class="keyword">FROM</span> .... WHERE....</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> emp1</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#在删除数据时，也有可能因为约束的影响，导致删除失败</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> departments</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">#小结：DML操作默认情况下，执行完以后都会自动提交数据。</span><br><span class="line">#如果希望执行完以后不自动提交数据，则需要使用 <span class="keyword">SET</span> autocommit <span class="operator">=</span> FALSE.</span><br></pre></td></tr></table></figure>

<h2 id="3-6-DML之update"><a href="#3-6-DML之update" class="headerlink" title="3.6 DML之update"></a>3.6 DML之update</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 更新数据 （或修改数据）</span><br><span class="line"><span class="keyword">UPDATE</span> .... <span class="keyword">SET</span> .... <span class="keyword">WHERE</span> ...</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 可以实现批量修改数据的。</span><br><span class="line"><span class="keyword">UPDATE</span> emp1</span><br><span class="line"><span class="keyword">SET</span> hire_date <span class="operator">=</span> CURDATE()</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">#同时修改一条数据的多个字段</span><br><span class="line"><span class="keyword">UPDATE</span> emp1</span><br><span class="line"><span class="keyword">SET</span> hire_date <span class="operator">=</span> CURDATE(),salary <span class="operator">=</span> <span class="number">6000</span></span><br><span class="line"><span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">#题目：将表中姓名中包含字符a的提薪<span class="number">20</span><span class="operator">%</span></span><br><span class="line"><span class="keyword">UPDATE</span> emp1</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.2</span></span><br><span class="line"><span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%a%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#修改数据时，是可能存在不成功的情况的。（可能是由于约束的影响造成的）</span><br><span class="line"><span class="keyword">UPDATE</span> employees</span><br><span class="line"><span class="keyword">SET</span> department_id <span class="operator">=</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">102</span>;</span><br></pre></td></tr></table></figure>

<h2 id="3-7-MySQL数据类型"><a href="#3-7-MySQL数据类型" class="headerlink" title="3.7 MySQL数据类型"></a>3.7 MySQL数据类型</h2><h2 id="3-8-约束"><a href="#3-8-约束" class="headerlink" title="3.8 约束"></a>3.8 约束</h2><h1 id="4-其它数据库对象"><a href="#4-其它数据库对象" class="headerlink" title="4.其它数据库对象"></a>4.其它数据库对象</h1><blockquote>
<p>常见的数据库对象</p>
</blockquote>
<table>
<thead>
<tr>
<th>对象 描述</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>表(TABLE)</td>
<td>表是存储数据的逻辑单元，以行和列的形式存在，列就是字段，行就是记录</td>
</tr>
<tr>
<td>数据字典</td>
<td>就是系统表，存放数据库相关信息的表。系统表的数据通常由数据库系统维护， 程序员通常不应该修改，只可查看</td>
</tr>
<tr>
<td>约束 (CONSTRAINT)</td>
<td>执行数据校验的规则，用于保证数据完整性的规则</td>
</tr>
<tr>
<td>视图(VIEW)</td>
<td>一个或者多个数据表里的数据的逻辑显示，视图并不存储数据</td>
</tr>
<tr>
<td>索引(INDEX)</td>
<td>用于提高查询性能，相当于书的目录</td>
</tr>
<tr>
<td>存储过程 (PROCEDURE)</td>
<td>用于完成一次完整的业务处理，没有返回值，但可通过传出参数将多个值传给调用环境</td>
</tr>
<tr>
<td>存储函数 (FUNCTION)</td>
<td>用于完成一次特定的计算，具有一个返回值</td>
</tr>
<tr>
<td>触发器 (TRIGGER)</td>
<td>相当于一个事件监听器，当数据库发生特定事件后，触发器被触发，完成相应的处理</td>
</tr>
</tbody></table>
<h2 id="4-1-视图"><a href="#4-1-视图" class="headerlink" title="4.1 视图"></a>4.1 视图</h2><p><img src="image-20221101195450488.png" alt="MySQL之性能优化/image-20221101195450488"></p>
<h3 id="4-1-1-为什么使用视图"><a href="#4-1-1-为什么使用视图" class="headerlink" title="4.1.1 为什么使用视图"></a>4.1.1 为什么使用视图</h3><p>视图一方面可以帮我们使用表的一部分而不是所有的表，另一方面也可以针对不同的用户制定不同的查 询视图。比如，针对一个公司的销售人员，我们只想给他看部分数据，而某些特殊的数据，比如采购的 价格，则不会提供给他。再比如，人员薪酬是个敏感的字段，那么只给某个级别以上的人员开放，其他 人的查询视图中则不提供这个字段。</p>
<h3 id="4-1-2-视图的理解"><a href="#4-1-2-视图的理解" class="headerlink" title="4.1.2 视图的理解"></a>4.1.2 视图的理解</h3><ul>
<li>视图是一种<strong>虚拟表</strong>，本身是<strong>不具有数据</strong>的，占用很少的内存空间，它是 <strong>SQL</strong> 中的一个重要概念</li>
<li><strong>视图建立在已有表的基础上</strong>, 视图赖以建立的这些表称为<strong>基表</strong></li>
</ul>
<p><img src="image-20221101225235963.png" alt="MySQL之性能优化/image-20221101225235963"></p>
<ul>
<li>视图的创建和删除只影响视图本身，不影响对应的基表。但是当对视图中的数据进行增加、删除和 修改操作时，数据表中的数据会相应地发生变化，反之亦然</li>
<li><strong>向视图提供数据内容的语句为 SELECT 语句</strong>, 可以将视图理解为<strong>存储起来的 SELECT 语句</strong> <ul>
<li>在数据库中，视图不会保存数据，数据真正保存在数据表中。当对视图中的数据进行增加、删 除和修改操作时，数据表中的数据会相应地发生变化；反之亦然</li>
</ul>
</li>
<li>视图，是向用户提供基表数据的另一种表现形式。通常情况下，小型项目的数据库可以不使用视 图，但是在大型项目中，以及数据表比较复杂的情况下，视图的价值就凸显出来了，它可以帮助我 们把经常查询的结果集放到虚拟表中，提升使用效率。理解和使用起来都非常方便</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">① 视图，可以看做是一个虚拟表，本身是不存储数据的。</span><br><span class="line">  视图的本质，就可以看做是存储起来的<span class="keyword">SELECT</span>语句</span><br><span class="line">  </span><br><span class="line">② 视图中<span class="keyword">SELECT</span>语句中涉及到的表，称为基表</span><br><span class="line"></span><br><span class="line">③ 针对视图做DML操作，会影响到对应的基表中的数据。反之亦然</span><br><span class="line"></span><br><span class="line">④ 视图本身的删除，不会导致基表中数据的删除</span><br><span class="line"></span><br><span class="line">⑤ 视图的应用场景：针对于小型项目，不推荐使用视图。针对于大型项目，可以考虑使用视图</span><br><span class="line"></span><br><span class="line">⑥ 视图的优点：简化查询; 控制数据的访问</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3-创建视图"><a href="#4-1-3-创建视图" class="headerlink" title="4.1.3 创建视图"></a>4.1.3 创建视图</h3><blockquote>
<p>在 CREATE VIEW 语句中嵌入子查询</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">OR</span> REPLACE]</span><br><span class="line">[ALGORITHM <span class="operator">=</span> &#123;UNDEFINED <span class="operator">|</span> <span class="keyword">MERGE</span> <span class="operator">|</span> TEMPTABLE&#125;]</span><br><span class="line"><span class="keyword">VIEW</span> 视图名称 [(字段列表)]</span><br><span class="line"><span class="keyword">AS</span> 查询语句</span><br><span class="line">[<span class="keyword">WITH</span> [<span class="keyword">CASCADED</span><span class="operator">|</span><span class="keyword">LOCAL</span>] <span class="keyword">CHECK</span> OPTION]</span><br></pre></td></tr></table></figure>

<ul>
<li>精简版</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> 视图名称</span><br><span class="line"><span class="keyword">AS</span> 查询语句</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">#准备工作</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE dbtest14;</span><br><span class="line"></span><br><span class="line">USE dbtest14;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emps</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> atguigudb.`employees`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> depts</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> atguigudb.`departments`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> emps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> depts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> emps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> atguigudb.employees;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">1</span> 针对于单表</span><br><span class="line">#情况<span class="number">1</span>：视图中的字段与基表的字段有对应关系</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> emps;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp1;</span><br><span class="line"></span><br><span class="line">#确定视图中字段名的方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp2</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id emp_id,last_name lname,salary #查询语句中字段的别名会作为视图中字段的名称出现</span><br><span class="line"><span class="keyword">FROM</span> emps</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line">#确定视图中字段名的方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp3(emp_id,NAME,monthly_sal) #小括号内字段个数与<span class="keyword">SELECT</span>中字段个数相同</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary </span><br><span class="line"><span class="keyword">FROM</span> emps</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">8000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp3;</span><br><span class="line"></span><br><span class="line">#情况<span class="number">2</span>：视图中的字段在基表中可能没有对应的字段</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp_sal</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> department_id,<span class="built_in">AVG</span>(salary) avg_sal</span><br><span class="line"><span class="keyword">FROM</span> emps</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_sal;</span><br><span class="line"></span><br><span class="line">#<span class="number">2</span> 针对于多表</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp_dept</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> e.employee_id,e.department_id,d.department_name</span><br><span class="line"><span class="keyword">FROM</span> emps e <span class="keyword">JOIN</span> depts d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_dept;</span><br><span class="line"></span><br><span class="line">#利用视图对数据进行格式化</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp_dept1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(e.last_name,<span class="string">&#x27;(&#x27;</span>,d.department_name,<span class="string">&#x27;)&#x27;</span>) emp_info</span><br><span class="line"><span class="keyword">FROM</span> emps e <span class="keyword">JOIN</span> depts d</span><br><span class="line"><span class="keyword">ON</span> e.`department_id` <span class="operator">=</span> d.`department_id`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_dept1;</span><br><span class="line"></span><br><span class="line">#<span class="number">3</span> 基于视图创建视图</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp4</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name</span><br><span class="line"><span class="keyword">FROM</span> vu_emp1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp4; </span><br></pre></td></tr></table></figure>

<p>说明1：实际上就是我们在 SQL 查询语句的基础上封装了视图 VIEW，这样就会基于 SQL 语句的结果集形 成一张虚拟表</p>
<p>说明2：在创建视图时，没有在视图名后面指定字段列表，则视图中字段列表默认和SELECT语句中的字 段列表一致。如果SELECT语句中给字段取了别名，那么视图中的字段名和别名相同</p>
<h3 id="4-1-4-查看视图"><a href="#4-1-4-查看视图" class="headerlink" title="4.1.4 查看视图"></a>4.1.4 查看视图</h3><ul>
<li>语法1：查看数据库的表对象、视图对象</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br></pre></td></tr></table></figure>

<ul>
<li>语法2：查看视图的结构</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DESC</span> <span class="operator">/</span> <span class="keyword">DESCRIBE</span> 视图名称;</span><br></pre></td></tr></table></figure>

<ul>
<li>语法3：查看视图的属性信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看视图信息（显示数据表的存储引擎、版本、数据行数和数据大小等）</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;视图名称&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>执行结果显示，注释Comment为VIEW，说明该表为视图，其他的信息为NULL，说明这是一个虚表</p>
<ul>
<li>语法4：查看视图的详细定义信息</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> 视图名称;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 语法<span class="number">1</span>：查看数据库的表对象、视图对象</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line">#语法<span class="number">2</span>：查看视图的结构</span><br><span class="line"><span class="keyword">DESCRIBE</span> vu_emp1;</span><br><span class="line"></span><br><span class="line">#语法<span class="number">3</span>：查看视图的属性信息</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;vu_emp1&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#语法<span class="number">4</span>：查看视图的详细定义信息</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span> vu_emp1;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-4-更新视图"><a href="#4-1-4-更新视图" class="headerlink" title="4.1.4 更新视图"></a>4.1.4 更新视图</h3><blockquote>
<p>一般情况</p>
</blockquote>
<ul>
<li>MySQL支持使用INSERT、UPDATE和DELETE语句对视图中的数据进行插入、更新和删除操作。当视图中的 数据发生变化时，数据表中的数据也会发生变化，反之亦然</li>
</ul>
<blockquote>
<p>不可更新的视图</p>
</blockquote>
<ul>
<li>要使视图可更新，视图中的行和底层基本表中的行之间必须存在 一对一 的关系。另外当视图定义出现如 下情况时，视图不支持更新操作： <ul>
<li>在定义视图的时候指定了“ALGORITHM &#x3D; TEMPTABLE”，视图将不支持INSERT和DELETE操作</li>
<li>视图中不包含基表中所有被定义为非空又未指定默认值的列，视图将不支持INSERT操作</li>
<li>在定义视图的SELECT语句中使用了 <strong>JOIN联合查询</strong> ，视图将不支持INSERT和DELETE操作</li>
<li>在定义视图的SELECT语句后的字段列表中使用了 <strong>数学表达式</strong> 或 <strong>子查询</strong> ，视图将不支持INSERT，也 不支持UPDATE使用了数学表达式、子查询的字段值</li>
<li>在定义视图的SELECT语句后的字段列表中使用 <strong>DISTINCT 、 聚合函数 、 GROUP BY 、 HAVING 、 UNION</strong> 等，视图将不支持INSERT、UPDATE、DELETE</li>
<li>在定义视图的SELECT语句中包含了子查询，而子查询中引用了FROM后面的表，视图将不支持 INSERT、UPDATE、DELETE</li>
<li>视图定义基于一个<strong>不可更新视图</strong></li>
<li>常量视图</li>
</ul>
</li>
</ul>
<blockquote>
<p>虽然可以更新视图数据，但总的来说，视图作为<strong>虚拟表</strong> ，主要用于<strong>方便查询</strong> ，不建议更新视图的<strong>数据</strong>。<strong>对视图数据的更改，都是通过对实际数据表里数据的操作来完成的</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1</span> 一般情况，可以更新视图的数据</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> emps;</span><br><span class="line">#更新视图的数据，会导致基表中数据的修改</span><br><span class="line"><span class="keyword">UPDATE</span> vu_emp1</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">20000</span></span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line"></span><br><span class="line">#同理，更新表中的数据，也会导致视图中的数据的修改</span><br><span class="line"><span class="keyword">UPDATE</span> emps</span><br><span class="line"><span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">10000</span></span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line"></span><br><span class="line">#删除视图中的数据，也会导致表中的数据的删除</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> vu_emp1</span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary</span><br><span class="line"><span class="keyword">FROM</span> emps</span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">101</span>;</span><br><span class="line"></span><br><span class="line">#<span class="number">2</span> 不能更新视图中的数据</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> vu_emp_sal;</span><br><span class="line"></span><br><span class="line">#更新失败</span><br><span class="line"><span class="keyword">UPDATE</span> vu_emp_sal</span><br><span class="line"><span class="keyword">SET</span> avg_sal <span class="operator">=</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">#删除失败</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> vu_emp_sal</span><br><span class="line"><span class="keyword">WHERE</span> department_id <span class="operator">=</span> <span class="number">30</span>;</span><br></pre></td></tr></table></figure>

<h3 id="4-1-5-修改、删除视图"><a href="#4-1-5-修改、删除视图" class="headerlink" title="4.1.5 修改、删除视图"></a>4.1.5 修改、删除视图</h3><blockquote>
<p>修改视图</p>
</blockquote>
<ul>
<li><p>方式1：使用<code>CREATE OR REPLACE VIEW</code>子句修改视图</p>
</li>
<li><p>方式2：ALTER VIEW 修改视图的语法是：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> 视图名称</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">查询语句</span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除视图</p>
</blockquote>
<ul>
<li><p>删除视图只是删除视图的定义，<strong>并不会删除基表的数据</strong></p>
</li>
<li><p>删除视图的语法是：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> IF <span class="keyword">EXISTS</span> 视图名称;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span>修改视图</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> vu_emp1;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">1</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> REPLACE <span class="keyword">VIEW</span> vu_emp1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary,email</span><br><span class="line"><span class="keyword">FROM</span> emps</span><br><span class="line"><span class="keyword">WHERE</span> salary <span class="operator">&gt;</span> <span class="number">7000</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">VIEW</span> vu_emp1</span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">SELECT</span> employee_id,last_name,salary,email,hire_date</span><br><span class="line"><span class="keyword">FROM</span> emps;</span><br><span class="line"></span><br><span class="line">#<span class="number">2.</span>删除视图</span><br><span class="line"><span class="keyword">SHOW</span> TABLES;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> vu_emp4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> IF <span class="keyword">EXISTS</span> vu_emp2,vu_emp3;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>说明：基于视图a、b创建了新的视图c，如果将视图a或者视图b删除，会导致视图c的查询失败。这 样的视图c需要手动删除或修改，否则影响使用</strong></p>
</blockquote>
<h3 id="4-1-6-总结"><a href="#4-1-6-总结" class="headerlink" title="4.1.6 总结"></a>4.1.6 总结</h3><blockquote>
<p>优点</p>
</blockquote>
<ul>
<li>操作简单</li>
<li>减少数据冗余</li>
<li>数据安全</li>
<li>适应灵活多变的需求</li>
<li>能够分解复杂的查询逻辑</li>
</ul>
<blockquote>
<p>缺点</p>
</blockquote>
<p>如果我们在实际数据表的基础上创建了视图，那么，如果实际数据表的结构变更了，我们就需要及时对 相关的视图进行相应的维护。特别是嵌套的视图（就是在视图的基础上创建视图），维护会变得比较复 杂， 可读性不好 ，容易变成系统的潜在隐患。因为创建视图的 SQL 查询可能会对字段重命名，也可能包 含复杂的逻辑，这些都会增加维护的成本。 实际项目中，如果视图过多，会导致数据库维护成本的问题。 所以，在创建视图的时候，你要结合实际项目需求，综合考虑视图的优点和不足，这样才能正确使用视 图，使系统整体达到最优。</p>
<h2 id="4-2-存储过程与存储函数"><a href="#4-2-存储过程与存储函数" class="headerlink" title="4.2 存储过程与存储函数"></a>4.2 存储过程与存储函数</h2><p><strong>MySQL从5.0版本开始支持存储过程和函数。存储过程和函数能够将复杂的SQL逻辑封装在一起，应用程 序无须关注存储过程和函数内部复杂的SQL逻辑，而只需要简单地调用存储过程和函数即可</strong></p>
<h3 id="4-2-1-存储过程"><a href="#4-2-1-存储过程" class="headerlink" title="4.2.1 存储过程"></a>4.2.1 存储过程</h3><h4 id="4-2-1-1-概述"><a href="#4-2-1-1-概述" class="headerlink" title="4.2.1.1 概述"></a>4.2.1.1 概述</h4><blockquote>
<p>理解</p>
</blockquote>
<ul>
<li><p><strong>含义</strong>：存储过程的英文是 <strong>Stored Procedure</strong> 。它的思想很简单，就是一组经过 <strong>预先编译</strong> 的 SQL 语句的封装</p>
</li>
<li><p><strong>执行过程</strong>：存储过程预先存储在 MySQL 服务器上，需要执行的时候，客户端只需要向服务器端发出调用 存储过程的命令，服务器端就可以把预先存储好的这一系列 SQL 语句全部执行</p>
</li>
<li><p><strong>好处</strong>： </p>
<ul>
<li>1.简化操作，提高了sql语句的重用性，减少了开发程序员的压力 </li>
<li>2.减少操作过程中的失误，提高效率 </li>
<li>3.减少网络传输量（客户端不需要把所有的 SQL 语句通过网络发给服务器） </li>
<li>4.减少了 SQL 语句暴露在 网上的风险，也提高了数据查询的安全性</li>
</ul>
</li>
<li><p><strong>和视图、函数的对比</strong>： </p>
<ul>
<li>它和视图有着同样的优点，清晰、安全，还可以减少网络传输量。不过它和视图不同，视图是 <strong>虚拟表</strong> ， 通常不对底层数据表直接操作，而存储过程是程序化的 SQL，可以<strong>直接操作底层数据表</strong> ，相比于面向集 合的操作方式，能够实现一些更复杂的数据处理</li>
<li>一旦存储过程被创建出来，使用它就像使用函数一样简单，我们直接通过调用存储过程名即可。相较于 函数，存储过程是<strong>没有返回值</strong>的</li>
</ul>
</li>
</ul>
<blockquote>
<p>分类</p>
</blockquote>
<p>存储过程的参数类型可以是IN、OUT和INOUT。根据这点分类如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>没有参数（无参数无返回） </span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>仅仅带 <span class="keyword">IN</span> 类型（有参数无返回） </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>仅仅带 <span class="keyword">OUT</span> 类型（无参数有返 回） </span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>既带 <span class="keyword">IN</span> 又带 <span class="keyword">OUT</span>（有参数有返回） </span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>带 <span class="keyword">INOUT</span>（有参数有返回） </span><br><span class="line"></span><br><span class="line">注意：<span class="keyword">IN</span>、<span class="keyword">OUT</span>、<span class="keyword">INOUT</span> 都可以在一个存储过程中带多个</span><br></pre></td></tr></table></figure>

<h4 id="4-2-1-2-创建存储过程"><a href="#4-2-1-2-创建存储过程" class="headerlink" title="4.2.1.2 创建存储过程"></a>4.2.1.2 创建存储过程</h4><blockquote>
<p>语法分析</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 存储过程名(<span class="keyword">IN</span><span class="operator">|</span><span class="keyword">OUT</span><span class="operator">|</span><span class="keyword">INOUT</span> 参数名 参数类型,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">存储过程体</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p>类似于Java中的方法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">修饰符 返回类型 方法名(参数类型 参数名,...)&#123;</span><br><span class="line">方法体;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明： </p>
<ul>
<li><p>1.参数前面的符号的意思 </p>
<ul>
<li><strong>IN</strong> ：当前参数为输入参数，也就是表示入参； 存储过程只是读取这个参数的值。如果没有定义参数种类，<strong>默认就是 IN</strong> ，表示输入参数</li>
<li><strong>OUT</strong> ：当前参数为输出参数，也就是表示出参； 执行完成之后，调用这个存储过程的客户端或者应用程序就可以读取这个参数返回的值了</li>
<li><strong>INOUT</strong> ：当前参数既可以为输入参数，也可以为输出参数</li>
</ul>
</li>
<li><p>2.形参类型可以是 MySQL数据库中的任意类型 </p>
</li>
<li><p>3.<code>characteristics</code> 表示创建存储过程时指定的对存储过程的<strong>约束条件</strong>，其取值信息如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LANGUAGE</span> <span class="keyword">SQL</span></span><br><span class="line"><span class="operator">|</span> [<span class="keyword">NOT</span>] <span class="keyword">DETERMINISTIC</span></span><br><span class="line"><span class="operator">|</span> &#123; <span class="keyword">CONTAINS</span> <span class="keyword">SQL</span> <span class="operator">|</span> <span class="keyword">NO</span> <span class="keyword">SQL</span> <span class="operator">|</span> <span class="keyword">READS</span> <span class="keyword">SQL</span> DATA <span class="operator">|</span> <span class="keyword">MODIFIES</span> <span class="keyword">SQL</span> DATA &#125;</span><br><span class="line"><span class="operator">|</span> <span class="keyword">SQL</span> SECURITY &#123; DEFINER <span class="operator">|</span> INVOKER &#125;</span><br><span class="line"><span class="operator">|</span> COMMENT <span class="string">&#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>LANGUAGE SQL</code> ：说明存储过程执行体是由SQL语句组成的，当前系统支持的语言为SQL</p>
</li>
<li><p><code>[NOT] DETERMINISTIC</code> ：指明存储过程执行的结果是否确定。DETERMINISTIC表示结果是确定 的。每次执行存储过程时，相同的输入会得到相同的输出。NOT DETERMINISTIC表示结果是不确定 的，相同的输入可能得到不同的输出。如果没有指定任意一个值，默认为NOT DETERMINISTIC </p>
</li>
<li><p><code>&#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</code> ：指明子程序使 用SQL语句的限制</p>
<ul>
<li>CONTAINS SQL表示当前存储过程的子程序包含SQL语句，但是并不包含读写数据的SQL语句</li>
<li>NO SQL表示当前存储过程的子程序中不包含任何SQL语句</li>
<li>READS SQL DATA表示当前存储过程的子程序中包含读数据的SQL语句</li>
<li>MODIFIES SQL DATA表示当前存储过程的子程序中包含写数据的SQL语句</li>
<li>默认情况下，系统会指定为CONTAINS SQL</li>
</ul>
</li>
<li><p><code>SQL SECURITY &#123; DEFINER | INVOKER &#125;</code> ：执行当前存储过程的权限，即指明哪些用户能够执 行当前存储过程</p>
<ul>
<li><strong>DEFINER</strong> 表示只有当前存储过程的创建者或者定义者才能执行当前存储过程</li>
<li><strong>INVOKER</strong> 表示拥有当前存储过程的访问权限的用户能够执行当前存储过程</li>
<li>如果没有设置相关的值，则MySQL默认指定值为<strong>DEFINER</strong></li>
</ul>
</li>
<li><p><code>COMMENT &#39;string&#39;</code> ：注释信息，可以用来描述存储过程</p>
</li>
</ul>
</li>
<li><p>4.存储过程体中可以有多条 SQL 语句，如果仅仅一条SQL 语句，则可以省略 BEGIN 和 END 编写存储过程并不是一件简单的事情，可能存储过程中需要复杂的 SQL 语句</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">BEGIN</span>…<span class="keyword">END</span>：<span class="keyword">BEGIN</span>…<span class="keyword">END</span> 中间包含了多个语句，每个语句都以（;）号为结束符。</span><br><span class="line"><span class="number">2.</span> <span class="keyword">DECLARE</span>：<span class="keyword">DECLARE</span> 用来声明变量，使用的位置在于 <span class="keyword">BEGIN</span>…<span class="keyword">END</span> 语句中间，而且需要在其他语句使用之前进</span><br><span class="line">行变量的声明。</span><br><span class="line"><span class="number">3.</span> <span class="keyword">SET</span>：赋值语句，用于对变量进行赋值。</span><br><span class="line"><span class="number">4.</span> <span class="keyword">SELECT</span>… <span class="keyword">INTO</span>：把从数据表中查询的结果存放到变量中，也就是为变量赋值。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>5.需要设置新的结束标记</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER 新的结束标记</span><br></pre></td></tr></table></figure>

<ul>
<li>因为MySQL默认的语句结束符号为分号‘;’。为了避免与存储过程中SQL语句结束符相冲突，需要使用 DELIMITER改变存储过程的结束符 </li>
<li>比如：“DELIMITER &#x2F;&#x2F;”语句的作用是将MySQL的结束符设置为&#x2F;&#x2F;，并以“END &#x2F;&#x2F;”结束存储过程。存储过程定 义完毕之后再使用“DELIMITER ;”恢复默认结束符。DELIMITER也可以指定其他符号作为结束符</li>
<li><strong>当使用DELIMITER命令时，应该避免使用反斜杠（‘\’）字符，因为反斜线是MySQL的转义字符</strong></li>
<li>示例：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 存储过程名(<span class="keyword">IN</span><span class="operator">|</span><span class="keyword">OUT</span><span class="operator">|</span><span class="keyword">INOUT</span> 参数名 参数类型,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">sql</span>语句<span class="number">1</span>;</span><br><span class="line"><span class="keyword">sql</span>语句<span class="number">2</span>;</span><br><span class="line"><span class="keyword">END</span> $</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>代码举例</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#创建存储过程select_all_data()，查看 employees 表的所有数据</span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> select_all_data()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<h4 id="4-2-1-3-调用存储过程"><a href="#4-2-1-3-调用存储过程" class="headerlink" title="4.2.1.3 调用存储过程"></a>4.2.1.3 调用存储过程</h4><blockquote>
<p>调用格式</p>
</blockquote>
<ul>
<li>存储过程有多种调用方法。存储过程必须使用CALL语句调用，并且存储过程和数据库相关，如果要执行 其他数据库中的存储过程，需要指定数据库名称，例如CALL dbname.procname</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> 存储过程名(实参列表)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>格式： </p>
<ul>
<li>1.调用in模式的参数：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> sp1(<span class="string">&#x27;值&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>2.调用out模式的参数：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@name</span>;</span><br><span class="line"><span class="keyword">CALL</span> sp1(<span class="variable">@name</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@name</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>3.调用inout模式的参数：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="variable">@name</span><span class="operator">=</span>值;</span><br><span class="line"><span class="keyword">CALL</span> sp1(<span class="variable">@name</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@name</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>代码举例</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> 创建存储过程</span><br><span class="line"></span><br><span class="line">#类型<span class="number">1</span>：无参数无返回值</span><br><span class="line"></span><br><span class="line">#举例<span class="number">1</span>：创建存储过程select_all_data()，查看 employees 表的所有数据</span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> select_all_data()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#<span class="number">2.</span> 存储过程的调用</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> select_all_data();</span><br><span class="line"></span><br><span class="line">#举例<span class="number">2</span>：创建存储过程avg_employee_salary()，返回所有员工的平均工资</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> avg_employee_salary()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> avg_employee_salary();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#举例<span class="number">3</span>：创建存储过程show_max_salary()，用来查看“emps”表的最高薪资值。</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_max_salary()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary)</span><br><span class="line">	<span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> show_max_salary();</span><br><span class="line"></span><br><span class="line">#类型<span class="number">2</span>：带 <span class="keyword">OUT</span></span><br><span class="line">#举例<span class="number">4</span>：创建存储过程show_min_salary()，查看“emps”表的最低薪资值。并将最低薪资</span><br><span class="line">#通过<span class="keyword">OUT</span>参数“ms”输出</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_min_salary(<span class="keyword">OUT</span> ms <span class="keyword">DOUBLE</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) <span class="keyword">INTO</span> ms</span><br><span class="line">	<span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> show_min_salary(<span class="variable">@ms</span>);</span><br><span class="line"></span><br><span class="line">#查看变量值</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@ms</span>;</span><br><span class="line"></span><br><span class="line">#类型<span class="number">3</span>：带 <span class="keyword">IN</span></span><br><span class="line">#举例<span class="number">5</span>：创建存储过程show_someone_salary()，查看“emps”表的某个员工的薪资，</span><br><span class="line">#并用<span class="keyword">IN</span>参数empname输入员工姓名。</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_someone_salary(<span class="keyword">IN</span> empname <span class="type">VARCHAR</span>(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">FROM</span> employees</span><br><span class="line">	<span class="keyword">WHERE</span> last_name <span class="operator">=</span> empname;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用方式<span class="number">1</span></span><br><span class="line"><span class="keyword">CALL</span> show_someone_salary(<span class="string">&#x27;Abel&#x27;</span>);</span><br><span class="line">#调用方式<span class="number">2</span></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@empname</span> :<span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"><span class="keyword">CALL</span> show_someone_salary(<span class="variable">@empname</span>);</span><br><span class="line"></span><br><span class="line">#类型<span class="number">4</span>：带 <span class="keyword">IN</span> 和 <span class="keyword">OUT</span></span><br><span class="line">#举例<span class="number">6</span>：创建存储过程show_someone_salary2()，查看“emps”表的某个员工的薪资，</span><br><span class="line">#并用<span class="keyword">IN</span>参数empname输入员工姓名，用<span class="keyword">OUT</span>参数empsalary输出员工薪资。</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_someone_salary2(<span class="keyword">IN</span> empname <span class="type">VARCHAR</span>(<span class="number">20</span>),<span class="keyword">OUT</span> empsalary <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> empsalary</span><br><span class="line">	<span class="keyword">FROM</span> employees</span><br><span class="line">	<span class="keyword">WHERE</span> last_name <span class="operator">=</span> empname;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@empname</span> <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"><span class="keyword">CALL</span> show_someone_salary2(<span class="variable">@empname</span>,<span class="variable">@empsalary</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@empsalary</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#类型<span class="number">5</span>：带 <span class="keyword">INOUT</span></span><br><span class="line">#举例<span class="number">7</span>：创建存储过程show_mgr_name()，查询某个员工领导的姓名，并用<span class="keyword">INOUT</span>参数“empname”输入员工姓名，</span><br><span class="line">#输出领导的姓名。</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_mgr_name(<span class="keyword">INOUT</span> empname <span class="type">VARCHAR</span>(<span class="number">25</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">SELECT</span> last_name <span class="keyword">INTO</span> empname</span><br><span class="line">	<span class="keyword">FROM</span> employees</span><br><span class="line">	<span class="keyword">WHERE</span> employee_id <span class="operator">=</span> (</span><br><span class="line">				<span class="keyword">SELECT</span> manager_id</span><br><span class="line">				<span class="keyword">FROM</span> employees</span><br><span class="line">				<span class="keyword">WHERE</span> last_name <span class="operator">=</span> empname</span><br><span class="line">				);</span><br><span class="line">	</span><br><span class="line"><span class="keyword">END</span> $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@empname</span> :<span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"><span class="keyword">CALL</span> show_mgr_name(<span class="variable">@empname</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@empname</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如何调试</p>
</blockquote>
<p>在 MySQL 中，存储过程不像普通的编程语言（比如 VC++、Java 等）那样有专门的集成开发环境。因 此，你可以通过 SELECT 语句，把程序执行的中间结果查询出来，来调试一个 SQL 语句的正确性。调试 成功之后，把 SELECT 语句后移到下一个 SQL 语句之后，再调试下一个 SQL 语句。这样 <strong>逐步推进</strong> ，就可 以完成对存储过程中所有操作的调试了。当然，你也可以把存储过程中的 SQL 语句复制出来，逐段单独调试。</p>
<h3 id="4-2-2-存储函数"><a href="#4-2-2-存储函数" class="headerlink" title="4.2.2 存储函数"></a>4.2.2 存储函数</h3><blockquote>
<p>语法分析</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> 函数名(参数名 参数类型,...)</span><br><span class="line"><span class="keyword">RETURNS</span> 返回值类型</span><br><span class="line">[characteristics ...]</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">函数体 #函数体中肯定有 <span class="keyword">RETURN</span> 语句</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<ul>
<li>说明： <ul>
<li>1.参数列表：指定参数为IN、OUT或INOUT只对PROCEDURE是合法的，FUNCTION中总是默认为IN参数</li>
<li>2.RETURNS type 语句表示函数返回数据的类型； RETURNS子句只能对FUNCTION做指定，对函数而言这是 <strong>强制</strong> 的。它用来指定函数的返回类型，而且函 数体必须包含一个 <strong>RETURN value</strong> 语句</li>
<li>3.<strong><code>characteristic</code> 创建函数时指定的对函数的约束。取值与创建存储过程时相同，这里不再赘述</strong></li>
<li>4.函数体也可以用BEGIN…END来表示SQL代码的开始和结束。如果函数体只有一条语句，也可以省略 BEGIN…END</li>
</ul>
</li>
</ul>
<blockquote>
<p>调用存储函数</p>
</blockquote>
<p>在MySQL中，存储函数的使用方法与MySQL内部函数的使用方法是一样的。换言之，用户自己定义的存 储函数与MySQL内部函数是一个性质的。区别在于，存储函数是 <strong>用户自己定义</strong> 的，而内部函数是MySQL 的 <strong>开发者定义</strong> 的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 函数名(实参列表)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>代码举例</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"># 举例<span class="number">1</span>：创建存储函数，名称为email_by_name()，参数定义为空，</span><br><span class="line">#该函数查询Abel的email，并返回，数据类型为字符串型。</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> email_by_name()</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">25</span>)</span><br><span class="line">	<span class="keyword">DETERMINISTIC</span></span><br><span class="line">	<span class="keyword">CONTAINS</span> <span class="keyword">SQL</span></span><br><span class="line">	<span class="keyword">READS</span> <span class="keyword">SQL</span> DATA</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> email <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SELECT</span> email_by_name();</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> email,last_name <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#举例<span class="number">2</span>：创建存储函数，名称为email_by_id()，参数传入emp_id，该函数查询emp_id的email，</span><br><span class="line">#并返回，数据类型为字符串型。</span><br><span class="line"></span><br><span class="line">#创建函数前执行此语句，保证函数的创建会成功</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_bin_trust_function_creators <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#声明函数</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> email_by_id(emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> email <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SELECT</span> email_by_id(<span class="number">101</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@emp</span>_id :<span class="operator">=</span> <span class="number">102</span>;</span><br><span class="line"><span class="keyword">SELECT</span> email_by_id(<span class="variable">@emp</span>_id);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#举例<span class="number">3</span>：创建存储函数count_by_id()，参数传入dept_id，该函数查询dept_id部门的</span><br><span class="line">#员工人数，并返回，数据类型为整型。</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> count_by_id(dept_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">INT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">RETURN</span> (<span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> department_id <span class="operator">=</span> dept_id);</span><br><span class="line">	</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@dept</span>_id :<span class="operator">=</span> <span class="number">50</span>;</span><br><span class="line"><span class="keyword">SELECT</span> count_by_id(<span class="variable">@dept</span>_id);</span><br></pre></td></tr></table></figure>

<ul>
<li>注意： 若在创建存储函数中报错“ <strong>you might want to use the less safe log_bin_trust_function_creators variable</strong> ”，有两种处理方法： <ul>
<li>方式1：加上必要的函数特性“[NOT] DETERMINISTIC”和“{CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA}” </li>
<li>方式2：</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_bin_trust_function_creators <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对比存储过程和存储函数</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>关键字</th>
<th>调用语法</th>
<th>返回值</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>存储过程</td>
<td>PROCEDURE</td>
<td>CALL 存储过程()</td>
<td>理解为有0个或多个</td>
<td>一般用于更新</td>
</tr>
<tr>
<td>存储函数</td>
<td>FUNCTION</td>
<td>SELECT 函数 ()</td>
<td>只能是一个</td>
<td>一般用于查询结果为一个值并返回时</td>
</tr>
</tbody></table>
<ul>
<li>此外，<strong>存储函数可以放在查询语句中使用，存储过程不行</strong>。反之，存储过程的功能更加强大，包括能够 执行对表的操作（比如创建表，删除表等）和事务操作，这些功能是存储函数不具备的</li>
</ul>
<h3 id="4-2-3-存储过程和存储函数的查看、修改、删除"><a href="#4-2-3-存储过程和存储函数的查看、修改、删除" class="headerlink" title="4.2.3 存储过程和存储函数的查看、修改、删除"></a>4.2.3 存储过程和存储函数的查看、修改、删除</h3><blockquote>
<p>查看</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">1.</span> 使用<span class="keyword">SHOW</span> <span class="keyword">CREATE</span>语句查看存储过程和函数的创建信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> show_mgr_name;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> count_by_id;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2.</span> 使用<span class="keyword">SHOW</span> STATUS语句查看存储过程和函数的状态信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">PROCEDURE</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;show_max_salary&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">FUNCTION</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;email_by_id&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">3.</span>从information_schema.Routines表中查看存储过程和函数的信息</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.Routines</span><br><span class="line"><span class="keyword">WHERE</span> ROUTINE_NAME<span class="operator">=</span><span class="string">&#x27;email_by_id&#x27;</span> <span class="keyword">AND</span> ROUTINE_TYPE <span class="operator">=</span> <span class="string">&#x27;FUNCTION&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.Routines</span><br><span class="line"><span class="keyword">WHERE</span> ROUTINE_NAME<span class="operator">=</span><span class="string">&#x27;show_min_salary&#x27;</span> <span class="keyword">AND</span> ROUTINE_TYPE <span class="operator">=</span> <span class="string">&#x27;PROCEDURE&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> show_max_salary</span><br><span class="line"><span class="keyword">SQL</span> SECURITY INVOKER</span><br><span class="line">COMMENT <span class="string">&#x27;查询最高工资&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> IF <span class="keyword">EXISTS</span> count_by_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> IF <span class="keyword">EXISTS</span> show_min_salary;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-4-存储过程的优缺点"><a href="#4-2-4-存储过程的优缺点" class="headerlink" title="4.2.4 存储过程的优缺点"></a>4.2.4 存储过程的优缺点</h3><blockquote>
<p>优点</p>
</blockquote>
<ul>
<li><p>1.<strong>存储过程可以一次编译多次使用</strong>。存储过程只在创建时进行编译，之后的使用都不需要重新编译， 这就提升了 SQL 的执行效率</p>
</li>
<li><p>2.<strong>可以减少开发工作量</strong>。将代码 <strong>封装</strong> 成模块，实际上是编程的核心思想之一，这样可以把复杂的问题 拆解成不同的模块，然后模块之间可以 <strong>重复使用</strong> ，在减少开发工作量的同时，还能保证代码的结构清 晰。</p>
</li>
<li><p>3.<strong>存储过程的安全性强</strong>。我们在设定存储过程的时候可以 设置对用户的<strong>使用权限</strong> ，这样就和视图一样具 有较强的安全性 </p>
</li>
<li><p>4.可以减少网络传输量。因为代码封装到存储过程中，每次使用只需要调用存储过程即可，这样就减 少了网络传输量</p>
</li>
<li><p>5.<strong>良好的封装性</strong>。在进行相对复杂的数据库操作时，原本需要使用一条一条的 SQL 语句，可能要连接 多次数据库才能完成的操作，现在变成了一次存储过程，只需要<strong>连接一次即可</strong></p>
</li>
</ul>
<blockquote>
<p>缺点</p>
</blockquote>
<ul>
<li><p>1.<strong>可移植性差</strong>。存储过程不能跨数据库移植，比如在 MySQL、Oracle 和 SQL Server 里编写的存储过 程，在换成其他数据库时都需要重新编写</p>
</li>
<li><p>2.<strong>调试困难</strong>。只有少数 DBMS 支持存储过程的调试。对于复杂的存储过程来说，开发和维护都不容 易。虽然也有一些第三方工具可以对存储过程进行调试，但要收费</p>
</li>
<li><p>3.<strong>存储过程的版本管理很困难</strong>。比如数据表索引发生变化了，可能会导致存储过程失效。我们在开发 软件的时候往往需要进行版本管理，但是存储过程本身没有版本控制，版本迭代更新的时候很麻烦</p>
</li>
<li><p>4.<strong>它不适合高并发的场景</strong>。高并发的场景需要减少数据库的压力，有时数据库会采用分库分表的方 式，而且对可扩展性要求很高，在这种情况下，存储过程会变得难以维护， <strong>增加数据库的压力</strong> ，显然就 不适用了</p>
</li>
</ul>
<h2 id="4-3-变量、流程控制与游标"><a href="#4-3-变量、流程控制与游标" class="headerlink" title="4.3 变量、流程控制与游标"></a>4.3 变量、流程控制与游标</h2><h3 id="4-3-1-变量"><a href="#4-3-1-变量" class="headerlink" title="4.3.1 变量"></a>4.3.1 变量</h3><ul>
<li><p>在MySQL数据库的存储过程和函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据</p>
</li>
<li><p>在 MySQL 数据库中，变量分为 <strong>系统变量</strong> 以及 <strong>用户自定义变量</strong></p>
</li>
</ul>
<h4 id="4-3-1-1-系统变量"><a href="#4-3-1-1-系统变量" class="headerlink" title="4.3.1.1 系统变量"></a>4.3.1.1 系统变量</h4><blockquote>
<p>系统变量分类</p>
</blockquote>
<ul>
<li><p>变量由系统定义，不是用户定义，属于 <strong>服务器</strong> 层面。启动MySQL服务，生成MySQL服务实例期间，MySQL将为MySQL服务器内存中的系统变量赋值，这些系统变量定义了当前MySQL服务实例的属性、特征。这些系统变量的值要么是 <strong>编译MySQL时参数</strong> 的默认值，要么是 <strong>配置文件</strong> （例如my.ini等）中的参数值。大家可以通过网址 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html">https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html</a> 查看MySQL文档的系统变量</p>
</li>
<li><p>系统变量分为<strong>全局系统变量</strong>（需要添加 global 关键字）以及<strong>会话系统变量</strong>（需要添加 session 关键字），有时也把全局系统变量简称为<strong>全局变量</strong>，有时也把会话系统变量称为<strong>local变量</strong>。如果不写，<strong>默认会话级别</strong>。静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量</p>
</li>
<li><p>每一个MySQL客户机成功连接MySQL服务器后，都会产生与之对应的会话。会话期间，MySQL服务实例会在MySQL服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：</p>
</li>
</ul>
<p><img src="image-20221104162007491.png" alt="MySQL之性能优化/image-20221104162007491"></p>
<ul>
<li>全局系统变量针对于所有会话（连接）有效，但<strong>不能跨重启</strong></li>
<li>会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其他会话同一个会话系统变量的值</li>
<li><strong>会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在MySQL中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看系统变量</p>
</blockquote>
<ul>
<li>查看所有或部分系统变量</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查看所有全局变量</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES;</span><br><span class="line"></span><br><span class="line">#查看所有会话变量</span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES;</span><br><span class="line"></span><br><span class="line">#查看满足条件的部分系统变量。</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%标识符%&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#查看满足条件的部分会话变量</span><br><span class="line"><span class="keyword">SHOW</span> SESSION VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%标识符%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#举例</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;admin_%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看指定系统变量<ul>
<li>作为 MySQL 编码规范，MySQL 中的系统变量以 <strong>两个“@” 开头</strong>，其中“@@global”仅用于标记全局系统变量，“@@session”仅用于标记会话系统变量。“@@”首先标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#查看指定的系统变量的值</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.变量名;</span><br><span class="line"></span><br><span class="line">#查看指定的会话变量的值</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.变量名;</span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">SELECT</span> @@变量名;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改系统变量的值<ul>
<li>有些时候，数据库管理员需要修改系统变量的默认值，以便修改当前会话或者MySQL服务实例的属性、特征。具体方法：<ul>
<li>方式1：修改MySQL<strong>配置文件</strong> ，继而修改MySQL系统变量的值（该方法需要重启MySQL服务）</li>
<li>方式2：在MySQL服务运行期间，使用“set”命令重新设置系统变量的值</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#为某个系统变量赋值</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@global</span>.变量名<span class="operator">=</span>变量值;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> 变量名<span class="operator">=</span>变量值;</span><br><span class="line"></span><br><span class="line">#针对于当前的数据库实例是有效的，一旦重启mysql服务，就失效了</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#为某个会话变量赋值</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@session</span>.变量名<span class="operator">=</span>变量值;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：</span><br><span class="line"><span class="keyword">SET</span> SESSION 变量名<span class="operator">=</span>变量值;</span><br><span class="line"></span><br><span class="line">#针对于当前会话是有效的，一旦结束会话，重新建立起新的会话，就失效了</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#举例：</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.autocommit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@session</span>.tx_isolation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> @<span class="variable">@session</span>.tx_isolation<span class="operator">=</span><span class="string">&#x27;read-uncommitted&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> max_connections <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@global</span>.max_connections;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-1-2-用户变量"><a href="#4-3-1-2-用户变量" class="headerlink" title="4.3.1.2 用户变量"></a>4.3.1.2 用户变量</h4><blockquote>
<p>用户变量分类</p>
</blockquote>
<ul>
<li><p>用户变量是用户自己定义的，作为 MySQL 编码规范，MySQL 中的用户变量以 <strong>一个“@” 开头</strong>。根据作用范围不同，又分为<strong>会话用户变量</strong>和<strong>局部变量</strong></p>
</li>
<li><p><strong>会话用户变量</strong>：作用域和会话变量一样，只对<strong>当前连接</strong>会话有效</p>
</li>
<li><p><strong>局部变量</strong>：只在 BEGIN 和 END 语句块中有效。局部变量只能在<strong>存储过程和函数</strong>中使用</p>
</li>
</ul>
<blockquote>
<p>会话用户变量</p>
</blockquote>
<ul>
<li><p>变量的定义</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">1</span>：“<span class="operator">=</span>”或“:<span class="operator">=</span>”</span><br><span class="line"><span class="keyword">SET</span> @用户变量 <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">SET</span> @用户变量 :<span class="operator">=</span> 值;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：“:<span class="operator">=</span>” 或 <span class="keyword">INTO</span>关键字</span><br><span class="line"><span class="keyword">SELECT</span> @用户变量 :<span class="operator">=</span> 表达式 [<span class="keyword">FROM</span> 等子句];</span><br><span class="line"><span class="keyword">SELECT</span> 表达式 <span class="keyword">INTO</span> @用户变量	[<span class="keyword">FROM</span> 等子句];</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看用户变量的值 （查看、比较、运算等）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @用户变量</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#举例</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@a</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@a</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@num</span> :<span class="operator">=</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@num</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> <span class="variable">@avgsalary</span> <span class="keyword">FROM</span> employees; </span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@avgsalary</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@big</span>;	</span><br><span class="line">#查看某个未声明的变量时，将得到<span class="keyword">NULL</span>值</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>局部变量</p>
</blockquote>
<ul>
<li><p><strong>定义</strong>：可以使用 <code>DECLARE</code> 语句定义一个局部变量</p>
</li>
<li><p><strong>作用域</strong>：仅仅在定义它的 <code>BEGIN … END</code> 中有效</p>
</li>
<li><p><strong>位置</strong>：只能放在 <code>BEGIN … END</code> 中，而且<strong>只能放在第一句</strong></p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">#声明局部变量</span><br><span class="line"><span class="keyword">DECLARE</span> 变量名<span class="number">1</span> 变量数据类型 [<span class="keyword">DEFAULT</span> 变量默认值];</span><br><span class="line"><span class="keyword">DECLARE</span> 变量名<span class="number">2</span>,变量名<span class="number">3</span>,... 变量数据类型 [<span class="keyword">DEFAULT</span> 变量默认值];</span><br><span class="line"></span><br><span class="line">#为局部变量赋值</span><br><span class="line"><span class="keyword">SET</span> 变量名<span class="number">1</span> <span class="operator">=</span> 值;</span><br><span class="line"><span class="keyword">SELECT</span> 值 <span class="keyword">INTO</span> 变量名<span class="number">2</span> [<span class="keyword">FROM</span> 子句];</span><br><span class="line"></span><br><span class="line">#查看局部变量的值</span><br><span class="line"><span class="keyword">SELECT</span> 变量<span class="number">1</span>,变量<span class="number">2</span>,变量<span class="number">3</span>;</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<ul>
<li>1.定义变量</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 变量名 类型 [<span class="keyword">default</span> 值];	</span><br><span class="line">#如果没有<span class="keyword">DEFAULT</span>子句，初始值为<span class="keyword">NULL</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#举例：</span><br><span class="line"><span class="keyword">DECLARE</span>	myparam	<span class="type">INT</span>	<span class="keyword">DEFAULT</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>2.变量赋值</li>
</ul>
<p>方式1：一般用于赋简单的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> 变量名<span class="operator">=</span>值;</span><br><span class="line"><span class="keyword">SET</span> 变量名:<span class="operator">=</span>值;</span><br></pre></td></tr></table></figure>


<p>方式2：一般用于赋表中的字段值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 字段名或表达式 <span class="keyword">INTO</span> 变量名 <span class="keyword">FROM</span> 表;</span><br></pre></td></tr></table></figure>

<ul>
<li>3.使用变量（查看、比较、运算等）</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 局部变量名;</span><br></pre></td></tr></table></figure>

<p>举例1：声明局部变量，并分别赋值为employees表中employee_id为102的last_name和salary</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> set_value()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> emp_name <span class="type">VARCHAR</span>(<span class="number">25</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> sal <span class="keyword">DOUBLE</span>(<span class="number">10</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">SELECT</span> last_name,salary <span class="keyword">INTO</span> emp_name,sal</span><br><span class="line"><span class="keyword">FROM</span> employees</span><br><span class="line"><span class="keyword">WHERE</span> employee_id <span class="operator">=</span> <span class="number">102</span>;</span><br><span class="line"><span class="keyword">SELECT</span> emp_name,sal;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>举例2：声明两个变量，求和并打印 （分别使用会话用户变量、局部变量的方式实现）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">1</span>：使用用户变量</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@m</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@n</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@sum</span><span class="operator">=</span><span class="variable">@m</span><span class="operator">+</span><span class="variable">@n</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@sum</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：使用局部变量</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> add_value()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">#局部变量</span><br><span class="line"><span class="keyword">DECLARE</span> m <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> n <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">3</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> SUM <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">SET</span> SUM <span class="operator">=</span> m<span class="operator">+</span>n;</span><br><span class="line"><span class="keyword">SELECT</span> SUM;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>举例3：创建存储过程“different_salary”查询某员工和他领导的薪资差距，并用IN参数emp_id接收员工id，用OUT参数dif_salary输出薪资差距结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#声明</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> different_salary(<span class="keyword">IN</span> emp_id <span class="type">INT</span>,<span class="keyword">OUT</span> dif_salary <span class="keyword">DOUBLE</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">#声明局部变量</span><br><span class="line"><span class="keyword">DECLARE</span> emp_sal,mgr_sal <span class="keyword">DOUBLE</span> <span class="keyword">DEFAULT</span> <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> mgr_id <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> emp_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> manager_id <span class="keyword">INTO</span> mgr_id <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> mgr_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> mgr_id;</span><br><span class="line"><span class="keyword">SET</span> dif_salary <span class="operator">=</span> mgr_sal <span class="operator">-</span> emp_sal;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">SET</span> <span class="variable">@emp</span>_id <span class="operator">=</span> <span class="number">102</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> different_salary(<span class="variable">@emp</span>_id,<span class="variable">@diff</span>_sal);</span><br><span class="line">#查看</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@diff</span>_sal;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对比会话用户变量与局部变量</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>作用域</th>
<th>定义位置</th>
<th>语法</th>
</tr>
</thead>
<tbody><tr>
<td>会话用户变量</td>
<td>当前会话</td>
<td>会话的任何地方</td>
<td>加@符号，不用指定类型</td>
</tr>
<tr>
<td>局部变量</td>
<td>定义它的BEGIN END中</td>
<td>BEGIN END的第一句话</td>
<td>一般不用加@,需要指定类型</td>
</tr>
</tbody></table>
<h3 id="4-3-2-定义条件与处理程序"><a href="#4-3-2-定义条件与处理程序" class="headerlink" title="4.3.2 定义条件与处理程序"></a>4.3.2 定义条件与处理程序</h3><blockquote>
<p><strong>定义条件</strong>是事先定义程序执行过程中可能遇到的问题， <strong>处理程序</strong>定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。这样可以增强存储程序处理问题的能力，避免程序异常停止运行</p>
</blockquote>
<ul>
<li><strong>说明</strong>：定义条件和处理程序在存储过程、存储函数中都是支持的</li>
</ul>
<h4 id="4-3-2-1-案例分析"><a href="#4-3-2-1-案例分析" class="headerlink" title="4.3.2.1 案例分析"></a>4.3.2.1 案例分析</h4><ul>
<li>案例分析：创建一个名称为“UpdateDataNoCondition”的存储过程。代码如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> UpdateDataNoCondition()</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> email <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>; </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> email <span class="operator">=</span> <span class="string">&#x27;aabbel&#x27;</span> <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>; </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用存储过程：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> UpdateDataNoCondition();</span><br><span class="line">#ERROR <span class="number">1048</span> (<span class="number">23000</span>): <span class="keyword">Column</span> <span class="string">&#x27;email&#x27;</span> cannot be <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@x</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+------+</span></span><br><span class="line"><span class="comment">| @x	|</span></span><br><span class="line"><span class="comment">+------+</span></span><br><span class="line"><span class="comment">|	1	|</span></span><br><span class="line"><span class="comment">+------+*/</span></span><br></pre></td></tr></table></figure>

<p>可以看到，此时@x变量的值为1。结合创建存储过程的SQL语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的SQL语句报错时，MySQL数据库会抛出错误，并退出当前SQL逻辑，不再向下继续执行。</p>
<h4 id="4-3-2-2-定义条件"><a href="#4-3-2-2-定义条件" class="headerlink" title="4.3.2.2 定义条件"></a>4.3.2.2 定义条件</h4><ul>
<li><p>定义条件就是给MySQL中的错误码命名，这有助于存储的程序代码更清晰。它将一个 <strong>错误名字</strong> 和 <strong>指定的错误条件</strong> 关联起来。这个名字可以随后被用在定义处理程序的 <strong><code>DECLARE HANDLER</code></strong> 语句中</p>
</li>
<li><p>定义条件使用DECLARE语句，语法格式如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 错误名称 <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> 错误码（或错误条件）</span><br></pre></td></tr></table></figure>

<ul>
<li>错误码的说明：<ul>
<li><strong>MySQL_error_code</strong> 和 <strong>sqlstate_value</strong> 都可以表示MySQL的错误。<ul>
<li>1)<code>MySQL_error_code</code>是数值类型错误代码。</li>
<li>2)<code>sqlstate_value</code>是长度为5的字符串类型错误代码。</li>
</ul>
</li>
<li>例如，在ERROR 1418 (HY000)中，1418是MySQL_error_code，’HY000’是<code>sqlstate_value</code></li>
<li>例如，在ERROR 1142（42000）中，1142是MySQL_error_code，’42000’是<code>sqlstate_value</code></li>
</ul>
</li>
<li>举例1：定义“Field_Not_Be_NULL”错误名与MySQL中违反非空约束的错误类型是“ERROR 1048 (23000)”对应</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#使用MySQL_error_code</span><br><span class="line"></span><br><span class="line"><span class="keyword">DECLARE</span> Field_Not_Be_NULL <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1048</span>;</span><br><span class="line"></span><br><span class="line">#使用sqlstate_value</span><br><span class="line"><span class="keyword">DECLARE</span> Field_Not_Be_NULL <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;23000&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：定义”ERROR 1148(42000)”错误，名称为command_not_allowed</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#使用MySQL_error_code</span><br><span class="line"><span class="keyword">DECLARE</span> command_not_allowed <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1148</span>;</span><br><span class="line"></span><br><span class="line">#使用sqlstate_value</span><br><span class="line"><span class="keyword">DECLARE</span> command_not_allowed <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;42000&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-3-定义处理程序"><a href="#4-3-2-3-定义处理程序" class="headerlink" title="4.3.2.3 定义处理程序"></a>4.3.2.3 定义处理程序</h4><ul>
<li>可以为SQL执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用DECLARE语句的语法如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 处理方式 HANDLER <span class="keyword">FOR</span> 错误类型 处理语句</span><br></pre></td></tr></table></figure>

<ul>
<li>处理方式：处理方式有3个取值：<code>CONTINUE、EXIT、UNDO</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONTINUE ：表示遇到错误不处理，继续执行</span><br><span class="line">EXIT ：表示遇到错误马上退出</span><br><span class="line">UNDO ：表示遇到错误后撤回之前的操作。MySQL中暂时不支持这样的操作</span><br></pre></td></tr></table></figure>

<ul>
<li>错误类型（即条件）可以有如下取值:</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SQLSTATE</span> ‘字符串错误码’ ：表示长度为<span class="number">5</span>的sqlstate_value类型的错误代码</span><br><span class="line">MySQL_error_code ：匹配数值类型错误代码</span><br><span class="line">错误名称 ：表示<span class="keyword">DECLARE</span> … <span class="keyword">CONDITION</span>定义的错误条件名称</span><br><span class="line"><span class="keyword">SQLWARNING</span> ：匹配所有以<span class="number">01</span>开头的<span class="keyword">SQLSTATE</span>错误代码</span><br><span class="line"><span class="keyword">NOT</span> FOUND ：匹配所有以<span class="number">02</span>开头的<span class="keyword">SQLSTATE</span>错误代码</span><br><span class="line"><span class="keyword">SQLEXCEPTION</span> ：匹配所有没有被<span class="keyword">SQLWARNING</span>或<span class="keyword">NOT</span> FOUND捕获的<span class="keyword">SQLSTATE</span>错误代码</span><br></pre></td></tr></table></figure>

<ul>
<li>处理语句：如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像“ SET 变量 &#x3D; 值 ”这样的简单语句，也可以是使用 BEGIN … END 编写的复合语句<ul>
<li>定义处理程序的几种方式，代码如下：</li>
</ul>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#方法<span class="number">1</span>：捕获sqlstate_value</span><br><span class="line"><span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;42S02&#x27;</span> <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;NO_SUCH_TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方法<span class="number">2</span>：捕获mysql_error_value</span><br><span class="line"><span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="number">1146</span> <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;NO_SUCH_TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方法<span class="number">3</span>：先定义条件，再调用</span><br><span class="line"><span class="keyword">DECLARE</span> no_such_table <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="number">1146</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> NO_SUCH_TABLE <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;NO_SUCH_TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方法<span class="number">4</span>：使用<span class="keyword">SQLWARNING</span></span><br><span class="line"><span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLWARNING</span> <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;ERROR&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方法<span class="number">5</span>：使用<span class="keyword">NOT</span> FOUND</span><br><span class="line"><span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;NO_SUCH_TABLE&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#方法<span class="number">6</span>：使用<span class="keyword">SQLEXCEPTION</span></span><br><span class="line"><span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> <span class="keyword">SQLEXCEPTION</span> <span class="keyword">SET</span> <span class="variable">@info</span> <span class="operator">=</span> <span class="string">&#x27;ERROR&#x27;</span>;</span><br></pre></td></tr></table></figure>


<h4 id="4-3-2-4-案例解决"><a href="#4-3-2-4-案例解决" class="headerlink" title="4.3.2.4 案例解决"></a>4.3.2.4 案例解决</h4><ul>
<li>在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到MySQL_error_code值为1048时，执行CONTINUE操作，并且将@proc_value的值设置为-1</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> UpdateDataNoCondition()</span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">        #定义处理程序</span><br><span class="line">        <span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="number">1048</span> <span class="keyword">SET</span> <span class="variable">@proc</span>_value <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> email <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>; </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> email <span class="operator">=</span> <span class="string">&#x27;aabbel&#x27;</span> <span class="keyword">WHERE</span> last_name <span class="operator">=</span> <span class="string">&#x27;Abel&#x27;</span>; </span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用过程：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> InsertDataWithCondition();</span><br><span class="line">#Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@x</span>,<span class="variable">@proc</span>_value;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">| @x	|	@proc_value |</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">|		3 |	-1  |</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>举例：</p>
<ul>
<li>创建一个名称为“InsertDataWithCondition”的存储过程</li>
<li>在存储过程中，定义处理程序，捕获sqlstate_value值，当遇到sqlstate_value值为23000时，执行EXIT操作，并且将@proc_value的值设置为-1</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#准备工作</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> departments</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> atguigudb.`departments`;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> departments</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> uk_dept_name <span class="keyword">UNIQUE</span>(department_id);</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> InsertDataWithCondition()</span><br><span class="line">    <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">DECLARE</span> duplicate_entry <span class="keyword">CONDITION</span> <span class="keyword">FOR</span> <span class="keyword">SQLSTATE</span> <span class="string">&#x27;23000&#x27;</span> ; </span><br><span class="line">        <span class="keyword">DECLARE</span> EXIT HANDLER <span class="keyword">FOR</span> duplicate_entry <span class="keyword">SET</span> <span class="variable">@proc</span>_value <span class="operator">=</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> departments(department_name) <span class="keyword">VALUES</span>(<span class="string">&#x27;测试&#x27;</span>);</span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">INSERT</span> <span class="keyword">INTO</span> departments(department_name) <span class="keyword">VALUES</span>(<span class="string">&#x27;测试&#x27;</span>);</span><br><span class="line">        <span class="keyword">SET</span> <span class="variable">@x</span> <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用存储过程：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> InsertDataWithCondition();</span><br><span class="line">#Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@x</span>,<span class="variable">@proc</span>_value;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">| @x	|	@proc_value |</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">|		2 |	-1  |</span></span><br><span class="line"><span class="comment">+	------	+-------------	+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-3-3-流程控制"><a href="#4-3-3-流程控制" class="headerlink" title="4.3.3 流程控制"></a>4.3.3 流程控制</h3><p>解决复杂问题不可能通过一个 SQL 语句完成，我们需要执行多个 SQL 操作。<strong>流程控制语句的作用就是控制存储过程中 SQL 语句的执行顺序</strong>，是我们完成复杂操作必不可少的一部分。只要是执行的程序，流程就分为三大类：</p>
<ul>
<li><p><strong>顺序结构</strong>：程序从上往下依次执行</p>
</li>
<li><p><strong>分支结构</strong>：程序按条件进行选择执行，从两条或多条路径中选择一条执行</p>
</li>
<li><p><strong>循环结构</strong>：程序满足一定条件下，重复执行一组语句</p>
</li>
</ul>
<p>针对于MySQL 的流程控制语句主要有 3 类。注意：<strong>只能用于存储程序</strong></p>
<ul>
<li><strong>条件判断语句</strong> ：if 语句和 case 语句</li>
<li><strong>循环语句</strong> ：loop、while 和 repeat 语句</li>
<li><strong>跳转语句</strong> ：iterate 和 leave 语句</li>
</ul>
<h4 id="4-3-3-1-分支机构之if"><a href="#4-3-3-1-分支机构之if" class="headerlink" title="4.3.3.1 分支机构之if"></a>4.3.3.1 分支机构之if</h4><ul>
<li>if 语句的语法结构是：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF 表达式<span class="number">1</span> <span class="keyword">THEN</span> 操作<span class="number">1</span></span><br><span class="line">[ELSEIF 表达式<span class="number">2</span> <span class="keyword">THEN</span> 操作<span class="number">2</span>]……</span><br><span class="line">[<span class="keyword">ELSE</span> 操作N]</span><br><span class="line"><span class="keyword">END</span> IF</span><br></pre></td></tr></table></figure>

<ul>
<li><p>根据表达式的结果为 true 或 false 执行相应的语句。这里“[]”中的内容是可选的</p>
</li>
<li><p>特点：</p>
<ul>
<li>① 不同的表达式对应不同的操作</li>
<li>② <strong>使用在begin end中</strong></li>
</ul>
</li>
<li><p>举例1：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_if()</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>	</span><br><span class="line">	#情况<span class="number">1</span>：</span><br><span class="line">	#声明局部变量</span><br><span class="line">	#<span class="keyword">declare</span> stu_name <span class="type">varchar</span>(<span class="number">15</span>);</span><br><span class="line">	</span><br><span class="line">	#if stu_name <span class="keyword">is</span> <span class="keyword">null</span> </span><br><span class="line">	#	<span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;stu_name is null&#x27;</span>;</span><br><span class="line">	#<span class="keyword">end</span> if;</span><br><span class="line">	</span><br><span class="line">	#情况<span class="number">2</span>：二选一</span><br><span class="line">	#<span class="keyword">declare</span> email <span class="type">varchar</span>(<span class="number">25</span>) <span class="keyword">default</span> <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">	#if email <span class="keyword">is</span> <span class="keyword">null</span></span><br><span class="line">	#	<span class="keyword">then</span> <span class="keyword">select</span> <span class="string">&#x27;email is null&#x27;</span>;</span><br><span class="line">	#<span class="keyword">else</span></span><br><span class="line">	#	<span class="keyword">select</span> <span class="string">&#x27;email is not null&#x27;</span>;</span><br><span class="line">	#<span class="keyword">end</span> if;</span><br><span class="line">	</span><br><span class="line">	#情况<span class="number">3</span>：多选一</span><br><span class="line">	<span class="keyword">DECLARE</span> age <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">20</span>;</span><br><span class="line">	</span><br><span class="line">	IF age <span class="operator">&gt;</span> <span class="number">40</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;中老年&#x27;</span>;</span><br><span class="line">	ELSEIF age <span class="operator">&gt;</span> <span class="number">18</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;青壮年&#x27;</span>;</span><br><span class="line">	ELSEIF age <span class="operator">&gt;</span> <span class="number">8</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;青少年&#x27;</span>;</span><br><span class="line">	<span class="keyword">ELSE</span></span><br><span class="line">		<span class="keyword">SELECT</span> <span class="string">&#x27;婴幼儿&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> test_if();</span><br><span class="line"></span><br><span class="line">#删除存储过程</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span> test_if;</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：声明存储过程“update_salary_by_eid1”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于8000元并且入职时间超过5年，就涨薪500元；否则就不变</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_by_eid1(<span class="keyword">IN</span> emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明局部变量</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_sal <span class="keyword">DOUBLE</span>; #记录员工的工资</span><br><span class="line">	<span class="keyword">DECLARE</span> hire_year <span class="keyword">DOUBLE</span>; #记录员工入职公司的年头</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> emp_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SELECT</span> DATEDIFF(CURDATE(),hire_date)<span class="operator">/</span><span class="number">365</span> <span class="keyword">INTO</span> hire_year <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	#判断</span><br><span class="line">	IF emp_sal <span class="operator">&lt;</span> <span class="number">8000</span> <span class="keyword">AND</span> hire_year <span class="operator">&gt;=</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid1(<span class="number">104</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>举例3：声明存储过程“update_salary_by_eid2”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元并且入职时间超过5年，就涨薪500元；否则就涨薪100元</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_by_eid2(<span class="keyword">IN</span> emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明局部变量</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_sal <span class="keyword">DOUBLE</span>; #记录员工的工资</span><br><span class="line">	<span class="keyword">DECLARE</span> hire_year <span class="keyword">DOUBLE</span>; #记录员工入职公司的年头</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> emp_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SELECT</span> DATEDIFF(CURDATE(),hire_date)<span class="operator">/</span><span class="number">365</span> <span class="keyword">INTO</span> hire_year <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	#判断</span><br><span class="line">	IF emp_sal <span class="operator">&lt;</span> <span class="number">9000</span> <span class="keyword">AND</span> hire_year <span class="operator">&gt;=</span> <span class="number">5</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">ELSE</span></span><br><span class="line">		<span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid2(<span class="number">103</span>);</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid2(<span class="number">104</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>举例4：声明存储过程“update_salary_by_eid3”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资如果大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_by_eid3(<span class="keyword">IN</span> emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明变量</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_sal <span class="keyword">DOUBLE</span>; #记录员工工资</span><br><span class="line">	<span class="keyword">DECLARE</span> bonus <span class="keyword">DOUBLE</span>; #记录员工的奖金率</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> emp_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">SELECT</span> commission_pct <span class="keyword">INTO</span> bonus <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	#判断</span><br><span class="line">	IF emp_sal <span class="operator">&lt;</span> <span class="number">9000</span> </span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">9000</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	ELSEIF emp_sal <span class="operator">&lt;</span> <span class="number">10000</span> <span class="keyword">AND</span> bonus <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">		<span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> commission_pct <span class="operator">=</span> <span class="number">0.01</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">ELSE</span> </span><br><span class="line">		<span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid3(<span class="number">102</span>);</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid3(<span class="number">103</span>);</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid3(<span class="number">104</span>);</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-2-分支机构之case"><a href="#4-3-3-2-分支机构之case" class="headerlink" title="4.3.3.2 分支机构之case"></a>4.3.3.2 分支机构之case</h4><ul>
<li>语句的语法结构：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#情况一：类似于switch</span><br><span class="line"><span class="keyword">CASE</span> 表达式</span><br><span class="line"><span class="keyword">WHEN</span> 值<span class="number">1</span> <span class="keyword">THEN</span> 结果<span class="number">1</span>或语句<span class="number">1</span>(如果是语句，需要加分号)</span><br><span class="line"><span class="keyword">WHEN</span> 值<span class="number">2</span> <span class="keyword">THEN</span> 结果<span class="number">2</span>或语句<span class="number">2</span>(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">ELSE</span> 结果n或语句n(如果是语句，需要加分号)</span><br><span class="line"><span class="keyword">END</span> [<span class="keyword">case</span>]（如果是放在<span class="keyword">begin</span> <span class="keyword">end</span>中需要加上<span class="keyword">case</span>，如果放在<span class="keyword">select</span>后面不需要）</span><br><span class="line"></span><br><span class="line">#情况二：类似于多重if</span><br><span class="line"><span class="keyword">CASE</span></span><br><span class="line"><span class="keyword">WHEN</span> 条件<span class="number">1</span> <span class="keyword">THEN</span> 结果<span class="number">1</span>或语句<span class="number">1</span>(如果是语句，需要加分号)</span><br><span class="line"><span class="keyword">WHEN</span> 条件<span class="number">2</span> <span class="keyword">THEN</span> 结果<span class="number">2</span>或语句<span class="number">2</span>(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line"><span class="keyword">ELSE</span> 结果n或语句n(如果是语句，需要加分号)</span><br><span class="line"><span class="keyword">END</span> [<span class="keyword">case</span>]（如果是放在<span class="keyword">begin</span> <span class="keyword">end</span>中需要加上<span class="keyword">case</span>，如果放在<span class="keyword">select</span>后面不需要）</span><br></pre></td></tr></table></figure>

<ul>
<li>举例1：使用 case 流程控制语句的第1种格式，判断val值等于1、等于2，或者两者都不等</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CASE</span> val</span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is 1&#x27;</span>;</span><br><span class="line"><span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is 2&#x27;</span>;</span><br><span class="line"><span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is not 1 or 2&#x27;</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：使用 case 流程控制语句的第2种格式，判断val是否为空、小于0、大于0或者等于0</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CASE</span></span><br><span class="line"><span class="keyword">WHEN</span> val <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is null&#x27;</span>;</span><br><span class="line"><span class="keyword">WHEN</span> val <span class="operator">&lt;</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is less than 0&#x27;</span>;</span><br><span class="line"><span class="keyword">WHEN</span> val <span class="operator">&gt;</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is greater than 0&#x27;</span>;</span><br><span class="line"><span class="keyword">ELSE</span> <span class="keyword">SELECT</span> <span class="string">&#x27;val is 0&#x27;</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>举例3：声明存储过程“update_salary_by_eid4”，定义IN参数emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_by_eid4(<span class="keyword">IN</span> emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#局部变量的声明</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_sal <span class="keyword">DOUBLE</span>; #记录员工的工资</span><br><span class="line">	<span class="keyword">DECLARE</span> bonus <span class="keyword">DOUBLE</span>; #记录员工的奖金率</span><br><span class="line">	</span><br><span class="line">	#局部变量的赋值</span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> emp_sal <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">SELECT</span> commission_pct <span class="keyword">INTO</span> bonus <span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">CASE</span></span><br><span class="line">	<span class="keyword">WHEN</span> emp_sal <span class="operator">&lt;</span> <span class="number">9000</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> <span class="number">9000</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">WHEN</span> emp_sal <span class="operator">&lt;</span> <span class="number">10000</span> <span class="keyword">AND</span> bonus <span class="keyword">IS</span> <span class="keyword">NULL</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> commission_pct <span class="operator">=</span> <span class="number">0.01</span> </span><br><span class="line">						    <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">ELSE</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid4(<span class="number">103</span>);</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid4(<span class="number">104</span>);</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid4(<span class="number">105</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>举例4：声明存储过程update_salary_by_eid5，定义IN参数emp_id，输入员工编号。判断该员工的入职年限，如果是0年，薪资涨50；如果是1年，薪资涨100；如果是2年，薪资涨200；如果是3年，薪资涨300；如果是4年，薪资涨400；其他的涨薪500</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_by_eid5(<span class="keyword">IN</span> emp_id <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明局部变量</span><br><span class="line">	<span class="keyword">DECLARE</span> hire_year <span class="type">INT</span>; #记录员工入职公司的总时间（单位：年）</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SELECT</span> ROUND(DATEDIFF(CURDATE(),hire_date) <span class="operator">/</span> <span class="number">365</span>) <span class="keyword">INTO</span> hire_year </span><br><span class="line">	<span class="keyword">FROM</span> employees <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	</span><br><span class="line">	#判断</span><br><span class="line">	<span class="keyword">CASE</span> hire_year</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">50</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">100</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">2</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">200</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">3</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">300</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">		<span class="keyword">WHEN</span> <span class="number">4</span> <span class="keyword">THEN</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">400</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">		<span class="keyword">ELSE</span> <span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">+</span> <span class="number">500</span> <span class="keyword">WHERE</span> employee_id <span class="operator">=</span> emp_id;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> update_salary_by_eid5(<span class="number">101</span>);</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-3-循环结构之-loop"><a href="#4-3-3-3-循环结构之-loop" class="headerlink" title="4.3.3.3 循环结构之 loop"></a>4.3.3.3 循环结构之 loop</h4><ul>
<li><p>loop循环语句用来重复执行某些语句。loop内的语句一直重复执行直到循环被退出（使用leave子句），跳出循环过程</p>
</li>
<li><p>loop语句的基本格式如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[loop_label:] LOOP</span><br><span class="line">循环执行的语句</span><br><span class="line"><span class="keyword">END</span> LOOP [loop_label]</span><br><span class="line">#其中，loop_label表示loop语句的标注名称，该参数可以省略</span><br></pre></td></tr></table></figure>

<ul>
<li>举例1：使用loop语句进行循环操作，id值小于10时将重复执行循环过程</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_loop()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明局部变量</span><br><span class="line">	<span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	loop_label:LOOP</span><br><span class="line">		#重新赋值</span><br><span class="line">		<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		#可以考虑某个代码程序反复执行。（略）</span><br><span class="line">		</span><br><span class="line">		IF num <span class="operator">&gt;=</span> <span class="number">10</span> <span class="keyword">THEN</span> LEAVE loop_label;</span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">	<span class="keyword">END</span> LOOP loop_label;</span><br><span class="line">	</span><br><span class="line">	#查看num</span><br><span class="line">	<span class="keyword">SELECT</span> num;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> test_loop();</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_loop()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.1倍。直到全公司的平均薪资达到12000结束。并统计循环次数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_loop(<span class="keyword">OUT</span> num <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明变量</span><br><span class="line">	<span class="keyword">DECLARE</span> avg_sal <span class="keyword">DOUBLE</span> ; #记录员工的平均工资</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">DECLARE</span> loop_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;#记录循环的次数</span><br><span class="line">	</span><br><span class="line">	#① 初始化条件</span><br><span class="line">	#获取员工的平均工资</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line">	loop_lab:LOOP</span><br><span class="line">		#② 循环条件</span><br><span class="line">		#结束循环的条件</span><br><span class="line">		IF avg_sal <span class="operator">&gt;=</span> <span class="number">12000</span></span><br><span class="line">			<span class="keyword">THEN</span> LEAVE loop_lab;</span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">		</span><br><span class="line">		#③ 循环体</span><br><span class="line">		#如果低于<span class="number">12000</span>，更新员工的工资</span><br><span class="line">		<span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.1</span>;</span><br><span class="line">		</span><br><span class="line">		#④ 迭代条件</span><br><span class="line">		#更新avg_sal变量的值</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line">		</span><br><span class="line">		#记录循环次数</span><br><span class="line">		<span class="keyword">SET</span> loop_count <span class="operator">=</span> loop_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">END</span> LOOP loop_lab;</span><br><span class="line">			</span><br><span class="line">	#给num赋值</span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> loop_count;	</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-4-循环结构之-while"><a href="#4-3-3-4-循环结构之-while" class="headerlink" title="4.3.3.4 循环结构之 while"></a>4.3.3.4 循环结构之 while</h4><ul>
<li>while 语句创建一个带条件判断的循环过程。while 在执行语句执行时，先对指定的表达式进行判断，如果为真，就执行循环内的语句，否则退出循环</li>
<li>while 语句的基本格式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[while_label:] WHILE 循环条件	DO</span><br><span class="line"></span><br><span class="line">循环体</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> WHILE [while_label];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>while_label为 while 语句的标注名称；如果循环条件结果为真，while 语句内的语句或语句群被执行，直至循环条件为假，退出循环</p>
</li>
<li><p>举例1：while 语句示例，i值小于10时，将重复执行循环过程，代码如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_while()</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>	</span><br><span class="line">	#初始化条件</span><br><span class="line">	<span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	#循环条件</span><br><span class="line">	WHILE num <span class="operator">&lt;=</span> <span class="number">10</span> DO</span><br><span class="line">		#循环体（略）</span><br><span class="line">		</span><br><span class="line">		#迭代条件</span><br><span class="line">		<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	</span><br><span class="line">	#查询</span><br><span class="line">	<span class="keyword">SELECT</span> num;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> test_while();</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“update_salary_while()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家降薪，薪资降为原来的90%。直到全公司的平均薪资达到5000结束。并统计循环次数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_while(<span class="keyword">OUT</span> num <span class="type">INT</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明变量</span><br><span class="line">	<span class="keyword">DECLARE</span> avg_sal <span class="keyword">DOUBLE</span> ; #记录平均工资</span><br><span class="line">	<span class="keyword">DECLARE</span> while_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>; #记录循环次数</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line">	WHILE avg_sal <span class="operator">&gt;</span> <span class="number">5000</span> DO</span><br><span class="line">		<span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">0.9</span> ;</span><br><span class="line">		<span class="keyword">SET</span> while_count <span class="operator">=</span> while_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	</span><br><span class="line">	#给num赋值</span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> while_count;		</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> update_salary_while(<span class="variable">@num</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@num</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-5-循环结构之-repeat"><a href="#4-3-3-5-循环结构之-repeat" class="headerlink" title="4.3.3.5 循环结构之 repeat"></a>4.3.3.5 循环结构之 repeat</h4><ul>
<li><p>repeat 语句创建一个带条件判断的循环过程。与 while 循环不同的是，repeat 循环首先会执行一次循环，然后在 UNTIL 中进行表达式的判断，如果满足条件就退出，即 end repeat；如果条件不满足，则会就继续执行循环，直到满足退出条件为止</p>
</li>
<li><p>REPEAT语句的基本格式如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[repeat_label:] REPEAT</span><br><span class="line">循环体的语句</span><br><span class="line"></span><br><span class="line">UNTIL 结束循环的条件表达式</span><br><span class="line"><span class="keyword">END</span> REPEAT [repeat_label]</span><br><span class="line"></span><br><span class="line">#repeat_label为repeat语句的标注名称，该参数可以省略；repeat语句内的语句或语句群被重复，直至expr_condition为真</span><br></pre></td></tr></table></figure>

<ul>
<li>举例1：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_repeat()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#声明变量</span><br><span class="line">	<span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line">	REPEAT</span><br><span class="line">		<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		UNTIL num <span class="operator">&gt;=</span> <span class="number">10</span></span><br><span class="line">	<span class="keyword">END</span> REPEAT;</span><br><span class="line">	</span><br><span class="line">	#查看</span><br><span class="line">	<span class="keyword">SELECT</span> num;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> test_repeat();</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程“update_salary_repeat()”，声明OUT参数num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.15倍。直到全公司的平均薪资达到13000结束。并统计循环次数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> update_salary_repeat(<span class="keyword">OUT</span> num <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> avg_sal <span class="keyword">DOUBLE</span> ;</span><br><span class="line"><span class="keyword">DECLARE</span> repeat_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">1.15</span>;</span><br><span class="line"><span class="keyword">SET</span> repeat_count <span class="operator">=</span> repeat_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">UNTIL avg_sal <span class="operator">&gt;=</span> <span class="number">13000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> num <span class="operator">=</span> repeat_count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>对比三种循环结构：</p>
</blockquote>
<ul>
<li><p>1.这三种循环都可以省略名称，但如果循环中添加了循环控制语句（leave 或 repeat）则必须添加名称</p>
</li>
<li><p>2.loop：一般用于实现简单的”死”循环 while：先判断后执行 repeat：先执行后判断，无条件至少执行一次</p>
</li>
</ul>
<h4 id="4-3-3-6-跳转语句之leave语句"><a href="#4-3-3-6-跳转语句之leave语句" class="headerlink" title="4.3.3.6 跳转语句之leave语句"></a>4.3.3.6 跳转语句之leave语句</h4><ul>
<li><p>leave 语句：<strong>可以用在循环语句内，或者以 BEGIN 和 END 包裹起来的程序体内，表示跳出循环或者跳出程序体的操作</strong>。如果你有面向过程的编程语言的使用经验，你可以把 leave 理解为 break</p>
</li>
<li><p>基本格式如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LEAVE 标记名</span><br><span class="line"></span><br><span class="line">#其中，label参数表示循环的标志。leave 和<span class="keyword">BEGIN</span> … <span class="keyword">END</span>或循环一起被使用</span><br></pre></td></tr></table></figure>

<ul>
<li>举例1：创建存储过程 “leave_begin()”，声明INT类型的IN参数num。给BEGIN…END加标记名，并在BEGIN…END中使用IF语句判断num参数的值</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">如果num<span class="operator">&lt;=</span><span class="number">0</span>，则使用LEAVE语句退出<span class="keyword">BEGIN</span>…<span class="keyword">END</span>；</span><br><span class="line">如果num<span class="operator">=</span><span class="number">1</span>，则查询“employees”表的平均薪资；</span><br><span class="line">如果num<span class="operator">=</span><span class="number">2</span>，则查询“employees”表的最低薪资；</span><br><span class="line">如果num<span class="operator">&gt;</span><span class="number">2</span>，则查询“employees”表的最高薪资。</span><br><span class="line">IF语句结束后查询“employees”表的总人数。</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> leave_begin(<span class="keyword">IN</span> num <span class="type">INT</span>)</span><br><span class="line"></span><br><span class="line">    begin_label:<span class="keyword">BEGIN</span></span><br><span class="line">        IF num <span class="operator">&lt;=</span> <span class="number">0</span></span><br><span class="line">            <span class="keyword">THEN</span> LEAVE begin_label;</span><br><span class="line">        ELSEIF num <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">            <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line">        ELSEIF num <span class="operator">=</span> <span class="number">2</span></span><br><span class="line">            <span class="keyword">THEN</span> <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line">        <span class="keyword">ELSE</span> </span><br><span class="line">            <span class="keyword">SELECT</span> <span class="built_in">MAX</span>(salary) <span class="keyword">FROM</span> employees;</span><br><span class="line">        <span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line">        #查询总人数</span><br><span class="line">        <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> employees;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> leave_begin(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>举例2：当市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“leave_while()”，声明OUT参数num，输出循环次数，存储过程中使用WHILE循环给大家降低薪资为原来薪资的90%，直到全公司的平均薪资小于等于10000，并统计循环次数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> leave_while(<span class="keyword">OUT</span> num <span class="type">INT</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> avg_sal <span class="keyword">DOUBLE</span>;#记录平均工资</span><br><span class="line">	<span class="keyword">DECLARE</span> while_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>; #记录循环次数</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees; #① 初始化条件</span><br><span class="line">	</span><br><span class="line">	while_label:WHILE <span class="literal">TRUE</span> DO  #② 循环条件</span><br><span class="line">		</span><br><span class="line">		#③ 循环体</span><br><span class="line">		IF avg_sal <span class="operator">&lt;=</span> <span class="number">10000</span> <span class="keyword">THEN</span></span><br><span class="line">			LEAVE while_label;</span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">UPDATE</span> employees <span class="keyword">SET</span> salary  <span class="operator">=</span> salary <span class="operator">*</span> <span class="number">0.9</span>;</span><br><span class="line">		<span class="keyword">SET</span> while_count <span class="operator">=</span> while_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		#④ 迭代条件</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">INTO</span> avg_sal <span class="keyword">FROM</span> employees;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	</span><br><span class="line">	#赋值</span><br><span class="line">	<span class="keyword">SET</span> num <span class="operator">=</span> while_count;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> leave_while(<span class="variable">@num</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@num</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">AVG</span>(salary) <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-7-跳转语句之iterate语句"><a href="#4-3-3-7-跳转语句之iterate语句" class="headerlink" title="4.3.3.7 跳转语句之iterate语句"></a>4.3.3.7 跳转语句之iterate语句</h4><ul>
<li><p>iterate 语句：<strong>只能用在循环语句（loop、repeat 和 while 语句）内，表示重新开始循环，将执行顺序转到语句段开头处</strong>。如果你有面向过程的编程语言的使用经验，<strong>可以把 iterate 理解为 continue，意思为“再次循环”</strong></p>
</li>
<li><p>语句基本格式如下：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label</span><br><span class="line">#label参数表示循环的标志。iterate 语句必须跟在循环标志前面</span><br></pre></td></tr></table></figure>

<ul>
<li>举例：定义局部变量num，初始值为0。循环结构中执行num + 1操作；如果num &lt; 10，则继续执行循环；如果num &gt; 15，则退出循环结构</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> test_iterate()</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> num <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	loop_label:LOOP</span><br><span class="line">		#赋值</span><br><span class="line">		<span class="keyword">SET</span> num <span class="operator">=</span> num <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		</span><br><span class="line">		IF num  <span class="operator">&lt;</span> <span class="number">10</span></span><br><span class="line">			<span class="keyword">THEN</span> ITERATE loop_label;</span><br><span class="line">		ELSEIF num <span class="operator">&gt;</span> <span class="number">15</span></span><br><span class="line">			<span class="keyword">THEN</span> LEAVE loop_label;</span><br><span class="line">		<span class="keyword">END</span> IF;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SELECT</span> <span class="string">&#x27;尚硅谷：让天下没有难学的技术&#x27;</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">END</span> LOOP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> test_iterate();</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-4-游标"><a href="#4-3-4-游标" class="headerlink" title="4.3.4 游标"></a>4.3.4 游标</h3><h4 id="4-3-4-1-什么是游标（或光标）"><a href="#4-3-4-1-什么是游标（或光标）" class="headerlink" title="4.3.4.1 什么是游标（或光标）"></a>4.3.4.1 什么是游标（或光标）</h4><ul>
<li><p>虽然可以通过筛选条件 WHERE 和 HAVING，或者是限定返回记录的关键字 LIMIT 返回一条记录，但是，却<strong>无法在结果集中像指针一样，向前定位一条记录、向后定位一条记录</strong>，或者是<strong>随意定位到某一条记录</strong>，并对记录的数据进行处理</p>
</li>
<li><p>这个时候，就可以用到游标。游标，提供了一种灵活的操作方式，让我们能够对结果集中的每一条记录进行定位，并对指向的记录中的数据进行操作的数据结构。<strong>游标让 SQL 这种面向集合的语言有了面向过程开发的能力</strong></p>
</li>
<li><p>在 SQL 中，游标是一种临时的数据库对象，可以指向存储在数据库表中的数据行指针。这里游标 <strong>充当了指针的作用</strong>，我们可以通过操作游标来对数据行进行操作</p>
</li>
<li><p>MySQL中游标可以在<strong>存储过程和函数</strong>中使用</p>
</li>
</ul>
<h4 id="4-3-4-2-使用游标步骤"><a href="#4-3-4-2-使用游标步骤" class="headerlink" title="4.3.4.2 使用游标步骤"></a>4.3.4.2 使用游标步骤</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">游标使用的步骤：</span></span><br><span class="line"><span class="comment">① 声明游标</span></span><br><span class="line"><span class="comment">② 打开游标</span></span><br><span class="line"><span class="comment">③ 使用游标（从游标中获取数据）</span></span><br><span class="line"><span class="comment">④ 关闭游标</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>游标必须在声明处理程序之前被声明，并且变量和条件还必须在声明游标或处理程序之前被声明</p>
</li>
<li><p>如果我们想要使用游标，一般需要经历四个步骤。不同的 DBMS 中，使用游标的语法可能略有不同</p>
</li>
<li><p>第一步，<strong>声明游标</strong></p>
<ul>
<li>在MySQL中，使用DECLARE关键字来声明游标，其语法的基本形式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> cursor_name <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> select_statement;</span><br></pre></td></tr></table></figure>

<ul>
<li>这个语法适用于 MySQL，SQL Server，DB2 和 MariaDB。如果是用 Oracle 或者 PostgreSQL，需要写成：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> cursor_name <span class="keyword">CURSOR</span> <span class="keyword">IS</span> select_statement;</span><br></pre></td></tr></table></figure>

<ul>
<li>要使用 SELECT 语句来获取数据结果集，而此时还没有开始遍历数据，这里 select_statement 代表的是 SELECT 语句，返回一个用于创建游标的结果集。<br>比如：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> cur_emp <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line"><span class="keyword">SELECT</span> employee_id,salary <span class="keyword">FROM</span> employees;</span><br><span class="line"><span class="keyword">DECLARE</span> cursor_fruit <span class="keyword">CURSOR</span> <span class="keyword">FOR</span></span><br><span class="line"><span class="keyword">SELECT</span> f_name, f_price <span class="keyword">FROM</span> fruits ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二步，<strong>打开游标</strong></p>
<ul>
<li>打开游标的语法如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">OPEN</span> cursor_name</span><br></pre></td></tr></table></figure>

<ul>
<li>当定义好游标之后，如果想要使用游标，必须先打开游标。打开游标的时候 SELECT 语句的查询结果集就会送到游标工作区，为后面游标的逐条读取 结果集中的记录做准备</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">OPEN</span>	cur_emp ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第三步，<strong>使用游标</strong>（从游标中取得数据）</p>
<ul>
<li>语法如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FETCH</span> cursor_name <span class="keyword">INTO</span> var_name [, var_name] ...</span><br></pre></td></tr></table></figure>

<ul>
<li>这句的作用是使用 cursor_name 这个游标来读取当前行，并且将数据保存到 var_name 这个变量中，游标指针指到下一行。如果游标读取的数据行有多个列名，则在 INTO 关键字后面赋值给多个变量名即可</li>
<li>注意：var_name必须在声明游标之前就定义好</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FETCH</span>	cur_emp <span class="keyword">INTO</span> emp_id, emp_sal ;</span><br></pre></td></tr></table></figure>

<ul>
<li>注意：游标的查询结果集中的字段数，必须跟 INTO 后面的变量数一致，否则，在存储过程执行的时候，MySQL 会提示错误</li>
</ul>
</li>
<li><p>第四步，<strong>关闭游标</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CLOSE</span> cursor_name</span><br></pre></td></tr></table></figure>

<ul>
<li>有OPEN 就会有 CLOSE，也就是打开和关闭游标。使用完游标后需要关闭掉该游标。因为游标会占用系统资源，如果不及时关闭，游标会一直保持到存储过程结束，影响系统运行的效率。而关闭游标的操作，会释放游标占用的系统资源</li>
<li>关闭游标之后就不能再检索查询结果中的数据行，如果需要检索只能再次打开游标。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CLOSE</span>	cur_emp;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="4-3-4-3-举例"><a href="#4-3-4-3-举例" class="headerlink" title="4.3.4.3 举例"></a>4.3.4.3 举例</h4><ul>
<li>创建存储过程“get_count_by_limit_total_salary()”，声明IN参数 limit_total_salary，DOUBLE类型；声明OUT参数total_count，INT类型。函数的功能可以实现累加薪资最高的几个员工的薪资值，直到薪资总和达到limit_total_salary参数的值，返回累加的人数给total_count</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> get_count_by_limit_total_salary(<span class="keyword">IN</span> limit_total_salary <span class="keyword">DOUBLE</span>,<span class="keyword">OUT</span> total_count <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"></span><br><span class="line">	#声明局部变量</span><br><span class="line">	<span class="keyword">DECLARE</span> sum_sal <span class="keyword">DOUBLE</span> <span class="keyword">DEFAULT</span> <span class="number">0.0</span>; #记录累加的工资总额</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_sal <span class="keyword">DOUBLE</span>; #记录每一个员工的工资</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_count <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;#记录累加的人数</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	#<span class="number">1.</span>声明游标</span><br><span class="line">	<span class="keyword">DECLARE</span> emp_cursor <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> salary <span class="keyword">FROM</span> employees <span class="keyword">ORDER</span> <span class="keyword">BY</span> salary <span class="keyword">DESC</span>;</span><br><span class="line">	</span><br><span class="line">	#<span class="number">2.</span>打开游标</span><br><span class="line">	<span class="keyword">OPEN</span> emp_cursor;</span><br><span class="line">	</span><br><span class="line">	REPEAT</span><br><span class="line">		</span><br><span class="line">		#<span class="number">3.</span>使用游标</span><br><span class="line">		<span class="keyword">FETCH</span> emp_cursor <span class="keyword">INTO</span> emp_sal;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SET</span> sum_sal <span class="operator">=</span> sum_sal <span class="operator">+</span> emp_sal;</span><br><span class="line">		<span class="keyword">SET</span> emp_count <span class="operator">=</span> emp_count <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">		UNTIL sum_sal <span class="operator">&gt;=</span> limit_total_salary</span><br><span class="line">	<span class="keyword">END</span> REPEAT;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SET</span> total_count <span class="operator">=</span> emp_count;</span><br><span class="line">	</span><br><span class="line">	#<span class="number">4.</span>关闭游标</span><br><span class="line">	<span class="keyword">CLOSE</span> emp_cursor;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> get_count_by_limit_total_salary(<span class="number">200000</span>,<span class="variable">@total</span>_count);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="variable">@total</span>_count;</span><br></pre></td></tr></table></figure>


<h4 id="4-3-4-4-小结"><a href="#4-3-4-4-小结" class="headerlink" title="4.3.4.4 小结"></a>4.3.4.4 小结</h4><ul>
<li><p>游标是 MySQL 的一个重要的功能，为 <strong>逐条读取</strong> 结果集中的数据，提供了完美的解决方案。跟在应用层面实现相同的功能相比，游标可以在存储程序中使用，效率高，程序也更加简洁</p>
</li>
<li><p>但同时也会带来一些性能问题，比如在使用游标的过程中，会对数据行进行<strong>加锁</strong> ，这样在业务并发量大的时候，不仅会影响业务之间的效率，还会<strong>消耗系统资源</strong> ，造成内存不足，这是因为游标是在内存中进行的处理</p>
</li>
<li><p>建议：养成用完之后就关闭的习惯，这样才能提高系统的整体效率</p>
</li>
</ul>
<h2 id="4-4-触发器"><a href="#4-4-触发器" class="headerlink" title="4.4 触发器"></a>4.4 触发器</h2><h3 id="4-4-1-概述"><a href="#4-4-1-概述" class="headerlink" title="4.4.1 概述"></a>4.4.1 概述</h3><ul>
<li>MySQL从 <strong>5.0.2</strong>  版本开始支持触发器。MySQL的触发器和存储过程一样，都是嵌入到MySQL服务器的一段程序</li>
<li>触发器是由 <strong>事件来触发</strong> 某个操作，这些事件包括 <strong>INSERT 、 UPDATE 、 DELETE</strong> 事件。所谓事件就是指用户的动作或者触发某项行为。如果定义了触发程序，当数据库执行这些语句时候，就相当于事件发生了，就会<strong>自动</strong> 激发触发器执行相应的操作</li>
<li>当对数据表中的数据执行插入、更新和删除操作，需要自动执行一些数据库逻辑时，可以使用触发器来实现</li>
</ul>
<h3 id="4-4-2-创建触发器"><a href="#4-4-2-创建触发器" class="headerlink" title="4.4.2 创建触发器"></a>4.4.2 创建触发器</h3><h4 id="4-4-2-1-创建触发器语法"><a href="#4-4-2-1-创建触发器语法" class="headerlink" title="4.4.2.1 创建触发器语法"></a>4.4.2.1 创建触发器语法</h4><ul>
<li>创建触发器的语法结构是：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> 触发器名称</span><br><span class="line">&#123;BEFORE<span class="operator">|</span>AFTER&#125; &#123;<span class="keyword">INSERT</span><span class="operator">|</span><span class="keyword">UPDATE</span><span class="operator">|</span><span class="keyword">DELETE</span>&#125; <span class="keyword">ON</span> 表名</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line">触发器执行的语句块;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>说明：</p>
<ul>
<li>表名：表示触发器监控的对象</li>
<li>BEFORE|AFTER ：表示触发的时间。BEFORE 表示在事件之前触发；AFTER 表示在事件之后触发</li>
<li>INSERT|UPDATE|DELETE ：表示触发的事件<ul>
<li>1）INSERT 表示插入记录时触发</li>
<li>2）UPDATE 表示更新记录时触发</li>
<li>3）DELETE 表示删除记录时触发</li>
</ul>
</li>
</ul>
<blockquote>
<p>触发器执行的语句块 ：可以是单条SQL语句，也可以是由BEGIN…END结构组成的复合语句块</p>
</blockquote>
</li>
</ul>
<h4 id="4-4-2-2-代码举例"><a href="#4-4-2-2-代码举例" class="headerlink" title="4.4.2.2 代码举例"></a>4.4.2.2 代码举例</h4><ul>
<li><p>举例1：</p>
<ul>
<li><p>1.创建数据表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_trigger (</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">t_note <span class="type">VARCHAR</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_trigger_log (</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">t_log <span class="type">VARCHAR</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.创建触发器：创建名称为before_insert的触发器，向test_trigger数据表插入数据之前，向test_trigger_log数据表中插入before_insert的日志信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> before_insert</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> test_trigger</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_trigger_log (t_log)</span><br><span class="line">    <span class="keyword">VALUES</span>(<span class="string">&#x27;before_insert&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.向test_trigger数据表中插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_trigger (t_note) <span class="keyword">VALUES</span> (<span class="string">&#x27;测试 BEFORE INSERT 触发器&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.查看test_trigger_log数据表中的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span>	test_trigger_log;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+	----+---------------	+</span></span><br><span class="line"><span class="comment">| id |	t_log	|</span></span><br><span class="line"><span class="comment">+	----+---------------	+</span></span><br><span class="line"><span class="comment">|	1 |	before_insert	|</span></span><br><span class="line"><span class="comment">+	----+---------------	+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>举例2：</p>
<ul>
<li><p>1.创建名称为after_insert的触发器，向test_trigger数据表插入数据之后，向test_trigger_log数据表中插入after_insert的日志信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> after_insert</span><br><span class="line">AFTER <span class="keyword">INSERT</span> <span class="keyword">ON</span> test_trigger</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_trigger_log (t_log)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="string">&#x27;after_insert&#x27;</span>);</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.向test_trigger数据表中插入数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_trigger (t_note) <span class="keyword">VALUES</span> (<span class="string">&#x27;测试 AFTER INSERT 触发器&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.查看test_trigger_log数据表中的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test_trigger_log;</span><br><span class="line"><span class="comment">/*+	----	+---------------	+</span></span><br><span class="line"><span class="comment">| id |	t_log	|</span></span><br><span class="line"><span class="comment">+	----	+---------------	+</span></span><br><span class="line"><span class="comment">|	1	|	before_insert |</span></span><br><span class="line"><span class="comment">|	2	|	before_insert |</span></span><br><span class="line"><span class="comment">|	3	|	after_insert	|</span></span><br><span class="line"><span class="comment">+	----	+---------------	+*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>举例3：定义触发器“salary_check_trigger”，基于员工表“employees”的INSERT事件，在INSERT之前检查将要添加的新员工薪资是否大于他领导的薪资，如果大于领导薪资，则报sqlstate_value为’HY000’的错误，从而使得添加失败</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">#准备工作</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employees</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> atguigudb.`employees`;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> departments</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> atguigudb.`departments`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"></span><br><span class="line">#创建触发器</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> salary_check_trigger</span><br><span class="line">BEFORE <span class="keyword">INSERT</span> <span class="keyword">ON</span> employees</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	#查询到要添加的数据的manager的薪资</span><br><span class="line">	<span class="keyword">DECLARE</span> mgr_sal <span class="keyword">DOUBLE</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">SELECT</span> salary <span class="keyword">INTO</span> mgr_sal <span class="keyword">FROM</span> employees </span><br><span class="line">	<span class="keyword">WHERE</span> employee_id <span class="operator">=</span> NEW.manager_id;</span><br><span class="line">	</span><br><span class="line">	IF NEW.salary <span class="operator">&gt;</span> mgr_sal</span><br><span class="line">		<span class="keyword">THEN</span> SIGNAL <span class="keyword">SQLSTATE</span> <span class="string">&#x27;HY000&#x27;</span> <span class="keyword">SET</span> MESSAGE_TEXT <span class="operator">=</span> <span class="string">&#x27;薪资高于领导薪资错误&#x27;</span>;</span><br><span class="line">	<span class="keyword">END</span> IF;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#测试</span><br><span class="line"><span class="keyword">DESC</span> employees;</span><br><span class="line"></span><br><span class="line">#添加成功：依然触发了触发器salary_check_trigger的执行</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees(employee_id,last_name,email,hire_date,job_id,salary,manager_id)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">300</span>,<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&#x27;tom@126.com&#x27;</span>,CURDATE(),<span class="string">&#x27;AD_VP&#x27;</span>,<span class="number">8000</span>,<span class="number">103</span>);</span><br><span class="line"></span><br><span class="line">#添加失败</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees(employee_id,last_name,email,hire_date,job_id,salary,manager_id)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">301</span>,<span class="string">&#x27;Tom1&#x27;</span>,<span class="string">&#x27;tom1@126.com&#x27;</span>,CURDATE(),<span class="string">&#x27;AD_VP&#x27;</span>,<span class="number">10000</span>,<span class="number">103</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employees;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面触发器声明过程中的NEW关键字代表INSERT添加语句的新记录</p>
</blockquote>
<h3 id="4-4-3-查看、删除触发器"><a href="#4-4-3-查看、删除触发器" class="headerlink" title="4.4.3 查看、删除触发器"></a>4.4.3 查看、删除触发器</h3><h4 id="4-4-3-1-查看触发器"><a href="#4-4-3-1-查看触发器" class="headerlink" title="4.4.3.1 查看触发器"></a>4.4.3.1 查看触发器</h4><ul>
<li>查看触发器是查看数据库中已经存在的触发器的定义、状态和语法信息等</li>
<li>方式1：查看当前数据库的所有触发器的定义</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TRIGGERS\G</span><br></pre></td></tr></table></figure>

<ul>
<li>方式2：查看当前数据库中某个触发器的定义</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> 触发器名</span><br></pre></td></tr></table></figure>

<ul>
<li>方式3：从系统库information_schema的TRIGGERS表中查询“salary_check_trigger”触发器的信息。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.TRIGGERS;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-3-2-删除触发器"><a href="#4-4-3-2-删除触发器" class="headerlink" title="4.4.3.2 删除触发器"></a>4.4.3.2 删除触发器</h4><ul>
<li>触发器也是数据库对象，删除触发器也用DROP语句，语法格式如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span>	IF <span class="keyword">EXISTS</span> 触发器名称;</span><br></pre></td></tr></table></figure>

<h3 id="4-4-4-触发器的优缺点"><a href="#4-4-4-触发器的优缺点" class="headerlink" title="4.4.4 触发器的优缺点"></a>4.4.4 触发器的优缺点</h3><h4 id="4-4-4-1-优点"><a href="#4-4-4-1-优点" class="headerlink" title="4.4.4.1 优点"></a>4.4.4.1 优点</h4><ul>
<li>触发器可以确保数据的完整性</li>
<li>触发器可以帮助我们记录操作日志</li>
<li>触发器还可以用在操作数据前，对数据进行合法性检查</li>
</ul>
<h4 id="4-4-4-2-缺点"><a href="#4-4-4-2-缺点" class="headerlink" title="4.4.4.2 缺点"></a>4.4.4.2 缺点</h4><ul>
<li>触发器最大的一个问题就是可读性差</li>
<li>相关数据的变更，可能会导致触发器出错</li>
</ul>
<h1 id="5-MySQL8新特性"><a href="#5-MySQL8新特性" class="headerlink" title="5.MySQL8新特性"></a>5.MySQL8新特性</h1><h1 id="6-MySQL架构"><a href="#6-MySQL架构" class="headerlink" title="6.MySQL架构"></a>6.MySQL架构</h1><h2 id="6-1-Linux下MySQL的安装和使用"><a href="#6-1-Linux下MySQL的安装和使用" class="headerlink" title="6.1 Linux下MySQL的安装和使用"></a>6.1 Linux下MySQL的安装和使用</h2><h3 id="6-1-1-卸载MySQL"><a href="#6-1-1-卸载MySQL" class="headerlink" title="6.1.1 卸载MySQL"></a>6.1.1 卸载MySQL</h3><blockquote>
<p>查看MySQL安装版本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysqladmin --version</span></span><br><span class="line">mysqladmin  Ver 8.42 Distrib 5.7.39, <span class="keyword">for</span> Linux on x86_64</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql --version</span></span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.39, <span class="keyword">for</span> Linux (x86_64) using  EditLine wrapper</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看系统是否安装了MySQL</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql57-community-release-el7-10.noarch</span><br><span class="line">mysql-community-client-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.39-1.el7.x86_64</span><br><span class="line">perl-DBD-MySQL-4.023-6.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-compat-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.39-1.el7.x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum list installed | grep mysql</span></span><br><span class="line">Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast</span><br><span class="line">mysql-community-client.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-common.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-libs.x86_64                 5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-libs-compat.x86_64          5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-server.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql57-community-release.noarch            el7-10                     @/mysql57-community-release-el7-10.noarch</span><br></pre></td></tr></table></figure>

<blockquote>
<p>查看MySQL服务运行状态，关闭MySQL服务</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl status mysqld</span></span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2022-11-10 16:55:19 CST; 31min ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 1888 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class="variable">$MYSQLD_OPTS</span> (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1866 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1891 (mysqld)</span><br><span class="line">    Tasks: 28</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─1891 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: mysqld.service holdoff time over, scheduling restart.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Stopped MySQL Server.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Starting MySQL Server...</span><br><span class="line">11月 10 16:55:19 localhost.localdomain systemd[1]: Started MySQL Server.</span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl stop mysqld</span></span><br><span class="line">[root@localhost ~]<span class="comment"># systemctl status mysqld.service</span></span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead) since 四 2022-11-10 17:32:47 CST; 1min 39s ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 1888 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class="variable">$MYSQLD_OPTS</span> (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 1866 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1891 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: mysqld.service holdoff time over, scheduling restart.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Stopped MySQL Server.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Starting MySQL Server...</span><br><span class="line">11月 10 16:55:19 localhost.localdomain systemd[1]: Started MySQL Server.</span><br><span class="line">11月 10 17:32:46 localhost.localdomain systemd[1]: Stopping MySQL Server...</span><br><span class="line">11月 10 17:32:47 localhost.localdomain systemd[1]: Stopped MySQL Server.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>卸载</p>
</blockquote>
<ul>
<li>执行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove mysql-xxx mysql-xxx mysql-xxx ...</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>反复执行：确认是否有卸载残留</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep -i mysql</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum list installed | grep mysql</span></span><br><span class="line">Repodata is over 2 weeks old. Install yum-cron? Or run: yum makecache fast</span><br><span class="line">mysql-community-client.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-common.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-libs.x86_64                 5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-libs-compat.x86_64          5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql-community-server.x86_64               5.7.39-1.el7               @mysql57-community</span><br><span class="line">mysql57-community-release.noarch            el7-10                     @/mysql57-community-release-el7-10.noarch</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql57-community-release-el7-10.noarch</span><br><span class="line">mysql-community-client-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.39-1.el7.x86_64</span><br><span class="line">perl-DBD-MySQL-4.023-6.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-compat-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.39-1.el7.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># yum remove mysql57-community-release-el7-10.noarch</span></span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql57-community-release.noarch.0.el7-10 将被 删除</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line">base/7/x86_64                                                                                                                                                                                                                            | 3.6 kB  00:00:00     </span><br><span class="line">extras/7/x86_64                                                                                                                                                                                                                          | 2.9 kB  00:00:00     </span><br><span class="line">mysql-connectors-community/x86_64                                                                                                                                                                                                        | 2.6 kB  00:00:00     </span><br><span class="line">mysql-tools-community/x86_64                                                                                                                                                                                                             | 2.6 kB  00:00:00     </span><br><span class="line">mysql57-community/x86_64                                                                                                                                                                                                                 | 2.6 kB  00:00:00     </span><br><span class="line">updates/7/x86_64                                                                                                                                                                                                                         | 2.9 kB  00:00:00     </span><br><span class="line">updates/7/x86_64/primary_db                                                                                                                                                                                                              |  17 MB  00:00:17     </span><br><span class="line"></span><br><span class="line">依赖关系解决</span><br><span class="line"></span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                            架构                                            版本                                               源                                                                                  大小</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">正在删除:</span><br><span class="line"> mysql57-community-release                                          noarch                                          el7-10                                             @/mysql57-community-release-el7-10.noarch                                           30 k</span><br><span class="line"></span><br><span class="line">事务概要</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">移除  1 软件包</span><br><span class="line"></span><br><span class="line">安装大小：30 k</span><br><span class="line">是否继续？[y/N]：y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在删除    : mysql57-community-release-el7-10.noarch                                                                                                                                                                                                     1/1 </span><br><span class="line">  验证中      : mysql57-community-release-el7-10.noarch                                                                                                                                                                                                     1/1 </span><br><span class="line"></span><br><span class="line">删除:</span><br><span class="line">  mysql57-community-release.noarch 0:el7-10                                                                                                                                                                                                                     </span><br><span class="line"></span><br><span class="line">完毕！</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql-community-client-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.39-1.el7.x86_64</span><br><span class="line">perl-DBD-MySQL-4.023-6.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-compat-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.39-1.el7.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># yum remove mysql-community-libs-compat-5.7.39-1.el7.x86_64</span></span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql-community-libs-compat.x86_64.0.5.7.39-1.el7 将被 删除</span><br><span class="line">--&gt; 正在处理依赖关系 libmysqlclient.so.18()(64bit)，它被软件包 perl-DBD-MySQL-4.023-6.el7.x86_64 需要</span><br><span class="line">--&gt; 正在处理依赖关系 libmysqlclient.so.18()(64bit)，它被软件包 2:postfix-2.10.1-9.el7.x86_64 需要</span><br><span class="line">--&gt; 正在处理依赖关系 libmysqlclient.so.18(libmysqlclient_18)(64bit)，它被软件包 perl-DBD-MySQL-4.023-6.el7.x86_64 需要</span><br><span class="line">--&gt; 正在处理依赖关系 libmysqlclient.so.18(libmysqlclient_18)(64bit)，它被软件包 2:postfix-2.10.1-9.el7.x86_64 需要</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 perl-DBD-MySQL.x86_64.0.4.023-6.el7 将被 删除</span><br><span class="line">---&gt; 软件包 postfix.x86_64.2.2.10.1-9.el7 将被 删除</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line"></span><br><span class="line">依赖关系解决</span><br><span class="line"></span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                                  架构                                                版本                                                        源                                                               大小</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">正在删除:</span><br><span class="line"> mysql-community-libs-compat                                              x86_64                                              5.7.39-1.el7                                                @mysql57-community                                              5.9 M</span><br><span class="line">为依赖而移除:</span><br><span class="line"> perl-DBD-MySQL                                                           x86_64                                              4.023-6.el7                                                 @base                                                           323 k</span><br><span class="line"> postfix                                                                  x86_64                                              2:2.10.1-9.el7                                              @anaconda                                                        12 M</span><br><span class="line"></span><br><span class="line">事务概要</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">移除  1 软件包 (+2 依赖软件包)</span><br><span class="line"></span><br><span class="line">安装大小：18 M</span><br><span class="line">是否继续？[y/N]：y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在删除    : 2:postfix-2.10.1-9.el7.x86_64                                                                                                                                                                                                               1/3 </span><br><span class="line">  正在删除    : perl-DBD-MySQL-4.023-6.el7.x86_64                                                                                                                                                                                                           2/3 </span><br><span class="line">  正在删除    : mysql-community-libs-compat-5.7.39-1.el7.x86_64                                                                                                                                                                                             3/3 </span><br><span class="line">  验证中      : mysql-community-libs-compat-5.7.39-1.el7.x86_64                                                                                                                                                                                             1/3 </span><br><span class="line">  验证中      : perl-DBD-MySQL-4.023-6.el7.x86_64                                                                                                                                                                                                           2/3 </span><br><span class="line">  验证中      : 2:postfix-2.10.1-9.el7.x86_64                                                                                                                                                                                                               3/3 </span><br><span class="line"></span><br><span class="line">删除:</span><br><span class="line">  mysql-community-libs-compat.x86_64 0:5.7.39-1.el7                                                                                                                                                                                                             </span><br><span class="line"></span><br><span class="line">作为依赖被删除:</span><br><span class="line">  perl-DBD-MySQL.x86_64 0:4.023-6.el7                                                                                               postfix.x86_64 2:2.10.1-9.el7                                                                                              </span><br><span class="line"></span><br><span class="line">完毕！</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql-community-client-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-server-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.39-1.el7.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># yum remove mysql-community-client-5.7.39-1.el7.x86_64</span></span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql-community-client.x86_64.0.5.7.39-1.el7 将被 删除</span><br><span class="line">--&gt; 正在处理依赖关系 mysql-community-client(x86-64) &gt;= 5.7.9，它被软件包 mysql-community-server-5.7.39-1.el7.x86_64 需要</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql-community-server.x86_64.0.5.7.39-1.el7 将被 删除</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line"></span><br><span class="line">依赖关系解决</span><br><span class="line"></span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                              架构                                                 版本                                                          源                                                                大小</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">正在删除:</span><br><span class="line"> mysql-community-client                                               x86_64                                               5.7.39-1.el7                                                  @mysql57-community                                               107 M</span><br><span class="line">为依赖而移除:</span><br><span class="line"> mysql-community-server                                               x86_64                                               5.7.39-1.el7                                                  @mysql57-community                                               773 M</span><br><span class="line"></span><br><span class="line">事务概要</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">移除  1 软件包 (+1 依赖软件包)</span><br><span class="line"></span><br><span class="line">安装大小：879 M</span><br><span class="line">是否继续？[y/N]：y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在删除    : mysql-community-server-5.7.39-1.el7.x86_64                                                                                                                                                                                                  1/2 </span><br><span class="line">  正在删除    : mysql-community-client-5.7.39-1.el7.x86_64                                                                                                                                                                                                  2/2 </span><br><span class="line">  验证中      : mysql-community-client-5.7.39-1.el7.x86_64                                                                                                                                                                                                  1/2 </span><br><span class="line">  验证中      : mysql-community-server-5.7.39-1.el7.x86_64                                                                                                                                                                                                  2/2 </span><br><span class="line"></span><br><span class="line">删除:</span><br><span class="line">  mysql-community-client.x86_64 0:5.7.39-1.el7                                                                                                                                                                                                                  </span><br><span class="line"></span><br><span class="line">作为依赖被删除:</span><br><span class="line">  mysql-community-server.x86_64 0:5.7.39-1.el7                                                                                                                                                                                                                  </span><br><span class="line"></span><br><span class="line">完毕！</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.39-1.el7.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># yum remove mysql-community-libs-5.7.39-1.el7.x86_64</span></span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql-community-libs.x86_64.0.5.7.39-1.el7 将被 删除</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line"></span><br><span class="line">依赖关系解决</span><br><span class="line"></span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                             架构                                                  版本                                                         源                                                                 大小</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">正在删除:</span><br><span class="line"> mysql-community-libs                                                x86_64                                                5.7.39-1.el7                                                 @mysql57-community                                                 10 M</span><br><span class="line"></span><br><span class="line">事务概要</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">移除  1 软件包</span><br><span class="line"></span><br><span class="line">安装大小：10 M</span><br><span class="line">是否继续？[y/N]：y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在删除    : mysql-community-libs-5.7.39-1.el7.x86_64                                                                                                                                                                                                    1/1 </span><br><span class="line">  验证中      : mysql-community-libs-5.7.39-1.el7.x86_64                                                                                                                                                                                                    1/1 </span><br><span class="line"></span><br><span class="line">删除:</span><br><span class="line">  mysql-community-libs.x86_64 0:5.7.39-1.el7                                                                                                                                                                                                                    </span><br><span class="line"></span><br><span class="line">完毕！</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">mysql-community-common-5.7.39-1.el7.x86_64</span><br><span class="line">[root@localhost ~]<span class="comment"># yum remove mysql-community-common-5.7.39-1.el7.x86_64</span></span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">正在解决依赖关系</span><br><span class="line">--&gt; 正在检查事务</span><br><span class="line">---&gt; 软件包 mysql-community-common.x86_64.0.5.7.39-1.el7 将被 删除</span><br><span class="line">--&gt; 解决依赖关系完成</span><br><span class="line"></span><br><span class="line">依赖关系解决</span><br><span class="line"></span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line"> Package                                                              架构                                                 版本                                                          源                                                                大小</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">正在删除:</span><br><span class="line"> mysql-community-common                                               x86_64                                               5.7.39-1.el7                                                  @mysql57-community                                               2.8 M</span><br><span class="line"></span><br><span class="line">事务概要</span><br><span class="line">================================================================================================================================================================================================================================================================</span><br><span class="line">移除  1 软件包</span><br><span class="line"></span><br><span class="line">安装大小：2.8 M</span><br><span class="line">是否继续？[y/N]：y</span><br><span class="line">Downloading packages:</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">  正在删除    : mysql-community-common-5.7.39-1.el7.x86_64                                                                                                                                                                                                  1/1 </span><br><span class="line">  验证中      : mysql-community-common-5.7.39-1.el7.x86_64                                                                                                                                                                                                  1/1 </span><br><span class="line"></span><br><span class="line">删除:</span><br><span class="line">  mysql-community-common.x86_64 0:5.7.39-1.el7                                                                                                                                                                                                                  </span><br><span class="line"></span><br><span class="line">完毕！</span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -qa | grep -i mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum list installed | grep mysql</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除MySQL相关文件</p>
</blockquote>
<ul>
<li>查找相关文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name mysql</span><br></pre></td></tr></table></figure>

<ul>
<li>删除找出的相关文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf xxx</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># find / -name mysql</span></span><br><span class="line">/etc/selinux/targeted/active/modules/100/mysql</span><br><span class="line">/etc/selinux/targeted/tmp/modules/100/mysql</span><br><span class="line">/var/lib/mysql</span><br><span class="line">/var/lib/mysql/mysql</span><br><span class="line">/usr/share/mysql</span><br><span class="line">[root@localhost ~]<span class="comment"># rm -rf /etc/selinux/targeted/active/modules/100/mysql /etc/selinux/targeted/tmp/modules/100/mysql /var/lib/mysql /usr/share/mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># find / -name mysql</span></span><br><span class="line">[root@localhost ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>删除my.cnf(相当于Windows下的my.ini)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /etc/my.cnf</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># rm -rf /etc/my.cnf</span></span><br><span class="line">[root@localhost ~]<span class="comment"># find /etc -name my.cnf</span></span><br><span class="line">[root@localhost ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>检测</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql --version</span></span><br><span class="line">-bash: /usr/bin/mysql: 没有那个文件或目录</span><br><span class="line">[root@localhost ~]<span class="comment"># mysqladmin --version</span></span><br><span class="line">-bash: /usr/bin/mysqladmin: 没有那个文件或目录</span><br></pre></td></tr></table></figure>

<h3 id="6-1-2-安装MySQL5-7"><a href="#6-1-2-安装MySQL5-7" class="headerlink" title="6.1.2 安装MySQL5.7"></a>6.1.2 安装MySQL5.7</h3><blockquote>
<p>MySQL四大版本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MySQL Community Server 社区版本，开源免费，自由下载，但不提供官方技术支持，适用于大多数普通用户</span><br><span class="line">MySQL Enterprise Edition 企业版本，需付费，不能在线下载，可以试用30天。提供了更多的功能和更完 备的技术支持，更适合于对数据库的功能和可靠性要求较高的企业客户</span><br><span class="line">MySQL Cluster 集群版，开源免费。用于架设集群服务器，可将几个MySQL Server封装成一个Server。需要在社区版或企业版的基础上使用</span><br><span class="line">MySQL Cluster CGE高级集群版，需付费</span><br></pre></td></tr></table></figure>

<ul>
<li>官方还提供了 MySQL Workbench (GUITOOL)一款专为MySQL设计的ER&#x2F;数据库建模工具。它是著名的数据库设计工具DBDesigner4的继任者。MySQLWorkbench又分为两个版本，分别是社区版(MySQL Workbench OSS)、商用版(MySQLWorkbenchSE)</li>
</ul>
<blockquote>
<p>下载</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.mysql.com/downloads/">https://www.mysql.com/downloads/</a></p>
<p><img src="image-20221110211904104-16680863687081.png" alt="MySQL之性能优化/image-20221110211904104"></p>
<p><img src="image-20221110211933295.png" alt="MySQL之性能优化/image-20221110211933295"></p>
<p><img src="image-20221110212037886.png" alt="MySQL之性能优化/image-20221110212037886"></p>
<p><img src="image-20221110212243970.png" alt="MySQL之性能优化/image-20221110212243970"></p>
<p><img src="image-20221110212418063.png" alt="MySQL之性能优化/image-20221110212418063"></p>
<blockquote>
<p>解压</p>
</blockquote>
<p><img src="image-20221110212904697.png" alt="MySQL之性能优化/image-20221110212904697"></p>
<blockquote>
<p>抽取部分压缩包上传到Linux环境下</p>
</blockquote>
<p><img src="image-20221110213106043.png" alt="MySQL之性能优化/image-20221110213106043"></p>
<p><img src="image-20221110213334534.png" alt="MySQL之性能优化/image-20221110213334534"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># ll</span></span><br><span class="line">总用量 194480</span><br><span class="line">-rw-r--r--. 1 root root  25085192 11月 10 21:33 mysql-community-client-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--. 1 root root    278292 11月 10 21:33 mysql-community-common-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--. 1 root root   2238032 11月 10 21:33 mysql-community-libs-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--. 1 root root 171537176 11月 10 21:33 mysql-community-server-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">drwxr-xr-x. 2 root root         6 10月 31 2018 rh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Linux系统下安装软件的常用三种方式</p>
</blockquote>
<ul>
<li><strong>方式1:rpm命令</strong></li>
</ul>
<p>​     使用rpm命令安装扩展名为”.rpm”的软件包</p>
<p>​     .rpm包的一般格式:</p>
<p><img src="image-20221110214004910.png" alt="MySQL之性能优化/image-20221110214004910"></p>
<ul>
<li><p><strong>方式2:yum命令</strong><br>需联网，从<strong>互联网获取</strong>的yum源，直接使用yum命令安装</p>
</li>
<li><p><strong>方式3:编译安装源码包</strong><br>针对<strong>tar.gz</strong>这样的压缩格式，要用tar命令来解压;如果是其它压缩格式，就使用其它命令</p>
</li>
</ul>
<blockquote>
<p>Linux系统下安装MySQL，官方给出多种方式</p>
</blockquote>
<table>
<thead>
<tr>
<th>安装方式</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>rpm</td>
<td>安装简单，灵活性差，无法灵活选择版本、升级</td>
</tr>
<tr>
<td>rpm repository</td>
<td>安装包极小，版本安装简单灵活，升级方便，需要联网</td>
</tr>
<tr>
<td>通用二进制包</td>
<td>安装比较复杂，灵活性高，平台通用性好</td>
</tr>
<tr>
<td>源码包</td>
<td>安装复杂，时间长，参数设置灵活，性能好</td>
</tr>
</tbody></table>
<blockquote>
<p>CentOS7 下检查MySQL依赖</p>
</blockquote>
<ul>
<li><p>1.检查&#x2F;tmp临时目录权限（必不可少）</p>
<ul>
<li><p>由于mysql安装过程中，会通过mysql用户在&#x2F;tmp目录下新建tmp_db文件，所以请给&#x2F;tmp较大的权限。执<br>行 ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 /tmp</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>2.安装前，检查依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># rpm -qa|grep libaio</span></span><br><span class="line">libaio-0.3.109-13.el7.x86_64</span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qa|grep net-tools</span></span><br><span class="line">net-tools-2.0-0.25.20131004git.el7.x86_64</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>安装</p>
</blockquote>
<ul>
<li>在mysql的安装文件目录下执行：（<em><strong>必须按照逐句顺序执行</strong></em>）不要省事一次性粘贴</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh mysql-community-common-5.7.19-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh mysql-community-libs-5.7.19-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh mysql-community-client-5.7.19-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh mysql-community-server-5.7.19-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<ul>
<li><p><em><strong>注意: 如在检查工作时，没有检查mysql依赖环境在安装mysql-community-server会报错</strong></em></p>
</li>
<li><p>&#96;&#96;&#96;bash<br>rpm 是Redhat Package Manage缩写，通过RPM的管理，用户可以把源代码包装成以rpm为扩展名的<br>文件形式，易于安装。<br>-i , –install 安装软件包<br>-v , –verbose 提供更多的详细信息输出<br>-h , –hash 软件包安装的时候列出哈希标记 (和 -v 一起使用效果更好)，展示进度条</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 安装</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">  [root@localhost /]# cd /opt</span><br><span class="line">  [root@localhost opt]# rpm -ivh mysql-community-common-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">  准备中...                          ################################# [100%]</span><br><span class="line">  正在升级/安装...</span><br><span class="line">     1:mysql-community-common-5.7.19-1.e################################# [100%]</span><br><span class="line">  [root@localhost opt]# rpm -ivh mysql-community-libs-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">  准备中...                          ################################# [100%]</span><br><span class="line">  正在升级/安装...</span><br><span class="line">     1:mysql-community-libs-5.7.19-1.el7################################# [100%]</span><br><span class="line">  [root@localhost opt]# rpm -ivh mysql-community-client-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">  准备中...                          ################################# [100%]</span><br><span class="line">  正在升级/安装...</span><br><span class="line">     1:mysql-community-client-5.7.19-1.e################################# [100%]</span><br><span class="line">  [root@localhost opt]# rpm -ivh mysql-community-server-5.7.19-1.el7.x86_64.rpm</span><br><span class="line">  准备中...                          ################################# [100%]</span><br><span class="line">  正在升级/安装...</span><br><span class="line">     1:mysql-community-server-5.7.19-1.e################################# [100%]</span><br><span class="line">  [root@localhost opt]# </span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>查看MySQL版本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># mysqladmin --version</span></span><br><span class="line">mysqladmin  Ver 8.42 Distrib 5.7.19, <span class="keyword">for</span> Linux on x86_64</span><br><span class="line">[root@localhost opt]<span class="comment"># mysql --version</span></span><br><span class="line">mysql  Ver 14.14 Distrib 5.7.19, <span class="keyword">for</span> Linux (x86_64) using  EditLine wrapper</span><br></pre></td></tr></table></figure>

<ul>
<li><p>执行如下命令，查看是否安装成功。需要增加 -i 不用去区分大小写，否则搜索不到</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># rpm -qa|grep -i mysql</span></span><br><span class="line">mysql-community-server-5.7.19-1.el7.x86_64</span><br><span class="line">mysql-community-common-5.7.19-1.el7.x86_64</span><br><span class="line">mysql-community-libs-5.7.19-1.el7.x86_64</span><br><span class="line">mysql-community-client-5.7.19-1.el7.x86_64</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>MySQL服务初始化</p>
</blockquote>
<ul>
<li>为了保证数据库目录与文件的所有者为 mysql 登录用户，如果你是以 root 身份运行 mysql 服务，需要执行下面的命令初始化：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># mysqld --initialize --user=mysql</span></span><br><span class="line">[root@localhost opt]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>说明： –initialize 选项默认以“安全”模式来初始化，则会为 root 用户生成一个密码并将 该密码标记为过期 ，登录后你需要设置一个新的密码。生成的 临时密码 会往日志中记录一份</p>
</li>
<li><p><strong>查看密码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># cat /var/log/mysqld.log</span></span><br><span class="line">2022-11-10T14:06:55.884869Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2022-11-10T14:06:56.267702Z 0 [Warning] InnoDB: New <span class="built_in">log</span> files created, LSN=45790</span><br><span class="line">2022-11-10T14:06:56.311589Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2022-11-10T14:06:56.375337Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: ef764432-6100-11ed-9e29-000c299f788e.</span><br><span class="line">2022-11-10T14:06:56.376702Z 0 [Warning] Gtid table is not ready to be used. Table <span class="string">&#x27;mysql.gtid_executed&#x27;</span> cannot be opened.</span><br><span class="line">2022-11-10T14:06:56.378537Z 1 [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: 5/OXpbmkAU1P</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>启动MySQL</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#加不加.service后缀都可以</span></span><br><span class="line"></span><br><span class="line">启动：systemctl start mysqld.service</span><br><span class="line"></span><br><span class="line">关闭：systemctl stop mysqld.service</span><br><span class="line"></span><br><span class="line">重启：systemctl restart mysqld.service</span><br><span class="line"></span><br><span class="line">查看状态：systemctl status mysqld.service</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># systemctl status mysqld.service</span></span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line"></span><br><span class="line">11月 10 16:55:16 localhost.localdomain systemd[1]: mysqld.service: control process exited, code=exited status=1</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Failed to start MySQL Server.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Unit mysqld.service entered failed state.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: mysqld.service failed.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: mysqld.service holdoff time over, scheduling restart.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Stopped MySQL Server.</span><br><span class="line">11月 10 16:55:18 localhost.localdomain systemd[1]: Starting MySQL Server...</span><br><span class="line">11月 10 16:55:19 localhost.localdomain systemd[1]: Started MySQL Server.</span><br><span class="line">11月 10 17:32:46 localhost.localdomain systemd[1]: Stopping MySQL Server...</span><br><span class="line">11月 10 17:32:47 localhost.localdomain systemd[1]: Stopped MySQL Server.</span><br><span class="line">[root@localhost opt]<span class="comment"># systemctl start mysqld.service</span></span><br><span class="line">[root@localhost opt]<span class="comment"># systemctl status mysqld.service</span></span><br><span class="line">● mysqld.service - MySQL Server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since 四 2022-11-10 22:19:43 CST; 3s ago</span><br><span class="line">     Docs: man:mysqld(8)</span><br><span class="line">           http://dev.mysql.com/doc/refman/en/using-systemd.html</span><br><span class="line">  Process: 21077 ExecStart=/usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid <span class="variable">$MYSQLD_OPTS</span> (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 21054 ExecStartPre=/usr/bin/mysqld_pre_systemd (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 21080 (mysqld)</span><br><span class="line">    Tasks: 27</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─21080 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">11月 10 22:19:40 localhost.localdomain systemd[1]: Starting MySQL Server...</span><br><span class="line">11月 10 22:19:43 localhost.localdomain systemd[1]: Started MySQL Server.</span><br><span class="line">[root@localhost opt]<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># ps -ef | grep -i mysql</span></span><br><span class="line">mysql     21080      1  0 22:19 ?        00:00:00 /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line">root      21183   1995  0 22:20 pts/0    00:00:00 grep --color=auto -i mysql</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>查看MySQL服务是否自启动</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# systemctl list-unit-files|grep mysqld.service</span><br><span class="line">mysqld.service                                enabled </span><br></pre></td></tr></table></figure>

<ul>
<li>如不是enabled可以运行如下命令设置自启动</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mysqld.service</span><br></pre></td></tr></table></figure>

<ul>
<li>如果希望不进行自启动，运行如下命令设置</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable mysqld.service</span><br></pre></td></tr></table></figure>

<blockquote>
<p>MySQL登录</p>
</blockquote>
<ul>
<li><p>初次登陆：通过 mysql -uroot -p 进行登录，在Enter password：录入初始化密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 3</span><br><span class="line">Server version: 5.7.19</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">ERROR 1820 (HY000): You must reset your password using ALTER USER statement before executing this statement.</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改密码：<strong>因为初始化密码默认是过期的</strong>，所以查看数据库会报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified by <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>用新密码再次登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">exit</span>;</span><br><span class="line">Bye</span><br><span class="line">[root@localhost opt]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 4</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>SQLyog实现MySQL5.7的远程连接</p>
</blockquote>
<ul>
<li><p>1.当前问题：使用sqlyog远程连接MySQL数据库会报错，这是由于MySQL配置了不支持远程连接引起的</p>
<p><img src="image-20221110231237263.png" alt="MySQL之性能优化/image-20221110231237263"></p>
<p><img src="image-20221110232354941.png" alt="MySQL之性能优化/image-20221110232354941"></p>
</li>
<li><p>2.确认网络</p>
<ul>
<li><p>在远程机器上使用ping ip地址<strong>保证网络畅通</strong></p>
<p><img src="image-20221110231605795.png" alt="MySQL之性能优化/image-20221110231605795"></p>
</li>
<li><p>在远程机器上使用telnet命令<strong>保证端口号开放访问</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">telnet ip地址 端口号</span><br></pre></td></tr></table></figure>

<p><img src="image-20221110231909383.png" alt="MySQL之性能优化/image-20221110231909383"></p>
<p><img src="image-20221110232016329.png" alt="MySQL之性能优化/image-20221110232016329"></p>
</li>
<li><p>关闭远程机器防火墙，或者放行3306端口号</p>
<ul>
<li><p>方式一：关闭防火墙</p>
<p><img src="image-20221110233004330.png" alt="MySQL之性能优化/image-20221110233004330"></p>
</li>
<li><p>方式二：开放端口</p>
<p><img src="image-20221111125950470.png" alt="MySQL之性能优化/image-20221111125950470"></p>
<p><img src="image-20221111130108956.png" alt="MySQL之性能优化/image-20221111130108956"></p>
<p><img src="image-20221111130140046.png" alt="MySQL之性能优化/image-20221111130140046"></p>
<p><img src="image-20221111130217820.png" alt="MySQL之性能优化/image-20221111130217820"></p>
<p><img src="image-20221111130338316.png" alt="MySQL之性能优化/image-20221111130338316"></p>
<p><img src="image-20221111130408341.png" alt="MySQL之性能优化/image-20221111130408341"></p>
</li>
</ul>
</li>
<li><p>关闭本地防火墙，或者放行3306端口号</p>
<ul>
<li><p>检测防火墙状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since 四 2022-11-10 16:55:04 CST; 6h ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line"> Main PID: 834 (firewalld)</span><br><span class="line">    Tasks: 2</span><br><span class="line">   CGroup: /system.slice/firewalld.service</span><br><span class="line">           └─834 /usr/bin/python2 -Es /usr/sbin/firewalld --nofork --nopid</span><br><span class="line"></span><br><span class="line">11月 10 16:55:03 localhost.localdomain systemd[1]: Starting firewalld - dynamic firewall daemon...</span><br><span class="line">11月 10 16:55:04 localhost.localdomain systemd[1]: Started firewalld - dynamic firewall daemon.</span><br><span class="line">11月 10 16:55:05 localhost.localdomain firewalld[834]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed <span class="keyword">in</span> a future release. Please consider disabling it now.</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># systemctl stop firewalld</span></span><br><span class="line">[root@localhost opt]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead) since 四 2022-11-10 23:35:31 CST; 2s ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line">  Process: 834 ExecStart=/usr/sbin/firewalld --nofork --nopid <span class="variable">$FIREWALLD_ARGS</span> (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 834 (code=exited, status=0/SUCCESS)</span><br><span class="line"></span><br><span class="line">11月 10 16:55:03 localhost.localdomain systemd[1]: Starting firewalld - dynamic firewall daemon...</span><br><span class="line">11月 10 16:55:04 localhost.localdomain systemd[1]: Started firewalld - dynamic firewall daemon.</span><br><span class="line">11月 10 16:55:05 localhost.localdomain firewalld[834]: WARNING: AllowZoneDrifting is enabled. This is considered an insecure configuration option. It will be removed <span class="keyword">in</span> a future release. Please consider disabling it now.</span><br><span class="line">11月 10 23:35:30 localhost.localdomain systemd[1]: Stopping firewalld - dynamic firewall daemon...</span><br><span class="line">11月 10 23:35:31 localhost.localdomain systemd[1]: Stopped firewalld - dynamic firewall daemon.</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开机自动关闭防火墙</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以不关闭防火墙，只开放端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看开放的端口号</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="comment">#开放端口</span></span><br><span class="line">firewall-cmd --add-service=http --permanent</span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent</span><br><span class="line"><span class="comment">#重启防火墙</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># firewall-cmd --list-all</span></span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: ens33</span><br><span class="line">  sources: </span><br><span class="line">  services: dhcpv6-client ssh</span><br><span class="line">  ports: </span><br><span class="line">  protocols: </span><br><span class="line">  masquerade: no</span><br><span class="line">  forward-ports: </span><br><span class="line">  source-ports: </span><br><span class="line">  icmp-blocks: </span><br><span class="line">  rich rules: </span><br><span class="line">	</span><br><span class="line">[root@localhost opt]<span class="comment"># firewall-cmd --add-service=http --permanent</span></span><br><span class="line">success</span><br><span class="line">[root@localhost opt]<span class="comment"># firewall-cmd --add-port=3306/tcp --permanent</span></span><br><span class="line">success</span><br><span class="line">[root@localhost opt]<span class="comment"># firewall-cmd --reload</span></span><br><span class="line">success</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>3.MySQL默认情况下不需要root用户远程连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">ERROR 1046 (3D000): No database selected</span><br><span class="line">mysql&gt; use mysql</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | root          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update user set host=&#x27;%&#x27; user=&#x27;root&#x27;;</span><br><span class="line">ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#x27;user=&#x27;root&#x27;&#x27; at line 1</span><br><span class="line">mysql&gt; update user set host=&#x27;%&#x27; where user=&#x27;root&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.远程连接</p>
<p><img src="image-20221111000125169.png" alt="MySQL之性能优化/image-20221111000125169"></p>
<p><img src="image-20221111000142712.png" alt="MySQL之性能优化/image-20221111000142712"></p>
</li>
</ul>
<h3 id="6-1-3-字符集的相关操作"><a href="#6-1-3-字符集的相关操作" class="headerlink" title="6.1.3 字符集的相关操作"></a>6.1.3 字符集的相关操作</h3><h4 id="6-1-3-1-修改MySQL5-7字符集"><a href="#6-1-3-1-修改MySQL5-7字符集" class="headerlink" title="6.1.3.1 修改MySQL5.7字符集"></a>6.1.3.1 修改MySQL5.7字符集</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Mysql8.0之前默认是latin1，故而需要设置表的时候显示设置为utf8mb4。8.0之后是utf-8（用utf8mb4兼容特殊字符，比utf-8更好）</span></span><br><span class="line"><span class="comment">#查看服务器所有字符集</span></span><br><span class="line">show variables like <span class="string">&#x27;char%&#x27;</span></span><br><span class="line">show variables like <span class="string">&#x27;%character%&#x27;</span>;</span><br><span class="line"><span class="comment">#查看数据库信息</span></span><br><span class="line">show create database 数据库名;</span><br><span class="line"><span class="comment">#修改数据库字符集</span></span><br><span class="line">alter database 数据库名 character <span class="built_in">set</span> <span class="string">&#x27;utf8&#x27;</span></span><br><span class="line"><span class="comment">#查看表的信息</span></span><br><span class="line">show create table 表名</span><br><span class="line"><span class="comment">#修改表的字符集</span></span><br><span class="line">alter table 表名 convert to character <span class="built_in">set</span> <span class="string">&#x27;utf8&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 7</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;char%&#x27;</span></span><br><span class="line">    -&gt; ;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | latin1                     |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%character%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | latin1                     |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create database dbtest1;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use dbtest1;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show create database dbtest1;</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                    |</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">| dbtest1  | CREATE DATABASE `dbtest1` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table emp1(<span class="built_in">id</span> int,username varchar(15));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into emp1(<span class="built_in">id</span>,username) values (1,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into emp1(<span class="built_in">id</span>,username) values (2,<span class="string">&#x27;毕业&#x27;</span>);</span><br><span class="line">ERROR 1366 (HY000): Incorrect string value: <span class="string">&#x27;\xE6\xAF\x95\xE4\xB8\x9A&#x27;</span> <span class="keyword">for</span> column <span class="string">&#x27;username&#x27;</span> at row 1</span><br><span class="line">mysql&gt; show table emp1;</span><br><span class="line">ERROR 1064 (42000): You have an error <span class="keyword">in</span> your SQL syntax; check the manual that corresponds to your MySQL server version <span class="keyword">for</span> the right syntax to use near <span class="string">&#x27;emp1&#x27;</span> at line 1</span><br><span class="line">mysql&gt; show create table emp1;</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                    |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| emp1  | CREATE TABLE `emp1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL,</span><br><span class="line">  `username` varchar(15) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_database   | latin1                     |</span><br><span class="line">| character_set_server     | latin1                     |</span><br><span class="line">+--------------------------+----------------------------+</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改配置文件my.cnf</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /etc/my.cnf</span></span><br><span class="line"><span class="comment"># For advice on how to change settings please see</span></span><br><span class="line"><span class="comment"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # and set to the amount of RAM for the most important data</span></span><br><span class="line"><span class="comment"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span></span><br><span class="line"><span class="comment"># innodb_buffer_pool_size = 128M</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to turn on a very important data integrity option: logging</span></span><br><span class="line"><span class="comment"># changes to the binary log between backups.</span></span><br><span class="line"><span class="comment"># log_bin</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to set options mainly useful for reporting servers.</span></span><br><span class="line"><span class="comment"># The server defaults are faster for transactions and fast SELECTs.</span></span><br><span class="line"><span class="comment"># Adjust sizes as needed, experiment to find the optimal values.</span></span><br><span class="line"><span class="comment"># join_buffer_size = 128M</span></span><br><span class="line"><span class="comment"># sort_buffer_size = 2M</span></span><br><span class="line"><span class="comment"># read_rnd_buffer_size = 2M</span></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"></span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加</span></span><br><span class="line">character_set_server=utf8</span><br></pre></td></tr></table></figure>

<blockquote>
<p>重启MySQL服务，生效配置文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># systemctl restart mysqld</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> is 3</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> or <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">&#x27;\c&#x27;</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="string">&#x27;%character%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>之前创建的库和表字符集编码没有变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create database dbtest1;</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                    |</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">| dbtest1  | CREATE DATABASE `dbtest1` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+----------+--------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table emp1;</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                    |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| emp1  | CREATE TABLE `emp1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL,</span><br><span class="line">  `username` varchar(15) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+-------+---------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>创建新库新表</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create database dbtest2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use dbtest2;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; create table emp2(<span class="built_in">id</span> int,username varchar(15));</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create database dbtest2;</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                  |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| dbtest2  | CREATE DATABASE `dbtest2` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table emp2;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                  |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| emp2  | CREATE TABLE `emp2` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL,</span><br><span class="line">  `username` varchar(15) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into emp2(<span class="built_in">id</span>,username) values (1,<span class="string">&#x27;Tom&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into emp2(<span class="built_in">id</span>,username) values (2,<span class="string">&#x27;毕业&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from emp2;</span><br><span class="line">+------+----------+</span><br><span class="line">| <span class="built_in">id</span>   | username |</span><br><span class="line">+------+----------+</span><br><span class="line">|    1 | Tom      |</span><br><span class="line">|    2 | 毕业     |</span><br><span class="line">+------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改已有库和表的字符集</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter database dbtest1 character <span class="built_in">set</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; use dbtest1;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; alter table emp1 convert to character <span class="built_in">set</span> <span class="string">&#x27;utf8&#x27;</span>;</span><br><span class="line">Query OK, 1 row affected (0.09 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; show create database dbtest1;</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                  |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">| dbtest1  | CREATE DATABASE `dbtest1` /*!40100 DEFAULT CHARACTER SET utf8 */ |</span><br><span class="line">+----------+------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show create table emp1;</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                                  |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| emp1  | CREATE TABLE `emp1` (</span><br><span class="line">  `<span class="built_in">id</span>` int(11) DEFAULT NULL,</span><br><span class="line">  `username` varchar(15) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</span><br><span class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; insert into emp1(<span class="built_in">id</span>,username) values (2,<span class="string">&#x27;毕业&#x27;</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from emp1;</span><br><span class="line">+------+----------+</span><br><span class="line">| <span class="built_in">id</span>   | username |</span><br><span class="line">+------+----------+</span><br><span class="line">|    1 | Tom      |</span><br><span class="line">|    2 | 毕业     |</span><br><span class="line">+------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>

<h4 id="6-1-3-2-各级别的字符集"><a href="#6-1-3-2-各级别的字符集" class="headerlink" title="6.1.3.2 各级别的字符集"></a>6.1.3.2 各级别的字符集</h4><ul>
<li><p>MySQL有4个级别的字符集和比较规则，分别是：</p>
<ul>
<li>服务器级别</li>
<li>数据库级别</li>
<li>表级别</li>
<li>列级别</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;character%&#x27;</span>;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>character_set_server</code>：服务器级别的字符集</li>
<li><code>character_set_database</code>：当前数据库的字符集</li>
<li><code>character_set_client</code>：服务器解码请求时使用的字符集</li>
<li><code>character_set_connection</code>：服务器处理请求时会把请求字符串从<code>character_set_client</code>转为<code>character_set_connection</code></li>
<li><code>character_set_results</code>：服务器向客户端返回数据时使用的字符集</li>
</ul>
</li>
</ul>
<h4 id="6-1-3-3-字符集与比较规则"><a href="#6-1-3-3-字符集与比较规则" class="headerlink" title="6.1.3.3 字符集与比较规则"></a>6.1.3.3 字符集与比较规则</h4><blockquote>
<p>utf8与utf8mb4</p>
</blockquote>
<p><img src="image-20221111211632477.png" alt="MySQL之性能优化/image-20221111211632477"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show charset;</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| Charset  | Description                     | Default collation   | Maxlen |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">| big5     | Big5 Traditional Chinese        | big5_chinese_ci     |      2 |</span><br><span class="line">| dec8     | DEC West European               | dec8_swedish_ci     |      1 |</span><br><span class="line">| cp850    | DOS West European               | cp850_general_ci    |      1 |</span><br><span class="line">| hp8      | HP West European                | hp8_english_ci      |      1 |</span><br><span class="line">| koi8r    | KOI8-R Relcom Russian           | koi8r_general_ci    |      1 |</span><br><span class="line">| latin1   | cp1252 West European            | latin1_swedish_ci   |      1 |</span><br><span class="line">| latin2   | ISO 8859-2 Central European     | latin2_general_ci   |      1 |</span><br><span class="line">| swe7     | 7bit Swedish                    | swe7_swedish_ci     |      1 |</span><br><span class="line">| ascii    | US ASCII                        | ascii_general_ci    |      1 |</span><br><span class="line">| ujis     | EUC-JP Japanese                 | ujis_japanese_ci    |      3 |</span><br><span class="line">| sjis     | Shift-JIS Japanese              | sjis_japanese_ci    |      2 |</span><br><span class="line">| hebrew   | ISO 8859-8 Hebrew               | hebrew_general_ci   |      1 |</span><br><span class="line">| tis620   | TIS620 Thai                     | tis620_thai_ci      |      1 |</span><br><span class="line">| euckr    | EUC-KR Korean                   | euckr_korean_ci     |      2 |</span><br><span class="line">| koi8u    | KOI8-U Ukrainian                | koi8u_general_ci    |      1 |</span><br><span class="line">| gb2312   | GB2312 Simplified Chinese       | gb2312_chinese_ci   |      2 |</span><br><span class="line">| greek    | ISO 8859-7 Greek                | greek_general_ci    |      1 |</span><br><span class="line">| cp1250   | Windows Central European        | cp1250_general_ci   |      1 |</span><br><span class="line">| gbk      | GBK Simplified Chinese          | gbk_chinese_ci      |      2 |</span><br><span class="line">| latin5   | ISO 8859-9 Turkish              | latin5_turkish_ci   |      1 |</span><br><span class="line">| armscii8 | ARMSCII-8 Armenian              | armscii8_general_ci |      1 |</span><br><span class="line">| utf8     | UTF-8 Unicode                   | utf8_general_ci     |      3 |</span><br><span class="line">| ucs2     | UCS-2 Unicode                   | ucs2_general_ci     |      2 |</span><br><span class="line">| cp866    | DOS Russian                     | cp866_general_ci    |      1 |</span><br><span class="line">| keybcs2  | DOS Kamenicky Czech-Slovak      | keybcs2_general_ci  |      1 |</span><br><span class="line">| macce    | Mac Central European            | macce_general_ci    |      1 |</span><br><span class="line">| macroman | Mac West European               | macroman_general_ci |      1 |</span><br><span class="line">| cp852    | DOS Central European            | cp852_general_ci    |      1 |</span><br><span class="line">| latin7   | ISO 8859-13 Baltic              | latin7_general_ci   |      1 |</span><br><span class="line">| utf8mb4  | UTF-8 Unicode                   | utf8mb4_general_ci  |      4 |</span><br><span class="line">| cp1251   | Windows Cyrillic                | cp1251_general_ci   |      1 |</span><br><span class="line">| utf16    | UTF-16 Unicode                  | utf16_general_ci    |      4 |</span><br><span class="line">| utf16le  | UTF-16LE Unicode                | utf16le_general_ci  |      4 |</span><br><span class="line">| cp1256   | Windows Arabic                  | cp1256_general_ci   |      1 |</span><br><span class="line">| cp1257   | Windows Baltic                  | cp1257_general_ci   |      1 |</span><br><span class="line">| utf32    | UTF-32 Unicode                  | utf32_general_ci    |      4 |</span><br><span class="line">| binary   | Binary pseudo charset           | binary              |      1 |</span><br><span class="line">| geostd8  | GEOSTD8 Georgian                | geostd8_general_ci  |      1 |</span><br><span class="line">| cp932    | SJIS for Windows Japanese       | cp932_japanese_ci   |      2 |</span><br><span class="line">| eucjpms  | UJIS for Windows Japanese       | eucjpms_japanese_ci |      3 |</span><br><span class="line">| gb18030  | China National Standard GB18030 | gb18030_chinese_ci  |      4 |</span><br><span class="line">+----------+---------------------------------+---------------------+--------+</span><br><span class="line">41 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>比较规则</p>
</blockquote>
<ul>
<li>由上可知，MySQL版本一个支持41种字符集，其中的<code>Default collation</code>列表示这种字符集中一种默认的比较规则，里面包含着该比较规则主要作用于哪种语言，比如<code>eucjpms_japanese_ci</code>表示日语的规则比较，<code>utf8_general_ci</code>是一种通用的比较规则</li>
</ul>
<table>
<thead>
<tr>
<th align="left">后缀</th>
<th align="left">英文释义</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">_ai</td>
<td align="left">accent insensiteve</td>
<td align="left">不区分重音</td>
</tr>
<tr>
<td align="left">_as</td>
<td align="left">accent sensiteve</td>
<td align="left">区分重音</td>
</tr>
<tr>
<td align="left">_ci</td>
<td align="left">case insensiteve</td>
<td align="left">不区分大小写</td>
</tr>
<tr>
<td align="left">_cs</td>
<td align="left">case sensiteve</td>
<td align="left">区分大小写</td>
</tr>
<tr>
<td align="left">_bin</td>
<td align="left">binary</td>
<td align="left">二进制比较</td>
</tr>
</tbody></table>
<ul>
<li><p>最后一列<code>Maxlen</code>，代表该字符集最多需要几个字节</p>
</li>
<li><p>常用操作1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#查看GBK字符集的比较规则</span><br><span class="line">show collattion like &#x27;gbk%&#x27;;</span><br><span class="line"></span><br><span class="line">#查看UTF-8字符集的比较规则</span><br><span class="line">show collattion like &#x27;utf8%&#x27;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>常用操作2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#查看服务器的字符集和比较规则</span><br><span class="line">show variables like &#x27;%_server&#x27;;</span><br><span class="line"></span><br><span class="line">#查看数据库的字符集和比较规则</span><br><span class="line">show variables like &#x27;%_database&#x27;;</span><br><span class="line"></span><br><span class="line">#查看具体数据库的字符集</span><br><span class="line">show create database 数据库名;</span><br><span class="line"></span><br><span class="line">#修改具体数据库的字符集</span><br><span class="line">alter database 数据库名 default character set &#x27;字符集&#x27; collate &#x27;比较规则&#x27;;</span><br><span class="line">alter database dbtest1 default character set &#x27;utf8&#x27; collate &#x27;utf8_general_ci&#x27;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#说明</span><br><span class="line">&#x27;utf8_unicode_ci&#x27;和&#x27;utf8_general_ci&#x27;对中英文来说没有实质性的差别</span><br><span class="line">&#x27;utf8_general_ci&#x27;校队速度快，但准确度稍差</span><br><span class="line">&#x27;utf8_unicode_ci&#x27;准确度高，但校对速度稍慢</span><br><span class="line"></span><br><span class="line">一般情况下，用&#x27;utf8_general_ci&#x27;就够了，但是如果应用德语、法语或者俄语，使用&#x27;utf8_unicode_ci&#x27;</span><br><span class="line"></span><br><span class="line">修改了数据库的默认字符集和比较规则后，原来已经创建的表格的字符集和比较规则并不会改变，如果需要，那么需要单独修改</span><br></pre></td></tr></table></figure>
</li>
<li><p>常用操作3：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查看表的字符集</span><br><span class="line">show create table 表名;</span><br><span class="line"></span><br><span class="line">#查看表的比较规则</span><br><span class="line">show table status from 数据库名 like &#x27;表名&#x27;;</span><br><span class="line"></span><br><span class="line">#修改表的字符集和比较规则</span><br><span class="line">alter table 表名 default character set &#x27;字符集&#x27; collate &#x27;比较规则&#x27;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-1-3-4-请求到响应过程中字符集的变化"><a href="#6-1-3-4-请求到响应过程中字符集的变化" class="headerlink" title="6.1.3.4 请求到响应过程中字符集的变化"></a>6.1.3.4 请求到响应过程中字符集的变化</h4><ul>
<li><p>MySQL中从客户端发往服务器的请求本质上就是一个<strong>字符串</strong>，服务器向客户端返回的结果本质上也是一个<strong>字符串</strong>，而<strong>字符串其实就是使用某种字符集编码的二进制数据</strong></p>
</li>
<li><p>字符串从发送请求到返回结果的过程中<strong>发生多次字符集的转换</strong></p>
</li>
<li><p>在这个过程中会用到三个系统变量</p>
<table>
<thead>
<tr>
<th>系统变量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>character_set_client</code></td>
<td>服务器解码请求时使用的字符集</td>
</tr>
<tr>
<td><code>character_set_connection</code></td>
<td>服务器处理请求时会把请求字符串从<code>character_set_client</code>转为<code>character_set_connection</code></td>
</tr>
<tr>
<td><code>character_set_results</code></td>
<td>服务器向客户端返回数据时使用的字符集</td>
</tr>
</tbody></table>
</li>
<li><p>这几个系统变量的默认值如下：**(character_set_database|character_set_server)之前有过修改**</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;character%&#x27;;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>实验：观察客户端与服务器一次请求和响应过程中字符集的转换过程</p>
</blockquote>
<ul>
<li><p>因为请求处理过程中涉及的三个系统变量的值均为<code>utf8</code>，为了看出字符集编码的变化，这里特地修改<strong>中间</strong>的一个系统变量值：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;character%&#x27;;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; set character_set_connection=&#x27;gbk&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &#x27;character%&#x27;;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | gbk                        |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在假设客户端发送的求是下边的字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from t where s=&#x27;我&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>观察分析字符**’我’**在请求响应过程中的字符集转换</p>
<ul>
<li><p>1.客户端发送请求使用的字符集</p>
<ul>
<li><p>一般情况下客户端使用的字符集和当前操作系统一致，不同操作系统使用的字符集可能不同，如下：</p>
<ul>
<li>类Unix系统：<code>utf8</code></li>
<li><code>Windows</code>：<code>gbk</code></li>
</ul>
</li>
<li><p>当客户端使用的是<code>utf8</code>字符集，字符**’我’<strong>在发送给服务器的请求中的字节形式就是：</strong>0xE68891**</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#提示：如果使用的是可视化工具，比如sqlyog之类的，这些工具可能会使用自定义的字符集来编码发送到服务器的字符串，而不采用操作系统默认的字符集</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>2.服务器接收到客户端发送来的请求其实是<strong>一串二进制的字节</strong>，它会认为这串字节采用的字符集是<code>character_set_client</code>，然后把这串字节转换为<code>character_set_connection</code>字符集编码的字符。首先会按照<code>character_set_client</code>的值<code>utf8</code>进行解码，得到的字符串就是**’我’<strong>，然后按照<code>character_set_connection</code>的当前值<code>gbk</code>进行编码，得到的结果就是字符串</strong>0xCED2**</p>
</li>
<li><p>3.因为<strong>表t</strong>的<strong>列col</strong>采用的是<code>utf8</code>字符集，与<code>character_set_connection</code>不一致，所以需要再转一次，变成<strong>0xE68891</strong>，然后在列中找到字节值为<strong>0xE68891</strong>的记录，最后找到了一条记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#提示：如果某个列使用的字符集与character_set_connection代表的字符集一致，则直接查找记录，不需要再一次转换字符集</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.上一步骤找到的记录中的<strong>col列</strong>其实是一个字符串<strong>0xE68891</strong>，<strong>col列</strong>采用<code>utf8</code>进行编码的，<code>character_set_results</code>也是<code>utf8</code>，所以不需要在进行解码编码，直接发送给客户端<strong>0xE68891</strong></p>
</li>
<li><p>5.由于客户端<code>character_set_client</code>用的字符集是<code>utf8</code>，所以顺利将<strong>0xE68891</strong>解释成我，从而显示到我们的显示器上</p>
</li>
</ul>
<p><img src="image-20221112124713746.png" alt="MySQL之性能优化/image-20221112124713746"></p>
</li>
</ul>
<h3 id="6-1-4-SQL大小写规范"><a href="#6-1-4-SQL大小写规范" class="headerlink" title="6.1.4 SQL大小写规范"></a>6.1.4 SQL大小写规范</h3><h4 id="6-1-4-1-Windows和Linux平台区别"><a href="#6-1-4-1-Windows和Linux平台区别" class="headerlink" title="6.1.4.1 Windows和Linux平台区别"></a>6.1.4.1 Windows和Linux平台区别</h4><ul>
<li><p>在SQL中，关键字和函数名是不区分字母大小写的，比如SELECT、WHERE、ORDER等关键字，以及ABS、MOD、ROUND、MAX等函数名</p>
</li>
<li><p>但是在Linux和Windows环境下，可能会遇到不同的大小写问题，<strong>Windows系统默认大小写不敏感</strong>，但是<strong>Linux系统是大小写敏感的</strong></p>
</li>
<li><p>Linux系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%lower_case_table_names%&#x27;;</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| lower_case_table_names | 0     |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Windows系统：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">C:\WINDOWS\system32&gt;mysql -uroot -p</span><br><span class="line">Enter password: ******</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 20</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &#x27;%lower_case_table_names%&#x27;;</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">| lower_case_table_names | 1     |</span><br><span class="line">+------------------------+-------+</span><br><span class="line">1 row in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>lower_case_table_names</code>参数值的设置：</p>
<ul>
<li><strong>默认为0，大小写敏感</strong></li>
<li>设置1，大小写不敏感。创建的数据库和表都是以小写的形式存放在磁盘上，<strong>对于sql语句都是转换为小写对表和数据库进行查找</strong></li>
<li>设置2，创建的数据库和表依据语句上格式存放，凡是查找都是转换为小写进行</li>
</ul>
</li>
<li><p>两个平台SQL大小写的区别具体来说：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MySQL在Linux下数据库名、表名、列名、别名大小写规则是这样的：</span><br><span class="line">1.数据库名、表名、表的别名、变量名是严格区分大小写的</span><br><span class="line">2.关键字、函数名在SQL中不区分大小写</span><br><span class="line">3.列名与列的别名在所以情况下均忽略大小写</span><br><span class="line"></span><br><span class="line">MySQL在Windows的环境下全部不区分大小写</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-1-4-2-Linux下大小写规则设置"><a href="#6-1-4-2-Linux下大小写规则设置" class="headerlink" title="6.1.4.2 Linux下大小写规则设置"></a>6.1.4.2 Linux下大小写规则设置</h4><p><img src="image-20221112142049242.png" alt="MySQL之性能优化/image-20221112142049242"></p>
<h4 id="6-1-4-3-SQL编写建议"><a href="#6-1-4-3-SQL编写建议" class="headerlink" title="6.1.4.3 SQL编写建议"></a>6.1.4.3 SQL编写建议</h4><p><img src="image-20221112142120028.png" alt="MySQL之性能优化/image-20221112142120028"></p>
<h3 id="6-1-5-sql-mode的合理设置"><a href="#6-1-5-sql-mode的合理设置" class="headerlink" title="6.1.5 sql_mode的合理设置"></a>6.1.5 sql_mode的合理设置</h3><h4 id="6-1-5-1-介绍"><a href="#6-1-5-1-介绍" class="headerlink" title="6.1.5.1 介绍"></a>6.1.5.1 介绍</h4><ul>
<li><p><code>sql_mode</code>会影响MySQL支持的SQL语法以及它执行的<strong>数据验证检查</strong>。通过设置**<code>sql_mode</code>**，可以完成不同严格程度的数据校验，有效的保障数据的准确性</p>
</li>
<li><p>MySQL服务器可以在不同的SQL模式下运行，并且可以针对不同的客户端以不同的方式应用这些模式，具体取决于<code>sql_mode</code>系统变量的值</p>
</li>
<li><p>MySQL5.6和MySQL5.7默认的<code>sql_mode</code>模式参数是不一样的：</p>
<ul>
<li>5.6的mode默认值为空(即：<code>NO_ENGINE_SUBSTITUTION</code>)，其实表示的是一个空值，相当于没有什么模式设置，可以理解为<strong>宽松模式</strong>。在这种设置下是可以允许一些非法操作的，比如允许一些非法数据的插入</li>
<li>5.7的<code>mode</code>是<code>STRICT_TRANS_TABLES</code>，也就是<strong>严格模式</strong>。用于进行数据的严格校验，错误数据不能插入，报<code>error</code>(错误)，并且事务回滚</li>
</ul>
</li>
</ul>
<h4 id="6-1-5-2-宽松模式-vs-严格模式"><a href="#6-1-5-2-宽松模式-vs-严格模式" class="headerlink" title="6.1.5.2 宽松模式 vs 严格模式"></a>6.1.5.2 宽松模式 vs 严格模式</h4><p><img src="image-20221112174656304.png" alt="MySQL之性能优化/image-20221112174656304"></p>
<p><img src="image-20221112174745396.png" alt="MySQL之性能优化/image-20221112174745396"></p>
<h4 id="6-1-5-3-模式查看和设置"><a href="#6-1-5-3-模式查看和设置" class="headerlink" title="6.1.5.3 模式查看和设置"></a>6.1.5.3 模式查看和设置</h4><h4 id="6-1-5-4-sql-mode常用值"><a href="#6-1-5-4-sql-mode常用值" class="headerlink" title="6.1.5.4 sql_mode常用值"></a>6.1.5.4 sql_mode常用值</h4><h2 id="6-2-MySQL的数据目录"><a href="#6-2-MySQL的数据目录" class="headerlink" title="6.2 MySQL的数据目录"></a>6.2 MySQL的数据目录</h2><blockquote>
<p>补充：Windows下MySQL的目录结构</p>
</blockquote>
<p><img src="image-20221113210451607.png" alt="MySQL之性能优化/image-20221113210451607"></p>
<ul>
<li>1.<code>bin</code>目录：用于放置一些可执行文件，如mysql.exe、mysqld.exe、mysqlshow.exe等</li>
<li>2.<code>data</code>目录：用于放置一些日志文件以及数据库</li>
<li>3.<code>include</code>目录：用于放置一些头文件，如：mysql.h、mysql_ername.h等</li>
<li>4.<code>lib</code>目录：用于放置一系列库文件</li>
<li>5.<code>share</code>目录：用于存放字符集、语言等信息</li>
<li>6.<code>my.ini</code>：是MySQL数据库中使用的配置文件</li>
</ul>
<h3 id="6-2-1-MySQL5-7的主要目录结构"><a href="#6-2-1-MySQL5-7的主要目录结构" class="headerlink" title="6.2.1 MySQL5.7的主要目录结构"></a>6.2.1 MySQL5.7的主要目录结构</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># find / -name mysql</span></span><br><span class="line">/etc/logrotate.d/mysql</span><br><span class="line">/var/lib/mysql</span><br><span class="line">/var/lib/mysql/mysql</span><br><span class="line">/usr/bin/mysql</span><br><span class="line">/usr/lib64/mysql</span><br><span class="line">/usr/share/mysql</span><br></pre></td></tr></table></figure>

<h4 id="6-2-1-1-数据库文件的存放路径"><a href="#6-2-1-1-数据库文件的存放路径" class="headerlink" title="6.2.1.1 数据库文件的存放路径"></a>6.2.1.1 数据库文件的存放路径</h4><ul>
<li>MySQL数据库文件的存放路径：**&#x2F;var&#x2F;lib&#x2F;mysql<strong>，相当于Windows系统下MySQL的</strong>data**目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cd /var/lib/mysql</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># ls</span></span><br><span class="line">auto.cnf  dbtest1  dbtest2  ib_buffer_pool  ibdata1  ib_logfile0  ib_logfile1  ibtmp1  mysql  mysql.sock  mysql.sock.lock  performance_schema  sys</span><br><span class="line">[root@localhost mysql]<span class="comment"># ls -l</span></span><br><span class="line">总用量 122920</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:37 dbtest2</span><br><span class="line">-rw-r-----. 1 mysql mysql      377 11月 11 16:29 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 20:31 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 13 20:31 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 10 22:06 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 20:31 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 11月 10 22:06 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 11月 13 20:31 mysql.sock</span><br><span class="line">-rw-------. 1 mysql mysql        5 11月 13 20:31 mysql.sock.lock</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 sys</span><br></pre></td></tr></table></figure>

<ul>
<li><p>MySQL服务器程序在启动时会到文件系统的某个目录下加载一些文件，之后在运行过程中产生的数据也都会存储到这个目录下的某些文件中，这个目录就称为<strong>数据目录</strong></p>
</li>
<li><p>MySQL把数据都存储到哪个路径下呢？其实<strong>数据目录</strong>对应一个系统变量<strong>datadir</strong>，我们在使用客户端连接服务器之后查看这个系统变量的值就可以了：</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&#x27;datadir&#x27;</span>;</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| datadir       | /var/lib/mysql/ |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>

<h4 id="6-2-1-2-相关命令目录"><a href="#6-2-1-2-相关命令目录" class="headerlink" title="6.2.1.2 相关命令目录"></a>6.2.1.2 相关命令目录</h4><ul>
<li>相关命令目录：**&#x2F;usr&#x2F;bin**(mysqladmin、mysqlbinlog、mysqldump等命令)和**&#x2F;usr&#x2F;sbin<strong>，相当于Windows系统下MySQL的</strong>bin**目录</li>
</ul>
<h4 id="6-2-1-3-配置文件目录"><a href="#6-2-1-3-配置文件目录" class="headerlink" title="6.2.1.3 配置文件目录"></a>6.2.1.3 配置文件目录</h4><ul>
<li><strong>配置文件目录：&#x2F;usr&#x2F;share&#x2F;mysql-5.7(命令及配置文件)，&#x2F;etc(如my.cnf)</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql]<span class="comment"># cd /usr/share/mysql</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># ls -l</span></span><br><span class="line">总用量 1932</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 bulgarian</span><br><span class="line">drwxr-xr-x. 2 root root   4096 11月 10 21:59 charsets</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 czech</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 danish</span><br><span class="line">-rw-r--r--. 1 root root  25575 6月  22 2017 dictionary.txt</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 dutch</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 english</span><br><span class="line">-rw-r--r--. 1 root root 525548 6月  22 2017 errmsg-utf8.txt</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 estonian</span><br><span class="line">-rw-r--r--. 1 root root 927189 6月  22 2017 fill_help_tables.sql</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 french</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 german</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 greek</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 hungarian</span><br><span class="line">-rw-r--r--. 1 root root   3999 6月  22 2017 innodb_memcached_config.sql</span><br><span class="line">-rw-r--r--. 1 root root   1812 6月  22 2017 install_rewriter.sql</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 italian</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 japanese</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 korean</span><br><span class="line">-rw-r--r--. 1 root root    773 6月  22 2017 magic</span><br><span class="line">-rw-r--r--. 1 root root    844 6月  22 2017 mysql-log-rotate</span><br><span class="line">-rw-r--r--. 1 root root   1760 6月  22 2017 mysql_security_commands.sql</span><br><span class="line">-rw-r--r--. 1 root root 287110 6月  22 2017 mysql_sys_schema.sql</span><br><span class="line">-rw-r--r--. 1 root root    811 6月  22 2017 mysql_system_tables_data.sql</span><br><span class="line">-rw-r--r--. 1 root root 154624 6月  22 2017 mysql_system_tables.sql</span><br><span class="line">-rw-r--r--. 1 root root  10410 6月  22 2017 mysql_test_data_timezone.sql</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 norwegian</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 norwegian-ny</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 polish</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 portuguese</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 romanian</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 russian</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 serbian</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 slovak</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 spanish</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 swedish</span><br><span class="line">drwxr-xr-x. 2 root root     24 11月 10 21:59 ukrainian</span><br><span class="line">-rw-r--r--. 1 root root    834 6月  22 2017 uninstall_rewriter.sql</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># find /etc -name my.cnf</span></span><br><span class="line">/etc/my.cnf</span><br></pre></td></tr></table></figure>

<h3 id="6-2-2-数据库与文件系统的关系"><a href="#6-2-2-数据库与文件系统的关系" class="headerlink" title="6.2.2 数据库与文件系统的关系"></a>6.2.2 数据库与文件系统的关系</h3><blockquote>
<p>像<strong>InnoDB</strong>、<strong>MyISAM</strong>这样的存储引擎都是<strong>把表存储到磁盘上的</strong>，操作系统用来管理磁盘的结构被称为<strong>文件系统</strong>，所以用专业一点的话来表述就是：像<strong>InnoDB</strong>、<strong>MyISAM</strong>这样的存储引擎都是<strong>把表存储在文件系统上的</strong>。当我们想读取数据的时候，这些存储引擎会从文件系统中把数据读出来返回给我们，当我们想写入数据的时候，这些存储引擎会把这些数据又写回到文件系统</p>
</blockquote>
<h4 id="6-2-2-1-查看默认数据库"><a href="#6-2-2-1-查看默认数据库" class="headerlink" title="6.2.2.1 查看默认数据库"></a>6.2.2.1 查看默认数据库</h4><blockquote>
<p>查看当前计算机中有哪些数据库：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dbtest1            |</span><br><span class="line">| dbtest2            |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows in set (0.10 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到有4个数据库是属于MySQL自带的数据库</p>
</blockquote>
<ul>
<li><p><strong>mysql</strong>：MySQL系统自带的核心数据库，它存储了MySQL的用户账户和权限信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息，一些帮助信息以及时区信息等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| engine_cost               |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| gtid_executed             |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| innodb_index_stats        |</span><br><span class="line">| innodb_table_stats        |</span><br><span class="line">| ndb_binlog_index          |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| server_cost               |</span><br><span class="line">| servers                   |</span><br><span class="line">| slave_master_info         |</span><br><span class="line">| slave_relay_log_info      |</span><br><span class="line">| slave_worker_info         |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">31 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>information_schema</strong>：MySQL系统自带的数据库，这个数据库保存着MySQL服务器<strong>维护的所有其它数据库的信息</strong>，比如有哪些表、哪些视图、哪些触发器、哪些列、哪些索引。这些信息并不是真实的用户数据，而是一些描述性信息，有些时候也称为<strong>元数据</strong>。在系统数据库<strong>information_schema</strong>中提供了一些以<strong>innodb_sys</strong>开头的表，用于表示内部系统表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use information_schema;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| Tables_in_information_schema          |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| CHARACTER_SETS                        |</span><br><span class="line">| COLLATIONS                            |</span><br><span class="line">| COLLATION_CHARACTER_SET_APPLICABILITY |</span><br><span class="line">| COLUMNS                               |</span><br><span class="line">| COLUMN_PRIVILEGES                     |</span><br><span class="line">| ENGINES                               |</span><br><span class="line">| EVENTS                                |</span><br><span class="line">| FILES                                 |</span><br><span class="line">| GLOBAL_STATUS                         |</span><br><span class="line">| GLOBAL_VARIABLES                      |</span><br><span class="line">| KEY_COLUMN_USAGE                      |</span><br><span class="line">| OPTIMIZER_TRACE                       |</span><br><span class="line">| PARAMETERS                            |</span><br><span class="line">| PARTITIONS                            |</span><br><span class="line">| PLUGINS                               |</span><br><span class="line">| PROCESSLIST                           |</span><br><span class="line">| PROFILING                             |</span><br><span class="line">| REFERENTIAL_CONSTRAINTS               |</span><br><span class="line">| ROUTINES                              |</span><br><span class="line">| SCHEMATA                              |</span><br><span class="line">| SCHEMA_PRIVILEGES                     |</span><br><span class="line">| SESSION_STATUS                        |</span><br><span class="line">| SESSION_VARIABLES                     |</span><br><span class="line">| STATISTICS                            |</span><br><span class="line">| TABLES                                |</span><br><span class="line">| TABLESPACES                           |</span><br><span class="line">| TABLE_CONSTRAINTS                     |</span><br><span class="line">| TABLE_PRIVILEGES                      |</span><br><span class="line">| TRIGGERS                              |</span><br><span class="line">| USER_PRIVILEGES                       |</span><br><span class="line">| VIEWS                                 |</span><br><span class="line">| INNODB_LOCKS                          |</span><br><span class="line">| INNODB_TRX                            |</span><br><span class="line">| INNODB_SYS_DATAFILES                  |</span><br><span class="line">| INNODB_FT_CONFIG                      |</span><br><span class="line">| INNODB_SYS_VIRTUAL                    |</span><br><span class="line">| INNODB_CMP                            |</span><br><span class="line">| INNODB_FT_BEING_DELETED               |</span><br><span class="line">| INNODB_CMP_RESET                      |</span><br><span class="line">| INNODB_CMP_PER_INDEX                  |</span><br><span class="line">| INNODB_CMPMEM_RESET                   |</span><br><span class="line">| INNODB_FT_DELETED                     |</span><br><span class="line">| INNODB_BUFFER_PAGE_LRU                |</span><br><span class="line">| INNODB_LOCK_WAITS                     |</span><br><span class="line">| INNODB_TEMP_TABLE_INFO                |</span><br><span class="line">| INNODB_SYS_INDEXES                    |</span><br><span class="line">| INNODB_SYS_TABLES                     |</span><br><span class="line">| INNODB_SYS_FIELDS                     |</span><br><span class="line">| INNODB_CMP_PER_INDEX_RESET            |</span><br><span class="line">| INNODB_BUFFER_PAGE                    |</span><br><span class="line">| INNODB_FT_DEFAULT_STOPWORD            |</span><br><span class="line">| INNODB_FT_INDEX_TABLE                 |</span><br><span class="line">| INNODB_FT_INDEX_CACHE                 |</span><br><span class="line">| INNODB_SYS_TABLESPACES                |</span><br><span class="line">| INNODB_METRICS                        |</span><br><span class="line">| INNODB_SYS_FOREIGN_COLS               |</span><br><span class="line">| INNODB_CMPMEM                         |</span><br><span class="line">| INNODB_BUFFER_POOL_STATS              |</span><br><span class="line">| INNODB_SYS_COLUMNS                    |</span><br><span class="line">| INNODB_SYS_FOREIGN                    |</span><br><span class="line">| INNODB_SYS_TABLESTATS                 |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">61 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>performance_schema</strong>：MySQL系统自带的数据库，这个数据库主要保存MySQL服务器运行过程中的一些状态信息，可以用来<strong>监控MySQL服务的各类性能指标</strong>。包括统计最近执行了哪些语句，在执行的每个阶段都花费了多长时间，内存的使用情况等信息</p>
</li>
<li><p><strong>sys</strong>：MySQL系统自带的数据库，这个数据库主要是通过<strong>视图</strong>的形式把<strong>information_schema</strong>和<strong>performance_schema</strong>结合起来，帮助系统管理员和开放人员<strong>监控MySQL的技术性能</strong></p>
</li>
</ul>
<h4 id="6-2-2-2-数据库在文件系统中的表示"><a href="#6-2-2-2-数据库在文件系统中的表示" class="headerlink" title="6.2.2.2 数据库在文件系统中的表示"></a>6.2.2.2 数据库在文件系统中的表示</h4><ul>
<li><p>使用<code>create database 数据库名</code>语句创建一个数据库时，MySQL做了两件事：</p>
<ul>
<li>1.在<strong>数据目录</strong>下创建一个数据库名同名的子目录</li>
<li>2.在与该数据库名同名的子目录下创建一个名为**<code>db.opt</code><strong>的文件（仅限MySQL5.7及之前版本），这个文件包含了</strong>该数据库的各种属性**，比如该数据库的字符集和比较规则</li>
</ul>
</li>
<li><p>例如：之前创建数据库<strong>dbtest2</strong>和再此数据库中创建的表<strong>emp2</strong>,查看数据目录中多出一个<strong>dbtest2</strong>子目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use dbtest2;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_dbtest2 |</span><br><span class="line">+-------------------+</span><br><span class="line">| emp2              |</span><br><span class="line">+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># cd /var/lib/mysql</span></span><br><span class="line">[root@localhost mysql]<span class="comment"># ll</span></span><br><span class="line">总用量 122920</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:37 dbtest2</span><br><span class="line">-rw-r-----. 1 mysql mysql      377 11月 11 16:29 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 20:31 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 13 20:31 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 10 22:06 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 22:25 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 11月 10 22:06 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 11月 13 20:31 mysql.sock</span><br><span class="line">-rw-------. 1 mysql mysql        5 11月 13 20:31 mysql.sock.lock</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 sys</span><br><span class="line">[root@localhost mysql]<span class="comment"># cd dbtest2</span></span><br><span class="line">[root@localhost dbtest2]<span class="comment"># ll</span></span><br><span class="line">总用量 112</span><br><span class="line">-rw-r-----. 1 mysql mysql    61 11月 11 16:36 db.opt</span><br><span class="line">-rw-r-----. 1 mysql mysql  8594 11月 11 16:37 emp2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql 98304 11月 11 16:38 emp2.ibd</span><br></pre></td></tr></table></figure>
</li>
<li><p>*.frm：存储表的结构</p>
</li>
<li><p>*.ibd：存储表的数据（表的数据也可以存储到此数据库目录的上一级目录中的系统表空间<strong>ibdata1</strong>中（默认存储空间12M））</p>
</li>
</ul>
<h4 id="6-2-2-3-表在文件系统中的表示"><a href="#6-2-2-3-表在文件系统中的表示" class="headerlink" title="6.2.2.3 表在文件系统中的表示"></a>6.2.2.3 表在文件系统中的表示</h4><ul>
<li>数据其实是以记录的形式插入到表中的，每个表的信息其实可以分为两种：<ul>
<li>1.表结构的定义</li>
<li>2.表中的数据</li>
</ul>
</li>
<li><strong>表结构</strong>就是该表的名称，表里有多少列，每个列的数据类型，约束条件和索引，使用的字符集和比较规则等各种信息，这些信息都体现在了建表的语句中了</li>
</ul>
<blockquote>
<p>InnoDB存储引擎模式</p>
</blockquote>
<ul>
<li><p>1.表结构</p>
<ul>
<li><p>为了保存表结构，<strong>InnoDB</strong>在<strong>数据目录</strong>下对应的数据库子目录下创建了一个专门用于<strong>描述表结构的文件</strong>，文件名是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表名.frm</span><br></pre></td></tr></table></figure>
</li>
<li><p>比如，<strong>dbtest2</strong>数据库下创建的表<strong>emp2</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use dbtest2;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_dbtest2 |</span><br><span class="line">+-------------------+</span><br><span class="line">| emp2              |</span><br><span class="line">+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[root@localhost /]# cd /var/lib/mysql</span><br><span class="line">[root@localhost mysql]# ll</span><br><span class="line">总用量 122920</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:37 dbtest2</span><br><span class="line">-rw-r-----. 1 mysql mysql      377 11月 11 16:29 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 20:31 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 13 20:31 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 10 22:06 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 22:25 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 11月 10 22:06 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 11月 13 20:31 mysql.sock</span><br><span class="line">-rw-------. 1 mysql mysql        5 11月 13 20:31 mysql.sock.lock</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 sys</span><br><span class="line">[root@localhost mysql]# cd dbtest2</span><br><span class="line">[root@localhost dbtest2]# ll</span><br><span class="line">总用量 112</span><br><span class="line">-rw-r-----. 1 mysql mysql    61 11月 11 16:36 db.opt</span><br><span class="line">-rw-r-----. 1 mysql mysql  8594 11月 11 16:37 emp2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql 98304 11月 11 16:38 emp2.ibd</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>.frm</strong>文件的格式在不同的平台都是相同的，这个后缀名为**.frm<strong>是以</strong>二进制格式存储**的，直接打开是乱码的</p>
</li>
</ul>
</li>
<li><p>2.表中数据和索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#InnoDB其实是使用页为基本单位来管理存储空间的，默认的页大小为16KB</span><br><span class="line"></span><br><span class="line">#对于InnoDB存储引擎来说，每个索引都对应一颗B+树，该B+树的每个节点都是一个数据页，数据页之间不必要是物理#连续的，因为数据页之间有双向链表来维护这些页的顺序</span><br><span class="line"></span><br><span class="line">#InnoDB的聚簇索引的叶子节点存储了完整的用户记录，也就是所谓的索引即数据，数据即索引</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#为了更好的管理的这些页，InnoDB提出了一个表空间或者文件空间的概念，这个表空间是一个抽象的概念，它可以对应文件系统上一个或多个真实文件（不同表空间对应的文件数量可能不同）。每一个表空间可以被划分为很多个页，我们的表数据就存放在某个表空间下的某些页里。这里的表空间有几种不同的类型：</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>系统表空间</strong></p>
<ul>
<li><p>默认情况下，InnoDB会在数据目录下创建一个名为<strong>ibdata1</strong>、大小为12M的文件，这个文件就是对应的<strong>系统表空间</strong>在文件系统上的表示。怎么才12M？主要这个文件是<strong>自扩展文件</strong>，当不够用的时候会自己增加文件的大小</p>
</li>
<li><p>当然，<strong>如果想要系统表空间对应文件系统上多个实际文件</strong>，或者觉得原来的<strong>ibdata1</strong>这个文件名难听，那么可以在MySQL启动时配置对应的文件路径以及大小，比如这样修改配置文件<strong>my.cnf</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line">innodb_data_file_path=data1:512M;data2:512M:autoextend</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样在MySQL启动之后就会创建这两个512M大小的文件作为<strong>系统表空间</strong>，其中的<strong>autoextend</strong>表明这两个文件如果不够用就自动扩展<strong>data2</strong>文件的大小</p>
</li>
<li><p>需要注意的是，在一个<strong>MySQL服务器中，系统表空间只能有一份</strong>。从MySQL5.5.7到MySQL5.6.6之间的各个版本中，表中的数据都会被默认存储到这个系统表空间</p>
</li>
</ul>
</li>
<li><p><strong>独立表空间</strong></p>
<ul>
<li><p>在MySQL5.6.6以及之后的版本中，InnoDB并不会默认的把各个表的数据存储到系统表空间中，而是为<strong>每一个表建立一个独立表空间</strong>，也就是说我们创建多少个表，就有多少个独立表空间。使用<strong>独立表空间</strong>来存储表数据的话，会在该表所属的数据库对应的子目录下创建一个表示该独立表空间的文件，文件名与表名相同，只不过添加了一个**.ibd**的扩展名而已，所以完整的文件名称：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表名.ibd</span><br></pre></td></tr></table></figure>
</li>
<li><p>比如，<strong>dbtest2</strong>数据库下创建的表<strong>emp2</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use dbtest2;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_dbtest2 |</span><br><span class="line">+-------------------+</span><br><span class="line">| emp2              |</span><br><span class="line">+-------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[root@localhost /]# cd /var/lib/mysql</span><br><span class="line">[root@localhost mysql]# ll</span><br><span class="line">总用量 122920</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:37 dbtest2</span><br><span class="line">-rw-r-----. 1 mysql mysql      377 11月 11 16:29 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 20:31 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 13 20:31 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 10 22:06 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 13 22:25 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 11月 10 22:06 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 11月 13 20:31 mysql.sock</span><br><span class="line">-rw-------. 1 mysql mysql        5 11月 13 20:31 mysql.sock.lock</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 sys</span><br><span class="line">[root@localhost mysql]# cd dbtest2</span><br><span class="line">[root@localhost dbtest2]# ll</span><br><span class="line">总用量 112</span><br><span class="line">-rw-r-----. 1 mysql mysql    61 11月 11 16:36 db.opt</span><br><span class="line">-rw-r-----. 1 mysql mysql  8594 11月 11 16:37 emp2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql 98304 11月 11 16:38 emp2.ibd</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中<strong>emp2.ibd</strong>文件就用来存储<strong>emp2</strong>表中的数据和索引</p>
</li>
</ul>
</li>
<li><p><strong>系统表空间与独立表空间的设置</strong></p>
<ul>
<li><p>可以指定使用系统表空间还是独立表空间来存储数据，这个功能由启动参数<code>innodb_file_per_table</code>控制，比如设置将表数据存储到系统表空间时，配置文件<code>my.cnf</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line">innodb_file_per_table=0 #0：代表使用系统表空间 1：代表使用独立表空间</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>默认情况：ON，即开启使用独立表空间存储表数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;innodb_file_per_table&#x27;;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | ON    |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>说明：<code>innodb_file_per_table</code>参数的修改只对新建表起作用，对已经分配表空间的表不起作用</p>
</li>
<li><p>将已经存储在<strong>系统表空间</strong>中的表数据转移到<strong>独立表空间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table 表名 tablespace [=] innodb_file_per_table;</span><br></pre></td></tr></table></figure>
</li>
<li><p>将已经存储在<strong>独立表空间</strong>中的表数据转移到<strong>系统表空间</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table 表名 tablespace [=] innodb_system;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>其它类型的表空间</strong></p>
<ul>
<li>通用表空间</li>
<li>临时表空间</li>
<li>等等</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>MyISAM存储引擎模式</p>
</blockquote>
<ul>
<li><p>1.表结构</p>
<ul>
<li><p>在存储表结构方面，MyISAM和InnoDB一样，也是在数据目录下对应的数据库子目录下创建了一个专门用于描述表结构的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">表名.frm</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>2.表中的数据和索引</p>
<ul>
<li><p>在MyISAM中的索引全部都是二级索引，该存储引擎的数据和索引是分开存放的。所以在文件系统中也是使用不同的文件来存储数据文件和索引文件，同时表数据都存放在对应的数据库子目录下。假如test表使用MyISAM存储引擎的话，那么在它所在的数据库对应的子目录下会为test表创建三个文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test.frm #存储表结构</span><br><span class="line">test.MYD #存储数据（MYData）</span><br><span class="line">test.MYI #存储索引（MYDIndex）</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>其中test.MYD代表表的数据文件，采用独立表存储模式，每个表对应一个MYD文件；</strong>test.MYI代表表的索引文件，我们为该表创建的索引都会存放到这个文件中</li>
</ul>
</li>
<li><p>举例：创建一个表，使用MyISAM存储引擎</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; create table if not emp2_myisam`(</span><br><span class="line">    -&gt; `id` int not null auto_increment,</span><br><span class="line">    -&gt; `name` varchar(20) not null,</span><br><span class="line">    -&gt; primary key (`id`)</span><br><span class="line">    -&gt; )engine=myisam default charset=utf8;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_dbtest2 |</span><br><span class="line">+-------------------+</span><br><span class="line">| emp2              |</span><br><span class="line">| mp2_myisam        |</span><br><span class="line">+-------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /var/lib/mysql</span><br><span class="line">[root@localhost mysql]# ll</span><br><span class="line">总用量 122920</span><br><span class="line">-rw-r-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span><br><span class="line">drwxr-x---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span><br><span class="line">drwxr-x---. 2 mysql mysql      118 11月 14 16:39 dbtest2</span><br><span class="line">-rw-r-----. 1 mysql mysql      320 11月 14 14:11 ib_buffer_pool</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 14 14:11 ibdata1</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 14 14:11 ib_logfile0</span><br><span class="line">-rw-r-----. 1 mysql mysql 50331648 11月 10 22:06 ib_logfile1</span><br><span class="line">-rw-r-----. 1 mysql mysql 12582912 11月 14 14:11 ibtmp1</span><br><span class="line">drwxr-x---. 2 mysql mysql     4096 11月 10 22:06 mysql</span><br><span class="line">srwxrwxrwx. 1 mysql mysql        0 11月 14 14:11 mysql.sock</span><br><span class="line">-rw-------. 1 mysql mysql        5 11月 14 14:11 mysql.sock.lock</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span><br><span class="line">drwxr-x---. 2 mysql mysql     8192 11月 10 22:06 sys</span><br><span class="line">[root@localhost mysql]# cd dbtest2</span><br><span class="line">[root@localhost dbtest2]# ll</span><br><span class="line">总用量 128</span><br><span class="line">-rw-r-----. 1 mysql mysql    61 11月 11 16:36 db.opt</span><br><span class="line">-rw-r-----. 1 mysql mysql  8594 11月 11 16:37 emp2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql 98304 11月 11 16:38 emp2.ibd</span><br><span class="line">-rw-r-----. 1 mysql mysql  8586 11月 14 16:39 mp2_myisam.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql     0 11月 14 16:39 mp2_myisam.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  1024 11月 14 16:39 mp2_myisam.MYI</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="6-2-2-4-小结"><a href="#6-2-2-4-小结" class="headerlink" title="6.2.2.4 小结"></a>6.2.2.4 小结</h4><p><img src="image-20221114165606939.png" alt="MySQL之性能优化/image-20221114165606939"></p>
<h4 id="6-2-2-5-视图在文件系统中的表示"><a href="#6-2-2-5-视图在文件系统中的表示" class="headerlink" title="6.2.2.5 视图在文件系统中的表示"></a>6.2.2.5 视图在文件系统中的表示</h4><p><strong>视图</strong>其实是<strong>虚拟表</strong>，也就是某个查询语句的一个别名而已，索引存储视图时<strong>不需要存储真实的数据</strong>，只需要把它的结构存储起来就可以了。和表一样，描述视图结构的文件也会被存储到所属数据库对应的子目录下，只会存储一个<strong>视图名.frm</strong>的文件。比如基于<strong>emp2</strong>创建一个视图<strong>emp2_view</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create view emp2_view </span><br><span class="line">    -&gt; as select * from emp2;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_dbtest2 |</span><br><span class="line">+-------------------+</span><br><span class="line">| emp2              |</span><br><span class="line">| emp2_view         |</span><br><span class="line">| mp2_myisam        |</span><br><span class="line">+-------------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost dbtest2]<span class="comment"># ll</span></span><br><span class="line">总用量 132</span><br><span class="line">-rw-r-----. 1 mysql mysql    61 11月 11 16:36 db.opt</span><br><span class="line">-rw-r-----. 1 mysql mysql  8594 11月 11 16:37 emp2.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql 98304 11月 11 16:38 emp2.ibd</span><br><span class="line">-rw-r-----. 1 mysql mysql   482 11月 14 17:02 emp2_view.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql  8586 11月 14 16:39 mp2_myisam.frm</span><br><span class="line">-rw-r-----. 1 mysql mysql     0 11月 14 16:39 mp2_myisam.MYD</span><br><span class="line">-rw-r-----. 1 mysql mysql  1024 11月 14 16:39 mp2_myisam.MYI</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-6-其它文件"><a href="#6-2-2-6-其它文件" class="headerlink" title="6.2.2.6 其它文件"></a>6.2.2.6 其它文件</h4><ul>
<li><strong>服务器进程文件</strong>：每运行一个MySQL服务器程序，都意味着启动一个线程。MySQL服务器会把自己的进程ID写入到一个文件中</li>
<li><strong>服务器日志文件</strong>：在服务器运行过程中，会产生各种各样的日志，比如常规的查询日志、错误日志、二进制日志、redo日志等</li>
<li><strong>默认&#x2F;自动生成的SSL和RSA证书和密钥文件</strong>：主要是为了客户端和服务器安全通信而创建的一些文件</li>
</ul>
<h2 id="6-3-用户和权限管理"><a href="#6-3-用户和权限管理" class="headerlink" title="6.3 用户和权限管理"></a>6.3 用户和权限管理</h2><h3 id="6-3-1-用户管理"><a href="#6-3-1-用户管理" class="headerlink" title="6.3.1 用户管理"></a>6.3.1 用户管理</h3><ul>
<li><p>MySQL用户可以分为<strong>普通用户</strong>和<strong>root用户</strong></p>
</li>
<li><p>root用户是超级管理员，拥有所有权限，包括创建用户、删除用户和修改用户的密码等管理权限</p>
</li>
<li><p>普通用户只拥有被授予的各种权限</p>
</li>
<li><p><strong>MySQL提供了许多语句用来管理用户账户</strong>，这些语句可以用来管理包括登录和退出MySQL服务器、创建用户、删除用户、密码管理和权限管理等内容</p>
</li>
<li><p><strong>MySQL数据库的安全性需要通过账户管理来保证</strong></p>
</li>
</ul>
<h4 id="6-3-1-1-登录MySQL服务器"><a href="#6-3-1-1-登录MySQL服务器" class="headerlink" title="6.3.1.1 登录MySQL服务器"></a>6.3.1.1 登录MySQL服务器</h4><ul>
<li><p>启动MySQL服务后，可以通过mysql命令来登录MySQL服务器，命令如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h hostname|hostIP -P port -u username -p DatabaseName -e &quot;SQL语句&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数：</p>
<ul>
<li>-h 参数：后面接主机名或者主机IP，hostname为主机名，hostIP为主机IP</li>
<li>-P 参数：后面接MySQL服务的端口，通过该参数连接指定的端口。MySQL服务默认端口是3306，不使用该参数时自动连接到3306端口，port为连接的端口号</li>
<li>-u 参数：后面接用户名，username为用户名</li>
<li>-p 参数：会提示输入密码</li>
<li>DatabaseName：指明登录到哪一个数据库中。如果没有该参数，就直接登录到MySQL数据库中，然后可以使用use命令来选择数据库</li>
<li>-e 参数：后面可以直接加SQL语句。登录MySQL服务器以后即可执行这个SQL语句，然后退出MySQL服务器</li>
</ul>
</li>
<li><p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# mysql -h localhost -P 3306 -uroot -p dbtest2 -e &quot;select * from emp2;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+------+----------+</span><br><span class="line">| id   | username |</span><br><span class="line">+------+----------+</span><br><span class="line">|    1 | Tom      |</span><br><span class="line">|    2 | 毕业     |</span><br><span class="line">+------+----------+</span><br><span class="line">[root@localhost /]# </span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-1-2-创建用户"><a href="#6-3-1-2-创建用户" class="headerlink" title="6.3.1.2 创建用户"></a>6.3.1.2 创建用户</h4><ul>
<li><p>当前数据库已有用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information for completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| engine_cost               |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| gtid_executed             |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| innodb_index_stats        |</span><br><span class="line">| innodb_table_stats        |</span><br><span class="line">| ndb_binlog_index          |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| server_cost               |</span><br><span class="line">| servers                   |</span><br><span class="line">| slave_master_info         |</span><br><span class="line">| slave_relay_log_info      |</span><br><span class="line">| slave_worker_info         |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">31 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>官方推荐使用**<code>create user</code>** 语句创建新用户</p>
</li>
<li><p>MySQL8版本移除了<code>PASSWORD</code>加密方法，因此<strong>不推荐</strong>使用<code>INSERT</code>语句直接操作MySQL中的<code>user</code>表增加用户</p>
</li>
<li><p>使用<code>create user</code>语句创建新用户时，<strong>必须有<code>create user</code>权限</strong></p>
</li>
<li><p><code>create user</code>语句会在<code>MySQL.user</code>表中添加一条新记录，<strong>但是新创建的账户没有任何权限</strong></p>
</li>
<li><p>如果添加的账户已存在，<code>create user</code>语句会返回一个错误</p>
</li>
<li><p>基本语法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create user 用户名 [identified by &#x27;密码&#x27;][,用户名 [identified by &#x27;密码&#x27;]];</span><br></pre></td></tr></table></figure>

<ul>
<li>用户名参数表示新建用户的账户，由<strong>用户（User）</strong>和<strong>主机名（Host）</strong>构成</li>
<li>“[]”表示可选，可以指定用户登录时需要密码验证，也可以不指定，这样用户可以直接登录，不安全，不推荐使用。如果指定密码，这里需要使用<code>identified by</code> 指定明文密码值</li>
<li><code>create user</code> 语句可以同时创建多个用户</li>
<li><strong>可以在用户名后添加@’localhost’或者@’%’限制登录主机</strong></li>
</ul>
</li>
<li><p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create user &#x27;yty&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| %         | yty           |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user &#x27;yty2&#x27; identified by &#x27;123456&#x27;,&#x27;yty3&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| %         | yty           |</span><br><span class="line">| %         | yty2          |</span><br><span class="line">| %         | yty3          |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create user &#x27;yty&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">ERROR 1396 (HY000): Operation CREATE USER failed for &#x27;yty&#x27;@&#x27;%&#x27;</span><br><span class="line">mysql&gt; create user &#x27;yty&#x27; @&#x27;localhost&#x27; identified by &#x27;123456&#x27;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| %         | yty           |</span><br><span class="line">| %         | yty2          |</span><br><span class="line">| %         | yty3          |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | yty           |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost /]# mysql -uyty -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show grants;</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| Grants for yty@localhost                |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &#x27;yty&#x27;@&#x27;localhost&#x27; |</span><br><span class="line">+-----------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-1-3-修改用户"><a href="#6-3-1-3-修改用户" class="headerlink" title="6.3.1.3 修改用户"></a>6.3.1.3 修改用户</h4><p>修改用户名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">update mysql.user set user=&#x27;newName&#x27; where user=oldName&#x27;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update mysql.user set user=&#x27;ytyNew&#x27; where user=&#x27;yty&#x27;;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 2  Changed: 2  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select host,user from mysql.user;</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| host      | user          |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">| %         | root          |</span><br><span class="line">| %         | yty2          |</span><br><span class="line">| %         | yty3          |</span><br><span class="line">| %         | ytyNew        |</span><br><span class="line">| localhost | mysql.session |</span><br><span class="line">| localhost | mysql.sys     |</span><br><span class="line">| localhost | ytyNew        |</span><br><span class="line">+-----------+---------------+</span><br><span class="line">7 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uytyNew -p</span><br><span class="line">Enter password: </span><br><span class="line">ERROR 1045 (28000): Access denied for user &#x27;ytyNew&#x27;@&#x27;localhost&#x27; (using password: YES)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -uytyNew -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 5.7.19 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure>

<h4 id="6-3-1-4-删除用户"><a href="#6-3-1-4-删除用户" class="headerlink" title="6.3.1.4 删除用户"></a>6.3.1.4 删除用户</h4><blockquote>
<p>方式一：使用<code>drop user</code>方式删除（推荐）</p>
</blockquote>
<ul>
<li><p>使用<code>drop user</code>方式删除用户时，必须要有<code>drop user</code>权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> 用户名<span class="number">1</span>,用户名<span class="number">2</span>,...; #默认删除host为<span class="operator">%</span>的用户</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty3          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> yty3;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> ytyNew;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> ytyNew;</span><br><span class="line">ERROR <span class="number">1396</span> (HY000): Operation <span class="keyword">DROP</span> <span class="keyword">USER</span> failed <span class="keyword">for</span> <span class="string">&#x27;ytyNew&#x27;</span>@<span class="string">&#x27;%&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> ytyNew        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;ytyNew&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span> <span class="keyword">from</span> mysql.user;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>方式二：使用<code>delete</code>方式删除</p>
</blockquote>
<ul>
<li><p>可以使用<code>delete</code>语句直接将用户信息从<code>mysql.user</code>表中删除，但必须要有对<code>mysql.user</code>表的delete的权限</p>
</li>
<li><p><code>delete</code>语句基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> host<span class="operator">=</span><span class="string">&#x27;hostname&#x27;</span> <span class="keyword">and</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;username&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>host字段和user字段是<strong>user表</strong>的联合主键，因此<strong>两个字段的值确定才能唯一确定一条记录</strong></li>
</ul>
</li>
<li><p>执行完<code>delete</code>命令需要使用<code>flush</code>命令使用户生效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>注意：不推荐使用<code>delete</code>进行删除用户，系统会有残留信息保留，而<code>drop user</code>命令会删除用户以及对应的权限，执行命令会发现<code>mysql.user</code>表和<code>mysql.db</code>表的相应记录都消失了</p>
</blockquote>
<h4 id="6-3-1-5-设置当前用户密码"><a href="#6-3-1-5-设置当前用户密码" class="headerlink" title="6.3.1.5 设置当前用户密码"></a>6.3.1.5 设置当前用户密码</h4><ul>
<li><p>适用于root用户修改自己密码，以及普通用户登录后修改自己的密码</p>
</li>
<li><p>root用户拥有很高的权限，因此必须保证root用户的密码安全</p>
</li>
<li><p>root用户可以通过多种方法来修改密码</p>
<ul>
<li>使用 <code>alter user</code>修改用户密码（<strong>MySQL官方推荐</strong>）</li>
<li>通过set语句修改密码</li>
<li>由于MySQL8已经移除了<code>PASSWORD()</code>函数，因此不再使用<code>update</code>语句直接操作用户表修改密码</li>
</ul>
</li>
<li><p>旧的写法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#修改当前用户的密码：（MySQL5<span class="number">.7</span>侧式有效）</span><br><span class="line"><span class="keyword">set</span> password<span class="operator">=</span>password(<span class="string">&#x27;新密码&#x27;</span>)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> password<span class="operator">=</span>password(<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>1.使用alter user命令修改当前用户密码</p>
</blockquote>
<ul>
<li><p>用户可以使用alter命令来修改自身密码，如下语句代表修改当前登录用户的密码，基本语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="keyword">user</span>() identified <span class="keyword">by</span> <span class="string">&#x27;新密码&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：修改yty2用户的密码，改为’abc123’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>p123456</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> <span class="keyword">user</span>() identified <span class="keyword">by</span> <span class="string">&#x27;abc123&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> exit;</span><br><span class="line">Bye</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>p123456</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabc123</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">10</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>2.使用set语句来修改当前用户密码</p>
</blockquote>
<ul>
<li><p>基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> password<span class="operator">=</span><span class="string">&#x27;新密码&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>该语句会自动将密码加密后再赋值给当前用户</strong></p>
</li>
<li><p>举例：将yty2用户密码修改为’123456’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabc123</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">11</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> password<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> exit;</span><br><span class="line">Bye</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabc123</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>p123456</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">13</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> host,<span class="keyword">user</span>,authentication_string <span class="keyword">from</span> <span class="keyword">user</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> host      <span class="operator">|</span> <span class="keyword">user</span>          <span class="operator">|</span> authentication_string                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> root          <span class="operator">|</span> <span class="operator">*</span><span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.session <span class="operator">|</span> <span class="operator">*</span>THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> localhost <span class="operator">|</span> mysql.sys     <span class="operator">|</span> <span class="operator">*</span>THISISNOTAVALIDPASSWORDTHATCANBEUSEDHERE <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="operator">%</span>         <span class="operator">|</span> yty2          <span class="operator">|</span> <span class="operator">*</span><span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+---------------+-------------------------------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-1-6-修改其他用户密码"><a href="#6-3-1-6-修改其他用户密码" class="headerlink" title="6.3.1.6 修改其他用户密码"></a>6.3.1.6 修改其他用户密码</h4><ul>
<li>root用户不仅可以修改自己的密码，还可以修改其它普通用户的密码</li>
<li>root用户登录MySQL服务器后，可以通过alter语句和set语句来修改普通用户的密码</li>
<li>由于PASSWORD()函数已经移除，因此直接使用update修改用户表的方式不再使用</li>
</ul>
<blockquote>
<p>1.使用alter语句来修改普通用户的密码</p>
</blockquote>
<ul>
<li><p>基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;username&#x27;</span> @ <span class="string">&#x27;hostname&#x27;</span> [identified <span class="keyword">by</span> <span class="string">&#x27;新密码&#x27;</span>] [,<span class="string">&#x27;username&#x27;</span> @ <span class="string">&#x27;hostname&#x27;</span> [identified <span class="keyword">by</span> <span class="string">&#x27;新密码&#x27;</span>]]...;</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：root用户修改yty2密码为’abcabc’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uroot <span class="operator">-</span>p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">14</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;abcabc&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>p123456</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabcabc</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">16</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>2.使用set命令修改普通用户的密码</p>
</blockquote>
<ul>
<li><p>基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> <span class="string">&#x27;username&#x27;</span> @ <span class="string">&#x27;hostname&#x27;</span><span class="operator">=</span><span class="string">&#x27;新密码&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：修改yty2密码为’abc123’</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> password <span class="keyword">for</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span><span class="operator">=</span><span class="string">&#x27;abc123&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabcabc</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">ERROR <span class="number">1045</span> (<span class="number">28000</span>): Access denied <span class="keyword">for</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> (<span class="keyword">using</span> password: YES)</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysql <span class="operator">-</span>uyty2 <span class="operator">-</span>pabc123</span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">18</span></span><br><span class="line">Server version: <span class="number">5.7</span><span class="number">.19</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its affiliates. <span class="keyword">All</span> rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span><span class="operator">/</span><span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">&#x27;help;&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;\h&#x27;</span> <span class="keyword">for</span> help. Type <span class="string">&#x27;\c&#x27;</span> <span class="keyword">to</span> clear the <span class="keyword">current</span> input statement.</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> </span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>3.使用update修改普通用户密码（不推荐）</p>
</blockquote>
<ul>
<li><p>基本语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> authentication_string<span class="operator">=</span>password(<span class="string">&#x27;新密码&#x27;</span>)</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;username&#x27;</span> <span class="keyword">and</span> host<span class="operator">=</span><span class="string">&#x27;hostname&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>PASSWORD()</code>函数为明文密码加密，但MySQL8移除了此函数，所有不推荐使用update修改密码</strong></p>
</li>
</ul>
<h4 id="6-3-1-7-MySQL8密码管理"><a href="#6-3-1-7-MySQL8密码管理" class="headerlink" title="6.3.1.7 MySQL8密码管理"></a>6.3.1.7 MySQL8密码管理</h4><ul>
<li>MySQL中记录使用过的历史密码，目前包含如下密码管理功能：<ul>
<li>(1) 密码过期：要求定期修改密码</li>
<li>(2) 密码重用限制：不允许使用旧密码</li>
<li>(3) 密码强度评估：要求使用高强度的密码</li>
</ul>
</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">提示</span><br><span class="line">MySQL密码管理功能只针对使用基于MySQL授权插件的账号，这些插件有mysql<span class="built_in">_</span>native<span class="built_in">_</span>password,sha256<span class="built_in">_</span>password和caching<span class="built_in">_</span>sha2<span class="built_in">_</span>password</span><br></pre></td></tr></table></figure>

<blockquote>
<p>密码过期策略</p>
</blockquote>
<ul>
<li><p>在MySQL中，数据库管理员可以<strong>手动设置</strong>账号密码过期，也可以建立一个<strong>自动</strong>密码过期策略</p>
</li>
<li><p>过期策略可以使全局的，也可以为<strong>每个账号</strong>设置单独的过期策略</p>
</li>
<li><p>手动设置立马过期</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">USER</span> username PASSWORD EXPIRE;</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动设置指定时间过期方式一：全局</p>
<ul>
<li><p>MySQL使用<code>default_password_lifetime</code>系统变量<strong>建立全局密码过期策略</strong></p>
</li>
<li><p>默认值是0，表示禁止自动密码过期</p>
</li>
<li><p>允许值为正整数N，表示允许的密码生存期，密码必须每隔N天进行修改</p>
</li>
<li><p><strong>方式一：使用SQL语句修改变量的值并持久化</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> persist default_password_lifetime<span class="operator">=</span>N; #建立全局策略，设置密码每隔N天过期</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>方式二：配置文件my.cnf中进行维护</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">default_password_lifetime</span>=<span class="string">N; #建立全局策略，设置密码每隔N天过期</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>手动设置指定时间过期方式二：单独设置</p>
<ul>
<li><p>每个账号即可<strong>延用全局密码过期策略，也可以单独设置策略</strong></p>
</li>
<li><p>在<code>create user</code>和<code>alter user</code>语句上加入<code>PASSWORD EXPIRE</code>选项可实现单独设置策略</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#设置yty2账号密码每隔<span class="number">80</span>天过期</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire <span class="type">interval</span> <span class="number">80</span> <span class="keyword">day</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire <span class="type">interval</span> <span class="number">80</span> <span class="keyword">day</span>;</span><br><span class="line"></span><br><span class="line">#设置密码永不过期</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire never;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire never;</span><br><span class="line"></span><br><span class="line">#延用全局密码过期策略</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password expire <span class="keyword">default</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<p>密码重用策略</p>
</blockquote>
<ul>
<li><p>MySQL限制使用已用过的密码，重用限制策略基于<strong>密码更改的数量</strong>和<strong>使用的时间</strong></p>
</li>
<li><p>重用策略可以是<strong>全局的</strong>，也可以为每个账号设置<strong>单独的策略</strong></p>
</li>
<li><p>账号的历史密码包含过去改账号所使用的密码。MySQL基于以下规则来限制密码重用：</p>
<ul>
<li>如果账号的密码限制<strong>基于密码更改的数量</strong>，那么新密码不能从最近限制的密码数量中选择。例如，如果密码更改的最小值为3，那么新密码不能与最近3个密码中任何一个相同</li>
<li>如果账号密码限制<strong>基于时间</strong>，那么新密码不能从规定时间内选择。例如，如果密码重用周期为60天，那么密码就不能从最近60天内使用的密码中选择</li>
</ul>
</li>
<li><p>MySQL使用<code>password_history</code>和<code>password_reuse_interval</code>系统变量设置密码重用策略</p>
<ul>
<li><code>password_history</code>：规定密码重用的数量</li>
<li><code>password_reuse_interval</code>：规定密码重用的周期</li>
</ul>
</li>
<li><p>这两个值可在服务器的<strong>配置文件中进行维护</strong>，也可以在运行期间<strong>使用SQL语句更改该变量的值并持久化</strong></p>
</li>
<li><p>手动设置密码重用方式1：全局</p>
<ul>
<li><p>方式一：使用SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> persist password_history<span class="operator">=</span><span class="number">6</span>; #设置不能选择最近使用过的<span class="number">6</span>个密码</span><br><span class="line"><span class="keyword">set</span> persist password_reuse_interval<span class="operator">=</span><span class="number">365</span>; #设置不能选择最近一年的密码</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：my.cnf配置文件</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">password_history</span>=<span class="string">6</span></span><br><span class="line"><span class="attr">password_reuse_interval</span>=<span class="string">365</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>手动设置密码重用方式2：单独设置</p>
<ul>
<li>每个账号可以延用全局密码重用策略，也可以单独设置策略</li>
<li>这两个可以单独使用，也可以结合在一起使用</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#设置yty2账号密码不能使用最近<span class="number">5</span>个密码</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="number">5</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">#不能使用最近一年的密码</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password reuse <span class="type">interval</span> <span class="number">365</span> <span class="keyword">day</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password reuse <span class="type">interval</span> <span class="number">365</span> <span class="keyword">day</span>;</span><br><span class="line"></span><br><span class="line">#设置yty2账号密码不能使用最近<span class="number">5</span>个密码，也不能使用最近一年的密码</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="number">5</span> password reuse <span class="type">interval</span> <span class="number">365</span> <span class="keyword">day</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="number">5</span> password reuse <span class="type">interval</span> <span class="number">365</span> <span class="keyword">day</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#延用全局策略</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="keyword">default</span> password reuse <span class="type">interval</span> <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> password history <span class="keyword">default</span> password reuse <span class="type">interval</span> <span class="keyword">default</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-3-2-权限管理"><a href="#6-3-2-权限管理" class="headerlink" title="6.3.2 权限管理"></a>6.3.2 权限管理</h3><h4 id="6-3-2-1-权限列表"><a href="#6-3-2-1-权限列表" class="headerlink" title="6.3.2.1 权限列表"></a>6.3.2.1 权限列表</h4><ul>
<li><p>MySQL用户有哪些权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> privileges;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------------------------------------+-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Privilege               <span class="operator">|</span> Context                               <span class="operator">|</span> Comment                                               <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------------------------------------+-------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Alter</span>                   <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">alter</span> the <span class="keyword">table</span>                                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Alter</span> routine           <span class="operator">|</span> Functions,Procedures                  <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">alter</span> <span class="keyword">or</span> <span class="keyword">drop</span> stored functions<span class="operator">/</span>procedures          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span>                  <span class="operator">|</span> Databases,Tables,Indexes              <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span> <span class="keyword">new</span> databases <span class="keyword">and</span> tables                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span> routine          <span class="operator">|</span> Databases                             <span class="operator">|</span> <span class="keyword">To</span> use <span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span><span class="operator">/</span><span class="keyword">PROCEDURE</span>                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span> temporary tables <span class="operator">|</span> Databases                             <span class="operator">|</span> <span class="keyword">To</span> use <span class="keyword">CREATE</span> TEMPORARY <span class="keyword">TABLE</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">view</span>             <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span> <span class="keyword">new</span> views                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">user</span>             <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span> <span class="keyword">new</span> users                                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Delete</span>                  <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">delete</span> existing <span class="keyword">rows</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Drop</span>                    <span class="operator">|</span> Databases,Tables                      <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">drop</span> databases, tables, <span class="keyword">and</span> views                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Event                   <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span>, <span class="keyword">alter</span>, <span class="keyword">drop</span> <span class="keyword">and</span> <span class="keyword">execute</span> events             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Execute</span>                 <span class="operator">|</span> Functions,Procedures                  <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">execute</span> stored routines                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> File                    <span class="operator">|</span> File access <span class="keyword">on</span> server                 <span class="operator">|</span> <span class="keyword">To</span> read <span class="keyword">and</span> write files <span class="keyword">on</span> the server                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Grant</span> option            <span class="operator">|</span> Databases,Tables,Functions,Procedures <span class="operator">|</span> <span class="keyword">To</span> give <span class="keyword">to</span> other users those privileges you possess   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Index                   <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">drop</span> indexes                             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Insert</span>                  <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">insert</span> data <span class="keyword">into</span> tables                            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Lock tables             <span class="operator">|</span> Databases                             <span class="operator">|</span> <span class="keyword">To</span> use LOCK TABLES (together <span class="keyword">with</span> <span class="keyword">SELECT</span> privilege)   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Process                 <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">view</span> the plain text <span class="keyword">of</span> currently executing queries <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Proxy                   <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> make proxy <span class="keyword">user</span> possible                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">References</span>              <span class="operator">|</span> Databases,Tables                      <span class="operator">|</span> <span class="keyword">To</span> have <span class="keyword">references</span> <span class="keyword">on</span> tables                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Reload                  <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> reload <span class="keyword">or</span> refresh tables, logs <span class="keyword">and</span> privileges      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Replication client      <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> ask <span class="keyword">where</span> the slave <span class="keyword">or</span> master servers <span class="keyword">are</span>          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Replication slave       <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> read <span class="type">binary</span> log events <span class="keyword">from</span> the master             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Select</span>                  <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> retrieve <span class="keyword">rows</span> <span class="keyword">from</span> <span class="keyword">table</span>                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Show</span> databases          <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> see <span class="keyword">all</span> databases <span class="keyword">with</span> <span class="keyword">SHOW</span> DATABASES              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Show</span> <span class="keyword">view</span>               <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> see views <span class="keyword">with</span> <span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">VIEW</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Shutdown                <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> shut down the server                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Super                   <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> use KILL thread, <span class="keyword">SET</span> <span class="keyword">GLOBAL</span>, CHANGE MASTER, etc.   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Trigger</span>                 <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> use triggers                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Create</span> <span class="keyword">table</span>space       <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">create</span><span class="operator">/</span><span class="keyword">alter</span><span class="operator">/</span><span class="keyword">drop</span> tablespaces                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">Update</span>                  <span class="operator">|</span> Tables                                <span class="operator">|</span> <span class="keyword">To</span> <span class="keyword">update</span> existing <span class="keyword">rows</span>                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Usage                   <span class="operator">|</span> Server Admin                          <span class="operator">|</span> <span class="keyword">No</span> privileges <span class="operator">-</span> allow <span class="keyword">connect</span> <span class="keyword">only</span>                    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------------------------------------+-------------------------------------------------------+</span></span><br><span class="line"><span class="number">31</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>MySQL的权限分布：</p>
<table>
<thead>
<tr>
<th>权限分布</th>
<th>可能的设置的权限</th>
</tr>
</thead>
<tbody><tr>
<td>表权限</td>
<td>select,insert,update,delete,create,drop,grant,references,index,alter</td>
</tr>
<tr>
<td>列权限</td>
<td>select,insert,update,references</td>
</tr>
<tr>
<td>过程权限</td>
<td>excute,alter,routine,grant</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="6-3-2-2-授予权限的原则"><a href="#6-3-2-2-授予权限的原则" class="headerlink" title="6.3.2.2 授予权限的原则"></a>6.3.2.2 授予权限的原则</h4><ul>
<li>只授予<strong>满足需求的最小权限</strong></li>
<li>创建用户的时候<strong>限制用户的登录主机</strong>，一般限制成指定IP或者内网IP</li>
<li>为每个用户<strong>设置满足密码复杂度的密码</strong></li>
<li><strong>定期清理不需要的用户</strong>，回收权限或者删除用户</li>
</ul>
<h4 id="6-3-2-3-授予权限"><a href="#6-3-2-3-授予权限" class="headerlink" title="6.3.2.3 授予权限"></a>6.3.2.3 授予权限</h4><ul>
<li><p>给用户授权有2种方式：</p>
<ul>
<li>通过把<strong>角色赋予用户给用户授权</strong></li>
<li><strong>直接给用户授权</strong></li>
</ul>
</li>
<li><p>用户是数据库的使用者，可以通过给用户授予访问数据库中资源的限制，来控制使用者对数据库的访问，消除安全隐患</p>
</li>
<li><p>授权命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,...,权限n <span class="keyword">on</span> 数据库名称.表名 <span class="keyword">to</span> 用户名@用户地址 [identified <span class="keyword">by</span> <span class="string">&#x27;密码口令&#x27;</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>该权限如果发现没有用户，则会直接创建一个用户</strong></p>
</li>
<li><p>举例：</p>
<ul>
<li><p>给yty2用户授予dbtest2数据库所有表的增删改查的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> yty2@<span class="operator">%</span>                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">delete</span>,<span class="keyword">update</span> <span class="keyword">on</span> dbtest2.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> yty2@<span class="operator">%</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> USAGE <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> `dbtest2`.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>赋予yty2用户所有权限，但是不包括grant权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">grant</span> <span class="keyword">all</span> privileges <span class="keyword">on</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">to</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> yty2@<span class="operator">%</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> `dbtest2`.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#root用户权限</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> root@<span class="operator">%</span>                                           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="keyword">WITH</span> <span class="keyword">GRANT</span> OPTION <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果想要<strong>赋予grant权限</strong>，添加参数<code>with grant option</code>即可</li>
</ul>
</li>
</ul>
</li>
<li><p>多次赋予用户权限，<strong>权限会叠加</strong>而不是覆盖</p>
</li>
</ul>
<h4 id="6-3-2-4-查看权限"><a href="#6-3-2-4-查看权限" class="headerlink" title="6.3.2.4 查看权限"></a>6.3.2.4 查看权限</h4><ul>
<li><p>查看当前用户权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants;</span><br><span class="line"># 或</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="built_in">current_user</span>;</span><br><span class="line"># 或</span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="built_in">current_user</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看某用户的全部权限：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;username&#x27;</span>@<span class="string">&#x27;hostname&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-2-5-收回权限"><a href="#6-3-2-5-收回权限" class="headerlink" title="6.3.2.5 收回权限"></a>6.3.2.5 收回权限</h4><ul>
<li><p>MySQL使用<code>revoke</code>语句取消用户的某些权限</p>
</li>
<li><p>使用<code>revoke</code>回收权限之后，用户账户的记录将从db，host，table_priv和columns_priv表中删除，但是用户账户仍然在<strong>user表</strong>中保存（删除user表中的账户记录使用<code>drop user</code>语句）</p>
</li>
<li><p>注意：在将用户账户从user表删除之前，应该收回相应用户的所有权限</p>
</li>
<li><p>收回权限命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,...,权限n <span class="keyword">on</span> 数据库名称.表名 <span class="keyword">from</span> 用户名@用户地址;</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：收回yty2用户dbtest2数据库所有表的增删改查的权限</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> yty2@<span class="operator">%</span>                                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> <span class="keyword">ON</span> `dbtest2`.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">revoke</span> <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span> <span class="keyword">on</span> dbtest2.<span class="operator">*</span> <span class="keyword">from</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Grants <span class="keyword">for</span> yty2@<span class="operator">%</span>                         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> <span class="operator">*</span>.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;yty2&#x27;</span>@<span class="string">&#x27;%&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-3-3-权限表"><a href="#6-3-3-权限表" class="headerlink" title="6.3.3 权限表"></a>6.3.3 权限表</h3><ul>
<li><p>MySQL服务器通过<strong>权限表</strong>来<strong>控制用户对数据库的访问</strong>，权限表存放在<strong>mysql数据库</strong>中</p>
</li>
<li><p>MySQL数据库系统会根据这些权限表的内容为每一个用户赋予相应的权限</p>
</li>
<li><p>这些权限表中最重要的是<strong>user表</strong>、<strong>db表</strong>。除此之外还有，<strong>table_priv表、column_priv表</strong>和<strong>proc_priv表</strong>等</p>
</li>
<li><p><strong>在MySQL启动时，服务器将这些数据库表中权限信息的内容读入内存</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use mysql;</span><br><span class="line">Reading <span class="keyword">table</span> information <span class="keyword">for</span> completion <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">and</span> <span class="keyword">column</span> names</span><br><span class="line">You can turn off this feature <span class="keyword">to</span> <span class="keyword">get</span> a quicker startup <span class="keyword">with</span> <span class="operator">-</span>A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_mysql           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="operator">|</span> columns_priv              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> db                        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> engine_cost               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> event                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> func                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> general_log               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> gtid_executed             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> help_category             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> help_keyword              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> help_relation             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> help_topic                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_index_stats        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> innodb_table_stats        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ndb_binlog_index          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> plugin                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> proc                      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> procs_priv                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> proxies_priv              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> server_cost               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> servers                   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_master_info         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_relay_log_info      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slave_worker_info         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_log                  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> tables_priv               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_zone                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_zone_leap_second     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_zone_name            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_zone_transition      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> time_zone_transition_type <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">user</span>                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+</span></span><br><span class="line"><span class="number">31</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-3-1-user表"><a href="#6-3-3-1-user表" class="headerlink" title="6.3.3.1 user表"></a>6.3.3.1 user表</h4><p><img src="image-20221115202538135.png" alt="MySQL之性能优化/image-20221115202538135"></p>
<p><img src="image-20221115202849458.png" alt="MySQL之性能优化/image-20221115202849458"></p>
<h4 id="6-3-3-2-db表"><a href="#6-3-3-2-db表" class="headerlink" title="6.3.3.2 db表"></a>6.3.3.2 db表</h4><p><img src="image-20221115202746642.png" alt="MySQL之性能优化/image-20221115202746642"></p>
<h4 id="6-3-3-3-tables-priv表和columns-priv表"><a href="#6-3-3-3-tables-priv表和columns-priv表" class="headerlink" title="6.3.3.3 tables_priv表和columns_priv表"></a>6.3.3.3 tables_priv表和columns_priv表</h4><p><img src="image-20221115202942712.png" alt="MySQL之性能优化/image-20221115202942712"></p>
<p><img src="image-20221115203053748.png" alt="MySQL之性能优化/image-20221115203053748"></p>
<h4 id="6-3-3-4-procs-priv表"><a href="#6-3-3-4-procs-priv表" class="headerlink" title="6.3.3.4 procs_priv表"></a>6.3.3.4 procs_priv表</h4><p><img src="image-20221115203208318.png" alt="MySQL之性能优化/image-20221115203208318"></p>
<h3 id="6-3-4-访问控制"><a href="#6-3-4-访问控制" class="headerlink" title="6.3.4 访问控制"></a>6.3.4 访问控制</h3><p><img src="image-20221115203430082.png" alt="MySQL之性能优化/image-20221115203430082"></p>
<h4 id="6-3-4-1-连接核实阶段"><a href="#6-3-4-1-连接核实阶段" class="headerlink" title="6.3.4.1 连接核实阶段"></a>6.3.4.1 连接核实阶段</h4><p><img src="image-20221115203349545.png" alt="MySQL之性能优化/image-20221115203349545"></p>
<h4 id="6-3-4-2-请求核实阶段"><a href="#6-3-4-2-请求核实阶段" class="headerlink" title="6.3.4.2 请求核实阶段"></a>6.3.4.2 请求核实阶段</h4><p><img src="image-20221115203535275.png" alt="MySQL之性能优化/image-20221115203535275"></p>
<p><img src="image-20221115203626010.png" alt="MySQL之性能优化/image-20221115203626010"></p>
<p><img src="image-20221115203656245.png" alt="MySQL之性能优化/image-20221115203656245"></p>
<h3 id="6-3-5-角色管理"><a href="#6-3-5-角色管理" class="headerlink" title="6.3.5 角色管理"></a>6.3.5 角色管理</h3><h4 id="6-3-5-1-角色的理解"><a href="#6-3-5-1-角色的理解" class="headerlink" title="6.3.5.1 角色的理解"></a>6.3.5.1 角色的理解</h4><ul>
<li><strong>角色是在MySQL8.0中引入的新功能</strong></li>
<li>在MySQL中，<strong>角色是权限的集合</strong>，可以为角色添加或移除权限</li>
<li>用户可以被授予角色，同时也被赋予角色包含的权限</li>
<li>对角色进行操作需要较高的权限，并且像用户账户一样，角色可以拥有授予和撤销的权限</li>
<li>引入角色的目的：<strong>方便管理拥有相同权限的用户</strong></li>
</ul>
<h4 id="6-3-5-2-创建角色"><a href="#6-3-5-2-创建角色" class="headerlink" title="6.3.5.2 创建角色"></a>6.3.5.2 创建角色</h4><ul>
<li><p>当用户数量过多时，为了避免单独给每一个用户授予多个权限，可以先将权限集合放入到角色中，再赋予用户相应的角色</p>
</li>
<li><p>创建角色使用create role语句，语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> role <span class="string">&#x27;role_name&#x27;</span> [@<span class="string">&#x27;host_name&#x27;</span>] [,<span class="string">&#x27;role_name&#x27;</span> [@<span class="string">&#x27;host_name&#x27;</span>]]...;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果host_name省略，默认为%，role_name不可省略</li>
</ul>
</li>
<li><p>举例：创建一个经理的角色：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> role <span class="string">&#x27;manager&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里创建了一个角色，角色名称是manager，角色可以登录的主机是localhost，意思是只能从数据库服务器运行的这台计算机登录这个账号</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> role <span class="string">&#x27;manager&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不写主机名，MySQL默认是通配符%，意思是这个账号可以从任何一台计算机上登录数据库</li>
</ul>
</li>
</ul>
<h4 id="6-3-5-3-给权限赋予角色"><a href="#6-3-5-3-给权限赋予角色" class="headerlink" title="6.3.5.3 给权限赋予角色"></a>6.3.5.3 给权限赋予角色</h4><ul>
<li><p>创建角色之后，默认这个角色没有任何权限，需要给角色授权：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> privileges <span class="keyword">on</span> table_name <span class="keyword">to</span> <span class="string">&#x27;role_name&#x27;</span>[@<span class="string">&#x27;host_name&#x27;</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>privileges代表权限的名称，多个权限用逗号隔开，可以用show语句查询权限名称</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> privileges;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="6-3-5-4-查看角色权限"><a href="#6-3-5-4-查看角色权限" class="headerlink" title="6.3.5.4 查看角色权限"></a>6.3.5.4 查看角色权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> <span class="string">&#x27;角色名&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-5-5-回收角色权限"><a href="#6-3-5-5-回收角色权限" class="headerlink" title="6.3.5.5 回收角色权限"></a>6.3.5.5 回收角色权限</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> 权限<span class="number">1</span>,权限<span class="number">2</span>,...,权限n <span class="keyword">on</span> tablename <span class="keyword">from</span> <span class="string">&#x27;角色名&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-5-6-删除角色"><a href="#6-3-5-6-删除角色" class="headerlink" title="6.3.5.6 删除角色"></a>6.3.5.6 删除角色</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> role role1 [,role2]...;</span><br></pre></td></tr></table></figure>

<h4 id="6-3-5-7-给用户赋予角色"><a href="#6-3-5-7-给用户赋予角色" class="headerlink" title="6.3.5.7 给用户赋予角色"></a>6.3.5.7 给用户赋予角色</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> role [,role2,...] <span class="keyword">to</span> <span class="keyword">user</span> [,user2,...];</span><br></pre></td></tr></table></figure>

<h4 id="6-3-5-8-激活角色"><a href="#6-3-5-8-激活角色" class="headerlink" title="6.3.5.8 激活角色"></a>6.3.5.8 激活角色</h4><ul>
<li><p>查看当前会话被激活的角色：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">current_role</span>();</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式一：使用<code>set default role</code>命令激活角色</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">DEFAULT</span> ROLE <span class="string">&#x27;角色名&#x27;</span> <span class="keyword">TO</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名	&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>注意：用户需要退出重新登录，才能看到赋予的角色</strong></li>
</ul>
</li>
<li><p>方式二：将<code>active_all_roles_on_login</code>设置为ON</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> activate_all_roles_on_login<span class="operator">=</span><span class="keyword">ON</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>对所有角色永久激活</strong></li>
</ul>
</li>
</ul>
<h4 id="6-3-5-9-撤销用户的角色"><a href="#6-3-5-9-撤销用户的角色" class="headerlink" title="6.3.5.9 撤销用户的角色"></a>6.3.5.9 撤销用户的角色</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">revoke</span> <span class="string">&#x27;角色名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span> <span class="keyword">from</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>重新登录才能生效</strong></li>
</ul>
<h4 id="6-3-5-10-设置强制角色"><a href="#6-3-5-10-设置强制角色" class="headerlink" title="6.3.5.10 设置强制角色"></a>6.3.5.10 设置强制角色</h4><ul>
<li><p>强制角色是给每个创建账户的默认角色，不需要手动设置</p>
</li>
<li><p><strong>强制角色无法被revoke或者drop</strong></p>
</li>
<li><p>方式一：服务启动前设置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">mandatory_roles</span>=<span class="string">&#x27;role1,role2@localhost,role3@%&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二：运行时设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> persist mandatory_roles<span class="operator">=</span><span class="string">&#x27;role1,role2@localhost,role3@%&#x27;</span>; #系统重启后仍然生效</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> mandatory_roles<span class="operator">=</span><span class="string">&#x27;role1,role2@localhost,role3@%&#x27;</span>; #系统重启之后失效</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-5-11-小结"><a href="#6-3-5-11-小结" class="headerlink" title="6.3.5.11 小结"></a>6.3.5.11 小结</h4><p><img src="image-20221115214516086.png" alt="MySQL之性能优化/image-20221115214516086"></p>
<h3 id="6-3-6-配置文件的使用"><a href="#6-3-6-配置文件的使用" class="headerlink" title="6.3.6 配置文件的使用"></a>6.3.6 配置文件的使用</h3><h4 id="6-3-6-1-配置文件格式"><a href="#6-3-6-1-配置文件格式" class="headerlink" title="6.3.6.1 配置文件格式"></a>6.3.6.1 配置文件格式</h4><ul>
<li>与命令行中指定启动选项不同的是，配置文件中的启动选项被划分为若干个组，每个组有一个组名，用中括号**[]**括起来，像这样：</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqld_safe]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[client]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysql]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqladmin]</span></span><br><span class="line"><span class="attr">(具体的启动选项...)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>每个组下边可以定义若干个启动选项，以[server]为例：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">option1</span>				<span class="string">#这是option1，该选项不需要选项值</span></span><br><span class="line"><span class="attr">option2</span>=<span class="string">value2		#这是option2，该选项需要选项值</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-3-6-2-启动命令和选项组"><a href="#6-3-6-2-启动命令和选项组" class="headerlink" title="6.3.6.2 启动命令和选项组"></a>6.3.6.2 启动命令和选项组</h4><ul>
<li><p>配置文件中不同的选项组是给不同的启动命令使用的。不过有两个选项组比较特别：</p>
<ul>
<li><strong>[server]<strong>组下边的启动选项将用于</strong>所有的服务器程序</strong></li>
<li><strong>[client]<strong>组下边的启动选项将用于</strong>所有的客户端程序</strong></li>
</ul>
</li>
<li><p>下边是启动命令能读取的选项组有哪些：</p>
<table>
<thead>
<tr>
<th>启动命令</th>
<th>类别</th>
<th>能读取的组</th>
</tr>
</thead>
<tbody><tr>
<td>mysqld</td>
<td>启动服务器</td>
<td>[mysqld]、[server]</td>
</tr>
<tr>
<td>mysqld_safe</td>
<td>启动服务器</td>
<td>[mysqld]、[server]、[mysqld_safe]</td>
</tr>
<tr>
<td>mysql.server</td>
<td>启动服务器</td>
<td>[mysqld]、[server]、[mysqld.server]</td>
</tr>
<tr>
<td>mysql</td>
<td>启动客户端</td>
<td>[mysql]、[client]</td>
</tr>
<tr>
<td>mysqladmin</td>
<td>启动客户端</td>
<td>[mysqladmin]、[client]</td>
</tr>
<tr>
<td>mysqldump</td>
<td>启动客户端</td>
<td>[mysqldump]、[client]</td>
</tr>
</tbody></table>
</li>
<li><p>比如，在**&#x2F;etc&#x2F;mysql&#x2F;my.cnf**这个配置文件中添加一些内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">skip-networking</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=<span class="string">MyISAM</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后直接使用mysqld启动服务器程序：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld</span><br></pre></td></tr></table></figure>
</li>
<li><p>虽然在命令行没有添加启动选项，但是在程序启动的时候，就会默认的到上边提到的配置文件路径下查找配置文件，其中就包括**&#x2F;etc&#x2F;my.cnf<strong>。又由于mysqld命令可以读取</strong>[server]**选项组的内容，所以<code>skip-networking</code>和<code>default-storage-engine=MyISAM</code>这两个选项是生效的。如果放在[client]选项组下就不会生效</p>
</li>
</ul>
<h4 id="6-3-6-3-特定MySQL版本的专用选项组"><a href="#6-3-6-3-特定MySQL版本的专用选项组" class="headerlink" title="6.3.6.3 特定MySQL版本的专用选项组"></a>6.3.6.3 特定MySQL版本的专用选项组</h4><p>我们可以在选项组的名称后面添加上特定的<strong>MySQL版本号</strong>，比如对于**[mysqld]<strong>选项组来说，可以定义一个</strong>[mysqld-5.7]<strong>的选项组，它的含义和</strong>[mysqld]<strong>一样，只不过只有版本号为</strong>5.7<strong>的</strong>mysqld**程序才能使用这个选项组的选项</p>
<h4 id="6-3-6-4-同一个配置文件中的多个组的优先级"><a href="#6-3-6-4-同一个配置文件中的多个组的优先级" class="headerlink" title="6.3.6.4 同一个配置文件中的多个组的优先级"></a>6.3.6.4 同一个配置文件中的多个组的优先级</h4><ul>
<li><p>同一个命令可以访问配置文件中的多个组，比如mysqld可以访问[mysqld]、[server]组，如果在同一个配置文件中，比如&#x2F;etc&#x2F;my.cnf，在这些组里出现了同样的配置项，比如这样：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=<span class="string">InnoDB</span></span><br><span class="line"></span><br><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=<span class="string">MyISAM</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>那么，将以**最后一个出现的组中的启动选项为准,**即以[mysqld]的启动选项为准：<code>default-storage-engine=MyISAM</code></p>
</li>
</ul>
<h4 id="6-3-6-5-命令行和配置文件中的启动选项的区别"><a href="#6-3-6-5-命令行和配置文件中的启动选项的区别" class="headerlink" title="6.3.6.5 命令行和配置文件中的启动选项的区别"></a>6.3.6.5 命令行和配置文件中的启动选项的区别</h4><ul>
<li><p>如果一个启动选项即出现在命令行中，又出现在配置文件中，那么<strong>以命令行中的启动选项为准</strong></p>
</li>
<li><p>举例：</p>
<ul>
<li><p>配置文件：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=<span class="string">InnoDB</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>而启动命令是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql.server <span class="keyword">start</span> <span class="comment">--default-storage-engine=MyISAM</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>那么最后<code>default-storage-engine</code>的值就是<code>MyISAM</code></strong></p>
</li>
</ul>
</li>
</ul>
<h2 id="6-4-逻辑架构"><a href="#6-4-逻辑架构" class="headerlink" title="6.4 逻辑架构"></a>6.4 逻辑架构</h2><h3 id="6-4-1-逻辑架构剖析"><a href="#6-4-1-逻辑架构剖析" class="headerlink" title="6.4.1 逻辑架构剖析"></a>6.4.1 逻辑架构剖析</h3><h4 id="6-4-1-1-服务器处理客户端的请求"><a href="#6-4-1-1-服务器处理客户端的请求" class="headerlink" title="6.4.1.1 服务器处理客户端的请求"></a>6.4.1.1 服务器处理客户端的请求</h4><ul>
<li><p>MySQL是典型的C&#x2F;S架构，即<code>Client/Server</code>架构，服务器端程序使用的<code>mysqld</code></p>
</li>
<li><p>不论客户端进程和服务器进程采用哪种方式通信，最后实现的效果都是：<strong>客户端进程向服务器进程发送一段文本（SQL语句），服务器进程处理后再向客户端进程发送一段文本（处理结果）</strong></p>
</li>
<li><p>那服务器进程对客户端进程发送的请求做了什么处理，才能产生最后的处理结果呢？这里以查询请求为例展示：</p>
<p><img src="image-20221116145136711.png" alt="MySQL之性能优化/image-20221116145136711"></p>
</li>
<li><p>下面具体展开：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E7%9A%84%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E8%AF%B4%E6%98%8E.png" alt="MySQL服务器端的逻辑架构说明"></p>
</li>
<li><p>Connectors: MySQL服务器之外的客户端程序，和具体编程语言相关的内容</p>
</li>
<li><p>Management Service &amp;Utilities–&gt;基础服务组件： MySQL服务器的基础服务组件</p>
</li>
<li><p>Connection Pool –&gt;连接池： 提供了多个用于客户端和服务器端进行交互的线程，这些线程使用完后交还到连接池，供其他客户端使用，从而保证资源不被浪费</p>
</li>
<li><p>SQL Interface–&gt;SQL接口： 作用是用来接收SQL指令并返回查询结果</p>
</li>
<li><p>Parser–&gt;解析器： 用来解析SQL接口中的SQL，分为语法解析和语义解析。解析后会生成一个语法树，该语法树可用于后续的查询优化。解析器将SQL语句“肢解”为关键字、表名、字段名等内容</p>
</li>
<li><p>Optimlzer–&gt;优化器： 核心组件，对SQL进行优化：分为逻辑上的优化和物理上的优化。物理优化—使用索引</p>
</li>
<li><p>Cache &amp; Buffers–&gt;查询缓存: 在8.0中已经弃用。以key - value的方式缓存查询结果，查询结果作为value，SQL语句作为key。当下一次查询和缓存的查询语句完全一致时查询命中</p>
</li>
<li><p>pluggable Storage Engines–&gt;插件式存储引擎： 与底层的文件系统进行交互</p>
</li>
<li><p>File system–&gt;文件系统</p>
</li>
<li><p>File &amp; Logs–&gt;日志文件</p>
</li>
<li><p>5.7查询顺序： Connectors–&gt;Connection Pool (连接池)–&gt;SQL Interface(SQL接口)–&gt;Cache &amp; Buffers(查询缓存)–&gt;Parser(解析器)–&gt;Optimlzer(优化器)–&gt;pluggable Storage Engines(插件式存储引擎)–&gt;File system(文件系统)–&gt;Cache &amp; Buffers(查询缓存)–&gt;SQL Interface(SQL接口)</p>
</li>
</ul>
<h4 id="6-4-1-2-Connectors"><a href="#6-4-1-2-Connectors" class="headerlink" title="6.4.1.2 Connectors"></a>6.4.1.2 Connectors</h4><p>Connectors，指的是不同语言中与SQL的交互。MySQL首先是一个网络程序，在TCP之上定义了自己的应用层协议。所以要使用MySQL，我们可以编写代码，跟MySQL Server<strong>建立TCP连接</strong>，之后按照其定义好的协议进行交互。或者比较方便的办法是调用SDK，比如Native C API、JDBC、PHP等各语言MysQL Connector，或者通过ODBC。但<strong>通过SDK来访问MysQL，本质上还是在TCP连接上通过MySQL协议跟MySQL进行交互</strong>。<br>接下来的MysQL Server结构可以分为如下的三层:</p>
<ul>
<li>连接层</li>
<li>服务层</li>
<li>引擎层</li>
</ul>
<h4 id="6-4-1-3-第一层：连接层"><a href="#6-4-1-3-第一层：连接层" class="headerlink" title="6.4.1.3 第一层：连接层"></a>6.4.1.3 第一层：连接层</h4><ul>
<li><p>系统（客户端）访问 <strong>MySQL</strong> 服务器前，做的第一件事就是建立 <strong>TCP</strong> 连接</p>
</li>
<li><p>经过三次握手建立连接成功后， <strong>MySQL</strong> 服务器对 <strong>TCP</strong> 传输过来的账号密码做身份认证、权限获取</p>
</li>
<li><p><strong>用户名或密码不对，会收到一个Access denied for user错误，客户端程序结束执行</strong></p>
</li>
<li><p><strong>用户名密码认证通过，会从权限表查出账号拥有的权限与连接关联，之后的权限判断逻辑，都将依赖于此时读到的权限</strong></p>
</li>
<li><p>一个系统只会和MySQL服务器建立一个连接吗？只有一个系统和MySQL服务器建立连接吗？</p>
<ul>
<li>当然不是，多个系统都可以和MySQL服务器建立连接，每个系统建立的连接肯定不止一个。所以为了解决TCP无限创建与TCP频繁创建销毁带来的资源耗尽、性能下降问题。MySQL服务器里有专门的<strong>TCP连接池</strong>限制连接数，采用<strong>长连接模式</strong>复用TCP连接，来解决上述问题</li>
</ul>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/connectors.png" alt="connectors"></p>
</li>
<li><p>TCP 连接收到请求后，必须要分配给一个线程专门与这个客户端的交互。所以还会有个线程池，去走后面的流程。每一个连接从线程池中获取线程，省去了创建和销毁线程的开销</p>
</li>
</ul>
<h4 id="6-4-1-4-第二层：服务层"><a href="#6-4-1-4-第二层：服务层" class="headerlink" title="6.4.1.4 第二层：服务层"></a>6.4.1.4 第二层：服务层</h4><ul>
<li><p>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成<strong>缓存的查询</strong>，SQL的分析和优化及部分内置函数的执行</p>
</li>
<li><p>所有的跨存储引擎的功能也在这一层实现，如过程、函数等</p>
</li>
<li><p>在服务层，服务器会<strong>解析查询</strong>并创建相应的内部<strong>解析树</strong>，并对其完成相应的优化：如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作</p>
</li>
<li><p>如果是SELECT语句，服务器还会<strong>查询内部的缓存</strong>。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能</p>
</li>
<li><p><strong>SQL Interface: SQL接口</strong></p>
<ul>
<li>接收用户的SQL命令，并且返回用户需要查询的结果。比如SELECT … FROM就是调用SQL Interface</li>
<li>MySQL支持DML（数据操作语言）、DDL（数据定义语言）、存储过程、视图、触发器、自定义函数等多种SQL语言接口</li>
</ul>
</li>
<li><p><strong>Parser: 解析器</strong></p>
<ul>
<li>在解析器中对 SQL 语句进行语法分析、语义分析。将SQL语句分解成数据结构，并将这个结构传递到后续步骤，以后SQL语句的传递和处理就是基于这个结构的。如果在分解构成中遇到错误，那么就说明这个SQL语句是不合理的</li>
<li>在SQL命令传递到解析器的时候会被解析器验证和解析，并为其创建<strong>语法树</strong> ，并根据数据字典丰富查询语法树，会<strong>验证该客户端是否具有执行该查询的权限</strong>。创建好语法树后，MySQL还会对SQl查询进行语法上的优化，进行查询重写</li>
</ul>
</li>
<li><p><strong>Optimizer: 查询优化器</strong></p>
<ul>
<li><p>SQL语句在语法解析之后、查询之前会使用查询优化器确定 SQL 语句的执行路径，生成一个<strong>执行计划</strong></p>
</li>
<li><p>这个执行计划表明应该<strong>使用哪些索引</strong>进行查询（全表检索还是使用索引检索），表之间的连接顺序如何，最后会按照执行计划中的步骤调用存储引擎提供的方法来真正的执行查询，并将查询结果返回给用户</p>
</li>
<li><p>它使用“ <strong>选取-投影-连接</strong> ”策略进行查询。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> id,name <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> gender <span class="operator">=</span> <span class="string">&#x27;女&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个SELECT查询先根据WHERE语句进行 <strong>选取</strong> ，而不是将表全部查询出来以后再进行gender过滤。 这个SELECT查询先根据id和name进行属性<strong>投影</strong> ，而不是将属性全部取出以后再进行过滤，将这两个查询条件 <strong>连接</strong> 起来生成最终查询结果</p>
</li>
</ul>
</li>
<li><p><strong>Caches &amp; Buffers： 查询缓存组件</strong></p>
<ul>
<li>MySQL内部维持着一些Cache和Buffer，比如Query Cache用来缓存一条SELECT语句的执行结果，如果能够在其中找到对应的查询结果，那么就不必再进行查询解析、优化和执行的整个过 程了，直接将结果反馈给客户端</li>
<li>这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等 </li>
<li>这个查询缓存可以在<strong>不同客户端之间共享</strong> </li>
<li>从MySQL 5.7.20开始，不推荐使用查询缓存，并在 <strong>MySQL 8.0中删除</strong></li>
</ul>
</li>
</ul>
<h4 id="6-4-1-5-第三层：引擎层"><a href="#6-4-1-5-第三层：引擎层" class="headerlink" title="6.4.1.5 第三层：引擎层"></a>6.4.1.5 第三层：引擎层</h4><ul>
<li>插件式存储引擎层（ Storage Engines），<strong>真正的负责了MySQL中数据的存储和提取，对物理服务器级别维护的底层数据执行操作</strong>， 服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取</li>
<li>MySQL5.7.19默认支持的存储引擎如下：</li>
</ul>
<p><img src="image-20221116155754346.png" alt="MySQL之性能优化/image-20221116155754346"></p>
<h4 id="6-4-1-6-存储层"><a href="#6-4-1-6-存储层" class="headerlink" title="6.4.1.6 存储层"></a>6.4.1.6 存储层</h4><p>所有的数据，数据库、表的定义，表的每一行的内容，索引，都是存在<strong>文件系统</strong>上，以<strong>文件</strong>的方式存在的，并完成与存储引擎的交互。当然有些存储引擎比如InnoDB，也支持不使用文件系统直接管理裸设备，但现代文件系统的实现使得这样做没有必要了。在文件系统之下，可以使用本地磁盘，可以使用DAS、NAS、SAN等各种存储系统</p>
<h4 id="6-4-1-7-小结"><a href="#6-4-1-7-小结" class="headerlink" title="6.4.1.7 小结"></a>6.4.1.7 小结</h4><ul>
<li><p>为了熟悉SQL执行流程方便，我们可以简化MySQL架构图，如下：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%AE%80%E5%8C%96%E7%89%88MySQL%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="简化版MySQL架构图"></p>
</li>
<li><p>简化为三层结构：</p>
<ol>
<li>连接层：客户端和服务器端建立连接，客户端发送 SQL 至服务器端；</li>
<li>SQL 层（服务层）：对 SQL 语句进行查询处理；与数据库文件的存储方式无关；</li>
<li>存储引擎层：与数据库文件打交道，负责数据的存储和读取。</li>
</ol>
</li>
</ul>
<h3 id="6-4-2-执行流程"><a href="#6-4-2-执行流程" class="headerlink" title="6.4.2 执行流程"></a>6.4.2 执行流程</h3><h4 id="6-4-2-1-MySQL中的SQL执行流程"><a href="#6-4-2-1-MySQL中的SQL执行流程" class="headerlink" title="6.4.2.1 MySQL中的SQL执行流程"></a>6.4.2.1 MySQL中的SQL执行流程</h4><p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="SQL执行流程"></p>
<p>MySQL的查询流程如下：</p>
<blockquote>
<p>1.<strong>查询缓存</strong>：Server 如果在查询缓存中发现了这条 SQL 语句，就会直接将结果返回给客户端；如果没有，就进入到解析器阶段。需要说明的是，因为查询缓存往往效率不高，所以在MySQL8.0 之后就抛弃了这个功能</p>
</blockquote>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98.png" alt="查询缓存"></p>
<ul>
<li><p>MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句</p>
<ul>
<li><strong>之前执行过的语句及其结果可能会以<code>key-value</code>对的形式，被直接缓存在内存中</strong>。key是查询的语句，value是查询的结果。如果你的查询能够直接在这个缓存中找到key，那么这个value就会被直接返回给客户端</li>
<li>如果语句不在查询缓中，就会继续后面的执行阶段。<strong>执行完成后，执行结果会被存入到查询缓存中</strong></li>
<li>所以，如果查询命中缓存，MySQL不需要执行后面的复杂操作，就可以直接返回结果，这个效率会很高</li>
</ul>
</li>
<li><p><strong>大多数情况查询缓存就是个鸡肋，为什么呢？</strong></p>
<ul>
<li><p>查询缓存是提前把查询结果缓存起来，这样下次不需要执行就可以直接拿到结果。需要说明的是，在MySQL 中的查询缓存，不是缓存查询计划，而是查询对应的结果。这就意味着查询匹配的 <strong>鲁棒性大大降低</strong> ，只有 <strong>相同的查询操作才会命中查询缓存</strong> 。两个查询请求在任何字符上的不同（例如：空格、注释、大小写），都会导致缓存不会命中。因此 <strong>MySQL 的查询缓存命中率不高</strong> </p>
</li>
<li><p>同时，如果查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表，如 mysql 、information_schema、 performance_schema 数据库中的表，那这个请求就不会被缓存。以某些系统函数举例，可能同样的函数的两次调用会产生不一样的结果，比如函数 <strong>NOW</strong> ，每次调用都会产生最新的当前时间，如果在一个查询请求中调用了这个函数，那即使查询请求的文本信息都一样，那不同时间的两次查询也应该得到不同的结果，如果在第一次查询时就缓存了，那第二次查询的时候直接使用第一次查询的结果就是错误的</p>
</li>
<li><p>此外，既然是缓存，那就有它 <strong>缓存失效的时候</strong> 。MySQL的缓存系统会监测涉及到的每张表，只要该表的结构或者数据被修改，如对该表使用了 <strong><code>INSERT 、 UPDATE 、 DELETE 、 TRUNCATE TABLE 、 ALTER TABLE 、 DROP TABLE</code></strong> 或 <strong><code>DROP DATABASE</code></strong> 语句，那使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除！对于 <strong>更新压力大的数据库</strong> 来说，查询缓存的命中率会非常低</p>
</li>
<li><p><strong>总之，因为查询缓存往往弊大于利，查询缓存的失效非常频繁</strong></p>
</li>
<li><p>一般建议大家在<strong>静态表</strong>里使用查询缓存，什么叫<strong>静态表</strong>呢？就是一般我们极少更新的表。比如，一个系统配置表、字典表，这张表上的查询才适合使们查询缓存。</p>
</li>
<li><p>好在MySQL也提供了这种”<strong>按需使用</strong>“的方式。你可以将<strong>my.cnf</strong>参数**<code>query_cache_type</code>**设置成<code>DEMAND</code>，代表当sql语句中有<code>SQL_CACHE</code>关键词时才缓存。比如:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#query_cache_type有<span class="number">3</span>个值：<span class="number">0</span>代表关闭查询缓存OFF、<span class="number">1</span>代力开启<span class="keyword">ON</span>、<span class="number">2</span> 〔DEMAND)</span><br><span class="line">uery_cache_type<span class="operator">=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>这样对于默认的SQL语句都不使用查询缓存。而对于你确定要使用查询缓存的语句，可以用SQL_CACHE显式指定，像下面这个语句—样:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> SQL_CACHE <span class="operator">*</span> <span class="keyword">from</span> test <span class="keyword">where</span> ID<span class="operator">=</span><span class="number">5</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前mysql实例是否开启缓存机制：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;query_cache_type&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> query_cache_type <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"># mysql5<span class="number">.7</span>默认是关闭查询缓存的</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Mysql8.0输出：</span></span><br><span class="line"><span class="comment">Empty set (0.01 sec)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>监控查询缓存的命中率：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#mysql5<span class="number">.7</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%Qcache%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name           <span class="operator">|</span> <span class="keyword">Value</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Qcache_free_blocks      <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_free_memory      <span class="operator">|</span> <span class="number">1031832</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_hits             <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_inserts          <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_lowmem_prunes    <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_not_cached       <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_queries_in_cache <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Qcache_total_blocks     <span class="operator">|</span> <span class="number">1</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#mysql8<span class="number">.0</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;%Qcache%&#x27;</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Qcache_free_blocks</strong>：表示查询缓存中还有多少剩余的blocks，如果该值显示较大，则说明查询缓存中的<strong>内存碎片</strong>过多了，可能在一定的时间进行整理</li>
<li><strong>cache_free_memory</strong>：查询缓存的内存大小，通过这个参数可以很清晰的知道当前系统的查询内存是否够用，是多了，还是不够用，DBA可以根据实际情况做出调整</li>
<li><strong>Qcache_hits</strong>：表示有<strong>多少次命中缓存</strong>。我们主要可以通过该值来验证我们的查询缓存的效果。数字越大，缓存效果越理想</li>
<li><strong>Qcache_inserts</strong>：表示<strong>多少次未命中然后插入</strong>，意思是新来的SQL请求在缓存中未找到，不得不执行查询处理，执行查询处理后把结果insert到查询缓存中。这样的情况的次数越多，表示查询缓存应用到的比较少，效果也就不理想。当然系统刚启动后，查询缓存是空的，这很正常</li>
<li><strong>Qcache_lowmem_prunes</strong>：该参数记录有<strong>多少条查询因为内存不足而被移除出查询缓存</strong>。通过这个值，用户可以适当的调整缓存大小</li>
<li><strong>Qcache_not_cached</strong>：表示因为query_cache_type的设置而没有被缓存的查询数量</li>
<li><strong>Qcache_queries_in_cache</strong>：当前缓存中<strong>缓存的查询的数量</strong></li>
<li><strong>Qcache_total_blocks</strong>：当前缓存的block数量</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>2.<strong>解析器：在解析器中对 SQL 语句进行语法分析、语义分析</strong></p>
</blockquote>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%A7%A3%E6%9E%90%E5%99%A8.png" alt="解析器"></p>
</li>
<li><p>如果没有命中查询缓存，就要开始真正执行语句了。首先，MySQL需要知道你要做什么，因此需要对SQL语句做解析。<strong>SQL语句的分析分为词法分析与语法分析</strong></p>
</li>
<li><p>分析器先做“ <strong>词法分析</strong> ”。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么</p>
</li>
<li><p>MySQL 从你输入的”select”这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”</p>
</li>
<li><p>接着，要做“ <strong>语法分析</strong> ”。根据词法分析的结果，语法分析器（比如：Bison）会根据语法规则，判断你输入的这个 SQL 语句是否 <strong>满足 MySQL 语法</strong> </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#语法错误：<span class="keyword">group</span> <span class="keyword">by</span>后面没有job_id（词对但是组合在一起出现了问题）</span><br><span class="line"><span class="keyword">select</span> department_id,job_id,<span class="built_in">avg</span>(salary) <span class="keyword">from</span> employees <span class="keyword">group</span> <span class="keyword">by</span> department_id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果你的语句不对，就会收到”<strong>You have an error in your SQL syntax</strong>“的错误提醒，比如语句from写成了”rom”–&gt;词法错误</p>
</li>
<li><p>如果SQL语句正确，则会生成一个这样的语法树：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%AF%AD%E6%B3%95%E6%A0%91.png" alt="语法树"></p>
</li>
<li><p>下面是SQL词法分析的过程步骤：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90.png" alt="词法分析"></p>
</li>
<li><p>至此解析器的工作结束，接下来进入到优化器</p>
</li>
</ul>
<blockquote>
<p><strong>3.优化器</strong>：在优化器中会确定 SQL 语句的执行路径，比如是根据<strong>全表检索</strong> ，还是根据<strong>索引检索</strong>等</p>
</blockquote>
<ul>
<li><p>经过了解析器，MySQL就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。<strong>一条查询可以有很多种执行方式，最后都返回相同的结果。优化器的作用就是找到这其中最好的执行计划</strong></p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BC%98%E5%8C%96%E5%99%A8.png" alt="优化器"></p>
</li>
<li><p>比如:优化器是在表里面有多个索引的时候，决定使用哪个索引;或者在一个语句有多表关联（join)的时候，决定各个表的连接顺序，还有表达式简化、子查询转为连接、外连接转为内连接等</p>
<ul>
<li>举例：如下语句是执行两个表的 join：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> test1 <span class="keyword">join</span> test2 <span class="keyword">using</span>(ID)</span><br><span class="line"><span class="keyword">where</span> test1.name<span class="operator">=</span><span class="string">&#x27;zhangwei&#x27;</span> <span class="keyword">and</span> test2.name<span class="operator">=</span><span class="string">&#x27;mysql高级课程&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#方案<span class="number">1</span>：可以先从表 test1 里面取出 name<span class="operator">=</span><span class="string">&#x27;zhangwei’的记录的 ID 值，再根据 ID 值关联到表 test2，再判断 test2 里面 name的值是否等于 ‘mysql高级课程’</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#方案2：可以先从表 test2 里面取出 name=‘mysql高级课程’ 的记录的 ID 值，再根据 ID 值关联到 test1，再判断 test1 里面 name的值是否等于 zhangwei</span></span><br></pre></td></tr></table></figure>

<ul>
<li>这两种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定选择使用哪一个方案。优化器阶段完成后，这个语句的执行方案就确定下来了，然后进入执行器阶段</li>
<li>如果你还有一些疑问，比如优化器是怎么选择索引的，有没有可能选择错等。后面讲到索引我们再谈。</li>
<li>在查询优化器中，可以分为<strong>逻辑查询</strong>优化阶段和<strong>物理查询</strong>优化阶段</li>
<li><strong>逻辑查询</strong>优化就是通过改变SQL语句的内容来使得SQL查询更高效，同时为物理查询优化提供更多的候选执行计划。通常采用的方式是对SQL语句进行<strong>等价变换</strong>，对查询进行<strong>重写</strong>，而查询重写的数学基础就是关系代数。对条件表达式进行等价谓词重写、条件简化，对视图进行重写，对子查询进行优化，对连接语义进行了外连接消除、嵌套连接消除等</li>
<li><strong>物理查询</strong>优化是基于关系代数进行的查询重写，而关系代数的每一步都对应着物理计算，这些物理计算往往存在多种算法。因此需要计算各种物理路径的代价，从中选择代价最小的作为执行计划。在这个阶段里，对于单表和多表连接的操作，需要高效地<strong>使用索引</strong>，提升直询效率</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>4.执行器</strong></p>
</blockquote>
<ul>
<li><p>截止到现在，还没有真正去读写真实的表，仅仅只是产出了一个<strong>执行计划</strong>。于是就进入了<strong>执行器阶段</strong></p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E6%89%A7%E8%A1%8C%E5%99%A8.png" alt="执行器"></p>
</li>
<li><p>在执行之前需要判断该用户是否<strong>具备权限</strong> 。如果没有，就会返回权限错误。如果具备权限，就执行 SQL查询并返回结果。在 MySQL8.0 以下的版本，<strong>如果设置了查询缓存，这时会将查询结果进行缓存</strong></p>
</li>
<li><p><strong>如果有权限</strong>，就打开表继续执行。打开表的时候，执行器就会<strong>根据表的引擎定义</strong>，<strong>调用存储引擎API对表进行的读写</strong>。<strong>存储引擎API</strong>只是<strong>抽象接口</strong>，下面还有个<strong>存储引擎层</strong>，具体实现还是要看表选择的存储引擎</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.png" alt="调用存储引擎"></p>
</li>
<li><p>比如：表 test 中，ID 字段没有索引，那么执行器的执行流程是这样的：</p>
<ul>
<li>调用 InnoDB 引擎接口取这个表的第一行，判断 ID 值是不是1，如果不是则跳过，如果是则将这行存在结果集中</li>
<li>调用引擎接口取“下一行”，重复相同的判断逻辑，直到取到这个表的最后一行</li>
<li>执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端</li>
<li>至此，这个语句就执行完成了</li>
<li>对于有索引的表，执行的逻辑也差不多</li>
</ul>
</li>
<li><p>SQL 语句在 MySQL 中的流程是： <strong>SQL语句→查询缓存→解析器→优化器→执行器</strong></p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/MySQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="MySQL执行流程"></p>
</li>
</ul>
<h4 id="6-4-2-2-MySQL8中SQL执行原理"><a href="#6-4-2-2-MySQL8中SQL执行原理" class="headerlink" title="6.4.2.2 MySQL8中SQL执行原理"></a>6.4.2.2 MySQL8中SQL执行原理</h4><ul>
<li>前面的结构图很复杂，我们需要抓取最核心的部分:<strong>SQL的执行原理</strong>。不同的DBMS的SQL的执行原理是相通的，只是在不同的软件中，各有各的实现路径</li>
<li>既然一条SQL语句会经历不同的模块，那我们就来看下，在不同的模块中。SQL执行所使用的资源(时间）是怎样的。如何在MySQL中对一条 SQL语句的执行时间进行分析</li>
</ul>
<blockquote>
<p>1.确认profiling 是否开启</p>
</blockquote>
<ul>
<li><p>了解查询语句底层执行的过程: <code>select @@profiling;</code>或者<code>show variables like &#39;%profiling%&#39;</code>查看是否开启计划。开启它可以让MySQL收集在SQL执行时所使用的资源情况，命令如下:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">| @@profiling |</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">|           0 |</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+---------------+-------+</span></span><br><span class="line"><span class="comment">| Variable_name | Value |</span></span><br><span class="line"><span class="comment">+---------------+-------+</span></span><br><span class="line"><span class="comment">| profiling     | OFF   |</span></span><br><span class="line"><span class="comment">+---------------+-------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>profiling&#x3D;0 代表关闭，我们需要把 profiling 打开，即设置为 1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">| @@profiling |</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">|           1 |</span></span><br><span class="line"><span class="comment">+-------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>2.多次执行相同SQL查询</strong></p>
</blockquote>
<ul>
<li>执行一个 SQL 查询：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>3.查看profiles</strong></p>
</blockquote>
<ul>
<li><p>查看当前会话所产生的所有 profiles：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profiles; # 显示最近的几次查询</span><br><span class="line"><span class="comment">/*本机输出：</span></span><br><span class="line"><span class="comment">+----------+------------+-------------------------+</span></span><br><span class="line"><span class="comment">| Query_ID | Duration   | Query                   |</span></span><br><span class="line"><span class="comment">+----------+------------+-------------------------+</span></span><br><span class="line"><span class="comment">|        1 | 0.00031625 | select @@profiling      |</span></span><br><span class="line"><span class="comment">|        2 | 0.00019625 | select * from employees |</span></span><br><span class="line"><span class="comment">+----------+------------+-------------------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>4.查看profile</strong></p>
</blockquote>
<ul>
<li><p>显示执行计划，查看程序的执行步骤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profile;</span><br><span class="line"><span class="comment">/*本机输出</span></span><br><span class="line"><span class="comment">+--------------------------------+----------+</span></span><br><span class="line"><span class="comment">| Status                         | Duration |</span></span><br><span class="line"><span class="comment">+--------------------------------+----------+</span></span><br><span class="line"><span class="comment">| starting                       | 0.000172 |</span></span><br><span class="line"><span class="comment">| Executing hook on transaction  | 0.000013 |</span></span><br><span class="line"><span class="comment">| starting                       | 0.000012 |</span></span><br><span class="line"><span class="comment">| checking permissions           | 0.000008 |</span></span><br><span class="line"><span class="comment">| Opening tables                 | 0.000044 |</span></span><br><span class="line"><span class="comment">| init                           | 0.000005 |</span></span><br><span class="line"><span class="comment">| System lock                    | 0.000008 |</span></span><br><span class="line"><span class="comment">| optimizing                     | 0.000004 |</span></span><br><span class="line"><span class="comment">| statistics                     | 0.000021 |</span></span><br><span class="line"><span class="comment">| preparing                      | 0.000016 |</span></span><br><span class="line"><span class="comment">| executing                      | 0.000239 |</span></span><br><span class="line"><span class="comment">| end                            | 0.000009 |</span></span><br><span class="line"><span class="comment">| query end                      | 0.000003 |</span></span><br><span class="line"><span class="comment">| waiting for handler commit     | 0.000007 |</span></span><br><span class="line"><span class="comment">| closing tables                 | 0.000007 |</span></span><br><span class="line"><span class="comment">| freeing items                  | 0.000030 |</span></span><br><span class="line"><span class="comment">| cleaning up                    | 0.000013 |</span></span><br><span class="line"><span class="comment">+--------------------------------+----------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>当然你也可以查询指定的 Query ID，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询 SQL 的执行时间结果和上面是一样的</p>
</li>
<li><p>此外，还可以查询更丰富的内容：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> profile cpu,block io <span class="keyword">for</span> query <span class="number">6</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#本机测试</span><br><span class="line"><span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">1</span>;</span><br><span class="line"><span class="comment">/*本机输出：</span></span><br><span class="line"><span class="comment">+----------------------+----------+</span></span><br><span class="line"><span class="comment">| Status               | Duration |</span></span><br><span class="line"><span class="comment">+----------------------+----------+</span></span><br><span class="line"><span class="comment">| starting             | 0.000116 |</span></span><br><span class="line"><span class="comment">| checking permissions | 0.000007 |</span></span><br><span class="line"><span class="comment">| Opening tables       | 0.000028 |</span></span><br><span class="line"><span class="comment">| init                 | 0.000023 |</span></span><br><span class="line"><span class="comment">| optimizing           | 0.000011 |</span></span><br><span class="line"><span class="comment">| executing            | 0.000009 |</span></span><br><span class="line"><span class="comment">| end                  | 0.000003 |</span></span><br><span class="line"><span class="comment">| query end            | 0.000005 |</span></span><br><span class="line"><span class="comment">| closing tables       | 0.000003 |</span></span><br><span class="line"><span class="comment">| freeing items        | 0.000021 |</span></span><br><span class="line"><span class="comment">| cleaning up          | 0.000009 |</span></span><br><span class="line"><span class="comment">+----------------------+----------+</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">show</span> profile cpu,block io <span class="keyword">for</span> query <span class="number">1</span>;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">show</span> profile cpu,block io <span class="keyword">for</span> query <span class="number">1</span>\G;</span><br><span class="line"><span class="comment">/*部分输出：</span></span><br><span class="line"><span class="comment">*************************** 1. row ***************************</span></span><br><span class="line"><span class="comment">       Status: starting</span></span><br><span class="line"><span class="comment">     Duration: 0.000116</span></span><br><span class="line"><span class="comment">     CPU_user: 0.000113</span></span><br><span class="line"><span class="comment">   CPU_system: 0.000000</span></span><br><span class="line"><span class="comment"> Block_ops_in: 0</span></span><br><span class="line"><span class="comment">Block_ops_out: 0</span></span><br><span class="line"><span class="comment">*************************** 2. row ***************************</span></span><br><span class="line"><span class="comment">       Status: checking permissions</span></span><br><span class="line"><span class="comment">     Duration: 0.000007</span></span><br><span class="line"><span class="comment">     CPU_user: 0.000005</span></span><br><span class="line"><span class="comment">   CPU_system: 0.000000</span></span><br><span class="line"><span class="comment"> Block_ops_in: 0</span></span><br><span class="line"><span class="comment">Block_ops_out: 0</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-4-2-3-MySQL5-7中SQL执行原理"><a href="#6-4-2-3-MySQL5-7中SQL执行原理" class="headerlink" title="6.4.2.3 MySQL5.7中SQL执行原理"></a>6.4.2.3 MySQL5.7中SQL执行原理</h4><blockquote>
<p><strong>1.配置文件中开启查询缓存</strong></p>
</blockquote>
<ul>
<li><p>在 &#x2F;etc&#x2F;my.cnf 中新增一行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query_cache_type<span class="operator">=</span><span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>2.重启mysql服务</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%query_cache_type&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> query_cache_type <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>3.开启查询执行计划</strong></p>
</blockquote>
<ul>
<li><p>由于重启过服务，需要重新执行如下指令，开启profiling。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @<span class="variable">@profiling</span><span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> @<span class="variable">@profiling</span><span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@profiling</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@profiling</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>4.执行语句两次：</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> databases;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> Database           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="operator">|</span> information_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> atguigudb          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dbtest1            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> dbtest2            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> mysql              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> performance_schema <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sys                <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> use atguigudb;</span><br><span class="line">Reading <span class="keyword">table</span> information <span class="keyword">for</span> completion <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">and</span> <span class="keyword">column</span> names</span><br><span class="line">You can turn off this feature <span class="keyword">to</span> <span class="keyword">get</span> a quicker startup <span class="keyword">with</span> <span class="operator">-</span>A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_atguigudb <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="operator">|</span> countries           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> departments         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> emp_details_view    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> employees           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> job_grades          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> job_history         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> jobs                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> locations           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">order</span>               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> regions             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> departments;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> department_id <span class="operator">|</span> department_name      <span class="operator">|</span> manager_id <span class="operator">|</span> location_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">10</span> <span class="operator">|</span> Administration       <span class="operator">|</span>        <span class="number">200</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">20</span> <span class="operator">|</span> Marketing            <span class="operator">|</span>        <span class="number">201</span> <span class="operator">|</span>        <span class="number">1800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">30</span> <span class="operator">|</span> Purchasing           <span class="operator">|</span>        <span class="number">114</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">40</span> <span class="operator">|</span> Human Resources      <span class="operator">|</span>        <span class="number">203</span> <span class="operator">|</span>        <span class="number">2400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">50</span> <span class="operator">|</span> Shipping             <span class="operator">|</span>        <span class="number">121</span> <span class="operator">|</span>        <span class="number">1500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">60</span> <span class="operator">|</span> IT                   <span class="operator">|</span>        <span class="number">103</span> <span class="operator">|</span>        <span class="number">1400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">70</span> <span class="operator">|</span> Public Relations     <span class="operator">|</span>        <span class="number">204</span> <span class="operator">|</span>        <span class="number">2700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">80</span> <span class="operator">|</span> Sales                <span class="operator">|</span>        <span class="number">145</span> <span class="operator">|</span>        <span class="number">2500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">90</span> <span class="operator">|</span> Executive            <span class="operator">|</span>        <span class="number">100</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">100</span> <span class="operator">|</span> Finance              <span class="operator">|</span>        <span class="number">108</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">110</span> <span class="operator">|</span> Accounting           <span class="operator">|</span>        <span class="number">205</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">120</span> <span class="operator">|</span> Treasury             <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">130</span> <span class="operator">|</span> Corporate Tax        <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">140</span> <span class="operator">|</span> Control <span class="keyword">And</span> Credit   <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">150</span> <span class="operator">|</span> Shareholder Services <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">160</span> <span class="operator">|</span> Benefits             <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">170</span> <span class="operator">|</span> Manufacturing        <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">180</span> <span class="operator">|</span> Construction         <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">190</span> <span class="operator">|</span> Contracting          <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">200</span> <span class="operator">|</span> Operations           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">210</span> <span class="operator">|</span> IT Support           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">220</span> <span class="operator">|</span> NOC                  <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">230</span> <span class="operator">|</span> IT Helpdesk          <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">240</span> <span class="operator">|</span> Government Sales     <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">250</span> <span class="operator">|</span> Retail Sales         <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">260</span> <span class="operator">|</span> Recruiting           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">270</span> <span class="operator">|</span> Payroll              <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="number">27</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> departments;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="operator">|</span> department_id <span class="operator">|</span> department_name      <span class="operator">|</span> manager_id <span class="operator">|</span> location_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">10</span> <span class="operator">|</span> Administration       <span class="operator">|</span>        <span class="number">200</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">20</span> <span class="operator">|</span> Marketing            <span class="operator">|</span>        <span class="number">201</span> <span class="operator">|</span>        <span class="number">1800</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">30</span> <span class="operator">|</span> Purchasing           <span class="operator">|</span>        <span class="number">114</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">40</span> <span class="operator">|</span> Human Resources      <span class="operator">|</span>        <span class="number">203</span> <span class="operator">|</span>        <span class="number">2400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">50</span> <span class="operator">|</span> Shipping             <span class="operator">|</span>        <span class="number">121</span> <span class="operator">|</span>        <span class="number">1500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">60</span> <span class="operator">|</span> IT                   <span class="operator">|</span>        <span class="number">103</span> <span class="operator">|</span>        <span class="number">1400</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">70</span> <span class="operator">|</span> Public Relations     <span class="operator">|</span>        <span class="number">204</span> <span class="operator">|</span>        <span class="number">2700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">80</span> <span class="operator">|</span> Sales                <span class="operator">|</span>        <span class="number">145</span> <span class="operator">|</span>        <span class="number">2500</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>            <span class="number">90</span> <span class="operator">|</span> Executive            <span class="operator">|</span>        <span class="number">100</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">100</span> <span class="operator">|</span> Finance              <span class="operator">|</span>        <span class="number">108</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">110</span> <span class="operator">|</span> Accounting           <span class="operator">|</span>        <span class="number">205</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">120</span> <span class="operator">|</span> Treasury             <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">130</span> <span class="operator">|</span> Corporate Tax        <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">140</span> <span class="operator">|</span> Control <span class="keyword">And</span> Credit   <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">150</span> <span class="operator">|</span> Shareholder Services <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">160</span> <span class="operator">|</span> Benefits             <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">170</span> <span class="operator">|</span> Manufacturing        <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">180</span> <span class="operator">|</span> Construction         <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">190</span> <span class="operator">|</span> Contracting          <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">200</span> <span class="operator">|</span> Operations           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">210</span> <span class="operator">|</span> IT Support           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">220</span> <span class="operator">|</span> NOC                  <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">230</span> <span class="operator">|</span> IT Helpdesk          <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">240</span> <span class="operator">|</span> Government Sales     <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">250</span> <span class="operator">|</span> Retail Sales         <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">260</span> <span class="operator">|</span> Recruiting           <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>           <span class="number">270</span> <span class="operator">|</span> Payroll              <span class="operator">|</span>       <span class="keyword">NULL</span> <span class="operator">|</span>        <span class="number">1700</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+----------------------+------------+-------------+</span></span><br><span class="line"><span class="number">27</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>5.查看profiles</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profiles;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span> Query_ID <span class="operator">|</span> Duration   <span class="operator">|</span> Query                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> <span class="number">0.00020050</span> <span class="operator">|</span> <span class="keyword">select</span> @<span class="variable">@profiling</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> <span class="number">0.00117450</span> <span class="operator">|</span> <span class="keyword">show</span> databases            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> <span class="number">0.00019575</span> <span class="operator">|</span> <span class="keyword">SELECT</span> DATABASE()         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span> <span class="number">0.00033300</span> <span class="operator">|</span> <span class="keyword">show</span> databases            <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> <span class="number">0.00018600</span> <span class="operator">|</span> <span class="keyword">show</span> tables               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> <span class="number">0.00036175</span> <span class="operator">|</span> <span class="keyword">show</span> tables               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">7</span> <span class="operator">|</span> <span class="number">0.00028225</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> departments <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">8</span> <span class="operator">|</span> <span class="number">0.00006875</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> departments <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>6.查看profile</strong></p>
</blockquote>
<ul>
<li><p>显示执行计划，查看程序的执行步骤：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">7</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status                         <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000020</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Waiting <span class="keyword">for</span> query cache lock   <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking query cache <span class="keyword">for</span> query <span class="operator">|</span> <span class="number">0.000033</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions           <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables                 <span class="operator">|</span> <span class="number">0.000018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                           <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock                    <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Waiting <span class="keyword">for</span> query cache lock   <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock                    <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing                     <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics                     <span class="operator">|</span> <span class="number">0.000010</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing                      <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing                      <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data                   <span class="operator">|</span> <span class="number">0.000069</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                            <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>                      <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables                 <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items                  <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Waiting <span class="keyword">for</span> query cache lock   <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items                  <span class="operator">|</span> <span class="number">0.000016</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Waiting <span class="keyword">for</span> query cache lock   <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items                  <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> storing <span class="keyword">result</span> <span class="keyword">in</span> query cache  <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up                    <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="number">25</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>storing result in query cache ： 把查询结果放入查询缓存</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">8</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status                         <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000028</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Waiting <span class="keyword">for</span> query cache lock   <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> starting                       <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking query cache <span class="keyword">for</span> query <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking privileges <span class="keyword">on</span> cached  <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions           <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sending cached <span class="keyword">result</span> <span class="keyword">to</span> clien <span class="operator">|</span> <span class="number">0.000012</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up                    <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+----------+</span></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>结论不言而喻。执行编号8时，比执行编号7时少了很多信息，可以看出查询语句直接<strong>从缓存中获取数据</strong></p>
</li>
<li><p><strong>注意1</strong>：SQL必须是一致的，否则,不能命中缓存。</p>
<ul>
<li>例如:<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#虽然查询结果一致。但并没有命中缓存</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mydb.mytbl <span class="keyword">where</span> id<span class="operator">=</span><span class="number">2</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> mydb.mytbl <span class="keyword">where</span> id<span class="operator">&gt;</span><span class="number">1</span> <span class="keyword">and</span> id<span class="operator">&lt;</span><span class="number">3</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>注意2</strong>：同样的开启缓存的配置信息如果在MySQL8中添加。重启服务时会报错(<strong>MySQL8移除了查询缓存功能</strong>)</p>
</li>
<li><p>还可以查询下列参数的利用情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Syntax :</span><br><span class="line">SH0W PROFILE [type [,type] ... ]</span><br><span class="line">[ <span class="keyword">FOR</span> QUERY n]</span><br><span class="line">[LIMIT row_count [<span class="keyword">OFFSET</span> <span class="keyword">offset</span>]]</span><br><span class="line">type : &#123;</span><br><span class="line"><span class="keyword">ALL</span> <span class="comment">-- 显示所有参数的开销信息</span></span><br><span class="line">BLOCK IO <span class="comment">-- 显示IO的相关开销</span></span><br><span class="line">CONTEXT SWITCHES <span class="comment">-- 上下文切换和关开信息</span></span><br><span class="line">CPU <span class="comment">-- 显示CPU的相关开销</span></span><br><span class="line">IPC <span class="comment">-- 显示发送和接收相关开销信息</span></span><br><span class="line">MEMORY <span class="comment">-- 显示内存相关开销信息</span></span><br><span class="line">PAGE FAULTS <span class="comment">-- 显示页面错读和关开销信息</span></span><br><span class="line">SOURCE <span class="comment">-- 显示和Saurce_function, Source_file , Source_line 相关的开销信息</span></span><br><span class="line">SWAPS <span class="comment">-- 显示交换次数相关的开销信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221117144231350.png" alt="MySQL之性能优化/image-20221117144231350"></p>
</li>
</ul>
<h4 id="6-4-2-4-SQL语法顺序"><a href="#6-4-2-4-SQL语法顺序" class="headerlink" title="6.4.2.4 SQL语法顺序"></a>6.4.2.4 SQL语法顺序</h4><ul>
<li><p>随着Mysql版本的更新换代，其优化器也在不断的升级，优化器会分析不同执行顺序产生的性能消耗不同而动态调整执行顺序</p>
</li>
<li><p>需求：查询每个部门年龄高于20岁的人数且高于20岁人数不能少于2人，显示人数最多的第一名部门信息</p>
</li>
<li><p>下面是经常出现的查询顺序：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/SQL%E8%AF%AD%E6%B3%95%E9%A1%BA%E5%BA%8F.png" alt="SQL语法顺序"></p>
</li>
</ul>
<h4 id="6-4-2-5-Oracle中的SQL执行流程-了解"><a href="#6-4-2-5-Oracle中的SQL执行流程-了解" class="headerlink" title="6.4.2.5 Oracle中的SQL执行流程(了解)"></a>6.4.2.5 Oracle中的SQL执行流程(了解)</h4><ul>
<li><p>Oracle 中采用了<strong>共享池</strong>来判断 SQL 语句是否存在缓存和执行计划，通过这一步骤我们可以知道应该采用硬解析还是软解析</p>
</li>
<li><p>我们先来看下 SQL 在 Oracle 中的执行过程：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="Oracle执行流程"></p>
<ul>
<li><p>从上面这张图中可以看出，SQL 语句在 Oracle 中经历了以下的几个步骤：</p>
<ul>
<li><strong>1.语法检查</strong>：检查 SQL 拼写是否正确，如果不正确，Oracle 会报语法错误</li>
<li><strong>2.语义检查</strong>：检查 SQL 中的访问对象是否存在。比如我们在写 SELECT 语句的时候，列名写错了，系统就会提示错误。语法检查和语义检查的作用是保证 SQL 语句没有错误</li>
<li><strong>3.权限检查</strong>：看用户是否具备访问该数据的权限</li>
<li><strong>4.共享池检查</strong>：共享池（Shared Pool）是一块内存池，<strong>最主要的作用是缓存 SQL 语句和该语句的执行计划</strong>。Oracle 通过检查共享池是否存在 SQL 语句的执行计划，来判断进行软解析，还是硬解析。那软解析和硬解析又该怎么理解呢？<ul>
<li>在共享池中，Oracle 首先对 SQL 语句进行 <strong>Hash 运算</strong> ，然后根据 Hash 值在库缓存（Library Cache）中查找，如果存在 SQL 语句的执行计划 ，就直接拿来执行，直接进入“执行器”的环节，这就是 <strong>软解析</strong> </li>
<li>如果没有找到 SQL 语句和执行计划，Oracle 就需要创建解析树进行解析，生成执行计划，进入“优化器”这个步骤，这就是<strong>硬解析</strong></li>
</ul>
</li>
<li><strong>5.优化器</strong>：优化器中就是要进行硬解析，也就是决定怎么做，比如创建解析树，生成执行计划</li>
<li><strong>6.执行器</strong>：当有了解析树和执行计划之后，就知道了 SQL 该怎么被执行，这样就可以在执行器中执行语句了</li>
</ul>
</li>
<li><p><strong>共享池</strong>是 Oracle 中的术语，包括了库缓存，数据字典缓冲区等。我们上面已经讲到了库缓存区，它主要缓存 SQL 语句和执行计划。而 <strong>数据字典缓冲区</strong> 存储的是 Oracle 中的对象定义，比如表、视图、索引等对象。当对 SQL 语句进行解析的时候，如果需要相关的数据，会从数据字典缓冲区中提取。</p>
</li>
<li><p><strong>库缓存</strong> 这一个步骤，决定了 SQL 语句是否需要进行硬解析。为了提升 SQL 的执行效率，我们应该尽量避免硬解析，因为在 SQL 的执行过程中，创建解析树，生成执行计划是很消耗资源的</p>
</li>
</ul>
</li>
<li><p>你可能会问，如何避免硬解析，尽量使用软解析呢？</p>
<ul>
<li><p>在 Oracle 中， <strong>绑定变量</strong>是它的一大特色。绑定变量就是在 SQL 语句中使用变量，通过不同的变量取值来改变 SQL 的执行结果。这样做的好处是能<strong>提升软解析的可能性</strong> ，不足之处在于可能会导致生成的执行计划不够优化，因此是否需要绑定变量还需要视情况而定</p>
</li>
<li><p>举个例子，我们可以使用下面的查询语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> player <span class="keyword">where</span> player_id <span class="operator">=</span> <span class="number">10001</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>你也可以使用绑定变量，如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> player <span class="keyword">where</span> player_id <span class="operator">=</span> :player_id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这两个查询语句的效率在 Oracle 中是完全不同的。如果你在查询 player_id &#x3D; 10001 之后，还会查询10002、10003 之类的数据，那么每一次查询都会创建一个新的查询解析。而第二种方式使用了绑定变量，那么在第一次查询之后，在共享池中就会存在这类查询的执行计划，也就是软解析</p>
</li>
<li><p>因此，<strong>我们可以通过使用绑定变量来减少硬解析，减少 Oracle 的解析工作量</strong>。但是这种方式也有缺点，使用动态 SQL 的方式，因为参数不同，会导致 SQL 的执行效率不同，同时 SQL 优化也会比较困难</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Oracle架构图：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="Oracle架构图"></p>
</li>
<li><p>简图：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/Oracle%E6%9E%B6%E6%9E%84%E5%9B%BE%E7%AE%80%E5%9B%BE.png" alt="Oracle架构图简图"></p>
</li>
<li><p>小结：Oracle 和 MySQL 在进行 SQL 的查询上面有软件实现层面的差异。Oracle 提出了共享池的概念，通过共享池来判断是进行软解析，还是硬解析</p>
</li>
</ul>
<h3 id="6-4-3-数据库缓冲池-buffer-pool"><a href="#6-4-3-数据库缓冲池-buffer-pool" class="headerlink" title="6.4.3  数据库缓冲池(buffer pool)"></a>6.4.3  数据库缓冲池(buffer pool)</h3><ul>
<li><strong>InnoDB</strong> 存储引擎是以页为单位来管理存储空间的，我们进行的增删改查操作其实本质上都是在访问页面（包括读页面、写页面、创建新页面等操作）。而磁盘 I&#x2F;O 需要消耗的时间很多，而在内存中进行操作，效率则会高很多，为了能让数据表或者索引中的数据随时被我们所用，DBMS 会申请 <strong>占用内存来作为数据缓冲池</strong> ，在真正访问页面之前，需要把在磁盘上的页缓存到内存中的 <strong>Buffer Pool</strong> 之后才可以访问</li>
<li>这样做的好处是可以让磁盘活动最小化，从而<strong>减少与磁盘直接进行 I&#x2F;O 的时间</strong> 。要知道，这种策略对提升 SQL 语句的查询性能来说至关重要。如果索引的数据在缓冲池里，那么访问的成本就会降低很多</li>
</ul>
<h4 id="6-4-3-1-缓冲池-vs-查询缓存"><a href="#6-4-3-1-缓冲池-vs-查询缓存" class="headerlink" title="6.4.3.1  缓冲池 vs 查询缓存"></a>6.4.3.1  缓冲池 vs 查询缓存</h4><ul>
<li><strong>缓冲池和查询缓存是一个东西吗？</strong><ul>
<li><strong>不是</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>1.缓冲池（Buffer Pool）</p>
</blockquote>
<ul>
<li><p>首先我们需要了解在 InnoDB 存储引擎中，缓冲池都包括了哪些</p>
</li>
<li><p>在 InnoDB 存储引擎中有一部分数据会放到内存中，缓冲池则占了这部分内存的大部分，它用来存储各种数据的缓存，如下图所示：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%BC%93%E5%86%B2%E6%B1%A0.png" alt="缓冲池"></p>
</li>
<li><p>从图中，你能看到 InnoDB 缓冲池包括了数据页、索引页、插入缓冲、锁信息、自适应 Hash 和数据字典信息等</p>
</li>
<li><p><strong>缓存池的重要性：</strong><br>对于使用<strong>InnoDB</strong>作为存储引擎的表来说，不管是用于存储用户数据的索引(包括聚簇索引和二级索引)，还是各种系统数据，都是以<strong>页</strong>的形式存放在<strong>表空间</strong>中的，而所谓的表空间只不过是InnoDB对文件系统上一个或几个实际文件的抽象，也就是说我们的数据说到底还是存储在磁盘上的。但是各位也都知道，磁盘的速度慢的跟乌龟一样，怎么能配得上**”快如风，疾如电”的CPU<strong>呢?这里，缓冲池可以帮助我们消除CPU和磁盘之间的</strong>鸿沟<strong>。所以InnoDB存储引擎在处理客户端的请求时，当需要访问某个页的数据时，就会把</strong>完整的页的数据全部加载到内存<strong>中,也就是说即使我们只需要访问一个页的一条记录，那也需要先把整个页的数据加载到内存中。将整个页加载到内存中后就可以进行读写访问了，在进行完读写访问之后并不着急把该页对应的内存空间释放掉，而是将其</strong>缓存<strong>起来，这样将来有请求再次访问该页面时，就可以</strong>省去磁盘IO**的开销了</p>
</li>
<li><p><strong>缓存原则：</strong><br>“ <strong>位置</strong> * <strong>频次</strong> ”这个原则，可以帮我们对 I&#x2F;O 访问效率进行优化。<br>首先，位置决定效率，提供缓冲池就是为了在内存中可以直接访问数据。<br>其次，频次决定优先级顺序。因为缓冲池的大小是有限的，比如磁盘有 200G，但是内存只有 16G，缓冲池大小只有 1G，就无法将所有数据都加载到缓冲池里，这时就涉及到优先级顺序，会 <strong>优先对使用频次高的热数据进行加载</strong> </p>
</li>
<li><p><strong>缓冲池的预读特性：</strong><br>了解了缓冲池的作用之后，我们还需要了解缓冲池的另一个特性：<strong>预读</strong><br>缓冲池的作用就是提升IO效率，而我们进行读取数据的时候存在一个”“局部性原理”，也就是说我们使用了一些数据，<strong>大概率还会使用它周周的一些数据</strong>，因此采用“预读”的机制提前加载，可以减少未来可能的磁盘I&#x2F;O操作</p>
</li>
</ul>
<blockquote>
<p>2.查询缓存</p>
</blockquote>
<ul>
<li>那么什么是查询缓存呢？<ul>
<li>查询缓存是提前把<strong>查询结果缓存</strong> 起来，这样下次不需要执行就可以直接拿到结果。需要说明的是，在MySQL 中的查询缓存，不是缓存查询计划，而是查询对应的结果。因为命中条件苛刻，而且只要数据表发生变化，查询缓存就会失效，因此命中率低</li>
</ul>
</li>
</ul>
<h4 id="6-4-3-2-缓冲池如何读取数据"><a href="#6-4-3-2-缓冲池如何读取数据" class="headerlink" title="6.4.3.2 缓冲池如何读取数据"></a>6.4.3.2 缓冲池如何读取数据</h4><ul>
<li><p>缓冲池管理器会尽量将经常使用的数据保存起来，在数据库进行页面读操作的时候，首先会判断该页面是否在缓冲池中，如果存在就直接读取，如果不存在，就会通过内存或磁盘将页面存放到缓冲池中再进行读取</p>
</li>
<li><p>缓存在数据库中的结构和作用如下图所示：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E7%BC%93%E5%86%B2%E5%8C%BA%E5%A4%A7%E7%9A%84%E7%BB%93%E6%9E%84%E5%92%8C%E4%BD%9C%E7%94%A8.png" alt="缓冲区大的结构和作用"></p>
</li>
<li><p><strong>如果我们执行 SQL 语句的时候更新了缓存池中的数据，那么这些数据会马上同步到磁盘上吗？</strong></p>
</li>
<li><p>实际上，当我们对数据库中的记录进行修改的时候，<strong>首先会修改缓冲池中页里面的记录信息</strong>，然后数据库会<strong>以一定的频率刷新到磁盘上</strong>。注意并不是每次发生更新操作，都会立刻进行磁盘回写。缓冲池会采用一种叫做<strong>checkpoint 的机制</strong>将数据回写到磁盘上，这样做的好处就是提升了数据库的整体性能</p>
</li>
<li><p>比如，当<strong>缓冲池不够用</strong>时，需要释放掉一些不常用的页，此时就可以强行采用checkpoint的方式，将不常用的脏页回写到磁盘上，然后两从缓冲池中将这些页释放掉。这里脏页（dirty page)指的是缓冲池中被修改过的页，与磁盘上的数据页不一致</p>
</li>
</ul>
<h4 id="6-4-3-3-查看-x2F-设置缓冲池的大小"><a href="#6-4-3-3-查看-x2F-设置缓冲池的大小" class="headerlink" title="6.4.3.3 查看&#x2F;设置缓冲池的大小"></a>6.4.3.3 查看&#x2F;设置缓冲池的大小</h4><ul>
<li><p>如果使用的是<strong>MySQL MyISAM存储引擎</strong>，它只缓存索引，不缓存数据，对应的键缓存参数为<code>key_buffer_size</code>，你可以用它进行查看</p>
</li>
<li><p>如果你使用的是 <strong>InnoDB 存储引擎</strong>，可以通过查看 <code>innodb_buffer_pool_size</code> 变量来查看缓冲池的大小。命令如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_buffer_pool_size&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name           <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> innodb_buffer_pool_size <span class="operator">|</span> <span class="number">134217728</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>能看到此时 InnoDB 的缓冲池大小只有 <code>134217728/1024/1024=128MB</code>。可以修改缓冲池大小，比如改为256MB，方法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> innodb_buffer_pool_size <span class="operator">=</span> <span class="number">268435456</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>或者：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_size</span> = <span class="string">268435456</span></span><br><span class="line"><span class="comment">#然后再来看下修改后的缓冲池大小，此时已成功修改成了 256 MB</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="6-4-3-4-多个Buffer-Pool实例"><a href="#6-4-3-4-多个Buffer-Pool实例" class="headerlink" title="6.4.3.4 多个Buffer Pool实例"></a>6.4.3.4 多个Buffer Pool实例</h4><ul>
<li><p>Buffer Pool本质是InnoDB向操作系统申请的一块<strong>连续的内存空间</strong>，在多线程环境下，访问Buffer Pool中的数据都需要<strong>加锁</strong>处理。在Buffer Pool特别大而且多线程并发访问特别高的情况下，单一的Buffer Pool可能会影响请求的处理速度。所以在Buffer Pool特别大的时候，我们可以把它们<strong>拆分成若干个小的Buffer Pool</strong>，每个Buffer Pool都称为一个<strong>实例</strong>，它们都是独立的，独立的去中请内存空间，独立的管理各种链表。所以在多线程并发访问时并不会相互影响，从而提高并发处理能力</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_buffer_pool_instances&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_buffer_pool_instances <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"># 默认有一个Buffer Pool实例</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以在服务器启动的时候通过设置innodb_buffer_pool_instances的值来修改Buffer Pool实例的个数：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[server]</span></span><br><span class="line"><span class="attr">innodb_buffer_pool_instances</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>这样就表明我们要创建2个 Buffer Pool 实例</p>
</li>
<li><p>查看缓冲池的个数，使用命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_buffer_pool_instances&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_buffer_pool_instances <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>那每个 <strong>Buffer Pool</strong> 实例实际占多少内存空间呢？其实使用这个公式算出来的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_buffer_pool_size<span class="operator">/</span>innodb_buffer_pool_instances</span><br></pre></td></tr></table></figure>

<ul>
<li>也就是总共的大小除以实例的个数，结果就是每个 <strong>Buffer Pool</strong> 实例占用的大小</li>
</ul>
</li>
<li><p>不过也不是说Buffer Pool实例创建的越多越好，分别<strong>管理各个Buffer Pool也是需要性能开销</strong>的，InnoDB规定:当innodb_buffer_pool_size的值小于1G的时候设置多个实例是无效的，InnoDB会默认把innodb_buffer_pool_instances 的值修改为1。而我们鼓励在Bufer Pool大于或等于1G的时候设置多个Buffer Pool实例</p>
</li>
</ul>
<h4 id="6-4-3-5-引申问题"><a href="#6-4-3-5-引申问题" class="headerlink" title="6.4.3.5 引申问题"></a>6.4.3.5 引申问题</h4><ul>
<li>Buffer Pool是MySQL内存结构中十分核心的一个组成，你可以先把它想象成一个黑盒子</li>
<li><strong>黑盒下的更新数据流程</strong>：当查询数据的时候，会先去Buffer Pool中查询。如果Buffer Pool中不存在，存储引擎会先将数据从磁盘加载到Buffer Pool中，然后将数据返回给客户端;同理，当更新某个数据的时候，如果这个数据不存在于BufferPool，同样会先将数据加载进来，然后修改内存的数据。被修改过的数据会在之后统一刷入磁盘<br><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E9%BB%91%E7%9B%92%E4%B8%8B%E7%9A%84%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E6%B5%81%E7%A8%8B.png" alt="黑盒下的更新数据流程"></li>
<li>这个过程看似没啥问题，实则是有问题的。假设修改Buffer Pool中的数据成功，但是还没来得及将数据刷入磁盘MySQL就挂了怎么办?按照上图的逻辑，此时更新之后的数据只存在于Buffer Pool中，如果此时MySQL宕机了，这部分数据将会永久地丢失</li>
<li>再者，更新到一半突然发生错误了，想要回滚到更新之前的版本，该怎么办？连数据持久化的保证、事务回滚都做不到还谈什么崩溃恢复？<ul>
<li><strong>答案：Redo Log &amp; Undo Log</strong><ul>
<li>Redo Log ：解决刷盘时刷到一半宕机的问题</li>
<li>Undo Log：解决回滚的问题</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="6-5-存储引擎"><a href="#6-5-存储引擎" class="headerlink" title="6.5 存储引擎"></a>6.5 存储引擎</h2><ul>
<li>为了管理方便，把<strong>连接管理</strong>、<strong>查询缓存</strong>、<strong>语法解析</strong>、<strong>查询优化</strong>这些并不涉及真实数据存储的功能划分为<strong>MySQL server</strong>的功能，把真实存取数据的功能划分为<strong>存储引擎</strong>的功能。所以在MySQL server完成了查询优化后，只需按照生成的<strong>执行计划</strong>调用底层存储引擎提供的API，获取到数据后返回给客户端就好了</li>
<li>MySQL中提到了存储引擎的概念。简而言之， <strong>存储引擎就是指表的类型</strong>。其实存储引擎以前叫做<strong>表处理器</strong>，后来改名为<strong>存储引擎</strong>，它的功能就是接收上层传下来的指令，然后对表中的数据进行提取或写入操作</li>
</ul>
<h3 id="6-5-1-查看存储引擎"><a href="#6-5-1-查看存储引擎" class="headerlink" title="6.5.1 查看存储引擎"></a>6.5.1 查看存储引擎</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engines;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> Engine             <span class="operator">|</span> Support <span class="operator">|</span> Comment                                                        <span class="operator">|</span> Transactions <span class="operator">|</span> XA   <span class="operator">|</span> Savepoints <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> InnoDB             <span class="operator">|</span> <span class="keyword">DEFAULT</span> <span class="operator">|</span> Supports transactions, <span class="type">row</span><span class="operator">-</span>level locking, <span class="keyword">and</span> <span class="keyword">foreign</span> keys     <span class="operator">|</span> YES          <span class="operator">|</span> YES  <span class="operator">|</span> YES        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MRG_MYISAM         <span class="operator">|</span> YES     <span class="operator">|</span> Collection <span class="keyword">of</span> identical MyISAM tables                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MEMORY             <span class="operator">|</span> YES     <span class="operator">|</span> Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables      <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BLACKHOLE          <span class="operator">|</span> YES     <span class="operator">|</span> <span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> storage engine (anything you write <span class="keyword">to</span> it disappears) <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MyISAM             <span class="operator">|</span> YES     <span class="operator">|</span> MyISAM storage engine                                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CSV                <span class="operator">|</span> YES     <span class="operator">|</span> CSV storage engine                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARCHIVE            <span class="operator">|</span> YES     <span class="operator">|</span> Archive storage engine                                         <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> PERFORMANCE_SCHEMA <span class="operator">|</span> YES     <span class="operator">|</span> Performance Schema                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FEDERATED          <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> Federated MySQL storage engine                                 <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> engines \G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: InnoDB</span><br><span class="line">     Support: <span class="keyword">DEFAULT</span></span><br><span class="line">     Comment: Supports transactions, <span class="type">row</span><span class="operator">-</span>level locking, <span class="keyword">and</span> <span class="keyword">foreign</span> keys</span><br><span class="line">Transactions: YES</span><br><span class="line">          XA: YES</span><br><span class="line">  Savepoints: YES</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MRG_MYISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Collection <span class="keyword">of</span> identical MyISAM tables</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MEMORY</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: BLACKHOLE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: <span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> storage engine (anything you write <span class="keyword">to</span> it disappears)</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: MyISAM</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: MyISAM storage engine</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">6.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: CSV</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: CSV storage engine</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">7.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: ARCHIVE</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Archive storage engine</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">8.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: PERFORMANCE_SCHEMA</span><br><span class="line">     Support: YES</span><br><span class="line">     Comment: Performance Schema</span><br><span class="line">Transactions: <span class="keyword">NO</span></span><br><span class="line">          XA: <span class="keyword">NO</span></span><br><span class="line">  Savepoints: <span class="keyword">NO</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">9.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">      Engine: FEDERATED</span><br><span class="line">     Support: <span class="keyword">NO</span></span><br><span class="line">     Comment: Federated MySQL storage engine</span><br><span class="line">Transactions: <span class="keyword">NULL</span></span><br><span class="line">          XA: <span class="keyword">NULL</span></span><br><span class="line">  Savepoints: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>Engine参数表示存储引擎名称</li>
<li>Support参数表示MySQL数据库管理系统是否支持该存储引擎:YES表示支持，NO表示不支持。DEFAULT表示系统默认支持的存储引擎</li>
<li>Comment参数表示对存储引擎的评论</li>
<li>Transactions参数表示存储引擎是否支持事务:YES表示支持，NO表示不支持</li>
<li>XA参数表示存储引擎所支持的分布式是否符合XA规范: YES表示支持，NO表示不支持。代表着该存储引擎是否支持分布式事务</li>
<li>Savepoints参数表示存储引擎是否支持事务处理的保存点:YES表示支持，NO表示不支持。也就是说，该存储引擎是否支持部分事务回滚</li>
</ul>
<h3 id="6-5-2-设置系统默认的存储引擎"><a href="#6-5-2-设置系统默认的存储引擎" class="headerlink" title="6.5.2 设置系统默认的存储引擎"></a>6.5.2 设置系统默认的存储引擎</h3><ul>
<li><p>查看默认的存储引擎：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%storage_engine%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                    <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> default_storage_engine           <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> default_tmp_storage_engine       <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> disabled_storage_engines         <span class="operator">|</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> internal_tmp_disk_storage_engine <span class="operator">|</span> InnoDB <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------------------+--------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@default</span>_storage_engine;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@default</span>_storage_engine <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="operator">|</span> InnoDB                   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改默认的存储引擎</p>
<ul>
<li><p>如果在创建表的语句中没有显式指定表的存储引擎的话，那就会默认使用 InnoDB 作为表的存储引擎</p>
</li>
<li><p>改变表的默认存储引擎：</p>
<ul>
<li><p>可以这样写启动服务器的命令行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#修改存储引擎（临时的）</span><br><span class="line"><span class="keyword">SET</span> DEFAULT_STORAGE_ENGINE<span class="operator">=</span>MyISAM;</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者修改 my.cnf 文件（持久的）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span><span class="operator">-</span>storage<span class="operator">-</span>engine<span class="operator">=</span>MyISAM</span><br><span class="line"># 重启服务</span><br><span class="line">systemctl restart mysqld.service</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>存储引擎是用来处理表的，创建的表默认的存储引擎和系统默认的存储引擎相同</p>
</li>
</ul>
<h3 id="6-5-3-设置表的存储引擎"><a href="#6-5-3-设置表的存储引擎" class="headerlink" title="6.5.3 设置表的存储引擎"></a>6.5.3 设置表的存储引擎</h3><p>存储引擎是负责对表中的数据进行提取和写入工作的，可以为不同的表设置不同的存储引擎 ，也就是说不同的表可以有不同的物理存储结构，不同的提取和写入方式。表的存储引擎决定了表在底层存储数据的具体格式</p>
<h4 id="6-5-3-1-创建表时指定存储引擎"><a href="#6-5-3-1-创建表时指定存储引擎" class="headerlink" title="6.5.3.1 创建表时指定存储引擎"></a>6.5.3.1 创建表时指定存储引擎</h4><ul>
<li><p>创建表的语句没有指定表的存储引擎，那就会使用默认的存储引擎 InnoDB </p>
</li>
<li><p>如果想显式的指定一下表的存储引擎，那可以这么写：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名(</span><br><span class="line">建表语句;</span><br><span class="line">) ENGINE <span class="operator">=</span> 存储引擎名称;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="6-5-3-2-修改表的存储引擎"><a href="#6-5-3-2-修改表的存储引擎" class="headerlink" title="6.5.3.2 修改表的存储引擎"></a>6.5.3.2 修改表的存储引擎</h4><ul>
<li><p>如果表已经建好了，也可以使用下边这个语句来修改表的存储引擎：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 ENGINE <span class="operator">=</span> 存储引擎名称;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="6-5-4-引擎介绍"><a href="#6-5-4-引擎介绍" class="headerlink" title="6.5.4 引擎介绍"></a>6.5.4 引擎介绍</h3><h4 id="6-5-4-1-InnoDB-引擎：具备外键支持功能的事务存储引擎"><a href="#6-5-4-1-InnoDB-引擎：具备外键支持功能的事务存储引擎" class="headerlink" title="6.5.4.1 InnoDB 引擎：具备外键支持功能的事务存储引擎"></a>6.5.4.1 InnoDB 引擎：具备外键支持功能的事务存储引擎</h4><ul>
<li>InnoDB 引擎具备外键支持功能的事务存储引擎（InnoDB的优点一）</li>
<li>MySQL从3.23.34a开始就包含InnoDB存储引擎。 <strong>大于等于5.5之后，默认采用InnoDB引擎</strong> </li>
<li>InnoDB是MySQL的<strong>默认事务型引擎</strong>，它被设计用来处理大量的短期(short-lived)事务。可以确保事务的完整提交(Commit)和回滚(Rollback)（InnoDB的优点二）</li>
<li>除了增加和查询外（MyISAM擅长增加和查询）,还需要更新、删除操作，那么，应优先选择InnoDB存储引擎</li>
<li><strong>除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎</strong></li>
<li>数据文件结构：<ul>
<li>表名.frm 存储表结构（MySQL8.0时，合并在表名.ibd中）</li>
<li>表名.ibd 存储数据和索引</li>
</ul>
</li>
<li>InnoDB是 <strong>为处理巨大数据量的最大性能而设计</strong> （InnoDB的优点三）<ul>
<li>在以前的版本中，字典数据以元数据文件、非事务表等来存储。现在这些元数据文件被删除了。比如： <strong>.frm ， .par ， .trn ，.isl ， .db.opt</strong> 等都在MySQL8.0中不存在了</li>
</ul>
</li>
<li>对于并发量大的情况和数据量大的情况，<strong>InnoDB性能表现较好</strong>。InnoDB支持行级锁，行级锁粒度低，更适合于高并发的场景（InnoDB的优点四）</li>
<li>对比MyISAM的存储引擎， InnoDB写的处理效率差一些 ，并且会占用更多的磁盘空间以保存数据和索引（InnoDB缺点）</li>
<li>MyISAM只缓存索引，不缓存真实数据；InnoDB不仅缓存索引还要缓存真实数据， <strong>对内存要求较高</strong> ，而且内存大小对性能有决定性的影响</li>
</ul>
<h4 id="6-5-4-2-MyISAM-引擎：主要的非事务处理存储引擎"><a href="#6-5-4-2-MyISAM-引擎：主要的非事务处理存储引擎" class="headerlink" title="6.5.4.2 MyISAM 引擎：主要的非事务处理存储引擎"></a>6.5.4.2 MyISAM 引擎：主要的非事务处理存储引擎</h4><ul>
<li><p>MyISAM提供了大量的特性，包括全文索引、压缩、空间函数(GIS)等，但MyISAM <strong>不支持事务、行级锁、外键</strong>，有一个毫无疑问的缺陷就是<strong>崩溃后无法安全恢复</strong> </p>
</li>
<li><p><strong>5.5之前默认的存储引擎</strong></p>
</li>
<li><p>优势是访问的速度快 ，对事务完整性没有要求或者以SELECT、INSERT为主的应用</p>
</li>
<li><p>针对数据统计有额外的常数存储。故而 count(*) 的查询效率很高</p>
</li>
<li><p>数据文件结构：</p>
<ul>
<li>表名.frm 存储表结构</li>
<li>表名.MYD 存储数据 (MYData)</li>
<li>表名.MYI 存储索引 (MYIndex)</li>
</ul>
</li>
<li><p><strong>应用场景：只读应用或者以读为主的业务</strong></p>
</li>
</ul>
<table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁，即使操作一条记录也会锁住整个表，不适合高并发的操作</td>
<td>行锁，操作时只锁某一行，不对其它行有影响，适合高并发的操作</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性的影响</td>
</tr>
<tr>
<td>自带系统表使用</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>关注点</td>
<td>性能：节省资源、消耗少、简单业务</td>
<td>事务：并发写、事务、更大资源</td>
</tr>
<tr>
<td>默认安装</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>默认使用</td>
<td>N</td>
<td>Y</td>
</tr>
</tbody></table>
<h1 id="7-索引及调优"><a href="#7-索引及调优" class="headerlink" title="7.索引及调优"></a>7.索引及调优</h1><h2 id="7-1-索引"><a href="#7-1-索引" class="headerlink" title="7.1 索引"></a>7.1 索引</h2><h3 id="7-1-1-为什么使用索引"><a href="#7-1-1-为什么使用索引" class="headerlink" title="7.1.1 为什么使用索引"></a>7.1.1 为什么使用索引</h3><ul>
<li><p>索引是存储引擎用于快速查找数据记录的一种数据结构，类似书的目录部分</p>
</li>
<li><p>MySQL中，进行数据查找时：</p>
<ul>
<li>首先查看查询条件是否命中某条索引，符合则<strong>通过索引查找</strong>相关数据</li>
<li>如果不符合则需要<strong>全表扫描</strong>，即需要一条一条地查找记录，直到找到与条件符合的记录</li>
</ul>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95.png" alt="为什么使用索引"></p>
</li>
<li><p>如上图所示，数据库没有索引的情况下，数据<strong>分布在硬盘不同的位置上面</strong>，读取数据时，摆臂需要前后摆动查找数据，这样操作非常耗费时间。如果<strong>数据顺序摆放</strong>，那么也需要从1到6行按顺序读取，这样就相当于进行了6次IO操作，<strong>依旧非常耗时</strong>。如果不借助任何索引结构快速定位数据的话，查找Col12&#x3D;89这条记录，就要逐行去查找、去比较。从Col2&#x3D;34开始，进行比较，发现不是，继续下一行。当前的表只有不到10行数据，但如果表很大的话，有<strong>上千万条数据</strong>，就意味着要做<strong>很多次磁盘IO</strong>才能找到。现在要查找Col2&#x3D;89这条记录。CPU必须先去磁盘查找这条记录，找到之后加载到内存，再对数据进行处理。这个过程最耗时间的就是磁盘IO（涉及到磁盘的旋转时间（速度较快）、磁头的寻道时间（速度慢、费时））</p>
</li>
<li><p>假如给数据使用二叉树这样的数据结构进行存储，如下图所示：</p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BA%8C%E5%8F%89%E6%A0%91.png" alt="二叉树"></p>
<p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/%E4%BA%8C%E5%8F%89%E6%A0%91%E6%96%87%E5%AD%97.png" alt="二叉树文字"></p>
</li>
</ul>
<h3 id="7-1-2-索引及其优缺点"><a href="#7-1-2-索引及其优缺点" class="headerlink" title="7.1.2 索引及其优缺点"></a>7.1.2 索引及其优缺点</h3><h4 id="7-1-2-1-索引概述"><a href="#7-1-2-1-索引概述" class="headerlink" title="7.1.2.1 索引概述"></a>7.1.2.1 索引概述</h4><ul>
<li>索引的定义：<strong>索引是帮助MySQL高效获取数据的数据结构</strong></li>
<li><strong>索引的本质</strong>：索引是数据结构，可以简单的理解为”排好序的快速查找数据结构”，满足特定的查找算法。这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现<strong>高级查找算法</strong></li>
<li><strong>索引是在存储引擎中实现的</strong>，因此每一种存储引擎的索引不一定完全相同，并且每种存储引擎不一定支持所有索引类型。同时，存储引擎可以定义每个表的<strong>最大索引数</strong>和<strong>最大索引长度</strong>。所有存储引擎支持每个表至少16个索引，总索引长度至少为256字节。有些存储引擎支持更多的索引数和更大的索引长度</li>
</ul>
<h4 id="7-1-2-2-优点"><a href="#7-1-2-2-优点" class="headerlink" title="7.1.2.2 优点"></a>7.1.2.2 优点</h4><ul>
<li>1.类似于书目录，提高数据检索的效率，降低<strong>数据库的IO成本</strong></li>
<li>2.通过创建唯一索引，可以保证数据库中每一行<strong>数据的唯一性</strong></li>
<li>3.在实现数据的参考完整性方面，可以加速<strong>表与表之间的连接</strong>，即对于有依赖关系的子表和父表联合查询时，可以提高查询速度</li>
<li>4.在使用分组和排序子句进行数据查询时，可以显著<strong>减少查询中分组和排序的时间</strong>，降低了CPU的消耗</li>
</ul>
<h4 id="7-1-2-3-缺点"><a href="#7-1-2-3-缺点" class="headerlink" title="7.1.2.3 缺点"></a>7.1.2.3 缺点</h4><ul>
<li>1.创建索引和维护索引要<strong>耗费时间</strong>，并且随着数据量的增加，所耗费的时间也会增加</li>
<li>索引需要占<strong>磁盘空间</strong>，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，<strong>存储在磁盘上</strong>，如果有大量索引，索引文件就可能比数据文件更快达到最大文件尺寸</li>
<li>3.索引大大提高查询速度，同时会<strong>降低表的更新速度</strong>。当对表中的数据进行增删改时，索引也需要动态维护，这样就降低了数据的维护速度</li>
</ul>
<h3 id="7-1-3-InnoDB中索引的推演"><a href="#7-1-3-InnoDB中索引的推演" class="headerlink" title="7.1.3 InnoDB中索引的推演"></a>7.1.3 InnoDB中索引的推演</h3><h4 id="7-1-3-1-索引之前的查找"><a href="#7-1-3-1-索引之前的查找" class="headerlink" title="7.1.3.1 索引之前的查找"></a>7.1.3.1 索引之前的查找</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> [列名列表] <span class="keyword">from</span> 表名 <span class="keyword">where</span> 列名<span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在一个页中的查找</p>
</blockquote>
<ul>
<li>假设目前表中的记录比较少，所有的记录都可以被存放到一个页中，在查找记录的时候可以根据搜索条件的不同分为两种情况：<ul>
<li>以主键为搜索条件<ul>
<li>可以在页目录中使用<strong>二分法</strong>快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录</li>
</ul>
</li>
<li>以其他列作为搜索条件<ul>
<li>因为在数据页中并没有对非主键列建立所谓的页目录，所以我们无法通过二分法快速定位相应的槽。这种情况下只能从<strong>最小记录</strong>开始<strong>依次遍历</strong>单链表中的每条记录，然后对比每条记录是否符合搜索条件。查询效率非常低</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>在很多页中查找</p>
</blockquote>
<ul>
<li>大部分情况下表中存放的记录是非常多的，需要好多数据页来存储这些记录。在很多页中查找记录的话，可以分为两步：<ul>
<li>1.定位到记录所在的表</li>
<li>2.从所在的页内中查找相应的记录</li>
</ul>
</li>
<li>在没有索引的情况下，不论是根据主键列或者其他列的值进行查找，由于并不能快速的定位到记录所在的页，所以只能<strong>从第一页</strong>沿着<strong>双向链表</strong>一直往下找，每一页根据上面的查找方式去查找指定的记录。因此需要遍历所有的数据页，<strong>非常耗时</strong>。由此引出<strong>索引</strong></li>
</ul>
<h4 id="7-1-3-2-设计索引"><a href="#7-1-3-2-设计索引" class="headerlink" title="7.1.3.2 设计索引"></a>7.1.3.2 设计索引</h4><ul>
<li><p>建立一个表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> index_demo(</span><br><span class="line">	c1 <span class="type">int</span>,</span><br><span class="line">    c2 <span class="type">int</span>,</span><br><span class="line">    c3 <span class="type">char</span>(<span class="number">1</span>),</span><br><span class="line">    <span class="keyword">primary</span> key(c1)</span><br><span class="line">)row_format<span class="operator">=</span>Compact;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个新建的<strong>index_demo</strong>表中有2个int类型的列，1个char(1)类型的列，c1列为主键，这个表使用<strong>Compact</strong>行格式来实际存储记录。下面是简化的index_demo表的行格式示意图：</p>
<p><img src="image-20221125135047152.png" alt="MySQL之性能优化/image-20221125135047152"></p>
</li>
<li><p>只在示意图里展示记录的这几个部分： </p>
<ul>
<li><p><strong>record_type</strong> ：记录头信息的一项属性，表示记录的类型， 0 表示普通记录、 2 表示最小记 录、 3 表示最大记录、 1 表示目录项记录</p>
</li>
<li><p><strong>next_record</strong> ：记录头信息的一项属性，表示下一条地址相对于本条记录的地址偏移量，我们用 箭头来表明下一条记录是谁</p>
</li>
<li><p><strong>各个列的值</strong> ：这里只记录在 <strong>index_demo</strong> 表中的三个列，分别是 c1 、 c2 和 c3 </p>
</li>
<li><p>其他信息 ：除了上述3种信息以外的所有信息，包括其他隐藏列的值以及记录的<strong>额外信息</strong></p>
</li>
<li><p>将记录格式示意图的其他信息项暂时去掉并把它竖起来的效果就是这样：</p>
<p><img src="image-20221125135401382.png" alt="MySQL之性能优化/image-20221125135401382"></p>
</li>
</ul>
</li>
<li><p>把一些记录放到页里的示意图就是：</p>
<p><img src="image-20221125135435664.png" alt="MySQL之性能优化/image-20221125135435664"></p>
</li>
</ul>
<blockquote>
<p> <strong>一个简单的索引设计方案</strong> </p>
</blockquote>
<ul>
<li><p>我们在根据某个搜索条件查找一些记录时为什么要遍历所有的数据页呢？因为各个页中的记录并没有规 律，我们并不知道我们的搜索条件匹配哪些页中的记录，所以不得不依次遍历所有的数据页。所以如果 我们 <strong>想快速的定位到需要查找的记录在哪些数据页</strong> 中该咋办？我们可以为快速定位记录所在的数据页而 <strong>建立一个目录</strong> ，建这个目录必须完成下边这些事： </p>
<ul>
<li><p><strong>下一个数据页中用户记录的主键值必须大于上一个页中用户记录的主键值</strong></p>
<ul>
<li><p>假设：每个数据页最多能存放3条记录，然后向<strong>index_demo</strong>表插入三条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> index_demo <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">4</span>,<span class="string">&#x27;u&#x27;</span>),(<span class="number">3</span>,<span class="number">9</span>,<span class="string">&#x27;d&#x27;</span>),(<span class="number">5</span>,<span class="number">3</span>,<span class="string">&#x27;y&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>那么这些记录已经按照主键值的大小串联成一个单向链表，如图所示：</p>
<p><img src="image-20221125143825892.png" alt="MySQL之性能优化/image-20221125143825892"></p>
</li>
<li><p>从图中可以看出，<strong>index_demo</strong>表中的3条记录都被插入到了编号为<strong>10</strong>的数据页中了，此时再来插入一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> index_demo <span class="keyword">values</span>(<span class="number">4</span>,<span class="number">4</span>,<span class="string">&#x27;a&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为数据页10最多只能存放3条记录，所以必须再分配一个新页：</p>
<p><img src="image-20221125144315455.png" alt="MySQL之性能优化/image-20221125144315455"></p>
</li>
<li><p>注意：新分配的<strong>数据页编号</strong>可能并不是连续的。它们只是通过维护着上一个页和下一个页的编号而建立了<strong>链表</strong>关系。此为，<strong>页10</strong>中用户记录最大主键值是<strong>5</strong>，而<strong>页28</strong>中有一条记录的主键值是4，因为<strong>5&gt;4</strong>，所以这就不符合<strong>下一个数据页中用户记录的主键值必须大于上一个数据页中用户记录的主键值</strong>的要求，所以在插入主键值为4的记录的时候要伴随一次<strong>记录移动</strong>，也就是把主键值为5的记录移动到数据页28中，然后再把主键值为4的记录插入到数据页10中，过程如下：</p>
<p><img src="image-20221125145227224.png" alt="MySQL之性能优化/image-20221125145227224"></p>
</li>
<li><p>这个过程表明了在对数据页的记录进行增删改查的过程中，必须通过一些诸如<strong>记录移动</strong>的操作来始终保持这个状态一直成立：<strong>下一个数据页中用户记录的主键值必须大于上一个数据页中用户记录的主键值</strong>。这个过程被称为<strong>页分裂</strong></p>
</li>
</ul>
</li>
<li><p><strong>给所有的页建立一个目录项</strong></p>
<ul>
<li><p>由于数据页的<strong>编号可能是不连续</strong>的，所以在向index_demo表插入许多条记录后，可能时这样的效果：</p>
<p><img src="image-20221125150014804.png" alt="MySQL之性能优化/image-20221125150014804"></p>
</li>
<li><p>因为这些<strong>16KB</strong>的数据页在物理存储上是<strong>不连续</strong>的，所以如果想从这么多页中根据主键值<strong>快速定位某些记录所在的页</strong>，我们需要给它们做个<strong>目录</strong>，每个页对应一个目录项，每一个目录项包含两个部分：</p>
<ul>
<li>数据页的用户记录中的最小的主键值，用<strong>key</strong>表示</li>
<li>页号，用<strong>page_no</strong>表示</li>
</ul>
</li>
<li><p>所以为上边几个页做好的目录就像这样子：</p>
<p><img src="image-20221125143225533.png" alt="MySQL之性能优化/image-20221125143225533"></p>
</li>
<li><p>以 <strong>页28</strong> 为例，它对应 <strong>目录项2</strong> ，这个目录项中包含着该页的页号 <strong>28</strong> 以及该页中用户记录的最小主 键值 <strong>5</strong> 。我们只需要把几个目录项在物理存储器上连续存储（比如：数组），就可以实现根据主键 值快速查找某条记录的功能了。比如：查找主键值为 <strong>20</strong> 的记录，具体查找过程分两步： </p>
<ul>
<li><p>1.先从目录项中根据 <strong>二分法</strong> 快速确定出主键值为 <strong>20</strong> 的记录在 <strong>目录项3</strong> 中（因为 <strong>12 &lt; 20 &lt; 209</strong> ），它对应的页是 <strong>页9</strong> </p>
</li>
<li><p>2.再根据前边说的在页中查找记录的方式去 <strong>页9</strong> 中定位具体的记录</p>
</li>
</ul>
</li>
<li><p>至此，针对数据页做的简易目录就搞定了。这个目录有一个别名，称为<strong>索引</strong></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>InnoDB中的索引方案</strong></p>
</blockquote>
<ul>
<li><p><strong>① 迭代1次</strong>目录项纪录的页 </p>
<ul>
<li><p>上边称为一个简易的索引的方案，是因为为了在根据主键值进行查找时使用<strong>二分法</strong>快速查定位具体的目录项而<strong>假设</strong>所有的目录项都可以在物理存储器上<strong>连续存储</strong>，但是这样做有几个问题：</p>
<ul>
<li>InnoDB是使用页来作为管理存储空间的基本单位，最多能保证<strong>16KB</strong>的连续存储空间，而随着表中记录数量的增多，需要<strong>非常大的连续的存储空间</strong>才能把所有的目录项都放下，这对记录数量非常多的表是不现实的</li>
<li>经常会对<strong>记录进行增删</strong>，假设我们把<strong>页28</strong>中的记录都删除了，那就也意味着<strong>目录项2</strong>没有存在的必要了，这就需要把目录项2后的目录项都向前移动一下，这样牵一发而动全身的操作效率很差</li>
</ul>
</li>
<li><p>所以，我们需要一种可以<strong>灵活管理所有数据项</strong>的方式。发现目录项其实长得跟用户记录差不多，只不过目录项中的两个列分别是<strong>主键</strong>和<strong>页号</strong>而已。为了和用户记录做区分，把这些用来表示目录项的记录称为<strong>目录项记录</strong>。那么InnoDB怎么区分一条记录是普通的<strong>用户记录</strong>还是<strong>目录项记录</strong>呢？使用记录头信息里的<strong>record_type</strong>属性，它的各个取值代表的意思如下：</p>
<ul>
<li>0：普通的用户记录</li>
<li>1：目录项记录</li>
<li>2：最小记录</li>
<li>3：最大记录</li>
</ul>
</li>
<li><p>把前边使用到的目录项放到数据页中的样子就是这样：</p>
</li>
</ul>
<p><img src="image-20221125174429599.png" alt="MySQL之性能优化/image-20221125174429599"></p>
<ul>
<li>从图中可以看出来，我们新分配了一个编号为30的页来专门存储目录项记录。这里再次强调 <strong>目录项记录</strong> 和普通的 <strong>用户记录</strong> 的<strong>：</strong><ul>
<li><strong>目录项记录</strong> 的 <strong>record_type</strong> 值是1，而 <strong>普通用户记录</strong> 的 <strong>record_type</strong> 值是0</li>
<li>目录项记录只有 <strong>主键值和页的编号</strong> 两个列，而普通的用户记录的列是用户自己定义的，可能包含 <strong>很 多列</strong> ，另外还有InnoDB自己添加的隐藏列</li>
<li>了解：记录头信息里还有一个叫 <strong>min_rec_mask</strong> 的属性，只有在存储 <strong>目录项记录</strong> 的页中的主键值 最小的 <strong>目录项记录</strong> 的 <strong>min_rec_mask</strong> 值为 <strong>1</strong> ，其他别的记录的 <strong>min_rec_mask</strong> 值都是 <strong>0</strong></li>
</ul>
</li>
<li><strong>相同点</strong>：两者用的是一样的数据页，都会为主键值生成 <strong>Page Directory</strong> （页目录），从而在按照主键 值进行查找时可以使用 <strong>二分法</strong> 来加快查询速度</li>
<li>现在以查找主键为 <strong>20</strong> 的记录为例，<strong>根据某个主键值去查找记录的步骤就可以大致拆分成下边两步</strong>：<ul>
<li>先到存储 <strong>目录项记录</strong> 的页，也就是页<strong>30</strong>中通过 <strong>二分法</strong> 快速定位到对应目录项，因为 <strong>12 &lt; 20 &lt; 209</strong> ，所以定位到对应的记录所在的页就是页<strong>9</strong></li>
<li>再到存储用户记录的页9中根据 <strong>二分法</strong> 快速定位到主键值为 <strong>20</strong> 的用户记录</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>②迭代2次：多个目录项纪录的页</strong></p>
<ul>
<li><p>虽然说<strong>目录项记录</strong>中只存储主键值和对应的页号，比用户记录需要的存储空间小多了，但是不论怎么说一个页只有<strong>16KB</strong>大小，能存放的<strong>目录项记录</strong>也是有限的，那如果表中的数据太多，以至于一个数据页不能存放所有的<strong>目录项记录</strong>，如何处理？</p>
</li>
<li><p>这里假设一个存储目录项记录的页<strong>最多只能存放4条目录项记录</strong>，所以如果此时再向表中插入一条主键值为<strong>320</strong>的用户记录的话，那么就需要分配一个新的存储<strong>目录项记录</strong>的页：</p>
<p><img src="image-20221125205359476.png" alt="MySQL之性能优化/image-20221125205359476"></p>
</li>
<li><p>从图中可以看出，我们插入了一条主键值为320的用户记录之后需要两个新的数据页： </p>
<ul>
<li>为存储该用户记录而新生成了 <strong>页31</strong> </li>
<li>因为原先存储目录项记录的 页30的容量已满 （我们前边假设只能存储4条目录项记录），所以不得 不需要一个新的 页32 来存放 页31 对应的目录项</li>
</ul>
</li>
<li><p>现在因为存储目录项记录的页不止一个，所以如果我们想根据主键值查找一条用户记录大致需要3个步 骤，以查找主键值为 20 的记录为例： </p>
<ul>
<li><p>1.确定<strong>目录项记录页</strong>：我们现在的存储目录项记录的页有两个，即 <strong>页30</strong> 和 <strong>页32</strong> ，又因为页30表示的目录项的主键值的 范围是 <strong>[1, 320)</strong> ，页32表示的目录项的主键值不小于 <strong>320</strong> ，所以主键值为 <strong>20</strong> 的记录对应的目 录项记录在 <strong>页30</strong> 中</p>
</li>
<li><p>2.通过目录项记录页 <strong>确定用户记录真实所在的页</strong>： 在一个存储 目录项记录 的页中通过主键值定位一条目录项记录的方式说过了</p>
</li>
<li><p>3.在真实存储用户记录的页中定位到具体的记录</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>③ 迭代3次：目录项记录页的目录页</strong></p>
<ul>
<li><p>问题来了，在这个查询步骤的第一步中需要定位存储目录项记录的页，但这些<strong>页是不连续的</strong>，如果表中数据非常多则会<strong>产生很多存储目录项记录的页</strong>，那么怎么根据主键值快速定位一个存储目录项记录的页呢？那就为这些存储目录项记录的页再生成一个<strong>更高级的目录</strong>，就像是一个多级目录一样，<strong>大目录嵌套小目录</strong>，小目录里才是实际的数据，所以现在各个页的示意图如下：</p>
<p><img src="image-20221125211436009.png" alt="MySQL之性能优化/image-20221125211436009"></p>
</li>
<li><p>如图，我们生成了一个存储更高级目录项的 <strong>页33</strong> ，这个页中的两条记录分别代表页30和页32，如果用 户记录的主键值在 <strong>[1, 320)</strong> 之间，则到页30中查找更详细的目录项记录，如果主键值 <strong>不小于320</strong> 的 话，就到页32中查找更详细的目录项记录</p>
</li>
<li><p>随着表中记录的增加，这个目录的层级会继续增加，如果简化一下，那么可以用下图描述：</p>
<p><img src="image-20221125212126795.png" alt="MySQL之性能优化/image-20221125212126795"></p>
</li>
<li><p>这个数据结构，它的名称是 <strong>B+树</strong></p>
</li>
</ul>
</li>
<li><p><strong>④ B+Tree</strong></p>
<ul>
<li>不论是存放<strong>用户记录</strong>的数据页，还是存放<strong>目录项记录</strong>的数据页，都把它存放到B+树这个数据结构中了。所以也称为这些数据页为<strong>节点</strong>。从图中可以看出，我们的实际用户记录其实都存放在B+树的最底层的节点上，这些节点也被称为<strong>叶子节点</strong>，其余存放<strong>目录项</strong>的节点称为<strong>非叶子节点</strong>或者<strong>内节点</strong>，其中B+树最上边的节点也称为<strong>根节点</strong></li>
<li>一个B+树的节点其实可以分成好多层，规定最下边的那层，也就是存放我们用户记录的那层为第 <strong>0</strong> 层， 之后依次往上加。之前我们做了一个非常极端的假设：存放用户记录的页 <strong>最多存放3条记录</strong> ，存放目录项 记录的页 <strong>最多存放4条记录</strong> 。其实真实环境中一个页存放的记录数量是非常大的，假设所有存放用户记录 的叶子节点代表的数据页可以存放 <strong>100条用户记录</strong> ，所有存放目录项记录的内节点代表的数据页可以存 放 <strong>1000条目录项记录</strong> ，那么：<ul>
<li>如果B+树只有1层，也就是只有1个用于存放用户记录的节点，最多能存放 <strong>100</strong> 条记录</li>
<li>如果B+树有2层，最多能存放 <strong>1000×100&#x3D;10,0000</strong> 条记录</li>
<li>如果B+树有3层，最多能存放 <strong>1000×1000×100&#x3D;1,0000,0000</strong> 条记录</li>
<li>如果B+树有4层，最多能存放 <strong>1000×1000×1000×100&#x3D;1000,0000,0000</strong> 条记录。相当多的记录</li>
</ul>
</li>
<li>你的表里能存放 <strong>100000000000</strong> 条记录吗？所以一般情况下，我们 <strong>用到的B+树都不会超过4层</strong> ，那我们 通过主键值去查找某条记录最多只需要做4个页面内的查找（查找3个目录项页和一个用户记录页），又 因为在每个页面内有所谓的 <strong>Page Directory</strong> （页目录），所以在页面内也可以通过 <strong>二分法</strong> 实现快速 定位记录</li>
</ul>
</li>
</ul>
<h4 id="7-1-3-3-常见的索引概念"><a href="#7-1-3-3-常见的索引概念" class="headerlink" title="7.1.3.3 常见的索引概念"></a>7.1.3.3 常见的索引概念</h4><ul>
<li>索引按照物理实现方式，索引可以分为 2 种：聚簇（聚集）和非聚簇（非聚集）索引。我们也把非聚集 索引称为二级索引或者辅助索引</li>
</ul>
<blockquote>
<p>1.聚簇索引</p>
</blockquote>
<ul>
<li><strong>特点</strong>： <ul>
<li>1.使用记录主键值的大小进行记录和页的排序，这包括三个方面的含义： <ul>
<li><strong>页内</strong> 的记录是按照<strong>主键</strong>的大小顺序排成一个 <strong>单向链表</strong> </li>
<li>各个存放 <strong>用户记录的页</strong> 也是根据页中用户记录的<strong>主键</strong>大小顺序排成一个 <strong>双向链表</strong> </li>
<li>存放 <strong>目录项记录的页</strong> 分为不同的层次，在同一层次中的页也是根据页中目录项记录的<strong>主键</strong> 大小顺序排成一个 <strong>双向链表</strong></li>
</ul>
</li>
<li>2.B+树的 <strong>叶子节点</strong> 存储的是<strong>完整的用户记录</strong><ul>
<li>所谓完整的用户记录，就是指这个记录中存储了所有列的值（包括隐藏列）</li>
</ul>
</li>
</ul>
</li>
<li>我们把具有这两种特性的B+树称为<strong>聚簇索引</strong>，所有<strong>完整的用户记录</strong>都存放在这个<strong>聚簇索引</strong>的叶子节点处。这种聚簇索引并不需要在MySQL语句中显示的使用<strong>INDEX</strong>语法去创建，<strong>InnoDB</strong>存储引擎会<strong>自动</strong>的创建聚簇索引</li>
<li><strong>优点</strong>： <ul>
<li><strong>数据访问更快</strong> ，因为聚簇索引将索引和数据保存在同一个B+树中，因此从聚簇索引中获取数据比非 聚簇索引更快 </li>
<li>聚簇索引对于主键的 <strong>排序查找</strong> 和 <strong>范围查找</strong> 速度非常快 </li>
<li>按照聚簇索引排列顺序，查询显示一定范围数据的时候，由于数据都是紧密相连，数据库不用从多 个数据块中提取数据，所以 <strong>节省了大量的io操作</strong></li>
</ul>
</li>
<li><strong>缺点</strong>： <ul>
<li><strong>插入速度严重依赖于插入顺序</strong> ，按照主键的顺序插入是最快的方式，否则将会出现页分裂，严重影 响性能。因此，对于InnoDB表，我们一般都会定义一个<strong>自增的ID列为主键</strong> </li>
<li>更新主键的代价很高 ，因为将会导致被更新的行移动。因此，对于InnoDB表，我们一般定义<strong>主键为不可更新</strong> </li>
<li><strong>二级索引访问需要两次索引查找</strong> ，第一次找到主键值，第二次根据主键值找到行数据</li>
</ul>
</li>
<li><strong>限制</strong>：<ul>
<li>对于MySQL数据库目前只有InnoDB数据引擎支持聚簇索引，而MyISAM并不支持聚簇索引</li>
<li>由于数据物理存储排序方式只能有一种，所以每个MySQL的表<strong>只能有一个聚簇索引</strong>。一般情况下就是该表的主键索引</li>
<li>如果没有定义主键，InnoDB会选择<strong>非空的唯一索引代替</strong>。如果没有这样的索引，InnoDB会隐式的定义一个主键作为聚簇索引</li>
<li>为了充分利用聚簇索引的聚簇的特性，索引InnoDB表的主键尽量<strong>选用有序的id</strong>，比如UUID、MD5、HASH、字符串列作为主键无法保证数据的顺序增长</li>
</ul>
</li>
</ul>
<blockquote>
<p>2.二级索引（辅助索引、非聚簇索引）</p>
</blockquote>
<ul>
<li><p>上边介绍的<strong>聚簇索引</strong>只能在搜索条件是<strong>主键值</strong>时才能发挥作用，因为B+树中的数据都是按照主键进行排序的。那么想以别的列作为搜索条件该怎么办？</p>
</li>
<li><p>答案：可以<strong>多建几颗B+树</strong>，不同的B+树中的数据采用不同的排序规则。比如用c2列的大小作为数据页、页中记录的排序规则，再建一颗B+树，效果图如下：</p>
<p><img src="image-20221125222805959.png" alt="MySQL之性能优化/image-20221125222805959"></p>
<p><img src="image-20221125223512909.png" alt="MySQL之性能优化/image-20221125223512909"></p>
</li>
<li><p><strong>概念</strong>：<strong>回表</strong> 我们根据这个以c2列大小排序的B+树只能确定我们要查找记录的主键值，所以如果我们想根 据c2列的值查找到<strong>完整的用户记录</strong>的话，仍然需要到 <strong>聚簇索引</strong> 中再查一遍，这个过程称为 <strong>回表</strong> 。也就 是根据c2列的值<strong>查询一条完整的用户记录需要使用到 2 棵B+树</strong></p>
</li>
<li><p><strong>问题</strong>：为什么我们还需要一次 回表 操作呢？直接把完整的用户记录放到叶子节点不OK吗？</p>
<p><img src="image-20221125223648404.png" alt="MySQL之性能优化/image-20221125223648404"></p>
<p><img src="image-20221125223715177.png" alt="MySQL之性能优化/image-20221125223715177"></p>
</li>
</ul>
<p><img src="image-20221125223834861.png" alt="MySQL之性能优化/image-20221125223834861"></p>
<blockquote>
<p>3.联合索引</p>
</blockquote>
<ul>
<li><p>我们也可以同时以多个列的大小作为排序规则，也就是同时为多个列建立索引，比方说我们想让B+树按照 <strong>c2和c3列</strong> 的大小进行排序，这个包含两层含义： </p>
<ul>
<li>先把各个记录和页按照c2列进行排序</li>
<li>在记录的c2列相同的情况下，采用c3列进行排序</li>
</ul>
</li>
<li><p>为c2和c3建立的索引的示意图如下：</p>
<p><img src="image-20221125224140120.png" alt="MySQL之性能优化/image-20221125224140120"></p>
<p><img src="image-20221125224229862.png" alt="MySQL之性能优化/image-20221125224229862"></p>
</li>
<li><p>注意一点，以c2和c3列的大小为排序规则建立的B+树称为 <strong>联合索引</strong> ，本质上也是一个二级索引。它的意 思与分别为c2和c3列分别建立索引的表述是不同的，不同点如下： </p>
<ul>
<li>建立 <strong>联合索引</strong> 只会建立如上图一样的1棵B+树</li>
<li>为c2和c3列分别建立索引会分别以c2和c3列的大小为排序规则建立2棵B+树</li>
</ul>
</li>
</ul>
<h4 id="7-1-3-4-InnoDB的B-树索引的注意事项"><a href="#7-1-3-4-InnoDB的B-树索引的注意事项" class="headerlink" title="7.1.3.4 InnoDB的B+树索引的注意事项"></a>7.1.3.4 InnoDB的B+树索引的注意事项</h4><blockquote>
<p><strong>1.根页面位置万年不动</strong> </p>
</blockquote>
<ul>
<li>实际上B+树的形成过程如下：<ul>
<li>每当为某个表创建一个B+树索引（聚簇索引不是人为创建的，默认就有）的时候，都会为这个索引创建一个<strong>根节点</strong>页面。最开始表中没有数据的时候，每个B+树索引的<strong>根节点</strong>中既没有用户记录，也没有目录项记录</li>
<li>随后向表中插入用户记录时，先把用户记录存储到这个<strong>根节点</strong>中</li>
<li>当根节点中的可用<strong>空间用完时</strong>继续插入记录，此时会将根节点中的所有记录复制一份到一个新分配的页，比如<strong>页a</strong>中，然后对这个新页进行<strong>页分裂</strong>的操作，得到另一个新页，比如<strong>页b</strong>。这时新插入的记录根据键值（也就是聚簇索引中的主键值，二级索引中对应索引列的值）的大小就会分配到<strong>页a</strong>或者<strong>页b</strong>中，而<strong>根节点</strong>便升级为存储目录项记录的页</li>
</ul>
</li>
<li>这个过程特别注意的是：一个B+树索引的根节点自诞生之日起，便不会移动。这样只要我们对某个表建立一个索引，那么它的根节点的页号便会被记录到某个地方，然后凡是<strong>InnoDB</strong>存储引擎需要用到这个索引的时候，都会从那个固定的地方取出根节点的页号，从而访问到这个索引</li>
</ul>
<blockquote>
<p><strong>2.内节点中目录项记录的唯一性</strong></p>
</blockquote>
<ul>
<li><p>B+树索引的内节点中目录项记录的内容是<strong>索引列+页号</strong>的搭配，但是这个搭配对于二级索引来说有点不严谨。以<strong>index_demo</strong>表为例，假设这个表中的数据是这样的：</p>
<table>
<thead>
<tr>
<th>c1</th>
<th>c2</th>
<th>c3</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>‘u’</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>‘d’</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
<td>‘y’</td>
</tr>
<tr>
<td>7</td>
<td>1</td>
<td>‘a’</td>
</tr>
</tbody></table>
</li>
<li><p>如果二级索引中目录项记录的内容只是<strong>索引列+页号</strong>的搭配的话，那么为<strong>c2列</strong>建立索引后的B+树应该长这样：</p>
<p><img src="image-20221126150705142.png" alt="MySQL之性能优化/image-20221126150705142"></p>
</li>
<li><p>如果想插入一条记录，其中<strong>c1、c2、c3</strong>的值分别是<strong>9、1、’c’<strong>，那么在修改这个为c2列建立的二级索引对应的B+树时便碰到了大问题：由于</strong>页3</strong>中存储的目录项记录是由<strong>c2列+页号</strong>的值构成的，<strong>页3</strong>中的两条目录项记录对应的c2列的值都为<strong>1</strong>，而<strong>新插入的这条记录</strong>的c2列的值也是<strong>1</strong>，那么这条新插入的记录到底应该放到<strong>页4</strong>中，还应该放到<strong>页5</strong>中？不清楚</p>
</li>
<li><p>为了让新插入记录能找到自己在哪个页里，需要<strong>保证在B+树的同一层内节点的目录项记录除页号这个字段以外是唯一的</strong>。所以对于二级索引的内节点的目录项记录的内容实际上是由三个部分构成的：</p>
<ul>
<li>索引列的值</li>
<li>主键值</li>
<li>页号</li>
</ul>
</li>
<li><p>也就是把<strong>主键值</strong>也添加到二级索引内节点的目录项记录了，这样就能保证B+树每一层节点中各条目录项记录除页号这个字段以外是唯一的，所以我们为c2列建立二级索引后的示意图应该是这样子的：</p>
<p><img src="image-20221126152432398.png" alt="MySQL之性能优化/image-20221126152432398"></p>
</li>
<li><p>这样再插入记录**(9,1,’c’)<strong>时，由于</strong>页3<strong>中存储的目录项记录是由</strong>c2列+主键+页号<strong>的值构成的，可以先把新记录的</strong>c2列<strong>和个目录项记录的</strong>c2列<strong>的值作比较，如果c2列的值相同的话，可以接着比较主键值，因为B+树同一层中不同目录项记录的</strong>c2列+主键<strong>的值肯定是不一样的，所以最后能定位唯一的一条目录项记录，在本例中最后确定新记录应该插入到</strong>页5**中</p>
</li>
</ul>
<blockquote>
<p><strong>3.一个页面最少存储2条记录</strong></p>
</blockquote>
<ul>
<li>一个B+树只需要很少的层级就可以轻松存储数亿条记录，查询速度相当不错！这是因为B+树本质就是一个大的多级目录，每经过一个目录都会过滤掉许多无效的子目录，直到最后访问到存储真实数据的目录。那如果一个大的目录中只存放一个子目录是个啥效果？那就是目录层级非常非常非常多，而且最后那个存放真实数据的目录中只能存放一条记录。费了半天只能存放一条真实的用户记录？所以<strong>InnoDB的一个数据页者少可以存放两条记录</strong></li>
</ul>
<h3 id="7-1-4-MyISAM中的索引方案"><a href="#7-1-4-MyISAM中的索引方案" class="headerlink" title="7.1.4 MyISAM中的索引方案"></a>7.1.4 MyISAM中的索引方案</h3><ul>
<li><p>B树索引适用存储引擎如表所示：</p>
<table>
<thead>
<tr>
<th>索引&#x2F;存储引擎</th>
<th>MyISAM</th>
<th>InnoDB</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>B-Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody></table>
</li>
<li><p>即使多个存储引擎支持同一种类型的索引，但是他们的实现原理也是不同的。Innodb和MyISAM默认的索 引是Btree索引；而Memory默认的索引是Hash索引</p>
</li>
<li><p>MyISAM引擎使用 <strong>B+Tree</strong> 作为索引结构，叶子节点的data域存放的是 <strong>数据记录的地址</strong></p>
</li>
</ul>
<h4 id="7-1-4-1-MyISAM索引的原理"><a href="#7-1-4-1-MyISAM索引的原理" class="headerlink" title="7.1.4.1 MyISAM索引的原理"></a>7.1.4.1 MyISAM索引的原理</h4><p><img src="image-20221126154641774.png" alt="MySQL之性能优化/image-20221126154641774"></p>
<p><img src="image-20221126154752128.png" alt="MySQL之性能优化/image-20221126154752128"></p>
<p><img src="image-20221126155001288.png" alt="MySQL之性能优化/image-20221126155001288"></p>
<p><img src="image-20221126155034671.png" alt="MySQL之性能优化/image-20221126155034671"></p>
<p>同样也是一颗B+Tree，data域保存数据记录的地址。因此，MyISAM中索引检索的算法为：首先按照B+Tree搜索算法搜索索引，如果指定key存在，则取出其data域的值，然后以data域的值为地址，读取相应的数据记录</p>
<h4 id="7-1-4-2-MyISAM-与-InnoDB对比"><a href="#7-1-4-2-MyISAM-与-InnoDB对比" class="headerlink" title="7.1.4.2 MyISAM 与 InnoDB对比"></a>7.1.4.2 MyISAM 与 InnoDB对比</h4><ul>
<li><p><strong>MyISAM的索引方式都是“非聚簇”的，与InnoDB包含1个聚簇索引是不同的。小结两种引擎中索引的区别：</strong> </p>
<ul>
<li>① 在InnoDB存储引擎中，我们只需要根据主键值对 <strong>聚簇索引</strong> 进行一次查找就能找到对应的记录，而在 <strong>MyISAM</strong> 中却需要进行一次 <strong>回表</strong> 操作，意味着MyISAM中建立的索引相当于全部都是 <strong>二级索引</strong>  </li>
<li>② InnoDB的数据文件本身就是索引文件，而MyISAM索引文件和数据文件是 <strong>分离的</strong> ，索引文件仅保存数 据记录的地址</li>
<li>③ InnoDB的非聚簇索引data域存储相应记录 <strong>主键的值</strong> ，而MyISAM索引记录的是 <strong>地址</strong> 。换句话说， InnoDB的所有非聚簇索引都引用主键作为data域</li>
<li>④ MyISAM的回表操作是十分 <strong>快速</strong> 的，因为是拿着地址偏移量直接到文件中取数据的，反观InnoDB是通 过获取主键之后再去聚簇索引里找记录，虽然说也不慢，但还是比不上直接用地址去访问</li>
<li>⑤ InnoDB要求表 <strong>必须有主键 （ MyISAM可以没有</strong> ）。如果没有显式指定，则MySQL系统会自动选择一个 可以非空且唯一标识数据记录的列作为主键。如果不存在这种列，则MySQL自动为InnoDB表生成一个隐 含字段作为主键，这个字段长度为6个字节，类型为长整型</li>
</ul>
</li>
<li><p><strong>小结</strong>：</p>
<p><img src="image-20221126160053220.png" alt="MySQL之性能优化/image-20221126160053220"></p>
<p><img src="image-20221126160109505.png" alt="MySQL之性能优化/image-20221126160109505"></p>
</li>
</ul>
<h3 id="7-1-5-索引的代价"><a href="#7-1-5-索引的代价" class="headerlink" title="7.1.5 索引的代价"></a>7.1.5 索引的代价</h3><ul>
<li>索引是个好东西，可不能乱建，它在空间和时间上都会有消耗： <ul>
<li><strong>空间上的代价</strong> <ul>
<li>每建立一个索引都要为它建立一棵B+树，每一棵B+树的每一个节点都是一个数据页，一个页默认会 占用 <strong>16KB</strong> 的存储空间，一棵很大的B+树由许多数据页组成，那就是很大的一片存储空间。</li>
</ul>
</li>
<li><strong>时间上的代价</strong> <ul>
<li>每次对表中的数据进行 <strong>增、删、改</strong> 操作时，都需要去修改各个B+树索引。而且我们讲过，B+树每层节点都是按照索引列的值 <strong>从小到大的顺序排序</strong> 而组成了 <strong>双向链表</strong> 。不论是叶子节点中的记录，还 是内节点中的记录（也就是不论是用户记录还是目录项记录）都是按照索引列的值从小到大的顺序 而形成了一个<strong>单向链表</strong>。而增、删、改操作可能会对节点和记录的排序造成破坏，所以存储引擎需 要额外的时间进行一些 <strong>记录移位 ， 页面分裂 、 页面回收</strong> 等操作来维护好节点和记录的排序。如果 我们建了许多索引，每个索引对应的B+树都要进行相关的维护操作，会给性能拖后腿</li>
</ul>
</li>
</ul>
</li>
<li>一个表上索引建的越多，就会占用越多的存储空间，在增删改记录的时候性能就差。为了能建立又好又少的索引，需要学习这些索引在哪些条件下起作用</li>
</ul>
<h3 id="7-1-6-MySQL数据结构选择的合理性"><a href="#7-1-6-MySQL数据结构选择的合理性" class="headerlink" title="7.1.6 MySQL数据结构选择的合理性"></a>7.1.6 MySQL数据结构选择的合理性</h3><ul>
<li>从MySQL的角度讲，不得不考虑一个现实问题就是磁盘IO。如果我们能让索引的数据结构尽量减少磁盘的IO操作，所消耗的时间也就越小。可以说，<strong>磁盘的I&#x2F;O操作次数</strong>对索引的使用效率至关重要</li>
<li>查找都是索引操作，一般来说索引非常大，尤其是关系型数据库，当数据量比较大的时候，索引的大小有可能几个G甚至更多，为了减少索引在内存的占用，<strong>数据库索引是存储在外部磁盘上的</strong>。当我们利用索引查询的时候，不可能把整个索引全部加载到内存，只能<strong>逐一加载</strong>，那么MySQL衡量查询效率的标准就是磁盘IO次数</li>
</ul>
<h4 id="7-1-6-1-全表遍历"><a href="#7-1-6-1-全表遍历" class="headerlink" title="7.1.6.1 全表遍历"></a>7.1.6.1 全表遍历</h4><h4 id="7-1-6-2-Hash结构"><a href="#7-1-6-2-Hash结构" class="headerlink" title="7.1.6.2 Hash结构"></a>7.1.6.2 Hash结构</h4><ul>
<li><p>Hash本身是一个函数，又被称为散列函数，它可以大幅提升检索数据的效率</p>
</li>
<li><p>Hash算法是通过某种确定性的算法（比如MD5、SHA1、SHA2、SHA3）将输入转变为输出。<strong>相同的输入永远可以得到相同的输出</strong>，假设输入内容有微小偏差，在输出中通常会有不同的结果</p>
</li>
<li><p>举例:如果想要验证两个文件是否相同，那么不需要把两份文件直接拿来比对，只需要让对方把Hash函数计算得到的结果告诉你即可，然后在本地同样对文件进行Hash函数的运算，最后通过比较这两个Hash 函数的结果是否相同，就可以知道这两个文件是否相同</p>
</li>
<li><p><strong>加速查找速度的数据结构。常见的有两类：</strong></p>
<ul>
<li><p>⑴树，例如平衡二叉搜索树，查询&#x2F;插入&#x2F;修改&#x2F;删除的平均时间复杂度都是<strong>O(log2N)</strong></p>
</li>
<li><p>⑵哈希，例如HashMap，查询&#x2F;插入&#x2F;修改&#x2F;删除的平均时间复杂度都是<strong>O(1)</strong></p>
<p><img src="image-20221128095132392.png" alt="MySQL之性能优化/image-20221128095132392"></p>
</li>
</ul>
</li>
<li><p>采用Hash进行检索效率非常高，基本上一次检索就可以找到数据，而B+树需要自顶向下依次查找，多次访问节点才能找到数据，中间需要多次IO操作，<strong>从效率来说Hash比 B+树更快</strong></p>
</li>
<li><p>在哈希的方式下，一个元素k处于h(k)中，即利用哈希函数h，根据关键字k计算出槽的位置。函数h将关键字域映射到哈希表T[o…m-1]的槽位上</p>
<p><img src="image-20221128095309295.png" alt="MySQL之性能优化/image-20221128095309295"></p>
</li>
<li><p>上图中哈希函数h有可能将两个不同的关键字映射到相同的位置，这叫做<strong>碰撞</strong>，在数据库中一般采用<strong>链接法</strong>来解决。在链接法中，将散列到同一槽位的元素放在一个链表中，如下图所示：</p>
<p><img src="image-20221128095358536.png" alt="MySQL之性能优化/image-20221128095358536"></p>
</li>
<li><p>实验：体会数组全表遍历和hash表的查找方面的效率区别：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 算法复杂度为 O(n)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">100000</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">        arr[i] = i + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= <span class="number">100000</span>; j++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> j;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (temp == arr[i]) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;time： &quot;</span> + (end - start)); <span class="comment">//time： 823</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//算法复杂度为 O(1)</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">    HashSet&lt;Integer&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(<span class="number">100000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">        set.add(i + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= <span class="number">100000</span>; j++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> j;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> set.contains(temp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">&quot;time： &quot;</span> + (end - start)); <span class="comment">//time： 5</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hash结构效率高，那为什么索引结构要设计成树型呢？</p>
<ul>
<li>原因1: Hash索引仅能满足(&#x3D;)、(&lt;&gt;)和IN查询。如果进行<strong>范围查询</strong>，哈希型的索引，时间复杂度会退化为O(n);而树型的“有序”特性，依然能够保持O(log2N)的高效率</li>
<li>原因2: Hash索引还有一个缺陷，数据的存储是<strong>没有顺序的</strong>，在ORDER BY的情况下，使用Hash索引还需要对数据重新排序</li>
<li>原因3∶对于联合索引的情况，Hash值是将联合索引键合并后一起来计算的，无法对单独的一个键或者几个索引键进行查询</li>
<li>原因4:对于等值查询来说，通常Hash索引的效率更高，不过也存在一种情况，就是<strong>索引列的重复值如果很多，效率就会降低</strong>。这是因为遇到 Hash冲突时，需要遍历桶中的行指针来进行比较，找到查询的关键字，非常耗时。所以,Hash索引通常不会用到重复值多的列上，比如列为性别、年龄的情况等</li>
</ul>
</li>
<li><p>Hash索引适用存储引擎如表所示：</p>
<table>
<thead>
<tr>
<th>索引 &#x2F; 存储引擎</th>
<th>MyISAM</th>
<th>InnoDB</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>HASH索引</td>
<td>不支持</td>
<td>不支持</td>
<td><code>支持</code></td>
</tr>
</tbody></table>
</li>
<li><p>Hash索引的适用性：</p>
<ul>
<li>Hash索引存在着很多限制，相比之下在数据库中B+树索引的使用面会更广，不过也有一些场景采用Hash索引效率更高，比如在键值型（Key-Value）数据库中，<strong>Redis 存储的核心就是Hash表</strong></li>
<li>MysQL中的 Memory存储引擎支持Hash存储，如果需要用到查询的临时表时，就可以选择Memory存储引擎，把某个字段设置为Hash索引，比如字符串类型的字段，进行Hash 计算之后长度可以缩短到几个字节。当字段的重复度低，而且经常需要进行<strong>等值查询</strong>的时候，采用Hash索引是个不错的选择</li>
<li>另外，InnoDB本身不支持 Hash索引，但是提供<strong>自适应Hash 索引</strong>(Adaptive Hash Index)。什么情况下才会使用自适应Hash 索引呢?如果某个数据经常被访问，当满足一定条件的时候（比如某个内容的查询数目超过某个值），就会将这个数据页的地址存放到Hash表中。这样下次查询的时候，就可以直接找到这个页面的所在位置。这样让B+树也具备了Hash索引的优点</li>
</ul>
<p><img src="image-20221128100238559.png" alt="MySQL之性能优化/image-20221128100238559"></p>
</li>
<li><p>采用自适应 Hash 索引目的是方便根据 SQL 的查询条件加速定位到叶子节点，特别是当 B+ 树比较深的时候，通过自适应 Hash 索引可以明显提高数据的检索效率</p>
</li>
<li><p>可以通过 <code>innodb_adaptive_hash_index</code> 变量来查看是否开启了自适应 Hash，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%adaptive_hash_index&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+----------------------------+-------+</span></span><br><span class="line"><span class="comment">| Variable_name              | Value |</span></span><br><span class="line"><span class="comment">+----------------------------+-------+</span></span><br><span class="line"><span class="comment">| innodb_adaptive_hash_index | ON    |</span></span><br><span class="line"><span class="comment">+----------------------------+-------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-1-6-3-二叉搜索树"><a href="#7-1-6-3-二叉搜索树" class="headerlink" title="7.1.6.3 二叉搜索树"></a>7.1.6.3 二叉搜索树</h4><ul>
<li>如果利用二叉树作为索引结构，那么磁盘的IO次数和索引树的高度是相关的</li>
</ul>
<blockquote>
<p>1.二叉搜索树的特点</p>
</blockquote>
<ul>
<li>一个节点只能有两个子节点，也就是<strong>一个节点度不能超过2</strong></li>
<li>左子节点&lt;本节点;右子节点&gt;&#x3D;本节点，比我大的向右，比我小的向左</li>
</ul>
<blockquote>
<p>2.查找规则</p>
</blockquote>
<ul>
<li><p>先来看下最基础的二叉搜索树(Binary Search Tree)，搜索某个节点和插入节点的规则一样，假设搜索插入的数值为key :</p>
<ul>
<li>如果key大于根节点，则在右子树中进行查找</li>
<li>如果 key小于根节点,则在左子树中进行查找</li>
<li>如果key等于根节点，也就是找到了这个节点，返回根节点即可。</li>
</ul>
</li>
<li><p>举个例子，对数列(34，22，89，5，23，77，91)创造出来的二分查找树如下图所示：</p>
<p> <img src="image-20221128100927058.png" alt="MySQL之性能优化/image-20221128100927058"></p>
<ul>
<li><p>但是存在特殊的情况，就是有时候二叉树的深度非常大。比如给出的数据顺序是(5,22,23,34,77,89,91)，创造出来的二分搜索树如下图所示：</p>
<p><img src="image-20221128101014882.png" alt="MySQL之性能优化/image-20221128101014882"></p>
</li>
</ul>
</li>
<li><p>上面第二棵树也属于二分查找树，但是性能上已经退化成了一条链表，查找数据的时间复杂度变成了**O(n)**。可以看出来第一个树的深度是3，也就是说最多只需3次比较，就可以找到节点，而第二个树的深度是7，最多需要7次比较才能找到节点</p>
</li>
<li><p>为了提高查询效率，就需要<strong>减少磁盘IO数</strong>。为了减少磁盘IO的次数，就需要尽量<strong>降低树的高度</strong>，需要把原来”瘦高”“的树结构变的“矮胖”，树的每层的分叉越多越好</p>
</li>
</ul>
<h4 id="7-1-6-4-AVL树"><a href="#7-1-6-4-AVL树" class="headerlink" title="7.1.6.4 AVL树"></a>7.1.6.4 AVL树</h4><ul>
<li><p>为了解决上面二叉查找树退化成链表的问题，人们提出了**平衡二叉搜索树(Balanced Binary Tree)<strong>，又称为</strong>AVL树(有别于AVL算法)**，它在二叉搜索树的基础上增加了约束，具有以下性质:</p>
<ul>
<li><strong>它是一棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树</strong></li>
</ul>
</li>
<li><p>这里说一下，常见的平衡二叉树有很多种，包括了<strong>平衡二叉搜索树、红黑树、数堆、伸展树</strong>。平衡二叉搜索树是最早提出来的自平衡二叉搜索树，当提到平衡二叉树时一般指的就是平衡二叉搜索树。事实上，第一棵树就属于平衡二叉搜索树，搜索时间复杂度就是<strong>O(log2n)</strong></p>
</li>
<li><p>数据查询的时间主要依赖于磁盘I&#x2F;O的次数，如果我们采用二叉树的形式，即使通过平衡二叉搜索树进行了改进，树的深度也是O(log2n)，当n比较大时，深度也是比较高的，比如下图的情况：</p>
<p><img src="image-20221128101511285.png" alt="MySQL之性能优化/image-20221128101511285"></p>
</li>
<li><p><strong>每访问一次节点就需要进行一次磁盘I&#x2F;O操作</strong>，对于上面的树来说，需要进行5次I&#x2F;O操作。虽然平衡二叉树的效率高，但是树的深度也同样高，这就意味着磁盘I&#x2F;O操作次数多，会影响整体数据查询的效率</p>
</li>
<li><p>针对同样的数据，如果把二叉树改成<strong>M叉树</strong>(M&gt;2）呢?当M&#x3D;3时，同样的31个节点可以由下面的三叉树来进行存储：</p>
<p><img src="image-20221128101644383.png" alt="MySQL之性能优化/image-20221128101644383"></p>
</li>
<li><p>可以看到此时树的高度降低了，当数据量N大的时候，以及树的分叉数M大的时候，M叉树的高度会远小于二叉树的高度(M&gt;2)。所以，我们需要把<strong>树从”瘦高”变”矮胖”</strong></p>
</li>
</ul>
<h4 id="7-1-6-5-B-Tree"><a href="#7-1-6-5-B-Tree" class="headerlink" title="7.1.6.5 B-Tree"></a>7.1.6.5 B-Tree</h4><ul>
<li><p>B树的英文是Balance Tree，也就是<strong>多路平衡查找树</strong>。简写为B-Tree (注意横杠表示这两个单词连起来的意思，不是减号)。它的高度远小于平衡二叉树的高度</p>
</li>
<li><p>B树的结构如下图所示：</p>
<p><img src="image-20221128101847061.png" alt="MySQL之性能优化/image-20221128101847061"></p>
</li>
<li><p>B树作为多路平衡查找树，它的每一个节点最多可以包括M个子节点，<strong>M称为B树的阶</strong>。每个磁盘块中包括了关键字和子节点的指针。如果一个磁盘块中包括了x个关键字，那么指针数就是x+1。对于一个100阶的B树来说，如果有3层的话最多可以存储约100万的索引数据。对于大量的索引数据来说，采用B树的结构是非常适合合的，因为树的高度要远小于二叉树的高度</p>
</li>
<li><p>一个M阶的B树(M&gt;2)有以下的特性：</p>
<ul>
<li>根节点的儿子数的范围是[2,M]</li>
<li>每个中间节点包含k-1个关键字和k个孩子，孩子的数量&#x3D;关键字的数量+1，k的取值范围为[ceil(M&#x2F;2),M]</li>
<li>叶子节点包括 k-1个关键字(叶子节点没有孩子)，k的取值范围为[ceil(M&#x2F;2),M]</li>
<li>假设中间节点节点的关键字为:Key[1],Key[2]… Key|k-1]，且关键字按照升序排序，即Key[i]&lt;Key[i+1]。此时k-1个关键字相当于划分了k个范围，也就是对应着k个指针，即为: P[1],P[2]…P[K]，其中 P[1]指向关键字小于Key[1]的子树，P[i]指向关键字属于(Key[i-1], Key[i])的子树，P[K]指向关键字大于Key[k-1]的子树</li>
<li>所有叶子节点位于同一层</li>
</ul>
</li>
<li><p>上面那张图所表示的B树就是一棵3阶的B树。可以看一下磁盘块2，里面的关键字为(8，12)，它有3个孩子(3，5)，(9，10)和(13，15)，能看到(3，5)小于8，(9，10)在8和12之间，而(13，15)大于12，刚好符合刚才给出的特征</p>
</li>
<li><p>然后来看一下如何用B树进行查找。假设想要<strong>查找的关键字是9</strong>，那么步骤可以分为以下几步：</p>
<ul>
<li><p>与根节点的关键字(17，35)进行比较，9小于17那么得到指针P1</p>
</li>
<li><p>按照指针P1找到磁盘块2，关键字为(8，12)，因为9在8和12之间，所以得到指针P2</p>
</li>
<li><p>按照指针P2找到磁盘块6，关键字为(9，10)，然后找到了关键字9</p>
</li>
</ul>
</li>
<li><p>能看出来在B树的搜索过程中，比较的次数并不少，但如果把数据读取出来然后在内存中进行比较，这个时间就是可以忽略不计的。而读取磁盘块本身需要进行I&#x2F;O操作，消耗的时间比在内存中进行比较所需要的时间要多，是数据查找用时的重要因素。<strong>B树相比于平衡二叉树来说磁盘I&#x2F;O操作要少</strong>，在数据查询中比平衡二叉树效率要高。所以<strong>只要树的高度足够低，IO次数足够少。就可以提高查询性能</strong></p>
</li>
<li><p>小结:</p>
<ul>
<li>B树在插入和删除节点的时候如果导致树不平衡，就通过自动调整节点的位置来保持树的自平衡</li>
<li>关键字集合分布在整棵树中,即<strong>叶子节点和非叶子节点都存放数据</strong>。搜索有可能在非叶子节点结束</li>
<li>其搜索性能等价于在关键字全集内做一次二分查找</li>
</ul>
</li>
<li><p>再举例</p>
<p><img src="image-20221128102555811.png" alt="MySQL之性能优化/image-20221128102555811"></p>
</li>
</ul>
<h4 id="7-1-6-6-B-Tree"><a href="#7-1-6-6-B-Tree" class="headerlink" title="7.1.6.6 B+Tree"></a>7.1.6.6 B+Tree</h4><ul>
<li><p>B+树也是一种多路搜索树，<strong>基于B树做出了改进</strong>，主流的DBMS都支持B+树的索引方式，比如 MySQL。相比于B-Tree,<strong>B+Tree适合文件索引系统</strong></p>
</li>
<li><p>Mysql官网说明：</p>
<p><img src="image-20221128102834945.png" alt="MySQL之性能优化/image-20221128102834945"></p>
</li>
<li><p><strong>B+ 树和 B 树的差异在于以下几点：</strong></p>
<ul>
<li>1.有 k 个孩子的节点就有 k 个关键字。也就是孩子数量 &#x3D; 关键字数，而 B 树中，孩子数量 &#x3D; 关键字数+1</li>
<li>2.非叶子节点的关键字也会同时存在在子节点中，并且是在子节点中所有关键字的最大（或最<br>小）</li>
<li>3.非叶子节点仅用于索引，不保存数据记录，跟记录有关的信息都放在叶子节点中。而 B 树中， <strong>非叶子节点既保存索引，也保存数据记录</strong> </li>
<li>4.所有关键字都在叶子节点出现，叶子节点构成一个有序链表，而且叶子节点本身按照关键字的大小从小到大顺序链接</li>
</ul>
</li>
<li><p>看起来B+树和B树的查询过程差不多，但是B+树和B树有个根本的差异在于，<strong>B+树的中间节点并不直接存储数据</strong>。这样的好处都有什么呢?</p>
<ul>
<li>首先，<strong>B+树查询效率更稳定</strong>。因为B+树每次只有访问到叶子节点才能找到对应的数据，而在B树中，非叶子节点也会存储数据，这样就会造成查询效率不稳定的情况，有时候访问到了非叶子节点就可以找到关键字，而有时点需要访问到叶子节点才能找到关键字</li>
<li>其次，<strong>B+树的查询效率更高</strong>。这是因为B树非叶子节点也要存储数据，B+树非叶子节点不用存储数据。对于相同大小的页，B+树存储的目录项更多，故通常情况下B+树比B树更矮胖(阶数更大，深度更低)，查询所需要的磁盘I&#x2F;O也会更少。同样的磁盘页大小，B+树可以存储更多的节点关键字。</li>
<li>不仅是对单个关键字的查询上，<strong>在查询范围上，B+树的效率也比B树高</strong>。这是因为所有关键字都出现在B+树的叶子节点中，叶子节点之间会有指针，数据又是递增的，这使得范围查找可以通过指针连接查找。而在B树中则需要通过中序遍历才能完成查询范围的查找。效率要低很多</li>
</ul>
</li>
<li><p>思考题一：为了减少IO，索引树会一次性加载吗？</p>
<ul>
<li>1、数据库索引是存储在磁盘上的，如果数据量很大，必然导致索引的大小也会很大，超过几个G</li>
<li>2、当利用索引查询的时候，是不可能将全部几个G的索引都加载进内存的，我们能做的只能是：逐一加载每一个磁盘页，因为磁盘页对应着索引树的节点</li>
</ul>
</li>
<li><p>思考题二：B+树的存储能力如何？为何说一般查找行记录，最多只需1~3次磁盘IO</p>
<ul>
<li><p>InnoDB存储引擎中页的大小为16KB，一般表的主键类型为INT(占用4个字节）或BIGINT(占用8个字节)，指针类型也一般为4或8个字节，也就是说一个页(B+Tree中的一个节点)中大概存储16KB&#x2F;(8B+8B)&#x3D;1K个键值(因为是估值，为方便计算，这里的K取值为 103 。也就是说一个深度为3的B+Tree索引可以维护103 *103 * 103 &#x3D;10亿条记录。(这里假定一个数据页也存储103 条行记录数据了)</p>
</li>
<li><p>实际情况中每个节点可能不能填充满，因此在数据库中，B+Tree的高度一般都在2-4层。MySQL的InnoDB存储引擎在设计时是将根节点常驻内存的，也就是说查找某一键值的行记录时最多只需要1~3次磁盘1&#x2F;O操作</p>
</li>
</ul>
</li>
<li><p>思考题三：为什么说B+树比B-树更适合实际应用中操作系统的文件索引和数据库索引？</p>
<ul>
<li><p>1、B+树的磁盘读写代价更低</p>
<ul>
<li>B+树的内部结点并没有指向关键字具体信息的指针。因此其内部结点相对B树更小。如果把所有同一内部结点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多。一次性读入内存中的需要查找的关键字也就越多。相对来说IO读写次数也就降低了</li>
</ul>
</li>
<li><p>2、B+树的查询效率更加稳定</p>
<ul>
<li>由于非终结点并不是最终指向文件内容的结点，而只是叶子结点中关键字的索引。所以任何关键字的查找必须走一条从根结点到叶子结点的路。所有关键字查询的路径长度相同，导致每一个数据的查询效率相当</li>
</ul>
</li>
</ul>
</li>
<li><p>思考题四：Hash 索引与 B+ 树索引的区别</p>
<ul>
<li>之前讲到过B+树索引的结构，Hash索引结构和B+树的不同，因此在索引使用上也会有差别</li>
<li>1、Hash索引不能进行范围查询，而B+树可以。这是因为Hash索引指向的数据是无序的，而B+树的叶子节点是个有序的链表</li>
<li>2、Hash索引不支持联合索引的最左侧原则（即联合索引的部分索引无法使用)，而B+树可以。对于联合索引来说，Hash索引在计算 Hash值的时候是将索引键合并后再一起计算 Hash值，所以不会针对每个索引单独计算Hash值。因此如果用到联合索引的一个或者几个索引时，联合索引无法被利用</li>
<li>3、Hash索引不支持ORDER BY排序，因为Hash索引指向的数据是无序的，因此无法起到排序优化的作用，而B+树索引数据是有序的，可以起到对该字段ORDER BY排序优化的作用。同理，我们也无法用 Hash索引进行模糊查询，而B+树使用LIKE进行模糊查询的时候，LIKE后面后模糊查询(比如%结尾)的话就可以起到优化作用</li>
<li>4、InnoDB不支持哈希索引</li>
</ul>
</li>
<li><p>思考题五：Hash 索引与 B+ 树索引是在建索引的时候手动指定的吗？</p>
<ul>
<li>针对InnoDB和MyISAM存储引擎，都会默认采用B+树索引，无法使用Hash 索引。InnoDB提供的自适应Hash是不需要手动指定的。如果是Memory&#x2F;Heap和NDB存储引擎，是可以进行选择Hash 索引的</li>
</ul>
</li>
</ul>
<h4 id="7-1-6-7-R树"><a href="#7-1-6-7-R树" class="headerlink" title="7.1.6.7 R树"></a>7.1.6.7 R树</h4><ul>
<li>R-Tree在MySQL很少使用，仅支持<strong>geometry数据类型</strong> ，支持该类型的存储引擎只有myisam、bdb、innodb、ndb、archive几种。举个R树在现实领域中能够解决的例子：查找20英里以内所有的餐厅。如果没有R树你会怎么解决？一般情况下我们会把餐厅的坐标(x,y)分为两个字段存放在数据库中，一个字段记录经度，另一个字段记录纬度。这样的话我们就需要遍历所有的餐厅获取其位置信息，然后计算是否满足要求。如果一个地区有100家餐厅的话，我们就要进行100次位置计算操作了，如果应用到谷歌、百度地图这种超大数据库中，这种方法便必定不可行了。R树就很好的<strong>解决了这种高维空间搜索问题</strong>。它把B树的思想很好的扩展到了多维空间，采用了B树分割空间的思想，并在添加、删除操作时采用合并、分解结点的方法，保证树的平衡性。因此，R树就是一棵用来 <strong>存储高维数据的平衡树</strong> 。相对于B-Tree，R-Tree的优势在于范围查找</li>
</ul>
<table>
<thead>
<tr>
<th>索引 &#x2F; 存储引擎</th>
<th>MyISAM</th>
<th>InnoDB</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>R-Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<h4 id="7-1-6-8-小结"><a href="#7-1-6-8-小结" class="headerlink" title="7.1.6.8 小结"></a>7.1.6.8 小结</h4><ul>
<li><p>使用索引可以帮助我们从海量的数据中快速定位想要查找的数据，不过索引也存在一些不足，比如占用存储空间、降低数据库写操作的性能等，如果有多个索引还会增加索引选择的时间。当我们使用索引时，需要平衡索引的利(提升查询效率）和弊(维护索引所需的代价)</p>
</li>
<li><p>在实际工作中，还需要基于需求和数据本身的分布情况来确定是否使用索引，尽管<strong>索引不是万能的</strong>，但<strong>数据量大的时候不使用素引是不可想象的</strong>，毕竟索引的本质。是帮助我们提升数据检索的效率</p>
</li>
</ul>
<h4 id="7-1-6-9-算法的时间复杂度"><a href="#7-1-6-9-算法的时间复杂度" class="headerlink" title="7.1.6.9 算法的时间复杂度"></a>7.1.6.9 算法的时间复杂度</h4><table>
<thead>
<tr>
<th>数据结构</th>
<th>查找</th>
<th>插入</th>
<th>删除</th>
<th>遍历</th>
</tr>
</thead>
<tbody><tr>
<td>数组</td>
<td>o(N)</td>
<td>o1)</td>
<td>o(N)</td>
<td>–</td>
</tr>
<tr>
<td>有序数组</td>
<td>O(logN)</td>
<td>O(N)</td>
<td>O(N)</td>
<td>O(N)</td>
</tr>
<tr>
<td>链表</td>
<td>o(N)}</td>
<td>o1)</td>
<td>O(N)</td>
<td>–</td>
</tr>
<tr>
<td>有序链表</td>
<td>O(N)</td>
<td>O(N)</td>
<td>o(N)</td>
<td>O(N)</td>
</tr>
<tr>
<td>二叉树（一般情况〉</td>
<td>O(logN)</td>
<td>o(logN)</td>
<td>O(logN)</td>
<td>O(N)</td>
</tr>
<tr>
<td>二叉树（最坏情况)</td>
<td>o(N)</td>
<td>O(N)</td>
<td>o(N)</td>
<td>O(N)</td>
</tr>
<tr>
<td>平衡树（一般情况和最坏情况)</td>
<td>o(logN)</td>
<td>O(logN)</td>
<td>O(logN)</td>
<td>O(N)</td>
</tr>
<tr>
<td>哈希表</td>
<td>o(1)</td>
<td>o(1)</td>
<td>o(1)</td>
<td>–</td>
</tr>
</tbody></table>
<h2 id="7-2-InnoDB数据存储结构"><a href="#7-2-InnoDB数据存储结构" class="headerlink" title="7.2 InnoDB数据存储结构"></a>7.2 InnoDB数据存储结构</h2><ul>
<li>索引结构提供了更高效的索引方式，不过索引信息以及数据记录都是保存在文件上的，确切的说是存储在页结构中</li>
<li>另一方面，索引是在存储引擎中实现的，MySQL服务器上的<strong>存储引擎</strong>负责对表中数据的读取和写入工作</li>
<li>不同存储引擎中的<strong>存储的格式</strong>一般是不同的，甚至有的存储引擎比如Memory都不用磁盘来存储数据</li>
<li>由于<strong>InnoDB</strong>是MySQL的<strong>默认存储引擎</strong>，所以主要需要知道InnoDB存储引擎的数据存储结构</li>
</ul>
<h3 id="7-2-1-数据库的存储结构：页"><a href="#7-2-1-数据库的存储结构：页" class="headerlink" title="7.2.1 数据库的存储结构：页"></a>7.2.1 数据库的存储结构：页</h3><h4 id="7-2-1-1-磁盘与内存交互的基本单位：页"><a href="#7-2-1-1-磁盘与内存交互的基本单位：页" class="headerlink" title="7.2.1.1 磁盘与内存交互的基本单位：页"></a>7.2.1.1 磁盘与内存交互的基本单位：页</h4><ul>
<li>InnoDB将数据划分为若干个页，默认页的大小为<strong>16KB</strong></li>
<li>以<strong>页</strong>作为磁盘和内存交互的<strong>基本单位</strong>，也就是一次最少从磁盘中读取16KB的内容到内存中，一次最少把内存中的16KB内容刷新到磁盘中</li>
<li>也就是说，<strong>在数据库中不论读一行，还是读多行，都是将这些行所在的页进行加载。也就是说，数据库管理存储空间的基本单位是页，数据库IO操作的最小单位是页</strong>。一个页中可以存储多个行记录</li>
</ul>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">记录是按照行来存储的，但是数据库的读取并不是以行为单位的，否则一次读取（也就是一次I/O操作）只处理一行数据，效率会非常低</span><br></pre></td></tr></table></figure>

<p><img src="image-20221128141510370.png" alt="MySQL之性能优化/image-20221128141510370"></p>
<h4 id="7-2-1-2-页的概述"><a href="#7-2-1-2-页的概述" class="headerlink" title="7.2.1.2 页的概述"></a>7.2.1.2 页的概述</h4><ul>
<li>页a、页b、页c …页n这些页可以<strong>不在物理结构上相连</strong>，只要通过<strong>双向链表</strong>相关联即可。每个数据页中的记录会按照主键值从小到大的顺序组成一个<strong>单向链表</strong>，每个数据页都会为存储在它里边的记录生成一个<strong>页目录</strong>，在通过主键查找某条记录的时候可以在页目录中<strong>使用二分法</strong>快速定位到对应的槽，然后再遍历该槽对应分组中的记录即可快速找到指定的记录</li>
</ul>
<h4 id="7-2-1-3-页的大小"><a href="#7-2-1-3-页的大小" class="headerlink" title="7.2.1.3 页的大小"></a>7.2.1.3 页的大小</h4><ul>
<li><p>不同的数据库管理系统（简称DBMS）的页大小不同。比如在MySQL的InnoDB存储引擎中，默认页的大小是16KB，可以通过下面的命令来进行查看：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_page_size%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_page_size <span class="operator">|</span> <span class="number">16384</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>SQL Server中页的大小为 <strong>8KB</strong>，而在oracle中用术语’‘<strong>块</strong>’’(Block)来代表”页”，Oralce支持的块大小为2KB，4KB，8KB，16K8，32KB和64KB</p>
</li>
</ul>
<h4 id="7-2-1-4-页的上层结构"><a href="#7-2-1-4-页的上层结构" class="headerlink" title="7.2.1.4 页的上层结构"></a>7.2.1.4 页的上层结构</h4><ul>
<li><p>另外在数据库中，还存在区（Extent)、段(Segment)和表空间（Tablespace)的概念。行、页、区、段、表空间的关系如下图所示：</p>
<p><img src="image-20221128142327953.png" alt="MySQL之性能优化/image-20221128142327953"></p>
</li>
<li><p>区(Extent)是比页大一级的存储结构，在InnoDB存储引擎中，一个区会分配<strong>64个连续的页</strong>。因为InnoDB中的页大小默认是16KB，所以一个区的大小是64*16KB&#x3D; <strong>1MB</strong></p>
</li>
<li><p>段(Segment)由一个或多个区组成，区在文件系统是一个连续分配的空间（在InnoDB中是连续的64个页)，不过在段中不要求区与区之间是相邻的。<strong>段是数据库中的分配单位，不同类型的数据库对象以不同的段形式存在</strong>。当创建数据表、索引的时候，就会相应创建对应的段，比如创建一张表时会创建一个表段，创建一个索引时会创建一个索引段</p>
</li>
<li><p>表空间（Tablespace)是一个逻辑容器，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间。数据库由一个或多个表空间组成，表空间从管理上可以划分为<strong>系统表空间，用户表空间、撤销表空间、临时表空间</strong>等</p>
</li>
</ul>
<h3 id="7-2-2-页的内部结构"><a href="#7-2-2-页的内部结构" class="headerlink" title="7.2.2 页的内部结构"></a>7.2.2 页的内部结构</h3><ul>
<li><p>页如果按类型划分的话，常见的有<strong>数据页（保存B+树节点）、系统页、Undo页</strong>和<strong>事务数据页</strong>等。数据页是我们最常使用的页</p>
</li>
<li><p>数据页的<strong>16KB</strong>大小的存储空间被划分为七个部分，分别是文件头(File Header)、页头(Page Header)、最大最小记录(Infimum+supremum)、用户记录(User Records)、空闲空间(Free Space)、页目录(Page Directory)和文件尾(File Tailer) </p>
</li>
<li><p>页结构的示意图如下所示：</p>
<p><img src="image-20221128143210208.png" alt="MySQL之性能优化/image-20221128143210208"></p>
</li>
<li><p>这7个部分作用分别如下，简单梳理如下表所示:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>占用大小</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>File Header</td>
<td>38字节</td>
<td>文件头，描述页的信息</td>
</tr>
<tr>
<td>Page Header</td>
<td>56字节</td>
<td>页头,页的状态信息</td>
</tr>
<tr>
<td>lnfimum-Supremum</td>
<td>26字节</td>
<td>最大和最小记录，这是两个虚拟的行记录</td>
</tr>
<tr>
<td>User Records</td>
<td>不确定</td>
<td>用户记录，存储行记录内容</td>
</tr>
<tr>
<td>Free Space</td>
<td>不确定</td>
<td>空闲记录，页中还没有被使用的空间</td>
</tr>
<tr>
<td>Page Directory</td>
<td>不确定</td>
<td>页目录，存储用户记录的相对位置</td>
</tr>
<tr>
<td>File Trailer</td>
<td>8字节</td>
<td>文件尾，校验页是否完整</td>
</tr>
</tbody></table>
</li>
</ul>
<p><img src="image-20221129161453822.png" alt="MySQL之性能优化/image-20221129161453822"></p>
<h4 id="7-2-2-1-第一部分：File-Header（文件头部）和File-Trailer（文件结尾）"><a href="#7-2-2-1-第一部分：File-Header（文件头部）和File-Trailer（文件结尾）" class="headerlink" title="7.2.2.1 第一部分：File Header（文件头部）和File Trailer（文件结尾）"></a>7.2.2.1 第一部分：File Header（文件头部）和File Trailer（文件结尾）</h4><p>首先是<strong>文件通用部分</strong>，也就是<strong>文件头</strong>和<strong>文件尾</strong></p>
<blockquote>
<p>文件头信息</p>
</blockquote>
<blockquote>
<p>文件尾信息</p>
</blockquote>
<h4 id="7-2-2-2-第二部分：User-Records（用户记录）、最大最小记录、Free-Space（空闲空间）"><a href="#7-2-2-2-第二部分：User-Records（用户记录）、最大最小记录、Free-Space（空闲空间）" class="headerlink" title="7.2.2.2 第二部分：User Records（用户记录）、最大最小记录、Free Space（空闲空间）"></a>7.2.2.2 第二部分：User Records（用户记录）、最大最小记录、Free Space（空闲空间）</h4><h4 id="7-2-2-3-第三部分：Page-Directory（页目录）、Page-Header（页面头部）"><a href="#7-2-2-3-第三部分：Page-Directory（页目录）、Page-Header（页面头部）" class="headerlink" title="7.2.2.3 第三部分：Page Directory（页目录）、Page Header（页面头部）"></a>7.2.2.3 第三部分：Page Directory（页目录）、Page Header（页面头部）</h4><h4 id="7-2-2-4-从数据页的角度看B-树如何查询"><a href="#7-2-2-4-从数据页的角度看B-树如何查询" class="headerlink" title="7.2.2.4 从数据页的角度看B+树如何查询"></a>7.2.2.4 从数据页的角度看B+树如何查询</h4><ul>
<li><p>一颗B+树按照节点类型可分成两部分：</p>
<ul>
<li><p>1.叶子节点：B+树最底层的节点，节点的高度为0，存储行记录</p>
</li>
<li><p>2.非叶子节点：节点的高度大于0，存储引擎键和页面指针，并不存储行记录本身</p>
<p><img src="image-20221129205043413.png" alt="MySQL之性能优化/image-20221129205043413"></p>
</li>
</ul>
</li>
<li><p>从页结构的角度来理解B+树的时候，可以帮助理解一些通过索引检索的原理：</p>
<ul>
<li><strong>1.B+树是如何进行记录检索的：</strong><ul>
<li>如果通过B+树的索引查询记录，首先是从B+树的根开始，逐层检索，直到找到叶子节点，也就是找到对应的数据页为止，将数据页加载到内存中，页目录中的槽（slot）采用<strong>二分查找</strong>的方法先找到一个粗略的记录小组，然后再在分组中通过<strong>链表遍历</strong>的方式查找记录</li>
</ul>
</li>
<li><strong>2.普通索引和唯一索引在查询效率上有什么不同：</strong><ul>
<li>在创建索引的时候可以是普通索引，也可以是唯一索引，那么这两个索引在查询效率上有什么不同</li>
<li>唯一索引就是在普通索引上增加了约束性，也就是关键字唯一，找到了关键字就停止检索</li>
<li>而普通索引，可能会存在用户记录中的关键字相同的情况，根据页结构的原理，当我们读取一条记录的时候，不是单独将这条记录从磁盘中读出去，而是将这个记录所在的页加载到内存中进行读取</li>
<li>InnoDB存储引擎的页大小为16KB，在一个页中可能存储着上千个记录，因此在普通索引的字段上进行查询也就是在内存中多几次“判断下一条记录”的操作，对于CPU来说，这些操作所消耗的时间可以忽略不计</li>
<li>所以对一个索引字段进行检索，采用普通索引和唯一索引在检索效率上基本上没有差别</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="7-2-3-InnoDB行格式（或记录格式）"><a href="#7-2-3-InnoDB行格式（或记录格式）" class="headerlink" title="7.2.3 InnoDB行格式（或记录格式）"></a>7.2.3 InnoDB行格式（或记录格式）</h3><ul>
<li><p>平时的数据以行为单位来向表中插入数据，这些记录在磁盘上的存放方式也被称为<strong>行格式</strong>或者<strong>记录格式</strong></p>
</li>
<li><p>InnoDB存储引擎设计了4种不同类型的<strong>行格式</strong>，分别是<strong>Compact</strong>、<strong>Redundant</strong>、<strong>Dynamic</strong>和<strong>Compressed</strong>行格式</p>
</li>
<li><p>查看MySQL5.7的默认行格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@innodb</span>_default_row_format;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@innodb</span>_default_row_format <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">dynamic</span>                     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-2-3-1-指定行格式的语法"><a href="#7-2-3-1-指定行格式的语法" class="headerlink" title="7.2.3.1 指定行格式的语法"></a>7.2.3.1 指定行格式的语法</h4><ul>
<li><p>在创建或修改表的语句中指定行格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名 (列的信息) ROW_FORMAT<span class="operator">=</span>行格式名称</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 ROW_FORMAT<span class="operator">=</span>行格式名称</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> record_test_table( col1 <span class="type">varchar</span>(<span class="number">8</span>), col2 <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span>, col3 <span class="type">char</span>(<span class="number">8</span>), <span class="keyword">primary</span> key(col1) )charset<span class="operator">=</span>utf8 row_format<span class="operator">=</span>compact;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.20</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> record_test_table_1( col1 <span class="type">varchar</span>(<span class="number">8</span>), col2 <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="keyword">null</span>, col3 <span class="type">char</span>(<span class="number">8</span>), <span class="keyword">primary</span> key(col1) )charset<span class="operator">=</span>utf8;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">like</span> <span class="string">&#x27;record_test_table&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           Name: record_test_table</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: <span class="number">10</span></span><br><span class="line">     Row_format: Compact</span><br><span class="line">           <span class="keyword">Rows</span>: <span class="number">0</span></span><br><span class="line"> Avg_row_length: <span class="number">0</span></span><br><span class="line">    Data_length: <span class="number">16384</span></span><br><span class="line">Max_data_length: <span class="number">0</span></span><br><span class="line">   Index_length: <span class="number">0</span></span><br><span class="line">      Data_free: <span class="number">0</span></span><br><span class="line"> Auto_increment: <span class="keyword">NULL</span></span><br><span class="line">    Create_time: <span class="number">2022</span><span class="number">-11</span><span class="number">-29</span> <span class="number">21</span>:<span class="number">25</span>:<span class="number">55</span></span><br><span class="line">    Update_time: <span class="keyword">NULL</span></span><br><span class="line">     Check_time: <span class="keyword">NULL</span></span><br><span class="line">      <span class="keyword">Collation</span>: utf8_general_ci</span><br><span class="line">       Checksum: <span class="keyword">NULL</span></span><br><span class="line"> Create_options: row_format<span class="operator">=</span>COMPACT</span><br><span class="line">        Comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">table</span> status <span class="keyword">like</span> <span class="string">&#x27;record_test_table_1&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           Name: record_test_table_1</span><br><span class="line">         Engine: InnoDB</span><br><span class="line">        Version: <span class="number">10</span></span><br><span class="line">     Row_format: <span class="keyword">Dynamic</span></span><br><span class="line">           <span class="keyword">Rows</span>: <span class="number">0</span></span><br><span class="line"> Avg_row_length: <span class="number">0</span></span><br><span class="line">    Data_length: <span class="number">16384</span></span><br><span class="line">Max_data_length: <span class="number">0</span></span><br><span class="line">   Index_length: <span class="number">0</span></span><br><span class="line">      Data_free: <span class="number">0</span></span><br><span class="line"> Auto_increment: <span class="keyword">NULL</span></span><br><span class="line">    Create_time: <span class="number">2022</span><span class="number">-11</span><span class="number">-29</span> <span class="number">21</span>:<span class="number">26</span>:<span class="number">35</span></span><br><span class="line">    Update_time: <span class="keyword">NULL</span></span><br><span class="line">     Check_time: <span class="keyword">NULL</span></span><br><span class="line">      <span class="keyword">Collation</span>: utf8_general_ci</span><br><span class="line">       Checksum: <span class="keyword">NULL</span></span><br><span class="line"> Create_options: </span><br><span class="line">        Comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>向表中插入两条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> record_test_table(col1, col2, col3) </span><br><span class="line"></span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line"></span><br><span class="line">(<span class="string">&#x27;zhangsan&#x27;</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="string">&#x27;wangwu&#x27;</span>), </span><br><span class="line"></span><br><span class="line">(<span class="string">&#x27;tong&#x27;</span>, <span class="string">&#x27;chen&#x27;</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="7-2-3-2-COMPACT行格式"><a href="#7-2-3-2-COMPACT行格式" class="headerlink" title="7.2.3.2 COMPACT行格式"></a>7.2.3.2 COMPACT行格式</h4><h4 id="7-2-3-3-Dynamic和Compressed行格式"><a href="#7-2-3-3-Dynamic和Compressed行格式" class="headerlink" title="7.2.3.3 Dynamic和Compressed行格式"></a>7.2.3.3 Dynamic和Compressed行格式</h4><h3 id="7-2-4-区、段和碎片区"><a href="#7-2-4-区、段和碎片区" class="headerlink" title="7.2.4 区、段和碎片区"></a>7.2.4 区、段和碎片区</h3><h4 id="7-2-4-1-为什么要有区？"><a href="#7-2-4-1-为什么要有区？" class="headerlink" title="7.2.4.1 为什么要有区？"></a>7.2.4.1 为什么要有区？</h4><ul>
<li><strong>B+<strong>树的每一层中的页都会形成一个双向链表，如果是以</strong>页为单位</strong>来分配存储空间的话，双向链表相邻的两个页之间的<strong>物理位置可能离得非常远</strong>。我们介绍B+树索引的适用场景的时候特别提到范围查询只需要定位到最左边的记录和最右边的记录，然后沿着双向链表一直扫描就可以了，而如果链表中相邻的两个物理位置离得非常远，就是所谓的<strong>随机I&#x2F;O</strong>。再一次强调，磁盘的速度和内存的速度查了好几个数量级，<strong>随机I&#x2F;O是非常慢的</strong>，所以我们应该尽量让链表中相邻的页的物理位置也相邻，这样进行范围查询的时候才可以使用所谓的<strong>顺序I&#x2F;O</strong></li>
<li>引入<strong>区</strong>的概念，一个区就是在物理位置上连续的<strong>64个页</strong>。因为InnoDB中的页大小默认就是16KB，所以一个区的大小是64*16KB&#x3D;<strong>1MB</strong>。在表中<strong>数据量大</strong>的时候，为某个索引分配空间的时候就不再按照页为单位分配了，而是按照<strong>区为单位分配</strong>，甚至在表中的数据特别多的时候，可以一次性分配多个连续的区。虽然可能造成<strong>一点点空间的浪费</strong>（数据不足以填充满整个区），但是从性能角度看，可以消除很多的随机I&#x2F;O，<strong>功大于过</strong></li>
</ul>
<h4 id="7-2-4-2-为什么要有段？"><a href="#7-2-4-2-为什么要有段？" class="headerlink" title="7.2.4.2 为什么要有段？"></a>7.2.4.2 为什么要有段？</h4><ul>
<li>对于范围查询，其实是对B+树叶子节点中的记录进行顺序扫描，而如果不区分叶子节点和非叶子节点，统统把节点代表的页面放到申请的区中的话，进行范围扫描的效果就大打折扣了。所以InnoDB对B+树的<strong>叶子节点</strong>和<strong>非叶子节点</strong>进行了区别对待，也就是说叶子节点和非叶子节点有各自独有的区。存放叶子节点的区的集合就算是一个<strong>段</strong>，存放非叶子节点的区的集合也算是一个段。也就是说一个索引会生成2个段，一个<strong>叶子节点段</strong>，一个<strong>非叶子节点段</strong></li>
<li>除了索引的叶子节点段和非叶子节点段之外，InnoDB中还有为存储一些特殊的数据而定义段，比如回滚段。所以，常见的段有<strong>数据段、索引段、回滚段</strong>。数据段即为B+树叶子节点，索引段即为B+树的非叶子节点</li>
<li>在InnoDB存储引擎中，对段的管理都是由引擎自身完成的，DBA不能也没必要对其进行控制</li>
<li>段其实不对应表空间中某一个连续的物理区域，而是一个逻辑概念，由若干个零散的页面以及一些完整的的区组成</li>
</ul>
<h4 id="7-2-4-3-为什么要有碎片区？"><a href="#7-2-4-3-为什么要有碎片区？" class="headerlink" title="7.2.4.3 为什么要有碎片区？"></a>7.2.4.3 为什么要有碎片区？</h4><ul>
<li>默认情况下，一个使用InnoDB存储引擎的表只有一个聚簇索引，一个索引会生成2个段，而段是以区为单位申请存储空间的</li>
<li>一个区默认占用1M（64*16KB&#x3D;1024kb）存储空间，所以<strong>默认情况下一个只存了几条记录的小表也需要2M的存储空间吗？</strong>以后每次添加一个索引都要多申请2M存储空间吗？这对于存储记录比较少的表简直是天大的浪费。这个问题的症结在于到现在为止我们介绍的区都是非常<strong>纯粹</strong>的，也就是一个区被整个分配给某一个段，或者说区中的所有页面都是为了存储同一个段的数据而存在的，即使段的数据填充不满区中所有页面，那余下的页面也不能挪作他用</li>
<li>为了考虑以完整的区为单位分配给某个段对于<strong>数据量较小</strong>的表太浪费存储空间的这种情况，InnoDB提出了一个<strong>碎片区</strong>的概念</li>
<li>在一个碎片区中，并不是所有的页都是为了存储同一个段的数据而存在的，而是碎片区中的页可以用于不同目的的，比如有些页用于段A，有些页用于段B，有些页甚至哪个段都不属于</li>
<li><strong>碎片区直属于表空间，并不属于任何一个段</strong></li>
<li>所以此后为某个段分配存储空间的策略是这样的：<ul>
<li>在刚开始向表中插入数据的时候，段是从某个碎片区以单个页面为单位来分配存储空间的</li>
<li>当某个段已经占用了<strong>32个碎片区页</strong>面之后，就会申请以完整的区为单位来分配存储空间</li>
</ul>
</li>
<li>所以现在段不能仅定义为是某些区的集合，更精确的应该是<strong>某些零散的页面</strong>以及<strong>一些完整的区</strong>的集合</li>
</ul>
<h4 id="7-2-4-4-区的分类"><a href="#7-2-4-4-区的分类" class="headerlink" title="7.2.4.4 区的分类"></a>7.2.4.4 区的分类</h4><ul>
<li>区大体上可以分为4种类型：<ul>
<li><strong>空闲的区（FREE）：</strong>现在还没有用到这个区中的任何页面</li>
<li><strong>有剩余空间的碎片区（FREE_FRAG）：</strong>表示碎片区中还有可用的页面</li>
<li><strong>没有剩余空间的碎片区（FULL_FRAG）：</strong>表示碎片区中的所有页面都被使用，没有空闲页面</li>
<li><strong>附属于某个段的区（FSEG）：</strong>每一个索引都可以分为叶子节点段和非叶子节点段</li>
</ul>
</li>
<li>处于<strong>FREE、FREE_FRAG</strong>以及<strong>FULL_FRAG</strong>这三种状态的区都是独立的，直属于表空间，而处于<strong>FSEG</strong>状态的区是附属于某个段的</li>
</ul>
<h3 id="7-2-5-表空间"><a href="#7-2-5-表空间" class="headerlink" title="7.2.5 表空间"></a>7.2.5 表空间</h3><ul>
<li>表空间可以看作是InnoDB存储引擎逻辑结构的最高层，所有的数据都存放在表空间中</li>
<li>表空间是一个<strong>逻辑容器</strong>，表空间存储的对象是段，在一个表空间中可以有一个或多个段，但是一个段只能属于一个表空间</li>
<li>表空间数据库由一个或多个表空间组成，表空间从管理层上可以划分为<strong>系统表空间</strong>、<strong>独立表空间</strong>、<strong>撤销表空间</strong>和<strong>临时表空间</strong>等</li>
</ul>
<h4 id="7-2-5-1-独立表空间"><a href="#7-2-5-1-独立表空间" class="headerlink" title="7.2.5.1 独立表空间"></a>7.2.5.1 独立表空间</h4><ul>
<li>独立表空间，即每张表有一个独立的表空间，也就是数据和索引信息都会保存在自己的表空间中</li>
<li>独立表空间可以在不同的数据库之间进行<strong>迁移</strong></li>
<li>空间可以回收（DROP TABLE操作可以自动回收表空间；其他情况，表空间不能自己回收）</li>
<li>如果对于统计分析或是日志表，删除大量数据后可以通过：<code>alter table TableName engine=innodb;</code>回收不用的空间</li>
<li>对于使用独立表空间的表，不管怎么删除，表空间的碎片不会太严重影响性能，而且还有机会处理</li>
</ul>
<blockquote>
<p>独立表空间结构</p>
</blockquote>
<ul>
<li>段</li>
<li>区</li>
<li>页</li>
</ul>
<blockquote>
<p>真实表空间对应的文件大小</p>
</blockquote>
<ul>
<li>新建一个数据库，创建表，发现对应的**.ibd<strong>文件只占用了</strong>96K**，才6个页面的大小（MySQL5.7）</li>
<li>这是因为一开始表空间占用的空间很小，因为表里边没有数据</li>
<li>.ibd文件是<strong>自扩展的</strong>，随着表中数据的增加，表空间对应的文件也逐渐增大</li>
</ul>
<blockquote>
<p>查看InnoDB的表空间类型</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_file_per_table&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name         <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_file_per_table <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="7-2-5-2-系统表空间"><a href="#7-2-5-2-系统表空间" class="headerlink" title="7.2.5.2 系统表空间"></a>7.2.5.2 系统表空间</h4><ul>
<li>系统表空间的结构和独立表空间基本类似</li>
<li>只不过整个MySQL进程只有一个系统表空间</li>
<li>在系统表空间中会额外记录一些有关整个系统信息的页面，这部分是独立表空间没有的</li>
</ul>
<blockquote>
<p>InnoDB数据字典</p>
</blockquote>
<ul>
<li><p>每当我们向一个表中插入一条记录的时候，<strong>MySQL校验过程</strong>如下：</p>
<ul>
<li><p>先校验一下插入语句对应的表是否存在，插入的列和表中的列是否符合，如果语法没有问题的话，还需要知道该表的聚簇索引和所有二级索引对应的根页面是哪个表空间的哪个页面</p>
</li>
<li><p>然后把记录插入对应索引B+树中</p>
</li>
<li><p>所以说，MySQL除了保存我们插入的用户数据之外，还需要保存许多额外的信息，比如说：</p>
<ul>
<li>某个表属于哪个表空间，表里面有多少列</li>
<li>表对应的每一个列的类型是什么</li>
<li>该表有多少索引，每个索引对应哪几个字段，该索引对应的根页面在哪个表空间的哪个页面</li>
<li>该表有哪些外键，外键对应哪个表的哪些列</li>
<li>某个表空间对应文件系统上的文件路径是什么</li>
<li>… …</li>
</ul>
</li>
<li><p>上述这些数据并不是我们使用<strong>insert</strong>语句插入的用户数据，实际上是为了更好的管理用户数据而不得不引入的一些额外数据，这些数据也称为<strong>元数据</strong></p>
</li>
<li><p>InnoDB存储引擎特意定义了一些<strong>内部的系统表</strong>来记录这些元数据：</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>SYS_TABLES</td>
<td>整个InnoDB存储引擎中所有的表的信息</td>
</tr>
<tr>
<td>SYS_COLUMNS</td>
<td>整个InnoDB存储引擎中所有的列的信息</td>
</tr>
<tr>
<td>SYS_INDEXES</td>
<td>整个InnoDB存储引擎中所有的索引的信息</td>
</tr>
<tr>
<td>SYS_FIFLDS</td>
<td>整个InnoDB存储引擎中所有的索引对应的列的信息</td>
</tr>
<tr>
<td>SYS_FOREIGN</td>
<td>整个InnoDB存储引擎中所有的外键的信息</td>
</tr>
<tr>
<td>SYS_FOREIGN_COLS</td>
<td>整个InnoDB存储引擎中所有的外键对应列的信息</td>
</tr>
<tr>
<td>SYS_TABLESPACES</td>
<td>整个InnoDB存储引擎中所有的表空间信息</td>
</tr>
<tr>
<td>SYS_DATAFILES</td>
<td>整个InnoDB存储引擎中所有的表空间对应文件系统的文件路径信息</td>
</tr>
<tr>
<td>SYS_VIRTUAL</td>
<td>整个InnoDB存储引擎中所有的虚拟生成列的信息</td>
</tr>
</tbody></table>
</li>
<li><p>这些系统表也被称为<strong>数据字典</strong>，它们都是以<strong>B+<strong>树的形式保存在系统表空间的某些页面中，其中</strong>SYS_TABLES、SYS_COLUMNS、SYS_INDEXES、SYS_FIELDS</strong>这四个表尤其重要，称之为基本系统表</p>
</li>
<li><p><strong>SYS_TABLES表结构</strong>：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>NAME</td>
<td>表的名称，主键</td>
</tr>
<tr>
<td>ID</td>
<td>InnoDB存储引擎中每个表都有一个唯一的ID,(二级索引)</td>
</tr>
<tr>
<td>N_COLS</td>
<td>该表拥有列的个数</td>
</tr>
<tr>
<td>TYPE</td>
<td>表的类型，记录了一些文件格式、行格式、压缩等信息</td>
</tr>
<tr>
<td>MIX_ID</td>
<td>已过时，忽略</td>
</tr>
<tr>
<td>MIX_LEN</td>
<td>表的一些额外属性</td>
</tr>
<tr>
<td>CLUSTER_ID</td>
<td>未使用，忽略</td>
</tr>
<tr>
<td>SPACE</td>
<td>该表所属表空间的ID</td>
</tr>
</tbody></table>
</li>
<li><p><strong>SYS_COLUMNS表结构：</strong></p>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>TABLE_ID</td>
<td>该列所属表对应的ID（与POS一起构成联合主键）</td>
</tr>
<tr>
<td>POS</td>
<td>该列在表中是第几列</td>
</tr>
<tr>
<td>NAME</td>
<td>该列的名称</td>
</tr>
<tr>
<td>MTYPE</td>
<td>main data type，主数据类型（int、char、varchar、float、double等等）</td>
</tr>
<tr>
<td>PRTYPE</td>
<td>precise type，精确数据类型（修饰主数据类型的，比如是否允许为NULL）</td>
</tr>
<tr>
<td>LEN</td>
<td>该列最多占用存储空间的字节数</td>
</tr>
<tr>
<td>PREC</td>
<td>该列的精度，默认值都是0</td>
</tr>
</tbody></table>
</li>
<li><p>SYS_INDEXES表结构：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>TABLE_ID</td>
<td>该索引所属表对应的ID（与ID一起构成联合索引）</td>
</tr>
<tr>
<td>ID</td>
<td>InnoDB存储引擎中每个索引都有一个唯一的ID</td>
</tr>
<tr>
<td>NAME</td>
<td>该索引的名称</td>
</tr>
<tr>
<td>M_FIELDS</td>
<td>该索引包含列的个数</td>
</tr>
<tr>
<td>TYPE</td>
<td>该索引的类型</td>
</tr>
<tr>
<td>SPACE</td>
<td>该索引根页面所在表空间ID</td>
</tr>
<tr>
<td>PAGE_NO</td>
<td>该索引根页面所在的页面号</td>
</tr>
<tr>
<td>MERGE_THRESHOLD</td>
<td>如果页面中的记录被删除到某个比例，就把该页面和相邻的页面合并，这个值就是这个比例</td>
</tr>
</tbody></table>
</li>
<li><p>SYS_FIELDS表结构：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>INDEX_ID</td>
<td>该索引列所属的索引的ID（与POS一起构成联合主键）</td>
</tr>
<tr>
<td>POS</td>
<td>该索引列在某个索引中是第几列</td>
</tr>
<tr>
<td>COL_NAME</td>
<td>该索引列的名称</td>
</tr>
</tbody></table>
</li>
<li><p>注意：用户是<strong>不能直接访问</strong>InnoDB的这些内部系统表，除非直接去解析系统表空间对应文件系统上的文件</p>
</li>
<li><p>不过考虑到查看这些表的内容可能有助于分析问题，所以在系统数据库<code>information_schema</code>中提供了一些以<code>innodb_sys</code>开头的表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use information_schema;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;innodb_sys%&#x27;</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables <span class="keyword">like</span> <span class="string">&#x27;INNODB_SYS%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_information_schema (INNODB_SYS<span class="operator">%</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_DATAFILES                       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_VIRTUAL                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_INDEXES                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_TABLES                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_FIELDS                          <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_TABLESPACES                     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_FOREIGN_COLS                    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_COLUMNS                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_FOREIGN                         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> INNODB_SYS_TABLESTATS                      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------------------+</span></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="7-3-索引的创建和设计原则"><a href="#7-3-索引的创建和设计原则" class="headerlink" title="7.3 索引的创建和设计原则"></a>7.3 索引的创建和设计原则</h2><h3 id="7-3-1-索引的声明和使用"><a href="#7-3-1-索引的声明和使用" class="headerlink" title="7.3.1 索引的声明和使用"></a>7.3.1 索引的声明和使用</h3><h4 id="7-3-1-1-索引的分类"><a href="#7-3-1-1-索引的分类" class="headerlink" title="7.3.1.1 索引的分类"></a>7.3.1.1 索引的分类</h4><ul>
<li>MySQL的索引包括普通索引、唯一索引、全文索引、单列索引、多列索引和空间索引等</li>
<li>从<strong>功能逻辑</strong>上说，索引主要有4种，分别是普通索引、唯一索引、主键索引、全文索引</li>
<li>按照<strong>物理实现方式</strong>，索引可以分为2种：聚簇索引和非聚簇索引</li>
<li>按照<strong>作用字段个数</strong>进行划分，分成单例索引和联合使用</li>
</ul>
<blockquote>
<p>1.普通索引</p>
</blockquote>
<ul>
<li>在创建普通索引时，不加任何限制条件，只是用于提高查询效率</li>
<li>这类索引可以创建在<strong>任何数据类型</strong>中，其值是否唯一和非空，要由字段本身的完整性约束条件决定</li>
<li>建立索引后，可以通过索引进行查询</li>
<li>例如，在表<strong>student</strong>的字段<strong>name</strong>上建立一个普通索引，查询记录时就可以根据该索引进行查询</li>
</ul>
<blockquote>
<p>2.唯一索引</p>
</blockquote>
<ul>
<li>使用<strong>UNIQUE参数</strong>可以设置索引为唯一索引</li>
<li>在创建唯一索引时，限制该索引的值必须是唯一的，但允许是空值</li>
<li>在一张表里<strong>可以有多个</strong>唯一索引 </li>
<li>例如，在表<strong>student</strong>的字段<strong>Email</strong>中创建唯一索引，那么字段<strong>Email</strong>的值就必须是唯一的。通过唯一索引，可以更快速地确定某条记录</li>
</ul>
<blockquote>
<p>3.主键索引 </p>
</blockquote>
<ul>
<li>主键索引就是一种<strong>特殊的唯一索引</strong></li>
<li>在唯一索引的基础上增加了不为空的约束，也就是NOT NULL+UNIQUE</li>
<li>一张表里<strong>最多只有一个</strong>主键索引：这是由主键索引的物理实现方式决定的，因为数据存储在文件中只能按照一种顺序进行存储</li>
</ul>
<blockquote>
<p>4.单列索引 </p>
</blockquote>
<ul>
<li>在表中单个字段上创建索引</li>
<li>单列索引只根据该字段进行索引</li>
<li>单列索引可以是普通索引，也可以是唯一索引，还可以是全文索引</li>
<li>只要保证该索引只对应一个字段即可</li>
<li>一个表可以<strong>有多个</strong>单列索引</li>
</ul>
<blockquote>
<p>5.多列(组合、联合)索引</p>
</blockquote>
<ul>
<li>多列索引是在表的<strong>多个字段组合</strong>上创建一个索引</li>
<li>该索引指向创建时对应的多个字段，可以通过这几个字段进行查询，但是只有查询条件中使用了这些字段中的第一个字段时才会被使用</li>
<li>例如，在表中的字段id、name和gender上建立一个多列索引<strong>idx_id_name_gender</strong>，只有查询条件中使用了字段id时该索引才会被使用</li>
<li>使用组合索引时遵循<strong>最左前缀集合</strong></li>
</ul>
<blockquote>
<p>6.全文索引</p>
</blockquote>
<ul>
<li>全文索引（也称为全文检索）是目前<strong>搜索引擎</strong>使用的一种关键技术</li>
<li>它能够利用<strong>分词技术</strong>等多种算法智能分析出文本文字中关键词的频率和重要性，然后按照一定的算法规则智能地筛选出我们想要的搜索结果</li>
<li>全文索引非常适合大型数据集，对于小的数据集，它的用处比较小</li>
<li>使用参数<strong>FULLTEXT</strong>可以设置索引为全文索引</li>
<li>在定义索引的列上支持值的全文查找，允许在这些索引列中插入重复值和空值</li>
<li>全文索引只能创建在<strong>char</strong>、<strong>varchar</strong>或<strong>text</strong>类型及其系列类型的字段上，<strong>查找数据量较大的字符串类型的字段时，使用全文索引可以提高查询速度</strong></li>
<li>例如，表<strong>student</strong>的字段<strong>information</strong>是<strong>text</strong>类型，该字段包含了很多文字信息。在information上建立全文索引后，可以提高查询字段information的速度</li>
<li>全文索引典型的两种类型：自然语言的全文索引和布尔全文索引<ul>
<li>自然语言搜索引擎将计算每一个文档对象和查询的相关度。这里，相关度是基于匹配的关键词的个数，以及关键词在文档中出现的次数。<strong>在整个索引中出现次数越少的词语，匹配时的相关度就越高</strong>。相反，非常常见的单词将不会被搜索，如果一个词语在超过50%的记录中都出现了，那么自然语言的搜索将不会搜索这类词语</li>
</ul>
</li>
<li>MySQL数据库从3.23.23版开始支持全文索引，但是MySQL5.6.4以前<strong>只有MyISAM支持</strong>，5.6.4版本以后InnoDB才支持，但是官方版本不支持<strong>中文分词</strong>，需要第三方分词插件。在5.7.6版本，MySQL内置了<strong>ngram全文解析器</strong>，用来支持亚洲语种的分词</li>
<li>随着大数据时代到来，关系型数据库应对全文索引的需求已力不从心，逐渐被<strong>solr</strong>、<strong>ElasticSearch</strong>等专门的搜索引擎所替代</li>
</ul>
<blockquote>
<p>7.补充：空间索引</p>
</blockquote>
<ul>
<li>使用参数<strong>SPATIAL</strong>可以设置索引为<strong>空间索引</strong></li>
<li>空间索引只能建立在空间数据类型上，这样可以提高系统获取空间数据的效率</li>
<li>MySQL中的空间数据类型包括<strong>GEOMETRY</strong>、<strong>POINT</strong>、<strong>LINESTRING</strong>和<strong>POLYGON</strong>等</li>
<li>目前只有MyISAM存储引擎支持空间检索，而且索引的字段不能为空值</li>
</ul>
<blockquote>
<p>小结：不同的存储引擎支持的索引类型也不一样</p>
</blockquote>
<ul>
<li><strong>InnoDB</strong>：支持B-tree、Full-text等索引，不支持hash索引</li>
<li><strong>MyISAM</strong>：支持B-tree、Full-text等索引，不支持hash索引</li>
<li><strong>Memory</strong>：支持B-tree、hash等索引，不支持Full-text索引</li>
<li><strong>NDB</strong>：支持hash索引，不支持B-tree、Full-text等索引</li>
<li><strong>Archive</strong>：不支持B-tree、hash、Full-text等索引</li>
</ul>
<h4 id="7-3-1-2-创建索引"><a href="#7-3-1-2-创建索引" class="headerlink" title="7.3.1.2 创建索引"></a>7.3.1.2 创建索引</h4><ul>
<li>MySQL支持多种方法在单个或多个列上创建索引</li>
<li>在<strong>创建表</strong>的定义语句**<code>create table</code>** 中指定索引列</li>
<li>使用**<code>alter table</code>** 语句在<strong>存在的表</strong>上创建索引</li>
<li>使用**<code>create index</code>** 语句在已<strong>存在的表</strong>上添加索引</li>
</ul>
<blockquote>
<p>1.<strong>创建表的时候</strong>创建索引</p>
</blockquote>
<ul>
<li><p>使用create table创建表时，除了可以定义列的数据类型外，还可以定义主键约束、外键约束或者唯一性约束，而且不论创建哪种约束，<strong>在定义约束的同时相当于在指定列上创建了一个索引</strong></p>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#隐式的方式创建索引。在声明有主键约束、唯一性约束、外键约束的字段上，会自动的添加相关的索引</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE dbtest2;</span><br><span class="line"></span><br><span class="line">USE dbtest2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept(</span><br><span class="line">    dept_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    dept_name <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp(</span><br><span class="line">    emp_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    emp_name <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">UNIQUE</span>,</span><br><span class="line">    dept_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> emp_dept_id_fk <span class="keyword">FOREIGN</span> KEY(dept_id) <span class="keyword">REFERENCES</span> dept(dept_id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201151921091.png" alt="MySQL之性能优化/image-20221201151921091"></p>
</li>
<li><p>但是，如果<strong>显式创建表时创建索引</strong>的话，基本语法格式如下： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name [col_name data_type]</span><br><span class="line">[<span class="keyword">UNIQUE</span> <span class="operator">|</span> FULLTEXT <span class="operator">|</span> SPATIAL] [INDEX <span class="operator">|</span> KEY] [index_name] (col_name [length]) [<span class="keyword">ASC</span> <span class="operator">|</span></span><br><span class="line"><span class="keyword">DESC</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>UNIQUE</strong> 、 <strong>FULLTEXT</strong> 和 <strong>SPATIAL</strong> 为可选参数，分别表示唯一索引、全文索引和空间索引</li>
<li><strong>INDEX</strong> 与 <strong>KEY</strong> 为同义词，两者的作用相同，用来指定创建索引</li>
<li><strong>index_name</strong> 指定索引的名称，为可选参数，如果不指定，那么MySQL默认col_name为索引名</li>
<li><strong>col_name</strong> 为需要创建索引的字段列，该列必须从数据表中定义的多个列中选择</li>
<li><strong>length</strong> 为可选参数，表示索引的长度，只有字符串类型的字段才能指定索引长度</li>
<li><strong>ASC</strong> 或 <strong>DESC</strong> 指定升序或者降序的索引值存储</li>
</ul>
</li>
<li><p>① 创建普通的索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span>,</span><br><span class="line">    #声明索引</span><br><span class="line">    INDEX idx_bname(book_name)</span><br><span class="line">);`atguigudb`</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201152621193.png" alt="MySQL之性能优化/image-20221201152621193"></p>
<ul>
<li><p>命令查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">1</span>：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> `book`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: book</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `book` (</span><br><span class="line">  `book_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `book_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authors` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `info` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `comment` <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `year_publication` <span class="keyword">year</span>(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `idx_bname` (`book_name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#方式<span class="number">2</span>：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_bname</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: book_name</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>性能分析工具：**<code>EXPLAIN</code>**</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book <span class="keyword">WHERE</span> book_name <span class="operator">=</span> <span class="string">&#x27;mysql高级&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_bname</span><br><span class="line">          key: idx_bname</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>② 创建唯一索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 声明有唯一索引的字段，在添加数据时，要保证唯一性，但是可以添加<span class="keyword">null</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book1(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span>,</span><br><span class="line">    #声明索引</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX uk_idx_cmt(`comment`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book1</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: uk_idx_cmt</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: comment</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>插入数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book1(book_id,book_name,`comment`)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">&#x27;Mysql高级&#x27;</span>,<span class="string">&#x27;适合有数据库开发经验的人员学习&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book1(book_id,book_name,`comment`)</span><br><span class="line"><span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">&#x27;Mysql高级&#x27;</span>,<span class="keyword">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book1;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201154417352.png" alt="MySQL之性能优化/image-20221201154417352"></p>
</li>
</ul>
</li>
<li><p>③ 主键索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#通过定义主键约束的方式定义主键索引</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book2(</span><br><span class="line">    book_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book2</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: <span class="keyword">PRIMARY</span></span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: book_id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>通过删除主键约束的方式删除主键索引</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">ALTER</span> <span class="keyword">TABLE</span> book2</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">DROP</span> <span class="keyword">PRIMARY</span> KEY;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.06</span> sec)</span><br><span class="line">Records: <span class="number">0</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book2\G</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>④ 创建单列索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book3(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span>,</span><br><span class="line">    #声明索引</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX idx_bname(book_name)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book3\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book3</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: idx_bname</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: book_name</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>⑤ 创建联合索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book4(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span>,</span><br><span class="line">    #声明索引</span><br><span class="line">    INDEX mul_bid_bname_info(book_id,book_name,info)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book4\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book4</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: mul_bid_bname_info</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: book_id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book4</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: mul_bid_bname_info</span><br><span class="line"> Seq_in_index: <span class="number">2</span></span><br><span class="line">  Column_name: book_name</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: book4</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: mul_bid_bname_info</span><br><span class="line"> Seq_in_index: <span class="number">3</span></span><br><span class="line">  Column_name: info</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book4 <span class="keyword">WHERE</span> book_id <span class="operator">=</span> <span class="number">1001</span> <span class="keyword">AND</span> book_name <span class="operator">=</span> <span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+--------------------+--------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys      <span class="operator">|</span> key                <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>         <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+--------------------+--------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> book4 <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> mul_bid_bname_info <span class="operator">|</span> mul_bid_bname_info <span class="operator">|</span> <span class="number">308</span>     <span class="operator">|</span> const,const <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">NULL</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+--------------------+--------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book4 <span class="keyword">WHERE</span> book_name <span class="operator">=</span> <span class="string">&#x27;mysql&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> select_type <span class="operator">|</span> <span class="keyword">table</span> <span class="operator">|</span> partitions <span class="operator">|</span> type <span class="operator">|</span> possible_keys <span class="operator">|</span> key  <span class="operator">|</span> key_len <span class="operator">|</span> <span class="keyword">ref</span>  <span class="operator">|</span> <span class="keyword">rows</span> <span class="operator">|</span> filtered <span class="operator">|</span> Extra       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> SIMPLE      <span class="operator">|</span> book4 <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">ALL</span>  <span class="operator">|</span> <span class="keyword">NULL</span>          <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>    <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span>   <span class="number">100.00</span> <span class="operator">|</span> <span class="keyword">Using</span> <span class="keyword">where</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201155707219.png" alt="MySQL之性能优化/image-20221201155707219"></p>
</li>
</ul>
</li>
<li><p>⑥ 创建全文索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test4(</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name` <span class="type">CHAR</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    age <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">255</span>),</span><br><span class="line">    FULLTEXT INDEX futxt_idx_info(info(<span class="number">50</span>))</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> test4\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: test4</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: futxt_idx_info</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: info</span><br><span class="line">    <span class="keyword">Collation</span>: <span class="keyword">NULL</span></span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">0</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: FULLTEXT</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<p>2.在已经存在的表上创建索引</p>
</blockquote>
<ul>
<li><p>① 使用**<code>alter table</code>**语句创建索引</p>
<ul>
<li><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">ADD</span> [<span class="keyword">UNIQUE</span> <span class="operator">|</span> FULLTEXT <span class="operator">|</span> SPATIAL] [INDEX <span class="operator">|</span> KEY]</span><br><span class="line">[index_name] (col_name[length],...) [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book5(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book5;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> book5 <span class="keyword">ADD</span> INDEX idx_cmt(`comment`);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> book5 <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> uk_idx_bname(book_name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> book5 <span class="keyword">ADD</span> INDEX mul_bid_bname_info(book_id,book_name,info);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201160825236.png" alt="MySQL之性能优化/image-20221201160825236"></p>
</li>
</ul>
</li>
<li><p>② .使用**<code>create index</code>**创建索引</p>
<ul>
<li><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">UNIQUE</span> <span class="operator">|</span> FULLTEXT <span class="operator">|</span> SPATIAL] INDEX index_name</span><br><span class="line"><span class="keyword">ON</span> table_name (col_name[length],...) [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]</span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book6(</span><br><span class="line">    book_id <span class="type">INT</span> ,</span><br><span class="line">    book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    `authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">    `comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    year_publication <span class="keyword">YEAR</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book6;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_cmt <span class="keyword">ON</span> book6(`comment`);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> INDEX  uk_idx_bname <span class="keyword">ON</span> book6(book_name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX mul_bid_bname_info <span class="keyword">ON</span> book6(book_id,book_name,info);</span><br></pre></td></tr></table></figure>

<p><img src="image-20221201161128834.png" alt="MySQL之性能优化/image-20221201161128834"></p>
</li>
</ul>
</li>
</ul>
<h4 id="7-3-1-3-删除索引"><a href="#7-3-1-3-删除索引" class="headerlink" title="7.3.1.3 删除索引"></a>7.3.1.3 删除索引</h4><ul>
<li><p>1.使用**<code>ALTER TABLE</code>**删除索引 **<code>ALTER TABLE</code>**删除索引的基本语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">DROP</span> INDEX index_name;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>添加auto_increment约束字段的唯一索引不能被删除</strong></li>
</ul>
</li>
<li><p>2.使用**<code>DROP INDEX</code>**语句删除索引 **<code>DROP INDEX</code>**删除索引的基本语法格式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX index_name <span class="keyword">ON</span> table_name;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>删除表中的列时，如果要删除的列为索引的组成部分，则该列也会从索引中删除</strong></li>
<li><strong>如果组成索引的所有列都被删除，则整个索引将被删除</strong></li>
</ul>
</li>
</ul>
<h3 id="7-3-2-MySQL8索引的新特性"><a href="#7-3-2-MySQL8索引的新特性" class="headerlink" title="7.3.2 MySQL8索引的新特性"></a>7.3.2 MySQL8索引的新特性</h3><h4 id="7-3-2-1-支持降序索引"><a href="#7-3-2-1-支持降序索引" class="headerlink" title="7.3.2.1 支持降序索引"></a>7.3.2.1 支持降序索引</h4><ul>
<li><p>降序索引以降序存储键值</p>
</li>
<li><p>虽然在语法上，从MySQL4版本开始就支持降序索引的语法了，但实际上该DESC定义是被忽略的，直到MySQL8版本才开始真正支持降序索引（仅限于InnoDB存储引擎）</p>
</li>
<li><p>MySQL在8.0版本之前创建的仍然是升序索引，使用时进行反向扫描，这大大降低了数据库的效率</p>
</li>
<li><p>在某些场景下，降序索引意义重大，例如：</p>
<ul>
<li>如果一个查询，需要对多个列进行排序，且顺序要求不一样，那么使用降序索引将会避免数据库使用额外的文件排序操作，从而提高性能</li>
</ul>
</li>
<li><p>举例：分别在MySQL5.7版本和MySQL8.0版本中创建数据表ts1，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ts1(a <span class="type">INT</span>,b <span class="type">INT</span>,INDEX idx_a_b(a <span class="keyword">ASC</span>,b <span class="keyword">DESC</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ts1;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在MySQL5.7版本中查看数据表ts1结构，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ts1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: ts1</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ts1` (</span><br><span class="line">  `a` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `b` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `idx_a_b` (`a`,`b`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在MySQL8.0版本中查看数据表ts1结构，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ts1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">       <span class="keyword">Table</span>: ts1</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `ts1` (</span><br><span class="line">  `a` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `b` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  KEY `idx_a_b` (`a`,`b` <span class="keyword">DESC</span>)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>从结果可以看出，索引已经降序了。下面继续测试降序索引在执行计划中的表现</p>
</li>
<li><p>分别在MySQL 5.7版本和MySQL 8.0版本的数据表ts1中插入800条随机数据，执行语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> ts_insert()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line">	WHILE i <span class="operator">&lt;</span> <span class="number">800</span></span><br><span class="line">	DO</span><br><span class="line">		<span class="keyword">INSERT</span> <span class="keyword">INTO</span> ts1 <span class="keyword">SELECT</span> RAND()<span class="operator">*</span><span class="number">80000</span>,RAND()<span class="operator">*</span><span class="number">80000</span>;</span><br><span class="line">		<span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">END</span> WHILE;</span><br><span class="line">	<span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用</span><br><span class="line"><span class="keyword">CALL</span> ts_insert();</span><br></pre></td></tr></table></figure>
</li>
<li><p>在MySQL 5.7版本中查看数据表ts1的执行计划，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#优化测试</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ts1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,b <span class="keyword">DESC</span> LIMIT <span class="number">5</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: ts1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_a_b</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">799</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>从结果可以看出，执行计划中扫描数为799，而且使用了<strong>Using filesort</strong></li>
<li><strong>Using filesort</strong>是MySQL中一种速度比较慢的外部排序，能避免是最好的。多数情况下，管理员可以通过优化索引来尽量避免出现Using filesort，从而提高数据库执行速度</li>
</ul>
</li>
<li><p>在MySQL 8.0版本中查看数据表ts1的执行计划，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#优化测试</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ts1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,b <span class="keyword">DESC</span> LIMIT <span class="number">5</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: ts1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_a_b</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">5</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>从结果可以看出，执行计划中扫描数为5，而且没有使用 Using filesort</p>
</li>
<li><p>降序索引只对查询中特定的排序顺序有效，如果使用不当，反而查询效率更低。例如，<strong>上述查询排序条件改为order by a desc, b desc，MySQL 5.7的执行计划要明显好于MySQL 8.0</strong></p>
</li>
<li><p>将排序条件修改为order by a desc, b desc后，下面来对比不同版本中执行计划的效果。 在MySQL 5.7版本中查看数据表ts1的执行计划，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#优化测试</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ts1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">DESC</span>,b <span class="keyword">DESC</span> LIMIT <span class="number">5</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: ts1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_a_b</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">5</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在MySQL 8.0版本中查看数据表ts1的执行计划，结果如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#优化测试</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> ts1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,b <span class="keyword">DESC</span> LIMIT <span class="number">5</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: ts1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_a_b</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">799</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>从结果可以看出，修改后MySQL 5.7的执行计划要明显好于MySQL 8.0</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-3-2-2-隐藏索引"><a href="#7-3-2-2-隐藏索引" class="headerlink" title="7.3.2.2 隐藏索引"></a>7.3.2.2 隐藏索引</h4><ul>
<li><p>在MySQL 5.7版本及之前，只能通过显式的方式删除索引。此时，如果发现删除索引后出现错误，又只能 通过显式创建索引的方式将删除的索引创建回来。如果数据表中的数据量非常大，或者数据表本身比较 大，这种操作就会消耗系统过多的资源，操作成本非常高 </p>
</li>
<li><p>从MySQL 8.x开始支持 <strong>隐藏索引（invisible indexes）</strong>，只需要将待删除的索引设置为隐藏索引，使 查询优化器不再使用这个索引（即使使用force index（强制使用索引），优化器也不会使用该索引）， 确认将索引设置为隐藏索引后系统不受任何响应，就可以彻底删除索引。 <strong>这种通过先将索引设置为隐藏索引，再删除索引的方式就是软删除</strong></p>
</li>
<li><p>同时，如果想验证某个索引删除之后的<strong>查询性能影响</strong>，就可以暂时先隐藏该索引</p>
</li>
<li><p><strong>注意：主键不能被设置为隐藏索引。当表中没有显示主键时，表中第一个唯一非空索引会成为隐式主键，也不能被设置为隐藏索引</strong></p>
</li>
<li><p>索引默认是可见的，在使用create table，create index或者alter table等语句时可以通过<strong>visible</strong>或者<strong>invisible</strong>关键词设置索引的可见性</p>
</li>
</ul>
<blockquote>
<p>1.<strong>创建表时直接创建</strong> </p>
</blockquote>
<ul>
<li><p>在MySQL中创建隐藏索引通过SQL语句<strong>INVISIBLE</strong>来实现，其语法形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tablename(</span><br><span class="line">    propname1 type1[CONSTRAINT1],</span><br><span class="line">    propname2 type2[CONSTRAINT2],</span><br><span class="line">    ……</span><br><span class="line">    propnamen typen,</span><br><span class="line">    INDEX [indexname](propname1 [(length)]) INVISIBLE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>上述语句比普通索引多了一个关键字<strong>INVISIBLE</strong>，用来标记索引为<strong>不可见索引</strong></li>
</ul>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> book7(</span><br><span class="line">	book_id <span class="type">INT</span> ,</span><br><span class="line">	book_name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	`authors` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	info <span class="type">VARCHAR</span>(<span class="number">100</span>) ,</span><br><span class="line">	`comment` <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	year_publication <span class="keyword">YEAR</span>,</span><br><span class="line">	#创建不可见的索引</span><br><span class="line">	INDEX idx_cmt(`comment`) invisible</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> book7;</span><br><span class="line"></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book7 <span class="keyword">WHERE</span> COMMENT <span class="operator">=</span> <span class="string">&#x27;mysql....&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>2.<strong>在已经存在的表上创建</strong></p>
</blockquote>
<ul>
<li><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX indexname</span><br><span class="line"><span class="keyword">ON</span> tablename(propname[(length)]) INVISIBLE;</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename</span><br><span class="line"><span class="keyword">ADD</span> INDEX indexname (propname [(length)]) INVISIBLE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> book7</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> INDEX uk_idx_bname(book_name) invisible;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_year_pub <span class="keyword">ON</span> book7(year_publication);</span><br><span class="line"></span><br><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> book7 <span class="keyword">WHERE</span> year_publication <span class="operator">=</span> <span class="string">&#x27;2022&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>3.<strong>修改索引的可见性</strong></p>
</blockquote>
<ul>
<li><p>语法：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">ALTER</span> INDEX index_name INVISIBLE; #切换成隐藏索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tablename <span class="keyword">ALTER</span> INDEX index_name VISIBLE; #切换成非隐藏索引</span><br></pre></td></tr></table></figure>
</li>
<li><p>当索引被隐藏时，它的内容仍然是和正常索引一样实时更新的。如果一个索引需要长期被隐 藏，那么可以将其删除，因为索引的存在会影响插入、更新和删除的性能</p>
</li>
<li><p>通过设置隐藏索引的可见性可以查看索引对调优的帮助</p>
</li>
</ul>
<blockquote>
<p>4.<strong>使隐藏索引对查询优化器可见</strong></p>
</blockquote>
<ul>
<li><p>在MySQL 8.x版本中，为索引提供了一种新的测试方式，可以通过查询优化器的一个开关 （<code>use_invisible_indexes</code>）来打开某个设置，使隐藏索引对查询优化器可见。如果 <code>use_invisible_indexes</code> 设置为<strong>off</strong>(默认)，优化器会忽略隐藏索引。如果设置为<strong>on</strong>，即使隐藏索引不可见，优化器在生成执行计 划时仍会考虑使用隐藏索引</p>
</li>
<li><p>1.在MySQL命令行执行如下命令查看查询优化器的开关设置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@optimizer</span>_switch \G</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在输出的结果信息中找到如下属性配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">use_invisible_indexes</span>=<span class="string">off</span></span><br></pre></td></tr></table></figure>

<ul>
<li>此属性配置值为off，说明隐藏索引默认对查询优化器不可见</li>
</ul>
</li>
</ul>
</li>
<li><p>2.使隐藏索引对查询优化器可见，需要在MySQL命令行执行如下命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session optimizer_switch<span class="operator">=</span>&quot;use_invisible_indexes=on&quot;;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>SQL语句执行成功，再次查看查询优化器的开关设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@optimizer</span>_switch \G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">@<span class="variable">@optimizer</span>_switch:</span><br><span class="line">index_merge<span class="operator">=</span><span class="keyword">on</span>,index_merge_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_sort_union<span class="operator">=</span><span class="keyword">on</span>,index_merge_</span><br><span class="line"><span class="keyword">intersection</span><span class="operator">=</span><span class="keyword">on</span>,engine_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,index_condition_pushdown<span class="operator">=</span><span class="keyword">on</span>,mrr<span class="operator">=</span><span class="keyword">on</span>,mrr_co</span><br><span class="line">st_based<span class="operator">=</span><span class="keyword">on</span>,block_nested_loop<span class="operator">=</span><span class="keyword">on</span>,batched_key_access<span class="operator">=</span>off,materialization<span class="operator">=</span><span class="keyword">on</span>,semijoin<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">,loosescan<span class="operator">=</span><span class="keyword">on</span>,firstmatch<span class="operator">=</span><span class="keyword">on</span>,duplicateweedout<span class="operator">=</span><span class="keyword">on</span>,subquery_materialization_cost_based<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line">,use_index_extensions<span class="operator">=</span><span class="keyword">on</span>,condition_fanout_filter<span class="operator">=</span><span class="keyword">on</span>,derived_merge<span class="operator">=</span><span class="keyword">on</span>,use_invisible_ind</span><br><span class="line">exes<span class="operator">=</span><span class="keyword">on</span>,skip_scan<span class="operator">=</span><span class="keyword">on</span>,hash_join<span class="operator">=</span><span class="keyword">on</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时，在输出结果中可以看到如下属性配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">use_invisible_indexes</span>=<span class="string">on</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>use_invisible_indexes</code>属性的值为<strong>on</strong>，说明此时隐藏索引对查询优化器可见</p>
</li>
</ul>
</li>
<li><p>3.使用<code>EXPLAIN</code>查看以字段<code>invisible_column</code>作为查询条件时的索引使用情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> classes <span class="keyword">where</span> cname <span class="operator">=</span> <span class="string">&#x27;高一2班&#x27;</span>;</span><br><span class="line">#查询优化器会使用隐藏索引来查询数据</span><br></pre></td></tr></table></figure>
</li>
<li><p>4.如果需要使隐藏索引对查询优化器不可见，则只需要执行如下命令即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session optimizer_switch<span class="operator">=</span>&quot;use_invisible_indexes=off&quot;;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再次查看查询优化器的开关设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@optimizer</span>_switch \G</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时，<code>use_invisible_indexes</code>属性的值已经被设置为<strong>off</strong></p>
</li>
</ul>
</li>
</ul>
<h3 id="7-3-3-索引的设计原则"><a href="#7-3-3-索引的设计原则" class="headerlink" title="7.3.3 索引的设计原则"></a>7.3.3 索引的设计原则</h3><ul>
<li>为了使索引的使用效率更高，在创建索引时，必须考虑在哪些字段上创建索引和创建什么类型的索引</li>
<li><strong>索引设计不合理或者缺少索引都会对数据库和应用程序的性能造成障碍</strong></li>
<li>高效的索引对于获得良好的性能非常重要。设计索引时，应该考虑相应准则</li>
</ul>
<h4 id="7-3-3-1-数据准备"><a href="#7-3-3-1-数据准备" class="headerlink" title="7.3.3.1 数据准备"></a>7.3.3.1 数据准备</h4><blockquote>
<p>第1步：创建数据库、创建表</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span>创建学生表和课程表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student_info` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">11</span>) AUTO_INCREMENT,</span><br><span class="line">    `student_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `name` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `course_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `class_id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `create_time` DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `course` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `course_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `course_name` <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第2步：创建模拟数据必需的存储函数</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#函数<span class="number">1</span>：创建随机产生字符串函数</span><br><span class="line"></span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string(n <span class="type">INT</span>) </span><br><span class="line">	<span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>) #该函数会返回一个字符串</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">	<span class="keyword">DECLARE</span> chars_str <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> return_str <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">	WHILE i <span class="operator">&lt;</span> n DO </span><br><span class="line">       <span class="keyword">SET</span> return_str <span class="operator">=</span>CONCAT(return_str,<span class="built_in">SUBSTRING</span>(chars_str,<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>RAND()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line">       <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">END</span> WHILE;</span><br><span class="line">    <span class="keyword">RETURN</span> return_str;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@log</span>_bin_trust_function_creators;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> log_bin_trust_function_creators <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#函数<span class="number">2</span>：创建随机数函数</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_num (from_num <span class="type">INT</span> ,to_num <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span>(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">BEGIN</span>   </span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> <span class="built_in">FLOOR</span>(from_num <span class="operator">+</span>RAND()<span class="operator">*</span>(to_num <span class="operator">-</span> from_num<span class="operator">+</span><span class="number">1</span>))   ;</span><br><span class="line"><span class="keyword">RETURN</span> i;  </span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第3步：创建插入模拟数据的存储过程</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 存储过程<span class="number">1</span>：创建插入课程表存储过程</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span>  insert_course( max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;   </span><br><span class="line"> <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;    #设置手动提交事务</span><br><span class="line"> REPEAT  #循环</span><br><span class="line"> <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;  #赋值</span><br><span class="line"> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> course (course_id, course_name ) <span class="keyword">VALUES</span> (rand_num(<span class="number">10000</span>,<span class="number">10100</span>),rand_string(<span class="number">6</span>));  </span><br><span class="line"> UNTIL i <span class="operator">=</span> max_num  </span><br><span class="line"> <span class="keyword">END</span> REPEAT;  </span><br><span class="line"> <span class="keyword">COMMIT</span>;  #提交事务</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 存储过程<span class="number">2</span>：创建插入学生信息表存储过程</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span>  insert_stu( max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;   </span><br><span class="line"> <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;    #设置手动提交事务</span><br><span class="line"> REPEAT  #循环</span><br><span class="line"> <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;  #赋值</span><br><span class="line"> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> student_info (course_id, class_id ,student_id ,NAME ) <span class="keyword">VALUES</span> (rand_num(<span class="number">10000</span>,<span class="number">10100</span>),rand_num(<span class="number">10000</span>,<span class="number">10200</span>),rand_num(<span class="number">1</span>,<span class="number">200000</span>),rand_string(<span class="number">6</span>));  </span><br><span class="line"> UNTIL i <span class="operator">=</span> max_num  </span><br><span class="line"> <span class="keyword">END</span> REPEAT;  </span><br><span class="line"> <span class="keyword">COMMIT</span>;  #提交事务</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>第4步：调用存储过程</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#调用存储过程：</span><br><span class="line"><span class="keyword">CALL</span> insert_course(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> course;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> insert_stu(<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student_info;</span><br></pre></td></tr></table></figure>

<h4 id="7-3-3-2-适合创建索引的情况"><a href="#7-3-3-2-适合创建索引的情况" class="headerlink" title="7.3.3.2 适合创建索引的情况"></a>7.3.3.2 适合创建索引的情况</h4><blockquote>
<p>1.<strong>字段的数值有唯一性的限制</strong></p>
</blockquote>
<ul>
<li>索引本身可以起到约束作用，比如唯一索引、主键索引都可以起到唯一性约束</li>
<li>因此在数据表中，如果<strong>某个字段是唯一性的</strong>，就可以直接<strong>创建唯一索引</strong>，或者<strong>主键索引</strong></li>
<li>这样可以更快速地通过该索引来确定某条记录</li>
<li>例如，学生表中<strong>学号</strong>是具有唯一性的字段，为该字段建立唯一性索引可以很快确定某个学生的信息，如果使用<strong>姓名</strong>的话，可能会出现重名现象，从而降低查询速度</li>
<li>业务上具有唯一特性的字段，即使是<strong>组合字段</strong>，也<strong>必须</strong>建成唯一索引</li>
<li>说明：<strong>不要以为唯一索引影响了 insert 速度，这个速度损耗可以忽略</strong>，但提高查找速度是明显的</li>
</ul>
<blockquote>
<p>2.<strong>频繁作为 WHERE 查询条件的字段</strong></p>
</blockquote>
<ul>
<li><p>某个字段在SELECT语句的 WHERE 条件中经常被使用到，那么就需要给这个字段创建索引了。尤其是在 数据量大的情况下，创建普通索引就可以大幅提升数据查询的效率</p>
</li>
<li><p>比如student_info数据表（含100万条数据），假设我们想要查询 student_id&#x3D;123110 的用户信息</p>
<ul>
<li><p>如果没有对student_id字段创建索引，进行如下查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> course_id, class_id, NAME, create_time, student_id </span><br><span class="line"><span class="keyword">FROM</span> student_info</span><br><span class="line"><span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123110</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> course_id, class_id, NAME, create_time, student_id </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">FROM</span> student_info</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123110</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span> course_id <span class="operator">|</span> class_id <span class="operator">|</span> NAME   <span class="operator">|</span> create_time         <span class="operator">|</span> student_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">10045</span> <span class="operator">|</span>    <span class="number">10199</span> <span class="operator">|</span> fJetFT <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">49</span> <span class="operator">|</span>     <span class="number">123110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">10021</span> <span class="operator">|</span>    <span class="number">10131</span> <span class="operator">|</span> gMtFVL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">10</span> <span class="operator">|</span>     <span class="number">123110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.29</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>给student_id字段添加索引，然后查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#给student_id字段添加索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_sid(student_id);</span><br><span class="line"></span><br><span class="line">#student_id字段上有索引的：</span><br><span class="line"><span class="keyword">SELECT</span> course_id, class_id, NAME, create_time, student_id </span><br><span class="line"><span class="keyword">FROM</span> student_info</span><br><span class="line"><span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123110</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student_info\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student_info</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: <span class="keyword">PRIMARY</span></span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">994004</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student_info</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_sid</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: student_id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">197516</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> course_id, class_id, NAME, create_time, student_id  <span class="keyword">FROM</span> student_info <span class="keyword">WHERE</span> student_id <span class="operator">=</span> <span class="number">123110</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span> course_id <span class="operator">|</span> class_id <span class="operator">|</span> NAME   <span class="operator">|</span> create_time         <span class="operator">|</span> student_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">10045</span> <span class="operator">|</span>    <span class="number">10199</span> <span class="operator">|</span> fJetFT <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">37</span>:<span class="number">49</span> <span class="operator">|</span>     <span class="number">123110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">10021</span> <span class="operator">|</span>    <span class="number">10131</span> <span class="operator">|</span> gMtFVL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">10</span> <span class="operator">|</span>     <span class="number">123110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+----------+--------+---------------------+------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>3.经常 GROUP BY 和 ORDER BY 的列</strong></p>
</blockquote>
<ul>
<li><p>索引就是让数据按照某种顺序进行存储或检索，因此当我们使用 GROUP BY 对数据进行分组查询，或者使用 ORDER BY 对数据进行排序的时候，就需要<strong>对分组或者排序的字段进行索引</strong> 。如果待排序的列有多个，那么可以在这些列上建立<strong>组合索引</strong></p>
</li>
<li><p>比如，按照student_id对学生选修的课程进行分组，显示不同的student_id和课程数量，显示100个即可</p>
<ul>
<li><p>不对student_id创建索引，执行查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num </span><br><span class="line"><span class="keyword">FROM</span> student_info </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id LIMIT <span class="number">100</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num  <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id LIMIT <span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> num <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">1</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">2</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">3</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">4</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">5</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">6</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">7</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">8</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">9</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">10</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">11</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">12</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">13</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">14</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">15</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">16</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">17</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">18</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">19</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">20</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">21</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">22</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">23</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">24</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">25</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">26</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">27</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">28</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">29</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">30</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">31</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">32</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">33</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">34</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">35</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">36</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">37</span> <span class="operator">|</span>  <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">38</span> <span class="operator">|</span>  <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">39</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">40</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">41</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">42</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">43</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">44</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">45</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">46</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">47</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">48</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">49</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">50</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">51</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">52</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">53</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">54</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">55</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">56</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">57</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">58</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">59</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">60</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">61</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">62</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">63</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">64</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">65</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">66</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">67</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">68</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">69</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">70</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">71</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">72</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">73</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">74</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">75</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">76</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">77</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">78</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">79</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">80</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">81</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">82</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">83</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">84</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">85</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">86</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">87</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">88</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">89</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">90</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">91</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">92</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">93</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">94</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">95</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">96</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">97</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">98</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">99</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">100</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.82</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>对student_id创建索引，执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num </span><br><span class="line"><span class="keyword">FROM</span> student_info </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id LIMIT <span class="number">100</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student_info\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student_info</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: <span class="keyword">PRIMARY</span></span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">994004</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student_info</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_sid</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: student_id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">197516</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">FROM</span> student_info </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id LIMIT <span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> num <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">1</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">2</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">3</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">4</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">5</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">6</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">7</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">8</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>          <span class="number">9</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">10</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">11</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">12</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">13</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">14</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">15</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">16</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">17</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">18</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">19</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">20</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">21</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">22</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">23</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">24</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">25</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">26</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">27</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">28</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">29</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">30</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">31</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">32</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">33</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">34</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">35</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">36</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">37</span> <span class="operator">|</span>  <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">38</span> <span class="operator">|</span>  <span class="number">11</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">39</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">40</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">41</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">42</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">43</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">44</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">45</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">46</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">47</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">48</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">49</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">50</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">51</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">52</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">53</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">54</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">55</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">56</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">57</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">58</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">59</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">60</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">61</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">62</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">63</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">64</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">65</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">66</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">67</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">68</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">69</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">70</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">71</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">72</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">73</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">74</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">75</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">76</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">77</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">78</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">79</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">80</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">81</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">82</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">83</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">84</span> <span class="operator">|</span>   <span class="number">7</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">85</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">86</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">87</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">88</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">89</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">90</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">91</span> <span class="operator">|</span>   <span class="number">8</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">92</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">93</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">94</span> <span class="operator">|</span>   <span class="number">5</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">95</span> <span class="operator">|</span>   <span class="number">3</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">96</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">97</span> <span class="operator">|</span>   <span class="number">9</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">98</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>         <span class="number">99</span> <span class="operator">|</span>   <span class="number">4</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">100</span> <span class="operator">|</span>   <span class="number">6</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>同样，如果ORDER BY，也需要对字段创建索引</p>
</li>
</ul>
</li>
<li><p>如果同时有GROUP BY和ORDER BY的情况：如果按照student_id进行分组，同时按照创建时间降序的方式进行排序，这时就需要同时进行GROUP BY和ORDER BY，那么是不是需要单独创建student_id的索引和create_time的索引呢？</p>
<ul>
<li><p>当对student_id和create_time<strong>分别创建索引</strong>，执行SQL查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_sid(student_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_cre_time(create_time);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">100</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id  <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span>  LIMIT <span class="number">100</span>;</span><br><span class="line">ERROR <span class="number">1055</span> (<span class="number">42000</span>): Expression #<span class="number">1</span> <span class="keyword">of</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> clause <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause <span class="keyword">and</span> <span class="keyword">contains</span> nonaggregated <span class="keyword">column</span> <span class="string">&#x27;atguigudb1.student_info.create_time&#x27;</span> which <span class="keyword">is</span> <span class="keyword">not</span> functionally dependent <span class="keyword">on</span> columns <span class="keyword">in</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> clause; this <span class="keyword">is</span> incompatible <span class="keyword">with</span> sql_mode<span class="operator">=</span>only_full_group_by</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> @<span class="variable">@sql</span>_mode <span class="operator">=</span> <span class="string">&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id  <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span>  LIMIT <span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> num <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">185311</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">194105</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">57189</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">120982</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">115944</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">83879</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">80899</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">121940</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2609</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">86746</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">75700</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">62838</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">60147</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">178808</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">8367</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">40069</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">161512</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">176475</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61686</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138391</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">12051</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">100177</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108925</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5180</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">64963</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96617</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61896</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">154278</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">80369</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">189522</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">33245</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">20877</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96084</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">89014</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">67721</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">159112</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">54222</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">137216</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">20814</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61285</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">131566</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">111848</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">195892</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">115319</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">106890</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">179093</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">17098</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">53414</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">97157</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">55471</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">91383</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">188118</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">140146</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">155145</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">182409</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">131429</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">134374</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">84127</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">143793</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">15014</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">192683</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">51641</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">118084</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108209</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">65176</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">164327</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">109823</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">50172</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">34640</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">123597</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">22421</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138851</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">71689</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">54843</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">141395</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">23288</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96059</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">69489</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">169371</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">19972</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">128123</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">95080</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">87060</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">93237</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">82607</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">153381</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">25366</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">105312</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">97230</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">101136</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">113139</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2165</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">10691</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">165419</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">179134</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">154699</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138426</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108429</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108656</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">15774</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">2.78</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id  <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span>  LIMIT <span class="number">100</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_sid</span><br><span class="line">          key: idx_sid</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">997141</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>可以看出，SQL执行只使用了student_id字段的索引</strong></li>
</ul>
</li>
<li><p>添加联合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_sid_cre_time(student_id,create_time <span class="keyword">DESC</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次执行SQL查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">100</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id  <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span>  LIMIT <span class="number">100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> num <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">185311</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">194105</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">57189</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">120982</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">115944</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">83879</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">80899</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">121940</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2609</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">86746</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">75700</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">62838</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">60147</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">178808</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">8367</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">40069</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">161512</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">176475</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61686</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138391</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">12051</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">100177</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108925</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5180</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">64963</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96617</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61896</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">154278</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">80369</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">189522</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">33245</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">20877</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96084</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">89014</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">67721</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">159112</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">54222</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">137216</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">20814</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61285</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">131566</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">111848</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">195892</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">115319</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">106890</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">179093</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">17098</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">53414</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">97157</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">55471</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">91383</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">188118</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">140146</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">155145</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">182409</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">131429</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">134374</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">84127</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">143793</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">15014</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">192683</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">51641</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">118084</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108209</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">65176</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">164327</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">109823</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">50172</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">34640</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">123597</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">22421</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138851</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">71689</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">54843</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">141395</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">23288</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96059</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">69489</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">169371</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">19972</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">128123</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">95080</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">87060</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">93237</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">82607</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">153381</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">25366</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">105312</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">97230</span> <span class="operator">|</span>   <span class="number">2</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">101136</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">113139</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2165</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">10691</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">165419</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">179134</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">154699</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">138426</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108429</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108656</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">15774</span> <span class="operator">|</span>   <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.31</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析SQL执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> student_id, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> num <span class="keyword">FROM</span> student_info  <span class="keyword">GROUP</span> <span class="keyword">BY</span> student_id  <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span>  LIMIT <span class="number">100</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_sid,idx_sid_cre_time</span><br><span class="line">          key: idx_sid_cre_time</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">997141</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index; <span class="keyword">Using</span> temporary; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在进行联合索引创建时，应该和和SQL语句执行的顺序一致，此时联合索引的顺序效率是最高的</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>4.<strong>UPDATE、DELETE 的 WHERE 条件列</strong></p>
</blockquote>
<ul>
<li><p>当对某条数据进行UPDATE或者DELETE操作的时候，是否也需要对WHERE的条件列创建索引呢？</p>
</li>
<li><p>先看一下对数据进行UPDATE的情况：想要把name为462eed7ac6e791292a79对应的student_id修改为10002，当没有对name进行索引的时候，执行SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">UPDATE</span> student_info <span class="keyword">SET</span> student_id <span class="operator">=</span> <span class="number">10002</span>  <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">2.06</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以看出效率不高，但是如果对name字段创建了索引，然后执行类似的SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#添加索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_name(`name`);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">UPDATE</span> student_info <span class="keyword">SET</span> student_id <span class="operator">=</span> <span class="number">10002</span>  <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"><span class="keyword">Rows</span> matched: <span class="number">0</span>  Changed: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">UPDATE</span> student_info <span class="keyword">SET</span> student_id <span class="operator">=</span> <span class="number">10002</span>  <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">UPDATE</span></span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>效率有了大幅度提升</p>
</li>
</ul>
</li>
<li><p>如果对某条数据进行DELETE，效率如何？</p>
</li>
<li><p>比如想要删除name为462eed7ac6e791292a79的数据：</p>
<ul>
<li><p>name字段没有创建索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> student_info <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.51</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">delete</span> <span class="keyword">from</span> student_info <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">DELETE</span></span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">997141</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>name字段创建了索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">delete</span> <span class="keyword">from</span> student_info <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">delete</span> <span class="keyword">from</span> student_info <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">DELETE</span></span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>name创建了索引，效率大幅度提升了</p>
</li>
</ul>
</li>
<li><p>对数据按照某个条件进行查询后再进行 UPDATE 或 DELETE 的操作，如果对 WHERE 字段创建了索引，就能大幅提升效率。原理是<strong>因为我们需要先根据 WHERE 条件列检索出来这条记录</strong>，然后再对它进行更新或 删除。<strong>如果进行更新的时候，更新的字段是非索引字段，提升的效率会更明显，这是因为非索引字段更新不需要对索引进行维护</strong></p>
</li>
</ul>
<blockquote>
<p>5.<strong>DISTINCT 字段需要创建索引</strong></p>
</blockquote>
<ul>
<li><p>有时候我们需要对某个字段进行去重，使用 DISTINCT，那么对这个字段创建索引，也会提升查询效率</p>
</li>
<li><p>比如，想要查询课程表中不同的 student_id 都有哪些，如果没有对 student_id 创建索引，执行 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(student_id) <span class="keyword">FROM</span> `student_info`;</span><br><span class="line">... ...</span><br><span class="line"><span class="number">198129</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">2.11</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(student_id) <span class="keyword">FROM</span> `student_info`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_sid_cre_time</span><br><span class="line">          key: idx_sid_cre_time</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">197445</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">for</span> <span class="keyword">group</span><span class="operator">-</span><span class="keyword">by</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>运行结果（198129 条记录，运行时间 2.11s ）：</li>
</ul>
</li>
<li><p>如果对 student_id 创建索引，再执行 SQL 语句：</p>
</li>
</ul>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#给student_id字段添加索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_sid(student_id);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(student_id) <span class="keyword">FROM</span> `student_info`;</span><br><span class="line">... ...</span><br><span class="line"><span class="number">198129</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.53</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span>(student_id) <span class="keyword">FROM</span> `student_info`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student_info</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_sid_cre_time,idx_sid</span><br><span class="line">          key: idx_sid</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">197975</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">for</span> <span class="keyword">group</span><span class="operator">-</span><span class="keyword">by</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>运行结果（198129 条记录，运行时间 0.53s ）： </p>
</li>
<li><p>你能看到 SQL 查询效率有了提升，同时显示出来的 student_id 还是按照<strong>递增的顺序</strong>进行展示的。这是因 为索引会对数据按照某种顺序进行排序，所以在去重的时候也会快很多</p>
</li>
</ul>
<blockquote>
<p>6.<strong>多表 JOIN 连接操作时，创建索引注意事项</strong></p>
</blockquote>
<ul>
<li><p>首先， <strong>连接表的数量尽量不要超过 3 张</strong> ，因为每增加一张表就相当于增加了一次嵌套的循环，数量级增 长会非常快，严重影响查询的效率</p>
</li>
<li><p>其次， <strong>对 WHERE 条件创建索引</strong> ，因为 WHERE 才是对数据条件的过滤。如果在数据量非常大的情况下， 没有 WHERE 条件过滤是非常可怕的</p>
</li>
<li><p>最后， <strong>对用于连接的字段创建索引</strong> ，并且该字段在多张表中的<strong>类型必须一致</strong> 。比如 course_id 在 student_info 表和 course 表中都为 int(11) 类型，而不能一个为 int 另一个为 varchar 类型</p>
</li>
<li><p>举个例子，如果只对 student_id 创建索引，执行 SQL 语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> s.course_id, `name`, s.student_id, c.course_name  <span class="keyword">FROM</span> student_info s <span class="keyword">JOIN</span> course c <span class="keyword">ON</span> s.course_id <span class="operator">=</span> c.course_id <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.24</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> s.course_id, `name`, s.student_id, c.course_name  <span class="keyword">FROM</span> student_info s <span class="keyword">JOIN</span> course c <span class="keyword">ON</span> s.course_id <span class="operator">=</span> c.course_id <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: c</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">100</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">997141</span></span><br><span class="line">     filtered: <span class="number">1.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再对name也创建索引，执行SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#添加索引</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> student_info</span><br><span class="line"><span class="keyword">ADD</span> INDEX idx_name(`name`);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> s.course_id, `name`, s.student_id, c.course_name  <span class="keyword">FROM</span> student_info s <span class="keyword">JOIN</span> course c <span class="keyword">ON</span> s.course_id <span class="operator">=</span> c.course_id <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e791292a79&#x27;</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> s.course_id, `name`, s.student_id, c.course_name  <span class="keyword">FROM</span> student_info s <span class="keyword">JOIN</span> course c <span class="keyword">ON</span> s.course_id <span class="operator">=</span> c.course_id <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;462eed7ac6e7791292a79&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: c</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">100</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>7.使用列的类型小的创建索引</strong></p>
</blockquote>
<ul>
<li><strong>类型大小</strong>是指该类型表示的数据范围的大小</li>
<li>以整数类型为例建立索引：在表示的整数范围允许的情况下，尽量让索引列使用较小的类型，比如，能使用<strong>int</strong>就不要使用<strong>bigint</strong>，能使用<strong>mediumint</strong>就不要使用<strong>int</strong>。这是因为：<ul>
<li>数据类型越小，在查询时进行的比较操作越快</li>
<li>数据类型越小，索引占用的存储空间就越少，在一个数据页内就可以<strong>放下更多的记录</strong>，从而减少<strong>磁盘I&#x2F;O</strong>带来的性能损耗，也就意味着可以把更多的数据页缓存到内存中，从而加快读写效率</li>
</ul>
</li>
<li>这个建议对于表的<strong>主键来说更加适用</strong>，因为不仅是聚簇索引中会存储主键值，其它所有的二级索引的节点处都会存储一份记录的主键值，如果主键使用更小的数据类型，也就意味着节省更多的存储空间和更高效的I&#x2F;O</li>
</ul>
<blockquote>
<p><strong>8.使用字符串前缀创建索引</strong></p>
</blockquote>
<ul>
<li><p>假设字符串很长，那存储一个字符串就需要占用很大的存储空间。在我们需要这个字符串列建立索引时，那就意味着在对应的B+树中有这么两个问题：</p>
<ul>
<li>B+树索引中的记录需要把该列的完整字符串存储起来，更费事。而且字符串越长，<strong>在索引中占用的存储空间越大</strong></li>
<li>如果B+树索引中索引列存储的字符串很长，那在做字符串<strong>比较时会占用更多的时间</strong></li>
</ul>
</li>
<li><p>可以通过截取字段的前面一部分内容建立索引，这个就叫<strong>前缀索引</strong>。这样在查找记录时虽然不能精确的定位到记录的位置，但是能定位到相应前缀所在的位置，然后根据前缀相同的记录的主键值<strong>回表</strong>查询完整的字符串值。即<strong>节约空间</strong>，又<strong>减少了字符串的比较时间</strong>，还大体能解决排序的问题</p>
</li>
<li><p>例如，TEXT和BLOG类型的字段，进行全文检索会很浪费时间，如果只检索字段前面的若干字符，这样可以提高检索速度</p>
</li>
<li><p>创建一张商户表，因为地址字段比较长，在地址字段上建立前缀索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> shop(address <span class="type">varchar</span>(<span class="number">120</span>) <span class="keyword">not</span> <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> shop <span class="keyword">add</span> index(address(<span class="number">12</span>));</span><br></pre></td></tr></table></figure>
</li>
<li><p>问题是，截取多少呢？截取得多了，达不到节省索引存储空间的目的；截取得少了，重复内容太多，字 段的散列度(选择性)会降低。<strong>怎么计算不同的长度的选择性呢？</strong> </p>
</li>
<li><p>先看一下字段在全部数据中的选择度：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> address) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> shop;</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过不同长度去计算，与全表的选择性对比：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(列名, 索引长度))<span class="operator">/</span><span class="built_in">count</span>(<span class="operator">*</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(address,<span class="number">10</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> sub10, <span class="comment">-- 截取前10个字符的选择度</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(address,<span class="number">15</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> sub11, <span class="comment">-- 截取前15个字符的选择度</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(address,<span class="number">20</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> sub12, <span class="comment">-- 截取前20个字符的选择度</span></span><br><span class="line"><span class="built_in">count</span>(<span class="keyword">distinct</span> <span class="keyword">left</span>(address,<span class="number">25</span>)) <span class="operator">/</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">as</span> sub13 <span class="comment">-- 截取前25个字符的选择度</span></span><br><span class="line"><span class="keyword">from</span> shop;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>引申另一个问题：索引列前缀对排序的影响：</strong></p>
<ul>
<li><p>如果使用了索引前缀，比方说前边只把address列的<strong>前12个字符</strong>放到了二级索引中，下边这个查询可能就有点尴尬了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> shop <span class="keyword">order</span> <span class="keyword">by</span> address limit <span class="number">12</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为二级索引中不包含完整的address列信息，所以无法对前12个字符相同，后边的字符不同的记录进行排序，也就是使用索引列前缀的方式<strong>无法支持使用索引排序</strong>，只能使用文件排序</p>
</li>
</ul>
</li>
<li><p><strong>拓展：Alibaba《Java开发手册》</strong> </p>
<ul>
<li>【 <strong>强制</strong> 】在 varchar 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本 区分度决定索引长度</li>
<li>说明：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，区分度会<strong>高达 90% 以上</strong> ，可以使用 count(distinct left(列名, 索引长度))&#x2F;count(*)的区分度来确定</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>9.区分度高(散列性高)的列适合作为索引</strong></p>
</blockquote>
<blockquote>
<p><strong>10.使用最频繁的列放到联合索引的左侧</strong></p>
</blockquote>
<ul>
<li>这样也可以较少的建立一些索引。同时，由于”最左前缀原则”，可以增加联合索引的使用率</li>
</ul>
<blockquote>
<p><strong>11.在多个字段都要创建索引的情况下，联合索引优于单值索引</strong></p>
</blockquote>
<h4 id="7-3-3-3-限制索引的数目"><a href="#7-3-3-3-限制索引的数目" class="headerlink" title="7.3.3.3 限制索引的数目"></a>7.3.3.3 限制索引的数目</h4><ul>
<li>在实际工作中需要平衡索引的数量，索引的数目不是越多越好，需要限制每张表上的索引数量，建议单张表索引数量<strong>不超过6个</strong>。原因：<ul>
<li>① 每个索引都会占用<strong>磁盘空间</strong>，索引越多，需要的磁盘空间就越大</li>
<li>② 索引会影响<strong>insert</strong>、<strong>delete</strong>、<strong>update</strong>等语句的性能，因为表中的数据更改的同时，索引也会进行调整和更新，会造成负担</li>
<li>③ 优化器在选择如何优化查询时，会根据统一信息，对每一个可以用到的<strong>索引来进行评估</strong>，以生出一个最好的执行计划，如果同时有很多个索引都可以用于查询，会增加MySQL优化器生成执行计划的时间，降低查询性能</li>
</ul>
</li>
</ul>
<h4 id="7-3-3-4-不适合创建索引的情况"><a href="#7-3-3-4-不适合创建索引的情况" class="headerlink" title="7.3.3.4 不适合创建索引的情况"></a>7.3.3.4 不适合创建索引的情况</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ① 在<span class="keyword">where</span>中使用不到的字段，不要设置索引</span><br><span class="line"></span><br><span class="line"># ② 数据量小的表最好不要使用索引</span><br><span class="line"></span><br><span class="line"># ③ 有大量重复数据的列上不要建立索引</span><br><span class="line">#结论：当数据重复度大，比如`高于 <span class="number">10</span><span class="operator">%</span> `的时候，也不需要对这个字段使用索引。</span><br><span class="line"></span><br><span class="line"># ④ 避免对经常更新的表创建过多的索引</span><br><span class="line"></span><br><span class="line"># ⑤ 不建议用无序的值作为索引</span><br><span class="line"></span><br><span class="line"># ⑥ 删除不再使用或者很少使用的索引</span><br><span class="line"></span><br><span class="line"># ⑦ 不要定义冗余或重复的索引</span><br></pre></td></tr></table></figure>

<h2 id="7-4-性能分析工具和使用"><a href="#7-4-性能分析工具和使用" class="headerlink" title="7.4 性能分析工具和使用"></a>7.4 性能分析工具和使用</h2><ul>
<li>在数据库调优中，目标就是<strong>响应时间更快，吞吐量更大</strong></li>
<li>利用宏观的监控工具和微观的日志分析可以帮助快速找到调优的思路和方式</li>
</ul>
<h3 id="7-4-1-数据库服务器的优化步骤"><a href="#7-4-1-数据库服务器的优化步骤" class="headerlink" title="7.4.1 数据库服务器的优化步骤"></a>7.4.1 数据库服务器的优化步骤</h3><ul>
<li><p>当我们遇到数据库调优问题的时候，该如何思考呢？这里把思考的流程整理成下面这张图</p>
</li>
<li><p>整个流程划分成了 <strong>观察</strong>（Show status） 和 <strong>行动</strong>（Action） 两个部分。字母 S 的部分代表观察（会使 用相应的分析工具），字母 A 代表的部分是行动（对应分析可以采取的行动）</p>
<p><img src="image-20221202134307759.png" alt="MySQL之性能优化/image-20221202134307759"></p>
</li>
<li><p>小结：</p>
<p><img src="image-20221202134549176.png" alt="MySQL之性能优化/image-20221202134549176"></p>
</li>
</ul>
<h3 id="7-4-2-查看系统性能参数"><a href="#7-4-2-查看系统性能参数" class="headerlink" title="7.4.2 查看系统性能参数"></a>7.4.2 查看系统性能参数</h3><ul>
<li><p>在MySQL中，可以使用 <code>SHOW STATUS</code> 语句查询一些MySQL数据库服务器的<strong>性能参数</strong>、<strong>执行频率</strong></p>
</li>
<li><p>SHOW STATUS语句语法如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> [<span class="keyword">GLOBAL</span><span class="operator">|</span>SESSION] STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;参数&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一些常用的性能参数如下：</p>
<ul>
<li><p>Connections：连接MySQL服务器的次数</p>
</li>
<li><p>Uptime：MySQL服务器的上线时间</p>
</li>
<li><p>Slow_queries：慢查询的次数</p>
</li>
<li><p>Innodb_rows_read：Select查询返回的行数</p>
</li>
<li><p>Innodb_rows_inserted：执行INSERT操作插入的行数</p>
</li>
<li><p>Innodb_rows_updated：执行UPDATE操作更新的行数</p>
</li>
<li><p>Innodb_rows_deleted：执行DELETE操作删除的行数</p>
</li>
<li><p>Com_select：查询操作的次数</p>
</li>
<li><p>Com_insert：插入操作的次数。对于批量插入的 INSERT 操作，只累加一次</p>
</li>
<li><p>Com_update：更新操作的次数</p>
</li>
<li><p>Com_delete：删除操作的次数</p>
</li>
<li><p>若查询MySQL服务器的连接次数，则可以执行如下语句:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;Connections&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Connections   <span class="operator">|</span> <span class="number">7</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>若查询服务器工作时间，则可以执行如下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;uptime&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Uptime        <span class="operator">|</span> <span class="number">15168</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>若查询MySQL服务器的慢查询次数，则可以执行如下语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;slow_queries&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Slow_queries  <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>慢查询次数参数可以结合慢查询日志找出慢查询语句，然后针对慢查询语句进行表结构优化或者查询语句优化。再比如，如下的指令可以查看相关的指令情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;Innodb_rows_%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name        <span class="operator">|</span> <span class="keyword">Value</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_rows_deleted  <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_rows_inserted <span class="operator">|</span> <span class="number">70</span>      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_rows_read     <span class="operator">|</span> <span class="number">4396538</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_rows_updated  <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+---------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="7-4-3-统计SQL的查询成本：last-query-cos"><a href="#7-4-3-统计SQL的查询成本：last-query-cos" class="headerlink" title="7.4.3 统计SQL的查询成本：last_query_cos"></a>7.4.3 统计SQL的查询成本：last_query_cos</h3><ul>
<li><p>一条SQL查询语句在执行前需要确定查询执行计划，如果存在多种执行计划的话，MySQL会计算每个执行计划所需要的成本，从中选择<strong>成本最小</strong>的一个作为最终执行的执行计划</p>
</li>
<li><p>如果想要查看某条SQL语句的查询成本，可以在执行完这条SQL语句之后，通过查看当前会话中的<code>last_query_cost</code>变量值来得到当前查询的成本。它通常也是<strong>评价一个查询的执行效率</strong>的一个常用指标。这个查询成本对应的是<strong>SQL语句所需要读取的页的数量</strong></p>
</li>
<li><p>我们依然使用第8章的student_info表为例:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student_info` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `student_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `name` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `course_id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `class_id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `create_time` DATETIME <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想要查询 id&#x3D;900001 的记录，然后看下查询成本，我们可以直接在聚簇索引上进行查找：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, class_id, NAME, create_time <span class="keyword">FROM</span> student_info <span class="keyword">where</span> id<span class="operator">=</span><span class="string">&#x27;900001&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> class_id <span class="operator">|</span> NAME   <span class="operator">|</span> create_time         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">143886</span> <span class="operator">|</span>    <span class="number">10188</span> <span class="operator">|</span> OMvOHV <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.05</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再看下查询优化器的成本，实际上我们<strong>只需要检索一个页</strong>即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;last_query_cost&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Last_query_cost <span class="operator">|</span> <span class="number">1.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果要查询 id 在 900001 到 9000100 之间的学生记录呢？</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> student_id, class_id, NAME, create_time <span class="keyword">FROM</span> student_info <span class="keyword">WHERE</span> id <span class="keyword">BETWEEN</span> <span class="number">900001</span> <span class="keyword">AND</span> <span class="number">900100</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span> student_id <span class="operator">|</span> class_id <span class="operator">|</span> NAME   <span class="operator">|</span> create_time         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">143886</span> <span class="operator">|</span>    <span class="number">10188</span> <span class="operator">|</span> OMvOHV <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">137090</span> <span class="operator">|</span>    <span class="number">10106</span> <span class="operator">|</span> RfZJwg <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">163914</span> <span class="operator">|</span>    <span class="number">10029</span> <span class="operator">|</span> ISpUFs <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61624</span> <span class="operator">|</span>    <span class="number">10125</span> <span class="operator">|</span> Iwgqns <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">87944</span> <span class="operator">|</span>    <span class="number">10130</span> <span class="operator">|</span> mVRuAu <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">113234</span> <span class="operator">|</span>    <span class="number">10149</span> <span class="operator">|</span> FrSoOg <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">54709</span> <span class="operator">|</span>    <span class="number">10159</span> <span class="operator">|</span> ZhLkRE <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">167876</span> <span class="operator">|</span>    <span class="number">10040</span> <span class="operator">|</span> ExzeXy <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">78020</span> <span class="operator">|</span>    <span class="number">10038</span> <span class="operator">|</span> tMAuwY <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">137734</span> <span class="operator">|</span>    <span class="number">10175</span> <span class="operator">|</span> RdThfe <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">171839</span> <span class="operator">|</span>    <span class="number">10045</span> <span class="operator">|</span> FzEyEB <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">130267</span> <span class="operator">|</span>    <span class="number">10173</span> <span class="operator">|</span> IsPTcC <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">43731</span> <span class="operator">|</span>    <span class="number">10128</span> <span class="operator">|</span> ikyMoj <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">146679</span> <span class="operator">|</span>    <span class="number">10003</span> <span class="operator">|</span> FTBZve <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">52236</span> <span class="operator">|</span>    <span class="number">10109</span> <span class="operator">|</span> ICMbZP <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">8516</span> <span class="operator">|</span>    <span class="number">10168</span> <span class="operator">|</span> KuRbFW <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">191888</span> <span class="operator">|</span>    <span class="number">10102</span> <span class="operator">|</span> oyExBp <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">121231</span> <span class="operator">|</span>    <span class="number">10088</span> <span class="operator">|</span> LNIbiK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">181015</span> <span class="operator">|</span>    <span class="number">10199</span> <span class="operator">|</span> CcDKRb <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">43715</span> <span class="operator">|</span>    <span class="number">10049</span> <span class="operator">|</span> shJJCL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">104975</span> <span class="operator">|</span>    <span class="number">10138</span> <span class="operator">|</span> CkqagE <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">132394</span> <span class="operator">|</span>    <span class="number">10014</span> <span class="operator">|</span> exYBMd <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">183028</span> <span class="operator">|</span>    <span class="number">10092</span> <span class="operator">|</span> jkxHRm <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">76189</span> <span class="operator">|</span>    <span class="number">10183</span> <span class="operator">|</span> iJUvvR <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">37314</span> <span class="operator">|</span>    <span class="number">10195</span> <span class="operator">|</span> aBEsaX <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">60686</span> <span class="operator">|</span>    <span class="number">10183</span> <span class="operator">|</span> OZDVQs <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">155098</span> <span class="operator">|</span>    <span class="number">10110</span> <span class="operator">|</span> mSChgl <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">178159</span> <span class="operator">|</span>    <span class="number">10159</span> <span class="operator">|</span> eLtKsK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">168501</span> <span class="operator">|</span>    <span class="number">10051</span> <span class="operator">|</span> xKkTOp <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">47603</span> <span class="operator">|</span>    <span class="number">10144</span> <span class="operator">|</span> bwdaSl <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">104263</span> <span class="operator">|</span>    <span class="number">10051</span> <span class="operator">|</span> RJFgSS <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">153987</span> <span class="operator">|</span>    <span class="number">10196</span> <span class="operator">|</span> VoIyrp <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">76817</span> <span class="operator">|</span>    <span class="number">10068</span> <span class="operator">|</span> UqSutK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">96615</span> <span class="operator">|</span>    <span class="number">10190</span> <span class="operator">|</span> ExycSe <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">43844</span> <span class="operator">|</span>    <span class="number">10035</span> <span class="operator">|</span> DihlIK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">115473</span> <span class="operator">|</span>    <span class="number">10037</span> <span class="operator">|</span> qUxHPg <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">46360</span> <span class="operator">|</span>    <span class="number">10111</span> <span class="operator">|</span> zNpllz <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">97259</span> <span class="operator">|</span>    <span class="number">10025</span> <span class="operator">|</span> cQVfPJ <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">82738</span> <span class="operator">|</span>    <span class="number">10174</span> <span class="operator">|</span> xcTlAR <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">194369</span> <span class="operator">|</span>    <span class="number">10158</span> <span class="operator">|</span> zCoKKv <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">31048</span> <span class="operator">|</span>    <span class="number">10077</span> <span class="operator">|</span> JIyqiV <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">8166</span> <span class="operator">|</span>    <span class="number">10085</span> <span class="operator">|</span> WAOsvb <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">139299</span> <span class="operator">|</span>    <span class="number">10098</span> <span class="operator">|</span> aYQjxL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">22286</span> <span class="operator">|</span>    <span class="number">10191</span> <span class="operator">|</span> KhFEic <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">61046</span> <span class="operator">|</span>    <span class="number">10146</span> <span class="operator">|</span> rOUfSY <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">67073</span> <span class="operator">|</span>    <span class="number">10085</span> <span class="operator">|</span> uZLHcr <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">124632</span> <span class="operator">|</span>    <span class="number">10129</span> <span class="operator">|</span> jdMBwD <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">123869</span> <span class="operator">|</span>    <span class="number">10165</span> <span class="operator">|</span> JoyDtk <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">144490</span> <span class="operator">|</span>    <span class="number">10177</span> <span class="operator">|</span> XJlmCa <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">105521</span> <span class="operator">|</span>    <span class="number">10034</span> <span class="operator">|</span> gaLDJz <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">91034</span> <span class="operator">|</span>    <span class="number">10042</span> <span class="operator">|</span> HRoRuv <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">75884</span> <span class="operator">|</span>    <span class="number">10088</span> <span class="operator">|</span> DMYIuW <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">132492</span> <span class="operator">|</span>    <span class="number">10171</span> <span class="operator">|</span> NOIYUA <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">53051</span> <span class="operator">|</span>    <span class="number">10154</span> <span class="operator">|</span> brJfFO <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">161720</span> <span class="operator">|</span>    <span class="number">10000</span> <span class="operator">|</span> bLBAXm <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">83154</span> <span class="operator">|</span>    <span class="number">10175</span> <span class="operator">|</span> xcTjqa <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">55358</span> <span class="operator">|</span>    <span class="number">10104</span> <span class="operator">|</span> QoWPkE <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">164793</span> <span class="operator">|</span>    <span class="number">10195</span> <span class="operator">|</span> kCgWsZ <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">126209</span> <span class="operator">|</span>    <span class="number">10092</span> <span class="operator">|</span> OYDUQs <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">95039</span> <span class="operator">|</span>    <span class="number">10142</span> <span class="operator">|</span> mPpdvT <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">3349</span> <span class="operator">|</span>    <span class="number">10017</span> <span class="operator">|</span> QbKxfl <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">142444</span> <span class="operator">|</span>    <span class="number">10041</span> <span class="operator">|</span> WCXgLo <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">48440</span> <span class="operator">|</span>    <span class="number">10080</span> <span class="operator">|</span> aqEZgL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">79022</span> <span class="operator">|</span>    <span class="number">10159</span> <span class="operator">|</span> FQnRxL <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">90246</span> <span class="operator">|</span>    <span class="number">10053</span> <span class="operator">|</span> yXviJJ <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">43374</span> <span class="operator">|</span>    <span class="number">10033</span> <span class="operator">|</span> EpLJos <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">166085</span> <span class="operator">|</span>    <span class="number">10150</span> <span class="operator">|</span> VdFPix <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">137719</span> <span class="operator">|</span>    <span class="number">10124</span> <span class="operator">|</span> ETHFdz <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">159113</span> <span class="operator">|</span>    <span class="number">10186</span> <span class="operator">|</span> kEsaab <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">114946</span> <span class="operator">|</span>    <span class="number">10074</span> <span class="operator">|</span> NfmSFx <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">166074</span> <span class="operator">|</span>    <span class="number">10166</span> <span class="operator">|</span> IRkzQJ <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2451</span> <span class="operator">|</span>    <span class="number">10125</span> <span class="operator">|</span> jVXeCz <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">107551</span> <span class="operator">|</span>    <span class="number">10119</span> <span class="operator">|</span> UTKSlB <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">5349</span> <span class="operator">|</span>    <span class="number">10035</span> <span class="operator">|</span> FYZblb <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">4001</span> <span class="operator">|</span>    <span class="number">10011</span> <span class="operator">|</span> WDdFRu <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">774</span> <span class="operator">|</span>    <span class="number">10014</span> <span class="operator">|</span> PaJeDE <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">111192</span> <span class="operator">|</span>    <span class="number">10045</span> <span class="operator">|</span> fRRLft <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">143311</span> <span class="operator">|</span>    <span class="number">10137</span> <span class="operator">|</span> BBcJah <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">40909</span> <span class="operator">|</span>    <span class="number">10011</span> <span class="operator">|</span> RFBOqm <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">95843</span> <span class="operator">|</span>    <span class="number">10133</span> <span class="operator">|</span> vELTlz <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">21139</span> <span class="operator">|</span>    <span class="number">10053</span> <span class="operator">|</span> LpsRjr <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">167369</span> <span class="operator">|</span>    <span class="number">10129</span> <span class="operator">|</span> nNcZMP <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">158357</span> <span class="operator">|</span>    <span class="number">10037</span> <span class="operator">|</span> uHZbiK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">59531</span> <span class="operator">|</span>    <span class="number">10016</span> <span class="operator">|</span> mrVElq <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">168087</span> <span class="operator">|</span>    <span class="number">10146</span> <span class="operator">|</span> aBEulV <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">116596</span> <span class="operator">|</span>    <span class="number">10175</span> <span class="operator">|</span> pMOKiK <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">134184</span> <span class="operator">|</span>    <span class="number">10188</span> <span class="operator">|</span> CKSkyJ <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">191976</span> <span class="operator">|</span>    <span class="number">10045</span> <span class="operator">|</span> gKiLfu <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>       <span class="number">2430</span> <span class="operator">|</span>    <span class="number">10197</span> <span class="operator">|</span> fBrevP <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">187089</span> <span class="operator">|</span>    <span class="number">10043</span> <span class="operator">|</span> bqCMek <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">173195</span> <span class="operator">|</span>    <span class="number">10047</span> <span class="operator">|</span> JAKXHv <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">98366</span> <span class="operator">|</span>    <span class="number">10028</span> <span class="operator">|</span> bKwdZP <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">76796</span> <span class="operator">|</span>    <span class="number">10138</span> <span class="operator">|</span> SgcSgc <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">51530</span> <span class="operator">|</span>    <span class="number">10033</span> <span class="operator">|</span> OixQJX <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">82046</span> <span class="operator">|</span>    <span class="number">10142</span> <span class="operator">|</span> WulTLa <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">71349</span> <span class="operator">|</span>    <span class="number">10034</span> <span class="operator">|</span> nnzLen <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">19395</span> <span class="operator">|</span>    <span class="number">10089</span> <span class="operator">|</span> hxQMlV <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">108167</span> <span class="operator">|</span>    <span class="number">10126</span> <span class="operator">|</span> QwMvSa <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">71421</span> <span class="operator">|</span>    <span class="number">10071</span> <span class="operator">|</span> LAvApa <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">70008</span> <span class="operator">|</span>    <span class="number">10107</span> <span class="operator">|</span> hITvvR <span class="operator">|</span> <span class="number">2022</span><span class="number">-12</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">39</span>:<span class="number">13</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+----------+--------+---------------------+</span></span><br><span class="line"><span class="number">100</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再看下查询优化器的成本，这时我们大概需要进行 20 个页的查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;last_query_cost&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Last_query_cost <span class="operator">|</span> <span class="number">41.136411</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>能看到页的数量是刚才的 41 倍，<strong>但是查询的效率并没有明显的变化</strong>，实际上这两个 SQL 查询的时间基本上一样，就是因为采用了顺序读取的方式将页面一次性加载到缓冲池中，然后再进行查找。虽然<strong>页数量（last_query_cost）增加了不少</strong> ，但是通过缓冲池的机制，并<strong>没有增加多少查询时间</strong> </p>
</li>
<li><p><strong>使用场景</strong>：它对于比较开销是非常有用的，特别是有好几种查询方式可选的时候：</p>
<ul>
<li>SQL查询是一个动态的过程，从页加载的角度来看，可以得到以下两点结论:<ul>
<li>1.<strong>位置决定效率</strong>。如果页就在<strong>数据库缓冲池中，那么效率是最高的</strong>，否则还需要从内存或者磁盘中进行读取，当然针对单个页的读取来说，如果页存在于<strong>内存</strong>中，会比在<strong>磁盘</strong>中读取效率高很多</li>
<li>2.<strong>批量决定效率</strong>。如果从磁盘中对单一页进行<strong>随机读，那么效率是很低的</strong>（差不多10ms)，而采用<strong>顺序读取的方式，批主对页进行读取，平均一页的读取效率就会提升很多</strong>，甚至要快于单个页面在内存中的随机读取</li>
</ul>
</li>
<li>所以说，遇到I&#x2F;O并不用担心，方法找对了，效率还是很高的。首先要考虑<strong>数据存放的位置</strong>，如果是经常使用的数据就要尽量放到<strong>缓冲池</strong>中，其次可以充分利用磁盘的吞吐能力，一次性批量读取数据，这样单个页的读取效率也就得到了提升</li>
</ul>
</li>
</ul>
<h3 id="7-4-4-定位执行慢的-SQL：慢查询日志"><a href="#7-4-4-定位执行慢的-SQL：慢查询日志" class="headerlink" title="7.4.4 定位执行慢的 SQL：慢查询日志"></a>7.4.4 定位执行慢的 SQL：慢查询日志</h3><ul>
<li><p>MySQL的慢查询日志，用来记录在MySQL中<strong>响应时间超过阈值</strong>的语句，具体指运行时间超过<code>long_query_time</code>值的SQL，则会被记录到慢查询日志中。<code>long_query_time</code>的默认值为<strong>10</strong>，意思是运行10秒以上(不含10秒)的语句，认为是超出了最大忍耐时间值</p>
</li>
<li><p>它的主要作用是，帮助我们发现那些执行时间特别长的SQL查询，并且有针对性地进行优化，从而提高系统的整体效率。当数据库服务器发生阻塞、运行变慢的时候，检查一下慢查询日志，找到那些慢查询，对解决问题很有帮助。比如一条sql执行超过5秒钟，就算慢SQL，希望能收集超过5秒的sql，结合explain进行全面分析</p>
</li>
<li><p>默认情况下，MySQL数据库<strong>没有开启慢查询日志</strong>，需要手动来设置这个参数。<strong>如果不是调优需要的话，一般不建议启动该参数</strong>，因为开启慢查询日志会或多或少带来一定的性能影响</p>
</li>
<li><p><strong>慢查询日志支持将日志记录写入文件</strong></p>
</li>
</ul>
<h4 id="7-4-4-1-开启慢查询日志参数"><a href="#7-4-4-1-开启慢查询日志参数" class="headerlink" title="7.4.4.1 开启慢查询日志参数"></a>7.4.4.1 开启慢查询日志参数</h4><blockquote>
<p><strong>1.开启slow_query_log</strong></p>
</blockquote>
<ul>
<li><p>在使用前，需要先看下慢查询是否已经开启，使用下面这条命令即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query_log&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name  <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="operator">|</span> slow_query_log <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>看到<code>slow_query_log=OFF</code>，可以把慢查询日志打开，<strong>注意设置变量值的时候需要使用global</strong>，否则会报错：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> slow_query_log<span class="operator">=</span><span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line">ERROR <span class="number">1229</span> (HY000): Variable <span class="string">&#x27;slow_query_log&#x27;</span> <span class="keyword">is</span> a <span class="keyword">GLOBAL</span> variable <span class="keyword">and</span> should be <span class="keyword">set</span> <span class="keyword">with</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> slow_query_log<span class="operator">=</span><span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看下慢查询日志是否开启，以及慢查询日志文件的位置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%slow_query_log%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name       <span class="operator">|</span> <span class="keyword">Value</span>                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> slow_query_log      <span class="operator">|</span> <span class="keyword">ON</span>                                <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_query_log_file <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------+-----------------------------------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这时<strong>慢查询分析已经开启</strong>，同时文件保存在<code>/var/lib/mysql/localhost-slow.log</code> 文件中</p>
</li>
</ul>
<blockquote>
<p><strong>2. 修改long_query_time阈值</strong></p>
</blockquote>
<ul>
<li><p>接下来看下慢查询的时间阈值设置，使用如下命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里如果想把时间缩短，比如设置为 1 秒，可以这样设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#测试发现：设置<span class="keyword">global</span>的方式对当前session的long_query_time失效。对新连接的客户端有效。所以可以一并执行下述语句</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> long_query_time <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">1.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> long_query_time<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">1.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">1.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>补充:配置文件中一并设置参，如下的方式相较于前面的命令行方式，可以看作是永久设置的方式<br>修改<code>my.cnf</code>文件，[mysqld]下增加或修改参数<code>long_query_time</code>、<code>slow_query_log</code> 和<code>slow_query_log_file</code>后，然后重启MySQL服务器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">slow_query_log<span class="operator">=</span><span class="keyword">ON</span>#开启慢查询日志的开关</span><br><span class="line">slow_query_log_file<span class="operator">=</span><span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log #慢查询日志的目录和文件名信息</span><br><span class="line">long_query_time<span class="operator">=</span><span class="number">3</span> #设置慢查询的阈值为<span class="number">3</span>秒。超出此设定值的<span class="keyword">SQL</span>即被记录到慢查询日志</span><br><span class="line">log_output<span class="operator">=</span>FTLE</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不指定存储路径，慢查询日志将默认存储到MySQL数据库的数据文件夹下。如果不指定文件名，默认文件名为<code>hostname-slow.log</code></li>
</ul>
</li>
</ul>
<h4 id="7-4-4-2-查看慢查询数目"><a href="#7-4-4-2-查看慢查询数目" class="headerlink" title="7.4.4.2 查看慢查询数目"></a>7.4.4.2 查看慢查询数目</h4><ul>
<li><p>查询当前系统中有多少条慢查询记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> STATUS <span class="keyword">LIKE</span> <span class="string">&#x27;%Slow_queries%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Slow_queries  <span class="operator">|</span> <span class="number">0</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-4-4-3-案例演示"><a href="#7-4-4-3-案例演示" class="headerlink" title="7.4.4.3 案例演示"></a>7.4.4.3 案例演示</h4><blockquote>
<p><strong>步骤1. 建表</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">    `id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `stuno` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">    `name` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `age` <span class="type">INT</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `classId` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>步骤2：设置参数log_bin_trust_function_creators</strong></p>
</blockquote>
<ul>
<li><p>创建函数，假如报错：This function has none of DETERMINISTIC…</p>
</li>
<li><p>命令开启：允许创建函数设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="number">1</span>; # 不加<span class="keyword">global</span>只是当前窗口有效。</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>步骤3：创建函数</strong></p>
</blockquote>
<ul>
<li><p>随机产生字符串：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string(n <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>) #该函数会返回一个字符串</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> chars_str <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span></span><br><span class="line"><span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> return_str <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">WHILE i <span class="operator">&lt;</span> n DO</span><br><span class="line"><span class="keyword">SET</span> return_str <span class="operator">=</span>CONCAT(return_str,<span class="built_in">SUBSTRING</span>(chars_str,<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>RAND()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">RETURN</span> return_str;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#测试</span><br><span class="line"><span class="keyword">SELECT</span> rand_string(<span class="number">10</span>);</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_num (from_num <span class="type">INT</span> ,to_num <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span>(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> <span class="built_in">FLOOR</span>(from_num <span class="operator">+</span>RAND()<span class="operator">*</span>(to_num <span class="operator">-</span> from_num<span class="operator">+</span><span class="number">1</span>)) ;</span><br><span class="line"><span class="keyword">RETURN</span> i;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#测试：</span><br><span class="line"><span class="keyword">SELECT</span> rand_num(<span class="number">10</span>,<span class="number">100</span>);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+------------------+</span></span><br><span class="line"><span class="comment">| rand_num(10,100) |</span></span><br><span class="line"><span class="comment">+------------------+</span></span><br><span class="line"><span class="comment">|               23 |</span></span><br><span class="line"><span class="comment">+------------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>步骤4：创建存储过程</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_stu1( <span class="keyword">START</span> <span class="type">INT</span> , max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>; #设置手动提交事务</span><br><span class="line">REPEAT #循环</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>; #赋值</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student (stuno, NAME ,age ,classId ) <span class="keyword">VALUES</span></span><br><span class="line">((<span class="keyword">START</span><span class="operator">+</span>i),rand_string(<span class="number">6</span>),rand_num(<span class="number">10</span>,<span class="number">100</span>),rand_num(<span class="number">10</span>,<span class="number">1000</span>));</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>; #提交事务</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>步骤5：调用存储过程</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#调用刚刚写好的函数, <span class="number">4000000</span>条记录,从<span class="number">100001</span>号开始</span><br><span class="line"><span class="keyword">CALL</span> insert_stu1(<span class="number">100001</span>,<span class="number">4000000</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.07</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="7-4-4-4-测试及分析"><a href="#7-4-4-4-测试及分析" class="headerlink" title="7.4.4.4 测试及分析"></a>7.4.4.4 测试及分析</h4><blockquote>
<p><strong>1. 测试</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> stuno <span class="operator">=</span> <span class="number">3453451</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> stuno   <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3353450</span> <span class="operator">|</span> <span class="number">3453451</span> <span class="operator">|</span> tJotZQ <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>     <span class="number">281</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.26</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;tJotZQ&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> stuno   <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1160153</span> <span class="operator">|</span> <span class="number">1260154</span> <span class="operator">|</span> tJotZQ <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>     <span class="number">309</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1374622</span> <span class="operator">|</span> <span class="number">1474623</span> <span class="operator">|</span> TjoTzQ <span class="operator">|</span>   <span class="number">66</span> <span class="operator">|</span>     <span class="number">665</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1826774</span> <span class="operator">|</span> <span class="number">1926775</span> <span class="operator">|</span> tjOtzq <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>     <span class="number">802</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1843682</span> <span class="operator">|</span> <span class="number">1943683</span> <span class="operator">|</span> TjoTzQ <span class="operator">|</span>   <span class="number">65</span> <span class="operator">|</span>     <span class="number">619</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3353450</span> <span class="operator">|</span> <span class="number">3453451</span> <span class="operator">|</span> tJotZQ <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>     <span class="number">281</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3466068</span> <span class="operator">|</span> <span class="number">3566069</span> <span class="operator">|</span> TjoTzQ <span class="operator">|</span>   <span class="number">68</span> <span class="operator">|</span>     <span class="number">783</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">3990581</span> <span class="operator">|</span> <span class="number">4090582</span> <span class="operator">|</span> TjoTzQ <span class="operator">|</span>   <span class="number">64</span> <span class="operator">|</span>     <span class="number">566</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.30</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>从上面的结果可以看出来，查询学生编号为“3453451”的学生信息花费时间为1.26 秒。查询学生姓名为“tJotZQ”的学生信息花费时间为1.30 秒。已经达到了秒的数量级，说明目前查询效率是比较低的，下面我们分析一下原因</li>
</ul>
<blockquote>
<p><strong>2. 分析</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;slow_queries&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Slow_queries  <span class="operator">|</span> <span class="number">3</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补充说明:</p>
<p>除了上述变量，控制慢查询日志的还有一个系统变量: min_examined_row_limit。这个变量的意思是，查询扫描过的最少记录数。这个变晕和查询执行时间，共同组成了判别一个查询是否是慢查询的条件。如果查询扫描过的记录数大于等于这个变量的值，并且查询执行时间超过long_query_time的值，那么，这个查询就被记录到慢查询日志中;反之，则不被记录到慢查询日志中。</p>
<p>mysql&gt; show variables like ‘min%’\G<br>*************************** 1. row ***************************<br>Variable_name: min_examined_row_limit<br>        Value: 0<br>1 row in set (0.00 sec)</p>
<p>这个值默认是0。与long_query_time&#x3D;10合在一起，表示只要查询的执行时间超过10秒钟，哪怕一个记录也没有扫描过，都要被记录到慢查询日志中。也可以根据需要，通过修“my.ini”文件，来修改查询时长，或者通过SET指令，用SQL语句修改“min_examined_row_limit”的值。</p>
</blockquote>
<h4 id="7-4-4-5-慢查询日志分析工具mysqldumslow"><a href="#7-4-4-5-慢查询日志分析工具mysqldumslow" class="headerlink" title="7.4.4.5 慢查询日志分析工具mysqldumslow"></a>7.4.4.5 慢查询日志分析工具mysqldumslow</h4><ul>
<li><p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具<code>mysqldumpslow</code></p>
</li>
<li><p>查看mysqldumpslow的帮助信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# mysqldumpslow <span class="comment">--help</span></span><br><span class="line">Usage: mysqldumpslow [ OPTS... ] [ LOGS... ]</span><br><span class="line"></span><br><span class="line">Parse <span class="keyword">and</span> summarize the MySQL slow query log. Options <span class="keyword">are</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">--verbose    verbose</span></span><br><span class="line">  <span class="comment">--debug      debug</span></span><br><span class="line">  <span class="comment">--help       write this text to standard output</span></span><br><span class="line"></span><br><span class="line">  <span class="operator">-</span>v           verbose</span><br><span class="line">  <span class="operator">-</span>d           debug</span><br><span class="line">  <span class="operator">-</span>s <span class="keyword">ORDER</span>     what <span class="keyword">to</span> sort <span class="keyword">by</span> (al, <span class="keyword">at</span>, ar, c, l, r, t), <span class="string">&#x27;at&#x27;</span> <span class="keyword">is</span> <span class="keyword">default</span></span><br><span class="line">                al: average lock <span class="type">time</span></span><br><span class="line">                ar: average <span class="keyword">rows</span> sent</span><br><span class="line">                <span class="keyword">at</span>: average query <span class="type">time</span></span><br><span class="line">                 c: count</span><br><span class="line">                 l: lock <span class="type">time</span></span><br><span class="line">                 r: <span class="keyword">rows</span> sent</span><br><span class="line">                 t: query <span class="type">time</span>  </span><br><span class="line">  <span class="operator">-</span>r           reverse the sort <span class="keyword">order</span> (largest <span class="keyword">last</span> instead <span class="keyword">of</span> <span class="keyword">first</span>)</span><br><span class="line">  <span class="operator">-</span>t NUM       just <span class="keyword">show</span> the top n queries</span><br><span class="line">  <span class="operator">-</span>a           don<span class="string">&#x27;t abstract all numbers to N and strings to &#x27;</span>S<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  -n NUM       abstract numbers with at least n digits within names</span></span><br><span class="line"><span class="string">  -g PATTERN   grep: only consider stmts that include this string</span></span><br><span class="line"><span class="string">  -h HOSTNAME  hostname of db server for *-slow.log filename (can be wildcard),</span></span><br><span class="line"><span class="string">               default is &#x27;</span><span class="operator">*</span><span class="string">&#x27;, i.e. match all</span></span><br><span class="line"><span class="string">  -i NAME      name of server instance (if using mysql.server startup script)</span></span><br><span class="line"><span class="string">  -l           don&#x27;</span>t subtract lock <span class="type">time</span> <span class="keyword">from</span> total <span class="type">time</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mysqldumpslow 命令的具体参数如下：</p>
<ul>
<li>-a: 不将数字抽象成N，字符串抽象成S</li>
<li>-s: 是表示按照何种方式排序：<ul>
<li>c: 访问次数</li>
<li>l: 锁定时间</li>
<li>r: 返回记录</li>
<li>t: 查询时间</li>
<li>al:平均锁定时间</li>
<li>ar:平均返回记录数</li>
<li>at:平均查询时间 （默认方式）</li>
<li>ac:平均查询次数</li>
</ul>
</li>
<li>-t :即为返回前面多少条的数据</li>
<li>-g: 后边搭配一个正则匹配模式，大小写不敏感的</li>
</ul>
</li>
<li><p>下面演示如何得到慢查询：</p>
<ul>
<li><p>首先找到慢查询文件在哪个目录下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# cd <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@localhost</span> mysql]# ll</span><br><span class="line">总用量 <span class="number">188468</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 17 14:14 atguigudb</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql      142 12月  3 18:07 atguigudb1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 12月  1 17:39 dbtest2</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      482 12月  3 15:13 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 79691776 12月  3 18:14 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月  3 18:14 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月  3 18:14 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 12月  3 18:08 ibtmp1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql     1300 12月  3 18:18 localhost-slow.log</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 10 22:06 mysql</span></span><br><span class="line">srwxrwxrwx. <span class="number">1</span> mysql mysql        <span class="number">0</span> <span class="number">12</span>月  <span class="number">3</span> <span class="number">15</span>:<span class="number">13</span> mysql.sock</span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------. 1 mysql mysql        5 12月  3 15:13 mysql.sock.lock</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 sys</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>举例：我们想要按照查询时间排序，查看前五条 SQL 语句，这样写即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> mysql]# mysqldumpslow <span class="operator">-</span>s t <span class="operator">-</span>t <span class="number">5</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line"></span><br><span class="line">Reading mysql slow query log <span class="keyword">from</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">317.42</span>s (<span class="number">317</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">0.0</span> (<span class="number">0</span>), root[root]@[<span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span>]</span><br><span class="line">  <span class="keyword">CALL</span> insert_stu1(N,N)</span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.31</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">7.0</span> (<span class="number">7</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;S&#x27;</span></span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.25</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">1.0</span> (<span class="number">1</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> stuno <span class="operator">=</span> N</span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.06</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">1.0</span> (<span class="number">1</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student</span><br><span class="line"></span><br><span class="line">Died <span class="keyword">at</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqldumpslow line <span class="number">161</span>, <span class="operator">&lt;&gt;</span> chunk <span class="number">4.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>不想替换S、N 用<code>-a</code> <strong>花费时间降序排列</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> mysql]# mysqldumpslow <span class="operator">-</span>a <span class="operator">-</span>s t <span class="operator">-</span>t <span class="number">5</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line"></span><br><span class="line">Reading mysql slow query log <span class="keyword">from</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">317.42</span>s (<span class="number">317</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">0.0</span> (<span class="number">0</span>), root[root]@[<span class="number">192.168</span><span class="number">.1</span><span class="number">.180</span>]</span><br><span class="line">  <span class="keyword">CALL</span> insert_stu1(<span class="number">100001</span>,<span class="number">4000000</span>)</span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.31</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">7.0</span> (<span class="number">7</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;tJotZQ&#x27;</span></span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.25</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">1.0</span> (<span class="number">1</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> stuno <span class="operator">=</span> <span class="number">3453451</span></span><br><span class="line"></span><br><span class="line">Count: <span class="number">1</span>  <span class="type">Time</span><span class="operator">=</span><span class="number">1.06</span>s (<span class="number">1</span>s)  Lock<span class="operator">=</span><span class="number">0.00</span>s (<span class="number">0</span>s)  <span class="keyword">Rows</span><span class="operator">=</span><span class="number">1.0</span> (<span class="number">1</span>), root[root]<span class="variable">@localhost</span></span><br><span class="line">  <span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student</span><br><span class="line"></span><br><span class="line">Died <span class="keyword">at</span> <span class="operator">/</span>usr<span class="operator">/</span>bin<span class="operator">/</span>mysqldumpslow line <span class="number">161</span>, <span class="operator">&lt;&gt;</span> chunk <span class="number">4.</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>工作常用参考：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#得到返回记录集最多的<span class="number">10</span>个<span class="keyword">SQL</span></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s r <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">#得到访问次数最多的<span class="number">10</span>个<span class="keyword">SQL</span></span><br><span class="line">mysqldumpslow <span class="operator">-</span>s c <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">#得到按照时间排序的前<span class="number">10</span>条里面含有左连接的查询语句</span><br><span class="line">mysqldumpslow <span class="operator">-</span>s t <span class="operator">-</span>t <span class="number">10</span> <span class="operator">-</span>g &quot;left join&quot; <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">#另外建议在使用这些命令时结合 <span class="operator">|</span> 和more 使用 ，否则有可能出现爆屏情况</span><br><span class="line">mysqldumpslow <span class="operator">-</span>s r <span class="operator">-</span>t <span class="number">10</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log <span class="operator">|</span> more</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-4-4-6-关闭慢查询日志"><a href="#7-4-4-6-关闭慢查询日志" class="headerlink" title="7.4.4.6 关闭慢查询日志"></a>7.4.4.6 关闭慢查询日志</h4><ul>
<li><p>MySQL服务器停止慢查询日志功能有两种方法：</p>
<ul>
<li><p><strong>方式1：永久性方式</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">slow_query_log</span>=<span class="string">OFF</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>或者，把slow_query_log一项注释掉或删除：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#slow_query_log =OFF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>重启MySQL服务，执行如下语句查询慢日志功能：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> ‘<span class="operator">%</span>slow<span class="operator">%</span>’; #查询慢查询日志所在目录</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> ‘<span class="operator">%</span>long_query_time<span class="operator">%</span>’; #查询超时时长</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到,MySQL系统中的慢查询日志是关闭的</p>
</li>
</ul>
</li>
<li><p><strong>方式2：临时性方式</strong></p>
<ul>
<li><p>使用SET语句来设置</p>
</li>
<li><p>1.停止MySQL慢查询日志功能，具体SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log<span class="operator">=</span>off;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.08</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%slow%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span>                             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------------------+</span></span><br><span class="line"><span class="operator">|</span> log_slow_admin_statements <span class="operator">|</span> OFF                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> log_slow_slave_statements <span class="operator">|</span> OFF                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_launch_time          <span class="operator">|</span> <span class="number">2</span>                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_query_log            <span class="operator">|</span> OFF                               <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> slow_query_log_file       <span class="operator">|</span> <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-----------------------------------+</span></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.14</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">1.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.重启MySQL服务，使用SHOW语句查询慢查询日志功能信息，具体SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#在根目录下重启服务</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">/</span>]# systemctl restart mysqld</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%long_query_time%&#x27;</span>;</span><br><span class="line">ERROR <span class="number">2006</span> (HY000): MySQL server has gone away</span><br><span class="line"><span class="keyword">No</span> connection. Trying <span class="keyword">to</span> reconnect...</span><br><span class="line">Connection id:    <span class="number">3</span></span><br><span class="line"><span class="keyword">Current</span> database: atguigudb1</span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name   <span class="operator">|</span> <span class="keyword">Value</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> long_query_time <span class="operator">|</span> <span class="number">10.000000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.12</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-4-4-7-删除查询日志"><a href="#7-4-4-7-删除查询日志" class="headerlink" title="7.4.4.7 删除查询日志"></a>7.4.4.7 删除查询日志</h4><ul>
<li><p>查询并调优完后该日志没有用了，可以将其删除</p>
</li>
<li><p>使用SHOW语句显示慢查询日志信息，具体SQL语句如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;slow_query_log%&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+---------------------+-----------------------------------------+</span></span><br><span class="line"><span class="comment">| Variable_name       | Value                                   |</span></span><br><span class="line"><span class="comment">+---------------------+-----------------------------------------+</span></span><br><span class="line"><span class="comment">| slow_query_log      | OFF                                     |</span></span><br><span class="line"><span class="comment">| slow_query_log_file | /var/lib/mysql/centos7-mysql-1-slow.log |</span></span><br><span class="line"><span class="comment">+---------------------+-----------------------------------------+</span></span><br><span class="line"><span class="comment">2 rows in set (0.00 sec)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>从执行结果可以看出，慢查询日志的目录默认为MySQL的数据目录，在该目录下手动删除慢查询日志文件即可：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">/</span>]# rm <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql<span class="operator">/</span>localhost<span class="operator">-</span>slow.log</span><br><span class="line">rm：是否删除普通文件 &quot;/var/lib/mysql/localhost-slow.log&quot;？y</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">/</span>]# cd <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@localhost</span> mysql]# ll</span><br><span class="line">总用量 <span class="number">188480</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 17 14:14 atguigudb</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql      142 12月  3 18:07 atguigudb1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 12月  1 17:39 dbtest2</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql    17582 12月  3 23:29 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 79691776 12月  3 23:30 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月  3 23:30 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月  3 23:30 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 12月  3 23:30 ibtmp1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 10 22:06 mysql</span></span><br><span class="line">srwxrwxrwx. <span class="number">1</span> mysql mysql        <span class="number">0</span> <span class="number">12</span>月  <span class="number">3</span> <span class="number">23</span>:<span class="number">30</span> mysql.sock</span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------. 1 mysql mysql        6 12月  3 23:30 mysql.sock.lock</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 sys</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用命令<code>mysqladmin flush-logs </code>来重新生成查询日志文件，具体命令如下，执行完毕会在数据目录下重新生成慢查询日志文件：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin <span class="operator">-</span>uroot <span class="operator">-</span>p flush<span class="operator">-</span>logs slow</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在打开的条件下，执行上面的语句，才可以看见重置的日志文件</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> slow_query_log<span class="operator">=</span><span class="keyword">on</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>提示:<br>慢查询日志都是使用mysqladmin flush-logs命令来删除重建的。使用时一定要注意，一旦执行了这个命令，慢查询日志都只存在新的日志文件中，如果需要旧的查询日志，就必须享先备份。</p>
</blockquote>
<h3 id="7-4-5-查看-SQL-执行成本：SHOW-PROFILE"><a href="#7-4-5-查看-SQL-执行成本：SHOW-PROFILE" class="headerlink" title="7.4.5 查看 SQL 执行成本：SHOW PROFILE"></a>7.4.5 查看 SQL 执行成本：SHOW PROFILE</h3><ul>
<li><p>Show Profile是MySQL提供的可以用来分析当前会话中SQL都做了什么、执行的资源消耗情况的工具，可用于sql调优的测量。<strong>默认情况下处于关闭状态</strong>，并保存最近15次的运行结果</p>
</li>
<li><p>可以在会话级别开启这个功能：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> profiling     <span class="operator">|</span> OFF   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过设profiling&#x3D;’ON’来开启show profile：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> profiling <span class="operator">=</span> <span class="string">&#x27;ON&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> profiling     <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>show profile使用演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use atguigudb1;</span><br><span class="line">Reading <span class="keyword">table</span> information <span class="keyword">for</span> completion <span class="keyword">of</span> <span class="keyword">table</span> <span class="keyword">and</span> <span class="keyword">column</span> names</span><br><span class="line">You can turn off this feature <span class="keyword">to</span> <span class="keyword">get</span> a quicker startup <span class="keyword">with</span> <span class="operator">-</span>A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> stuno <span class="operator">=</span><span class="number">343789</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id     <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">243788</span> <span class="operator">|</span> <span class="number">343789</span> <span class="operator">|</span> JOYCPr <span class="operator">|</span>   <span class="number">36</span> <span class="operator">|</span>     <span class="number">482</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">8.17</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;JOYCPr&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id      <span class="operator">|</span> stuno   <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">243788</span> <span class="operator">|</span>  <span class="number">343789</span> <span class="operator">|</span> JOYCPr <span class="operator">|</span>   <span class="number">36</span> <span class="operator">|</span>     <span class="number">482</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">676500</span> <span class="operator">|</span>  <span class="number">776501</span> <span class="operator">|</span> JOYCPr <span class="operator">|</span>   <span class="number">39</span> <span class="operator">|</span>     <span class="number">618</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">1101564</span> <span class="operator">|</span> <span class="number">1201565</span> <span class="operator">|</span> JOYCPr <span class="operator">|</span>   <span class="number">38</span> <span class="operator">|</span>     <span class="number">562</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------+---------+--------+------+---------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">1.26</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profiles;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span> Query_ID <span class="operator">|</span> Duration   <span class="operator">|</span> Query                                       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------------------------+</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">1</span> <span class="operator">|</span> <span class="number">0.00162050</span> <span class="operator">|</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;profiling&#x27;</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">2</span> <span class="operator">|</span> <span class="number">0.00021375</span> <span class="operator">|</span> <span class="keyword">SELECT</span> DATABASE()                           <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">3</span> <span class="operator">|</span> <span class="number">0.05371400</span> <span class="operator">|</span> <span class="keyword">show</span> databases                              <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">4</span> <span class="operator">|</span> <span class="number">0.00023750</span> <span class="operator">|</span> <span class="keyword">show</span> tables                                 <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">5</span> <span class="operator">|</span> <span class="number">8.16393575</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> stuno <span class="operator">=</span><span class="number">343789</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>        <span class="number">6</span> <span class="operator">|</span> <span class="number">1.26560900</span> <span class="operator">|</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;JOYCPr&#x27;</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------+------------+---------------------------------------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status               <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting             <span class="operator">|</span> <span class="number">0.000068</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables       <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                 <span class="operator">|</span> <span class="number">0.000023</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock          <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing           <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics           <span class="operator">|</span> <span class="number">0.000013</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing            <span class="operator">|</span> <span class="number">0.000010</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing            <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data         <span class="operator">|</span> <span class="number">1.265394</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                  <span class="operator">|</span> <span class="number">0.000013</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>            <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables       <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items        <span class="operator">|</span> <span class="number">0.000020</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up          <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以查看指定的Query lD的开销，比如&#96;show profile for query 6查询结果是一样的。在SHOWPROFILE中我们可以查看不同部分的开销，比如cpu、block.io等：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile cpu, block io <span class="keyword">for</span> query <span class="number">6</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> Status               <span class="operator">|</span> Duration <span class="operator">|</span> CPU_user <span class="operator">|</span> CPU_system <span class="operator">|</span> Block_ops_in <span class="operator">|</span> Block_ops_out <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class="line"><span class="operator">|</span> starting             <span class="operator">|</span> <span class="number">0.000068</span> <span class="operator">|</span> <span class="number">0.000018</span> <span class="operator">|</span>   <span class="number">0.000046</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span> <span class="number">0.000001</span> <span class="operator">|</span>   <span class="number">0.000005</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables       <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span> <span class="number">0.000005</span> <span class="operator">|</span>   <span class="number">0.000010</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                 <span class="operator">|</span> <span class="number">0.000023</span> <span class="operator">|</span> <span class="number">0.000006</span> <span class="operator">|</span>   <span class="number">0.000017</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock          <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span>   <span class="number">0.000006</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing           <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span> <span class="number">0.000002</span> <span class="operator">|</span>   <span class="number">0.000006</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics           <span class="operator">|</span> <span class="number">0.000013</span> <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span>   <span class="number">0.000009</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing            <span class="operator">|</span> <span class="number">0.000010</span> <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span>   <span class="number">0.000007</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing            <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span> <span class="number">0.000000</span> <span class="operator">|</span>   <span class="number">0.000002</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data         <span class="operator">|</span> <span class="number">1.265394</span> <span class="operator">|</span> <span class="number">1.229724</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                  <span class="operator">|</span> <span class="number">0.000013</span> <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>            <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables       <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items        <span class="operator">|</span> <span class="number">0.000020</span> <span class="operator">|</span> <span class="number">0.000020</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up          <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span>   <span class="number">0.000000</span> <span class="operator">|</span>            <span class="number">0</span> <span class="operator">|</span>             <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>show profile的常用查询参数:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ALL:显示所有的开销信息</span></span><br><span class="line"><span class="comment">BLOCK IO:显示块IO开销</span></span><br><span class="line"><span class="comment">CONTEXT SWITCHES:上下文切换开销</span></span><br><span class="line"><span class="comment">CPU:显示CPU开销信息</span></span><br><span class="line"><span class="comment">IPC:显示发送和接收开销信息</span></span><br><span class="line"><span class="comment">MEMORY:显示内存开销信息</span></span><br><span class="line"><span class="comment">PAGE FAULTS:显示页面错误开销信息</span></span><br><span class="line"><span class="comment">SOURCE:显示和Source_function，Source_file，Source_line相关的开销信息</span></span><br><span class="line"><span class="comment">SWAPS:显示交换次数开销信息</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>日常开发需注意的结论:</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># converting HEAP <span class="keyword">to</span> MyISAM:查询结果太大，内存不够，数据往磁盘上搬了</span><br><span class="line"># Creating tmp.table:创建临时表。先拷贝数据到临时表，用完后再删除临时表</span><br><span class="line"># Copying <span class="keyword">to</span> tmp <span class="keyword">table</span> <span class="keyword">on</span> disk:把内存中临时表复制到磁盘上，警惕</span><br><span class="line"># locked</span><br><span class="line"># 如果在<span class="keyword">show</span> profile诊断结果中出现了以上<span class="number">4</span>条结果中的任何一条，则<span class="keyword">sql</span>语句需要优化</span><br><span class="line"># 不过 <span class="keyword">SHOW</span> PROFILE命令将被弃用，可以从 information_schema中的profiling 数据表进行查看</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="7-4-6-分析查询语句：EXPLAIN"><a href="#7-4-6-分析查询语句：EXPLAIN" class="headerlink" title="7.4.6  分析查询语句：EXPLAIN"></a>7.4.6  分析查询语句：EXPLAIN</h3><h4 id="7-4-6-1-概述"><a href="#7-4-6-1-概述" class="headerlink" title="7.4.6.1 概述"></a>7.4.6.1 概述</h4><ul>
<li><p><strong>定位了查询慢的SQL之后，就可以使用EXPLAIN或DESCRIBE工具做针对性的分析查询语句</strong>。DESCRIBE语句的使用方法与EXPLAIN语句是一样的，并且分析结果也是一样的</p>
</li>
<li><p>MySQL中有专门负责优化SELECT语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供它认为最优的<strong>执行计划</strong>（他认为最优的数据检索方式，但不见得是DBA认为是最优的，这部分最耗费时间)</p>
</li>
<li><p>这个执行计划展示了接下来具体执行查询的方式，比如多表连接的顺序是什么，对于每个表采用什么访问方法来具体执行查询等等</p>
</li>
<li><p>MySQL为我们提供了<strong>EXPLAIN</strong>语句来帮助我们查看某个查询语句的具体执行计划，看懂<strong>EXPLAIN</strong>语句的各个输出项，可以有针对性的提升查询语句的性能</p>
</li>
</ul>
<blockquote>
<p><strong>1.能做什么</strong></p>
</blockquote>
<ul>
<li>表的读取顺序</li>
<li>数据读取操作的操作类型</li>
<li>哪些索引可以使用</li>
<li><strong>哪些索引被实际使用</strong></li>
<li>表之间的引用</li>
<li><strong>每张表有多少行被优化器查询</strong></li>
</ul>
<blockquote>
<p><strong>2.官网介绍</strong></p>
</blockquote>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></p>
</li>
</ul>
<blockquote>
<p><strong>3.版本情况</strong></p>
</blockquote>
<ul>
<li><p>MySQL 5.6.3以前只能 <strong>EXPLAIN SELECT</strong></p>
</li>
<li><p>MySQL 5.6.3以后就可以 <strong>EXPLAIN，SELECT，UPDATE，DELETE</strong></p>
</li>
<li><p>在5.7以前的版本中，想要显示 <strong>partitions</strong> 需要使用 <strong>explain partitions</strong> 命令；想要显示<strong>filtered</strong>需要使用 <strong>explain extended</strong>命令。在5.7版本后，<strong>默认explain直接显示partitions和filtered中的信息</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student_info;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student_info LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> student_info <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-4-6-2-基本语法"><a href="#7-4-6-2-基本语法" class="headerlink" title="7.4.6.2 基本语法"></a>7.4.6.2 基本语法</h4><ul>
<li><p><strong>EXPLAIN</strong> 或 <strong>DESCRIBE</strong>语句的语法形式如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN <span class="keyword">SELECT</span> select_options</span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">DESCRIBE</span> <span class="keyword">SELECT</span> select_options</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我们想看看某个查询的执行计划的话，可以在具体的查询语句前边加一个 <strong>EXPLAIN</strong> ，就像这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">No</span> tables used</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出的上述信息就是所谓的<strong>执行计划</strong>。在这个执行计划的辅助下，我们需要知道应该怎样改进自己的查询语句以使查询执行起来更高效。其实除了以<strong>SELECT</strong>开头的查询语句，其余的<strong>DELETE、INSERT、REPLACE</strong>以及<strong>UPDATE</strong>语句等都可以加上<strong>EXPLAIN</strong>，用来查看这些语句的执行计划，只是平时我们对<strong>SELECT</strong>语句更感兴趣</p>
</li>
<li><p>注意: 执行<strong>EXPLAIN</strong>时并<strong>没有</strong>真正的执行该后面的语句，因此可以安全的查看执行计划</p>
</li>
<li><p><code>EXPLAIN</code>语句输出的各个列的作用如下：</p>
<table>
<thead>
<tr>
<th>列名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>在一个大的查询语句中每个SELECT关键字都对应一个 <code>唯一的id</code></td>
</tr>
<tr>
<td><code>select_type</code></td>
<td>SELECT关键字对应的那个查询的类型</td>
</tr>
<tr>
<td><code>table</code></td>
<td>表名</td>
</tr>
<tr>
<td><code>partitions</code></td>
<td>匹配的分区信息</td>
</tr>
<tr>
<td><code>type</code></td>
<td>针对单表的访问方法</td>
</tr>
<tr>
<td><code>possible_keys</code></td>
<td>可能用到的索引</td>
</tr>
<tr>
<td><code>key</code></td>
<td>实际上使用的索引</td>
</tr>
<tr>
<td><code>key_len</code></td>
<td>实际使用到的索引长度(单位：字节)</td>
</tr>
<tr>
<td><code>ref</code></td>
<td>当使用索引列等值查询时，与索引列进行等值匹配的对象信息</td>
</tr>
<tr>
<td><code>rows</code></td>
<td>预估的需要读取的记录条数</td>
</tr>
<tr>
<td><code>filtered</code></td>
<td>某个表经过搜索条件过滤后剩余记录条数的百分比</td>
</tr>
<tr>
<td><code>Extra</code></td>
<td>一些额外的信息</td>
</tr>
</tbody></table>
</li>
</ul>
<h4 id="7-4-6-3-数据准备"><a href="#7-4-6-3-数据准备" class="headerlink" title="7.4.6.3 数据准备"></a>7.4.6.3 数据准备</h4><blockquote>
<p><strong>1. 建表</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#表一</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> s1 (</span><br><span class="line">	id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">	key1 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key2 <span class="type">INT</span>,</span><br><span class="line">	key3 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part1 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part2 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part3 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	common_field <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (id),</span><br><span class="line">	INDEX idx_key1 (key1),</span><br><span class="line">	<span class="keyword">UNIQUE</span> INDEX idx_key2 (key2),</span><br><span class="line">	INDEX idx_key3 (key3),</span><br><span class="line">	INDEX idx_key_part(key_part1, key_part2, key_part3)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#表二</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> s2 (</span><br><span class="line">	id <span class="type">INT</span> AUTO_INCREMENT,</span><br><span class="line">	key1 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key2 <span class="type">INT</span>,</span><br><span class="line">	key3 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part1 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part2 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	key_part3 <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	common_field <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (id),</span><br><span class="line">	INDEX idx_key1 (key1),</span><br><span class="line">	<span class="keyword">UNIQUE</span> INDEX idx_key2 (key2),</span><br><span class="line">	INDEX idx_key3 (key3),</span><br><span class="line">	INDEX idx_key_part(key_part1, key_part2, key_part3)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>2. 设置参数log_bin_trust_function_creators</strong></p>
</blockquote>
<ul>
<li><p>创建函数，假如报错，需开启如下命令：允许创建函数设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="number">1</span>; # 不加<span class="keyword">global</span>只是当前窗口有效。</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>3. 创建存储函数</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string1(n <span class="type">INT</span>)</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>) #该函数会返回一个字符串</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> chars_str <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span></span><br><span class="line"><span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> return_str <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">WHILE i <span class="operator">&lt;</span> n DO</span><br><span class="line"><span class="keyword">SET</span> return_str <span class="operator">=</span>CONCAT(return_str,<span class="built_in">SUBSTRING</span>(chars_str,<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>RAND()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">RETURN</span> return_str;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>创建存储过程</strong></p>
</blockquote>
<ul>
<li><p>创建往s1表中插入数据的存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_s1 (<span class="keyword">IN</span> min_num <span class="type">INT</span> (<span class="number">10</span>),<span class="keyword">IN</span> max_num <span class="type">INT</span> (<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> s1 <span class="keyword">VALUES</span>(</span><br><span class="line">(min_num <span class="operator">+</span> i),</span><br><span class="line">rand_string1(<span class="number">6</span>),</span><br><span class="line">(min_num <span class="operator">+</span> <span class="number">30</span> <span class="operator">*</span> i <span class="operator">+</span> <span class="number">5</span>),</span><br><span class="line">rand_string1(<span class="number">6</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>),</span><br><span class="line">rand_string1(<span class="number">5</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>));</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建往s2表中插入数据的存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_s2 (<span class="keyword">IN</span> min_num <span class="type">INT</span> (<span class="number">10</span>),<span class="keyword">IN</span> max_num <span class="type">INT</span> (<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> s2 <span class="keyword">VALUES</span>(</span><br><span class="line">(min_num <span class="operator">+</span> i),</span><br><span class="line">rand_string1(<span class="number">6</span>),</span><br><span class="line">(min_num <span class="operator">+</span> <span class="number">30</span> <span class="operator">*</span> i <span class="operator">+</span> <span class="number">5</span>),</span><br><span class="line">rand_string1(<span class="number">6</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>),</span><br><span class="line">rand_string1(<span class="number">5</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>),</span><br><span class="line">rand_string1(<span class="number">10</span>));</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>5. 调用存储过程</strong></p>
</blockquote>
<ul>
<li><p>s1表数据的添加：加入1万条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> insert_s1(<span class="number">10001</span>,<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>s2表数据的添加：加入1万条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> insert_s2(<span class="number">10001</span>,<span class="number">10000</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> s1;#<span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> s2;#<span class="number">10000</span></span><br></pre></td></tr></table></figure>

<h4 id="7-4-6-4-EXPLAIN各列作用"><a href="#7-4-6-4-EXPLAIN各列作用" class="headerlink" title="7.4.6.4 EXPLAIN各列作用"></a>7.4.6.4 EXPLAIN各列作用</h4><blockquote>
<h4 id="1-table"><a href="#1-table" class="headerlink" title="1.table"></a>1.table</h4></blockquote>
<ul>
<li><p>不论查询语句有多复杂，里边<code>包含了多少个表</code> ，到最后也是需要对每个表进行<code>单表访问</code> 的，所以MySQL规定<strong>EXPLAIN语句输出的每条记录都对应着某个单表的访问方法</strong>，该条记录的table列代表着该表的表名（有时不是真实的表名字，可能是简称）</p>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> <span class="keyword">table</span>：表名</span><br><span class="line"># 查询的每一行记录都对应着一个单表</span><br><span class="line"># 单表查询返回一行</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># s1:驱动表  s2:被驱动表</span><br><span class="line"># 查询的每一行记录都对应着一个单表:</span><br><span class="line"># 多表查询返回多行</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="2-id"><a href="#2-id" class="headerlink" title="2.id"></a>2.id</h4></blockquote>
<ul>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">2.</span> id：在一个大的查询语句中每个<span class="keyword">SELECT</span>关键字都对应一个唯一的id</span><br><span class="line"># 通常出现了几个<span class="keyword">select</span>关键字就对应几个id </span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;#id值<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2</span><br><span class="line"> <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key1</span><br><span class="line"> <span class="keyword">WHERE</span> s1.common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;#id值<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 </span><br><span class="line"> <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key3 <span class="keyword">FROM</span> s2);#id值<span class="number">1</span>、<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span>  EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2) <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">###查询优化器可能对涉及子查询的查询语句进行重写,转变为多表查询的操作###</span><br><span class="line">mysql<span class="operator">&gt;</span>  EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key2 <span class="keyword">FROM</span> s2 <span class="keyword">WHERE</span> common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>)\G</span><br><span class="line"># 两个<span class="keyword">select</span>却只出现一个id<span class="comment">--&gt;查询优化器将该语句转成了多表查询</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key2</span><br><span class="line">          key: idx_key2</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># <span class="keyword">Union</span>去重<span class="comment">--&gt;UNION取并集并去重时产生一个临时表 &lt;union1,2&gt;  Using temporary</span></span><br><span class="line">mysql<span class="operator">&gt;</span>  EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s2\G</span><br><span class="line"># 两个<span class="keyword">select</span>出现<span class="number">3</span>行记录 </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="keyword">NULL</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span> <span class="keyword">RESULT</span></span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"># <span class="keyword">UNION</span> <span class="keyword">ALL</span>不用去重，只有两个id<span class="operator">/</span>行</span><br><span class="line">mysql<span class="operator">&gt;</span>  EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1  <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>小结:</strong></p>
<ul>
<li><strong>id如果相同，可以认为是一组，从上往下顺序执行</strong></li>
<li><strong>在所有组中。id值越大。优先级越高。越先执行</strong></li>
<li><strong>关注点: id号每个号码。表示一趟独立的查询,一个sql的查询趟数越少越好</strong></li>
</ul>
</li>
</ul>
<blockquote>
<h4 id="3-select-type"><a href="#3-select-type" class="headerlink" title="3.select_type"></a>3.select_type</h4></blockquote>
<ul>
<li><p>一条大的查询语句里边可以包含若干个SELECT关键字，<strong>每个SELECT关键字代表着一个小的查询语句</strong>，而每个SELECT关键字的FROM子句中都可以包含若干张表（这些表用来做连接查询)，<strong>每一张表都对应着执行计划输出中的一条记录</strong>，对于在同一个SELECT关键字中的表来说，它们的id值是相同的</p>
</li>
<li><p>MySQL为每一个SELECT关键字代表的小查询都定义了一个称之为<strong>select_type</strong>的属性，意思是只要知道了某个小查询的<strong>select_type属性</strong>，就知道了这个<strong>小查询在整个大查询中扮演了一个什么角色</strong>，我们看一下select_type都能取哪些值，请看官方文档：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>SIMPLE</td>
<td>Simple SELECT (not using UNION or subqueries)</td>
</tr>
<tr>
<td>PRIMARY</td>
<td>Outermost SELECT</td>
</tr>
<tr>
<td>UNION</td>
<td>Second or later SELECT statement in a UNION</td>
</tr>
<tr>
<td>UNION</td>
<td>RESULT Result of a UNION</td>
</tr>
<tr>
<td>SUBQUERY</td>
<td>First SELECT in subquery</td>
</tr>
<tr>
<td>DEPENDENT</td>
<td>SUBQUERY First SELECT in subquery, dependent on outer query</td>
</tr>
<tr>
<td>DEPENDENT</td>
<td>UNION Second or later SELECT statement in a UNION, dependent on outer query</td>
</tr>
<tr>
<td>DERIVED</td>
<td>Derived table</td>
</tr>
<tr>
<td>MATERIALIZED</td>
<td>Materialized subquery</td>
</tr>
<tr>
<td>UNCACHEABLE SUBQUERY</td>
<td>A subquery for which the result cannot be cached and must be re-evaluated foreach row of the outer query</td>
</tr>
<tr>
<td>UNCACHEABLE UNION</td>
<td>The second or later select in a UNION that belongs to an uncacheable subquery (see UNCACHEABLE SUBQUERY)</td>
</tr>
</tbody></table>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br></pre></td><td class="code"><pre><span class="line"> #<span class="number">3.</span> select_type：<span class="keyword">SELECT</span>关键字对应的那个查询的类型,确定小查询在整个大查询中扮演了一个什么角色</span><br><span class="line"></span><br><span class="line"> # 查询语句中不包含`<span class="keyword">UNION</span>`或者子查询的查询都算作是`SIMPLE`类型</span><br><span class="line">mysql<span class="operator">&gt;</span>  EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">#连接查询也算是`SIMPLE`类型</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #对于包含`<span class="keyword">UNION</span>`或者`<span class="keyword">UNION</span> <span class="keyword">ALL</span>`或者子查询的大查询来说，它是由几个小查询组成的，其中最左边的那个</span><br><span class="line"> #查询的`select_type`值就是`<span class="keyword">PRIMARY</span>`</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> #对于包含`<span class="keyword">UNION</span>`或者`<span class="keyword">UNION</span> <span class="keyword">ALL</span>`的大查询来说，它是由几个小查询组成的，其中除了最左边的那个小查询</span><br><span class="line"> #以外，其余的小查询的`select_type`值就是`<span class="keyword">UNION</span>`</span><br><span class="line"> </span><br><span class="line"> #`MySQL`选择使用临时表来完成`<span class="keyword">UNION</span>`查询的去重工作，针对该临时表的查询的`select_type`就是</span><br><span class="line"> #`<span class="keyword">UNION</span> <span class="keyword">RESULT</span>`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">UNION</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="keyword">NULL</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span> <span class="keyword">RESULT</span></span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>union1,<span class="number">2</span><span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">UNION</span> <span class="keyword">ALL</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s2\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #子查询：</span><br><span class="line"> #如果包含子查询的查询语句不能够转为对应的`semi<span class="operator">-</span><span class="keyword">join</span>`的形式，并且该子查询是不相关子查询</span><br><span class="line"> #该子查询的第一个`<span class="keyword">SELECT</span>`关键字代表的那个查询的`select_type`就是`SUBQUERY`</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2) <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #如果包含子查询的查询语句不能够转为对应的`semi<span class="operator">-</span><span class="keyword">join</span>`的形式，并且该子查询是相关子查询，</span><br><span class="line"> #则该子查询的第一个`<span class="keyword">SELECT</span>`关键字代表的那个查询的`select_type`就是`DEPENDENT SUBQUERY`</span><br><span class="line"> #注意的是，select_type为`DEPENDENT SUBQUERY`的查询可能会被执行多次。</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1   <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2 <span class="keyword">WHERE</span> s1.key2 <span class="operator">=</span> s2.key2) <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: DEPENDENT SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key2,idx_key1</span><br><span class="line">          key: idx_key2</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key2</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line"> #在包含`<span class="keyword">UNION</span>`或者`<span class="keyword">UNION</span> <span class="keyword">ALL</span>`的大查询中，如果各个小查询都依赖于外层查询的话，那除了</span><br><span class="line"> #最左边的那个小查询之外，其余的小查询的`select_type`的值就是`DEPENDENT <span class="keyword">UNION</span>`。</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">UNION</span> <span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;b&#x27;</span>)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: DEPENDENT SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">3</span></span><br><span class="line">  select_type: DEPENDENT <span class="keyword">UNION</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="keyword">NULL</span></span><br><span class="line">  select_type: <span class="keyword">UNION</span> <span class="keyword">RESULT</span></span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>union2,<span class="number">3</span><span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary</span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #对于包含`派生表`的查询，该派生表对应的子查询的`select_type`就是`DERIVED`</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> (<span class="keyword">SELECT</span> key1, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> c <span class="keyword">FROM</span> s1 <span class="keyword">GROUP</span> <span class="keyword">BY</span> key1) <span class="keyword">AS</span> derived_s1 <span class="keyword">WHERE</span> c <span class="operator">&gt;</span> <span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">33.33</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: DERIVED</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #当查询优化器在执行包含子查询的语句时，选择将子查询物化之后与外层查询进行连接查询时，</span><br><span class="line"> #该子查询对应的`select_type`属性就是`MATERIALIZED`</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2)\G#子查询被转为了物化表</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>subquery2<span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">          key: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: MATERIALIZED</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="4-partitions-可略-匹配的分区信息"><a href="#4-partitions-可略-匹配的分区信息" class="headerlink" title="4. partitions (可略) :匹配的分区信息"></a>4. partitions (可略) :匹配的分区信息</h4></blockquote>
<ul>
<li><p>代表分区表中的命中情况，非分区表，该项为NULL。一般情况下的查询语句的执行计划的partitions列的值都是NULL</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html">https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html</a></p>
</li>
<li><p>如果想详细了解，可以如下方式测试。创建分区表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建分区表，</span></span><br><span class="line"><span class="comment">-- 按照id分区，id&lt;100 p0分区，其他p1分区</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_partitions (id <span class="type">INT</span> auto_increment,</span><br><span class="line">                              NAME <span class="type">VARCHAR</span>(<span class="number">12</span>),<span class="keyword">PRIMARY</span> KEY(id))</span><br><span class="line">							  <span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">RANGE</span>(id)(</span><br><span class="line">    								<span class="keyword">PARTITION</span> p0 <span class="keyword">VALUES</span> less than(<span class="number">100</span>),</span><br><span class="line">    								<span class="keyword">PARTITION</span> p1 <span class="keyword">VALUES</span> less than MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询id大于200（200&gt;100，p1分区）的记录，查看执行计划，partitions是p1，符合我们的分区规则</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s2)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>subquery2<span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">          key: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: MATERIALIZED</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DESC</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user_partitions <span class="keyword">WHERE</span> id<span class="operator">&gt;</span><span class="number">200</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: user_partitions</span><br><span class="line">   partitions: p1</span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="5-type"><a href="#5-type" class="headerlink" title="5. type"></a>5. type</h4></blockquote>
<ul>
<li><p>执行计划的一条记录就代表着MySQL对某个表的<strong>执行查询时的访问方法</strong>，又称”访问类型”，其中的<strong>type</strong>列就表明了这个访问方法是啥，是较为重要的一个指标。比如，看到 <strong>type</strong>列的值是<strong>ref</strong>，表明<strong>MySQL</strong>即将使用<strong>ref</strong>访问方法来执行对<strong>s1</strong>表的查询</p>
</li>
<li><p>完整的访问方法如下： <strong>system</strong> ， <strong>const</strong> ， <strong>eq_ref</strong> ， <strong>ref</strong> ， <strong>fulltext</strong> ， <strong>ref_or_null</strong> ，<br><strong>index_merge</strong> ， <strong>unique_subquery</strong> ， <strong>index_subquery</strong> ， <strong>range</strong>， <strong>index</strong> ， <strong>ALL</strong> </p>
</li>
<li><p>我们详细解释一下：</p>
<ul>
<li><strong>system</strong>：当表中只有一条记录并且该表使用的存储引擎的统计数据是精确的，比如MyISAM、Memory，那么对该表的访问方法就是<strong>system</strong>。比方说我们新建一个<strong>MyISAM</strong>表，并为其后入—条记录</li>
</ul>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line"> # <span class="number">5.</span> type：针对单表的访问方法</span><br><span class="line"> </span><br><span class="line"> #当表中`只有一条记录`并且该表使用的存储引擎的统计数据是精确的，比如MyISAM、Memory，</span><br><span class="line"> #那么对该表的访问方法就是`<span class="keyword">system</span>`。</span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> t(i <span class="type">INT</span>) ENGINE<span class="operator">=</span>MYISAM;</span><br><span class="line"> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br><span class="line"> #<span class="keyword">system</span><span class="comment">--&gt;性能最高的场景</span></span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">system</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line"> #再添加 <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br><span class="line"> #EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t; 就会变成<span class="keyword">all</span> </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> t <span class="keyword">VALUES</span>(<span class="number">2</span>);</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> #换成InnoDB</span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> tt(i <span class="type">INT</span>) ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> tt <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> tt\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: tt</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> #当我们根据主键或者唯一二级索引列与常数进行等值匹配时，对单表的访问方法就是`const`</span><br><span class="line"> #select_type为`const`<span class="comment">--&gt;访问效率为常数级</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">10005</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: const</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key2 <span class="operator">=</span> <span class="number">10066</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: const</span><br><span class="line">possible_keys: idx_key2</span><br><span class="line">          key: idx_key2</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #<span class="keyword">all</span></span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key3 <span class="operator">=</span> <span class="number">10066</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">3</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> #在连接查询时，如果被驱动表是通过主键或者唯一二级索引列等值匹配的方式进行访问的</span><br><span class="line"> #（如果该主键或者唯一二级索引是联合索引的话，所有的索引列都必须进行等值比较），则</span><br><span class="line"> # 驱动表 <span class="keyword">all</span> 对该被驱动表的访问方法就是`eq_ref`</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.id <span class="operator">=</span> s2.id\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.id</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line">  </span><br><span class="line"> #当通过普通的二级索引列与常量进行等值匹配时来查询某个表，那么对该表的访问方法就可能是`<span class="keyword">ref</span>`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> #为什么 EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key3 <span class="operator">=</span> <span class="number">10066</span>; 是<span class="keyword">all</span> 因为key3是<span class="type">varchar</span>类型 <span class="number">10066</span>需要函数转换，涉及函数是不会用到索引的</span><br><span class="line"> </span><br><span class="line"> #加上<span class="string">&#x27;&#x27;</span>就是 <span class="keyword">ref</span></span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key3 <span class="operator">=</span> <span class="string">&#x27;10066&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: idx_key3</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> #当对普通二级索引进行等值匹配查询，该索引列的值也可以是`<span class="keyword">NULL</span>`值时，那么对该表的访问方法</span><br><span class="line"> #就可能是`ref_or_null`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">OR</span> key1 <span class="keyword">IS</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: ref_or_null</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #单表访问方法时在某些场景下可以使用`<span class="keyword">Intersection</span>`、`<span class="keyword">Union</span>`、</span><br><span class="line"> #`Sort<span class="operator">-</span><span class="keyword">Union</span>`这三种索引合并的方式来执行查询 <span class="keyword">OR</span>的并集关系使两个索引都将用到 `index_merge`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index_merge</span><br><span class="line">possible_keys: idx_key1,idx_key3</span><br><span class="line">          key: idx_key1,idx_key3</span><br><span class="line">      key_len: <span class="number">303</span>,<span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">union</span>(idx_key1,idx_key3); <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #`unique_subquery`是针对在一些包含`<span class="keyword">IN</span>`子查询的查询语句中，如果查询优化器决定将`<span class="keyword">IN</span>`子查询</span><br><span class="line"> #转换为`<span class="keyword">EXISTS</span>`子查询，而且子查询可以使用到主键进行等值匹配的话，那么该子查询执行计划的`type`</span><br><span class="line"> #列的值就是`unique_subquery`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1   <span class="keyword">WHERE</span> key2 <span class="keyword">IN</span> (<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> s2 <span class="keyword">WHERE</span> s1.key1 <span class="operator">=</span> s2.key1) <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key3</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: DEPENDENT SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: unique_subquery</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span>,idx_key1</span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: func</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.01</span> sec)</span><br><span class="line"> </span><br><span class="line"> #如果使用索引获取某些`范围区间`的记录，那么就可能使用到`<span class="keyword">range</span>`访问方法</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="keyword">IN</span> (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">3</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line"> #同上</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">AND</span> key1 <span class="operator">&lt;</span> <span class="string">&#x27;b&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">377</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"> #当我们可以使用索引覆盖，但需要扫描全部的索引记录时，该表的访问方法就是`index`</span><br><span class="line"> # 索引覆盖   用到了联合索引idx_key_part</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> key_part2 <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key_part3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_key_part</span><br><span class="line">      key_len: <span class="number">909</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line"> #最熟悉的全表扫描  `<span class="keyword">all</span>`</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>小结：</p>
<ul>
<li><p>结果值从最好到最坏依次是：<br><strong>system</strong> &gt; <strong>const</strong> &gt; <strong>eq_ref</strong> &gt; <strong>ref</strong> &gt; fulltext &gt; ref_or_null &gt; index_merge &gt;unique_subquery &gt; index_subquery &gt; <strong>range</strong> &gt; <strong>index</strong> &gt; <strong>ALL</strong></p>
</li>
<li><p>其中比较重要的几个提取出来（见上图中的加粗）<br><strong>SQL 性能优化的目标：至少要达到 range 级别，要求是 ref 级别，最好是 const级别。（阿里巴巴开发手册要求）</strong></p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h4 id="6-possible-keys和key"><a href="#6-possible-keys和key" class="headerlink" title="6. possible_keys和key"></a>6. possible_keys和key</h4></blockquote>
<ul>
<li><p>在EXPLAIN语句输出的执行计划中, <strong>possible_keys</strong>列表示在某个查询语句中，对某个表执行<strong>单表查询时可能用到的索引</strong>有哪些。一般查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用。<strong>key</strong>列表示<strong>实际用到的索引</strong>有哪些，如果为NULL，则没有使用索引</p>
</li>
<li><p>比方说下边这个查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> <span class="keyword">AND</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1,idx_key3</span><br><span class="line">          key: idx_key3</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">5.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>上述执行计划的<code>possible_keys列</code>的值是<code>idx_key1 , idx_key3</code>，表示该查询可能使用到<code>idx_key1</code>, <code>idx_key3</code>两个索引，然后key列的值是<code>idx_key3</code>，表示经过查询优化器计算使用不同索引的成本后，最后决定使用哪一个来执行语句</p>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">6.</span> possible_keys和key：可能用到的索引 和  实际上使用的索引</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> <span class="keyword">AND</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1,idx_key3</span><br><span class="line">          key: idx_key3</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">5.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="7-key-len"><a href="#7-key-len" class="headerlink" title="7. key_len"></a>7. key_len</h4></blockquote>
<ul>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">7.</span>  key_len：实际使用到的索引长度(即：字节数)</span><br><span class="line"># 帮你检查`是否充分的利用上了索引`，`值越大越好`,主要针对于联合索引，有一定的参考意义</span><br><span class="line"></span><br><span class="line"># <span class="type">int</span> 主键 <span class="number">4</span>个字节</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">10005</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: const</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="type">int</span> 唯一索引可能为<span class="keyword">null</span> <span class="number">4</span><span class="operator">+</span><span class="number">1</span><span class="operator">=</span><span class="number">5</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key2 <span class="operator">=</span> <span class="number">10126</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: const</span><br><span class="line">possible_keys: idx_key2</span><br><span class="line">          key: idx_key2</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="type">varchar</span> <span class="number">100</span> utf8 <span class="number">100</span><span class="operator">*</span><span class="number">3</span>  <span class="operator">+</span><span class="number">1</span>(<span class="keyword">null</span>) <span class="operator">+</span><span class="number">2</span>(实践长度）</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#<span class="number">303</span> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key_part1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key_part</span><br><span class="line">          key: idx_key_part</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.10</span> sec)</span><br><span class="line"> </span><br><span class="line"> #<span class="number">606</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key_part1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">AND</span> key_part2 <span class="operator">=</span> <span class="string">&#x27;b&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key_part</span><br><span class="line">          key: idx_key_part</span><br><span class="line">      key_len: <span class="number">606</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"> </span><br><span class="line">#<span class="number">909</span> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key_part1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">AND</span> key_part2 <span class="operator">=</span> <span class="string">&#x27;b&#x27;</span> <span class="keyword">AND</span> key_part3 <span class="operator">=</span> <span class="string">&#x27;c&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key_part</span><br><span class="line">          key: idx_key_part</span><br><span class="line">      key_len: <span class="number">909</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#没有使用索引，<span class="keyword">null</span> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key_part3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">#练习：</span><br><span class="line">#key_len的长度计算公式：</span><br><span class="line">#<span class="type">varchar</span>(<span class="number">10</span>)变长字段且允许<span class="keyword">NULL</span>  <span class="operator">=</span> <span class="number">10</span> <span class="operator">*</span> ( <span class="type">character</span> <span class="keyword">set</span>：utf8<span class="operator">=</span><span class="number">3</span>,gbk<span class="operator">=</span><span class="number">2</span>,latin1<span class="operator">=</span><span class="number">1</span>)<span class="operator">+</span><span class="number">1</span>(<span class="keyword">NULL</span>)<span class="operator">+</span><span class="number">2</span>(变长字段)</span><br><span class="line"></span><br><span class="line">#<span class="type">varchar</span>(<span class="number">10</span>)变长字段且不允许<span class="keyword">NULL</span> <span class="operator">=</span> <span class="number">10</span> <span class="operator">*</span> ( <span class="type">character</span> <span class="keyword">set</span>：utf8<span class="operator">=</span><span class="number">3</span>,gbk<span class="operator">=</span><span class="number">2</span>,latin1<span class="operator">=</span><span class="number">1</span>)<span class="operator">+</span><span class="number">2</span>(变长字段)</span><br><span class="line"></span><br><span class="line">#<span class="type">char</span>(<span class="number">10</span>)固定字段且允许<span class="keyword">NULL</span>    <span class="operator">=</span> <span class="number">10</span> <span class="operator">*</span> ( <span class="type">character</span> <span class="keyword">set</span>：utf8<span class="operator">=</span><span class="number">3</span>,gbk<span class="operator">=</span><span class="number">2</span>,latin1<span class="operator">=</span><span class="number">1</span>)<span class="operator">+</span><span class="number">1</span>(<span class="keyword">NULL</span>)</span><br><span class="line"></span><br><span class="line">#<span class="type">char</span>(<span class="number">10</span>)固定字段且不允许<span class="keyword">NULL</span>  <span class="operator">=</span> <span class="number">10</span> <span class="operator">*</span> ( <span class="type">character</span> <span class="keyword">set</span>：utf8<span class="operator">=</span><span class="number">3</span>,gbk<span class="operator">=</span><span class="number">2</span>,latin1<span class="operator">=</span><span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="8-ref"><a href="#8-ref" class="headerlink" title="8. ref"></a>8. ref</h4></blockquote>
<ul>
<li><p>显示索引的哪一列被使用了，如果可能的话，是一个常数。哪些列或常量被用于查找索引列上的值</p>
</li>
<li><p>当使用索引列等值匹配的条件去执行查询时，也就是在访问方法是<strong>const</strong>、<strong>eq_ref</strong>、<strong>ref</strong> ,<strong>ref_or_null</strong>、<strong>unique_subquery</strong>、 <strong>index_subquery</strong>其中之一时，ref列展示的就是与索引列作等值匹配的结构是什么，比如只是一个常数或者是某个列。大家看下边这个查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到ref列的值是const，表明在使用idx_key1索引执行查询时，与key1列作等值匹配的对象是一个常数，当然有时候更复杂一点：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.id <span class="operator">=</span> s2.id\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.id</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"> # <span class="number">8.</span> <span class="keyword">ref</span>：当使用索引列等值查询时，与索引列进行等值匹配的对象信息。</span><br><span class="line"> #比如只是一个常数或者是某个列。</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.id <span class="operator">=</span> s2.id\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.id</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s2.key1 <span class="operator">=</span> <span class="built_in">UPPER</span>(s1.key1)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: func</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="9-rows"><a href="#9-rows" class="headerlink" title="9. rows"></a>9. rows</h4></blockquote>
<ul>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">9.</span> <span class="keyword">rows</span>：预估的需要读取的记录条数</span><br><span class="line"># 值越小越好</span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">363</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="10-filtered"><a href="#10-filtered" class="headerlink" title="10.filtered"></a>10.filtered</h4></blockquote>
<ul>
<li><p><em>越高越好，说明查的数据都是有效的</em></p>
</li>
<li><p>演示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> # <span class="number">10.</span> filtered: 某个表经过搜索条件过滤后剩余记录条数的百分比</span><br><span class="line"> </span><br><span class="line"># 如果使用的是索引执行的单表扫描，那么计算时需要估计出满足除使用</span><br><span class="line"># 到对应索引的搜索条件外的其他搜索条件的记录有多少条。</span><br><span class="line"># 越高越好，说明查的数据都是有效的</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> <span class="keyword">AND</span> common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">363</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 对于单表查询来说，这个filtered列的值没什么意义，我们`更关注在连接查询</span><br><span class="line"># 中驱动表对应的执行计划记录的filtered值`，它决定了被驱动表要执行的次数(即：<span class="keyword">rows</span> <span class="operator">*</span> filtered)</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key1 <span class="keyword">WHERE</span> s1.common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="11-Extra"><a href="#11-Extra" class="headerlink" title="11.Extra"></a>11.Extra</h4></blockquote>
<ul>
<li><p>顾名思义，<code>Extra</code>列是用来说明一些额外信息的，包含不适合在其他列中显示但十分重要的额外信息。可以通过这些额外信息来<code>更准确的理辑MySQL到底将如何执行给定的查询语句</code></p>
</li>
<li><p><code>No tables used</code></p>
<ul>
<li><p>当直询语句的没有<code>FROM</code>子句时将会提示该额外信息，比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">11.</span>Extra:一些额外的信息</span><br><span class="line"># 更准确的理解MySQL到底将如何执行给定的查询语句</span><br><span class="line"></span><br><span class="line"># 当查询语句的没有`<span class="keyword">FROM</span>`子句时将会提示该额外信息 <span class="keyword">No</span> tables used</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">No</span> tables used</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>Impossible WHERE</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#查询语句的`<span class="keyword">WHERE</span>`子句永远为`<span class="literal">FALSE</span>`时将会提示该额外信息  Impossible <span class="keyword">WHERE</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> <span class="number">1</span> <span class="operator">!=</span> <span class="number">1</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: Impossible <span class="keyword">WHERE</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Using where</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> #当使用全表扫描来执行对某个表的查询，并且该语句的`<span class="keyword">WHERE</span>`</span><br><span class="line"> #子句中有针对该表的搜索条件时，在`Extra`列中会提示上述额外信息：<span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"> </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> #当使用索引访问来执行对某个表的查询，并且该语句的`<span class="keyword">WHERE</span>`子句中</span><br><span class="line"> #有除了该索引包含的列之外的其他搜索条件时，在`Extra`列中也会提示上述额外信息：<span class="keyword">USING</span> <span class="keyword">WHERE</span></span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">AND</span> common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>No matching min/max row</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 当查询列表处有`MIN`或者`MAX`聚合函数，但是并没有符合`<span class="keyword">WHERE</span>`子句中</span><br><span class="line"># 的搜索条件的记录时，将会提示该额外信息  <span class="keyword">No</span> matching min<span class="operator">/</span>max <span class="type">row</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(key1) <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;abcdefg&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">No</span> matching min<span class="operator">/</span>max <span class="type">row</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 LIMIT <span class="number">10</span>;</span><br><span class="line"># znOhuD 是 s1表中key1字段真实存在的数据  <span class="keyword">Select</span> tables optimized away </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="built_in">MIN</span>(key1) <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;znOhuD&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: <span class="keyword">Select</span> tables optimized away</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Using index</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> #当我们的查询列表以及搜索条件中只包含属于某个索引的列，也就是在可以</span><br><span class="line"> #使用覆盖索引的情况下，在`Extra`列将会提示该额外信息 <span class="keyword">Using</span> index 。比方说下边这个查询中只</span><br><span class="line"> #需要用到`idx_key1`而不需要回表操作：</span><br><span class="line"> #覆盖索引 不需要回表操作 直接可以通过二级索引查到数据</span><br><span class="line"> # EXPLAIN <span class="keyword">SELECT</span> key1 <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> key1,id <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Using index condition</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">Using</span> index <span class="keyword">condition</span>：查找使用了索引,但是需要回表查询数据</span><br><span class="line">#有些搜索条件中虽然出现了索引列，但却不能使用到索引</span><br><span class="line">#索引条件下推  <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line">#先找key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> 再找key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span>，最后回表 <span class="operator">*</span>， 优化 key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span>  再回表 <span class="operator">*</span> 最后 key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> <span class="keyword">AND</span> key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">363</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>using where; using index的组合：</code></p>
<ul>
<li>查找使用了索引，但是需要的数据都在索引列中能找到，所以不需要回表查询数据</li>
</ul>
</li>
<li><p><code>Using join buffer (Block Nested Loop)</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> # 在连接查询执行过程中，当被驱动表不能有效的利用索引加快访问速度，MySQL一般会为</span><br><span class="line"> # 其分配一块名叫`<span class="keyword">join</span> buffer`的内存块来加快查询速度，也就是我们所讲的`基于块的嵌套循环算法`</span><br><span class="line"> # <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (hash <span class="keyword">join</span>)</span><br><span class="line"> mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.common_field <span class="operator">=</span> s2.common_field\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Not exists</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> #当我们使用左（外）连接时，如果`<span class="keyword">WHERE</span>`子句中包含要求被驱动表的某个列等于`<span class="keyword">NULL</span>`值的搜索条件，</span><br><span class="line"> #而且那个列又是不允许存储`<span class="keyword">NULL</span>`值的，那么在该表的执行计划的Extra列就会提示`<span class="keyword">Not</span> <span class="keyword">exists</span>`额外信息 <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Not</span> <span class="keyword">exists</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key1 <span class="keyword">WHERE</span> s2.id <span class="keyword">IS</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s1.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Not</span> <span class="keyword">exists</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Using intersect(…) 、 Using union(…) 和 Using sort_union(…)</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 如果执行计划的`Extra`列出现了`<span class="keyword">Using</span> <span class="keyword">intersect</span>(...)`提示，说明准备使用`<span class="keyword">Intersect</span>`索引</span><br><span class="line"># 合并的方式执行查询，括号中的`...`表示需要进行索引合并的索引名称；</span><br><span class="line"># 如果出现了`<span class="keyword">Using</span> <span class="keyword">union</span>(...)`提示，说明准备使用`<span class="keyword">Union</span>`索引合并的方式执行查询；</span><br><span class="line"># 出现了`<span class="keyword">Using</span> sort_union(...)`提示，说明准备使用`Sort<span class="operator">-</span><span class="keyword">Union</span>`索引合并的方式执行查询。  <span class="keyword">Using</span> <span class="keyword">union</span>(idx_key1,idx_key3); <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">OR</span> key3 <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index_merge</span><br><span class="line">possible_keys: idx_key1,idx_key3</span><br><span class="line">          key: idx_key1,idx_key3</span><br><span class="line">      key_len: <span class="number">303</span>,<span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">union</span>(idx_key1,idx_key3); <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Zero limit</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 当我们的`LIMIT`子句的参数为`<span class="number">0</span>`时，表示压根儿不打算从表中读出任何记录，将会提示该额外信息 Zero limit</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 LIMIT <span class="number">0</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="keyword">NULL</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">NULL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="keyword">NULL</span></span><br><span class="line">     filtered: <span class="keyword">NULL</span></span><br><span class="line">        Extra: Zero limit</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Using filesort</code></p>
<ul>
<li><p>有一些情况下<strong>对结果集中的记录进行排序是可以使用到索引的</strong>，比如下边这个查询：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 有一些情况下对结果集中的记录进行排序是可以使用到索引的。 <span class="keyword">NULL</span></span><br><span class="line"># 比如：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> key1 LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这个查询语句可以利用<strong>idx_key1</strong>索引直接取出<strong>key1</strong>列的<strong>10</strong>条记录，然后再进行<strong>回表</strong>操作就好了，但是很多情况下排序操作无法使用到索引，只能在内存中(记录较少的时候）或名磁盘中，(记录较多的时候）进行排序，MySQL把这种在内存中或者磁盘上进行排序的方式统称为文件排序〔英文名∶ <strong>filesort</strong> )。如果某个查询需要使用文件排序的方式执行查询，就会在执行计划的Extra列中显示<strong>Using filesort</strong>提示，比如这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 很多情况下排序操作无法使用到索引，只能在内存中（记录较少的时候）或者磁盘中（记录较多的时候）</span><br><span class="line"># 进行排序，MySQL把这种在内存中或者磁盘上进行排序的方式统称为文件排序（英文名：`filesort`）。</span><br><span class="line"> </span><br><span class="line"># 如果某个查询需要使用文件排序的方式执行查询，就会在执行计划的`Extra`列中显示`<span class="keyword">Using</span> filesort`提示 </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">ORDER</span> <span class="keyword">BY</span> common_field LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><code>Using temporary</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># 在许多查询的执行过程中，MySQL可能会借助临时表来完成一些功能，比如去重、排序之类的，比如我们</span><br><span class="line"># 在执行许多包含`<span class="keyword">DISTINCT</span>`、`<span class="keyword">GROUP</span> <span class="keyword">BY</span>`、`<span class="keyword">UNION</span>`等子句的查询过程中，如果不能有效利用索引来完成</span><br><span class="line"># 查询，MySQL很有可能寻求通过建立内部的临时表来执行查询。如果查询中使用到了内部的临时表，在执行</span><br><span class="line"># 计划的`Extra`列将会显示`<span class="keyword">Using</span> temporary`提示</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> common_field <span class="keyword">FROM</span> s1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># EXPLAIN <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> key1 <span class="keyword">FROM</span> s1;</span><br><span class="line"> </span><br><span class="line"># 同上</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> common_field, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> amount <span class="keyword">FROM</span> s1 <span class="keyword">GROUP</span> <span class="keyword">BY</span> common_field\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> temporary; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 执行计划中出现`<span class="keyword">Using</span> temporary`并不是一个好的征兆，因为建立与维护临时表要付出很大成本的，所以</span><br><span class="line"># 我们`最好能使用索引来替代掉使用临时表`。比如：扫描指定的索引idx_key1即可  <span class="keyword">Using</span> index</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> key1, <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">AS</span> amount <span class="keyword">FROM</span> s1 <span class="keyword">GROUP</span> <span class="keyword">BY</span> key1\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="12-小结"><a href="#12-小结" class="headerlink" title="12.小结"></a>12.小结</h4></blockquote>
<ul>
<li>EXPLAIN不考各种Cache</li>
<li>EXPLAIN不能显示MySQL在执行查询时所作的优化工作</li>
<li>EXPLAIN不会告诉你关于触发器、存储过程的信息或用户自定义函数对查询的影响情况</li>
<li>部分统计信息是估算的，并非精确值</li>
</ul>
<h3 id="7-4-7-EXPLAIN的进一步使用"><a href="#7-4-7-EXPLAIN的进一步使用" class="headerlink" title="7.4.7 EXPLAIN的进一步使用"></a>7.4.7 EXPLAIN的进一步使用</h3><h4 id="7-4-7-1-EXPLAIN四种输出格式"><a href="#7-4-7-1-EXPLAIN四种输出格式" class="headerlink" title="7.4.7.1 EXPLAIN四种输出格式"></a>7.4.7.1 EXPLAIN四种输出格式</h4><ul>
<li>EXPLAIN可以输出四种格式： <code>传统格式</code> ， <code>JSON格式</code> ， <code>TREE格式 </code>以及<code>可视化输出</code></li>
</ul>
<blockquote>
<h4 id="1-传统格式"><a href="#1-传统格式" class="headerlink" title="1. 传统格式"></a>1. 传统格式</h4></blockquote>
<ul>
<li><p>传统格式简单明了，输出是一个表格形式，概要说明查询计划</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> s1.key1, s2.key1 <span class="keyword">FROM</span> s1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key1 <span class="keyword">WHERE</span> s2.common_field <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">90.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s2.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="2-JSON格式"><a href="#2-JSON格式" class="headerlink" title="2. JSON格式"></a>2. JSON格式</h4></blockquote>
<ul>
<li><p>第1种格式中介绍的<code>EXPLAIN</code>语句输出中缺少了一个衡量执行计划好坏的重要属性——<code>成本</code>。而JSON格式是四种格式里面输出<code>信息最详尽</code>的格式，里面包含了执行的成本信息</p>
</li>
<li><p>JSON格式：在EXPLAIN单词和真正的查询语句中间加上 <strong>FORMAT&#x3D;JSON</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN FORMAT<span class="operator">=</span>JSON <span class="keyword">SELECT</span> ...</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>EXPLAIN的column与JSON的对应关系：</strong></p>
</li>
<li><p>这样就可以得到一个json格式的执行计划，里面包含该计划花费的成本，比如这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#json格式的explain</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN FORMAT<span class="operator">=</span>JSON <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key2 </span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">WHERE</span> s1.common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">EXPLAIN: &#123;</span><br><span class="line">  &quot;query_block&quot;: &#123;</span><br><span class="line">    &quot;select_id&quot;: <span class="number">1</span>,</span><br><span class="line">    &quot;cost_info&quot;: &#123;</span><br><span class="line">      &quot;query_cost&quot;: &quot;3263.40&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;nested_loop&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;table&quot;: &#123;</span><br><span class="line">          &quot;table_name&quot;: &quot;s1&quot;,</span><br><span class="line">          &quot;access_type&quot;: &quot;ALL&quot;,</span><br><span class="line">          &quot;possible_keys&quot;: [</span><br><span class="line">            &quot;idx_key1&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;rows_examined_per_scan&quot;: <span class="number">9895</span>,</span><br><span class="line">          &quot;rows_produced_per_join&quot;: <span class="number">989</span>,</span><br><span class="line">          &quot;filtered&quot;: &quot;10.00&quot;,</span><br><span class="line">          &quot;cost_info&quot;: &#123;</span><br><span class="line">            &quot;read_cost&quot;: &quot;1878.10&quot;,</span><br><span class="line">            &quot;eval_cost&quot;: &quot;197.90&quot;,</span><br><span class="line">            &quot;prefix_cost&quot;: &quot;2076.00&quot;,</span><br><span class="line">            &quot;data_read_per_join&quot;: &quot;1M&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;used_columns&quot;: [</span><br><span class="line">            &quot;id&quot;,</span><br><span class="line">            &quot;key1&quot;,</span><br><span class="line">            &quot;key2&quot;,</span><br><span class="line">            &quot;key3&quot;,</span><br><span class="line">            &quot;key_part1&quot;,</span><br><span class="line">            &quot;key_part2&quot;,</span><br><span class="line">            &quot;key_part3&quot;,</span><br><span class="line">            &quot;common_field&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;attached_condition&quot;: &quot;((`atguigudb1`.`s1`.`common_field` = &#x27;a&#x27;) and (`atguigudb1`.`s1`.`key1` is not null))&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;table&quot;: &#123;</span><br><span class="line">          &quot;table_name&quot;: &quot;s2&quot;,</span><br><span class="line">          &quot;access_type&quot;: &quot;ref&quot;,</span><br><span class="line">          &quot;possible_keys&quot;: [</span><br><span class="line">            &quot;idx_key2&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;key&quot;: &quot;idx_key2&quot;,</span><br><span class="line">          &quot;used_key_parts&quot;: [</span><br><span class="line">            &quot;key2&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;key_length&quot;: &quot;5&quot;,</span><br><span class="line">          &quot;ref&quot;: [</span><br><span class="line">            &quot;atguigudb1.s1.key1&quot;</span><br><span class="line">          ],</span><br><span class="line">          &quot;rows_examined_per_scan&quot;: <span class="number">1</span>,</span><br><span class="line">          &quot;rows_produced_per_join&quot;: <span class="number">989</span>,</span><br><span class="line">          &quot;filtered&quot;: &quot;100.00&quot;,</span><br><span class="line">          &quot;index_condition&quot;: &quot;(`atguigudb1`.`s1`.`key1` = `atguigudb1`.`s2`.`key2`)&quot;,</span><br><span class="line">          &quot;cost_info&quot;: &#123;</span><br><span class="line">            &quot;read_cost&quot;: &quot;989.50&quot;,</span><br><span class="line">            &quot;eval_cost&quot;: &quot;197.90&quot;,</span><br><span class="line">            &quot;prefix_cost&quot;: &quot;3263.40&quot;,</span><br><span class="line">            &quot;data_read_per_join&quot;: &quot;1M&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;used_columns&quot;: [</span><br><span class="line">            &quot;id&quot;,</span><br><span class="line">            &quot;key1&quot;,</span><br><span class="line">            &quot;key2&quot;,</span><br><span class="line">            &quot;key3&quot;,</span><br><span class="line">            &quot;key_part1&quot;,</span><br><span class="line">            &quot;key_part2&quot;,</span><br><span class="line">            &quot;key_part3&quot;,</span><br><span class="line">            &quot;common_field&quot;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">2</span> warnings (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>#</code>后边跟随注释的形式为大家解释了 <code>EXPLAIN FORMAT=JSON</code> 语句的输出内容，但是大家可能有疑问 “<code>cost_info</code>” 里边的成本看着怪怪的，它们是怎么计算出来的？先看<code> s1</code> 表的 “<code>cost_info</code>” 部分：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;cost_info&quot;: &#123;</span><br><span class="line">            &quot;read_cost&quot;: &quot;1878.10&quot;,</span><br><span class="line">            &quot;eval_cost&quot;: &quot;197.90&quot;,</span><br><span class="line">            &quot;prefix_cost&quot;: &quot;2076.00&quot;,</span><br><span class="line">            &quot;data_read_per_join&quot;: &quot;1M&quot;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>read_cost</code> 是由下边这两部分组成的：</p>
<ul>
<li>IO 成本</li>
<li>检测 <code>rows × (1 - filter)</code> 条记录的 CPU 成本</li>
</ul>
</li>
<li><p><code>eval_cost</code> 是这样计算的：检测 rows × filter 条记录的成本</p>
</li>
<li><p><code>prefix_cost</code> 就是单独查询 s1 表的成本，也就是：read_cost + eval_cost</p>
</li>
<li><p><code>data_read_per_join</code> 表示在此次查询中需要读取的数据量</p>
</li>
<li><p>对于<code> s2</code> 表的 “cost_info” 部分是这样的：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;cost_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;read_cost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;989.50&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;eval_cost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;197.90&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;prefix_cost&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3263.40&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;data_read_per_join&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1M&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>由于 s2 表是被驱动表，所以可能被读取多次，这里的 read_cost 和 eval_cost 是访问多次 s2 表后累加起来的值，大家主要关注里边儿的 prefix_cost 的值代表的是整个连接查询预计的成本，也就是单次查询 s1 表和多次查询 s2 表后的成本的和</p>
</li>
</ul>
<blockquote>
<h4 id="3-TREE格式"><a href="#3-TREE格式" class="headerlink" title="3. TREE格式"></a>3. TREE格式</h4></blockquote>
<ul>
<li><p>TREE格式是8.0.16版本之后引入的新格式，主要根据查询的 <code>各个部分之间的关系</code> 和 <code>各部分的执行顺序</code> 来描述如何查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN FORMAT<span class="operator">=</span>tree <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">INNER</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key2 <span class="keyword">WHERE</span></span><br><span class="line">s1.common_field <span class="operator">=</span> <span class="string">&#x27;a&#x27;</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*************************** 1. row ***************************</span></span><br><span class="line"><span class="comment">EXPLAIN: -&gt; Nested loop inner join  (cost=1360.08 rows=990)</span></span><br><span class="line"><span class="comment">    -&gt; Filter: ((s1.common_field = &#x27;a&#x27;) and (s1.key1 is not null))  (cost=1013.75 rows=990)</span></span><br><span class="line"><span class="comment">        -&gt; Table scan on s1  (cost=1013.75 rows=9895)</span></span><br><span class="line"><span class="comment">    -&gt; Single-row index lookup on s2 using idx_key2 (key2=s1.key1), with index condition: (cast(s1.key1 as double) = cast(s2.key2 as double))  (cost=0.25 rows=1)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h4 id="4-可视化输出"><a href="#4-可视化输出" class="headerlink" title="4. 可视化输出"></a>4. 可视化输出</h4></blockquote>
<ul>
<li><p>可视化输出，可以通过MySQL Workbench可视化查看MySQL的执行计划。通过点击Workbench的放大镜图标，即可生成可视化的查询计划</p>
<p><img src="image-20221205171138154.png" alt="MySQL之性能优化/image-20221205171138154"></p>
</li>
<li><p>上图按从左到右的连接顺序显示表。红色框表示 <code>全表扫描</code> ，而绿色框表示使用 <code>索引查找 </code>。对于每个表，显示使用的索引。还要注意的是，每个表格的框上方是每个表访问所发现的行数的估计值以及访问该表的成本</p>
</li>
</ul>
<h4 id="7-4-7-2-SHOW-WARNINGS的使用"><a href="#7-4-7-2-SHOW-WARNINGS的使用" class="headerlink" title="7.4.7.2 SHOW WARNINGS的使用"></a>7.4.7.2 SHOW WARNINGS的使用</h4><ul>
<li><p>在使用<code>EXPLAIN</code>语句查看了某个查询的执行计划后，紧接着还可以使用<code>SHOW WARNINGS</code>语句查看与这个查询的执行计划有关的一些扩展信息，比如这样</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># Message后的“语句”可以近似看作真正执行的情况</span><br><span class="line"># 通常通过<span class="keyword">SHOW</span> WARNINGS可以看到优化器对查询语句的重写和优化</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> s1.key1, s2.key1 <span class="keyword">FROM</span> s1 <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> s2 <span class="keyword">ON</span> s1.key1 <span class="operator">=</span> s2.key1 <span class="keyword">WHERE</span> s2.common_field <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s2</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9895</span></span><br><span class="line">     filtered: <span class="number">90.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb1.s2.key1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> WARNINGS\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">  Level: Note</span><br><span class="line">   Code: <span class="number">1003</span></span><br><span class="line">Message: <span class="comment">/* select#1 */</span> <span class="keyword">select</span> `atguigudb1`.`s1`.`key1` <span class="keyword">AS</span> `key1`,`atguigudb1`.`s2`.`key1` <span class="keyword">AS</span> `key1` <span class="keyword">from</span> `atguigudb1`.`s1` <span class="keyword">join</span> `atguigudb1`.`s2` <span class="keyword">where</span> ((`atguigudb1`.`s1`.`key1` <span class="operator">=</span> `atguigudb1`.`s2`.`key1`) <span class="keyword">and</span> (`atguigudb1`.`s2`.`common_field` <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>))</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到 <strong>SHOW WARNINGS</strong> 展示出来的信息有三个字段，分别是<strong>Level</strong>、<strong>Code</strong> 、<strong>Message</strong>。最常见的就是code为1003的信息，当Code信为1003时,Message字段展示的信息类似于查询优化器将查询语句重写后的语句。比如上边的查询本来是一个左(外）连接查询，但是有一个s2.common_field IS NOT NULL的条件，这就会导致查询优化器把左（外〉连接查询优化为内连接查询，从SHOW WARNINGS的 Message字段也可以看出来，原本的LEFTJOIN已经变成了JOIN</p>
</li>
<li><p><strong>小结</strong>：通过<strong>SHOW WARNINGS</strong>可以看到优化器对查询语句的重写和优化</p>
</li>
</ul>
<h3 id="7-4-8-分析优化器执行计划：trace"><a href="#7-4-8-分析优化器执行计划：trace" class="headerlink" title="7.4.8 分析优化器执行计划：trace"></a>7.4.8 分析优化器执行计划：trace</h3><ul>
<li><p><strong>OPTIMIZER_TRACE</strong> 是MySQL 5.6引入的一项跟踪功能，它可以跟踪优化器做出的各种决策〈比如访问表的方法、各种开销计算、各种转换等)，并将跟踪结果记录到<strong>INFORMATION_SCHEMA.OPTIMIZER_TRACE</strong>表中</p>
</li>
<li><p>此功能默认关闭。开启trace，并设置格式为JSON，同时设置trace最大能够使用的内存大小，避免解析过程中因为默认内存过小而不能够完整展示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#开启trace</span><br><span class="line"><span class="keyword">SET</span> optimizer_trace<span class="operator">=</span>&quot;enabled=on&quot;,end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"></span><br><span class="line">#设置trace最大能够使用的内存大小：</span><br><span class="line"><span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> optimizer_trace<span class="operator">=</span>&quot;enabled=on&quot;,end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>开启后，可分析如下语句：</p>
<ul>
<li>SELECT</li>
<li>INSERT</li>
<li>REPLACE</li>
<li>UPDATE</li>
<li>DELETE</li>
<li>EXPLAIN</li>
<li>SET</li>
<li>DECLARE</li>
<li>CASE</li>
<li>IF</li>
<li>RETURN</li>
<li>CALL</li>
</ul>
</li>
<li><p>测试：执行如下SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">10</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">100002</span> <span class="operator">|</span> OegrrH <span class="operator">|</span>   <span class="number">33</span> <span class="operator">|</span>     <span class="number">351</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> <span class="number">100003</span> <span class="operator">|</span> XJEVPm <span class="operator">|</span>   <span class="number">81</span> <span class="operator">|</span>     <span class="number">252</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> <span class="number">100004</span> <span class="operator">|</span> SBdNJS <span class="operator">|</span>   <span class="number">46</span> <span class="operator">|</span>     <span class="number">418</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> <span class="number">100005</span> <span class="operator">|</span> TeTeRU <span class="operator">|</span>   <span class="number">99</span> <span class="operator">|</span>     <span class="number">223</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> <span class="number">100006</span> <span class="operator">|</span> gaIqBM <span class="operator">|</span>   <span class="number">19</span> <span class="operator">|</span>     <span class="number">315</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> <span class="number">100007</span> <span class="operator">|</span> ljoPht <span class="operator">|</span>   <span class="number">47</span> <span class="operator">|</span>     <span class="number">940</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7</span> <span class="operator">|</span> <span class="number">100008</span> <span class="operator">|</span> xzbLzp <span class="operator">|</span>   <span class="number">14</span> <span class="operator">|</span>     <span class="number">319</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> <span class="number">100009</span> <span class="operator">|</span> wkMfrq <span class="operator">|</span>   <span class="number">64</span> <span class="operator">|</span>      <span class="number">27</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> <span class="number">100010</span> <span class="operator">|</span> pyvKon <span class="operator">|</span>   <span class="number">49</span> <span class="operator">|</span>     <span class="number">413</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.08</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后， 查询 <strong>information_schema.optimizer_trace</strong> 就可以知道MySQL是如何执行SQL的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace\G</span><br><span class="line">###输出结果：</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>第<span class="number">1</span>部分：查询语句</span><br><span class="line">QUERY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">10</span></span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>第<span class="number">2</span>部分：QUERY字段对应语句的跟踪信息</span><br><span class="line">TRACE: &#123;</span><br><span class="line">&quot;steps&quot;: [</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;join_preparation&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>预备工作</span><br><span class="line">			&quot;select#&quot;: <span class="number">1</span>,</span><br><span class="line">			&quot;steps&quot;: [</span><br><span class="line">				&#123;</span><br><span class="line">					&quot;expanded_query&quot;: &quot;/* select#1 */ select `student`.`id` AS</span><br><span class="line">					`id`,`student`.`stuno` AS `stuno`,`student`.`name` AS `name`,`student`.`age` AS</span><br><span class="line">					`age`,`student`.`classId` AS `classId` from `student` where (`student`.`id` &lt; 10)&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			] <span class="comment">/* steps */</span></span><br><span class="line">		&#125; <span class="comment">/* join_preparation */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;join_optimization&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>进行优化</span><br><span class="line">		&quot;select#&quot;: <span class="number">1</span>,</span><br><span class="line">		&quot;steps&quot;: [</span><br><span class="line">				&#123;</span><br><span class="line">				&quot;condition_processing&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>条件处理</span><br><span class="line">					&quot;condition&quot;: &quot;WHERE&quot;,</span><br><span class="line">					&quot;original_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">					&quot;steps&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;transformation&quot;: &quot;equality_propagation&quot;,</span><br><span class="line">							&quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;transformation&quot;: &quot;constant_propagation&quot;,</span><br><span class="line">							&quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">						&#125;,</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;transformation&quot;: &quot;trivial_condition_removal&quot;,</span><br><span class="line">							&quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					] <span class="comment">/* steps */</span></span><br><span class="line">				&#125; <span class="comment">/* condition_processing </span></span><br><span class="line"><span class="comment">			] /* steps */</span></span><br><span class="line">		&#125; <span class="comment">/* condition_processing */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;substitute_generated_columns&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>替换生成的列</span><br><span class="line">	&#125; <span class="comment">/* substitute_generated_columns */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;table_dependencies&quot;: [ <span class="operator">/</span><span class="operator">/</span>表的依赖关系</span><br><span class="line">			&#123;</span><br><span class="line">				&quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">				&quot;row_may_be_null&quot;: <span class="literal">false</span>,</span><br><span class="line">				&quot;map_bit&quot;: <span class="number">0</span>,</span><br><span class="line">				&quot;depends_on_map_bits&quot;: [</span><br><span class="line">				] <span class="comment">/* depends_on_map_bits */</span></span><br><span class="line">			&#125;</span><br><span class="line">		] <span class="comment">/* table_dependencies */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;ref_optimizer_key_uses&quot;: [ <span class="operator">/</span><span class="operator">/</span>使用键</span><br><span class="line">		] <span class="comment">/* ref_optimizer_key_uses */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;rows_estimation&quot;: [ <span class="operator">/</span><span class="operator">/</span>行判断</span><br><span class="line">				&#123;</span><br><span class="line">					&quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">					&quot;range_analysis&quot;: &#123;</span><br><span class="line">					&quot;table_scan&quot;: &#123;</span><br><span class="line">					&quot;rows&quot;: <span class="number">3973767</span>,</span><br><span class="line">					&quot;cost&quot;: <span class="number">408558</span></span><br><span class="line">				&#125; <span class="comment">/* table_scan */</span>, <span class="operator">/</span><span class="operator">/</span>扫描表</span><br><span class="line">				&quot;potential_range_indexes&quot;: [ <span class="operator">/</span><span class="operator">/</span>潜在的范围索引</span><br><span class="line">					&#123;</span><br><span class="line">						&quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">						&quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">						&quot;key_parts&quot;: [</span><br><span class="line">							&quot;id&quot;</span><br><span class="line">						] <span class="comment">/* key_parts */</span></span><br><span class="line">					&#125;</span><br><span class="line">				] <span class="comment">/* potential_range_indexes */</span>,</span><br><span class="line">				&quot;setup_range_conditions&quot;: [ <span class="operator">/</span><span class="operator">/</span>设置范围条件</span><br><span class="line">				] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">				&quot;group_index_range&quot;: &#123;</span><br><span class="line">					&quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">					&quot;cause&quot;: &quot;not_group_by_or_distinct&quot;</span><br><span class="line">				&#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">				&quot;skip_scan_range&quot;: &#123;</span><br><span class="line">					&quot;potential_skip_scan_indexes&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">						&quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">						&quot;usable&quot;: <span class="literal">false</span>,</span><br><span class="line">						&quot;cause&quot;: &quot;query_references_nonkey_column&quot;</span><br><span class="line">						&#125;</span><br><span class="line">					] <span class="comment">/* potential_skip_scan_indexes */</span></span><br><span class="line">				&#125; <span class="comment">/* skip_scan_range */</span>,</span><br><span class="line">				&quot;analyzing_range_alternatives&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>分析范围选项</span><br><span class="line">					&quot;range_scan_alternatives&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">							&quot;ranges&quot;: [</span><br><span class="line">								&quot;id &lt; 10&quot;</span><br><span class="line">							] <span class="comment">/* ranges */</span>,</span><br><span class="line">							&quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">							&quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">			&quot;				using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">							&quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">							&quot;rows&quot;: <span class="number">9</span>,</span><br><span class="line">							&quot;cost&quot;: <span class="number">1.91986</span>,</span><br><span class="line">							&quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">						&#125;</span><br><span class="line">					] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">					&quot;analyzing_roworder_intersect&quot;: &#123;</span><br><span class="line">						&quot;usable&quot;: <span class="literal">false</span>,</span><br><span class="line">						&quot;cause&quot;: &quot;too_few_roworder_scans&quot;</span><br><span class="line">					&#125; <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">				&#125; <span class="comment">/* analyzing_range_alternatives */</span>,</span><br><span class="line">				&quot;chosen_range_access_summary&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>选择范围访问摘要</span><br><span class="line">					&quot;range_access_plan&quot;: &#123;</span><br><span class="line">						&quot;type&quot;: &quot;range_scan&quot;,</span><br><span class="line">						&quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">						&quot;rows&quot;: <span class="number">9</span>,</span><br><span class="line">						&quot;ranges&quot;: [</span><br><span class="line">							&quot;id &lt; 10&quot;</span><br><span class="line">						] <span class="comment">/* ranges */</span></span><br><span class="line">					&#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">					&quot;rows_for_plan&quot;: <span class="number">9</span>,</span><br><span class="line">					&quot;cost_for_plan&quot;: <span class="number">1.91986</span>,</span><br><span class="line">					&quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">				&#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">			&#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">		&#125;</span><br><span class="line">	] <span class="comment">/* rows_estimation */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;considered_execution_plans&quot;: [ <span class="operator">/</span><span class="operator">/</span>考虑执行计划</span><br><span class="line">			&#123;</span><br><span class="line">				&quot;plan_prefix&quot;: [</span><br><span class="line">				] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">				&quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">				&quot;best_access_path&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>最佳访问路径</span><br><span class="line">					&quot;considered_access_paths&quot;: [</span><br><span class="line">						&#123;</span><br><span class="line">							&quot;rows_to_scan&quot;: <span class="number">9</span>,</span><br><span class="line">							&quot;access_type&quot;: &quot;range&quot;,</span><br><span class="line">							&quot;range_details&quot;: &#123;</span><br><span class="line">								&quot;used_index&quot;: &quot;PRIMARY&quot;</span><br><span class="line">							&#125; <span class="comment">/* range_details */</span>,</span><br><span class="line">							&quot;resulting_rows&quot;: <span class="number">9</span>,</span><br><span class="line">							&quot;cost&quot;: <span class="number">2.81986</span>,</span><br><span class="line">							&quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">						&#125;</span><br><span class="line">					] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">				&#125; <span class="comment">/* best_access_path */</span>,</span><br><span class="line">				&quot;condition_filtering_pct&quot;: <span class="number">100</span>, <span class="operator">/</span><span class="operator">/</span>行过滤百分比</span><br><span class="line">				&quot;rows_for_plan&quot;: <span class="number">9</span>,</span><br><span class="line">				&quot;cost_for_plan&quot;: <span class="number">2.81986</span>,</span><br><span class="line">				&quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">		] <span class="comment">/* considered_execution_plans */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;attaching_conditions_to_tables&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>将条件附加到表上</span><br><span class="line">			&quot;original_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">			&quot;attached_conditions_computation&quot;: [</span><br><span class="line">			] <span class="comment">/* attached_conditions_computation */</span>,</span><br><span class="line">			&quot;attached_conditions_summary&quot;: [ <span class="operator">/</span><span class="operator">/</span>附加条件概要</span><br><span class="line">				&#123;</span><br><span class="line">				&quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">				&quot;attached&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">				&#125;</span><br><span class="line">			] <span class="comment">/* attached_conditions_summary */</span></span><br><span class="line">		&#125; <span class="comment">/* attaching_conditions_to_tables */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;finalizing_table_conditions&quot;: [</span><br><span class="line">			&#123;</span><br><span class="line">				&quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">				&quot;original_table_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">				&quot;final_table_condition &quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		] <span class="comment">/* finalizing_table_conditions */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">	&quot;refine_plan&quot;: [ <span class="operator">/</span><span class="operator">/</span>精简计划</span><br><span class="line">		&#123;</span><br><span class="line">		&quot;table&quot;: &quot;`student`&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	] <span class="comment">/* refine_plan */</span></span><br><span class="line">	&#125;</span><br><span class="line">	] <span class="comment">/* steps */</span></span><br><span class="line">	&#125; <span class="comment">/* join_optimization */</span></span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		&quot;join_execution&quot;: &#123; <span class="operator">/</span><span class="operator">/</span>执行</span><br><span class="line">		&quot;select#&quot;: <span class="number">1</span>,</span><br><span class="line">		&quot;steps&quot;: [</span><br><span class="line">		] <span class="comment">/* steps */</span></span><br><span class="line">		&#125; <span class="comment">/* join_execution */</span></span><br><span class="line">	&#125;</span><br><span class="line">] <span class="comment">/* steps */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>第<span class="number">3</span>部分：跟踪信息过长时，被截断的跟踪信息的字节数。</span><br><span class="line">            </span><br><span class="line">MISSING_BYTES_BEYOND_MAX_MEM_SIZE: <span class="number">0</span> <span class="operator">/</span><span class="operator">/</span>丢失的超出最大容量的字节</span><br><span class="line"><span class="operator">/</span><span class="operator">/</span>第<span class="number">4</span>部分：执行跟踪语句的用户是否有查看对象的权限。当不具有权限时，该列信息为<span class="number">1</span>且TRACE字段为空，一般在</span><br><span class="line"># 调用带有<span class="keyword">SQL</span> SECURITY DEFINER的视图或者是存储过程的情况下，会出现此问题。</span><br><span class="line">INSUFFICIENT_PRIVILEGES: <span class="number">0</span> <span class="operator">/</span><span class="operator">/</span>缺失权限</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="7-4-9-MySQL监控分析视图-sys-schema"><a href="#7-4-9-MySQL监控分析视图-sys-schema" class="headerlink" title="7.4.9 MySQL监控分析视图-sys schema"></a>7.4.9 MySQL监控分析视图-sys schema</h3><ul>
<li>关于MySQL的<strong>性能监控</strong>和<strong>问题诊断</strong>，一般都从<code>performance_schema</code>中去获取想要的数据，在MySQL5.7.7版本中新增<code>sys schema</code>，它将<code>performance_schema</code>和<code>information_schema</code>中的数据以更容易理解的方式总结归纳为”视图”，其目的就是为了<strong>降低查询performance_schema的复杂度</strong>，让DBA能够快遇的定位问题。下面看看这些库中都有哪些监控表和视图，学握了这些，在开发和运维的过程中就起到了事半功倍的效果</li>
</ul>
<h4 id="7-4-9-1-Sys-schema视图摘要"><a href="#7-4-9-1-Sys-schema视图摘要" class="headerlink" title="7.4.9.1 Sys schema视图摘要"></a>7.4.9.1 Sys schema视图摘要</h4><ul>
<li><p>1.主机相关：以<code>host_summary</code>开头，主要汇总了IO延迟的信息</p>
</li>
<li><p>2.<code>Innodb</code>相关：以<code>innodb</code>开头，汇总了<code>innodb buffer</code>信息和事务等待<code>innodb</code>锁的信息</p>
</li>
<li><p>3.I&#x2F;o相关：以<code>io</code>开头，汇总了等待<code>I/O、I/O</code>使用量情况</p>
</li>
<li><p>4.内存使用情况：以<code>memory</code>开头，从主机、线程、事件等角度展示内存的使用情况</p>
</li>
<li><p>5.连接与会话信息：<code>processlist</code>和<code>session</code>相关视图，总结了会话相关信息</p>
</li>
<li><p>6.表相关：以<code>schema_table</code>开头的视图，展示了表的统计信息</p>
</li>
<li><p>7.索引信息：统计了索引的使用情况，包含冗余索引和未使用的索引情况</p>
</li>
<li><p>8.语句相关：以<code>statement</code>开头，包含执行全表扫描、使用临时表、排序等的语句信息</p>
</li>
<li><p>9.用户相关：以<code>user</code>开头的视图，统计了用户使用的文件<code>I/O</code>、执行语句统计信息</p>
</li>
<li><p>10.等待事件相关信息：以<code>wait</code>开头，展示等待事件的延迟情况</p>
</li>
</ul>
<h4 id="7-4-9-2-Sys-schema视图使用场景"><a href="#7-4-9-2-Sys-schema视图使用场景" class="headerlink" title="7.4.9.2 Sys schema视图使用场景"></a>7.4.9.2 Sys schema视图使用场景</h4><ul>
<li><p><strong>索引情况</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> 查询冗余索引</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.schema_redundant_indexes;</span><br><span class="line">#<span class="number">2.</span> 查询未使用过的索引</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.schema_unused_indexes;</span><br><span class="line">#<span class="number">3.</span> 查询索引的使用情况</span><br><span class="line"><span class="keyword">select</span> index_name,rows_selected,rows_inserted,rows_updated,rows_deleted</span><br><span class="line"><span class="keyword">from</span> sys.schema_index_statistics <span class="keyword">where</span> table_schema<span class="operator">=</span><span class="string">&#x27;dbname&#x27;</span> ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>表相关</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">1.</span> 查询表的访问量</span><br><span class="line"><span class="keyword">select</span> table_schema,table_name,<span class="built_in">sum</span>(io_read_requests<span class="operator">+</span>io_write_requests) <span class="keyword">as</span> io <span class="keyword">from</span></span><br><span class="line">sys.schema_table_statistics <span class="keyword">group</span> <span class="keyword">by</span> table_schema,table_name <span class="keyword">order</span> <span class="keyword">by</span> io <span class="keyword">desc</span>;</span><br><span class="line"># <span class="number">2.</span> 查询占用bufferpool较多的表</span><br><span class="line"><span class="keyword">select</span> object_schema,object_name,allocated,data</span><br><span class="line"><span class="keyword">from</span> sys.innodb_buffer_stats_by_table <span class="keyword">order</span> <span class="keyword">by</span> allocated limit <span class="number">10</span>;</span><br><span class="line"># <span class="number">3.</span> 查看表的全表扫描情况</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.statements_with_full_table_scans <span class="keyword">where</span> db<span class="operator">=</span><span class="string">&#x27;dbname&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>语句相关</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> 监控<span class="keyword">SQL</span>执行的频率</span><br><span class="line"><span class="keyword">select</span> db,exec_count,query <span class="keyword">from</span> sys.statement_analysis</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> exec_count <span class="keyword">desc</span>;</span><br><span class="line">#<span class="number">2.</span> 监控使用了排序的<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> db,exec_count,first_seen,last_seen,query</span><br><span class="line"><span class="keyword">from</span> sys.statements_with_sorting limit <span class="number">1</span>;</span><br><span class="line">#<span class="number">3.</span> 监控使用了临时表或者磁盘临时表的<span class="keyword">SQL</span></span><br><span class="line"><span class="keyword">select</span> db,exec_count,tmp_tables,tmp_disk_tables,query</span><br><span class="line"><span class="keyword">from</span> sys.statement_analysis <span class="keyword">where</span> tmp_tables<span class="operator">&gt;</span><span class="number">0</span> <span class="keyword">or</span> tmp_disk_tables <span class="operator">&gt;</span><span class="number">0</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> (tmp_tables<span class="operator">+</span>tmp_disk_tables) <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>IO相关</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> 查看消耗磁盘IO的文件</span><br><span class="line"><span class="keyword">select</span> file,avg_read,avg_write,avg_read<span class="operator">+</span>avg_write <span class="keyword">as</span> avg_io</span><br><span class="line"><span class="keyword">from</span> sys.io_global_by_file_by_bytes <span class="keyword">order</span> <span class="keyword">by</span> avg_read limit <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Innodb 相关</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1.</span> 行锁阻塞情况</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.innodb_lock_waits</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>风险提示:<br>通过sys库去查询时，MySQL会<code>消耗大量资源</code>去收集相关信息，严重的可能会导致业务请求被阻塞，从而引起故障。建议生产上<code>不要频繁</code>的去查询sys或者performance_schema、information_schema来完成监控、巡检等工作</p>
</blockquote>
<h3 id="7-4-10-小结"><a href="#7-4-10-小结" class="headerlink" title="7.4.10 小结"></a>7.4.10 小结</h3><ul>
<li>查询是数据库中最频繁的操作，提高查询速度可以有效地提高MySQL数据库的性能。通过对查询语句的分析可以了解查询语句的执行能力。找出查询语句的瓶颈，从而优化查询语句</li>
</ul>
<h2 id="7-5-索引优化和查询优化"><a href="#7-5-索引优化和查询优化" class="headerlink" title="7.5 索引优化和查询优化"></a>7.5 索引优化和查询优化</h2><ul>
<li><p>都有哪些维度可以进行数据库调优?简言之:</p>
<ul>
<li>索引失效、没有充分利用到索引―索引建立</li>
<li>关联查询太多JOIN（设计缺陷或不得已的需求)――SQL优化</li>
<li>服务器调优及各个参数设置（缓冲、线程数等）――调整my.cnf</li>
<li>数据过多――分库分表</li>
</ul>
</li>
<li><p>关于数据库调优的知识点非常分散。不同的DBMS，不同的公司，不同的职位，不同的项目遇到的问题都不尽相同</p>
</li>
<li><p>虽然SQL查询优化的技术有很多，但是大方向上完全可以分成<strong>物理查询优化</strong>和<strong>逻辑查询优化</strong>两大块：</p>
<ul>
<li>物理查询优化是通过<strong>索引</strong>和<strong>表连接方式</strong>等技术来进行优化，这里重点需要掌握索引的使用</li>
<li>逻辑查询优化就是通过SQL<strong>等价变换</strong>提升查询效率，直白一点就是说，换一种查询写法执行效率可能更高</li>
</ul>
</li>
</ul>
<h3 id="7-5-1-数据准备"><a href="#7-5-1-数据准备" class="headerlink" title="7.5.1 数据准备"></a>7.5.1 数据准备</h3><ul>
<li><strong>学员表</strong>插 <strong>50万</strong>条，<strong>班级表</strong>插<strong>1万</strong>条</li>
</ul>
<blockquote>
<p><strong>步骤1：建表</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `class` (</span><br><span class="line">	`id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	`className` <span class="type">VARCHAR</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`address` <span class="type">VARCHAR</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`monitor` <span class="type">INT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">	`id` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	`stuno` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> ,</span><br><span class="line">	`name` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`age` <span class="type">INT</span>(<span class="number">3</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	`classId` <span class="type">INT</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">	#<span class="keyword">CONSTRAINT</span> `fk_class_id` <span class="keyword">FOREIGN</span> KEY (`classId`) <span class="keyword">REFERENCES</span> `t_class` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>步骤2：设置参数</strong></p>
</blockquote>
<ul>
<li><p>命令开启：允许创建函数设置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#让数据库服务器信任函数的创建，否则会报错</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_bin_trust_function_creators<span class="operator">=</span><span class="number">1</span>; # 不加<span class="keyword">global</span>只是当前窗口有效</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>步骤3：创建函数</strong></p>
</blockquote>
<ul>
<li><p>保证每条数据都不同</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#随机产生字符串</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_string(n <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> chars_str <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span></span><br><span class="line"><span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> return_str <span class="type">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">WHILE i <span class="operator">&lt;</span> n DO</span><br><span class="line"><span class="keyword">SET</span> return_str <span class="operator">=</span>CONCAT(return_str,<span class="built_in">SUBSTRING</span>(chars_str,<span class="built_in">FLOOR</span>(<span class="number">1</span><span class="operator">+</span>RAND()<span class="operator">*</span><span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">RETURN</span> return_str;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#假如要删除</span><br><span class="line">#<span class="keyword">drop</span> <span class="keyword">function</span> rand_string;</span><br></pre></td></tr></table></figure>
</li>
<li><p>随机产生班级编号</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#用于随机产生多少到多少的编号</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> rand_num (from_num <span class="type">INT</span> ,to_num <span class="type">INT</span>) <span class="keyword">RETURNS</span> <span class="type">INT</span>(<span class="number">11</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> <span class="built_in">FLOOR</span>(from_num <span class="operator">+</span>RAND()<span class="operator">*</span>(to_num <span class="operator">-</span> from_num<span class="operator">+</span><span class="number">1</span>)) ;</span><br><span class="line"><span class="keyword">RETURN</span> i;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#假如要删除</span><br><span class="line">#<span class="keyword">drop</span> <span class="keyword">function</span> rand_num;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>步骤4：创建存储过程</strong></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#创建往stu表中插入数据的存储过程</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> insert_stu( <span class="keyword">START</span> <span class="type">INT</span> , max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>; #设置手动提交事务</span><br><span class="line">REPEAT #循环</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>; #赋值</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student (stuno, name ,age ,classId ) <span class="keyword">VALUES</span></span><br><span class="line">((<span class="keyword">START</span><span class="operator">+</span>i),rand_string(<span class="number">6</span>),rand_num(<span class="number">1</span>,<span class="number">50</span>),rand_num(<span class="number">1</span>,<span class="number">1000</span>));</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>; #提交事务</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#假如要删除</span><br><span class="line">#<span class="keyword">drop</span> <span class="keyword">PROCEDURE</span> insert_stu;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#执行存储过程，往class表添加随机数据</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> `insert_class`( max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class ( classname,address,monitor ) <span class="keyword">VALUES</span></span><br><span class="line">(rand_string(<span class="number">8</span>),rand_string(<span class="number">10</span>),rand_num(<span class="number">1</span>,<span class="number">100000</span>));</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br><span class="line">#假如要删除</span><br><span class="line">#<span class="keyword">drop</span> <span class="keyword">PROCEDURE</span> insert_class;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>步骤5：调用存储过程</strong></p>
</blockquote>
<ul>
<li><p>class</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#执行存储过程，往class表添加<span class="number">1</span>万条数据</span><br><span class="line"><span class="keyword">CALL</span> insert_class(<span class="number">10000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>stu</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#执行存储过程，往stu表添加<span class="number">50</span>万条数据</span><br><span class="line"><span class="keyword">CALL</span> insert_stu(<span class="number">100000</span>,<span class="number">500000</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> class;	#<span class="number">10000</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student;	#<span class="number">500000</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>步骤6：删除某表上的索引</strong></p>
</blockquote>
<ul>
<li><p>创建存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span>  <span class="keyword">PROCEDURE</span> `proc_drop_index`(dbname <span class="type">VARCHAR</span>(<span class="number">200</span>),tablename <span class="type">VARCHAR</span>(<span class="number">200</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">       <span class="keyword">DECLARE</span> done <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">DECLARE</span> ct <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">DECLARE</span> _index <span class="type">VARCHAR</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">       <span class="keyword">DECLARE</span> _cur <span class="keyword">CURSOR</span> <span class="keyword">FOR</span>  <span class="keyword">SELECT</span>   index_name   <span class="keyword">FROM</span> information_schema.STATISTICS   <span class="keyword">WHERE</span> table_schema<span class="operator">=</span>dbname <span class="keyword">AND</span> table_name<span class="operator">=</span>tablename <span class="keyword">AND</span> seq_in_index<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span>    index_name <span class="operator">&lt;&gt;</span><span class="string">&#x27;PRIMARY&#x27;</span>  ;</span><br><span class="line">       #每个游标必须使用不同的<span class="keyword">declare</span> continue handler <span class="keyword">for</span> <span class="keyword">not</span> found <span class="keyword">set</span> done<span class="operator">=</span><span class="number">1</span>来控制游标的结束</span><br><span class="line">       <span class="keyword">DECLARE</span>  CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> done<span class="operator">=</span><span class="number">2</span> ;      </span><br><span class="line">       #若没有数据返回,程序继续,并将变量done设为<span class="number">2</span></span><br><span class="line">        <span class="keyword">OPEN</span> _cur;</span><br><span class="line">        <span class="keyword">FETCH</span> _cur <span class="keyword">INTO</span> _index;</span><br><span class="line">        WHILE  _index<span class="operator">&lt;&gt;</span><span class="string">&#x27;&#x27;</span> DO </span><br><span class="line">               <span class="keyword">SET</span> <span class="variable">@str</span> <span class="operator">=</span> CONCAT(&quot;drop index &quot; , _index , &quot; on &quot; , tablename ); </span><br><span class="line">               <span class="keyword">PREPARE</span> sql_str <span class="keyword">FROM</span> <span class="variable">@str</span> ;</span><br><span class="line">               <span class="keyword">EXECUTE</span>  sql_str;</span><br><span class="line">               <span class="keyword">DEALLOCATE</span> <span class="keyword">PREPARE</span> sql_str;</span><br><span class="line">               <span class="keyword">SET</span> _index<span class="operator">=</span><span class="string">&#x27;&#x27;</span>; </span><br><span class="line">               <span class="keyword">FETCH</span> _cur <span class="keyword">INTO</span> _index; </span><br><span class="line">        <span class="keyword">END</span> WHILE;</span><br><span class="line">   <span class="keyword">CLOSE</span> _cur;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> proc_drop_index(&quot;dbname&quot;,&quot;tablename&quot;);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="7-5-2-索引失效案例"><a href="#7-5-2-索引失效案例" class="headerlink" title="7.5.2 索引失效案例"></a>7.5.2 索引失效案例</h3><ul>
<li><p>MySQL中<strong>提高性能</strong>的一个最有效的方式是对数据表<strong>设计合理的索引</strong>。索引提供了高效访问数据的方法，并且加快查询的速度，因此索引对查询的速度有着至关重要的影响</p>
</li>
<li><p>使用索引可以<strong>快速地定位表中的某条记录</strong>，从而提高数据库查询的速度，提高数据库的性能</p>
</li>
<li><p>如果查询时没有使用索引，查询语句就会扫描表中的所有记录。在数据量大的情况下，这样查询的速度会很慢</p>
</li>
<li><p>大多数情况下都〈默认）采用<strong>B+树</strong>来构建索引。只是空间列类型的索引使用<strong>R-树</strong>，并且MEMORY表还支持<strong>hash索引</strong></p>
</li>
<li><p>其实，用不用索引，最终都是优化器说了算。优化器是基于什么的优化器?基于<strong>cost开销 (CostBaseOptimizer )<strong>，它不是基于</strong>规则(Rule-BasedOptimizer)<strong>，也不是基于</strong>语义</strong>。怎么样开销小就怎么来。另外，<strong>SQL语句是否使用索引，跟数据库版本、数据量、数据选择度都有关系</strong></p>
</li>
</ul>
<h4 id="7-5-2-1-全值匹配"><a href="#7-5-2-1-全值匹配" class="headerlink" title="7.5.2.1 全值匹配"></a>7.5.2.1 全值匹配</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">1</span>）全值匹配我最爱</span><br><span class="line"># 语句一：没有索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 语句二：没有索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> classId<span class="operator">=</span><span class="number">4</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">1.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 语句三：没有索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> classId<span class="operator">=</span><span class="number">4</span> <span class="keyword">AND</span> NAME <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">0.10</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> classId<span class="operator">=</span><span class="number">4</span> <span class="keyword">AND</span> NAME <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>;</span><br><span class="line"><span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.14</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#分别为student表创建三个索引：</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age <span class="keyword">ON</span> student(age);#索引一</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_classid <span class="keyword">ON</span> student(age,classId);#索引二</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_classid_name <span class="keyword">ON</span> student(age,classId,`name`);#索引三</span><br><span class="line"></span><br><span class="line">#显示student表上的索引</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">0</span></span><br><span class="line">     Key_name: <span class="keyword">PRIMARY</span></span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: id</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">499086</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: </span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: age</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">48</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age_classid</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: age</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">48</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age_classid</span><br><span class="line"> Seq_in_index: <span class="number">2</span></span><br><span class="line">  Column_name: classId</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">50587</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">5.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age_classid_name</span><br><span class="line"> Seq_in_index: <span class="number">1</span></span><br><span class="line">  Column_name: age</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">48</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">6.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age_classid_name</span><br><span class="line"> Seq_in_index: <span class="number">2</span></span><br><span class="line">  Column_name: classId</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">50750</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">7.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">        <span class="keyword">Table</span>: student</span><br><span class="line">   Non_unique: <span class="number">1</span></span><br><span class="line">     Key_name: idx_age_classid_name</span><br><span class="line"> Seq_in_index: <span class="number">3</span></span><br><span class="line">  Column_name: name</span><br><span class="line">    <span class="keyword">Collation</span>: A</span><br><span class="line">  <span class="keyword">Cardinality</span>: <span class="number">499063</span></span><br><span class="line">     Sub_part: <span class="keyword">NULL</span></span><br><span class="line">       Packed: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">Null</span>: YES</span><br><span class="line">   Index_type: BTREE</span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line"><span class="number">7</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 再次执行有索引的语句一：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span>\G</span><br><span class="line"># 使用了索引一：索引字段为age</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age,idx_age_classid,idx_age_classid_name</span><br><span class="line">          key: idx_age</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10051</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再次执行有索引的语句二：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> classId<span class="operator">=</span><span class="number">4</span>\G</span><br><span class="line"># 使用了索引二：索引字段为age、classId </span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age,idx_age_classid,idx_age_classid_name</span><br><span class="line">          key: idx_age_classid</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">11</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 再次执行有索引的语句三：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> classId<span class="operator">=</span><span class="number">4</span> <span class="keyword">AND</span> NAME <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>\G</span><br><span class="line"># 使用了索引三：索引字段为age、classId  、NAME</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age,idx_age_classid,idx_age_classid_name</span><br><span class="line">          key: idx_age_classid_name</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#全值匹配表示索引列和查询条件的字段全部匹配，精度高，key_len长度大</span><br><span class="line">#结论：</span><br><span class="line">#当创建多个索引时，查询优化器通常会选取和查询字段匹配度最高的索引</span><br><span class="line">#因为匹配度越高，查询效率越快</span><br><span class="line">#此时除被选中的索引外，其它索引失效</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>补充：</strong>上面SQL语句中<code>SQL_NO_CACHE</code>的使用保证不存在查询缓存，使各语句的比较不受“是否缓存”的影响，从而达到了“控制变量”的目的</li>
</ul>
<h4 id="7-5-2-2-最佳左前缀法则"><a href="#7-5-2-2-最佳左前缀法则" class="headerlink" title="7.5.2.2 最佳左前缀法则"></a>7.5.2.2 最佳左前缀法则</h4><ul>
<li><p>在MySQL建立联合索引时会遵守最佳左前缀匹配原则，即最左优先，在检索数据时从联合索引的最左边开始匹配</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">2</span>）最佳左前缀法则</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student.age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>\G</span><br><span class="line"># 使用了索引一：索引字段为age</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age,idx_age_classid,idx_age_classid_name</span><br><span class="line">          key: idx_age</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10051</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student.classid<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  没有使用索引：因为没有classid索引、也没有（classid、name）索引</span></span><br><span class="line"><span class="comment">  没有使用(age,classId,name)索引的原因：不符合最佳左前缀法则</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">1.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student  <span class="keyword">WHERE</span> classid<span class="operator">=</span><span class="number">4</span> <span class="keyword">AND</span> student.age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abcd&#x27;</span>\G</span><br><span class="line"># 使用了索引三(age,classId,name)：索引字段为age、classId、name</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age,idx_age_classid,idx_age_classid_name</span><br><span class="line">          key: idx_age_classid_name</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>结论：MySQL可以为多个字段创建索引，一个索引可以包括16个字段。对于多列索引，<strong>过滤条件要使用索引必须按照索引建立时的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用</strong>。如果查询条件中没有使用这些字段中第1个字段时，多列(或联合)索引不会被使用</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>拓展: Alibaba 《Java开发手册》</strong></p>
<p>索引文件具有B-Tree的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引</p>
</blockquote>
<h4 id="7-5-2-3-主键插入顺序"><a href="#7-5-2-3-主键插入顺序" class="headerlink" title="7.5.2.3 主键插入顺序"></a>7.5.2.3 主键插入顺序</h4><ul>
<li><p>对于一个使用<strong>InnoDB</strong>存储引擎的表来说，在没有显式的创建索引时，表中的数据实际上都是存储在<strong>聚簇索引</strong>的叶子节点的。而记录又是存储在数据页中的，数据页和记录又是按照记录<strong>主键值从小到大</strong>的顺序进行排序，所以如果<strong>插入</strong>的记录的<strong>主键值是依次增大</strong>的话，那每插满一个数据页就换到下一个数据页继续插，而如果插入的主键值忽大忽小的话（一般不让这种情况发生），就比较麻烦了，假设某个数据页存储的记录已经满了，它存储的主键值在1~100之间：</p>
<p><img src="image-20221206154234789.png" alt="MySQL之性能优化/image-20221206154234789"></p>
</li>
<li><p>如果此时再插入一条主键值为 <strong>9</strong> 的记录，那它插入的位置就如下图：</p>
<p><img src="image-20221206154325641.png" alt="MySQL之性能优化/image-20221206154325641"></p>
</li>
<li><p>可这个数据页已经满了，再插进来咋办呢？</p>
</li>
<li><p>需要把当前 <strong>页面分裂</strong> 成两个页面，把本页中的一些记录移动到新创建的这个页中</p>
</li>
<li><p>页面分裂和记录移位意味着什么？</p>
</li>
<li><p>意味着： <strong>性能损耗</strong> ！所以如果想尽量避免这样无谓的性能损耗，最好让插入的记录的 主键值依次递增 ，这样就不会发生这样的性能损耗了</p>
</li>
<li><p>所以建议：让主键具有 <code>AUTO_INCREMENT</code> ，让存储引擎自己为表生成主键，而不是手动插入 ，比如： <code>person_info</code> 表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> person_info(</span><br><span class="line">	id <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">	name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	birthday <span class="type">DATE</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	phone_number <span class="type">CHAR</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	country <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY (id),</span><br><span class="line">	KEY idx_name_birthday_phone_number (name(<span class="number">10</span>), birthday, phone_number)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p>自定义的主键列 id 拥有<code>AUTO_INCREMENT</code> 属性，在插入记录时存储引擎会自动为我们填入自增的主键值。这样的主键占用空间小，顺序写入，减少页分裂</p>
</li>
</ul>
<h4 id="7-5-2-4-计算、函数、类型转换（自动或手动）导致索引失效"><a href="#7-5-2-4-计算、函数、类型转换（自动或手动）导致索引失效" class="headerlink" title="7.5.2.4 计算、函数、类型转换（自动或手动）导致索引失效"></a>7.5.2.4 计算、函数、类型转换（自动或手动）导致索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">4</span>)计算、函数、类型转换(自动或手动)导致索引失效</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> student(`name`);#创建索引(name)</span><br><span class="line"></span><br><span class="line"># 此语句比下一条要好！（能够使用上索引）</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student.name <span class="keyword">LIKE</span> <span class="string">&#x27;abc%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">25</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># <span class="keyword">LEFT</span>(student.name,<span class="number">3</span>) <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>; 中<span class="keyword">left</span>函数的使用导致索引失效</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> <span class="keyword">LEFT</span>(student.name,<span class="number">3</span>) <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 再举例</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_sno <span class="keyword">ON</span> student(stuno);#创建索引(stuno)</span><br><span class="line"></span><br><span class="line"># 使用“stuno<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> <span class="number">900001</span>”算术运算导致索引失效</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE id, stuno, NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> stuno<span class="operator">+</span><span class="number">1</span> <span class="operator">=</span> <span class="number">900001</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 使用了索引：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE id, stuno, NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> stuno <span class="operator">=</span> <span class="number">900000</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_sno</span><br><span class="line">          key: idx_sno</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 再举例</span><br><span class="line"># 索引失效</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> id, stuno, NAME <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> <span class="built_in">SUBSTRING</span>(`name`, <span class="number">1</span>,<span class="number">3</span>)<span class="operator">=</span><span class="string">&#x27;abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="7-5-2-5-类型转换导致索引失效"><a href="#7-5-2-5-类型转换导致索引失效" class="headerlink" title="7.5.2.5 类型转换导致索引失效"></a>7.5.2.5 类型转换导致索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">5</span>)类型转换导致索引失效</span><br><span class="line"># 没有使用索引：name是字符串类型，和<span class="type">int</span>匹配要类型转换</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="number">123</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">3</span> warnings (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 使用了索引：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;123&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="7-5-2-6-范围条件右边的列索引失效"><a href="#7-5-2-6-范围条件右边的列索引失效" class="headerlink" title="7.5.2.6 范围条件右边的列索引失效"></a>7.5.2.6 范围条件右边的列索引失效</h4><ul>
<li><p>范围条件：含(&lt;) (&lt;&#x3D;) (&gt;) (&gt;&#x3D;)和between等的条件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">6</span>)范围条件右边的列索引失效</span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> proc_drop_index(<span class="string">&#x27;atguigudb2&#x27;</span>,<span class="string">&#x27;student&#x27;</span>);#清空所有student表的索引</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_classId_name <span class="keyword">ON</span> student(age,classId,`name`);#创建联合索引 idx_age_classId_name</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student  <span class="keyword">WHERE</span> student.age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> student.classId<span class="operator">&gt;</span><span class="number">20</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Using index condition表示：有些搜索条件中虽然出现了索引列，但却不能使用到索引</span></span><br><span class="line"><span class="comment">使用了索引 idx_age_classId_name但是只用了联合索引的前两个字段</span></span><br><span class="line"><span class="comment">结合`age` INT(3)占5 、 `classId` INT(11)占5 以及key_len=10可知只使用了前两个字段 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_age_classId_name</span><br><span class="line">          key: idx_age_classId_name</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">18582</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student  <span class="keyword">WHERE</span> student.age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span> <span class="keyword">AND</span> student.classId<span class="operator">&gt;</span><span class="number">20</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	对于优化器来说AND连接的这几个条件可以任意颠倒，故此SQL语句和上一句执行效果一样   联合索引classId在中间</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_age_classId_name</span><br><span class="line">          key: idx_age_classId_name</span><br><span class="line">      key_len: <span class="number">10</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">18582</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#建一个新的索引</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_name_cid <span class="keyword">ON</span> student(age,`name`,classId);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student  <span class="keyword">WHERE</span> student.age<span class="operator">=</span><span class="number">30</span> <span class="keyword">AND</span> student.name <span class="operator">=</span> <span class="string">&#x27;abc&#x27;</span> <span class="keyword">AND</span> student.classId<span class="operator">&gt;</span><span class="number">20</span>\G</span><br><span class="line"># 在新索引下三个字段都用上了</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_age_classId_name,idx_age_name_cid</span><br><span class="line">          key: idx_age_name_cid</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#补充说明：</span><br><span class="line">#对于优化器来说<span class="keyword">AND</span>连接的字段先写哪个后写哪个无所谓</span><br><span class="line">#具体使用了哪几个字段只和索引中定义字段的位置以及哪个字段使用了范围查询有关</span><br><span class="line">#“范围条件右边的列”中的右<span class="comment">--&gt;是左是右要看索引中定义字段的相对位置，而不是字段在where中的位置</span></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>启发：</p>
<p>应用开发中范围查询，例如:金额查询，日期查询往往都是范围查询。应将查询条件放置where语句最后，建索引时也放在最后 (创建的联合索引中，务必把范围涉及到的字段写在最后)</p>
</blockquote>
<h4 id="7-5-2-7-不等于（-x3D-或者-lt-gt-索引失效"><a href="#7-5-2-7-不等于（-x3D-或者-lt-gt-索引失效" class="headerlink" title="7.5.2.7 不等于（!&#x3D;或者&lt;&gt;)索引失效"></a>7.5.2.7 不等于（!&#x3D;或者&lt;&gt;)索引失效</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">7</span>)不等于(<span class="operator">!=</span> 或者<span class="operator">&lt;&gt;</span>)索引失效</span><br><span class="line">#不等于时用不上B<span class="operator">+</span>树，只能一个一个查找</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_name <span class="keyword">ON</span> student(`name`);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student.name <span class="operator">&lt;&gt;</span> <span class="string">&#x27;abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">50.15</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#或</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> student.name <span class="operator">!=</span> <span class="string">&#x27;abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">50.15</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="7-5-2-8-is-null可以使用索引，is-not-null无法使用索引"><a href="#7-5-2-8-is-null可以使用索引，is-not-null无法使用索引" class="headerlink" title="7.5.2.8 is null可以使用索引，is not null无法使用索引"></a>7.5.2.8 is null可以使用索引，is not null无法使用索引</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">8</span>）<span class="keyword">is</span> <span class="keyword">null</span>可以使用索引，<span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>无法使用索引</span><br><span class="line">#<span class="keyword">is</span> <span class="keyword">null</span>可以使用索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="keyword">IS</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age_classId_name,idx_age_name_cid</span><br><span class="line">          key: idx_age_classId_name</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#<span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>无法使用索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_age_classId_name,idx_age_name_cid</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">50.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结论：最好在设计数据表的时候就将<code>字段设置为 NOT NULL约束</code>，比如可以将INT类型的字段，默认值设置为0。将字符类型的默认值设置为空字符串’’</p>
<p>拓展：同理,在查询中使用<code>not like </code>也无法使用索引，导致全表扫描</p>
</blockquote>
<h4 id="7-5-2-9-like以通配符-开头索引失效"><a href="#7-5-2-9-like以通配符-开头索引失效" class="headerlink" title="7.5.2.9 like以通配符%开头索引失效"></a>7.5.2.9 like以通配符%开头索引失效</h4><ul>
<li><p>在使用LIKE关键字进行查询的查询语句中，如果匹配字符串的第一个字符为”%”，索引就不会起作用。只有”%”不在第一个位置，索引才会起作用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">9</span>)<span class="keyword">like</span>以通配符<span class="operator">%</span>开头索引失效</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;ab%&#x27;</span>\G</span><br><span class="line"># 使用了索引</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_name</span><br><span class="line">          key: idx_name</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">759</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 没有使用索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> NAME <span class="keyword">LIKE</span> <span class="string">&#x27;%ab%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">11.11</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p><strong>拓展：Alibaba《Java开发手册》</strong><br>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决</p>
</blockquote>
<h4 id="7-5-2-10-OR前后存在非索引的列，索引失效"><a href="#7-5-2-10-OR前后存在非索引的列，索引失效" class="headerlink" title="7.5.2.10 OR前后存在非索引的列，索引失效"></a>7.5.2.10 OR前后存在非索引的列，索引失效</h4><ul>
<li><p>在WHERE子句中，如果在OR前的条件列进行了索引，而在OR后的条件列没有进行索引，那么索引会失效。也就是说，<strong>OR前后的两个条件中的列都是索引时，查询中才使用索引</strong></p>
</li>
<li><p>因为OR的含义就是两个只要满足一个即可，因此只有一个条件列进行了索引是没有意义的，只要有条件列没有进行索引，就会进行全表扫描，因此索引的条件列也会失效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">10</span>)<span class="keyword">OR</span> 前后存在非索引的列，索引失效</span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span> proc_drop_index(<span class="string">&#x27;atguigudb2&#x27;</span>,<span class="string">&#x27;student&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age <span class="keyword">ON</span> student(age);</span><br><span class="line"></span><br><span class="line"># 没有使用索引</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">10</span> <span class="keyword">OR</span> classid <span class="operator">=</span> <span class="number">100</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_age</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">11.88</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#为前后两个索引都创建索引，则<span class="keyword">OR</span>连接他们时就可以使用索引</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_cid <span class="keyword">ON</span> student(classid);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">10</span> <span class="keyword">OR</span> classid <span class="operator">=</span> <span class="number">100</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    因为age字段和classid字段上都有索引，所以查询中使用了索引</span></span><br><span class="line"><span class="comment">    能看到这里使用到了index_merge，简单来说index_merge就是对age和classid分别进行了扫描，然后将这两个结果集进行了合并。这样做的好处就是避免了全表扫描</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index_merge</span><br><span class="line">possible_keys: idx_age,idx_cid</span><br><span class="line">          key: idx_age,idx_cid</span><br><span class="line">      key_len: <span class="number">5</span>,<span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10655</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">union</span>(idx_age,idx_cid); <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-2-11-数据库和表的字符集统一使用uf8mb4"><a href="#7-5-2-11-数据库和表的字符集统一使用uf8mb4" class="headerlink" title="7.5.2.11 数据库和表的字符集统一使用uf8mb4"></a>7.5.2.11 数据库和表的字符集统一使用uf8mb4</h4><ul>
<li>统一使用<strong>utf8mb4</strong> (5.5.3版本以上支持) 兼容性更好，统一字符集可以避免由于字符集转换产生的乱码。不同的<strong>字符集</strong>进行比较前需要进行<strong>转换</strong>会造成索引失效</li>
<li>建议：数据库和表的字符集统一使用utf8mb4</li>
</ul>
<h4 id="7-5-2-12-练习及一般性建议"><a href="#7-5-2-12-练习及一般性建议" class="headerlink" title="7.5.2.12 练习及一般性建议"></a>7.5.2.12 练习及一般性建议</h4><p><img src="02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/QQ%E6%88%AA%E5%9B%BE20221206163721.png" alt="QQ截图20221206163721"></p>
<ul>
<li><strong>一般性建议:</strong><ul>
<li>对于单列索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠前越好</li>
<li>在选择组合索引的时候，尽量选择能够包含当前query中的where了句中更多字段的索引</li>
<li>在选择组合索引的时候，如果某个字段可能出现范围查询时，尽量把这个字段放在索引次序的最后面</li>
</ul>
</li>
</ul>
<h3 id="7-5-3-关联查询优化"><a href="#7-5-3-关联查询优化" class="headerlink" title="7.5.3 关联查询优化"></a>7.5.3 关联查询优化</h3><h4 id="7-5-3-1-数据准备"><a href="#7-5-3-1-数据准备" class="headerlink" title="7.5.3.1 数据准备"></a>7.5.3.1 数据准备</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#分类</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `type` (</span><br><span class="line">`id` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">`card` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">);</span><br><span class="line">#图书</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `book` (</span><br><span class="line">`bookid` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">`card` <span class="type">INT</span>(<span class="number">10</span>) UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY (`bookid`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#向分类表中添加<span class="number">30</span>条记录</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `type`(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">30</span>)));</span><br><span class="line"></span><br><span class="line">#向图书表中添加<span class="number">20</span>条记录</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="built_in">FLOOR</span>(<span class="number">1</span> <span class="operator">+</span> (RAND() <span class="operator">*</span> <span class="number">20</span>)));</span><br></pre></td></tr></table></figure>

<h4 id="7-5-3-2-采用左外连接"><a href="#7-5-3-2-采用左外连接" class="headerlink" title="7.5.3.2 采用左外连接"></a>7.5.3.2 采用左外连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 情况<span class="number">1</span>：左外连接</span><br><span class="line">#连接的时候就和“嵌套循环”一样</span><br><span class="line">#每次从驱动表里选取一条记录去被驱动表里整个遍历一遍</span><br><span class="line">#将符合连接条件的放到结果集中</span><br><span class="line">#驱动表和被驱动表<span class="comment">--&gt;EXPLAIN执行结果的记录中，上面的是驱动表，下面的是被驱动表</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">20</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>结论：type 有All</p>
</li>
<li><p>添加索引优化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#添加索引优化</span><br><span class="line"></span><br><span class="line">#给被驱动表加了索引可以避免全表扫描</span><br><span class="line"><span class="keyword">CREATE</span> INDEX Y <span class="keyword">ON</span> book(card); #【被驱动表】，可以避免全表扫描</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: Y</span><br><span class="line">          key: Y</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.type.card</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.05</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看到第二行的 type 变为了 ref，rows 也变成了1,优化比较明显。这是由左连接特性决定的。<code>LEFT JOIN</code>条件用于确定如何从右表搜索行，左边一定都有，所以<strong>右边是我们的关键点,一定需要建立索引</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#给驱动表加了索引也要全表扫描</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> `type` <span class="keyword">ADD</span> INDEX X (card); #【驱动表】，无法避免全表扫描</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: X</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: Y</span><br><span class="line">          key: Y</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.type.card</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>接着：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX Y <span class="keyword">ON</span> book;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: X</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">20</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-3-3-采用内连接"><a href="#7-5-3-3-采用内连接" class="headerlink" title="7.5.3.3 采用内连接"></a>7.5.3.3 采用内连接</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#情况<span class="number">2</span>：内连接</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> index X <span class="keyword">on</span> `type`;</span><br><span class="line"><span class="keyword">drop</span> index Y <span class="keyword">on</span> `book`;#（如果已经删除了可以不用再执行该操作）</span><br></pre></td></tr></table></figure>

<ul>
<li><p>LEFT JOIN 换成 INNER JOIN（MySQL自动选择驱动表）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">INNER</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">20</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">10.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加索引优化</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">#添加索引</span><br><span class="line"><span class="keyword">CREATE</span> INDEX Y <span class="keyword">ON</span> book(card);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">INNER</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">30</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: Y</span><br><span class="line">          key: Y</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.type.card</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.05</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX X <span class="keyword">ON</span> `type`(card);</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">INNER</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: Y</span><br><span class="line">          key: Y</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">20</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: X</span><br><span class="line">          key: X</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.book.card</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#如果发现type和book交换了 是因为<span class="keyword">INNER</span> <span class="keyword">JOIN</span> 的两表地位一样，选取cost小的执行</span><br><span class="line">#结论：对于内连接来说，查询优化器可以决定谁作为驱动表，谁作为被驱动表出现的</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">#删除索引</span><br><span class="line">#被驱动表book的索引，被驱动表book有可能是type</span><br><span class="line"><span class="keyword">DROP</span> INDEX Y <span class="keyword">ON</span> book;</span><br><span class="line"></span><br><span class="line">#结论：对于内连接来讲，如果表的连接条件中只能有一个字段有索引，则有索引的字段所在的表会被作为被驱动表出现；如果两张表都没有索引，则哪张表数量少就是驱动表</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> `type` <span class="keyword">INNER</span> <span class="keyword">JOIN</span> book <span class="keyword">ON</span> type.card <span class="operator">=</span> book.card\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: book</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">20</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: type</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: X</span><br><span class="line">          key: X</span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.book.card</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>结论：</p>
<ul>
<li>1.对于内连接来说，查询优化器可以决定谁作为驱动表，谁作为被驱动表出现的</li>
<li>2.对于内连接来讲，如果表的连接条件中只能有一个字段有索引，则有索引的字段所在的表会被作为<strong>被驱动表</strong>出现</li>
<li>3.对于内连接来说，在两个表的连接条件都存在索引的情况下，会选择小表作为<strong>驱动表</strong>。“小表驱动大表”</li>
</ul>
</li>
</ul>
<h4 id="7-5-3-4-join语句处理"><a href="#7-5-3-4-join语句处理" class="headerlink" title="7.5.3.4 join语句处理"></a>7.5.3.4 join语句处理</h4><ul>
<li>join方式连接多个表，本质就是各个表之间数据的循环匹配。MySQL5.5 版本之前，MySQL只支持一种表间关联方式，就是嵌套循环(Nested Loop Join)。如果关联表的数据量很大，则join关联的执行时间会非常长。在MySQL5.5以后的版本中,MySQL通过引入BNLJ算法来优化嵌套执行</li>
</ul>
<blockquote>
<h4 id="1-驱动表和被驱动表"><a href="#1-驱动表和被驱动表" class="headerlink" title="1.驱动表和被驱动表"></a>1.驱动表和被驱动表</h4></blockquote>
<ul>
<li><p>驱动表就是主表，被驱动表就是从表、非驱动表</p>
</li>
<li><p>查看哪个是驱动表、哪个是被驱动表：EXPLAIN执行结果的记录中，上面的是驱动表，下面的是被驱动表</p>
<ul>
<li><p><strong>对于内连接来说：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> A <span class="keyword">INNER</span> <span class="keyword">JOIN</span> B <span class="keyword">ON</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li>A一定是驱动表吗?不一定，优化器会根据你查询语句做优化，决定先查哪张表。先查询的那张表就是驱动表，反之就是被驱动表。通过explain关键字可以查看</li>
</ul>
</li>
<li><p><strong>对于外连接来说：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> A <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> B <span class="keyword">ON</span> ...</span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> B <span class="keyword">RIGHT</span> <span class="keyword">JOIN</span> A <span class="keyword">ON</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通常，大家会认为A就是驱动表，B就是被驱动表，但也未必。测试如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">JOIN</span> 底层原理</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> a(f1 <span class="type">INT</span>,f2 <span class="type">INT</span>,INDEX(f1))ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> b(f1 <span class="type">INT</span>,f2 <span class="type">INT</span>)ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> a <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="number">1</span>),(<span class="number">2</span>,<span class="number">2</span>),(<span class="number">3</span>,<span class="number">3</span> ),(<span class="number">4</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> b <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="number">3</span> ),(<span class="number">4</span>,<span class="number">4</span>),(<span class="number">5</span>,<span class="number">5</span>),(<span class="number">6</span>,<span class="number">6</span>),(<span class="number">7</span>,<span class="number">7</span>),(<span class="number">8</span>,<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> b;</span><br><span class="line"></span><br><span class="line">#测试<span class="number">1</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> b <span class="keyword">ON</span>(a.f1<span class="operator">=</span>b.f1) <span class="keyword">WHERE</span> (a.f2<span class="operator">=</span>b.f2)\G</span><br><span class="line"># 优化成内连接了 b驱动表 a被驱动表</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: b</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: a</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: f1</span><br><span class="line">          key: f1</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.b.f1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#测试<span class="number">2</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> a <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> b <span class="keyword">ON</span>(a.f1<span class="operator">=</span>b.f1) <span class="keyword">AND</span> (a.f2<span class="operator">=</span>b.f2)\G</span><br><span class="line"># a驱动表 b被驱动表</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: a</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: b</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> <span class="keyword">join</span> buffer (Block Nested Loop)</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#测试<span class="number">3</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> a <span class="keyword">JOIN</span> b <span class="keyword">ON</span>(a.f1<span class="operator">=</span>b.f1) <span class="keyword">WHERE</span> (a. f2<span class="operator">=</span>b.f2)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: b</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">6</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: a</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: f1</span><br><span class="line">          key: f1</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.b.f1</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">16.67</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h4 id="2-Simple-Nested-Loop-Join-简单嵌套循环连接"><a href="#2-Simple-Nested-Loop-Join-简单嵌套循环连接" class="headerlink" title="2.Simple Nested-Loop Join(简单嵌套循环连接)"></a>2.Simple Nested-Loop Join(简单嵌套循环连接)</h4></blockquote>
<ul>
<li><p>算法相当简单，从表A中取出一条数据1，遍历表B，将匹配到的数据放到result…以此类推，驱动表A中的每一条记录与被驱动表B的记录进行判断：</p>
<p><img src="image-20221206210449631.png" alt="MySQL之性能优化/image-20221206210449631"></p>
</li>
<li><p>可以看到这种方式效率是非常低的，以上述表A数据100条，表B数据1000条计算，则A*B&#x3D;10万次。开销统计如下：</p>
<table>
<thead>
<tr>
<th>开销统计</th>
<th>SNLJ</th>
</tr>
</thead>
<tbody><tr>
<td>外表扫描次数:</td>
<td>1</td>
</tr>
<tr>
<td>内表扫描次数:</td>
<td>A</td>
</tr>
<tr>
<td>读取记录数:</td>
<td>A+B*A</td>
</tr>
<tr>
<td>JOIN比较次数:</td>
<td>B*A</td>
</tr>
<tr>
<td>回表读取记录次数:</td>
<td>0</td>
</tr>
</tbody></table>
</li>
<li><p>当然mysql肯定不会这么粗暴的去进行表的连接，所以就出现了后面的两种对<strong>Nested-Loop Join</strong> 优化算法</p>
</li>
</ul>
<blockquote>
<h4 id="3-Index-Nested-Loop-Join-索引嵌套循环连接"><a href="#3-Index-Nested-Loop-Join-索引嵌套循环连接" class="headerlink" title="3.Index Nested-Loop Join(索引嵌套循环连接)"></a>3.Index Nested-Loop Join(索引嵌套循环连接)</h4></blockquote>
<ul>
<li><p>Index Nested-Loop Join其优化的思路主要是为了<strong>减少内层表数据的匹配次数</strong>，所以要求被驱动表上必须有<strong>索引</strong>才行。通过外层表匹配条件直接与内层表索引进行匹配，避免和内层表的每条记录去进行比较，这样极大的减少了对内层表的匹配次数：</p>
<p><img src="image-20221206210842894.png" alt="MySQL之性能优化/image-20221206210842894"></p>
</li>
<li><p>驱动表中的每条记录通过被驱动表的索引进行访问，因为索引查询的成本是比较固定的，故mysql优化器都倾向于使用记录数少的表作为驱动表（外表)</p>
<table>
<thead>
<tr>
<th>开销统计</th>
<th>SNLJ</th>
<th>INLJ</th>
</tr>
</thead>
<tbody><tr>
<td>外表扫描次数:</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>内表扫描次数:</td>
<td>A</td>
<td>0–&gt;直接用索引</td>
</tr>
<tr>
<td>读取记录数:</td>
<td>A+B*A</td>
<td>A+B(match)–&gt;A+B匹配的数目</td>
</tr>
<tr>
<td>JOIN比较次数:</td>
<td>B*A</td>
<td>A*Index(Height)</td>
</tr>
<tr>
<td>回表读取记录次数:</td>
<td>0</td>
<td>B(match)(if possible)</td>
</tr>
</tbody></table>
</li>
<li><p>如果被驱动表加索引，效率是非常高的，但如果索引不是主键索引，所以还得进行一次回表查询。相比，被驱动表的索引是主键索引，效率会更高</p>
</li>
</ul>
<blockquote>
<h4 id="4-Block-Nested-Loop-Join-块嵌套循环连接"><a href="#4-Block-Nested-Loop-Join-块嵌套循环连接" class="headerlink" title="4.Block Nested-Loop Join(块嵌套循环连接)"></a>4.Block Nested-Loop Join(块嵌套循环连接)</h4></blockquote>
<ul>
<li>如果存在索引，那么会使用index的方式进行join，如果join时被驱动表的列没有索引，被驱动表要扫描的次数太多了。每次访问被驱动表，其表中的记录都会被加载到内存中，然后再从驱动表中取一条与其匹配，匹配结束后清除内存，然后再从驱动表中加载一条记录，然后把被驱动表的记录在加载到内存匹配，这样周而复始，大大增加了IO的次数。为了减少被驱动表的IO次数，就出现了Block Nested-Loop Join的方式</li>
<li>不再是逐条获取驱动表的数据，而是一块一块的获取，引入了<strong>join buffer缓冲区</strong>，将驱动表join相关的部分数据列(大小受join buffer的限制）缓存到join buffer中，然后全表扫描被驱动表，被驱动表的每一条记录一次性和join buffer中的所有驱动表记录进行匹配(内存中操作)，将简单嵌套循环中的多次比较合并成一次，降低了被驱动表的访问频率</li>
</ul>
<blockquote>
<blockquote>
<p>注意:</p>
<p>这里缓存的不只是关联表的列,select后面的列也会缓存起来。</p>
<p>在一个有N个join关联的sql中会分配N-1个join buffer。所以查询的时候尽量减少不必要的字段，可以让join buffer中可以存放更多的列。</p>
</blockquote>
</blockquote>
<p><img src="image-20221206212521714.png" alt="MySQL之性能优化/image-20221206212521714"></p>
<table>
<thead>
<tr>
<th>开销统计</th>
<th>SNLJ</th>
<th>INLJ</th>
<th>BNLJ</th>
</tr>
</thead>
<tbody><tr>
<td>外表扫描次数:</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>内表扫描次数:</td>
<td>A</td>
<td>0</td>
<td>A* used_column_size &#x2F; join_buffer_size+1</td>
</tr>
<tr>
<td>读取记录数:</td>
<td>A+B*A</td>
<td>A+B(match)</td>
<td>A+B*(A * used_column_size &#x2F;join_buffer_size)</td>
</tr>
<tr>
<td>JOIN比较次数:</td>
<td>B*A</td>
<td>A *Index(Height)</td>
<td>B*A</td>
</tr>
<tr>
<td>回表读取记录次数:</td>
<td>0</td>
<td>B(match)(if possible)</td>
<td>0</td>
</tr>
</tbody></table>
<ul>
<li><p>参数设置</p>
<ul>
<li><p>block_nested_loop<br>通过<code>show variables like &#39;%optimizer_switch%&#39;</code>查看<code>block_nested_loop</code>状态。默认是开启的。</p>
</li>
<li><p>join_buffer_size<br>驱动表能不能一次加载完，要看join buffer能不能存储所有的数据，默认情况下<code>join_buffer_size=256k</code></p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%join_buffer%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------+</span></span><br><span class="line"><span class="operator">|</span> join_buffer_size <span class="operator">|</span> <span class="number">262144</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.06</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>join_buffer_size的最大值在32位系统可以申请4G，而在64位操做系统下可以申请大于4G的Join Buffer空间〔64位windows除外，其大会被截断为4GB并发出警告)</p>
</li>
<li><p>在决定哪个表做驱动表的时候，应该是两个表按照各自的条件过滤，过滤完成之后，计算参与join的各个字段的总数据量，数据量小的那个表，就是“小表”，应该作为驱动表</p>
</li>
</ul>
<h4 id="7-5-3-5-小结"><a href="#7-5-3-5-小结" class="headerlink" title="7.5.3.5 小结"></a>7.5.3.5 小结</h4><ul>
<li><p>1.<strong>整体效率比较: INLJ &gt; BNLJ &gt; SNLJ</strong></p>
</li>
<li><p>2.<strong>永远用小结果集驱动大结果集</strong>(其本质就是减少外层循环的数据数目) (小的度量单位指的是表行数*每行大小)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t1.b,t2.<span class="operator">*</span> <span class="keyword">from</span> t1 straight_join t2 <span class="keyword">on</span> (t1.b<span class="operator">=</span>t2.b) <span class="keyword">where</span> t2.id<span class="operator">&lt;=</span><span class="number">100</span>;#推荐  t1.b,t2.<span class="operator">*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> t1.b, t2.<span class="operator">*</span> <span class="keyword">from</span> t2 straight_join t1 <span class="keyword">on</span> (t1.b<span class="operator">=</span>t2.b) <span class="keyword">where</span> t2.id<span class="operator">&lt;=</span><span class="number">100</span>;#不推荐</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.为被驱动表匹配的条件增加索引(减少内层表的循环匹配次数)</p>
</li>
<li><p>4.增大join buffer size的大小(一次缓存的数据越多，那么内层包的扫表次数就越少)</p>
</li>
<li><p>5.减少驱动表不必要的字段查询（字段越少，join buffer所缓存的数据就越多)</p>
</li>
<li><p>6.保证被驱动表的J0IN字段已经创建了索引</p>
</li>
<li><p>7.需要JOIN的字段，数据类型保持绝对一致</p>
</li>
<li><p>8.LEFT JOlN时，选择小表作为驱动表，大表作为被驱动表。减少外层循环的次数。INNER JOIN时，MySQL会自动将小结果集的表选为驱动表。选择相信MySQL优化策略</p>
</li>
<li><p>9.能够直接多表关联的尽量直接关联，不用子查询(减少查询的趟数)</p>
</li>
<li><p>10.不建议使用子查询，建议将子查询SQL拆开结合程序多次查询，或使用JOIN来代替子查询</p>
</li>
<li><p>11.衍生表建不了索引</p>
</li>
</ul>
<blockquote>
<h4 id="6-Hash-Join"><a href="#6-Hash-Join" class="headerlink" title="6.Hash Join"></a>6.Hash Join</h4></blockquote>
<ul>
<li><p>从MySQL的8.0.20版本开始将废弃BNLJ，因为从MySQL8.0.18版本开始就加入了hash join默认都会使用hash join</p>
</li>
<li><p>Nested Loop:<br>对于被连接的数据子集较小的情况，Nested Loop是个较好的选择。</p>
</li>
<li><p>Hash Join是做<strong>大数据集连接</strong>时的常用方式，优化器使用两个表中较小(相对较小）的表利用Join Key在内存中建立<strong>散列表</strong>，然后扫描较大的表并探测<strong>散列表</strong>，找出与Hash表匹配的行</p>
<ul>
<li>这种方式适用于较小的表完全可以放于内存中的情况，这样总成本就是访问两个表的成本之和</li>
<li>在表很大的情况下并不能完全放入内存，这时优化器会将它分割成<strong>若干不同的分区</strong>，不能放入内存的部分就把该分区写入磁盘的临时段，此时要求有较大的临时段从而尽量提高IO的性能</li>
<li>它能够很好的工作于没有索引的大表和并行查询的环境中，并提供最好的性能。大多数人都说它是Join的重型升降机。Hash Join只能应用于等值连接(如WHERE A.COL1&#x3D;B.COL2)，这是由Hash的特点决定的</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>类别</th>
<th>Nested Loop</th>
<th>Hash Join</th>
</tr>
</thead>
<tbody><tr>
<td>使用条件</td>
<td>任何条件</td>
<td>等值连接(&#x3D;)</td>
</tr>
<tr>
<td>相关资源</td>
<td>CPU、磁盘IO</td>
<td>内存、临时空间</td>
</tr>
<tr>
<td>特点</td>
<td>当有高选择性索引或进行限制性搜索时效率比较高能能够快速返回第一次的搜索结果</td>
<td>当缺乏索引或索引条件模糊时，Hash Join比Nested于率比较高，Loop有效。在数据仓库环境下，如果表的纪录数多，效率高</td>
</tr>
<tr>
<td>缺点</td>
<td>当索引丢失或者查询条件限制不够时，效率很低。当表的纪录数多时，效率低</td>
<td>为建立哈希表，需要大量内存。第一次的结果返回较慢</td>
</tr>
</tbody></table>
<h3 id="7-5-4-子查询优化"><a href="#7-5-4-子查询优化" class="headerlink" title="7.5.4 子查询优化"></a>7.5.4 子查询优化</h3><ul>
<li><p>MySQL从4.1版本开始支持子查询，使用子查询可以进行SELECT语句的嵌套查询，即一个SELECT查询的结果作为另一个SELECT语句的条件。<strong>子查询可以一次性完成很多逻辑上需要多个步骤才能完成的SQL操作</strong></p>
</li>
<li><p><strong>子查询是MySQL的一项重要的功能，可以通过一个SQL语句实现比较复杂的查询。但是，子查询的执行效率不高。</strong>原因：</p>
<ul>
<li>① 执行子查询时，MySQL需要为内层查询语句的查询结果<strong>建立一个临时表</strong>，然后外层查询语句从临时表中查询记录。查询完毕后，再<strong>撤销这些临时表</strong>。这样会消耗过多的CPU和IO资源，产生大量的慢查询</li>
<li>② 子查询的结果集存储的临时表，不论是内存临时表还是磁盘临时表都<strong>不会存在索引</strong>，所以查询性能会受到一定的影响</li>
<li>③ 对于返回结果集比较大的子查询。其对查询性能的影响也就越大</li>
</ul>
</li>
<li><p><strong>在MySQL中，可以使用连接（JOIN）查询来替代子查询。</strong>连接查询<strong>不需要建立临时表</strong>，其<strong>速度比子查询要快</strong>，如果查询中使用索引的话，性能就会更好</p>
</li>
<li><p>举例1:查询学生表中是班长的学生信息</p>
<ul>
<li><p>使用子查询</p>
</li>
<li><p>推荐使用多表查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">4.</span> 子查询的优化</span><br><span class="line"></span><br><span class="line">#创建班级表中班长的索引</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_monitor <span class="keyword">ON</span> class(monitor);</span><br><span class="line"></span><br><span class="line">#子查询</span><br><span class="line">#查询班长的信息</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student stu1 <span class="keyword">WHERE</span> stu1.`stuno` <span class="keyword">IN</span> ( <span class="keyword">SELECT</span> monitor <span class="keyword">FROM</span> class c <span class="keyword">WHERE</span> monitor <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> )\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: stu1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>subquery2<span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">          key: <span class="operator">&lt;</span>auto_key<span class="operator">&gt;</span></span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.stu1.stuno</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: MATERIALIZED</span><br><span class="line">        <span class="keyword">table</span>: c</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_monitor</span><br><span class="line">          key: idx_monitor</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9952</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#推荐使用多表查询</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> stu1.<span class="operator">*</span> <span class="keyword">FROM</span> student stu1 <span class="keyword">JOIN</span> class c  <span class="keyword">ON</span> stu1.`stuno` <span class="operator">=</span> c.`monitor` <span class="keyword">WHERE</span> c.`monitor` <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: stu1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: c</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_monitor</span><br><span class="line">          key: idx_monitor</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.stu1.stuno</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#查询不为班长的学生信息</span><br><span class="line">#方式一</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE a.<span class="operator">*</span> <span class="keyword">FROM</span> student a <span class="keyword">WHERE</span>  a.stuno  <span class="keyword">NOT</span>  <span class="keyword">IN</span> (<span class="keyword">SELECT</span> monitor <span class="keyword">FROM</span> class b <span class="keyword">WHERE</span> monitor <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: a</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: SUBQUERY</span><br><span class="line">        <span class="keyword">table</span>: b</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_monitor</span><br><span class="line">          key: idx_monitor</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">9952</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#方式二</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE a.<span class="operator">*</span> <span class="keyword">FROM</span> student a <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> class b <span class="keyword">ON</span> a.stuno <span class="operator">=</span>b.monitor <span class="keyword">WHERE</span> b.monitor <span class="keyword">IS</span> <span class="keyword">NULL</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: a</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: b</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_monitor</span><br><span class="line">          key: idx_monitor</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: atguigudb2.a.stuno</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<p>结论：尽量不要使用NOT IN 或者 NOT EXISTS，用LEFT JOIN xxx ON xx WHERE xx IS NULL替代</p>
</blockquote>
<h3 id="7-5-5-排序优化"><a href="#7-5-5-排序优化" class="headerlink" title="7.5.5 排序优化"></a>7.5.5 排序优化</h3><h4 id="7-5-5-1-排序优化"><a href="#7-5-5-1-排序优化" class="headerlink" title="7.5.5.1 排序优化"></a>7.5.5.1 排序优化</h4><ul>
<li><p><strong>问题</strong>：在WHERE条件字段上加索引，但是为什么在ORDER BY字段上还要加索引呢?</p>
</li>
<li><p><strong>回答：</strong></p>
<ul>
<li>在MySQL中，支持两种排序方式，分别是<strong>FileSort</strong>和<strong>Index</strong>排序</li>
<li>Index排序中，索引可以保证数据的有序性，不需要再进行排序，<strong>效率更高</strong></li>
<li>FileSort 排序则一般在<strong>内存中</strong>进行排序，占用<strong>CPU 较多</strong>。如果待排结果较大，会产生临时文件I&#x2F;O到磁盘进行排序的情况，效率校低</li>
<li>Using filesort: 通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区sort buiffer中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫FileSot 排序。</li>
<li>using index: 通过有序索引顺序扫描直接返回有序数据，这种情况即为using index，不需要额外排序，操作效率高</li>
</ul>
</li>
<li><p>优化建议：</p>
<ul>
<li>SQL中，可以在WHERE子句和ORDER BY子句中使用索引，目的是在WHERE子句中<strong>避免全表扫描</strong>，在ORDER EY子句<strong>避免使用 FileSort排序</strong>。当然，某些情况下全表扫描，或者FileSort排序不一定比索引慢。但总的来说，还是要避免，以提高查询效率</li>
<li>尽量使用Index完成ORDER BY排序。如果WHERE和ORDER BY后面是相同的列就使用单索引列;如果不同就使用联合索引</li>
<li>无法使用lndex时，需要对FileSort方式进行调优</li>
</ul>
</li>
</ul>
<h4 id="7-5-5-2-测试"><a href="#7-5-5-2-测试" class="headerlink" title="7.5.5.2 测试"></a>7.5.5.2 测试</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">5.</span> 排序优化</span><br><span class="line">#删除student和class表中的非主键索引</span><br><span class="line"><span class="keyword">CALL</span> proc_drop_index(<span class="string">&#x27;atguigudb2&#x27;</span>,<span class="string">&#x27;student&#x27;</span>);</span><br><span class="line"><span class="keyword">CALL</span> proc_drop_index(<span class="string">&#x27;atguigudb2&#x27;</span>,<span class="string">&#x27;class&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> class;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#过程一：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#过程二：<span class="keyword">order</span> <span class="keyword">by</span>时不limit，索引失效</span><br><span class="line">#创建索引  </span><br><span class="line"><span class="keyword">CREATE</span>  INDEX idx_age_classid_name <span class="keyword">ON</span> student (age,classid,`name`);</span><br><span class="line"></span><br><span class="line">#不限制,索引失效</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> SQL_NO_CACHE age,classid,name,id <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid\G</span><br><span class="line"># 不回表，覆盖索引  <span class="keyword">Using</span> Index</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_age_classid_name</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#增加limit过滤条件，使用上索引了</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_age_classid_name</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#过程三：<span class="keyword">order</span> <span class="keyword">by</span>时顺序错误，索引失效</span><br><span class="line">#创建索引age,classid,stuno</span><br><span class="line"><span class="keyword">CREATE</span>  INDEX idx_age_classid_stuno <span class="keyword">ON</span> student (age,classid,stuno); </span><br><span class="line"></span><br><span class="line">#以下哪些索引失效?</span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> classid LIMIT <span class="number">10</span>;#失效</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> classid,NAME LIMIT <span class="number">10</span>; #失效 </span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid,stuno LIMIT <span class="number">10</span>;#使用索引，使用了三个字段 </span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age,classid LIMIT <span class="number">10</span>;##使用索引，使用了三个字段 </span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age LIMIT <span class="number">10</span>;#使用索引，使用了三个字段 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#过程四：<span class="keyword">order</span> <span class="keyword">by</span>时规则不一致, 索引失效 （顺序错，不索引；方向反，不索引）</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, classid <span class="keyword">ASC</span> LIMIT <span class="number">10</span>;#失效，没用使用索引</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> classid <span class="keyword">DESC</span>, NAME <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;#失效，没用使用索引</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">ASC</span>,classid <span class="keyword">DESC</span> LIMIT <span class="number">10</span>; #失效，没用使用索引</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, classid <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;#使用了索引 </span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">DESC</span>, classid <span class="keyword">DESC</span> LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_age_classid_name</span><br><span class="line">      key_len: <span class="number">73</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">10</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#过程五：无过滤，不索引</span><br><span class="line"></span><br><span class="line">#使用了索引,仅age字段</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">45</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> classid\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age_classid_name,idx_age_classid_stuno</span><br><span class="line">          key: idx_age_classid_stuno</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">18740</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span>  age<span class="operator">=</span><span class="number">45</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> classid,`name`; #使用了索引,仅age字段</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span>  classid<span class="operator">=</span><span class="number">45</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age;  #没使用了索引</span><br><span class="line"></span><br><span class="line">EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span>  classid<span class="operator">=</span><span class="number">45</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age LIMIT <span class="number">10</span>;#使用了索引,用了所有字段</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_cid <span class="keyword">ON</span> student(classid);</span><br><span class="line">#使用了索引idx_cid</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN  <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span>  classid<span class="operator">=</span><span class="number">45</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> age\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_cid</span><br><span class="line">          key: idx_cid</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">518</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>小结</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INDEX a_b_c(a,b,c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> 能使用索引最左前缀</span><br><span class="line"><span class="operator">-</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a</span><br><span class="line"><span class="operator">-</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,b</span><br><span class="line"><span class="operator">-</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,b,c</span><br><span class="line"><span class="operator">-</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">DESC</span>,b <span class="keyword">DESC</span>,c <span class="keyword">DESC</span></span><br><span class="line"><span class="operator">-</span> </span><br><span class="line">如果<span class="keyword">WHERE</span>使用索引的最左前缀定义为常量，则<span class="keyword">order</span> <span class="keyword">by</span> 能使用索引</span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c</span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">AND</span> b <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> c</span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c</span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">AND</span> b <span class="operator">&gt;</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c</span><br><span class="line"><span class="operator">-</span> </span><br><span class="line">不能使用索引进行排序</span><br><span class="line"><span class="operator">-</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> a <span class="keyword">ASC</span>,b <span class="keyword">DESC</span>,c <span class="keyword">DESC</span> 	<span class="comment">/* 排序不一致 */</span></span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> g <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c 	<span class="comment">/*丢失a索引*/</span></span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> c 	<span class="comment">/*丢失b索引*/</span></span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="operator">=</span> const <span class="keyword">ORDER</span> <span class="keyword">BY</span> a,d 	<span class="comment">/*d不是索引的一部分*/</span></span><br><span class="line"><span class="operator">-</span> <span class="keyword">WHERE</span> a <span class="keyword">in</span> (...) <span class="keyword">ORDER</span> <span class="keyword">BY</span> b,c <span class="comment">/*对于排序来说，多个相等条件也是范围查询*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-5-3-案例实战"><a href="#7-5-5-3-案例实战" class="headerlink" title="7.5.5.3 案例实战"></a>7.5.5.3 案例实战</h4><ul>
<li><p>ORDER BY子句，<strong>尽量使用Index方式排序</strong>，避免使用FileSort方式排序</p>
</li>
<li><p>执行案例前先清除student上的索引，只留主键：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 实战：测试filesort和index排序</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_age <span class="keyword">ON</span> student;</span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_age_classid_stuno <span class="keyword">ON</span> student;</span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_age_classid_name <span class="keyword">ON</span> student;</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">call</span> proc_drop_index(<span class="string">&#x27;atguigudb2&#x27;</span>,<span class="string">&#x27;student&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>场景:查询年龄为30岁的，且学生编号小于101000的学生，按用户名称排序</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">3.33</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">955</span> <span class="operator">|</span> <span class="number">100955</span> <span class="operator">|</span> AClvxZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">727</span> <span class="operator">|</span> <span class="number">100727</span> <span class="operator">|</span> aFZgKh <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">514</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">268</span> <span class="operator">|</span> <span class="number">100268</span> <span class="operator">|</span> ApYXPk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">304</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">88</span> <span class="operator">|</span> <span class="number">100088</span> <span class="operator">|</span> BREwvN <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">613</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">47</span> <span class="operator">|</span> <span class="number">100047</span> <span class="operator">|</span> DARJUx <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">529</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">441</span> <span class="operator">|</span> <span class="number">100441</span> <span class="operator">|</span> eAnNcX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">127</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">842</span> <span class="operator">|</span> <span class="number">100842</span> <span class="operator">|</span> hpcsJf <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">649</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">98</span> <span class="operator">|</span> <span class="number">100098</span> <span class="operator">|</span> IHnqRl <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">291</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">169</span> <span class="operator">|</span> <span class="number">100169</span> <span class="operator">|</span> JAIQeY <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">775</span> <span class="operator">|</span> <span class="number">100775</span> <span class="operator">|</span> JJrJhP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">542</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">756</span> <span class="operator">|</span> <span class="number">100756</span> <span class="operator">|</span> LoklxE <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">159</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">599</span> <span class="operator">|</span> <span class="number">100599</span> <span class="operator">|</span> ohTYmn <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">197</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">404</span> <span class="operator">|</span> <span class="number">100404</span> <span class="operator">|</span> QtvWwt <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">798</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">225</span> <span class="operator">|</span> <span class="number">100225</span> <span class="operator">|</span> QyTZrL <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">758</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">667</span> <span class="operator">|</span> <span class="number">100667</span> <span class="operator">|</span> RwHVHA <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">416</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">595</span> <span class="operator">|</span> <span class="number">100595</span> <span class="operator">|</span> scgAhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">344</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">357</span> <span class="operator">|</span> <span class="number">100357</span> <span class="operator">|</span> sDMaPZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">941</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">158</span> <span class="operator">|</span> <span class="number">100158</span> <span class="operator">|</span> SPsuTm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">242</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">855</span> <span class="operator">|</span> <span class="number">100855</span> <span class="operator">|</span> TJCRCm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">181</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">285</span> <span class="operator">|</span> <span class="number">100285</span> <span class="operator">|</span> txhssM <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">783</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">895</span> <span class="operator">|</span> <span class="number">100895</span> <span class="operator">|</span> uNDJsW <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">129</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">188</span> <span class="operator">|</span> <span class="number">100188</span> <span class="operator">|</span> WhUauX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">91</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">472</span> <span class="operator">|</span> <span class="number">100472</span> <span class="operator">|</span> XKKtOP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">609</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">381</span> <span class="operator">|</span> <span class="number">100381</span> <span class="operator">|</span> ZBJRhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">353</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.16</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>结论：type 是 ALL，即最坏的情况。Extra 里还出现了 Using filesort,也是最坏的情况。优化是必须的</p>
</blockquote>
</li>
<li><p><strong>优化思路：</strong></p>
<ul>
<li><p><strong>方案一: 为了去掉filesort我们可以把索引建成</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#创建新索引</span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_name <span class="keyword">ON</span> student(age,`name`);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: idx_age_name</span><br><span class="line">          key: idx_age_name</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">18278</span></span><br><span class="line">     filtered: <span class="number">33.33</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">955</span> <span class="operator">|</span> <span class="number">100955</span> <span class="operator">|</span> AClvxZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">727</span> <span class="operator">|</span> <span class="number">100727</span> <span class="operator">|</span> aFZgKh <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">514</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">268</span> <span class="operator">|</span> <span class="number">100268</span> <span class="operator">|</span> ApYXPk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">304</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">88</span> <span class="operator">|</span> <span class="number">100088</span> <span class="operator">|</span> BREwvN <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">613</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">47</span> <span class="operator">|</span> <span class="number">100047</span> <span class="operator">|</span> DARJUx <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">529</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">441</span> <span class="operator">|</span> <span class="number">100441</span> <span class="operator">|</span> eAnNcX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">127</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">842</span> <span class="operator">|</span> <span class="number">100842</span> <span class="operator">|</span> hpcsJf <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">649</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">98</span> <span class="operator">|</span> <span class="number">100098</span> <span class="operator">|</span> IHnqRl <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">291</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">169</span> <span class="operator">|</span> <span class="number">100169</span> <span class="operator">|</span> JAIQeY <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">775</span> <span class="operator">|</span> <span class="number">100775</span> <span class="operator">|</span> JJrJhP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">542</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">756</span> <span class="operator">|</span> <span class="number">100756</span> <span class="operator">|</span> LoklxE <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">159</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">599</span> <span class="operator">|</span> <span class="number">100599</span> <span class="operator">|</span> ohTYmn <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">197</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">404</span> <span class="operator">|</span> <span class="number">100404</span> <span class="operator">|</span> QtvWwt <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">798</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">225</span> <span class="operator">|</span> <span class="number">100225</span> <span class="operator">|</span> QyTZrL <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">758</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">667</span> <span class="operator">|</span> <span class="number">100667</span> <span class="operator">|</span> RwHVHA <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">416</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">595</span> <span class="operator">|</span> <span class="number">100595</span> <span class="operator">|</span> scgAhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">344</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">357</span> <span class="operator">|</span> <span class="number">100357</span> <span class="operator">|</span> sDMaPZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">941</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">158</span> <span class="operator">|</span> <span class="number">100158</span> <span class="operator">|</span> SPsuTm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">242</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">855</span> <span class="operator">|</span> <span class="number">100855</span> <span class="operator">|</span> TJCRCm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">181</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">285</span> <span class="operator">|</span> <span class="number">100285</span> <span class="operator">|</span> txhssM <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">783</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">895</span> <span class="operator">|</span> <span class="number">100895</span> <span class="operator">|</span> uNDJsW <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">129</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">188</span> <span class="operator">|</span> <span class="number">100188</span> <span class="operator">|</span> WhUauX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">91</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">472</span> <span class="operator">|</span> <span class="number">100472</span> <span class="operator">|</span> XKKtOP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">609</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">381</span> <span class="operator">|</span> <span class="number">100381</span> <span class="operator">|</span> ZBJRhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">353</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.04</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>方案二: 尽量让where的过滤条件和排序使用上索引</strong></p>
<ul>
<li><p>建一个三个字段的组合索引：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_stuno_name <span class="keyword">ON</span> student (age,stuno,`name`);</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_age_name,idx_age_stuno_name</span><br><span class="line">          key: idx_age_stuno_name</span><br><span class="line">      key_len: <span class="number">9</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">24</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">955</span> <span class="operator">|</span> <span class="number">100955</span> <span class="operator">|</span> AClvxZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">727</span> <span class="operator">|</span> <span class="number">100727</span> <span class="operator">|</span> aFZgKh <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">514</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">268</span> <span class="operator">|</span> <span class="number">100268</span> <span class="operator">|</span> ApYXPk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">304</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">88</span> <span class="operator">|</span> <span class="number">100088</span> <span class="operator">|</span> BREwvN <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">613</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">47</span> <span class="operator">|</span> <span class="number">100047</span> <span class="operator">|</span> DARJUx <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">529</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">441</span> <span class="operator">|</span> <span class="number">100441</span> <span class="operator">|</span> eAnNcX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">127</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">842</span> <span class="operator">|</span> <span class="number">100842</span> <span class="operator">|</span> hpcsJf <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">649</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">98</span> <span class="operator">|</span> <span class="number">100098</span> <span class="operator">|</span> IHnqRl <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">291</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">169</span> <span class="operator">|</span> <span class="number">100169</span> <span class="operator">|</span> JAIQeY <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">775</span> <span class="operator">|</span> <span class="number">100775</span> <span class="operator">|</span> JJrJhP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">542</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">756</span> <span class="operator">|</span> <span class="number">100756</span> <span class="operator">|</span> LoklxE <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">159</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">599</span> <span class="operator">|</span> <span class="number">100599</span> <span class="operator">|</span> ohTYmn <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">197</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">404</span> <span class="operator">|</span> <span class="number">100404</span> <span class="operator">|</span> QtvWwt <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">798</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">225</span> <span class="operator">|</span> <span class="number">100225</span> <span class="operator">|</span> QyTZrL <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">758</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">667</span> <span class="operator">|</span> <span class="number">100667</span> <span class="operator">|</span> RwHVHA <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">416</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">595</span> <span class="operator">|</span> <span class="number">100595</span> <span class="operator">|</span> scgAhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">344</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">357</span> <span class="operator">|</span> <span class="number">100357</span> <span class="operator">|</span> sDMaPZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">941</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">158</span> <span class="operator">|</span> <span class="number">100158</span> <span class="operator">|</span> SPsuTm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">242</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">855</span> <span class="operator">|</span> <span class="number">100855</span> <span class="operator">|</span> TJCRCm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">181</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">285</span> <span class="operator">|</span> <span class="number">100285</span> <span class="operator">|</span> txhssM <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">783</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">895</span> <span class="operator">|</span> <span class="number">100895</span> <span class="operator">|</span> uNDJsW <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">129</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">188</span> <span class="operator">|</span> <span class="number">100188</span> <span class="operator">|</span> WhUauX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">91</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">472</span> <span class="operator">|</span> <span class="number">100472</span> <span class="operator">|</span> XKKtOP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">609</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">381</span> <span class="operator">|</span> <span class="number">100381</span> <span class="operator">|</span> ZBJRhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">353</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>结果竟然有filesort的sql运行速度，<strong>超过了已经优化掉filesort的 sql</strong>，而且快了很多，几乎一瞬间就出现了结果</p>
</li>
<li><p>原因：</p>
<p>所有的排序都是在条件过滤之后才执行的。所以，如果条件过滤掉大部分数据的话，剩下几百几千条数据进行排序其实并不是很消耗性能，即使索引优化了排序，但实际提升性能很有限。相对的stuno&lt;101000这个条件，如果没有用到索引的话，要对几万条的数据进行扫描，这是非常消耗性能的，所以索引放在这个字段上性价比最高，是最优选择</p>
</li>
</ul>
<blockquote>
<p>结论：</p>
<p>1.两个索引同时存在，mysql自动选择最优的方案。（对于这个例子，mysql选择idx_age_stuno_name）。但是， 随着数据量的变化，选择的索引也会随之变化的 </p>
<p>2.当【范围条件】和【group by 或者 order by】的字段出现二选一时，优先观察条件字段的过滤数量，如果过滤的数据足够多，而需要排序的数据并不多时，优先把索引放在范围字段上。反之，亦然</p>
</blockquote>
<ul>
<li><p><strong>思考：这里我们使用如下索引，是否可行？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> INDEX idx_age_stuno_name <span class="keyword">ON</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_stuno <span class="keyword">ON</span> student(age,stuno);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可以</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_age_name,idx_age_stuno</span><br><span class="line">          key: idx_age_stuno</span><br><span class="line">      key_len: <span class="number">9</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">24</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> filesort</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> SQL_NO_CACHE <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">=</span> <span class="number">30</span> <span class="keyword">AND</span> stuno <span class="operator">&lt;</span><span class="number">101000</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> `name`;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span> stuno  <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span> classId <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">955</span> <span class="operator">|</span> <span class="number">100955</span> <span class="operator">|</span> AClvxZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">21</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">727</span> <span class="operator">|</span> <span class="number">100727</span> <span class="operator">|</span> aFZgKh <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">514</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">268</span> <span class="operator">|</span> <span class="number">100268</span> <span class="operator">|</span> ApYXPk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">304</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">88</span> <span class="operator">|</span> <span class="number">100088</span> <span class="operator">|</span> BREwvN <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">613</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">47</span> <span class="operator">|</span> <span class="number">100047</span> <span class="operator">|</span> DARJUx <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">529</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">441</span> <span class="operator">|</span> <span class="number">100441</span> <span class="operator">|</span> eAnNcX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">127</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">842</span> <span class="operator">|</span> <span class="number">100842</span> <span class="operator">|</span> hpcsJf <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">649</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">98</span> <span class="operator">|</span> <span class="number">100098</span> <span class="operator">|</span> IHnqRl <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">291</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">169</span> <span class="operator">|</span> <span class="number">100169</span> <span class="operator">|</span> JAIQeY <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">775</span> <span class="operator">|</span> <span class="number">100775</span> <span class="operator">|</span> JJrJhP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">542</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">756</span> <span class="operator">|</span> <span class="number">100756</span> <span class="operator">|</span> LoklxE <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">159</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">599</span> <span class="operator">|</span> <span class="number">100599</span> <span class="operator">|</span> ohTYmn <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">197</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">404</span> <span class="operator">|</span> <span class="number">100404</span> <span class="operator">|</span> QtvWwt <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">798</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">225</span> <span class="operator">|</span> <span class="number">100225</span> <span class="operator">|</span> QyTZrL <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">758</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">667</span> <span class="operator">|</span> <span class="number">100667</span> <span class="operator">|</span> RwHVHA <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">416</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">595</span> <span class="operator">|</span> <span class="number">100595</span> <span class="operator">|</span> scgAhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">344</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">357</span> <span class="operator">|</span> <span class="number">100357</span> <span class="operator">|</span> sDMaPZ <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">941</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">158</span> <span class="operator">|</span> <span class="number">100158</span> <span class="operator">|</span> SPsuTm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">242</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">855</span> <span class="operator">|</span> <span class="number">100855</span> <span class="operator">|</span> TJCRCm <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">181</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">285</span> <span class="operator">|</span> <span class="number">100285</span> <span class="operator">|</span> txhssM <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">783</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">895</span> <span class="operator">|</span> <span class="number">100895</span> <span class="operator">|</span> uNDJsW <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">129</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">188</span> <span class="operator">|</span> <span class="number">100188</span> <span class="operator">|</span> WhUauX <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>      <span class="number">91</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">472</span> <span class="operator">|</span> <span class="number">100472</span> <span class="operator">|</span> XKKtOP <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">609</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">381</span> <span class="operator">|</span> <span class="number">100381</span> <span class="operator">|</span> ZBJRhk <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span>     <span class="number">353</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+--------+--------+------+---------+</span></span><br><span class="line"><span class="number">24</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-5-5-4-filesort算法：双路排序和单路排序"><a href="#7-5-5-4-filesort算法：双路排序和单路排序" class="headerlink" title="7.5.5.4 filesort算法：双路排序和单路排序"></a>7.5.5.4 filesort算法：双路排序和单路排序</h4><ul>
<li><p>排序的字段若如果不在索引列上，则filesort会有两种算法：<strong>双路排序</strong>和<strong>单路排序</strong></p>
</li>
<li><p><strong>双路排序 （慢）</strong></p>
<ul>
<li><strong>MySQL 4.1之前是使用双路排序</strong> ，字面意思就是两次扫描磁盘，最终得到数据， 读取行指针和order by列对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出</li>
<li>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段</li>
<li>取一批数据，要对磁盘进行两次扫描，众所周知，IO是很耗时的，所以在mysql4.1之后，出现了第二种改进的算法，就是单路排序</li>
</ul>
</li>
<li><p><strong>单路排序 （快）</strong></p>
<ul>
<li>从磁盘读取查询需要的 <strong>所有列</strong> ，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出， 它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO，但是它会使用更多的空间， 因为它把每一行都保存在内存中了</li>
</ul>
</li>
<li><p><strong>结论及引申出的问题</strong></p>
<ul>
<li>由于单路是后出的，总体而言好过双路</li>
<li>但是用单路有问题<ul>
<li>在sort_buffer中，单路比多路要<strong>多占用很多空间</strong>，因为单路是把所有字段都取出,所以有可能取出的数据的总大小超出了<strong>sort_buffer</strong>的容量，导致每次只能取sort_buffer容量大小的数据，进行排序(创建tmp文件，多路合并)，排完再取sort_buffer容量大小，再排…从而多次I&#x2F;O。</li>
<li>单路本来想省一次l&#x2F;o操作，<strong>反而导致了大量的I&#x2F;O操作</strong>，反而得不偿失。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>order by 优化：</strong></p>
<ul>
<li>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</li>
<li>尽量使用覆盖索引</li>
<li>多字段排序,一个升序一个降序，此时需要注意联合索引在创建时的规则(ASC&#x2F;DESC)</li>
<li>如果不可避免的出现filesort，大数据量排序时，可以适当增大排序缓冲区大小 sort_buffer_size(默认256k)</li>
</ul>
</li>
<li><p><strong>优化策略</strong></p>
<ul>
<li><p><strong>1.尝试提高 sort_buffer_size</strong></p>
<ul>
<li><p>不管用哪种算法。提高这个参数都会提高效率，要根据系统的能力去提高，因为这个参数是针对每个进程(connection)的1M-8M之间调整。MySQL5.7，InnoDB存储引擎默认值是1048576字节，1MB</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%sort_buffer_size%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name           <span class="operator">|</span> <span class="keyword">Value</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="operator">|</span> innodb_sort_buffer_size <span class="operator">|</span> <span class="number">1048576</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> myisam_sort_buffer_size <span class="operator">|</span> <span class="number">8388608</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> sort_buffer_size        <span class="operator">|</span> <span class="number">262144</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+---------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>2.尝试提高 max_length_for_sort_data</strong></p>
<ul>
<li><p>提高这个参数，会增加用改进算法的概率</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%max_length_for_sort_data%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name            <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> max_length_for_sort_data <span class="operator">|</span> <span class="number">1024</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I&#x2F;O活动和低的处理器使用率。如果需要返回的列的总长度大于max_length_for_sort_data，使用双路算法，否则使用单路算法。1024-8192字节之间调整</p>
</li>
</ul>
</li>
<li><p><strong>3.Order by 时select * 是一个大忌。最好只Query需要的字段</strong></p>
<ul>
<li>当Query的字段大小总和小于<strong>max_length_for_sort_data</strong>，而且排序字段不是TEXT|BLOB类型时，会用改进后的算法―-单路排序，否则用老算法――多路排序</li>
<li>两种算法的数据都有可能超出sort_buffer_size的容量，超出之后，会创建tmp文件进行合并排序，导致多次I&#x2F;O，但是用单路排序算法的风险会更大一些，所以要提高<strong>sort_buffer_size</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="7-5-6-GROUP-BY优化"><a href="#7-5-6-GROUP-BY优化" class="headerlink" title="7.5.6 GROUP BY优化"></a>7.5.6 GROUP BY优化</h3><ul>
<li>group by 使用索引的原则几乎跟order by一致 ，group by 即使没有过滤条件用到索引，也可以直接使用索引</li>
<li>group by 先排序再分组，遵照索引建的最佳左前缀法则</li>
<li>当无法使用索引列，增大 <strong>max_length_for_sort_data</strong> 和 <strong>sort_buffer_size</strong> 参数的设置</li>
<li>where效率高于having，能写在where限定的条件就不要写在having中了</li>
<li>减少使用order by，和业务沟通能不排序就不排序，或将排序放到程序端去做。Order by、group by、distinct这些语句较为耗费CPU，数据库的CPU资源是极其宝贵的</li>
<li>包含了order by、group by、distinct这些查询的语句，where条件过滤出来的结果集请保持在1000行以内，否则SQL会很慢</li>
</ul>
<h3 id="7-5-7-优化分页查询-limit优化"><a href="#7-5-7-优化分页查询-limit优化" class="headerlink" title="7.5.7 优化分页查询(limit优化)"></a>7.5.7 优化分页查询(limit优化)</h3><ul>
<li><p>一般分页查询时，通过创建覆盖索引能够比较好地提高性能。一个常见又非常头疼的问题就是limit 2000000,10，此时需要MySQL排序前2000010记录，仅仅返回2000000-2000010的记录，其他记录丢弃，查询排序的代价非常大</p>
</li>
<li><p>在大数据量的分页查询时,limit后的起始位置越靠后，耗时越长</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student limit <span class="number">2000000</span>,<span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>优化思路一</strong></p>
<ul>
<li><p>在索引上完成排序分页操作，最后根据主键关联回原表查询所需要的其他列内容</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student t,(<span class="keyword">SELECT</span> id <span class="keyword">FROM</span> student <span class="keyword">ORDER</span> <span class="keyword">BY</span> id LIMIT <span class="number">2000000</span>,<span class="number">10</span>) a <span class="keyword">WHERE</span> t.id <span class="operator">=</span> a.id\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: <span class="operator">&lt;</span>derived2<span class="operator">&gt;</span></span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: <span class="keyword">PRIMARY</span></span><br><span class="line">        <span class="keyword">table</span>: t</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: eq_ref</span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: a.id</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">2</span></span><br><span class="line">  select_type: DERIVED</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>优化思路二</strong></p>
<ul>
<li><p>该方案适用于主键自增的表，可以把Limit查询转换成某个位置的查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">2000000</span> LIMIT <span class="number">10</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: <span class="keyword">PRIMARY</span></span><br><span class="line">          key: <span class="keyword">PRIMARY</span></span><br><span class="line">      key_len: <span class="number">4</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>limit优化思路：通过覆盖索引+子查询的方式来优化</strong></p>
</li>
</ul>
<h3 id="7-5-8-优先考虑覆盖索引"><a href="#7-5-8-优先考虑覆盖索引" class="headerlink" title="7.5.8 优先考虑覆盖索引"></a>7.5.8 优先考虑覆盖索引</h3><ul>
<li>尽量使用覆盖索引（覆盖索引：查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到)，减少使用selecl *.</li>
</ul>
<h4 id="7-5-8-1-什么是覆盖索引？"><a href="#7-5-8-1-什么是覆盖索引？" class="headerlink" title="7.5.8.1 什么是覆盖索引？"></a>7.5.8.1 什么是覆盖索引？</h4><ul>
<li><p>覆盖索引： SQL只需要通过索引就可以返回查询所需要的数据，而不必通过二级索引查到主键之后再去查询数据</p>
</li>
<li><p><strong>理解方式一：</strong> 索引是高效找到行的一个方法，但是一般数据库也能使用索引找到一个列的数据，因此它不必读取整个行。毕竟索引叶子节点存储了它们索引的数据；当能通过读取索引就可以得到想要的数据，那就不需要读取行了。<strong>一个索引包含了满足查询结果的数据就叫做覆盖索引</strong></p>
</li>
<li><p><strong>理解方式二：</strong> 非聚簇复合索引的一种形式，它包括在查询里的SELECT、JOIN和WHERE子句用到的所有列（即建索引的字段正好是覆盖查询条件中所涉及的字段）。</p>
</li>
<li><p>简单说就是， <strong>索引列+主键</strong> 包含 <strong>SELECT 到 FROM之间查询的列</strong> </p>
</li>
<li><p><strong>覆盖索引演示</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"># 覆盖索引</span><br><span class="line"># 删除之前的索引</span><br><span class="line"># 举例<span class="number">1</span>：</span><br><span class="line"><span class="keyword">DROP</span> INDEX idx_age_stuno <span class="keyword">ON</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> INDEX idx_age_name <span class="keyword">ON</span> student (age,`name`);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">&lt;&gt;</span> <span class="number">20</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: idx_age_name</span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.15</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> age,`name` <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> age <span class="operator">&lt;&gt;</span> <span class="number">20</span>\G</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	使用了索引，打破了前面说的“不等于”的查询索引会失效的原则</span></span><br><span class="line"><span class="comment">原因：查询优化器发现使用索引时，不会回表，开销更小，故使用了索引</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: idx_age_name</span><br><span class="line">          key: idx_age_name</span><br><span class="line">      key_len: <span class="number">68</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 举例<span class="number">2</span>：</span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;%abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ALL</span></span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: <span class="keyword">NULL</span></span><br><span class="line">      key_len: <span class="keyword">NULL</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">11.11</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> id,age <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">&#x27;%abc&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: student</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: index</span><br><span class="line">possible_keys: <span class="keyword">NULL</span></span><br><span class="line">          key: idx_age_name</span><br><span class="line">      key_len: <span class="number">68</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">499086</span></span><br><span class="line">     filtered: <span class="number">11.11</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-8-2-覆盖索引的利弊"><a href="#7-5-8-2-覆盖索引的利弊" class="headerlink" title="7.5.8.2 覆盖索引的利弊"></a>7.5.8.2 覆盖索引的利弊</h4><ul>
<li><strong>好处：</strong></li>
</ul>
<ol>
<li><strong>避免Innodb表进行索引的二次查询（回表）</strong></li>
</ol>
<p>lnnodb是以聚集索引的顺序来存储的，对于Innodb来说，二级索引在叶子节点中所保存的是行的主键信息，如果是用二级索引查询数据，在查找到相应的键值后，还需通过主键进行二次查询才能获取我们真实所需要的数据</p>
<p>在覆盖索引中，二级索引的键值中可以获取所要的据，避免了对主键的二次查询，减少了IO操作，提升了查询效率</p>
<ol start="2">
<li><strong>可以把随机IO变成顺序IO加快查询效率</strong></li>
</ol>
<p>由于覆盖索引是按键值的顺序存储的，对于IO密集型的范围查找来说，对比随机从磁盘读取每一行的数据IO要少的多，因此利用覆盖索引在访问时也可以把磁盘的<strong>随机读取的IO</strong>转变成索引查找的<strong>顺序IO</strong></p>
<p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段</p>
<ul>
<li><strong>弊端：</strong></li>
</ul>
<p><strong>索引字段的维护</strong>总是有代价的。因此，在建立冗余索引来支持覆盖索引时就需要权衡考虑了。这是业务DBA，或者称为业务数据架构师的工作</p>
<h3 id="7-5-9-如何给字符串添加索引"><a href="#7-5-9-如何给字符串添加索引" class="headerlink" title="7.5.9 如何给字符串添加索引"></a>7.5.9 如何给字符串添加索引</h3><ul>
<li><p>有一张教师表，表定义如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> teacher(</span><br><span class="line">    ID <span class="type">bigint</span> unsigned <span class="keyword">primary</span> key,</span><br><span class="line">    email <span class="type">varchar</span>(<span class="number">64</span>),</span><br><span class="line">    ...</span><br><span class="line">)engine<span class="operator">=</span>innodb;</span><br></pre></td></tr></table></figure>
</li>
<li><p>讲师要使用邮箱登录，所以业务代码中一定会出现类似于这样的语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> col1, col2 <span class="keyword">from</span> teacher <span class="keyword">where</span> email<span class="operator">=</span><span class="string">&#x27;xxx&#x27;</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果email这个字段上没有索引，那么这个语句就只能做<strong>全表扫描</strong></p>
</li>
</ul>
<h4 id="7-5-9-1-前缀索引"><a href="#7-5-9-1-前缀索引" class="headerlink" title="7.5.9.1 前缀索引"></a>7.5.9.1 前缀索引</h4><ul>
<li><p>MySQL是支持前缀索引的。默认地，如果你创建索引的语句不指定前缀长度，那么索引就会包含整个字符串</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> teacher <span class="keyword">add</span> index index1(email);</span><br><span class="line"># 或</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> teacher <span class="keyword">add</span> index index2(email(<span class="number">6</span>))</span><br></pre></td></tr></table></figure>
</li>
<li><p>这两种不同的定义在数据结构和存储上有什么区别呢？下图就是这两个索引的示意图</p>
<p><img src="image-20221208140141162.png" alt="MySQL之性能优化/image-20221208140141162"></p>
<p><img src="image-20221208140159657.png" alt="MySQL之性能优化/image-20221208140159657"></p>
</li>
<li><p>如果使用的是index1（即email整个字符串的索引结构），执行顺序是这样的：</p>
<ul>
<li>从index1索引树找到满足索引值是’ <a href="mailto:&#x7a;&#104;&#x61;&#110;&#x67;&#x73;&#x73;&#120;&#121;&#122;&#x40;&#x78;&#x78;&#120;&#46;&#x63;&#111;&#x6d;">&#x7a;&#104;&#x61;&#110;&#x67;&#x73;&#x73;&#120;&#121;&#122;&#x40;&#x78;&#x78;&#120;&#46;&#x63;&#111;&#x6d;</a> ’的这条记录，取得ID2的值</li>
<li>到主键上查到主键值是ID2的行，判断email的值是正确的，将这行记录加入结果集</li>
<li>取index1索引树上刚刚查到的位置的下一条记录，发现已经不满足email&#x3D;’ <a href="mailto:&#122;&#104;&#x61;&#110;&#103;&#x73;&#115;&#x78;&#x79;&#122;&#x40;&#x78;&#x78;&#x78;&#46;&#99;&#x6f;&#x6d;">&#122;&#104;&#x61;&#110;&#103;&#x73;&#115;&#x78;&#x79;&#122;&#x40;&#x78;&#x78;&#x78;&#46;&#99;&#x6f;&#x6d;</a> ’的条件了，循环结束。这个过程中，只需要回主键索引取一次数据，所以系统认为只扫描了一行</li>
</ul>
</li>
<li><p>如果使用的是index2（即email(6)索引结构），执行顺序是这样的：</p>
<ul>
<li>从index2索引树找到满足索引值是’zhangs’的记录，找到的第一个是ID1</li>
<li>到主键上查到主键值是ID1的行，判断出email的值不是’ <a href="mailto:&#122;&#x68;&#97;&#x6e;&#x67;&#115;&#115;&#x78;&#121;&#x7a;&#64;&#120;&#x78;&#x78;&#46;&#99;&#111;&#109;">&#122;&#x68;&#97;&#x6e;&#x67;&#115;&#115;&#x78;&#121;&#x7a;&#64;&#120;&#x78;&#x78;&#46;&#99;&#111;&#109;</a> ’，这行记录丢弃</li>
<li>取index2上刚刚查到的位置的下一条记录，发现仍然是’zhangs’，取出ID2，再到ID索引上取整行然后判断，这次值对了，将这行记录加入结果集</li>
<li>重复上一步，直到在idxe2上取到的值不是’zhangs’时，循环结束</li>
<li>也就是说使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加太多的查询成本。前面已经讲过区分度，区分度越高越好。因为区分度越高，意味着重复的键值越少</li>
</ul>
</li>
</ul>
<h4 id="7-5-9-2-前缀索引对覆盖索引的影响"><a href="#7-5-9-2-前缀索引对覆盖索引的影响" class="headerlink" title="7.5.9.2 前缀索引对覆盖索引的影响"></a>7.5.9.2 前缀索引对覆盖索引的影响</h4><p><strong>结论：</strong><br>使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择是否使用前缀索引时需要考虑的一个因素</p>
<h4 id="7-5-9-3-拓展内容"><a href="#7-5-9-3-拓展内容" class="headerlink" title="7.5.9.3 拓展内容"></a>7.5.9.3 拓展内容</h4><blockquote>
<p>从查询效率上看，使用hash字段方式的查询性能相对更稳定一些。因为crc32算出来的值虽然有冲突的概率，但是概率非常小，可以认为每次查询的平均扫描行数接近1。而倒序存储方式毕竟还是用的前缀索引的方式,也就是说还是会增加扫描行数</p>
</blockquote>
<h3 id="7-5-10-索引下推"><a href="#7-5-10-索引下推" class="headerlink" title="7.5.10 索引下推"></a>7.5.10 索引下推</h3><h4 id="7-5-10-1-使用前后的对比"><a href="#7-5-10-1-使用前后的对比" class="headerlink" title="7.5.10.1 使用前后的对比"></a>7.5.10.1 使用前后的对比</h4><ul>
<li>Index Condition Pushdown(ICP)是MySQL 5.6中新特性，是一种在<strong>存储引擎层</strong>使用索引过滤数据的一种优化方式</li>
<li><strong>ICP可以减少存储引擎访问基表的次数以及MySQL服务器访问存储引擎的次数</strong><ul>
<li>如果没有ICP，存储引擎会遍历索引以定位基表中的行，并将它们返回给MySQL服务器，由MySQL服务器评估<strong>WHERE</strong>后面的条件是否保留行</li>
<li>启用ICP后，如果部分<strong>WHERE</strong> 条件可以仅使用索引中的列进行筛选，则MySQL服务器会把这部分<strong>WHERE</strong>条件放到存储引擎筛选。然后，存储引擎通过使用索引条目来筛选数据，并且只有在满足这一条件时才从表中读取行<ul>
<li>好处:ICP可以减少存储引擎必须访问基表的次数和MySQL服务器必须访问存储引擎的次数</li>
<li>但是:ICP的<strong>加速效果</strong>取决于在存储引擎内通过<strong>ICP筛选</strong>掉的数据的比例</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-5-10-2-ICP的开启-x2F-关闭"><a href="#7-5-10-2-ICP的开启-x2F-关闭" class="headerlink" title="7.5.10.2 ICP的开启&#x2F;关闭"></a>7.5.10.2 ICP的开启&#x2F;关闭</h4><ul>
<li><p>默认情况下启用索引条件下推。可以通过设置系统变量<code>optimizer_switch</code> 制:<code>index_condition_pushdown</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#关闭索引下推</span><br><span class="line"><span class="keyword">SET</span> optimizer_switch <span class="operator">=</span> <span class="string">&#x27;index_condition_pushdown=off&#x27;</span> ;</span><br><span class="line"></span><br><span class="line">#打开索引下推</span><br><span class="line"><span class="keyword">SET</span> optimizer_switch <span class="operator">=</span> <span class="string">&#x27;index_condition_pushdown=on&#x27;</span> ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>当使用索引条件下推时，<code>EXPLAIN</code>语句输出结果中Extra列内容显示为<code>Using index condition</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> optimizer_switch <span class="operator">=</span> <span class="string">&#x27;index_condition_pushdown=off&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span> <span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span> <span class="keyword">AND</span> address <span class="keyword">LIKE</span> <span class="string">&#x27;%北京市%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: people</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: zip_last_first</span><br><span class="line">          key: zip_last_first</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">25.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> optimizer_switch <span class="operator">=</span> <span class="string">&#x27;index_condition_pushdown=on&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span> <span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span> <span class="keyword">AND</span> address <span class="keyword">LIKE</span> <span class="string">&#x27;%北京市%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: people</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: zip_last_first</span><br><span class="line">          key: zip_last_first</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">25.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-10-3-ICP使用案例"><a href="#7-5-10-3-ICP使用案例" class="headerlink" title="7.5.10.3 ICP使用案例"></a>7.5.10.3 ICP使用案例</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">USE atguigudb1;</span><br><span class="line"># 举例<span class="number">1</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">Using</span> index <span class="keyword">condition</span>   </span><br><span class="line"># 先key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> 再  key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span> 最后回表  </span><br><span class="line"># 优于 先key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> 再 回表   最后 key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span></span><br><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> s1 <span class="keyword">WHERE</span> key1 <span class="operator">&gt;</span> <span class="string">&#x27;z&#x27;</span> <span class="keyword">AND</span> key1 <span class="keyword">LIKE</span> <span class="string">&#x27;%a&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: s1</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">range</span></span><br><span class="line">possible_keys: idx_key1</span><br><span class="line">          key: idx_key1</span><br><span class="line">      key_len: <span class="number">303</span></span><br><span class="line">          <span class="keyword">ref</span>: <span class="keyword">NULL</span></span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">363</span></span><br><span class="line">     filtered: <span class="number">100.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.05</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>举例2</strong></p>
<ul>
<li>建表</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `people` (</span><br><span class="line">    `id` <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `zipcode` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `firstname` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `lastname` <span class="type">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `address` <span class="type">VARCHAR</span>(<span class="number">50</span>) <span class="keyword">COLLATE</span> utf8_bin <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY `zip_last_first` (`zipcode`,`lastname`,`firstname`)</span><br><span class="line">) ENGINE<span class="operator">=</span>INNODB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb3 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin;</span><br></pre></td></tr></table></figure>

<ul>
<li>插入数据</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `people` <span class="keyword">VALUES</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `people` <span class="keyword">VALUES</span></span><br><span class="line">( <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;000001&#x27;</span>,<span class="string">&#x27;三&#x27;</span>,<span class="string">&#x27;张&#x27;</span>,<span class="string">&#x27;北京市&#x27;</span>),</span><br><span class="line">( <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;000002&#x27;</span>,<span class="string">&#x27;四&#x27;</span>,<span class="string">&#x27;李&#x27;</span>,<span class="string">&#x27;南京市&#x27;</span>),</span><br><span class="line">( <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;000003&#x27;</span>,<span class="string">&#x27;五&#x27;</span>,<span class="string">&#x27;王&#x27;</span>,<span class="string">&#x27;上海市&#x27;</span>),</span><br><span class="line">( <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;000001&#x27;</span>,<span class="string">&#x27;六&#x27;</span>,<span class="string">&#x27;赵&#x27;</span>,<span class="string">&#x27;天津市&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>为该表定义联合索引zip_last_first (zipcode，lastname，firstname)。如果我们知道了一个人的邮编，但是不确定这个人的姓氏，我们可以进行如下检索：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span> <span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span> <span class="keyword">AND</span> address <span class="keyword">LIKE</span> <span class="string">&#x27;%北京市%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> zipcode <span class="operator">|</span> firstname <span class="operator">|</span> lastname <span class="operator">|</span> address   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">000001</span>  <span class="operator">|</span> 三        <span class="operator">|</span> 张       <span class="operator">|</span> 北京市    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>执行查看SQL的查询计划，<code>Extra</code>中显示了<code>Using index condition</code>，这表示使用了索引下推。另外，Using where表示条件中包含需要过滤的非索引列的数据，即address LIKE ‘%北京市%’这个条件并不是索引列，需要在服务端过滤掉</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span> <span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span> <span class="keyword">AND</span> address <span class="keyword">LIKE</span> <span class="string">&#x27;%北京市%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: people</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: zip_last_first</span><br><span class="line">          key: zip_last_first</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">25.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果不想出现Using where，把address LlKE’%北京市%’去掉即可</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> EXPLAIN <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span> <span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span>\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: people</span><br><span class="line">   partitions: <span class="keyword">NULL</span></span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: zip_last_first</span><br><span class="line">          key: zip_last_first</span><br><span class="line">      key_len: <span class="number">63</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">     filtered: <span class="number">25.00</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这个表中存在两个索引，分别是：</p>
<ul>
<li>主键索引</li>
<li>二级索引zip_last_first</li>
</ul>
</li>
<li><p>关闭ICP查看执行计划</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> optimizer_switch <span class="operator">=</span> <span class="string">&#x27;index_condition_pushdown=off &#x27;</span>;</span><br><span class="line">Query oK, <span class="keyword">rows</span> affected (<span class="number">0.02</span>秒)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people</span><br><span class="line"><span class="keyword">WHERE</span> zipcode<span class="operator">=</span><span class="string">&#x27;080801 &#x27;</span></span><br><span class="line"><span class="keyword">AND</span> lastname <span class="keyword">LIKE</span><span class="string">&#x27;%张%&#x27;</span><span class="keyword">AND</span> address <span class="keyword">LIKE</span> <span class="string">&#x27;%北京市%&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-10-4-开启和关闭ICP的性能对比"><a href="#7-5-10-4-开启和关闭ICP的性能对比" class="headerlink" title="7.5.10.4 开启和关闭ICP的性能对比"></a>7.5.10.4 开启和关闭ICP的性能对比</h4><ul>
<li><p>创建存储过程，主要目的就是插入很多0000001的数据，这样查询的时候为了在存储引擎层做过滤，减少IO，也为了减少缓冲池（缓存数据页，没有lO)的作用</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#创建存储过程，向people表中添加<span class="number">1000000</span>条数据，测试ICP开启和关闭状态下的性能</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span>  insert_people( max_num <span class="type">INT</span> )</span><br><span class="line"><span class="keyword">BEGIN</span>  </span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;   </span><br><span class="line"> <span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;    </span><br><span class="line"> REPEAT  </span><br><span class="line"> <span class="keyword">SET</span> i <span class="operator">=</span> i <span class="operator">+</span> <span class="number">1</span>;  </span><br><span class="line"> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> people ( zipcode,firstname,lastname,address ) <span class="keyword">VALUES</span> (<span class="string">&#x27;000001&#x27;</span>, <span class="string">&#x27;六&#x27;</span>, <span class="string">&#x27;赵&#x27;</span>, <span class="string">&#x27;天津市&#x27;</span>);  </span><br><span class="line"> UNTIL i <span class="operator">=</span> max_num  </span><br><span class="line"> <span class="keyword">END</span> REPEAT;  </span><br><span class="line"> <span class="keyword">COMMIT</span>; </span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">call</span> insert_people(<span class="number">1000000</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> people;#<span class="number">1000004</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>首先打开profiling</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> profiling<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行SQL语句，此时默认打开索引下推</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span><span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span>; </span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> zipcode <span class="operator">|</span> firstname <span class="operator">|</span> lastname <span class="operator">|</span> address   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">000001</span>  <span class="operator">|</span> 三        <span class="operator">|</span> 张       <span class="operator">|</span> 北京市    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.25</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次执行SQL语句，不使用索引下推</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="comment">/*+ no_icp (people)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span><span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> zipcode <span class="operator">|</span> firstname <span class="operator">|</span> lastname <span class="operator">|</span> address   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">000001</span>  <span class="operator">|</span> 三        <span class="operator">|</span> 张       <span class="operator">|</span> 北京市    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+---------+-----------+----------+-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">4.06</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看当前会话所产生的所有profiles</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profiles\G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Query_ID: <span class="number">1</span></span><br><span class="line">Duration: <span class="number">0.25798625</span></span><br><span class="line">   Query: <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span><span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">Query_ID: <span class="number">2</span></span><br><span class="line">Duration: <span class="number">4.05596200</span></span><br><span class="line">   Query: <span class="keyword">SELECT</span> <span class="comment">/*+ no_icp (people)*/</span> <span class="operator">*</span> <span class="keyword">FROM</span> people <span class="keyword">WHERE</span> zipcode<span class="operator">=</span><span class="string">&#x27;000001&#x27;</span> <span class="keyword">AND</span> lastname <span class="keyword">LIKE</span> <span class="string">&#x27;%张%&#x27;</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">1</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status               <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting             <span class="operator">|</span> <span class="number">0.000062</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions <span class="operator">|</span> <span class="number">0.000007</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables       <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                 <span class="operator">|</span> <span class="number">0.000057</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock          <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing           <span class="operator">|</span> <span class="number">0.000013</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics           <span class="operator">|</span> <span class="number">0.000079</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing            <span class="operator">|</span> <span class="number">0.000014</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing            <span class="operator">|</span> <span class="number">0.000004</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data         <span class="operator">|</span> <span class="number">0.257654</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                  <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>            <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables       <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items        <span class="operator">|</span> <span class="number">0.000025</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up          <span class="operator">|</span> <span class="number">0.000012</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> profile <span class="keyword">for</span> query <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Status               <span class="operator">|</span> Duration <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> starting             <span class="operator">|</span> <span class="number">0.000150</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> checking permissions <span class="operator">|</span> <span class="number">0.000011</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Opening tables       <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> init                 <span class="operator">|</span> <span class="number">0.000026</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">System</span> lock          <span class="operator">|</span> <span class="number">0.000043</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> optimizing           <span class="operator">|</span> <span class="number">0.000015</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> statistics           <span class="operator">|</span> <span class="number">0.000134</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> preparing            <span class="operator">|</span> <span class="number">0.000016</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> executing            <span class="operator">|</span> <span class="number">0.000003</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Sending data         <span class="operator">|</span> <span class="number">4.055421</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">end</span>                  <span class="operator">|</span> <span class="number">0.000016</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> query <span class="keyword">end</span>            <span class="operator">|</span> <span class="number">0.000009</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> closing tables       <span class="operator">|</span> <span class="number">0.000008</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> freeing items        <span class="operator">|</span> <span class="number">0.000025</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> cleaning up          <span class="operator">|</span> <span class="number">0.000072</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span>, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="7-5-10-5-ICP的使用条件"><a href="#7-5-10-5-ICP的使用条件" class="headerlink" title="7.5.10.5 ICP的使用条件"></a>7.5.10.5 ICP的使用条件</h4><ul>
<li><p>如果表访问的类型为rapge、ref、eq_ref和ref_or_null可以使用ICP</p>
</li>
<li><p>ICP可以用于<strong>InnoDB</strong>和<strong>MyISAM</strong>表，包括分区表<strong>InnoDB</strong>和<strong>MyISAM</strong>表</p>
</li>
<li><p>对于InnoDB表，ICP仅用于<strong>二级索引</strong>。ICP的目标是减少全行读取次数，从而减少I&#x2F;o操作。</p>
</li>
<li><p>当sQL使用覆盖索引时，不支持lCP。因为这种情况下使用ICP不会减少I&#x2F;O。</p>
</li>
<li><p>相关子查询的条件不能使用ICP</p>
</li>
<li><p>ICP的使用条件：</p>
<ul>
<li>① <strong>只能用于二级索引(secondary index)</strong></li>
<li>② explain显示的执行计划中type值（join 类型）为 range 、 ref 、 eq_ref 或者 ref_or_null</li>
<li>③ 并非全部where条件都可以用ICP筛选，如果where条件的字段不在索引列中，还是要读取整表的记录到server端做where过滤。</li>
<li>④ ICP可以用于MyISAM和InnnoDB存储引擎</li>
<li>⑤ MySQL 5.6版本的不支持分区表的ICP功能，5.7版本的开始支持。</li>
<li>⑥ 当SQL使用覆盖索引时，不支持ICP优化方法</li>
</ul>
</li>
</ul>
<h3 id="7-5-11-普通索引-vs-唯一索引"><a href="#7-5-11-普通索引-vs-唯一索引" class="headerlink" title="7.5.11 普通索引 vs 唯一索引"></a>7.5.11 普通索引 vs 唯一索引</h3><ul>
<li><p>从性能的角度考虑，你选择唯一索引还是普通索引呢？选择的依据是什么呢？</p>
</li>
<li><p>假设，我们有一个主键列为ID的表，表中有字段k，并且在k上有索引，假设字段 k 上的值都不重复</p>
</li>
<li><p>这个表的建表语句是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> test(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">primary</span> key,</span><br><span class="line">k <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">name <span class="type">varchar</span>(<span class="number">16</span>),</span><br><span class="line">index (k)</span><br><span class="line">)engine<span class="operator">=</span>InnoDB;</span><br></pre></td></tr></table></figure>
</li>
<li><p>表中R1~R5的(ID,k)值分别为(100,1)、(200,2)、(300,3)、(500,5)和(600,6)</p>
</li>
</ul>
<h4 id="7-5-11-1-查询过程"><a href="#7-5-11-1-查询过程" class="headerlink" title="7.5.11.1 查询过程"></a>7.5.11.1 查询过程</h4><ul>
<li>假设，执行查询的语句是 select id from test where k&#x3D;5<ul>
<li>对于普通索引来说，查找到满足条件的第一个记录(5,500)后，需要查找下一个记录，直到碰到第一个不满足k&#x3D;5条件的记录</li>
<li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检索</li>
</ul>
</li>
<li>那么，这个不同带来的性能差距会有多少呢？答案是， 微乎其微</li>
</ul>
<h4 id="7-5-11-2-更新过程"><a href="#7-5-11-2-更新过程" class="headerlink" title="7.5.11.2 更新过程"></a>7.5.11.2 更新过程</h4><ul>
<li><p>为了说明普通索引和唯一索引对更新语句性能的影响这个问题，介绍一下change buffer</p>
</li>
<li><p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数据页还没有在内存中的话，在不影响数据一致性的前提下， InooDB会将这些更新操作缓存在change buffer中 ，这样就不需要从磁盘中读入这个数据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后执行change buffer中与这个页有关的操作。通过这种方式就能保证这个数据逻辑的正确性<br>将change buffer中的操作应用到原数据页，得到最新结果的过程称为 merge 。除了 访问这个数据页 会触发merge外，系统有后台线程会定期merge。在 数据库正常关闭（shutdown） 的过程中，也会执行merge操作</p>
</li>
<li><p>如果能够将更新操作先记录在change buffer， 减少读磁盘 ，语句的执行速度会得到明显的提升。而且，数据读入内存是需要占用 buffer pool 的，所以这种方式还能够 避免占用内存 ，提高内存利用率。<br>唯一索引的更新就不能使用change buffer ，实际上也只有普通索引可以使用</p>
</li>
<li><p>如果要在这张表中插入一个新记录(4,400)的话，InnoDB的处理流程是怎样的</p>
</li>
</ul>
<h4 id="7-5-11-3-change-buffer的使用场景"><a href="#7-5-11-3-change-buffer的使用场景" class="headerlink" title="7.5.11.3 change buffer的使用场景"></a>7.5.11.3 change buffer的使用场景</h4><ul>
<li>1.普通索引和唯一索引应该怎么选择？其实，这两类索引在查询能力上是没差别的，主要考虑的是对<strong>更新性能</strong> 的影响。所以，建议<strong>尽量选择普通索引</strong> </li>
<li>2.在实际使用中会发现， <strong>普通索引</strong>和<strong>change buffer</strong>的配合使用，对于<strong>数据量大</strong>的表的更新优化还是很明显的</li>
<li>3.如果所有的更新后面，都马上<strong>伴随着对这个记录的查询</strong>，那么应该<strong>关闭change buffer</strong> 。而在其他情况下，change buffer都能提升更新性能</li>
<li>4.由于唯一索引用不上change buffer的优化机制，因此如果<strong>业务可以接受</strong>，从性能角度出发建议优先考虑非唯一索引。但是如果”业务可能无法确保”的情况下，怎么处理呢？<ul>
<li>首先， <strong>业务正确性优先</strong> 。我们的前提是“业务代码已经保证不会写入重复数据”的情况下，讨论性能问题。如果业务不能保证，或者业务就是要求数据库来做约束，那么没得选，必须创建唯一索引。<br>这种情况下，本节的意义在于，如果碰上了大量插入数据慢、内存命中率低的时候，给你多提供一个排查思路</li>
<li>然后，在一些“ <strong>归档库</strong> ”的场景，你是可以考虑使用唯一索引的。比如，线上数据只需要保留半年，然后历史数据保存在归档库。这时候，归档数据已经是确保没有唯一键冲突了。要提高归档效率，可以考虑把表里面的唯一索引改成普通索引</li>
</ul>
</li>
</ul>
<h3 id="7-5-12-其它查询优化策略"><a href="#7-5-12-其它查询优化策略" class="headerlink" title="7.5.12 其它查询优化策略"></a>7.5.12 其它查询优化策略</h3><h4 id="7-5-12-1-EXISTS-和-IN-的区分"><a href="#7-5-12-1-EXISTS-和-IN-的区分" class="headerlink" title="7.5.12.1 EXISTS 和 IN 的区分"></a>7.5.12.1 EXISTS 和 IN 的区分</h4><p><strong>问题：</strong></p>
<ul>
<li>不太理解哪种情况下应该使用 EXISTS，哪种情况应该用 IN。选择的标准是看能否使用表的索引吗？</li>
</ul>
<p><strong>回答:</strong></p>
<ul>
<li><p>索引是个前提，其实选择与否还是要看<strong>表的大小</strong>。你可以将选择的标准理解为<strong>小表驱动大表</strong>。在这种方式下效率是最高的</p>
</li>
<li><p>比如下面这样：</p>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> A  <span class="keyword">WHERE</span> cc <span class="keyword">IN</span>(<span class="keyword">SELECT</span> cc FRON B)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span>  <span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (<span class="keyword">SELECT</span> cc FRON B <span class="keyword">WHERE</span> B.cc<span class="operator">=</span>A.cc)</span><br></pre></td></tr></table></figure>

<ul>
<li>当A小于B时，用EXISTS。因为EXISTS的实现，相当于外表循环，实现的逻辑类似于：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> A</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> B</span><br><span class="line">		if j.cc <span class="operator">=</span><span class="operator">=</span> i.cc <span class="keyword">then</span> ...</span><br></pre></td></tr></table></figure>

<ul>
<li>当B小于A时用IN，因为实现的逻辑类似于：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> B</span><br><span class="line">	<span class="keyword">for</span> j <span class="keyword">in</span> A</span><br><span class="line">		if j.cc<span class="operator">=</span> i.cc then...</span><br></pre></td></tr></table></figure>

<ul>
<li>哪个表小就用哪个表来驱动，A表小就用EXISTS，B表小就用IN</li>
</ul>
<h4 id="7-5-12-2-COUNT-与COUNT-具体字段-效率"><a href="#7-5-12-2-COUNT-与COUNT-具体字段-效率" class="headerlink" title="7.5.12.2 COUNT(*)与COUNT(具体字段)效率"></a>7.5.12.2 COUNT(*)与COUNT(具体字段)效率</h4><p><strong>问：</strong></p>
<ul>
<li>在 MySQL 中统计数据表的行数，可以使用三种方式： <strong>SELECT COUNT(*)</strong> 、 <strong>ELECT COUNT(1)</strong> 和<strong>SELECT COUNT(具体字段)</strong> ，使用这三者之间的查询效率是怎样的</li>
</ul>
<p><strong>答：</strong></p>
<ul>
<li>前提:如果要统计的是某个字段的非空数据行数，则另当别论，毕竟比较执行效率的前提是结果一样才可以</li>
</ul>
<p><strong>环节1：</strong></p>
<ul>
<li><strong>COUNT(*)<strong>和</strong>COUNT(1)<strong>都是对所有结果进行</strong>COUNT</strong>,**COUNT()<strong>和</strong>COUNT(1)**本质上并没有区别（二者执行时间可能略有差别，不过你还是可以把它俩的执行效率看成是相等的)。如果有WHERE了句，则是对所有符合筛选条件的数据行进行统计;如果没有WHERE子句，则是对数据表的数据行数进行统计</li>
</ul>
<p><strong>环节2：</strong></p>
<ul>
<li><p>如果是MyISAM存储引擎，统计数据表的行数只需要<strong>o(1)<strong>的复杂度，这是因为每张MyISAM的数据表都有一个meta信息存储了</strong>row_count</strong>值，而—致性则由表级锁来保证</p>
</li>
<li><p>如果是InnoDB存储引擎，因为InnoDB支持事务，采用行级锁和MVCC机制，所以无法像 MyISAM—样，维护一个row_count变量，因此需要采用<strong>扫描全表</strong>，是O(n)的复杂度，进行循环＋计数的方式来完成统计。</p>
</li>
</ul>
<p><strong>环节3：</strong></p>
<ul>
<li><p>在InnoDB 引擎中，如果采用**COUNT(具体字段)<strong>来统计数据行数，要尽量采用二级索引。因为主键采用的索引是聚簇索引，聚簇索引包含的信息多，明显会大于二级索引（非聚簇索引)。对于</strong>COUNT(*)<strong>和</strong>COUNT(1)**来说，它们不需要查找具体的行，只是统计行数，系统会自动采用占用空间更小的二级索引来进行统计</p>
</li>
<li><p>如果有多个二级索引，会使用key_len 小的二级索引进行扫描。当没有二级索引的时候，才会采用主键索引来进行统计</p>
</li>
</ul>
<h4 id="7-5-12-3-关于SELECT"><a href="#7-5-12-3-关于SELECT" class="headerlink" title="7.5.12.3 关于SELECT(*)"></a>7.5.12.3 关于SELECT(*)</h4><ul>
<li>在表查询中，建议明确字段，不要使用 * 作为查询的字段列表，推荐使用SELECT &lt;字段列表&gt; 查询。原因：<ul>
<li>① MySQL 在解析的过程中，会通过<strong>查询数据字典</strong>将” * “按序转换成所有列名，这会大大的耗费资源和时间</li>
<li>② 无法使用<strong>覆盖索引</strong></li>
</ul>
</li>
</ul>
<h4 id="7-5-12-4-LIMIT-1-对优化的影响"><a href="#7-5-12-4-LIMIT-1-对优化的影响" class="headerlink" title="7.5.12.4 LIMIT 1 对优化的影响"></a>7.5.12.4 LIMIT 1 对优化的影响</h4><ul>
<li><p>针对的是会扫描全表的 SQL 语句，如果你可以确定结果集只有一条，那么加上<code> LIMIT 1</code> 的时候，当找到一条结果的时候就不会继续扫描了，这样会加快查询速度</p>
</li>
<li><p>如果数据表已经对字段建立了唯一索引，那么可以通过索引进行查询，不会全表扫描的话，就不需要加上 <code>LIMIT 1</code>了</p>
</li>
</ul>
<h4 id="7-5-12-5-多使用COMMIT"><a href="#7-5-12-5-多使用COMMIT" class="headerlink" title="7.5.12.5 多使用COMMIT"></a>7.5.12.5 多使用COMMIT</h4><ul>
<li><p>只要有可能，在程序中尽量多使用 COMMIT，这样程序的性能得到提高，需求也会因为 COMMIT 所释放的资源而减少</p>
</li>
<li><p>COMMIT 所释放的资源：</p>
<ul>
<li>回滚段上用于恢复数据的信息</li>
<li>被程序语句获得的锁</li>
<li>redo &#x2F; undo log buffer 中的空间</li>
<li>管理上述 3 种资源中的内部花费</li>
</ul>
</li>
</ul>
<h2 id="7-6-数据库的设计规范"><a href="#7-6-数据库的设计规范" class="headerlink" title="7.6 数据库的设计规范"></a>7.6 数据库的设计规范</h2><h3 id="7-6-1-为什么需要数据库设计"><a href="#7-6-1-为什么需要数据库设计" class="headerlink" title="7.6.1 为什么需要数据库设计"></a>7.6.1 为什么需要数据库设计</h3><ul>
<li><strong>在设计数据表的时候，要考虑很多问题，比如：</strong><ul>
<li>用户都需要什么数据？需要在数据表中保存哪些数据？</li>
<li>如何保证数据表中数据的<strong>正确性</strong>，当插入、删除、更新的时候该进行怎样的<strong>约束检查</strong>？</li>
<li>如何降低数据表的<strong>数据冗余度</strong>，保证数据表不会因为用户数量的增加而迅速扩张？</li>
<li>如何让负责数据库维护的人员<strong>更方便</strong>的使用数据库？</li>
<li>使用数据库的应用场景也各不相同，可以说针对不同情况，设计出来的数据库可能<strong>千差万别</strong></li>
</ul>
</li>
<li><strong>现实情况中，面临的场景：</strong><ul>
<li>当数据库运行了一段时间后，才发现数据表设计有问题。重新调整数据表的结构，就需要做数据迁移，还可能影响程序的业务逻辑，以及网站正常的访问</li>
</ul>
</li>
<li><strong>如果是糟糕的数据库设计可能会造成以下问题：</strong><ul>
<li>数据冗余、信息重复、存储空间浪费</li>
<li>数据更新、插入、删除的异常</li>
<li>无法正确表示信息</li>
<li>丢失有效信息</li>
<li>程序性能差</li>
</ul>
</li>
<li><strong>良好的数据库设计则有以下优点：</strong><ul>
<li>节省数据的存储空间</li>
<li>能够保证数据的完整性</li>
<li>方便进行数据库应用系统的开发</li>
</ul>
</li>
<li>总之，开始设计数据库的时候，需要重视数据表的设计，为了建立<strong>冗余度小</strong>、<strong>结构合理</strong>的数据库，设计数据库时必须遵守一定的规则</li>
</ul>
<h3 id="7-6-2-范式"><a href="#7-6-2-范式" class="headerlink" title="7.6.2 范式"></a>7.6.2 范式</h3><h4 id="7-6-2-1-范式简介"><a href="#7-6-2-1-范式简介" class="headerlink" title="7.6.2.1 范式简介"></a>7.6.2.1 范式简介</h4><ul>
<li><strong>在关系型数据库中，关于数据表设计的基本原则、规则就称为范式</strong>。可以理解为，一张数据表的设计结 构需要满足的某种设计标准的<strong>级别</strong> 。要想设计一个结构合理的关系型数据库，必须满足一定的范式</li>
</ul>
<h4 id="7-6-2-2-范式都包括哪些"><a href="#7-6-2-2-范式都包括哪些" class="headerlink" title="7.6.2.2 范式都包括哪些"></a>7.6.2.2 范式都包括哪些</h4><ul>
<li>目前关系型数据库有六种常见范式，按照范式级别，从低到高分别是<strong>：第一范式（1NF）、第二范式 （2NF）、第三范式（3NF）、巴斯-科德范式（BCNF）、第四范式(4NF）和第五范式（5NF，又称完美范式）</strong></li>
<li>数据库的范式设计越高阶，冗余度越低，同时高阶的范式一定符合低阶范式的要求，满足最低要求的范式就是第一范式（1NF）。在第一范式的基础上进一步满足更多规范要求的称为第二范式（2NF），其余范式以此类推</li>
<li>一般来说，在关系型数据库设计中，最高也就遵守到BCNF，普遍还是3NF。但也不绝对，有时为了提高某些重新性能，还需要破坏范式规则，也就是<strong>反规范化</strong></li>
</ul>
<p><img src="image-20221208170936996.png" alt="MySQL之性能优化/image-20221208170936996"></p>
<h4 id="7-6-6-3-键和相关属性的概念"><a href="#7-6-6-3-键和相关属性的概念" class="headerlink" title="7.6.6.3 键和相关属性的概念"></a>7.6.6.3 键和相关属性的概念</h4><ul>
<li><p>范式的定义会使用到主键和候选键，数据库中的键由一个或者多个属性组成。数据表中常用的几种键和属性的定义：</p>
<ul>
<li><strong>超键：</strong>能唯一标识元组的属性集叫做超键</li>
<li><strong>候选键：</strong>如果超键不包括多余的属性，那么这个超键就是候选键</li>
<li><strong>主键：</strong>用户可以从候选键中选择一个作为主键</li>
<li><strong>外键：</strong>如果数据表R1中的某属性不是R1的主键，而是另一个数据表R2的主键，那么这个属性就是数据表R1的外键</li>
<li><strong>主属性：</strong>包含在任一候选键中的属性称为主属性</li>
<li><strong>非主属性：</strong>与主属性相对，指的是不包含在任何一个候选键中的属性</li>
</ul>
</li>
<li><p>通常，也将候选键称为”<strong>码</strong>“，把主键也称为”<strong>主码</strong>“。因为键可能是由多个属性组成，针对单个属性，还可以用主属性和非主属性来进行区分</p>
</li>
<li><p>举例，这里有两个表： </p>
<ul>
<li><strong>球员表(player) ：</strong>球员编号 | 姓名 | 身份证号 | 年龄 | 球队编号 </li>
<li><strong>球队表(team) ：</strong>球队编号 | 主教练 | 球队所在地 <ul>
<li><strong>超键：</strong>对于球员表来说，超键就是包括球员编号或者身份证号的任意组合，比如（球员编号） （球员编号，姓名）（身份证号，年龄）等</li>
<li><strong>候选键：</strong>就是最小的超键，对于球员表来说，候选键就是（球员编号）或者（身份证号）</li>
<li><strong>主键：</strong>我们自己选定，也就是从候选键中选择一个，比如（球员编号）</li>
<li><strong>外键：</strong>球员表中的球队编号</li>
<li><strong>主属性 、 非主属性：</strong>在球员表中，主属性是（球员编号）（身份证号），其他的属性（姓名） （年龄）（球队编号）都是非主属性</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-6-6-4-第一范式"><a href="#7-6-6-4-第一范式" class="headerlink" title="7.6.6.4 第一范式"></a>7.6.6.4 第一范式</h4><ul>
<li><p>第一范式主要确保数据表中每个字段的值必须具有原子性，也就是说数据表中每个字段的值为不可再次拆分的最小数据单元</p>
</li>
<li><p>设计某个字段的时候，对于字段X来说，不能把字段X拆分成字段X-1和字段X-2。事实上，任何的DBMS都会满足第一范式的要求，不会将字段进行拆分</p>
</li>
<li><p><strong>举例：</strong></p>
<ul>
<li><p>假设一家公司要存储员工的姓名和联系方式。它创建一个如下表：</p>
<p><img src="image-20221208213932349.png" alt="MySQL之性能优化/image-20221208213932349"></p>
</li>
<li><p>该表不符合 1NF ，因为规则说“表的每个属性必须具有原子（单个）值”，lisi和zhaoliu员工的emp_mobile 值违反了该规则。为了使表符合 1NF ，我们应该有如下表数据：</p>
<p><img src="image-20221208214026963.png" alt="MySQL之性能优化/image-20221208214026963"></p>
</li>
</ul>
</li>
<li><p><strong>举例2：</strong></p>
<ul>
<li><p>user 表的设计不符合第一范式</p>
<p><img src="image-20221208214122375.png" alt="MySQL之性能优化/image-20221208214122375"></p>
</li>
<li><p>其中，user_info字段为用户信息，可以进一步拆分成更小粒度的字段，不符合数据库设计对第一范式的 要求。将user_info拆分后如下：</p>
<p><img src="image-20221208214154244.png" alt="MySQL之性能优化/image-20221208214154244"></p>
</li>
</ul>
</li>
<li><p><strong>举例3：</strong></p>
<ul>
<li><p>属性的原子性是 主观的 。例如，Employees关系中雇员姓名应当使用1个（fullname）、2个（firstname 和lastname）还是3个（firstname、middlename和lastname）属性表示呢？答案取决于应用程序。如果应 用程序需要分别处理雇员的姓名部分（如：用于搜索目的），则有必要把它们分开。否则，不需要</p>
</li>
<li><p>表1：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>年龄</th>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>20</td>
<td>广东省广州市三元里78号</td>
</tr>
<tr>
<td>李四</td>
<td>24</td>
<td>广东省深圳市龙华新区</td>
</tr>
</tbody></table>
</li>
<li><p>表2：</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>年龄</th>
<th>省</th>
<th>市</th>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>20</td>
<td>广东</td>
<td>广州</td>
<td>三元里78号</td>
</tr>
<tr>
<td>李四</td>
<td>24</td>
<td>广东</td>
<td>深圳</td>
<td>龙华新区</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<h4 id="7-6-6-5-第二范式"><a href="#7-6-6-5-第二范式" class="headerlink" title="7.6.6.5 第二范式"></a>7.6.6.5 第二范式</h4><ul>
<li><p>第二范式要求，在满足第一范式的基础上，还要<strong>满足数据表里的每一条数据记录，都是可唯一标识的。而且所有非主键字段，都必须完全依赖主键，不能只是依赖主键的一部分</strong>。如果知道主键的所有属性的值，就可以检索到任何元组（行）的任何属性的值。（要求中的主键，其实可以拓展替换为候选键）</p>
</li>
<li><p>举例1： </p>
<ul>
<li><strong>成绩表</strong> （学号，课程号，成绩）关系中，（学号，课程号）可以决定成绩，但是学号不能决定成绩，课 程号也不能决定成绩，所以“（学号，课程号）→成绩”就是<strong>完全依赖关系</strong></li>
</ul>
</li>
<li><p>举例2： </p>
<ul>
<li><p><strong>比赛表 player_game</strong>，里面包含球员编号、姓名、年龄、比赛编号、比赛时间和比赛场地等属性，这 里候选键和主键都为（球员编号，比赛编号），我们可以通过候选键（或主键）来决定如下的关系： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(球员编号, 比赛编号) → (姓名, 年龄, 比赛时间, 比赛场地，得分)</span><br></pre></td></tr></table></figure>
</li>
<li><p>但是这个数据表不满足第二范式，因为数据表中的字段之间还存在着如下的对应关系：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(球员编号) → (姓名，年龄)</span><br><span class="line">(比赛编号) → (比赛时间, 比赛场地)</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于非主属性来说，并非完全依赖候选键。这样会产生怎样的问题呢？</p>
<ul>
<li><strong>数据冗余</strong>：如果一个球员可以参加 m 场比赛，那么球员的姓名和年龄就重复了 m-1 次。一个比赛 也可能会有 n 个球员参加，比赛的时间和地点就重复了 n-1 次。</li>
<li><strong>插入异常：</strong>如果我们想要添加一场新的比赛，但是这时还没有确定参加的球员都有谁，那么就没法插入</li>
<li><strong>删除异常：</strong>如果我要删除某个球员编号，如果没有单独保存比赛表的话，就会同时把比赛信息删除掉</li>
<li><strong>更新异常：</strong>如果我们调整了某个比赛的时间，那么数据表中所有这个比赛的时间都需要进行调整，否则就会出现一场比赛时间不同的情况</li>
</ul>
</li>
<li><p>为了避免出现上述的情况，我们可以把球员比赛表设计为下面的三张表</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>属性（字段）</th>
</tr>
</thead>
<tbody><tr>
<td>球员 player 表</td>
<td>球员编号、姓名和年龄等属性</td>
</tr>
<tr>
<td>比赛 game 表</td>
<td>比赛编号、比赛时间和比赛场地等属性</td>
</tr>
<tr>
<td>球员比赛关系 player_game 表</td>
<td>球员编号、比赛编号和得分等属性</td>
</tr>
</tbody></table>
</li>
<li><p>这样的话，每张数据表都符合第二范式，也就避免了异常情况的发生</p>
</li>
</ul>
<blockquote>
<p>1NF 告诉我们字段属性需要是原子性的，而 2NF 告诉我们一张表就是一个独立的对象，一张表只 表达一个意思</p>
</blockquote>
</li>
<li><p>举例3： </p>
<ul>
<li><p>定义了一个名为 Orders 的关系，表示订单和订单行的信息：</p>
<p><img src="image-20221208215518466.png" alt="MySQL之性能优化/image-20221208215518466"></p>
</li>
<li><p>违反了第二范式，因为有非主键属性仅依赖于候选键（或主键）的一部分。例如，可以仅通过orderid找 到订单的 orderdate，以及 customerid 和 companyname，而没有必要再去使用productid</p>
</li>
<li><p>修改： Orders表和OrderDetails表如下，此时符合第二范式</p>
<p><img src="image-20221208215604030.png" alt="MySQL之性能优化/image-20221208215604030"></p>
</li>
</ul>
</li>
</ul>
<h4 id="7-6-6-6-第三范式"><a href="#7-6-6-6-第三范式" class="headerlink" title="7.6.6.6 第三范式"></a>7.6.6.6 第三范式</h4><ul>
<li><p>第三范式是在第二范式的基础上，确保数据表中的每一个非主键字段都和主键字段直接相关，也就是说，<strong>要求数据表中的所有非主键字段不能依赖于其它非主键字段</strong>。（即，不能存在非主属性A依赖非主属性B，非主属性B依赖于主键C的情况，即存在”A-&gt;B-&gt;C”的决定关系）通俗的讲，该规则的意思是所有<strong>非主键属性</strong>之间不能有依赖关系，必须<strong>相互独立</strong></p>
</li>
<li><p>这里的主键可以拓展为候选键</p>
</li>
<li><p><strong>举例1：</strong></p>
<ul>
<li><strong>部门信息表：</strong>每个部门有部门编号（dept_id）、部门名称、部门简介等信息</li>
<li><strong>员工信息表：</strong>每个员工有员工编号、姓名、部门编号。列出部门编号后就不能再将部门名称、部门简介 等与部门有关的信息再加入员工信息表中</li>
<li>如果不存在部门信息表，则根据第三范式（3NF）也应该构建它，否则就会有大量的数据冗余</li>
</ul>
</li>
<li><p><strong>举例2：</strong></p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
<th>是否是主键</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INT</td>
<td>是</td>
<td>商品主键id （主键）</td>
</tr>
<tr>
<td>category_id</td>
<td>INT</td>
<td>否</td>
<td>商品类别id</td>
</tr>
<tr>
<td>category_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品类别名称</td>
</tr>
<tr>
<td>goods_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品名称</td>
</tr>
<tr>
<td>price</td>
<td>DECIMAL(10,2)</td>
<td>否</td>
<td>商品价格</td>
</tr>
</tbody></table>
<ul>
<li><p>商品类别名称依赖于商品类别编号，不符合第三范式</p>
</li>
<li><p>修改：</p>
<ul>
<li><p>表1：符合第三范式的<strong>商品类别表</strong>的设计</p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
<th>是否是主键</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INT</td>
<td>是</td>
<td>商品主键id （主键）</td>
</tr>
<tr>
<td>category_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品类别名称</td>
</tr>
</tbody></table>
</li>
<li><p>表2：符合第三范式的<strong>商品表</strong>的设计</p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
<th>是否是主键</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INT</td>
<td>是</td>
<td>商品主键id （主键）</td>
</tr>
<tr>
<td>category_id</td>
<td>INT</td>
<td>否</td>
<td>商品类别id</td>
</tr>
<tr>
<td>goods_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品名称</td>
</tr>
<tr>
<td>price</td>
<td>DECIMAL(10,2)</td>
<td>否</td>
<td>商品价格</td>
</tr>
</tbody></table>
</li>
<li><p>商品表goods通过商品类别id字段（category_id）与商品类别表goods_category进行关联</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>举例3：</strong></p>
<ul>
<li><p><strong>球员player表：</strong>球员编号、姓名、球队名称和球队主教练。现在，我们把属性之间的依赖关系画出 来，如下图所示：</p>
<p><img src="image-20221208230221865.png" alt="MySQL之性能优化/image-20221208230221865"></p>
</li>
<li><p>能看到球员编号决定了球队名称，同时球队名称决定了球队主教练，非主属性球队主教练就会传递依 赖于球员编号，因此不符合 3NF 的要求。</p>
</li>
<li><p>如果要达到 3NF 的要求，需要把数据表拆成下面这样：</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>属性（字段）</th>
</tr>
</thead>
<tbody><tr>
<td>球员表</td>
<td>球员编号、姓名和球队名称</td>
</tr>
<tr>
<td>球队表</td>
<td>球队名称、球队主教练</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p><strong>举例4：</strong></p>
<ul>
<li><p>修改第二范式中的举例3</p>
</li>
<li><p>此时的Orders关系包含 orderid、orderdate、customerid 和 companyname 属性，主键定义为 orderid。 customerid 和companyname均依赖于主键——orderid。例如，你需要通过orderid主键来查找代表订单中 客户的customerid，同样，你需要通过 orderid 主键查找订单中客户的公司名称（companyname）。然 而， customerid和companyname也是互相依靠的。为满足第三范式，可以改写如下：</p>
<p><img src="image-20221208230510678.png" alt="MySQL之性能优化/image-20221208230510678"></p>
</li>
</ul>
<blockquote>
<p>符合3NF后的数据模型通俗地讲，2NF和3NF通常以这句话概括：“每个非键属性依赖于键，依赖于 整个键，并且除了键别无他物”</p>
</blockquote>
</li>
</ul>
<h4 id="7-6-6-7-小结"><a href="#7-6-6-7-小结" class="headerlink" title="7.6.6.7 小结"></a>7.6.6.7 小结</h4><ul>
<li>关于数据表的设计，有三个范式要遵循<ul>
<li>第一范式（1NF），确保每列保证<strong>原子性</strong><ul>
<li>数据库的每一列都是不可分割的原子数据项，不可再分的最小数据单元，而不能是集合、数组、记录等非原子数据项</li>
</ul>
</li>
<li>第二范式（2NF），确保每列都和主键<strong>完全依赖</strong><ul>
<li>尤其在复合主键的情况下，非主键部分不应该依赖于<strong>部分主键</strong></li>
</ul>
</li>
<li>第三范式（3NF），确保每列都和主键列<strong>直接相关</strong>，而不是间接相关</li>
</ul>
</li>
<li><strong>范式的优点：</strong>数据的标准化有助于消除数据库中的<strong>数据冗余</strong>，第三范式（3NF)通常被认为在性能、扩展性和数据完整性方面达到了最好的平衡</li>
<li><strong>范式的缺点：</strong>范式的使用，可能<strong>降低查询的效率</strong>。因为范式等级越高，设计出来的数据表就越多、越精细，数据的冗余度就越低，进行数据查询的时候就可能需要<strong>关联多张表</strong>，这不但代价昂贵，也可能使一些<strong>索引策略无效</strong></li>
<li>范式只是提出了设计的标准，实际上设计数据表时，未必一定要符合这些标准。开发中，会出现为了性能和读取效率违反范式化的原则，通过<strong>增加少量的冗余</strong>或重复的数据来提高数据库的<strong>读性能</strong>，减少关联查询，join表的次数，<strong>实现空间换取时间</strong>的目的。因此在实际的设计过程中要理论结合实际、灵活运用</li>
</ul>
<h3 id="7-6-3-反范式化"><a href="#7-6-3-反范式化" class="headerlink" title="7.6.3 反范式化"></a>7.6.3 反范式化</h3><h4 id="7-6-3-1-概述"><a href="#7-6-3-1-概述" class="headerlink" title="7.6.3.1 概述"></a>7.6.3.1 概述</h4><ul>
<li>有的时候不能简单按照规范要求设计数据表，因为有的数据看似冗余，其实对业务来说十分重要。这个时候，我们就要遵循<strong>业务优先</strong>的原则，首先满足业务需求，再尽量减少冗余</li>
<li>如果数据库中的数据量比较大，系统的UV和PV访问频次比较高，则完全按照MySQL的三大范式设计数据表，读数据时会产生大量的关联查询，在一定程度上会影响数据库的读性能。如果想对查询效率进行优化，<strong>反范式优化</strong>也是一种优化思路。此时，可以通过在数据表中<strong>增加冗余字段</strong>来提高数据库的读性能</li>
<li><strong>规范化 vs 性能</strong><ul>
<li>1.为满足某种商业目标 , 数据库性能比规范化数据库更重要 </li>
<li>2.在数据规范化的同时 , 要综合考虑数据库的性能 </li>
<li>3.通过在给定的表中添加额外的字段，以大量减少需要从中搜索信息所需的时间</li>
<li>4.通过在给定的表中插入计算列，以方便查询</li>
</ul>
</li>
</ul>
<h4 id="7-6-3-2-应用案例"><a href="#7-6-3-2-应用案例" class="headerlink" title="7.6.3.2 应用案例"></a>7.6.3.2 应用案例</h4><ul>
<li><p><strong>举例1：</strong></p>
<ul>
<li>员工的信息存储在 employees 表 中，部门信息存储在 departments 表 中。通过 employees 表中的 department_id字段与 departments 表建立关联关系。如果要查询一个员工所在部门的名称：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> employee_id,department_name</span><br><span class="line"><span class="keyword">from</span> employees e <span class="keyword">join</span> departments d</span><br><span class="line"><span class="keyword">on</span> e.department_id <span class="operator">=</span> d.department_id;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果经常需要进行这个操作，连接查询就会浪费很多时间。可以在 employees 表中增加一个冗余字段 department_name，这样就不用每次都进行连接操作了</li>
</ul>
</li>
<li><p><strong>举例2：</strong></p>
<ul>
<li><p>反范式化的<strong>goods商品信息表</strong>设计如下：</p>
<table>
<thead>
<tr>
<th>字段名称</th>
<th>字段类型</th>
<th>是否是主键</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>INT</td>
<td>是</td>
<td>商品id （主键）</td>
</tr>
<tr>
<td>category_id</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品类别id</td>
</tr>
<tr>
<td>category_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品类别名称</td>
</tr>
<tr>
<td>goods_name</td>
<td>VARCHAR(30)</td>
<td>否</td>
<td>商品名称</td>
</tr>
<tr>
<td>price</td>
<td>DECIMAL(10,2)</td>
<td>否</td>
<td>商品价格</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p><strong>举例3：</strong></p>
<ul>
<li><p>有 2 个表，分别是<strong>商品流水表（atguigu.trans）</strong>和<strong>商品信息表 （atguigu.goodsinfo）</strong>。商品流水表里有 400 万条流水记录，商品信息表里有 2000 条商品记录</p>
</li>
<li><p>商品流水表：</p>
<p><img src="image-20221209150809581.png" alt="MySQL之性能优化/image-20221209150809581"></p>
</li>
<li><p>商品信息表：</p>
<p><img src="image-20221209150839138.png" alt="MySQL之性能优化/image-20221209150839138"></p>
</li>
<li><p>两个表是符合第三范式要求的。但是，在项目的实施过程中，对流水的查询频率很高，而且为了获取商品名称，基本都会用到与商品信息表的连接查询</p>
</li>
<li><p>为了减少连接，可以直接把商品名称字段添加到流水表里面。这样一来，就可以直接从流水表中获取商品名称字段了。虽然增加了冗余字段，但是避免了关联查询，提升了查询的效率</p>
</li>
<li><p>新的商品流水表如下所示：</p>
<p><img src="image-20221209150913205.png" alt="MySQL之性能优化/image-20221209150913205"></p>
</li>
</ul>
</li>
<li><p><strong>举例4：</strong></p>
<ul>
<li><p><strong>课程评论表 class_comment</strong>，对应的字段名称及含义如下：</p>
<p><img src="image-20221209151518348.png" alt="MySQL之性能优化/image-20221209151518348"></p>
</li>
<li><p><strong>学生表 student</strong>，对应的字段名称及含义如下：</p>
<p><img src="image-20221209151558644.png" alt="MySQL之性能优化/image-20221209151558644"></p>
</li>
<li><p>在实际应用中，在显示课程评论的时候，通常会显示这个学生的昵称，而不是学生 ID，因此当想要查询某个课程的前 1000 条评论时，需要关联 class_comment 和 student这两张表来进行查询</p>
</li>
<li><p><strong>实验数据：模拟两张百万量级的数据表</strong> </p>
<ul>
<li><p>为了更好地进行 SQL 优化实验，需要给学生表和课程评论表随机模拟出百万量级的数据。可以 通过存储过程来实现模拟数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE atguigudb3;</span><br><span class="line"></span><br><span class="line">USE atguigudb3;</span><br><span class="line"></span><br><span class="line">#学生表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student(</span><br><span class="line">stu_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">stu_name <span class="type">VARCHAR</span>(<span class="number">25</span>),</span><br><span class="line">create_time DATETIME</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#课程评论表</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> class_comment(</span><br><span class="line">comment_id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">class_id <span class="type">INT</span>,</span><br><span class="line">comment_text <span class="type">VARCHAR</span>(<span class="number">35</span>),</span><br><span class="line">comment_time DATETIME,</span><br><span class="line">stu_id <span class="type">INT</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">###创建向学生表中添加数据的存储过程</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_student(<span class="keyword">IN</span> <span class="keyword">START</span> <span class="type">INT</span>(<span class="number">10</span>), <span class="keyword">IN</span> max_num <span class="type">INT</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> date_start DATETIME <span class="keyword">DEFAULT</span> (<span class="string">&#x27;2017-01-01 00:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> date_temp DATETIME;</span><br><span class="line"><span class="keyword">SET</span> date_temp <span class="operator">=</span> date_start;</span><br><span class="line"><span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">SET</span> date_temp <span class="operator">=</span> DATE_ADD(date_temp, <span class="type">INTERVAL</span> RAND()<span class="operator">*</span><span class="number">60</span> <span class="keyword">SECOND</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student(stu_id, stu_name, create_time)</span><br><span class="line"><span class="keyword">VALUES</span>((<span class="keyword">START</span><span class="operator">+</span>i), CONCAT(<span class="string">&#x27;stu_&#x27;</span>,i), date_temp);</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#调用存储过程，学生id从<span class="number">10001</span>开始，添加<span class="number">1000000</span>数据</span><br><span class="line"><span class="keyword">CALL</span> batch_insert_student(<span class="number">10000</span>,<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">####创建向课程评论表中添加数据的存储过程</span><br><span class="line">DELIMITER <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> batch_insert_class_comments(<span class="keyword">IN</span> <span class="keyword">START</span> <span class="type">INT</span>(<span class="number">10</span>), <span class="keyword">IN</span> max_num <span class="type">INT</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> date_start DATETIME <span class="keyword">DEFAULT</span> (<span class="string">&#x27;2018-01-01 00:00:00&#x27;</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> date_temp DATETIME;</span><br><span class="line"><span class="keyword">DECLARE</span> comment_text <span class="type">VARCHAR</span>(<span class="number">25</span>);</span><br><span class="line"><span class="keyword">DECLARE</span> stu_id <span class="type">INT</span>;</span><br><span class="line"><span class="keyword">SET</span> date_temp <span class="operator">=</span> date_start;</span><br><span class="line"><span class="keyword">SET</span> autocommit<span class="operator">=</span><span class="number">0</span>;</span><br><span class="line">REPEAT</span><br><span class="line"><span class="keyword">SET</span> i<span class="operator">=</span>i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">SET</span> date_temp <span class="operator">=</span> DATE_ADD(date_temp, <span class="type">INTERVAL</span> RAND()<span class="operator">*</span><span class="number">60</span> <span class="keyword">SECOND</span>);</span><br><span class="line"><span class="keyword">SET</span> comment_text <span class="operator">=</span> SUBSTR(MD5(RAND()),<span class="number">1</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">SET</span> stu_id <span class="operator">=</span> <span class="built_in">FLOOR</span>(RAND()<span class="operator">*</span><span class="number">1000000</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> class_comment(comment_id, class_id, comment_text, comment_time, stu_id)</span><br><span class="line"><span class="keyword">VALUES</span>((<span class="keyword">START</span><span class="operator">+</span>i), <span class="number">10001</span>, comment_text, date_temp, stu_id);</span><br><span class="line">UNTIL i <span class="operator">=</span> max_num</span><br><span class="line"><span class="keyword">END</span> REPEAT;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#添加数据的存储过程的调用，一共<span class="number">1000000</span>条记录</span><br><span class="line"><span class="keyword">CALL</span> batch_insert_class_comments(<span class="number">10000</span>,<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">#########</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> student;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> class_comment;</span><br><span class="line"></span><br><span class="line">###需求######</span><br><span class="line"><span class="keyword">SELECT</span> p.comment_text, p.comment_time, stu.stu_name </span><br><span class="line"><span class="keyword">FROM</span> class_comment <span class="keyword">AS</span> p <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> student <span class="keyword">AS</span> stu </span><br><span class="line"><span class="keyword">ON</span> p.stu_id <span class="operator">=</span> stu.stu_id </span><br><span class="line"><span class="keyword">WHERE</span> p.class_id <span class="operator">=</span> <span class="number">10001</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> p.comment_id <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">#####进行反范式化的设计######</span><br><span class="line">#表的复制</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> class_comment1</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> class_comment;</span><br><span class="line"></span><br><span class="line">#添加主键，保证class_comment1 与class_comment的结构相同</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> class_comment1</span><br><span class="line"><span class="keyword">ADD</span> <span class="keyword">PRIMARY</span> KEY (comment_id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> INDEX <span class="keyword">FROM</span> class_comment1;</span><br><span class="line"></span><br><span class="line">#向课程评论表中增加stu_name字段</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> class_comment1</span><br><span class="line"><span class="keyword">ADD</span> stu_name <span class="type">VARCHAR</span>(<span class="number">25</span>);</span><br><span class="line"></span><br><span class="line">#给新添加的字段赋值</span><br><span class="line"><span class="keyword">UPDATE</span> class_comment1 c</span><br><span class="line"><span class="keyword">SET</span> stu_name <span class="operator">=</span> (</span><br><span class="line"><span class="keyword">SELECT</span> stu_name</span><br><span class="line"><span class="keyword">FROM</span> student s</span><br><span class="line"><span class="keyword">WHERE</span> c.stu_id <span class="operator">=</span> s.stu_id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#查询同样的需求</span><br><span class="line"><span class="keyword">SELECT</span> comment_text, comment_time, stu_name </span><br><span class="line"><span class="keyword">FROM</span> class_comment1 </span><br><span class="line"><span class="keyword">WHERE</span> class_id <span class="operator">=</span> <span class="number">10001</span> </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> comment_id <span class="keyword">DESC</span> </span><br><span class="line">LIMIT <span class="number">10000</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-6-3-3-反范式的新问题"><a href="#7-6-3-3-反范式的新问题" class="headerlink" title="7.6.3.3 反范式的新问题"></a>7.6.3.3 反范式的新问题</h4><ul>
<li>存储<strong>空间变大</strong>了 </li>
<li>一个表中字段做了修改，另一个表中冗余的字段也需要做同步修改，否则<strong>数据不一致</strong> </li>
<li>若采用存储过程来支持数据的更新、删除等额外操作，如果更新频繁，会非常<strong>消耗系统资源</strong> </li>
<li>在<strong>数据量小</strong>的情况下，反范式不能体现性能的优势，可能还会让数据库的设计更加<strong>复杂</strong></li>
</ul>
<h4 id="7-6-3-4-反范式的适用场景"><a href="#7-6-3-4-反范式的适用场景" class="headerlink" title="7.6.3.4 反范式的适用场景"></a>7.6.3.4 反范式的适用场景</h4><ul>
<li>当冗余信息有价值或者能<strong>大幅度提高查询效率</strong>的时候，我们才会采取反范式的优化</li>
</ul>
<blockquote>
<p><strong>1.增加冗余字段的建议</strong></p>
</blockquote>
<ul>
<li>增加冗余字段一定要符合如下两个条件，才可以考虑增加冗余字段：<ul>
<li>这个冗余字段<strong>不需要经常进行修改</strong></li>
<li>这个冗余字段<strong>查询的时候不可或缺</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>2.历史快照、历史数据的需要</strong></p>
</blockquote>
<ul>
<li>在现实生活中，经常需要一些冗余信息，比如订单中的收货人信息，包括姓名、电话和地址等。每次发生的<strong>订单收货信息</strong>都属于<strong>历史快照</strong>，需要进行保存，但用户可以随时修改自己的信息，这时保存这 些冗余信息是非常有必要的</li>
<li>反范式优化也常用在<strong>数据仓库</strong>的设计中，因为数据仓库通常<strong>存储历史数据</strong>，对增删改的实时性要求不 强，对历史数据的分析需求强。这时适当允许数据的冗余度，更方便进行数据分析</li>
<li>简单总结数据仓库和数据库在使用上的区别：<ul>
<li>数据库设计的目的在于<strong>捕获数据</strong>，数据仓库设计的目的在于<strong>分析数据</strong></li>
<li>数据库对数据的<strong>增删改查实时性</strong>要求强，需要存储在线的用户数据，而数据仓库存储的一般是<strong>历史数据</strong></li>
<li>数据库设计需要<strong>尽量避免冗余</strong>，但为了提高查询效率也允许一定的<strong>冗余度</strong>，而数据仓库在设计上更偏向采用反范式设计</li>
</ul>
</li>
</ul>
<h3 id="7-6-4-BCNF-巴斯范式"><a href="#7-6-4-BCNF-巴斯范式" class="headerlink" title="7.6.4 BCNF(巴斯范式)"></a>7.6.4 BCNF(巴斯范式)</h3><h4 id="7-6-4-1-概述"><a href="#7-6-4-1-概述" class="headerlink" title="7.6.4.1 概述"></a>7.6.4.1 概述</h4><ul>
<li>在3NF的基础上进行了改进，提出了<strong>巴斯范式（BCNF）</strong>，也叫做<strong>巴斯-科德范式（Boyce-Codd Normal Form）</strong>。BCNF被认为没有新的设计规范加入，只是对第三范式中设计规范要求更强，使得数据冗余度更小。所以，称为<strong>修正的第三范式</strong>，或<strong>扩充的第三范式</strong>，BCNF不被称为第四范式</li>
<li>若一个关系达到了第三范式，并且它只有一个候选键，或者它的每个候选键都是单属性，则该关系自然达到BCNF</li>
<li>一般来说，一个数据库设计符合3NF或BCNF就可以了</li>
</ul>
<h4 id="7-6-4-2-案例分析"><a href="#7-6-4-2-案例分析" class="headerlink" title="7.6.4.2 案例分析"></a>7.6.4.2 案例分析</h4><blockquote>
<p><strong>1.案例</strong></p>
</blockquote>
<ul>
<li><p>分析如下表的范式情况：</p>
<p><img src="image-20221209160649192.png" alt="MySQL之性能优化/image-20221209160649192"></p>
</li>
<li><p>在这个表中，一个仓库只有一个管理员，同时一个管理员也只管理一个仓库。我们先来梳理下这些属性 之间的依赖关系</p>
</li>
<li><p>仓库名决定了管理员，管理员也决定了仓库名，同时（仓库名，物品名）的属性集合可以决定数量这个 属性。这样，我们就可以找到数据表的候选键</p>
<ul>
<li><strong>候选键：</strong>是（管理员，物品名）和（仓库名，物品名），然后我们从候选键中选择一个作为<strong>主键</strong>，比 如（仓库名，物品名）</li>
<li><strong>主属性：</strong>包含在任一候选键中的属性，也就是仓库名，管理员和物品名</li>
<li><strong>非主属性</strong>：数量这个属性</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>2.是否符合三范式</strong></p>
</blockquote>
<ul>
<li>如何判断一张表的范式呢？我们需要根据范式的等级，从低到高来进行判断<ul>
<li>首先，数据表每个属性都是原子性的，符合 1NF 的要求</li>
<li>其次，数据表中非主属性”数量“都与候选键全部依赖，（仓库名，物品名）决定数量，（管理员，物品 名）决定数量。因此，数据表符合 2NF 的要求</li>
<li>最后，数据表中的非主属性，不传递依赖于候选键。因此符合 3NF 的要求</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>3.存在的问题</strong></p>
</blockquote>
<ul>
<li><p>既然数据表已经符合了 3NF 的要求，是不是就不存在问题了呢？我们来看下面的情况：</p>
<ul>
<li>1.增加一个仓库，但是还没有存放任何物品。根据数据表实体完整性的要求，主键不能有空值，因此会出现<strong>插入异常</strong></li>
<li>2.如果仓库更换了管理员，我们就可能会<strong>修改数据表中的多条记录</strong></li>
<li>3.如果仓库里的商品都卖空了，那么此时仓库名称和相应的管理员名称也会随之被删除</li>
</ul>
</li>
<li><p>能看到，即便数据表符合 3NF 的要求，同样可能存在插入，更新和删除数据的异常情况</p>
</li>
</ul>
<blockquote>
<p><strong>4.问题解决</strong></p>
</blockquote>
<ul>
<li><p>首先我们需要确认造成异常的原因：主属性仓库名对于候选键（管理员，物品名）是部分依赖的关系， 这样就有可能导致上面的异常情况。因此引入BCNF，<strong>它在 3NF 的基础上消除了主属性对候选键的部分依赖或者传递依赖关系</strong></p>
<ul>
<li>如果在关系R中，U为主键，A属性是主键的一个属性，若存在A-&gt;Y，Y为主属性，则该关系不属于 BCNF</li>
</ul>
</li>
<li><p>根据 BCNF 的要求，我们需要把仓库管理关系 warehouse_keeper 表拆分成下面这样：</p>
<ul>
<li><strong>仓库表：</strong>（仓库名，管理员） </li>
<li><strong>库存表：</strong>（仓库名，物品名，数量）</li>
</ul>
</li>
<li><p>这样就不存在主属性对于候选键的部分依赖或传递依赖，上面数据表的设计就符合 BCNF</p>
</li>
<li><p>再举例： </p>
<ul>
<li><p>有一个<strong>学生导师表</strong>，其中包含字段：学生ID，专业，导师，专业GPA，这其中学生ID和专业是联合主键</p>
<table>
<thead>
<tr>
<th>StudentId</th>
<th>Major</th>
<th>Advisor</th>
<th>MajGPA</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>人工智能</td>
<td>Edward</td>
<td>4.0</td>
</tr>
<tr>
<td>2</td>
<td>大数据</td>
<td>William</td>
<td>3.8</td>
</tr>
<tr>
<td>1</td>
<td>大数据</td>
<td>William</td>
<td>3.7</td>
</tr>
<tr>
<td>3</td>
<td>大数据</td>
<td>Joseph</td>
<td>4.0</td>
</tr>
</tbody></table>
</li>
<li><p>这个表的设计满足三范式，但是这里存在另一个依赖关系，“专业”依赖于“导师”，也就是说每个导师只 做一个专业方面的导师，只要知道了是哪个导师，我们自然就知道是哪个专业的了</p>
</li>
<li><p>所以这个表的部分主键Major依赖于非主键属性Advisor，那么我们可以进行以下的调整，拆分成2个表：</p>
<ul>
<li><p>学生导师表：</p>
<table>
<thead>
<tr>
<th>StudentId</th>
<th>Advisor</th>
<th>MajGPA</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Edward</td>
<td>4.0</td>
</tr>
<tr>
<td>2</td>
<td>William</td>
<td>3.8</td>
</tr>
<tr>
<td>1</td>
<td>William</td>
<td>3.7</td>
</tr>
<tr>
<td>3</td>
<td>Joseph</td>
<td>4.0</td>
</tr>
</tbody></table>
</li>
<li><p>导师表：</p>
<table>
<thead>
<tr>
<th>Advisor</th>
<th>Major</th>
</tr>
</thead>
<tbody><tr>
<td>Edward</td>
<td>人工智能</td>
</tr>
<tr>
<td>William</td>
<td>大数据</td>
</tr>
<tr>
<td>William</td>
<td>大数据</td>
</tr>
<tr>
<td>Joseph</td>
<td>大数据</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="7-6-5-第四范式"><a href="#7-6-5-第四范式" class="headerlink" title="7.6.5 第四范式"></a>7.6.5 第四范式</h3><ul>
<li><p>多值依赖的概念：</p>
<ul>
<li><strong>多值依赖：</strong>即属性之间的一对多关系，记为K-&gt;-&gt;A</li>
<li><strong>函数依赖：</strong>事实上是单值依赖，所以不能表达属性值之间的一对多关系</li>
<li><strong>平凡的多值依赖：</strong>全集U&#x3D;K+A，一个K可以对应于多个A，即K-&gt;-&gt;A。此时整个表就是一组一对多关系</li>
<li><strong>非平凡的多值依赖：</strong>全集U&#x3D;K+A+B，一个K可以对应于多个A，也可以对应于多个B，A与B相互独立，即K-&gt;-&gt;A，K-&gt;-&gt;B。整个表有多组一对多关系，且有：”一”部分是相同的属性集合，”多”部分是相互独立的属性集合</li>
</ul>
</li>
<li><p>第四范式即在满足巴斯-科德范式（BCNF）的基础上，消除非平凡且非函数依赖的多值依赖（即把同一表内的多对多关系删除）</p>
</li>
<li><p>举例1：职工表(职工编号，职工孩子姓名，职工选修课程)</p>
<ul>
<li>在这个表中，同一个职工可能会有多个职工孩子姓名。同样，同一个职工也可能会有多个职工选修课 程，即这里存在着多值事实，不符合第四范式</li>
<li>如果要符合第四范式，只需要将上表分为两个表，使它们只有一个多值事实，例如：<strong>职工表一</strong> (职工编 号，职工孩子姓名)，<strong>职工表二</strong> (职工编号，职工选修课程)，两个表都只有一个多值事实，所以符合第四 范式</li>
</ul>
</li>
<li><p><strong>举例2：</strong></p>
<ul>
<li><p>比如建立课程、教师、教材的模型。我们规定，每门课程有对应的一组教师，每门课程也有对应的 一组教材，一门课程使用的教材和教师没有关系。我们建立的关系表如下： </p>
<ul>
<li><p>课程ID，教师ID，教材ID；这三列作为联合主键</p>
</li>
<li><p>为了表述方便，用Name代替ID，这样更容易看懂：</p>
<table>
<thead>
<tr>
<th>Course</th>
<th>Teacher</th>
<th>Book</th>
</tr>
</thead>
<tbody><tr>
<td>英语</td>
<td>Bill</td>
<td>人教版英语</td>
</tr>
<tr>
<td>英语</td>
<td>Bill</td>
<td>美版英语</td>
</tr>
<tr>
<td>英语</td>
<td>Jay</td>
<td>美版英语</td>
</tr>
<tr>
<td>高数</td>
<td>William</td>
<td>人教版高数</td>
</tr>
<tr>
<td>高数</td>
<td>Dave</td>
<td>美版高数</td>
</tr>
</tbody></table>
</li>
<li><p>这个表除了主键，就没有其他字段了，所以肯定满足BC范式，但是却存在<strong>多值依赖</strong>导致的异常</p>
</li>
<li><p>假如下学期想采用一本新的英版高数教材，但是还没确定具体哪个老师来教，那么就无法在这 个表中维护Course高数和Book英版高数教材的的关系</p>
</li>
<li><p>解决办法是把这个多值依赖的表拆解成2个表，分别建立关系。这是拆分后的表：</p>
<table>
<thead>
<tr>
<th>Course</th>
<th>Teacher</th>
</tr>
</thead>
<tbody><tr>
<td>英语</td>
<td>Bill</td>
</tr>
<tr>
<td>英语</td>
<td>Jay</td>
</tr>
<tr>
<td>高数</td>
<td>William</td>
</tr>
<tr>
<td>高数</td>
<td>Dave</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Course</th>
<th>Book</th>
</tr>
</thead>
<tbody><tr>
<td>英语</td>
<td>人教版英语</td>
</tr>
<tr>
<td>英语</td>
<td>美版英语</td>
</tr>
<tr>
<td>高数</td>
<td>人教版高数</td>
</tr>
<tr>
<td>高数</td>
<td>美版高数</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="7-6-6-第五范式、域键范式"><a href="#7-6-6-第五范式、域键范式" class="headerlink" title="7.6.6 第五范式、域键范式"></a>7.6.6 第五范式、域键范式</h3><ul>
<li><p>除了第四范式外，我们还有更高级的第五范式（又称完美范式）和域键范式（DKNF）</p>
</li>
<li><p>在满足第四范式（4NF）的基础上，消除不是由候选键所蕴含的连接依赖。<strong>如果关系模式R中的每一个连 接依赖均由R的候选键所隐含</strong>，则称此关系模式符合第五范式</p>
</li>
<li><p>函数依赖是多值依赖的一种特殊的情况，而多值依赖实际上是连接依赖的一种特殊情况。但连接依赖不 像函数依赖和多值依赖可以由<strong>语义直接导出</strong>，而是在<strong>关系连接运算</strong>时才反映出来。存在连接依赖的关系 模式仍可能遇到数据冗余及插入、修改、删除异常等问题</p>
</li>
<li><p>第五范式处理的是<strong>无损连接问题</strong>，这个范式基本<strong>没有实际意义</strong>，因为无损连接很少出现，而且难以察 觉。而域键范式试图定义一个<strong>终极范式</strong>，该范式考虑所有的依赖和约束类型，但是实用价值也是最小 的，只存在理论研究中</p>
</li>
</ul>
<h2 id="7-7-数据库其它调优策略"><a href="#7-7-数据库其它调优策略" class="headerlink" title="7.7 数据库其它调优策略"></a>7.7 数据库其它调优策略</h2><p>p156-P160</p>
<h1 id="8-事务"><a href="#8-事务" class="headerlink" title="8.事务"></a>8.事务</h1><h2 id="8-1-事务基础知识"><a href="#8-1-事务基础知识" class="headerlink" title="8.1 事务基础知识"></a>8.1 事务基础知识</h2><h3 id="8-1-1-数据库事务概述"><a href="#8-1-1-数据库事务概述" class="headerlink" title="8.1.1 数据库事务概述"></a>8.1.1 数据库事务概述</h3><ul>
<li>事务是数据库区别于文件系统的重要特性之一，当有了事务就会让数据库始终保持一致性，同时还能通过事务的机制恢复到某个时间点，这样可以保证已提交到数据库的修改不会因为系统崩溃而丢失</li>
</ul>
<h4 id="8-1-1-1-存储引擎支持情况"><a href="#8-1-1-1-存储引擎支持情况" class="headerlink" title="8.1.1.1 存储引擎支持情况"></a>8.1.1.1 存储引擎支持情况</h4><ul>
<li><p>SHOW ENGINES 命令来查看当前 MySQL 支持的存储引擎都有哪些，以及这些存储引擎是否支持事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> ENGINES;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> Engine             <span class="operator">|</span> Support <span class="operator">|</span> Comment                                                        <span class="operator">|</span> Transactions <span class="operator">|</span> XA   <span class="operator">|</span> Savepoints <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="operator">|</span> InnoDB             <span class="operator">|</span> <span class="keyword">DEFAULT</span> <span class="operator">|</span> Supports transactions, <span class="type">row</span><span class="operator">-</span>level locking, <span class="keyword">and</span> <span class="keyword">foreign</span> keys     <span class="operator">|</span> YES          <span class="operator">|</span> YES  <span class="operator">|</span> YES        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MRG_MYISAM         <span class="operator">|</span> YES     <span class="operator">|</span> Collection <span class="keyword">of</span> identical MyISAM tables                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MEMORY             <span class="operator">|</span> YES     <span class="operator">|</span> Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables      <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BLACKHOLE          <span class="operator">|</span> YES     <span class="operator">|</span> <span class="operator">/</span>dev<span class="operator">/</span><span class="keyword">null</span> storage engine (anything you write <span class="keyword">to</span> it disappears) <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MyISAM             <span class="operator">|</span> YES     <span class="operator">|</span> MyISAM storage engine                                          <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CSV                <span class="operator">|</span> YES     <span class="operator">|</span> CSV storage engine                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> ARCHIVE            <span class="operator">|</span> YES     <span class="operator">|</span> Archive storage engine                                         <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> PERFORMANCE_SCHEMA <span class="operator">|</span> YES     <span class="operator">|</span> Performance Schema                                             <span class="operator">|</span> <span class="keyword">NO</span>           <span class="operator">|</span> <span class="keyword">NO</span>   <span class="operator">|</span> <span class="keyword">NO</span>         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FEDERATED          <span class="operator">|</span> <span class="keyword">NO</span>      <span class="operator">|</span> Federated MySQL storage engine                                 <span class="operator">|</span> <span class="keyword">NULL</span>         <span class="operator">|</span> <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>能看出在MysQL中，只有InnoDB是支持事务的</p>
</li>
</ul>
<h4 id="8-1-1-2-基本概念"><a href="#8-1-1-2-基本概念" class="headerlink" title="8.1.1.2 基本概念"></a>8.1.1.2 基本概念</h4><ul>
<li><p><strong>事务</strong>：一组逻辑操作单元，使数据从一种状态变换到另一种状态</p>
</li>
<li><p><strong>事务处理的原则：</strong>保证所有事务都作为<strong>一个工作单元</strong>来执行，即使出现了故障，都不能改变这种执行方式。当在一个事务中执行多个操作时，要么所有的事务都被提交( commit )，那么这些修改就<strong>永久</strong>地保存下来；要么数据库管理系统将<strong>放弃</strong>所作的所有<strong>修改</strong>，整个事务回滚**( rollback )**到最初状态</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#案例: AA用户给BB用户转账<span class="number">100</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">-</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;AA&#x27;</span>;</span><br><span class="line">#服务器宕机</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">+</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;BB&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-1-1-3-事务的ACID特性"><a href="#8-1-1-3-事务的ACID特性" class="headerlink" title="8.1.1.3 事务的ACID特性"></a>8.1.1.3 事务的ACID特性</h4><ul>
<li><p><strong>原子性(atomicity)</strong></p>
<ul>
<li>原子性是指事务是一个不可分割的工作单位，要么<strong>全部提交</strong>，要么<strong>全部失败回滚</strong>。即要么转账成功，要么转账失败，是不存在中间的状态。如果无法保证原子性会怎么样?就会出现数据不一致的情形，A账户减去100元，而B账户增加100元操作失败，系统将无故丢失100元</li>
</ul>
</li>
<li><p><strong>一致性(consistency)</strong></p>
<ul>
<li>根据定义，<strong>一致性是指事务执行前后，数据从一个合法性状态变换到另外一个合法性状态</strong>。这种状态是语义上的而不是语法上的，跟具体的业务有关</li>
<li><strong>补充：</strong><ul>
<li>某本书上的一致性概念–&gt; 一致性:在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发地完成预定的工作</li>
<li>那什么是合法的数据状态呢?满足<strong>预定的约束</strong>的状态就叫做合法的状态。通俗一点，这状态是由你自己来定义的(比如满足现实世界中的约束)。满足这个状态，数据就是一致的，不满足这个状态，数据就是不一致的!如果事务中的某个操作失败了，系统就会自动撤销当前正在执行的事务，返回到事务操作之前的状态</li>
<li><strong>举例1：</strong>A账户有200元，转账300元出去，此时A账户余额为-100元。你自然就发现了此时数据是不一致的，为什么呢?因为你定义了一个状态，余额这列必须&gt;&#x3D;0</li>
<li><strong>举例2：</strong>A账户200元。转账50元给B账户，A账户的钱扣了，但是B账户因为各种意外，余额并没有增加。你也知道此时数据是不一致的，为什么呢?因为你定义了一个状态，要求A+E的总余额必须不。</li>
<li><strong>举例3：</strong>在数据表中将<strong>姓名</strong>字段设置为<strong>唯一性约束</strong>，这时当事务进行提交或者事务发生回滚的时候，如果数据表中的姓名不唯一，就破坏了事务的一致性要求</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>隔离型(isolation)</strong></p>
<ul>
<li><p>事务的隔离性是指<strong>一个事务的执行不能被其他事务干扰 ，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰</strong></p>
</li>
<li><p>如果无法保证隔离性会怎么样？假设A账户有200元，B账户0元。A账户往B账户转账两次，每次金额为50元，分别在两个事务中执行。如果无法保证隔离性，会出现下面的情形：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#案例: AA用户给BB用户转账<span class="number">100</span></span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">-</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;AA&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">+</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;BB&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221209224224867.png" alt="MySQL之性能优化/image-20221209224224867"></p>
</li>
</ul>
</li>
<li><p><strong>持久性（durability）</strong></p>
<ul>
<li>持久性是指一个事务一旦被提交，它对数据库中数据的改变就是 永久性的 ，接下来的其他操作和数据库故障不应该对其有任何影响</li>
<li>持久性是通过<strong>事务日志</strong>来保证的。日志包括了<strong>重做日志</strong>和<strong>回滚日志</strong>。当我们通过事务对数据进行修改的时候，首先会将数据库的变化信息记录到重做日志中，然后再对数据库中对应的行进行修改。这样做的好处是，即使数据库系统崩溃，数据库重启后也能找到没有更新到数据库系统中的重做日志，重新执行，从而使事务具有持久性</li>
</ul>
</li>
</ul>
<blockquote>
<p>总结<br>ACID是事务的四大特性，在这四个特性中，原子性是基础，隔离性是手段，一致性是约束条件，而持久性是目的</p>
<p>数据库事务，其实就是数据库设计者为了方便起见，把需要保证原子性、隔离性、一致性和持久性的一个或多个数据库操作称为一个事务</p>
</blockquote>
<h4 id="8-1-1-4-事务的状态"><a href="#8-1-1-4-事务的状态" class="headerlink" title="8.1.1.4 事务的状态"></a>8.1.1.4 事务的状态</h4><ul>
<li><p>现在知道<strong>事务</strong>是一个抽象的概念，它其实对应着一个或多个数据库操作，MySQL根据这些操作所执行的不同阶段把<strong>事务</strong>大致划分成几个状态：</p>
</li>
<li><p><strong>活动的（active）</strong></p>
<ul>
<li>事务对应的数据库操作正在执行过程中时，就说该事务处在<strong>活动的</strong>状态</li>
</ul>
</li>
<li><p><strong>部分提交的（partially committed）</strong></p>
<ul>
<li>当事务中的最后一个操作执行完成，但由于操作都在内存中执行，所造成的影响并<strong>没有刷新到磁盘时</strong>，就说该事务处在<strong>部分提交的</strong>状态</li>
</ul>
</li>
<li><p><strong>失败的（failed）</strong></p>
<ul>
<li>当事务处在<strong>活动的</strong>或者<strong>部分提交的</strong>状态时，可能遇到了某些错误（数据库自身的错误、操作系统错误或者直接断电等）而无法继续执行，或者人为的停止当前事务的执行，就说该事务处在失败的状态</li>
</ul>
</li>
<li><p><strong>中止的（aborted）</strong></p>
<ul>
<li><p>如果事务执行了一部分而变为<strong>失败的</strong>状态，那么就需要把已经修改的事务中的操作还原到事务执行前的状态。换句话说，就是要撤销失败事务对当前数据库造成的影响。把这个撤销的过程称之为<strong>回滚</strong>。当<strong>回滚</strong>操作执行完毕时，也就是数据库恢复到了执行事务之前的状态，就说该事务处在了<strong>中止的</strong>状态</p>
</li>
<li><p>举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">-</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;AA&#x27;</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> accounts <span class="keyword">SET</span> money <span class="operator">=</span> money <span class="operator">+</span> <span class="number">50</span> <span class="keyword">WHERE</span> NAME <span class="operator">=</span> <span class="string">&#x27;BB&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><h5 id="提交的（committed）"><a href="#提交的（committed）" class="headerlink" title="提交的（committed）"></a>提交的（committed）</h5><ul>
<li>当一个处在<strong>部分提交的</strong>状态的事务将修改过的数据都<strong>同步到磁盘上</strong>之后，就可以说该事务处在了<strong>提交的</strong>状态</li>
</ul>
</li>
<li><p>一个基本的状态转换图如下所示：</p>
<p><img src="image-20221209231303743.png" alt="MySQL之性能优化/image-20221209231303743"></p>
</li>
</ul>
<h3 id="8-1-2-如何使用事务"><a href="#8-1-2-如何使用事务" class="headerlink" title="8.1.2 如何使用事务"></a>8.1.2 如何使用事务</h3><ul>
<li>使用事务有两种方式，分别为<strong>显式事务</strong>和<strong>隐式事务</strong></li>
</ul>
<h4 id="8-1-2-1-显式事务"><a href="#8-1-2-1-显式事务" class="headerlink" title="8.1.2.1 显式事务"></a>8.1.2.1 显式事务</h4><ul>
<li><p><strong>步骤1</strong>： START TRANSACTION 或者 BEGIN ，作用是显式开启一个事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>START TRANSACTION 语句相较于 BEGIN 特别之处在于，后边能跟随几个<strong>修饰符</strong>：</p>
<ul>
<li><p>READ ONLY ：标识当前事务是一个<strong>只读事务</strong>，也就是属于该事务的数据库操作只能读取数据，而不<br>能修改数据</p>
<blockquote>
<p>补充:只读事务中只是不允许修改那些其他事务也能访问到的表中的数据，对于临时表来说(使用CREATE TMEPORARY TABLE创建的表)，由于它们只能在当前会话中可见，所以只读事务其实也是可以对临时表进行增、删、改操作的</p>
</blockquote>
</li>
<li><p>② READ WRITE ：标识当前事务是一个读写事务 ，也就是属于该事务的数据库操作既可以读取数据，也可以修改数据</p>
</li>
<li><p>③ WITH CONSISTENT SNAPSHOT ：启动一致性读</p>
<ul>
<li><p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">START</span> TRANSACTION READ <span class="keyword">ONLY</span>;#开启一个只读事务</span><br><span class="line"><span class="keyword">START</span> TRANSACTION READ <span class="keyword">ONLY</span>,<span class="keyword">WITH</span> CONSISTENT SNAPSHOT;#开启只读事多和一致性读</span><br><span class="line"><span class="keyword">START</span> TRANSACTION READ WRITE,<span class="keyword">WITH</span> CONSISTENT SNAPSHOT;#开启读写事务和一致性读</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>注意：</p>
<ul>
<li>READ ONLY和READ WRITE是用来设置所谓的事务访问模式的，就是以只读还是读写的方式来访问数据库中的数据，一个事务的访问模式不能同时既设置为只读的又设置为读写的，所以不能同时把READ ONLY和READ WRITE放到START TRANSACTION语句后边</li>
<li>如果不显式指定事务的访问模式，那么该事务的访问模式就是读写模式</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>步骤2</strong>：一系列事务中的操作（主要是DML，不含DDL）</p>
</li>
<li><p><strong>步骤3</strong>：提交事务 或 中止事务（即回滚事务）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 提交事务。当提交事务后，对数据库的修改是永久性的</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"># 回滚事务。即撤销正在进行的所有没有提交的修改</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"># 将事务回滚到某个保存点</span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> [<span class="keyword">SAVEPOINT</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>其中关于SAVEPOINT相关操作有：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#在事务中创建保存点，方便后续针对保存点进行回滚。一个事务中可么存在多个保存点</span><br><span class="line"><span class="keyword">SAVEPOINT</span> 保存点名称;</span><br><span class="line">#删除某个保存点</span><br><span class="line"><span class="keyword">RELEASE</span> <span class="keyword">SAVEPOINT</span>保存点名称；</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="8-1-2-2-隐式事务"><a href="#8-1-2-2-隐式事务" class="headerlink" title="8.1.2.2 隐式事务"></a>8.1.2.2 隐式事务</h4><ul>
<li><p>MySQL中有一个系统变量 autocommit ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;autocommit&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="operator">|</span> autocommit    <span class="operator">|</span> <span class="keyword">ON</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认情况下，如果不显式的使用<code>START TRANSACTION</code>或者<code>BEGIN</code>语句开启一个事务，那么每一条语句都算是一个独立的事务，这种特性称之为事务的自动提交。也就是说，不以<code>START TRANSACTION</code>或者<code>BEGIN</code>语句显式的开启一个事务，那么下边这两条语句就相当于放到两个独立的事务中去执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#  关键字：autocommit </span><br><span class="line">#<span class="keyword">set</span> autocommit <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;autocommit&#x27;</span>;#默认是<span class="keyword">ON</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; #此时这条DML操作是一个独立的事务</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>; #此时这条DML操作是一个独立的事务</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>当然，如果想关闭这种自动提交的功能，可以使用下边两种方法之一：</strong></p>
<ul>
<li><p>显式的的使用 START TRANSACTION 或者 BEGIN<br>语句开启一个事务。这样在本次事务提交或者回滚前会暂时关闭掉自动提交的功能。</p>
</li>
<li><p>把系统变量 autocommit 的值设置为<strong>OFF</strong>，就像这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> OFF;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>这样的话，写入的多条语句就算是属于同一个事务了，直到我们显式的写出COMNIT语句来把这个事务提交掉，或者显式的写出ROLLBACK语句来把这个事务回滚掉</p>
</li>
</ul>
<blockquote>
<p><strong>补充:</strong> Oracle 默认不自动提交，需要手写COMMIT命令，而MySQL 默认自动提交</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#  如何关闭自动提交？</span><br><span class="line">#方式<span class="number">1</span>：</span><br><span class="line"><span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="literal">FALSE</span>; #针对于DML操作是有效的，对DDL操作是无效的</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>; #或<span class="keyword">rollback</span>;</span><br><span class="line"></span><br><span class="line">#方式<span class="number">2</span>：在autocommit为<span class="literal">true</span>的情况下，使用<span class="keyword">start</span> transaction 或<span class="keyword">begin</span>开启事务，那么DML操作就不会自动提交数据</span><br><span class="line"></span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">10</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">2</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>; #或<span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure>

<h4 id="8-1-2-3-隐式提交数据的情况"><a href="#8-1-2-3-隐式提交数据的情况" class="headerlink" title="8.1.2.3 隐式提交数据的情况"></a>8.1.2.3 隐式提交数据的情况</h4><ul>
<li><h5 id="数据定义语言-Data-definition-language，缩写为-DDL"><a href="#数据定义语言-Data-definition-language，缩写为-DDL" class="headerlink" title="数据定义语言(Data definition language，缩写为:DDL)"></a>数据定义语言(Data definition language，缩写为:DDL)</h5><ul>
<li><p>数据库对象，指的就是<strong>数据库、表、视图、存储过程</strong>等结构。当使用<strong>CREATE 、ALTER、 DROP</strong>等语句去修改数据库对象时，就会隐式的提交前边语句所属于的事务。即：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> ... #事务中的一条语句</span><br><span class="line"><span class="keyword">UPDATE</span> ...#事务中的一条语句</span><br><span class="line">...  #丰务中的其它语句</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> ...# 此语句会隐式的提交前边语句所属于的事务</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><h5 id="隐式使用或修改mysql数据库中的表"><a href="#隐式使用或修改mysql数据库中的表" class="headerlink" title="隐式使用或修改mysql数据库中的表"></a>隐式使用或修改mysql数据库中的表</h5><ul>
<li>当使用<strong>ALTER USER、CREATE USER、DROP USER 、GRANT、RENAME USER、REVOKE. SET PASSWORD</strong>等语句时也会隐式的提交前边语句所属于的事务</li>
</ul>
</li>
<li><h5 id="事务控制或关于锁定的语句"><a href="#事务控制或关于锁定的语句" class="headerlink" title="事务控制或关于锁定的语句"></a>事务控制或关于锁定的语句</h5><ul>
<li><p>当在一个事务还没提交或者回滚时就又使用<strong>START TRANSACTION</strong>或者<strong>BEGIN</strong>语句开启了另一个事务时，会<strong>隐式的提交</strong>上—个事务。即：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> ... #事务中的一条语句</span><br><span class="line"><span class="keyword">UPDATE</span> ... #事务中的一条语句</span><br><span class="line">...       #事务中的其它语句</span><br><span class="line"><span class="keyword">BEGIN</span>;   #此语句会隐式的提交前面语句所属于的事务</span><br></pre></td></tr></table></figure>
</li>
<li><p>② 当前的 <strong>autocommit</strong> 系统变量的值为 <strong>OFF</strong> ，我们手动把它调为 <strong>ON</strong> 时，也会<strong>隐式的提交</strong>前边语<br>句所属的事务<br>③ 使用 <strong>LOCK TABLES 、 UNLOCK TABLES</strong> 等关于锁定的语句也会<strong>隐式的提交</strong>前边语句所属的事务</p>
</li>
</ul>
</li>
<li><p><strong>加载数据的语句</strong></p>
<ul>
<li>使用<strong>LOAD DATA</strong>语句来批量往数据库中导入数据时，也会<strong>隐式的提交</strong>前边语句所属的事务</li>
</ul>
</li>
<li><p><strong>关于MySQL复制的一些语句</strong></p>
<ul>
<li>使用<strong>START SLAVE、STOP SLAVE、RESET SLAVE、CHANGE MASTER TO</strong>等语句时会<strong>隐式的提交</strong>前边语句所属的事务</li>
</ul>
</li>
<li><p><strong>其它的一些语句</strong></p>
<ul>
<li>使用<strong>ANALYZE TABLE、CACHE INDEX、CHECK TABLE、FLUSH、LOAD INDEX INTO CACHE 、0PTIMIZE TABLE、REPAIR TABLE、RESET</strong> 等语句也会<strong>隐式的提交</strong>前边语句所属的事务</li>
</ul>
</li>
</ul>
<h4 id="8-1-2-4-使用举例1：提交与回滚"><a href="#8-1-2-4-使用举例1：提交与回滚" class="headerlink" title="8.1.2.4 使用举例1：提交与回滚"></a>8.1.2.4 使用举例1：提交与回滚</h4><ul>
<li><p>看下在 MySQL 的默认状态下，下面这个事务最后的处理结果是什么</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"># 案例分析</span><br><span class="line">#<span class="keyword">SET</span> autocommit <span class="operator">=</span> <span class="literal">TRUE</span>; </span><br><span class="line">#举例<span class="number">1</span>： <span class="keyword">commit</span> 和 <span class="keyword">rollback</span></span><br><span class="line"></span><br><span class="line">USE atguigudb2;</span><br><span class="line">#情况<span class="number">1</span>：</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user3(`name` <span class="type">VARCHAR</span>(<span class="number">15</span>) <span class="keyword">PRIMARY</span> KEY);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;张三&#x27;</span>); #此时不会自动提交数据</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>; #开启一个新的事务</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>); #此时不会自动提交数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>); #受主键的影响，不能添加成功</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#情况<span class="number">2</span>：</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> user3;  #DDL操作会自动提交数据，不受autocommit变量的影响。</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;张三&#x27;</span>); #此时不会自动提交数据</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>);# 默认情况下(即autocommit为<span class="literal">true</span>)，DML操作也会自动提交数据。</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>); #事务的失败的状态</span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> 李四   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#情况<span class="number">3</span>：</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> user3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> @<span class="variable">@completion</span>_type;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@completion</span>_type <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="operator">|</span> NO_CHAIN          <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SET</span> @<span class="variable">@completion</span>_type <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;张三&#x27;</span>); </span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3 <span class="keyword">VALUES</span>(<span class="string">&#x27;李四&#x27;</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>能看到相同的SQL代码，只是在事务开始之前设置了SET @@completion_type &#x3D; 1;结果就和第一次处理的一样，只有一个“张三”。这是为什么呢?</p>
</li>
<li><p>这里讲解下 MySQL中completion_type参数的作用，实际上这个参数有3种可能:</p>
<ul>
<li><strong>completion&#x3D;0</strong>，这是<strong>默认情况</strong>。当执行COMNIT的时候会提交事务，在执行下一个事务时，还需要使<strong>START TRANSACTION</strong> 或者<strong>BEGIN</strong>来开启</li>
<li><strong>completion&#x3D;1</strong>，这种情况下，当提交事务后，相当于执行了<strong>COMMIT AND CHAIN</strong>，也就是开启一个<br>链式事务，即提交事务之后会开启一个相同隔离级别的事务</li>
<li><strong>completion&#x3D;2</strong>，这种情况下<strong>CONMMIT&#x3D;COMMIT AND RELEASE</strong>，也就是提交后，会自动与服务器断开连接</li>
</ul>
</li>
</ul>
<blockquote>
<p>当设置 autocommit&#x3D;0 时，不论是否采用 START TRANSACTION 或者 BEGIN 的方式来开启事务，都需要用 COMMIT 进行提交，让事务生效，使用 ROLLBACK 对事务进行回滚</p>
<p>当设置 autocommit&#x3D;1 时，每条 SQL 语句都会自动进行提交。 不过这时，如果采用 START<br>TRANSACTION 或者 BEGIN 的方式来显式地开启事务，那么这个事务只有在 COMMIT 时才会生效，在 ROLLBACK 时才会回滚</p>
</blockquote>
<h4 id="8-1-2-5-使用举例2：测试不支持事务的engine"><a href="#8-1-2-5-使用举例2：测试不支持事务的engine" class="headerlink" title="8.1.2.5 使用举例2：测试不支持事务的engine"></a>8.1.2.5 使用举例2：测试不支持事务的engine</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#举例<span class="number">2</span>：体会INNODB 和 MyISAM</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test1(i <span class="type">INT</span>) ENGINE <span class="operator">=</span> INNODB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test2(i <span class="type">INT</span>) ENGINE <span class="operator">=</span> MYISAM;</span><br><span class="line"></span><br><span class="line">#针对于innodb表</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test1 <span class="keyword">VALUES</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test1;</span><br><span class="line">#<span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#针对于myisam表:不支持事务</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test2 <span class="keyword">VALUES</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> test2;</span><br><span class="line">##<span class="keyword">Empty</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-1-2-6-使用举例3：SAVEPOINT"><a href="#8-1-2-6-使用举例3：SAVEPOINT" class="headerlink" title="8.1.2.6 使用举例3：SAVEPOINT"></a>8.1.2.6 使用举例3：SAVEPOINT</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#举例<span class="number">3</span>：体会<span class="keyword">savepoint</span></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE atguigudb3;</span><br><span class="line"></span><br><span class="line">USE atguigudb3;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user3(`name` <span class="type">VARCHAR</span>(<span class="number">15</span>),balance <span class="type">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> user3(`name`,balance) <span class="keyword">VALUES</span>(<span class="string">&#x27;张三&#x27;</span>,<span class="number">1000</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> balance <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span> <span class="number">1000.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> user3 <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> user3 <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SAVEPOINT</span> s1;#设置保存点</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> user3 <span class="keyword">SET</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">1</span> <span class="keyword">WHERE</span> `name` <span class="operator">=</span> <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> s1; #回滚到保存点</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> balance <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span>   <span class="number">800.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">ROLLBACK</span>; #回滚操作</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> user3;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> name   <span class="operator">|</span> balance <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="operator">|</span> 张三   <span class="operator">|</span> <span class="number">1000.00</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+---------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="8-1-3-事务隔离级别"><a href="#8-1-3-事务隔离级别" class="headerlink" title="8.1.3 事务隔离级别"></a>8.1.3 事务隔离级别</h3><ul>
<li>MySQL是一个 <strong>客户端／服务器</strong> 架构的软件，对于同一个服务器来说，可以有若干个客户端与之连接，每个客户端与服务器连接上之后，就可以称为一个会话（ <strong>Session</strong> ）。每个客户端都可以在自己的会话中向服务器发出请求语句，一个请求语句可能是某个事务的一部分，也就是对于服务器来说可能同时处理多个事务。事务有 <strong>隔离性</strong> 的特性，理论上在某个事务 <strong>对某个数据进行访问</strong> 时，其他事务应该进行 <strong>排队</strong> ，当该事务提交之后，其他事务才可以继续访问这个数据。但是这样对 <strong>性能影响太大</strong> ，我们既想保持事务的隔离性，又想让服务器在处理访问同一数据的多个事务时 <strong>性能尽量高些</strong> ，那就看二者如何权衡取舍了</li>
</ul>
<h4 id="8-1-3-1-数据准备"><a href="#8-1-3-1-数据准备" class="headerlink" title="8.1.3.1 数据准备"></a>8.1.3.1 数据准备</h4><ul>
<li><p>创建一个表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student (</span><br><span class="line">    studentno <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    class <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (studentno)</span><br><span class="line">) Engine<span class="operator">=</span>InnoDB CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后向这个表里插入一条数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="string">&#x27;小谷&#x27;</span>, <span class="string">&#x27;1班&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在表里的数据就是这样的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student;</span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">+-----------+--------+-------+</span></span><br><span class="line"><span class="comment">| studentno | name   | class  |</span></span><br><span class="line"><span class="comment">+-----------+--------+-------+</span></span><br><span class="line"><span class="comment">| 1         | 小谷    | 1班   |</span></span><br><span class="line"><span class="comment">+-----------+--------+-------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-1-3-2-数据并发问题"><a href="#8-1-3-2-数据并发问题" class="headerlink" title="8.1.3.2 数据并发问题"></a>8.1.3.2 数据并发问题</h4><ul>
<li>针对事务的隔离性和并发性怎么做取舍呢？先看一下访问相同数据的事务在 <strong>不保证串行执行</strong> （也就是执行完一个再执行另一个）的情况下可能会出现哪些问题：</li>
</ul>
<blockquote>
<p><strong>1. 脏写（ Dirty Write ）</strong></p>
</blockquote>
<ul>
<li><p>对于两个事务 Session A、Session B，如果事务Session A <strong>修改了</strong> 另一个 <strong>未提交</strong> 事务Session B <strong>修改过</strong> 的数据，那就意味着发生了<strong>脏写</strong></p>
<p><img src="image-20221210164115069.png" alt="MySQL之性能优化/image-20221210164115069"></p>
</li>
<li><p>Session A和Sessione各开启了一个事务，Session B中的事务先将studentno列为1的记录的name列更新为李四，然后Session A中的事务接着又把这条studentno列为1的记录的name列更新为张三’。如果之后Session B中的事务进行了回滚，那么Session A中的更新也将不复存在，这科现象就称之为脏写。这时Session A中的事务就没有效果了，明明把数据更新了，最后也提交事务了，最后看到的数据什么变化也没有。这里大家对事务的隔离级比较了解的话，会发现默认隔离级别下，上面SessionA中的更新语句会处于等待状态，这里只是跟大家说明一下会出现这样现象</p>
</li>
</ul>
<blockquote>
<p><strong>2. 脏读（ Dirty Read ）</strong></p>
</blockquote>
<ul>
<li><p>对于两个事务 Session A、Session B，Session A <strong>读取</strong> 了已经被 Session B <strong>更新</strong> 但还 <strong>没有被提交</strong> 的字段。之后若 Session B 回滚 ，Session A 读取 的内容就是 <strong>临时且无效</strong> 的</p>
<p><img src="image-20221210164445509.png" alt="MySQL之性能优化/image-20221210164445509"></p>
</li>
<li><p>Session A和Session B各开启了一个事务，Session B中的事务先将studentno列为1的记录的name列更新<br>为’张三’，然后Session A中的事务再去查询这条studentno为1的记录，如果读到列name的值为’张三’，而Session B中的事务稍后进行了回滚，那么Session A中的事务相当于读到了一个不存在的数据，这种现象就称之为<strong>脏读</strong></p>
</li>
</ul>
<blockquote>
<p><strong>3. 不可重复读（ Non-Repeatable Read ）</strong></p>
</blockquote>
<ul>
<li><p>对于两个事务Session A、Session B，Session A <strong>读取</strong> 了一个字段，然后 Session B <strong>更新</strong> 了该字段。 之后Session A <strong>再次读取</strong>同一个字段， <strong>值就不同</strong> 了。那就意味着发生了不可重复读</p>
<p><img src="image-20221210164844392.png" alt="MySQL之性能优化/image-20221210164844392"></p>
</li>
<li><p>在Session B中提交了几个 <strong>隐式事务</strong> （注意是隐式事务，意味着语句结束事务就提交了），这些事务都修改了studentno列为1的记录的列name的值，每次事务提交之后，如果Session A中的事务都可以查看到最新的值，这种现象也被称之为<strong>不可重复读</strong></p>
</li>
</ul>
<blockquote>
<p><strong>4. 幻读（ Phantom ）</strong></p>
</blockquote>
<ul>
<li><p>对于两个事务Session A、Session B, Session A 从一个表中 <strong>读取</strong> 了一个字段, 然后 Session B 在该表中 <strong>插入</strong> 了一些新的行。 之后, 如果 Session A <strong>再次读取</strong> 同一个表, 就会多出几行。那就意味着发生了幻读</p>
<p><img src="image-20221210165234750.png" alt="MySQL之性能优化/image-20221210165234750"></p>
</li>
<li><p>Session A中的事务先根据条件 studentno &gt; 0这个条件查询表student，得到了name列值为’张三’的记录；之后Session B中提交了一个 隐式事务 ，该事务向表student中插入了一条新记录；之后Session A中的事务再根据相同的条件 studentno &gt; 0查询表student，得到的结果集中包含Session B中的事务新插入的那条记录，这种现象也被称之为 幻读 。我们把新插入的那些记录称之为幻影记录</p>
</li>
</ul>
<p><strong>注意1:</strong></p>
<ul>
<li>如果Session B中<strong>删除</strong>了一些符合<strong>studentno &gt; 0</strong>的记录而不是插入新记录，那SessionA之后再根据<strong>studentno &gt; 0</strong>的条件读取的<strong>记录变少了</strong>，这种现象算不算<strong>幻读</strong>呢?这种现象<strong>不属于幻读</strong>，幻读强调的是一个事务按照某个<strong>相同条件多次读取</strong>记录时，后读取时读到了之前<strong>没有读到的记录</strong></li>
</ul>
<p><strong>注意2:</strong></p>
<ul>
<li>那对于先前已经读到的记录，之后又读取不到这种情况，算啥呢?这相当于对每一条记录都发生了<strong>不可重复读</strong>的现象。幻读只是重点强调了读取到了之前读取没有获取到的记录</li>
</ul>
<h4 id="8-1-3-3-SQL中的四种隔离级别"><a href="#8-1-3-3-SQL中的四种隔离级别" class="headerlink" title="8.1.3.3 SQL中的四种隔离级别"></a>8.1.3.3 SQL中的四种隔离级别</h4><ul>
<li><p>上面介绍了几种并发事务执行过程中可能遇到的一些问题，这些问题有轻重缓急之分，我们给这些问题按照<strong>严重性</strong>来排一下序：</p>
<blockquote>
<p>脏写 &gt; 脏读 &gt; 不可重复读 &gt; 幻读</p>
</blockquote>
</li>
<li><p>愿意舍弃一部分隔离性来换取一部分性能在这里就体现在：设立一些隔离级别，隔离级别越低，并发问题发生的就越多。 <strong>SQL标准</strong> 中设立了4个 <strong>隔离级别</strong>：</p>
<ul>
<li><strong>READ UNCOMMITTED：</strong>读未提交，在该隔离级别，所有事务都可以看到其他未提交事务的执行结果。不能避免脏读、不可重复读、幻读</li>
<li><strong>READ COMMITTED：</strong>读已提交，它满足了隔离的简单定义：一个事务只能看见已经提交事务所做的改变。这是大多数数据库系统的默认隔离级别（但不是MySQL默认的）。可以避免脏读，但不可重复读、幻读问题仍然存在</li>
<li><strong>REPEATABLE READ：</strong>可重复读，事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交，那么事务A再读该数据，读到的还是原来的内容。可以避免脏读、不可重复读，但幻读问题仍然存在。这是MySQL的默认隔离级别</li>
<li><strong>SERIALIZABLE</strong>：可串行化，确保事务可以从一个表中读取相同的行。在这个事务持续期间，禁止其他事务对该表执行插入、更新和删除操作。所有的并发问题都可以避免，但性能十分低下。能避免脏读、不可重复读和幻读</li>
</ul>
</li>
<li><p><strong>SQL标准</strong>中规定，针对不同的隔离级别，并发事务可以发生不同严重程度的问题，具体情况如下：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读可能性</th>
<th>不可重复读可能性</th>
<th>幻读可能性</th>
<th>加锁读</th>
</tr>
</thead>
<tbody><tr>
<td>READ UNCONMITED</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>READ COMMITED</td>
<td>No</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>REPEATABLE READ</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
</tbody></table>
</li>
<li><p><strong>脏写</strong>怎么没涉及到？因为脏写这个问题太严重了，不论是哪种隔离级别，都不允许脏写的情况发生。 不同的隔离级别有不同的现象，并有不同的锁和并发机制，隔离级别越高，数据库的并发性能就越差，4 种事务隔离级别与并发性能的关系如下：</p>
<p><img src="image-20221210170305362.png" alt="MySQL之性能优化/image-20221210170305362"></p>
</li>
</ul>
<h4 id="8-1-3-4-MySQL支持的四种隔离级别"><a href="#8-1-3-4-MySQL支持的四种隔离级别" class="headerlink" title="8.1.3.4 MySQL支持的四种隔离级别"></a>8.1.3.4 MySQL支持的四种隔离级别</h4><ul>
<li><p>不同的数据库厂商对SQL标准中规定的四种隔离级别支持不一样。比如，<strong>Oracle</strong>就只支持<strong>READ COMNITTED</strong>（默认隔离级别〉和<strong>SERIALIZABLE</strong>隔离级别。MySQL虽然支持4种隔离级别，但与SQL标准中所规定的各级隔离级别允许发生的问题却有些出入，MySQL在<strong>REPEATABLE READ</strong>隔离级别下，是可以禁止幻读问题的发生的</p>
</li>
<li><p>MySQL的默认隔离级别为<strong>REPEATABLE READ</strong>，可以手动修改一下事务的隔离级别</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 查看隔离级别，MySQL <span class="number">5.7</span><span class="number">.20</span>的版本之前：</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;tx_isolation&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span>           <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="operator">|</span> tx_isolation  <span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------+-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># MySQL <span class="number">5.7</span><span class="number">.20</span>版本之后，引入transaction_isolation来替换tx_isolation</span><br><span class="line"># 查看隔离级别，MySQL <span class="number">5.7</span><span class="number">.20</span>的版本及之后：</span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;transaction_isolation&#x27;</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+-----------------------+-----------------+</span></span><br><span class="line"><span class="comment">| Variable_name         | Value           |</span></span><br><span class="line"><span class="comment">+-----------------------+-----------------+</span></span><br><span class="line"><span class="comment">| transaction_isolation | REPEATABLE-READ |</span></span><br><span class="line"><span class="comment">+-----------------------+-----------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-1-3-5-如何设置事务的隔离级别"><a href="#8-1-3-5-如何设置事务的隔离级别" class="headerlink" title="8.1.3.5 如何设置事务的隔离级别"></a>8.1.3.5 如何设置事务的隔离级别</h4><ul>
<li><p>通过下面的语句修改事务的隔离级别：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">GLOBAL</span><span class="operator">|</span>SESSION] TRANSACTION ISOLATION LEVEL 隔离级别;</span><br><span class="line">#其中，隔离级别格式：</span><br><span class="line"><span class="operator">&gt;</span> READ UNCOMMITTED</span><br><span class="line"><span class="operator">&gt;</span> READ COMMITTED</span><br><span class="line"><span class="operator">&gt;</span> REPEATABLE READ</span><br><span class="line"><span class="operator">&gt;</span> SERIALIZABLE</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> [<span class="keyword">GLOBAL</span><span class="operator">|</span>SESSION] TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;隔离级别&#x27;</span></span><br><span class="line">#其中，隔离级别格式：</span><br><span class="line"><span class="operator">&gt;</span> READ<span class="operator">-</span>UNCOMMITTED</span><br><span class="line"><span class="operator">&gt;</span> READ<span class="operator">-</span>COMMITTED</span><br><span class="line"><span class="operator">&gt;</span> REPEATABLE<span class="operator">-</span>READ</span><br><span class="line"><span class="operator">&gt;</span> SERIALIZABLE</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>关于设置时使用GLOBAL或SESSION的影响：</strong></p>
<ul>
<li><p>使用GLOBAL关键字（在全局范围影响）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;SERIALIZABLE&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>则：<br>当前已经存在的会话无效<br>只对执行完该语句之后产生的会话起作用</li>
</ul>
</li>
<li><p>使用 SESSION 关键字（在会话范围影响）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SET</span> SESSION TRANSACTION_ISOLATION <span class="operator">=</span> <span class="string">&#x27;SERIALIZABLE&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>则：<br>对当前会话的所有后续的事务有效<br>如果在事务之间执行，则对后续的事务有效<br>该语句可以在已经开启的事务中间执行，但不会影响当前正在执行的事务</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>小结：<br>数据库规定了多种事务隔离级别，不同隔离级别对应不同的干扰程度，隔离级别越高，数据一致性<br>就越好，但并发性越弱</p>
</blockquote>
<ul>
<li>GLOBAL</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> <span class="keyword">global</span> tx_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 重启一个会话</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>COMMITTED <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"># 重启MySQL服务</span><br><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# systemctl restart mysqld</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line">ERROR <span class="number">2006</span> (HY000): MySQL server has gone away</span><br><span class="line"><span class="keyword">No</span> connection. Trying <span class="keyword">to</span> reconnect...</span><br><span class="line">Connection id:    <span class="number">3</span></span><br><span class="line"><span class="keyword">Current</span> database: <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="keyword">NONE</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line"></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>Session</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">set</span> session tx_isolation<span class="operator">=</span><span class="string">&#x27;read-committed&#x27;</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="operator">|</span> READ<span class="operator">-</span>COMMITTED <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"># 开启另一个会话</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@tx</span>_isolation;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@tx</span>_isolation  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="8-1-3-6-不同隔离级别举例"><a href="#8-1-3-6-不同隔离级别举例" class="headerlink" title="8.1.3.6 不同隔离级别举例"></a>8.1.3.6 不同隔离级别举例</h4><ul>
<li><p>初始化数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">table</span> account(id <span class="type">INT</span>,name <span class="type">VARCHAR</span>(<span class="number">15</span>),balance <span class="type">VARCHAR</span>(<span class="number">15</span>));</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> account <span class="keyword">VALUES</span>(<span class="number">1</span> ,<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;180&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>表中数据如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> account;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------+---------+</span></span><br><span class="line"><span class="operator">|</span> id   <span class="operator">|</span> name   <span class="operator">|</span> balance <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------+---------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> <span class="number">180</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">2</span> <span class="operator">|</span> 李四   <span class="operator">|</span> <span class="number">0</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+--------+---------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h5 id="演示1-读未提交之脏读"><a href="#演示1-读未提交之脏读" class="headerlink" title="演示1. 读未提交之脏读"></a>演示1. 读未提交之脏读</h5></blockquote>
<ul>
<li><p>设置隔离级别为未提交读：</p>
<p><img src="image-20221210193204029.png" alt="MySQL之性能优化/image-20221210193204029"></p>
</li>
<li><p>事务1和事务2的执行流程如下：</p>
<p><img src="image-20221210193318107.png" alt="MySQL之性能优化/image-20221210193318107"></p>
</li>
</ul>
<blockquote>
<h5 id="演示2：读已提交"><a href="#演示2：读已提交" class="headerlink" title="演示2：读已提交"></a>演示2：读已提交</h5></blockquote>
<p><img src="image-20221210193355235.png" alt="MySQL之性能优化/image-20221210193355235"></p>
<blockquote>
<h5 id="演示3：可重复读"><a href="#演示3：可重复读" class="headerlink" title="演示3：可重复读"></a>演示3：可重复读</h5></blockquote>
<ul>
<li><p>设置隔离级别为可重复读，事务的执行流程如下：</p>
<p><img src="image-20221210193504905.png" alt="MySQL之性能优化/image-20221210193504905"></p>
</li>
</ul>
<blockquote>
<h5 id="演示4：幻读"><a href="#演示4：幻读" class="headerlink" title="演示4：幻读"></a>演示4：幻读</h5></blockquote>
<p><img src="image-20221210193541614.png" alt="MySQL之性能优化/image-20221210193541614"></p>
<ul>
<li><p>这里要灵活的理解读取的意思。第一次select是读取，第二次的insert其实也属于隐式的读取，只不过是在mysql的机制中读取的，插入数据也是要先读取一下有没有主键冲突才能决定是否执行插入</p>
</li>
<li><p>幻读，并不是说两次读取获取的结果集不同，幻读侧重的方面是某一次的select 操作得到的结果所表征的数据状态无法支后续的业务操作。更为具体一些: select某记录是否存在，不存在，准备插入此记录，但执行insert时发现此记录已存在，无法插入，此时就发生了幻读</p>
</li>
<li><p>在RR隔离级别下，step1、step2是会正常执行的，step3则会报错主键冲突，对于事务1的业务来说是执行失败的，这里事务1就是发生了幻读，因为事务1在step1中读取的数据状态并不能支撑后续的业务操作，事务1:“见鬼了，我刚才读到的结果应该可以支持我这样操作才对啊，为什么现在不可以”。事务1不敢相信的又执行了step4，发现和setp1读取的结果是一样的（RR下的 MVCC机制)。此时，幻读无疑已经发生，事务1无论读取多少次，都查不到id&#x3D;3的记录，但它的确无法插入这条他通过读取来认定不存在的记录（此数据已被事务2插入)，对于事务1来说，它幻读了</p>
</li>
<li><p>其实RR（Mysql默认隔离级别）也是可以避免幻读的，通过对select操作手动加行X锁(独占锁) (SELECT … FOR UPDATE这也正是SERIALIZABLE 隔离级别下会隐式为你做的事情)，同时，即便当前记录不存在，比如id &#x3D; 3是不存在的，当前事务也会获得一把记录锁（因为InnoDB的行锁锁定的是索引，故记录实体存在与否没关系，存在就加行X锁，不存在就加间隙领），其他事务则无法插入此索引的记录，故杜绝了幻读</p>
</li>
<li><p>在SERIALIZABLE隔离级别下，step1执行时是会隐式的添加行(X)锁&#x2F;gap(X)锁的，从而step2会被阻塞，step3 会正常执行，待事务1提交后，事务2才能继续执行（主键冲突执行失败)，对于事务1来说业务是正确的，成功的阻塞扼杀了扰乱业务的事务2，对于事务1来说他前期读取的结果是可以支撑其后续业务的</p>
</li>
<li><p>所以MySQL的幻读并非什么读取两次返回结果集不同，而是事务在插入事先检测不存在的记录时，惊奇的发现这些数据已经存在了，之前的检测读获取到的数据如同鬼影一般</p>
</li>
</ul>
<h3 id="8-1-4-事务的常见分类"><a href="#8-1-4-事务的常见分类" class="headerlink" title="8.1.4 事务的常见分类"></a>8.1.4 事务的常见分类</h3><ul>
<li>从事务理论的角度来看，可以把事务分为以下几种类型：<ul>
<li>扁平事务（Flat Transactions）</li>
<li>带有保存点的扁平事务（Flat Transactions with Savepoints）</li>
<li>链事务（Chained Transactions）</li>
<li>嵌套事务（Nested Transactions）</li>
</ul>
</li>
</ul>
<h2 id="8-2-MySQL事务日志"><a href="#8-2-MySQL事务日志" class="headerlink" title="8.2 MySQL事务日志"></a>8.2 MySQL事务日志</h2><ul>
<li>事务有4种特性:原子性、一致性、隔离性和持久性。那么事务的四种特性到底是基于什么机制实现呢<ul>
<li>事务的<strong>隔离性</strong>由<strong>锁机制</strong>实现</li>
<li>而事务的<strong>原子性、一致性和持久性</strong>由事务的<strong>redo</strong>日志和<strong>undo</strong>日志来保证<ul>
<li>1）REDO LOG称为<strong>重做日志</strong>，提供再写入操作，恢复提交事务修改的页操作，用来保证事务的<strong>特久性</strong></li>
<li>2）UNDO LOG称为<strong>回滚日志</strong>，回滚行记录到某个特定版本，用来保证事务的<strong>原子性、一致性</strong></li>
</ul>
</li>
</ul>
</li>
<li>有的DBA或许会认为UNDO是REDO的逆过程，其实不然。REDO和UNDO都可以视为是一种<strong>恢复操作</strong>。但是:<ul>
<li>redo log：是存储引擎层(innodb)生成的日志，记录的是”<strong>物理级别</strong>“上的页修改操作，比如页号xxx、偏移量yyy写入了’zzz’数据。主要为了保证数据的可靠性</li>
<li>undo log:是存储引擎层(innodb)生成的日志，记录的是<strong>逻辑操作</strong>日志，比如对某一行数据进行了INSERT语句操作，那么undo log就记录一条与之相反的DELETE操作。主要用于<strong>事务的回滚</strong>(undo log 记录的是每个修改操作的<strong>逆操作</strong>)和<strong>一致性非锁定读</strong>(undo log回滚行记录到某种特定的版本–MVCC，即多版本并发控制）</li>
</ul>
</li>
</ul>
<h3 id="8-2-1-redo日志"><a href="#8-2-1-redo日志" class="headerlink" title="8.2.1 redo日志"></a>8.2.1 redo日志</h3><ul>
<li>InnoDB存储引擎是以<strong>页为单位</strong>来管理存储空间的</li>
<li>在真正访问页面之前，需要把在<strong>磁盘上</strong>的页缓存到内存中的<strong>Buffer Pool</strong>之后才可以访问</li>
<li>所有的变更都必须<strong>先更新缓冲池中的数据</strong>，然后缓冲池中的<strong>脏页</strong>会以一定的频率被刷入磁盘（ <strong>checkPoint机制</strong>），通过缓冲池来优化CPU和磁盘之间的鸿沟，这样就可以保证整体的性能不会下降太快</li>
</ul>
<h4 id="8-2-1-1-为什么需要redo日志"><a href="#8-2-1-1-为什么需要redo日志" class="headerlink" title="8.2.1.1 为什么需要redo日志"></a>8.2.1.1 为什么需要redo日志</h4><ul>
<li><p>一方面，缓冲池可以帮助我们消除CPU和磁盘之间的鸿沟，checkpoint机制可以保证数据的最终落盘，然而由于checkpoint <strong>并不是每次变更的时候就触发</strong> 的，而是master线程隔一段时间去处理的。所以最坏的情况就是事务提交后，刚写完缓冲池，数据库宕机了，那么这段数据就是丢失的，无法恢复</p>
</li>
<li><p>另一方面，事务包含 <strong>持久性</strong> 的特性，就是说对于一个已经提交的事务，在事务提交后即使系统发生了崩溃，这个事务对数据库中所做的更改也不能丢失</p>
</li>
<li><p>那么如何保证这个持久性呢？ <strong>一个简单的做法</strong> ：在事务提交完成之前把该事务所修改的所有页面都刷新到磁盘，但是这个简单粗暴的做法有些问题：</p>
<ul>
<li><strong>修改量与刷新磁盘工作量严重不成比例</strong><ul>
<li>有时候仅仅修改了某个页面中的一个字节，但是我们知道在InnoDB中是以页为单位来进行磁盘IO的，也就是说在该事务提交时不得不将一个完整的页面从内存中刷新到磁盘，我们又知道一个页面默认是16KB大小，只修改一个字节就要刷新16KB的数据到磁盘上显然是太小题大做了</li>
</ul>
</li>
<li><strong>随机IO刷新较慢</strong><ul>
<li>一个事务可能包含很多语句，即使是一条语句也可能修改许多页面，假如该事务修改的这些页面可能并不相邻，这就意味着在将某个事务修改的Buffer Pool中的页面<strong>刷新到磁盘</strong>时，需要进行很多的<strong>随机IO</strong>，随机IO比顺序IO要慢，尤其对于传统的机械硬盘来说</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>另一个解决的思路</strong>∶我们只是想让已经提交了的事务对数据库中数据所做的修改永久生效，即使后来系统崩溃，在重启后也能把这种修改恢复出来。所以其实没有必要在每次事务提交时就把该事务在内存中修改过的全部页面刷新到磁盘，只需要把<strong>修改</strong>了哪些东西<strong>记录一下</strong>就好。比如，某个事务将系统表空间中<strong>第10号</strong>页面中偏移量为<strong>100处</strong>的值更新为<strong>2</strong></p>
</li>
<li><p>InnoDB引擎的事务采用了WAL技术（<strong>Write-Ahead Logging</strong> )，这种技术的思想就是先写日志，再写磁盘，只有日志写入成功，才算事务提交成功，这里的日志就是redo log。当发生宕机且数据未刷到磁盘的时候，可以通i过redo log来恢复，保证ACID中的D，这就是redo log的作用</p>
</li>
</ul>
<p><img src="image-20221210213744166.png" alt="MySQL之性能优化/image-20221210213744166"></p>
<h4 id="8-2-1-2-redo日志的优缺点"><a href="#8-2-1-2-redo日志的优缺点" class="headerlink" title="8.2.1.2 redo日志的优缺点"></a>8.2.1.2 redo日志的优缺点</h4><ul>
<li><strong>1.好处</strong><ul>
<li><strong>redo日志降低了刷盘频率</strong></li>
<li><strong>redo日志占用的空间非常小</strong></li>
</ul>
</li>
<li><strong>2.特点</strong><ul>
<li><strong>redo日志是顺序写入磁盘的</strong><br>在执行事务的过程中，每执行一条语句，就可能产生若干条redo日志，这些日志是按照<strong>产生的顺序写入磁盘的</strong>，也就是使用顺序IO，效率比随机lO快</li>
<li><strong>事务执行过程中，redo log不断记录</strong><br>redo log跟bin log的区别,redo log是<strong>存储引擎层</strong>产生的，而bin log是<strong>数据库层</strong>产生的。假设一个事务，对表做10万行的记录插入，在这个过程中，一直不断的往redo log顺序记录，而bin log不会记录，直到这个事务提交，才会一次写入到bin log文件中</li>
</ul>
</li>
</ul>
<h4 id="8-2-1-3-redo的组成"><a href="#8-2-1-3-redo的组成" class="headerlink" title="8.2.1.3 redo的组成"></a>8.2.1.3 redo的组成</h4><ul>
<li><p>Redo log可以简单分为以下两个部分：</p>
<ul>
<li><p><strong>重做日志的缓冲 (redo log buffer) ，保存在内存中，是易失的</strong></p>
<ul>
<li>在服务器启动时就向操作系统申请了一大片称之为redo log buffer的<strong>连续内存空间</strong>，翻译成中文就是redo日志缓冲区。这片内存空间被划分成若干个连续的<strong>redo log block</strong>。一个redo log block占用<strong>512字节</strong>大小</li>
</ul>
<p><img src="image-20221211195815164.png" alt="MySQL之性能优化/image-20221211195815164"></p>
<ul>
<li><p><strong>参数设置：innodb_log_buffer_size：</strong><br>redo log buffer 大小，默认<strong>16M</strong>，最大值是4096M，最小值为1M</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%innodb_log_buffer_size%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name          <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> innodb_log_buffer_size <span class="operator">|</span> <span class="number">16777216</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>重做日志文件 (redo log file) ，保存在硬盘中，是持久的</strong></p>
<ul>
<li><p>REDO日志文件，其中的ib_logfile0和ib_logfile1即为REDO日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">/</span>]# cd <span class="operator">/</span>var<span class="operator">/</span>lib<span class="operator">/</span>mysql</span><br><span class="line">[root<span class="variable">@localhost</span> mysql]# ll</span><br><span class="line">总用量 <span class="number">188476</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 17 14:14 atguigudb</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 12月  8 14:46 atguigudb1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 12月 10 15:27 atguigudb2</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       92 12月 10 19:25 atguigudb3</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql       56 11月 10 22:06 auto.cnf</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql       52 11月 11 16:46 dbtest1</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 12月  1 17:39 dbtest2</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      803 12月 11 20:02 ib_buffer_pool</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 79691776 12月 11 20:02 ibdata1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月 11 20:02 ib_logfile0</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 50331648 12月  8 14:59 ib_logfile1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql 12582912 12月 11 20:02 ibtmp1</span></span><br><span class="line"><span class="operator">-</span>rw<span class="operator">-</span>r<span class="comment">-----. 1 mysql mysql      358 12月  3 23:35 localhost-slow.log</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     4096 11月 10 22:06 mysql</span></span><br><span class="line">srwxrwxrwx. <span class="number">1</span> mysql mysql        <span class="number">0</span> <span class="number">12</span>月 <span class="number">11</span> <span class="number">20</span>:<span class="number">02</span> mysql.sock</span><br><span class="line"><span class="operator">-</span>rw<span class="comment">-------. 1 mysql mysql        5 12月 11 20:02 mysql.sock.lock</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 performance_schema</span></span><br><span class="line">drwxr<span class="operator">-</span>x<span class="comment">---. 2 mysql mysql     8192 11月 10 22:06 sys</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="8-2-1-4-redo的整体流程"><a href="#8-2-1-4-redo的整体流程" class="headerlink" title="8.2.1.4 redo的整体流程"></a>8.2.1.4 redo的整体流程</h4><ul>
<li><p>以一个更新事务为例，redo log 流转过程，如下图所示：</p>
<p><img src="image-20221211200237867.png" alt="MySQL之性能优化/image-20221211200237867"></p>
</li>
<li><p>第1步：先将原始数据从磁盘中读入内存中来，修改数据的内存拷贝</p>
</li>
<li><p>第2步：生成一条重做日志并写入redo log buffer，记录的是数据被修改后的值</p>
</li>
<li><p>第3步：当事务commit时，将redo log buffer中的内容刷新到 redo log file，对 redo log file采用追加写的方式</p>
</li>
<li><p>第4步：定期将内存中修改的数据刷新到磁盘中</p>
</li>
</ul>
<blockquote>
<p><strong>体会：</strong><br>Write-Ahead Log(预先日志持久化)：在持久化一个数据页之前，先将内存中相应的日志页持久化</p>
</blockquote>
<h4 id="8-2-1-5-redo-log的刷盘策略"><a href="#8-2-1-5-redo-log的刷盘策略" class="headerlink" title="8.2.1.5 redo log的刷盘策略"></a>8.2.1.5 redo log的刷盘策略</h4><ul>
<li><p>redo log的写入并不是直接写入磁盘的，InnoDB引擎会在写redo log的时候先写redo log buffer，之后以<strong>一</strong><br><strong>定的频率</strong>刷到真正的redo log file 中。这里的一定频率怎么看待呢？这就是要说的刷盘策略</p>
<p><img src="image-20221211201810557.png" alt="MySQL之性能优化/image-20221211201810557"></p>
</li>
<li><p>注意，redo log buffer刷盘到redo log file的过程并不是真正的刷到磁盘中去，只是刷入到<strong>文件系统缓存</strong>（page cache）中去（这是现代操作系统为了提高文件写入效率做的一个优化），真正的写入会交给系统自己来决定（比如page cache足够大了）。那么对于InnoDB来说就存在一个问题，如果交给系统来同步，同样如果系统宕机，那么数据也丢失了（虽然整个系统宕机的概率还是比较小的）</p>
</li>
<li><p>针对这种情况，InnoDB给出<strong>innodb_flush_log_at_trx_commit</strong>参数，该参数控制commit提交事务时，如何将 redo log buffer 中的日志刷新到 redo log file 中。它支持三种策略：</p>
<ul>
<li><p><strong>设置为0</strong>：表示每次事务提交时不进行刷盘操作。（系统默认master thread每隔1s进行一次重做日志的同步）</p>
</li>
<li><p><strong>设置为1：</strong>表示每次事务提交时都将进行同步，刷盘操作（ 默认值 ）</p>
</li>
<li><p><strong>设置为2：</strong>表示每次事务提交时都只把 redo log buffer 内容写入 page cache，不进行同步。由os自己决定什么时候同步到磁盘文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_flush_log_at_trx_commit&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name                  <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_flush_log_at_trx_commit <span class="operator">|</span> <span class="number">1</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>另外，InnoDB存储引擎有一个后台线程，每隔<strong>1秒</strong>，就会把 <strong>redo log buffer</strong> 中的内容写到文件系统缓存( <strong>page cache</strong> ) ，然后调用刷盘操作</p>
<p><img src="image-20221211202621151.png" alt="MySQL之性能优化/image-20221211202621151"></p>
</li>
<li><p>也就是说，一个没有提交事务的<strong>redo log</strong>记录，也可能会刷盘。因为在事务执行过程redo log记录是会写入redo log buffer中，这些redo log记录会被后台线程刷盘</p>
<p><img src="image-20221211202707200.png" alt="MySQL之性能优化/image-20221211202707200"></p>
</li>
<li><p>除了后台线程每秒<strong>1次</strong>的轮询操作，还有一种情况，当<strong>redo log buffer</strong>占用的空间即将达到<strong>innodb_log_buffer_size</strong>(这个参数默认是16M）的一半的时候，后台线程会主动刷盘</p>
</li>
</ul>
<h4 id="8-2-1-6-不同刷盘策略演示"><a href="#8-2-1-6-不同刷盘策略演示" class="headerlink" title="8.2.1.6 不同刷盘策略演示"></a>8.2.1.6 不同刷盘策略演示</h4><p><img src="image-20221211203039274.png" alt="MySQL之性能优化/image-20221211203039274"></p>
<blockquote>
<p>小结: innodb_flush_log_at_trx_commit&#x3D;1</p>
<p>为1时，只要事务提交成功,redo log记录就一定在硬盘里，不会有任何数据丢失</p>
<p>如果事务执行期间MySQL挂了或宕机，这部分日志丢了，但是事务并没有提交，所以日志丢了也不会有损失。可以保证ACID的D，数据绝对不会丢失，但是效率最差的</p>
<p>建议使用默认值，虽然操作系统宕机的概率理论小于数据库宕机的概率，但是一般既然使用了事务，那么数据的安全相对来说更重要些</p>
</blockquote>
<p><img src="image-20221211203410983.png" alt="MySQL之性能优化/image-20221211203410983"></p>
<p><img src="image-20221211203543705.png" alt="MySQL之性能优化/image-20221211203543705"></p>
<blockquote>
<p>小结: innodb_flush_log_at_trx_commit&#x3D;0</p>
<p>为0时,master thread中每1秒进行一次重做日志的fsync操作，因此实例crash最多丢失1秒钟内的事务。( master thread是负责将缓冲池中的数据异步刷新到磁盘，保证数据的一致性)</p>
<p>数值0话，是一种折中的做法，它的IO效率理论是高于1的，低于2的，这种策略也有丢失数据的风险，也无法保证</p>
</blockquote>
<ul>
<li><p>举例</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#<span class="number">10</span><span class="operator">-</span>事务日志</span><br><span class="line">USE atguigudb3;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_load(</span><br><span class="line">a <span class="type">INT</span>,</span><br><span class="line">b <span class="type">CHAR</span>(<span class="number">80</span>)</span><br><span class="line">)ENGINE<span class="operator">=</span>INNODB;</span><br><span class="line"></span><br><span class="line">#创建存储过程，用于向test_load中添加数据</span><br><span class="line">DELIMITER<span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> p_load(COUNT <span class="type">INT</span> UNSIGNED)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">DECLARE</span> s <span class="type">INT</span> UNSIGNED <span class="keyword">DEFAULT</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> c <span class="type">CHAR</span>(<span class="number">80</span>)<span class="keyword">DEFAULT</span> REPEAT(<span class="string">&#x27;a&#x27;</span>,<span class="number">80</span>);</span><br><span class="line">WHILE s<span class="operator">&lt;=</span>COUNT DO</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_load <span class="keyword">SELECT</span> <span class="keyword">NULL</span>,c;</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">SET</span> s<span class="operator">=</span>s<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">END</span> WHILE;</span><br><span class="line"><span class="keyword">END</span> <span class="operator">/</span><span class="operator">/</span></span><br><span class="line">DELIMITER;</span><br><span class="line"></span><br><span class="line">#测试<span class="number">1</span>：</span><br><span class="line">#设置并查看：innodb_flush_log_at_trx_commit</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_flush_log_at_trx_commit&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">set</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">#调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> p_load(<span class="number">30000</span>); #<span class="number">1</span>min <span class="number">28</span>sec</span><br><span class="line"></span><br><span class="line">#测试<span class="number">2</span>：</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> test_load;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> test_load;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_flush_log_at_trx_commit&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> p_load(<span class="number">30000</span>); #<span class="number">37.945</span> sec</span><br><span class="line"></span><br><span class="line">#测试<span class="number">3</span>：</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> test_load;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> test_load;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> innodb_flush_log_at_trx_commit <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;innodb_flush_log_at_trx_commit&#x27;</span>;</span><br><span class="line"></span><br><span class="line">#调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> p_load(<span class="number">30000</span>); #<span class="number">45.173</span> sec</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>innodb_flush_log_at_trx_commit</th>
<th>执行所用时间</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>38.709秒</td>
</tr>
<tr>
<td>1</td>
<td>1分23秒</td>
</tr>
<tr>
<td>2</td>
<td>41.016秒</td>
</tr>
</tbody></table>
</li>
<li><p>而针对上述存储过程，为了提高事务的提交性能，应该在将3万行记录插入表后进行一次的COMMIT操作，而不是每插入一条记录后进行一次COMMIT操作。这样做的好处是可以使事务方法在rollback时回滚到事务最开始的确定状态</p>
</li>
</ul>
<blockquote>
<p>虽然用户可以通过设置参数innodb_flush_log_at_trx_commit为0或2来提高事务提交的性能，但需清楚，这种设置方法丧失了事务的ACID特性</p>
</blockquote>
<h4 id="8-2-1-7-写入redo-log-buffer过程"><a href="#8-2-1-7-写入redo-log-buffer过程" class="headerlink" title="8.2.1.7 写入redo log buffer过程"></a>8.2.1.7 写入redo log buffer过程</h4><blockquote>
<h5 id="1-补充概念-Mini-Transaction"><a href="#1-补充概念-Mini-Transaction" class="headerlink" title="1.补充概念:Mini-Transaction"></a>1.补充概念:Mini-Transaction</h5></blockquote>
<ul>
<li><p>MySQL把对底层页面中的一次原子访问的过程称之为一个<strong>Mini-Transaction</strong>，简称<strong>mtr</strong>，比如，向某个索引对应的B+树中插入一条记录的过程就是一个 <strong>Mini-Transaction</strong>。一个所谓的<strong>mtr</strong>可以包含一组<strong>redo</strong>日志，在进行崩溃恢复时这一组<strong>redo</strong>日志作为一个不可分割的整体</p>
</li>
<li><p>一个事务可以包含若干条语句，每一条语句其实是由若干个mtr组成，每一个mtr又可以包含若干条redo日志，画个图表示它们的关系就是这样:</p>
<p><img src="image-20221211210202947.png" alt="MySQL之性能优化/image-20221211210202947"></p>
</li>
</ul>
<blockquote>
<h5 id="2-redo-日志写入log-buffer"><a href="#2-redo-日志写入log-buffer" class="headerlink" title="2. redo 日志写入log buffer"></a>2. redo 日志写入log buffer</h5></blockquote>
<ul>
<li><p>向<strong>log buffer</strong>中写入redo日志的过程是顺序的，也就是先往前边的block中写，当该block的空闲空间用完之后再往下一个block中写。当想往log buffer中写入redo日志时，第一个遇到的问题就是应该写在哪个<strong>block</strong>的哪个偏移量处，所以<strong>InnoDB</strong>的设计者特意提供了一个称之为<strong>buf_free</strong>的全局变量，该变量指明后续写入的redo日志应该写入到 <strong>log buffer</strong>中的哪个位置，如图所示：</p>
<p><img src="image-20221211210309690.png" alt="MySQL之性能优化/image-20221211210309690"></p>
</li>
<li><p>一个mtr执行过程中可能产生若干条redo日志，<strong>这些redo日志是一个不可分割的组</strong>，所以其实并不是每生成一条redo日志，就将其插入到log buffer中，而是每个mtr运行过程中产生的日志先暂时存到一个地方，当该mtr结束的时候，将过程中产生的一组redo日志再全部复制到log bulffer中。假设有两个名为<strong>T1、T2</strong>的事务，每个事务都包含2个mtr，我们给这几个mtr命名一下;</p>
<ul>
<li><p>事务<strong>T1</strong>的两个<strong>mtr</strong>分别称为<strong>mtr_T1_1</strong>和<strong>mtr_T1_2</strong></p>
</li>
<li><p>事务<strong>T2</strong>的两个<strong>mtr</strong>分别称为<strong>mtr_T2_1</strong>和<strong>mtr_T2_2</strong></p>
</li>
<li><p>每个mtr都会产生一组redo日志，用示意图来描述一下这些mtr产生的日志情况:<br><img src="image-20221211210352982.png" alt="MySQL之性能优化/image-20221211210352982"></p>
</li>
</ul>
</li>
<li><p>不同的事务可能是<strong>并发</strong>执行的，所以<strong>T1、T2</strong>之间的mtr可能是<strong>交替执行</strong>的。每当一个mtr执行完成时，伴随该mtr生成的一组redo日志就需要被复制到log buffer中，也就是说不同事务的mtr可能是交替写入log buffer的，我们画个示意图(为了美观，把一个mtr中产生的所有的redo日志当作一个整体来画)：</p>
<p><img src="image-20221211210440697.png" alt="MySQL之性能优化/image-20221211210440697"></p>
</li>
<li><p>有的mtr产生的redo日志量非常大，比如1mtr_t1_2产生的redo日志占用空间比较大，占用了3个block来存储</p>
</li>
</ul>
<blockquote>
<h4 id="3-redo-log-block的结构图"><a href="#3-redo-log-block的结构图" class="headerlink" title="3. redo log block的结构图"></a>3. redo log block的结构图</h4></blockquote>
<ul>
<li>一个redo log block是由<strong>日志头、日志体、日志尾</strong>组成。日志头占用12字节，日志尾占用8字节，所以一个block真正能存储的数据就是512-12-8&#x3D;492字节</li>
</ul>
<blockquote>
<p>为什么一个block设计成512字节?<br>这个和磁盘的扇区有关，机械磁盘默认的扇区就是512字节，如果要写入的数据大于512字节，那么要写入的扇区肯定不止一个，这时就要涉及到盘片的转动，找到下一个扇区，假设现在需要写入两个扇区A和B，如果扇区A写入成功，而扇区B写入失败，那么就会出现非原子性的写入，而如果每次只写入和扇区的大小一样的512字节,那么每次的写入都是原子性的</p>
</blockquote>
<p><img src="image-20221211210605042.png" alt="MySQL之性能优化/image-20221211210605042"></p>
<ul>
<li><p>真正的redo日志都是存储到占用496字节大小的log block body中，图中的log block header和log block trailer存储的是一些管理信息。我们来看看这些所谓的管理信息都有什么</p>
<p><img src="image-20221211210637414.png" alt="MySQL之性能优化/image-20221211210637414"></p>
</li>
<li><p><strong>log block header的属性分别如下：</strong></p>
<ul>
<li>LOG_BLOCK_HDR_NO : log buffer是由log block组成，在内部log buffer就好似一个数组，因此LOG_BLOCK_HDR_NO用来标记这个数组中的位置。其是递增并且循环使用的，占用4个字节，但是由于第—位用来判新是否是flush bit，所以最大的值为2G。</li>
<li>LOG_BLOCK_HDR_DATA_LEN∶表示block中已经使用了多少字节，初始值为12(因为log block body从第12个字节处开始)。随着往block中写入的redo日志越来也多，本属性值也跟着增长。如果log block body已经被全部写满,那么本属性的值被设置为512</li>
<li>LOG_BLOCK_FIRST_REC_GROUP :一条redo日志也可以称之为一条redo日志记录（redo log record)，一个mtr会生产多条redo日志记录，这些redo日志记录被称之为一个redo日志记录组(redo log record group)。LOG_BLOCK_FIRST_REC_GROUP就代表该block中第一个mtr生成的redo日志记录组的偏移量(其实也就是这个block里第一个mtr生成的第一条redo日志的偏移量)。如果该值的大小和LOG_BLOCK_HDR_DATA_LEN相同，则表示当前log block不包含新的日志</li>
</ul>
</li>
<li><p><strong>LOG_BLOCK_CHECKPOINT_NO:占用4字节，表示该log block最后被写入时的checkpoint。 log block trailer中属性的意思如下：</strong></p>
<ul>
<li>LOG_BLOCK_CHECKSUN:表示block的校验值，用于正确性校验（其值和LOG_BLOCK_HDR_NO相同)，暂时不关心它</li>
</ul>
</li>
</ul>
<h4 id="8-2-1-8-redo-log-file"><a href="#8-2-1-8-redo-log-file" class="headerlink" title="8.2.1.8 redo log file"></a>8.2.1.8 redo log file</h4><blockquote>
<h5 id="1-相关参数设置"><a href="#1-相关参数设置" class="headerlink" title="1.相关参数设置"></a>1.相关参数设置</h5></blockquote>
<ul>
<li><p><strong>innodb_log_group_home_dir</strong>：指定 redo log 文件组所在的路径，默认值为 <strong>.&#x2F;</strong> ，表示在数据库的数据目录下。MySQL的默认数据目录（ <strong>var&#x2F;lib&#x2F;mysql</strong> ）下默认有两个名为 <strong>ib_logfile0</strong> 和<strong>ib_logfile1</strong> 的文件，log buffer中的日志默认情况下就是刷新到这两个磁盘文件中。此redo日志文件位置还可以修改</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_log_group_home_dir&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_log_group_home_dir <span class="operator">|</span> .<span class="operator">/</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>i<strong>nnodb_log_files_in_group</strong>：指明redo log file的个数，命名方式如：ib_logfile0，iblogfile1…iblogfilen。默认2个，最大100个</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_log_files_in_group&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name             <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_log_files_in_group <span class="operator">|</span> <span class="number">2</span>     <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">---------------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">#ib_logfile0</span><br><span class="line">#ib_logfile1</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>innodb_flush_log_at_trx_commit：</strong>控制 redo log 刷新到磁盘的策略，默认为1</p>
</li>
<li><p><strong>innodb_log_file_size：</strong>单个 redo log 文件设置大小，默认值为 <strong>48M</strong> 。最大值为512G，注意最大值指的是整个redo log 系列文件之和，即（innodb_log_files_in_group * innodb_log_file_size）不能大于最大值512</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_log_file_size&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name        <span class="operator">|</span> <span class="keyword">Value</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="operator">|</span> innodb_log_file_size <span class="operator">|</span> <span class="number">50331648</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----------------------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据业务修改其大小，以便容纳较大的事务。编辑my.cnf文件并重启数据库生效，如下所示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="operator">~</span>]# vim <span class="operator">/</span>etc<span class="operator">/</span>my.cnf</span><br><span class="line">innodb_log_file_size<span class="operator">=</span><span class="number">200</span>M</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<p>在数据库实例更新比较频繁的情况下，可以适当加大 redo log组数和大小。但也不推荐redo log设置过大,在MySQL前溃恢复时会重新执行REDO日志中的记录</p>
</blockquote>
<blockquote>
<h5 id="2-日志文件组"><a href="#2-日志文件组" class="headerlink" title="2. 日志文件组"></a>2. 日志文件组</h5></blockquote>
<ul>
<li><p>从上边的描述中可以看到，磁盘上的<strong>redo</strong>日志文件不只一个，而是以一个<strong>日志文件组</strong>的形式出现的。这些文件以ib_logfile[数字]（数字可以是日、1、2…）)的形式进行命名，每个的redo日志文件大小都是一样的</p>
</li>
<li><p>在将redo日志写入日志文件组时，是从<strong>ib_logfile0</strong>开始写，如果<strong>ib_logfile0</strong>写满了，就接着<strong>ib_logfile1</strong>写。同理, <strong>ib_logf1le1</strong>写满了就去写<strong>ib_logfile2</strong>，依此类准。如果写到最后一个文件该咋办?那就重新转到<strong>ib_logfile0</strong>继续写，所以整个过程如下图所示：</p>
<p><img src="image-20221211212531222.png" alt="MySQL之性能优化/image-20221211212531222"></p>
</li>
<li><p>总共的redo日志文件大小其实就是: <strong>innodb_log_file_size * innodb_log_files_in_group</strong> </p>
</li>
<li><p>采用循环使用的方式向redo日志文件组里写数据的话，会导致后写入的redo日志在盖掉前边写的redo日志?当然!所以InnoDB的设计者提出了checkpoint的概念</p>
</li>
</ul>
<blockquote>
<h5 id="3-checkpoint"><a href="#3-checkpoint" class="headerlink" title="3. checkpoint"></a>3. checkpoint</h5></blockquote>
<ul>
<li><p>在整个日志文件组中还有两个重要的属性，分别是write pos、checkpoint</p>
<ul>
<li><strong>write pos</strong>是当前记录的位置，一边写一边后移</li>
<li><strong>checkpoint</strong>是当前要擦除的位置，也是往后推移</li>
</ul>
</li>
<li><p>每次刷盘 redo log记录到日志文件组中，write pos位置就会后移更新。每次MySQL加载日志文件组恢复数据时，会清空加载过的redo log记录，并把 checkpoint后移更新。write pos和checkpoint之间的还空着的部分可以用来写入新的redo log记录</p>
<p><img src="image-20221211212709196.png" alt="MySQL之性能优化/image-20221211212709196"></p>
</li>
<li><p>如果 write pos 追上 checkpoint ，表示<strong>日志文件组</strong>满了，这时候不能再写入新的 redo log记录，MySQL 得停下来，清空一些记录，把 checkpoint 推进一下</p>
<p><img src="image-20221211212744097.png" alt="MySQL之性能优化/image-20221211212744097"></p>
</li>
</ul>
<h4 id="8-2-1-9-redo-log小结"><a href="#8-2-1-9-redo-log小结" class="headerlink" title="8.2.1.9 redo log小结"></a>8.2.1.9 redo log小结</h4><ul>
<li><p>redo log的作用和它的刷盘时机、存储形式：<strong>InnoDB 的更新操作采用的是Write Ahead Log (预先日志持久化)策略，即先写日志，再写入磁盘</strong></p>
<p><img src="image-20221211213616332.png" alt="MySQL之性能优化/image-20221211213616332"></p>
</li>
</ul>
<h3 id="8-2-2-undo日志"><a href="#8-2-2-undo日志" class="headerlink" title="8.2.2 undo日志"></a>8.2.2 undo日志</h3><ul>
<li>redo log是事务持久性的保证，undo log是事务原子性的保证。在事务中<strong>更新数据</strong>的<strong>前置操作</strong>其实是要先写入一个<strong>undo log</strong></li>
</ul>
<h4 id="8-2-2-1-如何理解Undo日志"><a href="#8-2-2-1-如何理解Undo日志" class="headerlink" title="8.2.2.1 如何理解Undo日志"></a>8.2.2.1 如何理解Undo日志</h4><ul>
<li><p>事务需要保证<strong>原子性</strong>，也就是事务中的操作要么全部完成，要么什么也不做。但有时候事务执行到一半会出现一些情况，比如：</p>
<ul>
<li>情况一：事务执行过程中可能遇到各种错误，比如<strong>服务器本身的错误</strong> ， <strong>操作系统错误</strong> ，甚至是突然<strong>断电</strong> 导致的错误</li>
<li>情况二：程序员可以在事务执行过程中手动输入 <strong>ROLLBACK</strong> 语句结束当前事务的执行</li>
</ul>
</li>
<li><p>以上情况出现，需要把数据改回原先的样子，这个过程称之为<strong>回滚</strong> ，这样就可以造成一个假象：这个事务看起来什么都没做，所以符合<strong>原子性</strong>要求</p>
</li>
<li><p>每当要对一条记录做改动时(这里的<strong>改动</strong>可以指<strong>INSERT、DELETE、UPDATE</strong> ），都需要”留一手”—&gt;把回滚时所需的东西记下来。比如：</p>
<ul>
<li><strong>插入一条记录</strong>时，至少要把这条记录的主键值记下来，之后回滚的时候只需要把这个主键值对应的<strong>记录删除就好了</strong>（对于每个INSERT，InnoDB存储引擎会完成一个DELETE)</li>
<li><strong>删除了一条记录</strong>，至少要把这条记录中的内容都记下来，这样之后回滚时再把由这些内容组成的记录<strong>插入</strong>到表中就好了。(对于每个DELETE，InnoDB存储引擎会执行一个INSERT)</li>
<li><strong>修改了一条记录</strong>，至少要把修改这条记录前的旧值都记录下来，这样之后回滚时再把这条记录<strong>更新为旧值</strong>就好了。(对于每个UPDATE，InnoDB存储引擎会执行一个相反的UPDATE，将修改前的行放回去)</li>
</ul>
</li>
<li><p>MySQL把这些为了回滚而记录的这些内容称之为<strong>撒销日志</strong>或者<strong>回滚日志</strong>(即<strong>undo log</strong>)。注意，由于查询操作( <strong>SELECT</strong>）并不会修改任何用户记录，所以在查询操作执行时，并不需要记录相应的undo日志</p>
</li>
<li><p>此外，undo log <strong>会产生redo log</strong>，也就是undo log的产生会伴随着redo log的产生，这是因为undo log也需要持久性的保护</p>
</li>
</ul>
<h4 id="8-2-2-2-UNDO日志的作用"><a href="#8-2-2-2-UNDO日志的作用" class="headerlink" title="8.2.2.2 UNDO日志的作用"></a>8.2.2.2 UNDO日志的作用</h4><ul>
<li><h5 id="作用1：回滚数据"><a href="#作用1：回滚数据" class="headerlink" title="作用1：回滚数据"></a>作用1：回滚数据</h5><ul>
<li>用户对undo日志可能<strong>有误解</strong>：undo用于将数据库物理地恢复到执行语句或事务之前的样子。但事实并非如此。undo是<strong>逻辑日志</strong>，因此只是将数据库逻辑地恢复到原来的样子。所有修改都被逻辑地取消了，但是数据结构和页本身在回滚之后可能大不相同</li>
<li>这是因为在多用户并发系统中，可能会有数十、数百甚至数千个并发事务。数据库的主要任务就是协调对数据记录的并发访问。比如，一个事务在修改当前一个页中某几条记录，同时还有别的事务在对同一个页中另几条记录进行修改。因此，不能将一个页回滚到事务开始的样子，因为这样会影响其他事务正在进行的工作</li>
</ul>
</li>
<li><h5 id="作用2：MVCC"><a href="#作用2：MVCC" class="headerlink" title="作用2：MVCC"></a>作用2：MVCC</h5><ul>
<li>undo的另一个作用是MVCC，即在InnoDB存储引擎中MVCC的实现是通过undo来完成。当用户读取一行记录时，若该记录已经被其他事务占用，当前事务可以通过undo读取之前的行版本信息，以此实现非锁定读取</li>
</ul>
</li>
</ul>
<h4 id="8-2-2-3-undo的存储结构"><a href="#8-2-2-3-undo的存储结构" class="headerlink" title="8.2.2.3 undo的存储结构"></a>8.2.2.3 undo的存储结构</h4><blockquote>
<h5 id="1-回滚段与undo页"><a href="#1-回滚段与undo页" class="headerlink" title="1. 回滚段与undo页"></a>1. 回滚段与undo页</h5></blockquote>
<ul>
<li><p>InnoDB对undo log的管理采用段的方式，也就是<strong>回滚段（rollback segment）</strong> 。每个回滚段记录了<strong>1024</strong> 个 <strong>undo log segment</strong> ，而在每个undo log segment段中进行<strong>undo页</strong>的申请</p>
<ul>
<li>在 <strong>InnoDB1.1版本之前</strong> （不包括1.1版本），只有一个rollback segment，因此支持同时在线的事务限制为 <strong>1024</strong>。虽然对绝大多数的应用来说都已经够用</li>
<li>从1.1版本开始InnoDB支持最大 <strong>128个rollback segment</strong> ，故其支持同时在线的事务限制提高到 了 <strong>128*1024</strong></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_undo_logs&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name    <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_undo_logs <span class="operator">|</span> <span class="number">128</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------------+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>虽然InnoDB1.1版本支持了128个rollback segment，但是这些rollback segment都存储于共享表空间ibdata中。从InnoDB1.2版本开始，可通过参数对rollback segment做进一步的设置。这些参数包括：</p>
<ul>
<li><strong>innodb_undo_directory：</strong>设置rollback segment文件所在的路径。这意味若rollback segment可以存放在共享表空间以外的位置，即可以设置为独立表空间。该参数的默认值为“.&#x2F;”，表示当前InnoDB存储引擎的目录</li>
<li><strong>innodb_undo_logs：</strong>设置rollback segment的个数，默认值为128。在InnoDB1.2版本中，该参数用来替换之前版本的参数innodb_rollback_segments</li>
<li><strong>innodb_undo_tablespaces</strong>：设置构成rollback segment文件的数目，这样rollback segment可以较为平均地分布在多个文件中。设置该参数后，会在路径innodb_undo_directory看到undo为前缀的文件，该文件就代表rollback segment文件</li>
</ul>
</li>
<li><p>undo log相关参数一般很少改动</p>
</li>
<li><p><strong>undo页的重用</strong></p>
<ul>
<li><p>当开启一个事务需要写undo log的时候，就得先去undo log segment中去找到一个空闲的位置，当有空位的时候，就去申请undo页，在这个申请到的undo页中进行undo log的写入。我们知道mysql默认一页的大小是16k。为每一个事务分配一个页，是非常浪费的（除非你的事务非常长)，假设你的应用的TPS(每秒处理的事务数目)为1000，那么1s就需要1000个页大概需要16M的存储，1分钟大概需要1G的存储。如果照这样下去除非MySQL清理的非常勤快，否则随着时间的推移，磁盘空间会增长的非常快，而且很多空间都是浪费的</p>
</li>
<li><p>于是undo页就被设计的可以<strong>重用</strong>了，当事务提交时，并不会立刻删除undo页。因为重用，所以这个undo页可能混杂着其他事务的undo log。undo log在commit后，会被放到一个<strong>链表</strong>中，然后判断undo页的使用空间是否<strong>小于3 &#x2F;4</strong>，如果小于3&#x2F;4的话，则表示当前的undo页可以被重用，那么它就不会被回收，其他事务的undo log可以记录在当前undo页的后面。由于undo log是<strong>离散的</strong>，所以清理对应的磁盘空间时，效率不高</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="2-回滚段与事务"><a href="#2-回滚段与事务" class="headerlink" title="2.回滚段与事务"></a>2.回滚段与事务</h5></blockquote>
<ul>
<li>1.每个事务只会使用一个回滚段，一个回滚段在同一时刻可能会服务于多个事务</li>
<li>2.当一个事务开始的时候，会制定一个回滚段，在事务进行的过程中，当数据被修改时，原始的数据会被复制到回滚段<br>3.在回滚段中，事务会不断填充盘区，直到事务结束或所有的空间被用完。如果当前的盘区不够用，事务会在段中请求扩展下一个盘区，如果所有已分配的盘区都被用完，事务会覆盖最初的盘区或者在回滚段允许的情况下扩展新的盘区来使用</li>
<li>4.回滚段存在于undo表空间中，在数据库中可以存在多个undo表空间，但同一时刻只能使用一个undo表空间</li>
<li>5.当事务提交时， lnnoDB存储引擎会做以下两件事情：<ul>
<li>将undo log放入列表中，以供之后的purge操作</li>
<li>判断undo log所在的页是否可以重用，若可以分配给下个事务使用</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="3-回滚段中的数据分类"><a href="#3-回滚段中的数据分类" class="headerlink" title="3. 回滚段中的数据分类"></a>3. 回滚段中的数据分类</h5></blockquote>
<ul>
<li><strong>1.未提交的回滚数据(uncommitted undo information)</strong><br>该数据所关联的事务并未提交，用于实现读一致性，所以该数据不能被其他事务的数据覆盖</li>
<li><strong>2.已经提交但未过期的回滚数据(committed undo information)</strong><br>该数据关联的事务已经提交，但是仍受到undo retention参数的保持时间的影响</li>
<li><strong>3.事务已经提交并过期的数据(expired undo information)</strong><br>事务已经提交，而且数据保存时间已经超过undo retention参数指定的时间，属于已经过期的数据。当回滚段满了之后，会优先覆盖”事务已经提交并过期的数据”</li>
<li>事务提交后并不能马上删除undo log及undo log所在的页。这是因为可能还有其他事务需要通过undo log来得到行记录之前的版本。故事务提交时将undo log放入一个链表中，是否可以最终删除undo log及undo log所在页由purge线程来判断</li>
</ul>
<h4 id="8-2-2-4-undo的类型"><a href="#8-2-2-4-undo的类型" class="headerlink" title="8.2.2.4 undo的类型"></a>8.2.2.4 undo的类型</h4><ul>
<li>在InnoDB存储引擎中，undo log分为：<ul>
<li><strong>insert undo log</strong><br>insert undo log是指在insert操作中产生的undo log。因为insert操作的记录，只对事务本身可见，对其他事务不可见(这是事务隔离性的要求)，故该undo log可以在事务提交后直接删除。不需要进行purge操作</li>
<li><strong>update undo log</strong><br>update undo log记录的是对delete和update操作产生的undo log，该undo log可能需要提供MVCC机制，因此不能在事务提交时就进行删除。提交时放入undo log链表，等待purge线程进行最后的删除</li>
</ul>
</li>
</ul>
<h4 id="8-2-2-5-undo的生命周期"><a href="#8-2-2-5-undo的生命周期" class="headerlink" title="8.2.2.5 undo的生命周期"></a>8.2.2.5 undo的生命周期</h4><blockquote>
<h5 id="1-简要生成过程"><a href="#1-简要生成过程" class="headerlink" title="1.简要生成过程"></a>1.简要生成过程</h5></blockquote>
<ul>
<li><p>以下是undo+redo事务的简化i过程<br>假设有2个数值，分别为A&#x3D;1和B&#x3D;2，然后将A修改为3,B修改为4</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="operator">-</span> <span class="keyword">start</span> transaction ;</span><br><span class="line"><span class="number">2</span>．记录A<span class="operator">=</span><span class="number">1</span>到undo log;</span><br><span class="line"><span class="number">3.</span> <span class="operator">-</span> <span class="keyword">update</span> A <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="number">4.</span> 记录A<span class="operator">=</span><span class="number">3</span> 到redo log;</span><br><span class="line"><span class="number">5</span>．记录B<span class="operator">=</span><span class="number">2</span>到undo log;</span><br><span class="line"><span class="number">6.</span> <span class="operator">-</span> <span class="keyword">update</span> B <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="number">7.</span> 记录B <span class="operator">=</span><span class="number">4</span>到redo log;</span><br><span class="line"><span class="number">8</span>．将redo log刷新到磁盘</span><br><span class="line"><span class="number">9.</span> <span class="operator">-</span> <span class="keyword">commit</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在1-8步骤的任意一步系统宕机，事务未提交，该事务就不会对磁盘上的数据做任何影响</li>
<li>如果在8-9之间宕机，恢复之后可以选择回滚，也可以选择继续完成事务提交，因为此时redo log已经持久化</li>
<li>若在9之后系统宕机，内存映射中变更的数据还来不及刷回磁盘，那么系统恢复之后，可以根据redo log把数据刷回磁盘</li>
</ul>
</li>
<li><p><strong>只有Buffer Pool的流程：</strong></p>
<p><img src="image-20221211220138069.png" alt="MySQL之性能优化/image-20221211220138069"></p>
</li>
<li><p><strong>有了Redo Log和Undo Log之后：</strong></p>
<p><img src="image-20221211220714286.png" alt="MySQL之性能优化/image-20221211220714286"></p>
</li>
<li><p>在更新Buffer Pool中的数据之前，需要先将该数据事务开始之前的状态写入Undo Log中。假设更新到一半出错了，就可以通过Undo Log来回滚到事务开始前</p>
</li>
</ul>
<blockquote>
<h5 id="2-详细生成过程"><a href="#2-详细生成过程" class="headerlink" title="2. 详细生成过程"></a>2. 详细生成过程</h5></blockquote>
<ul>
<li><p>对于InnoDB引擎来说，每个行记录除了记录本身的数据之外，还有几个隐藏的列:</p>
<ul>
<li><strong>DB_ROW_ID：</strong>如果没有为表显式的定义主键，并且表中也没有定义唯一索引，那么InnoDB会自动为表添加一个row_id的隐藏列作为主键</li>
<li><strong>DB_TRX_ID：</strong>每个事务都会分配一个事务ID，当对某条记录发生变更时，就会将这个事务的事务ID写入trx_id中</li>
<li><strong>DB_ROLL_PTR：</strong>回滚指针，本质上就是指句undo log的指针</li>
</ul>
<p><img src="image-20221211220822732.png" alt="MySQL之性能优化/image-20221211220822732"></p>
</li>
<li><p><strong>当执行INSERT时：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">user</span> (name) <span class="keyword">VALUES</span> (&quot;tom&quot;);</span><br></pre></td></tr></table></figure>

<ul>
<li>插入的数据都会生成一条insert undo log，并且数据的回滚指针会指向它。undo log会记录undo log的序号、插入主键的列和值…。那么在进行rollback的时候，通过主键直接把对应的数据删除即可</li>
</ul>
<p><img src="image-20221211221012802.png" alt="MySQL之性能优化/image-20221211221012802"></p>
</li>
<li><p><strong>当执行UPDATE时：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> name<span class="operator">=</span> &quot;Sun&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221211221106858.png" alt="MySQL之性能优化/image-20221211221106858"></p>
<ul>
<li><p>这时会把老的记录写入新的undo log，让回滚指针指向新的undo log，它的undo no是1，并且新的undo log会指向老的undo log (undo no&#x3D;0)</p>
</li>
<li><p>假设现在执行:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">user</span> <span class="keyword">SET</span> id<span class="operator">=</span><span class="number">2</span> <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="image-20221211221214571.png" alt="MySQL之性能优化/image-20221211221214571"></p>
</li>
<li><p>对于更新主键的操作，会先把原来的数据deletemark标识打开，这时并没有真正的删除数据，真正的删除会交给清理线程去判断，然后在后面插入一条新的数据，新的数据也会产生undo log，并且undo log的序号会递增</p>
</li>
<li><p>可以发现每次对数据的变更都会产生一个undo log，当一条记录被变更多次时，那么就会产生多条undo log,undo log记录的是变更前的日志，并且每个undo log的序号是递增的，那么当要回滚的时候，按照序号<strong>依次向前推</strong>，就可以找到原始数据</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="3-undo-log是如何回滚的"><a href="#3-undo-log是如何回滚的" class="headerlink" title="3. undo log是如何回滚的"></a>3. undo log是如何回滚的</h5></blockquote>
<ul>
<li>以上面的例子来说，假设执行rollback，那么对应的流程应该是这样：<ul>
<li>通过undo no&#x3D;3的日志把id&#x3D;2的数据删除</li>
<li>通过undo no&#x3D;2的日志把id&#x3D;1的数据的deletemark还原成</li>
<li>通过undo no&#x3D;1的日志把id&#x3D;1的数据的name还原成Tom</li>
<li>通过undo no&#x3D;0的日志把id&#x3D;1的数据删除</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="4-undo-log的删除"><a href="#4-undo-log的删除" class="headerlink" title="4. undo log的删除"></a>4. undo log的删除</h5></blockquote>
<ul>
<li>针对于insert undo log<br>因为insert操作的记录，只对事务本身可见，对其他事务不可见。故该undo log可以在事务提交后直接删<br>除，不需要进行purge操作</li>
<li>针对于update undo log<br>该undo log可能需要提供MVCC机制，因此不能在事务提交时就进行删除。提交时放入undo log链表，等待purge线程进行最后的删除</li>
</ul>
<blockquote>
<p>补充:<br>purge线程两个主要作用是：<strong>清理undo页和清除page里面带有Delete_Bit标识的数据行</strong>。在InnoDB中，事务中的Delete操作实际上并不是真正的删除掉数据行，而是一种Delete Mark操作，在记录上标识Delete_Bit，而不删除记录。是一种”假删除”;只是做了个标记，真正的删除工作需要后台purge线程去完成</p>
</blockquote>
<h4 id="8-2-3-小结"><a href="#8-2-3-小结" class="headerlink" title="8.2.3 小结"></a>8.2.3 小结</h4><p><img src="image-20221211214046983.png" alt="MySQL之性能优化/image-20221211214046983"></p>
<ul>
<li>undo log是逻辑日志，对事务回滚时，只是将数据库逻辑地恢复到原来的样子</li>
<li>redo log是物理日志，记录的是数据页的物理变化，undo log不是redo log的逆过程</li>
</ul>
<h2 id="8-3-锁"><a href="#8-3-锁" class="headerlink" title="8.3 锁"></a>8.3 锁</h2><ul>
<li>事务的<strong>隔离性</strong>由这章讲述的<strong>锁</strong>来实现</li>
</ul>
<h3 id="8-3-1-概述"><a href="#8-3-1-概述" class="headerlink" title="8.3.1 概述"></a>8.3.1 概述</h3><ul>
<li><p><strong>锁</strong>是计算机协调多个进程或线程<strong>并发访问某一资源</strong>的机制。在程序开发中会存在多线程同步的问题，当多个线程并发访问某个数据的时候，尤其是针对一些敏感的数据（比如订单、金额等)，就需要保证这个数据在任何时刻<strong>最多只有一个线程</strong>在访问，保证数据的<strong>完整性</strong>和<strong>一致性</strong>。在开发过程中加锁是为了保证数据的一致性，这个思想在数据库领域中同样很重要</p>
</li>
<li><p>在数据库中，除传统的计算资源（如CPU、RAM、I&#x2F;O等）的争用以外，数据也是一种供许多用户共享的 资源。为保证数据的一致性，需要对<strong>并发操作进行控制</strong>，因此产生了<strong>锁</strong> 。同时 <strong>锁机制</strong> 也为实现MySQL 的各个隔离级别提供了保证。 <strong>锁冲突</strong> 也是影响数据库 <strong>并发访问性能</strong> 的一个重要因素。所以锁对数据库而 言显得尤其重要，也更加复杂</p>
</li>
</ul>
<h3 id="8-3-2-MySQL并发事务访问相同记录"><a href="#8-3-2-MySQL并发事务访问相同记录" class="headerlink" title="8.3.2 MySQL并发事务访问相同记录"></a>8.3.2 MySQL并发事务访问相同记录</h3><ul>
<li>并发事务访问相同记录的情况大致可以划分为3种</li>
</ul>
<h4 id="8-3-2-1-读-读情况"><a href="#8-3-2-1-读-读情况" class="headerlink" title="8.3.2.1 读-读情况"></a>8.3.2.1 读-读情况</h4><ul>
<li><strong>读-读</strong>情况，即并发事务相继<strong>读取相同的记录</strong>。读取操作本身不会对记录有任何影响，并不会引起什么问题，所以允许这种情况的发生</li>
</ul>
<h4 id="8-3-2-2-写-写情况"><a href="#8-3-2-2-写-写情况" class="headerlink" title="8.3.2.2 写-写情况"></a>8.3.2.2 写-写情况</h4><ul>
<li><p><strong>写-写</strong>情况，即并发事务相继对相同的记录做出改动</p>
</li>
<li><p>在这种情况下会发生<strong>脏写</strong>的问题，任何一种隔离级别都不允许这种问题的发生。所以在多个未提交事务相继对一条记录做改动时，需要让它们<strong>排队执行</strong> ，这个排队的过程其实是通过 <strong>锁</strong> 来实现的。这个所谓的锁其实是一个 <strong>内存中的结构</strong> ，在事务执行前本来是没有锁的，也就是说一开始是没有 <strong>锁结构</strong> 和记录进行关联的,如图所示：<br><img src="image-20221212173030228.png" alt="MySQL之性能优化/image-20221212173030228"></p>
</li>
<li><p>当一个事务想对这条记录做改动时，首先会看看内存中有没有与这条记录关联的 <strong>锁结构</strong> ，当没有的时候<br>就会在内存中生成一个 <strong>锁结构</strong> 与之关联。比如，事务 T1 要对这条记录做改动，就需要生成一个 <strong>锁结构</strong><br>与之关联：</p>
<p><img src="image-20221212173300984.png" alt="MySQL之性能优化/image-20221212173300984"></p>
</li>
<li><p>在<strong>锁结构</strong>里有很多信息，为了简化理解，只把两个比较重要的属性拿了出来：</p>
<ul>
<li><strong>trx信息：</strong>代表这个锁结构是哪个事务生成的</li>
<li><strong>is_waiting：</strong>代表当前事务是否在等待</li>
</ul>
</li>
<li><p>当事务<strong>T1</strong>改动了这条记录后，就生成了一个<strong>锁结构</strong>与该记录关联，因为之前没有别的事务为这条记录加锁，所以<strong>is_waiting</strong>属性就是<strong>false</strong>，把这个场景就称之为<strong>获取锁成功</strong>，或者<strong>加锁成功</strong>，然后就可以继续执行操作了</p>
</li>
<li><p>在事务<strong>T1</strong>提交之前，另一个事务<strong>T2</strong>也想对该记录做改动，那么先看看有没有<strong>锁结构</strong>与这条记录关联，发现有一个锁结构与之关联后，然后也生成了一个<strong>锁结构</strong>与这条记录关联，不过锁结构的<strong>is_waiting</strong>属性值为<strong>true</strong>，表示当前事务需要等待，把这个场景就称之为<strong>获取锁失败</strong>，或者<strong>加锁失败</strong>，图示：</p>
<p><img src="image-20221212173411360.png" alt="MySQL之性能优化/image-20221212173411360"></p>
</li>
<li><p>在事务<strong>T1</strong>提交之后，就会把该事务生成的<strong>锁结构释放</strong>掉，然后看看还有没有别的事务在等待获取锁，发现了事务T2还在等待获取锁，所以把事务<strong>T2</strong>对应的锁结构的<strong>is_waiting</strong>属性设置为<strong>false</strong>，然后把该事务对应的线程唤醒，让它继续执行，此时事务T2就算获取到锁了。效果图就是这样：</p>
<p><img src="image-20221212173449748.png" alt="MySQL之性能优化/image-20221212173449748"></p>
</li>
<li><p>小结几种说法:</p>
<ul>
<li>不加锁<br>意思就是不需要在内存中生成对应的<strong>锁结构</strong>，可以直接执行操作</li>
<li>获取锁成功，或者加锁成功<br>意思就是在内存中生成了对应的<strong>锁结构</strong>，而且锁结构的<strong>is_waiting</strong>属性为<strong>false</strong>，也就是事务可以继续执,行操作</li>
<li>获取锁失败，或者加锁失败，或者没有获取到锁<br>意思就是在内存中生成了对应的<strong>锁结构</strong>，不过锁结构的<strong>is_waiting</strong>属性为<strong>true</strong>，也就是事务需要等待，不可以继续执行操作</li>
</ul>
</li>
</ul>
<h4 id="8-3-2-3-读-写或写-读情况"><a href="#8-3-2-3-读-写或写-读情况" class="headerlink" title="8.3.2.3 读-写或写-读情况"></a>8.3.2.3 读-写或写-读情况</h4><ul>
<li><strong>读-写</strong>或<strong>写-读</strong>，即一个事务进行读取操作，另一个进行改动操作。这种情况下可能发生<strong>脏读</strong> 、<strong>不可重复读</strong> 、 <strong>幻读</strong>的问题</li>
<li>各个数据库厂商对 <strong>SQL标准</strong> 的支持都可能不一样。比如MySQL在 <strong>REPEATABLE READ 隔离</strong>级别上就已经解决了<strong>幻读</strong>问题</li>
</ul>
<h4 id="8-3-2-4-并发问题的解决方案"><a href="#8-3-2-4-并发问题的解决方案" class="headerlink" title="8.3.2.4 并发问题的解决方案"></a>8.3.2.4 并发问题的解决方案</h4><ul>
<li><p>怎么解决<strong>脏读 、不可重复读、幻读</strong>这些问题呢？其实有两种可选的解决方案- ：</p>
</li>
<li><p><strong>方案一：读操作利用多版本并发控制（ MVCC），写操作进行加锁 **<br>所谓的</strong>MVCC<strong>，就是生成一个</strong>ReadView<strong>，通过ReadView找到符合条件的记录版本（(历史版本由undo日志构建)。查询语句只能</strong>读<strong>到在生成ReadView之前</strong>已提交事务所做的更改<strong>，在生成ReadView之前未提交的事务或者之后才开启的事务所做的更改是看不到的。而</strong>写操作<strong>肯定针对的是</strong>最新版本的记录<strong>，读记录的历史版本和改动记录的最新版本本身并不冲突，也就是采用MVCC时，</strong>读-写**操作并不冲突</p>
</li>
</ul>
<blockquote>
<p>普通的SELECT语句在READ COMMITTED和REPEATABLE READ隔离级别下会使用到MVCC读取记录</p>
<ul>
<li>在 <strong>READ COMMITTED</strong> 隔离级别下，一个事务在执行过程中每次执行SELECT操作时都会生成一个ReadView，ReadView的存在本身就保证了 <strong>事务不可以读取到未提交的事务所做的更改</strong> ，也就 是避免了<strong>脏读</strong>现象</li>
<li>在 <strong>REPEATABLE READ</strong> 隔离级别下，一个事务在执行过程中只有 <strong>第一次执行SELECT操作</strong> 才会生成一个ReadView，之后的SELECT操作都 <strong>复用</strong> 这个ReadView，这样也就避免了<strong>不可重复读和幻读</strong>的问题</li>
</ul>
</blockquote>
<ul>
<li><p><strong>方案二：读、写操作都采用加锁的方式</strong><br>如果我们的一些业务场景不允许读取记录的旧版本，而是每次都必须去<strong>读取记录的最新版本</strong>。比如，在银行存款的事务中，你需要先把账户的余额读出来，然后将其加上本次存款的数额，最后再写到数据库中。在将账户余额读取出来后，就不想让别的事务再访问该余额，直到本次存款事务执行完成，其他事务才可以访问账户的余额。这样在读取记录的时候就需要对其进行<strong>加锁</strong>操作，这样也就意味着<strong>读操作</strong>和<strong>写操作</strong>也像写-写操作那样<strong>排队</strong>执行</p>
<p><strong>脏读的产生</strong>是因为当前事务读取了另一个未提交事务写的一条记录，如果另一个事务在写记录的时候就给这条记录加锁，那么当前事务就无法继续读取该记录了，所以也就不会有脏读问题的产生了</p>
<p><strong>不可重复读的产生</strong>是因为当前事务先读取一条记录，另外一个事务对该记录做了改动之后并提交之后，当前事务再次读取时会获得不同的值，如果在当前事务读取记录时就给该记录加锁，那么另一个事务就无法修改该记录，自然也不会发生不可重复读了</p>
<p><strong>幻读问题的产生</strong>是因为当前事务读取了一个范围的记录，然后另外的事务向该范围内插入了新记录，当前事务再次读取该范围的记录时发现了新插入的新记录。采用加锁的方式解决幻读问题就有一些麻烦，因为当前事务在第一次读取记录时幻影记录并不存在，所以读取的时候加锁就有点尴尬（因为你并不知道给谁加锁)</p>
</li>
<li><p><strong>小结对比发现：</strong></p>
<ul>
<li>采用 <strong>MVCC</strong> 方式的话， <strong>读-写</strong> 操作彼此并不冲突， <strong>性能更高</strong></li>
<li>采用<strong>加锁</strong>方式的话， <strong>读-写</strong>操作彼此需要排队执行，<strong>影响性能</strong></li>
</ul>
</li>
<li><p>一般情况下当然愿意采用 <strong>MVCC</strong> 来解决 <strong>读-写</strong> 操作并发执行的问题，但是业务在某些特殊情况下，要求必须采用 <strong>加锁</strong> 的方式执行。下面就讲解下MySQL中不同类别的锁</p>
</li>
</ul>
<h3 id="8-3-3-锁的不同角度分类"><a href="#8-3-3-锁的不同角度分类" class="headerlink" title="8.3.3 锁的不同角度分类"></a>8.3.3 锁的不同角度分类</h3><ul>
<li><p>锁的分类图，如下：</p>
<p><img src="image-20221212212643923.png" alt="MySQL之性能优化/image-20221212212643923"></p>
</li>
</ul>
<h4 id="8-3-3-1-从数据操作的类型划分：读锁、写锁"><a href="#8-3-3-1-从数据操作的类型划分：读锁、写锁" class="headerlink" title="8.3.3.1 从数据操作的类型划分：读锁、写锁"></a>8.3.3.1 从数据操作的类型划分：读锁、写锁</h4><ul>
<li><p>对于数据库中并发事务的<strong>读-读</strong>情况并不会引起什么问题。对于<strong>写-写、读-写</strong>或<strong>写-读</strong>这些情况可能会引起一些问题，需要使用<strong>MVCC</strong>或者<strong>加锁</strong>的方式来解决它们。在使用加锁的方式解决问题时，由于既要允许<strong>读-读</strong>情况不受影响，又要使<strong>写-写、读-写</strong>或<strong>写-读</strong>情况中的操作<strong>相互阻塞</strong>，所以MySQL实现一个由两种类型的锁组成的锁系统来解决。这两种类型的锁通常被称为<strong>共享锁(Shared Lock，S Lock)<strong>和</strong>排他锁(Exclusive Lock，X Lock)<strong>，也叫</strong>读锁(readlock)<strong>和</strong>写锁(write lock)</strong></p>
<ul>
<li><strong>读锁</strong>：也称为<strong>共享锁</strong>、英文用<strong>S</strong>表示。,针对同一份数据，多个事务的读操作可以同时进行而不会互相影响，相互不阻塞的。</li>
<li><strong>写锁：</strong>也称为<strong>排他锁</strong>、英文用<strong>X</strong>表示。当前写操作没有完成前，它会阻断其他写锁和读锁。这样就能确保在给定的时间里，只有一个事务能执行写入，并防止其他用户读取正在写入的同一资源</li>
</ul>
</li>
<li><p><strong>需要注意的是对于InnoDB引擎来说，读锁和写锁可以加在表上，也可以加在行上</strong></p>
</li>
<li><p><strong>举例（行级读写锁)︰</strong>如果一个事务T1已经获得了某个行r的读锁，那么此时另外的一个事务T2是可以去获得这个行r的读锁的，因为读取操作并没有改变行r的数据;但是，如果某个事务T3想获得行r的写锁，则它必须等待事务T1、T2释放掉行r上的读锁才行</p>
</li>
<li><p>总结：这里的兼容是指对同一张表或记录的锁的兼容性情况</p>
<table>
<thead>
<tr>
<th>兼容情况</th>
<th>X锁</th>
<th>S锁</th>
</tr>
</thead>
<tbody><tr>
<td>X锁</td>
<td>不兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>S锁</td>
<td>不兼容</td>
<td><strong>兼容</strong></td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<p><strong>1.锁定读</strong></p>
</blockquote>
<ul>
<li><p>在采用<strong>加锁</strong>方式解决<strong>脏读、不可重复读、幻读</strong>这些问题时，读取一条记录时需要获取该记录的<strong>S锁</strong>，其实是不严谨的，有时候需要在读取记录时就获取记录的<strong>X锁</strong>，来禁止别的事务读写该记录，为此MySQL提出了两种比较特殊的<strong>SELECT</strong>语句格式：</p>
<ul>
<li><p>对读取的记录加<strong>S锁</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... LOCK <span class="keyword">IN</span> SHARE MODE; </span><br><span class="line">#或</span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> SHARE;#(<span class="number">8.0</span>新增语法)</span><br></pre></td></tr></table></figure>

<ul>
<li>在普通的SELECT语句后边加<strong>LOCK IN SHARE MODE</strong>，如果当前事务执行了该语句，那么它会为读取到的记录加<strong>S锁</strong>，这样允许别的事务继续获取这些记录的<strong>S锁</strong>（比方说别的事务也使用<strong>SELECT …LOCK IN SHARE MODE</strong>语句来读取这些记录)，但是不能获取这些记录的<strong>X锁</strong>(比如使用<strong>SELECT … FOR UPDATE</strong>语句来读取这些记录，或者直接修改这些记录)。如果别的事务想要获取这些记录的<strong>X锁</strong>，那么它们会阻塞，直到当前事务提交之后将这些记录上的<strong>S锁</strong>释放掉</li>
</ul>
</li>
<li><p>对读取的记录加<strong>X锁</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在普通的SELECT语句后边加<strong>FOR UPDATE</strong>，如果当前事务执行了该语句，那么它会为读取到的记录加X锁，这样既不允许别的事务获取这些记录的<strong>S锁</strong>(比方说别的事务使用<strong>SELECT … LOCK IN SHARE MODE</strong>语句来读取这些记录)，也不允许获取这些记录的<strong>X锁</strong>(比如使用<strong>SELECT … FOR UPDATE</strong>语句来读取这些记录，或者直接修改这些记录)。如果别的事务想要获取这些记录的<strong>S锁</strong>或者<strong>X锁</strong>，那么它们会阻塞，直到当前事务提交之后将这些记录上的<strong>X锁</strong>释放掉</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>MySQL8.0新特性：</strong></p>
<ul>
<li>在5.7及之前的版本，SELECT …FOR UPDATE，如果获取不到锁，会一直等待，直到<br><strong>innodb_lock_wait_timeout</strong>超时。在8.0版本中，在<strong>SELECT …FOR UPDATE，SELECT …FOR SHARE</strong>后添加<strong>NOWAIT、SKIP LOCKED</strong>语法，跳过锁等待，或者跳过锁定</li>
<li>通过添加NOWAIT、SKIP LOCKED语法，能够立即返回。<strong>如果查询的行已经加锁：</strong><ul>
<li>那么NOWAIT会立即报错返回</li>
<li>而SKIP LOCKED也会立即返回，只是返回的结果中不包含被锁定的行</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>2.写操作</p>
</blockquote>
<ul>
<li><p>平常所用到的<strong>写操作</strong>无非是 <strong>DELETE、UPDATE、INSERT</strong> 这三种：</p>
</li>
<li><p><strong>DELETE:</strong><br>对一条记录做DELETE操作的过程其实是先在<strong>B+<strong>树中定位到这条记录的位置，然后获取这条记录的</strong>X锁</strong>，再执行<strong>delete mark</strong>操作。也可以把这个定位待删除记录在B+树中位置的过程看成是一个获取<strong>X锁</strong>的<strong>锁定读</strong></p>
</li>
<li><p><strong>UPDATE︰在对一条记录做UPDATE操作时分为三种情况：</strong></p>
<blockquote>
<p>情况1: 未修改该记录的键值，并且被更新的列占用的存储空间在修改前后未发生变化。 则先在<strong>B+<strong>树中定位到这条记录的位置，然后再获取一下记录的</strong>X锁</strong>，最后在原记录的位置进行修改操作。也可以把这个定位待修改记录在<strong>B+<strong>树中位置的过程看成是一个获取</strong>X锁</strong>的<strong>锁定读</strong></p>
<p>情况2∶未修改该记录的键值，并且至少有一个被更新的列占用的存储空间在修改前后发生变化。 则先在<strong>B+<strong>树中定位到这条记录的位置，然后获取一下记录的</strong>X锁</strong>，将该记录彻底删除掉（就是把记录彻底移入垃圾链表)，最后再插入一条新记录。这个定位待修改记录在<strong>B+<strong>树中位置的过程看成是一个获取</strong>X锁</strong>的<strong>锁定读</strong>，新插入的记录由<strong>INSERT</strong>操作提供的<strong>隐式锁</strong>进行保护</p>
<p>情况3∶ 修改了该记录的键值，则相当于在原记录上做<strong>DELETE</strong>操作之后再来一次<strong>INSERT</strong>操作，加锁操作就需要按照<strong>DELETE</strong>和<strong>INSERT</strong>的规则进行了</p>
</blockquote>
</li>
<li><p><strong>INSERT :</strong><br>一般情况下，新插入一条记录的操作并不加锁,通过一种称之为<strong>隐式锁</strong>的结构来保护这条新插入的记录在本事务提交前不被别的事务访问</p>
</li>
</ul>
<h4 id="8-3-3-2-从数据操作的粒度划分：表级锁、页级锁、行锁"><a href="#8-3-3-2-从数据操作的粒度划分：表级锁、页级锁、行锁" class="headerlink" title="8.3.3.2 从数据操作的粒度划分：表级锁、页级锁、行锁"></a>8.3.3.2 从数据操作的粒度划分：表级锁、页级锁、行锁</h4><ul>
<li><p>为了尽可能提高数据库的并发度，每次锁定的数据范围越小越好，理论上每次只锁定当前操作的数据的方案会得到最大的并发度，但是管理锁是很<strong>耗资源</strong>的事情（涉及获取、检查、释放锁等动作)。因此数据库系统需要在<strong>高并发响应</strong>和<strong>系统性能</strong>两方面进行平衡，这样就产生了“**锁粒度〈Lock granularity)**”的概念</p>
</li>
<li><p>对一条记录加锁影响的也只是这条记录而已，我们就说这个锁的粒度比较细;其实一个事务也可以在表级别进行加锁，自然就被称之为<strong>表级锁</strong>或者<strong>表锁</strong>，对一个表加锁影响整个表中的记录，我们就说这个锁的粒度比较粗。<strong>锁的粒度主要分为表级锁、页级锁和行锁</strong></p>
</li>
</ul>
<h5 id="8-3-3-2-1-表锁-Table-Lock"><a href="#8-3-3-2-1-表锁-Table-Lock" class="headerlink" title="8.3.3.2.1 表锁(Table Lock)"></a>8.3.3.2.1 表锁(Table Lock)</h5><ul>
<li>该锁会锁定整张表，它是MySQL中最基本的锁策略，并<strong>不依赖于存储引擎</strong>（不管是MySQL的什么存储引擎，对于表锁的策略都是一样的)，并且表锁是<strong>开销最小</strong>的策略(因为粒度比较大)。由于表级锁一次会将整个表锁定，所以可以很好的<strong>避免死锁</strong>问题。当然，锁的粒度大所带来最大的负面影响就是出现锁资源争用的概率也会最高，导致<strong>并发率大打折扣</strong></li>
</ul>
<blockquote>
<h5 id="①-表级别的S锁、X锁"><a href="#①-表级别的S锁、X锁" class="headerlink" title="① 表级别的S锁、X锁"></a>① 表级别的S锁、X锁</h5></blockquote>
<ul>
<li><p>在对某个表执行SELECT、INSERT、DELETE、UPDATE语句时，InnoDB存储引擎是不会为这个表添加表级别的<strong>S锁</strong>或者<strong>X锁</strong>的。在对某个表执行一些诸如<strong>ALTER TABLE、DROP TABLE</strong>这类的<strong>DDL</strong>语句时，其他事务对这个表并发执行诸如SELECT、INSERT、DELETE、UPDATE的语句会发生阻塞。同理，某个事务中对某个表执行SELECT、INSERT、DELETE、UPDATE语句时，在其他会话中对这个表执行<strong>DDL</strong>语句也会发生阻塞。这个过程其实是通过在<strong>server层</strong>使用一种称之为<strong>元数据锁</strong>(英文名: <strong>Metadata Locks</strong>，简称<strong>MDL</strong>）结构来实现的</p>
</li>
<li><p>一般情况下，不会使用InnoDB存储引擎提供的表级别的<strong>S锁</strong>和<strong>X锁</strong>。只会在一些特殊情况下，比方说<strong>崩溃恢复</strong>过程中用到。比如，在系统变量 <strong>autocommit&#x3D;0，innodb_table_locks &#x3D; 1</strong> 时，<strong>手动</strong>获取InnoDB存储引擎提供的表t 的<strong>S锁</strong>或者<strong>X锁</strong>可以这么写：</p>
<ul>
<li><strong>LOCK TABLES t READ：</strong>InnoDB存储引擎会对表 t 加表级别的<strong>S锁</strong></li>
<li><strong>LOCK TABLES t WRITE：</strong>InnoDB存储引擎会对表 t 加表级别的<strong>X锁</strong></li>
</ul>
</li>
<li><p>不过尽量避免在使用InnoDB存储引擎的表上使用 <strong>LOCK TABLES</strong> 这样的手动锁表语句，它们并不会提供什么额外的保护，只是会降低并发能力而已。InnoDB的厉害之处还是实现了更细粒度的<strong>行锁</strong> </p>
</li>
<li><p>举例:下面我们讲解MylSAM引擎下的表锁</p>
<ul>
<li><p>步骤1:创建表并添加数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mylock(</span><br><span class="line">id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY auto_increment,`name` <span class="type">VARCHAR</span>(<span class="number">20</span>)</span><br><span class="line">)ENGINE myisam;#存储引擎使用InnoDB也可以，只是不建议</span><br><span class="line">#插入一条数据</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> mylock(`name`) <span class="keyword">VALUES</span>(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">#查询表中所有的数据</span><br><span class="line"><span class="keyword">SELECT</span><span class="operator">*</span> <span class="keyword">FROM</span> mylock;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+----+------+</span></span><br><span class="line"><span class="comment">| id | name |</span></span><br><span class="line"><span class="comment">+----+------+</span></span><br><span class="line"><span class="comment">|  1 | a    |</span></span><br><span class="line"><span class="comment">+----+------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>步骤2:查看表上加过的锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES <span class="keyword">where</span> In_use <span class="operator">&gt;</span> a;</span><br><span class="line">#或者</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES;#主要关注In_use字段的值</span><br><span class="line"><span class="comment">/*部分输出</span></span><br><span class="line"><span class="comment">SHOW OPEN TABLES;</span></span><br><span class="line"><span class="comment">+--------------------+---------------------------+--------+-------------+</span></span><br><span class="line"><span class="comment">| Database           | Table                     | In_use | Name_locked |</span></span><br><span class="line"><span class="comment">+--------------------+---------------------------+--------+-------------+</span></span><br><span class="line"><span class="comment">| atguigudb2         | mylock                    |      0 |           0 |</span></span><br><span class="line"><span class="comment">| mysql              | routines                  |      0 |           0 |</span></span><br><span class="line"><span class="comment">| mysql              | parameter_type_elements   |      0 |           0 |</span></span><br><span class="line"><span class="comment">| performance_schema | session_variables         |      0 |           0 |</span></span><br><span class="line"><span class="comment">| mysql              | index_stats               |      0 |           0 |</span></span><br><span class="line"><span class="comment">| atguigudb2         | user3                     |      0 |           0 |</span></span><br><span class="line"><span class="comment">| atguigudb2         | type                      |      0 |           0 |</span></span><br><span class="line"><span class="comment">| atguigudb2         | test2                     </span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的结果表明，当前数据库中没有被锁定的表</li>
</ul>
</li>
<li><p>步骤3:手动增加表锁命令</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES t READ:#存储引擎会对表t加表级别的共享锁。共享锁也叫读锁或S锁(Share的缩写)</span><br><span class="line">LOCK TABLES t WRITE:#存储引擎会对表t加表级别的排他锁。排它锁也叫独占锁、写锁或X锁《是eXclusive的缩写)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lock tables mylock write;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">OPEN</span> TABLES <span class="keyword">where</span> In_use <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*mylock加了表锁</span></span><br><span class="line"><span class="comment">+------------+--------+--------+-------------+</span></span><br><span class="line"><span class="comment">| Database   | Table  | In_use | Name_locked |</span></span><br><span class="line"><span class="comment">+------------+--------+--------+-------------+</span></span><br><span class="line"><span class="comment">| atguigudb2 | mylock |      1 |           0 |</span></span><br><span class="line"><span class="comment">+------------+--------+--------+-------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>步骤4：释放锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#释放锁</span><br><span class="line">unlock tables;#释放当前加锁的表</span><br></pre></td></tr></table></figure>
</li>
<li><p>步骤5:加读锁<br>为mylock表加read锁(读阻塞写)，观察阻塞的情况，流程如下：</p>
<p><img src="image-20221213114824973.png" alt="MySQL之性能优化/image-20221213114824973"></p>
</li>
<li><p>步骤6∶加写锁<br>为mylock表加write锁，观察阻塞的情况，流程如下：</p>
<p><img src="image-20221213115201237.png" alt="MySQL之性能优化/image-20221213115201237"></p>
</li>
</ul>
</li>
<li><p><strong>总结:</strong></p>
<ul>
<li><p>MylSAM在执行查询语句(SELECT)前，会给涉及的所有表加读锁，在执行增删改操作前，会给涉及的表加写锁。<strong>InnoDB</strong>存储引擎是不会为这个表添加表级别的<strong>读锁</strong>或者<strong>写锁</strong>的</p>
</li>
<li><p>MySQL的表级锁有两种模式：(以MyISAM表进行操作的演示)</p>
<ul>
<li><strong>表共享读锁(Table Read Lock)</strong></li>
<li><strong>表独占写锁(Table Write Lock)</strong></li>
</ul>
<table>
<thead>
<tr>
<th>锁类型</th>
<th>自己可读</th>
<th>自己可写</th>
<th>自己可操作其他表</th>
<th>他人可读</th>
<th>他人可写</th>
</tr>
</thead>
<tbody><tr>
<td>读锁</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>是</td>
<td>否，需等待</td>
</tr>
<tr>
<td>写锁</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>否，需等待</td>
<td>否，需等待</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="②-意向锁-（intention-lock）"><a href="#②-意向锁-（intention-lock）" class="headerlink" title="② 意向锁 （intention lock）"></a>② 意向锁 （intention lock）</h5></blockquote>
<ul>
<li><p>InnoDB 支持 <strong>多粒度锁（multiple granularity locking）</strong> ，它允许 <strong>行级锁</strong> 与 <strong>表级锁</strong> 共存，而<strong>意向锁</strong>就是其中的一种<strong>表锁</strong></p>
<p>1、意向锁的存在是为了协调行锁和表锁的关系，支持多粒度（表锁与行锁）的锁并存。<br>2、意向锁是一种<strong>不与行级锁冲突表级锁</strong>，这一点非常重要<br>3、表明“某个事务正在某些行持有了锁或该事务准备去持有锁”</p>
</li>
<li><p>意向锁分为两种：</p>
<ul>
<li><p><strong>意向共享锁</strong>（intention shared lock, IS）：事务有意向对表中的某些行加<strong>共享锁</strong>（S锁）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 事务要获取某些行的 S 锁，必须先获得表的 IS 锁。</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span> <span class="keyword">FROM</span> <span class="keyword">table</span> ... LOCK <span class="keyword">IN</span> SHARE MODE;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>意向排他锁</strong>（intention exclusive lock, IX）：事务有意向对表中的某些行加<strong>排他锁</strong>（X锁）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 事务要获取某些行的 X 锁，必须先获得表的 IX 锁。</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">column</span> <span class="keyword">FROM</span> <span class="keyword">table</span> ... <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>即：意向锁是由存储引擎<strong>自己维护的</strong>，用户无法手动操作意向锁，在为数据行加共享 &#x2F; 排他锁之前，InooDB 会先获取该数据行<strong>所在数据表的对应意向锁</strong> </p>
</li>
<li><p><strong>1.意向锁要解决的问题</strong></p>
<ul>
<li><p>现在有两个事务，分别是T1和T2，其中T2试图在该表级别上应用共享或排它锁，如果没有意向锁存在，那么T2就需要去检查各个页或行是否存在锁;如果存在意向锁，那么此时就会受到由T1控制的表级别意向锁的阻塞。T2在锁定该表前不必检查各个页或行锁，而只需检查表上的意向锁。简单来说就是给更大一级别的空间示意里面是否已经上过锁</p>
</li>
<li><p>在数据表的场景中，<strong>如果给某一行数据加上了排它锁，数据库会自动给更大一级的空间，比如数据页或数据表加上意向锁，告诉其他人这个数据页或数据表已经有人上过排它锁了</strong>，这样当其他人想要获取数据表排它锁的时候，只需要了解是否有人已经获取了这个数据表的意向排他锁即可</p>
<ul>
<li>如果事务想要获得数据表中某些记录的共享锁，就需要在数据表上<strong>添加意向共享锁</strong></li>
<li>如果事务想要获得数据表中某些记录的排他锁，就需要在数据表上<strong>添加意向排他锁</strong></li>
</ul>
</li>
<li><p>这时，意向锁会告诉其他事务已经有人锁定了表中的某些记录</p>
</li>
<li><p><strong>举例：</strong>创建表teacher，插入6条数据，事务的隔离级别默认为<strong>Repeatable-Read</strong>，如下所示</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `teacher`(id <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">                       name <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,<span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">                      )ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `teacher` <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;zhangsan&#x27;</span>) ,</span><br><span class="line">( <span class="number">2</span> , <span class="string">&#x27;lisi&#x27;</span> ) ,( <span class="number">3</span>, <span class="string">&#x27;wangwu&#x27;</span> ) ,( <span class="number">4</span>, <span class="string">&#x27;zhaoliu&#x27;</span>),( <span class="number">5</span>, <span class="string">&#x27;songhongkang&#x27;</span> ),( <span class="number">6</span> , <span class="string">&#x27;leifengyang&#x27;</span>);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="variable">@transaction</span>_isolation;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+-------------------------+</span></span><br><span class="line"><span class="comment">| @@transaction_isolation |</span></span><br><span class="line"><span class="comment">+-------------------------+</span></span><br><span class="line"><span class="comment">| REPEATABLE-READ         |</span></span><br><span class="line"><span class="comment">+-------------------------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>假设事务A获取了某一行的排他锁，并未提交，语句如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#事务A</span><br><span class="line"><span class="keyword">begin</span> ;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teacher <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事务B想要获取teacher表的表读锁，语句如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> ;</span><br><span class="line">LOCK TABLES teacher READ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为共享锁与排他锁互斥，所以事务B在试图对teacher表加共享锁的时候，必须保证两个条件<br>(1）当前没有其他事务持有teacher表的排他锁<br>(2）当前没有其他事务持有teacher 表中任意一行的排他锁</p>
</li>
<li><p>为了检测是否满足第二个条件，事务B必须在确保teacher表不存在任何排他锁的前提下，去检测表中的每一行是否存在排他锁。很明显这是一个效率很差的做法，但是有了意向锁之后，情况就不一样了</p>
</li>
<li><p>意向锁是怎么解决这个问题的呢?首先需要知道意向锁之间的兼容互斥性，如下所示：</p>
<table>
<thead>
<tr>
<th>兼容性</th>
<th>意向共享锁(lS)</th>
<th>意向排他锁(IX)</th>
</tr>
</thead>
<tbody><tr>
<td>意向共享锁(IS)</td>
<td>兼容</td>
<td>兼容</td>
</tr>
<tr>
<td>意向排他锁(IX)</td>
<td>兼容</td>
<td>兼容</td>
</tr>
</tbody></table>
</li>
<li><p>即意向锁之间是互相兼容的，虽然意向锁和自家兄弟互相兼容，但是它会与普通的排他&#x2F;共享锁互斥：</p>
<table>
<thead>
<tr>
<th>兼容性</th>
<th>意向共享锁(lS)</th>
<th>意向排他锁(IX)</th>
</tr>
</thead>
<tbody><tr>
<td>共享锁(IS)</td>
<td>兼容</td>
<td>互斥</td>
</tr>
<tr>
<td>排他锁(IX)</td>
<td>互斥</td>
<td>互斥</td>
</tr>
</tbody></table>
</li>
<li><p>注意这里的排他&#x2F;共享锁指的都是表锁，意向锁不会与行级的共享&#x2F;排他锁互斥。回到刚才teacher表的例子。事务A获取了某一行的排他锁，并未提交：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teacher <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时 teacher表存在两把锁： teacher表上的意向排他锁与id为6的数据行上的排他锁。事务B想要获取teacher表的共享锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">LOCK TABLES teacher READ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时事务B检测事务A持有teacher 表的意向排他锁，就可以得知事务A必然持有该表中某些数据行的排他锁，那么事务B对teacher表的加锁请求就会被排斥(阻塞)，而无需去检测表中的每一行数据是否存在排他锁</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>2.意向锁的并发性</strong></p>
<p>- </p>
<ul>
<li><p>意向锁不会与行级的共享&#x2F;排他锁互斥!正因为如此，意向锁并不会影响到多个事务对不同数据行加排他锁时的并发性。(不然直接用普通的表锁就行了)</p>
</li>
<li><p>扩展一下上面teacher表的例子来概括一下意向锁的作用（一条数据从被锁定到被释放的过程中，可能存在多种不同锁，但是这里只着重表现意向锁)</p>
</li>
<li><p>事务A先获取了某一行的排他锁，并未提交：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teacher <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">6</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事务A获取了teacher表上的意向排他锁，事务A获取了id为6的数据行上的排他锁。之后事务B想要获取teacher表的共享锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">LOCK TABLES teacher READ ;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事务B检测到事务A持有teacher表的意向排他锁。事务B对teacher表的加锁请求被阻塞(排斥)。最后事务C也想获取teacher表中某一行的排他锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> teacher <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">5</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>事务C申请teacher表的意向排他锁。事务c检测到事务A持有teacher表的意向排他锁。因为意向锁之间并不互斥，所以事务c获取到了teacher表的意向排他锁。因为id为5的数据行上不存在任何排他锁，最终事务C成功获取到了该数据行上的排他锁</p>
</li>
</ul>
</li>
<li><p><strong>从上面的案例可以得到如下结论：</strong></p>
<ul>
<li>1.InnoDB支持<strong>多粒度锁</strong>，特定场景下，行级锁可以与表级锁共存</li>
<li>2.意向锁之间互不排斥，但除了IS与S兼容外，<strong>意向锁会与共享锁&#x2F;排他锁互斥</strong></li>
<li>3.IX，IS是表级锁，不会和行级的X，S锁发生冲突。只会和表级的X，S发生冲突</li>
<li>4.意向锁在保证并发性的前提下，实现了<strong>行锁和表锁共存</strong>且<strong>满足事务隔离性</strong>的要求</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="③-自增锁（AUTO-INC锁）"><a href="#③-自增锁（AUTO-INC锁）" class="headerlink" title="③ 自增锁（AUTO-INC锁）"></a>③ 自增锁（AUTO-INC锁）</h5></blockquote>
<ul>
<li><p>在使用MySQL过程中，我们可以为表的某个列添加 <strong>AUTO_INCREMENT</strong> 属性。举例：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `teacher` (</span><br><span class="line">    `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由于这个表的id字段声明了AUTO_INCREMENT，意味着在书写插入语句时不需要为其赋值，SQL语句修改如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `teacher` (name) <span class="keyword">VALUES</span> (<span class="string">&#x27;zhangsan&#x27;</span>), (<span class="string">&#x27;lisi&#x27;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>上边的插入语句并没有为id列显式赋值，所以系统会自动为它赋上递增的值，结果如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teacher;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+----+----------+</span></span><br><span class="line"><span class="comment">| id | name |</span></span><br><span class="line"><span class="comment">+----+----------+</span></span><br><span class="line"><span class="comment">| 1 | zhangsan |</span></span><br><span class="line"><span class="comment">| 2 | lisi |</span></span><br><span class="line"><span class="comment">+----+----------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在看到的上面插入数据只是一种简单的插入模式，所有插入数据的方式总共分为三类，分别是“ <strong>Simple inserts</strong> ”，“ <strong>Bulk inserts</strong> ”和“ <strong>Mixed-mode inserts</strong> ”</p>
<ul>
<li><strong>“Simple inserts” （简单插入）</strong><br>可以 <strong>预先确定要插入的行数</strong> （当语句被初始处理时）的语句。包括没有嵌套子查询的单行和多行<strong>INSERT…VALUES()</strong> 和 <strong>REPLACE</strong> 语句。比如我们上面举的例子就属于该类插入，已经确定要插入的行数</li>
<li><strong>“Bulk inserts” （批量插入）</strong><br><strong>事先不知道要插入的行数</strong> （和所需自动递增值的数量）的语句。比如 <strong>INSERT … SELECT ， REPLACE</strong><br><strong>… SELECT</strong> 和 <strong>LOAD DATA</strong> 语句，但不包括纯INSERT。 InnoDB在每处理一行，为AUTO_INCREMENT列分配一个新值</li>
<li><strong>“Mixed-mode inserts” （混合模式插入）</strong><br>这些是“Simple inserts”语句但是指定部分新行的自动递增值。例如 <strong>INSERT INTO teacher (id,name) VALUES (1,‘a’), (NULL,‘b’), (5,‘c’), (NULL,‘d’);</strong> 只是指定了部分id的值。另一种类型的“混合模式插入”是 <strong>INSERT … ON DUPLICATE KEY UPDATE</strong></li>
</ul>
</li>
<li><p>对于上面数据插入的案例，MySQL中采用了<strong>自增锁</strong>的方式来实现，<strong>AUTO-INC锁是当向使用含有AUTO_INCREMENT列的表中插入数据时需要获取的一种特殊的表级锁</strong>，在执行插入语句时就在表级别加一个AUTO-INC锁，然后为每条待插入记录的AUTO_INCREMENT修饰的列分配递增的值，在该语句执行结束后，再把AUTO-INC锁释放掉。<strong>一个事务在持有AUTO-INC锁的过程中，其他事务的插入语句都要被阻塞</strong>，可以保证一个语句中分配的递增值是连续的。也正因为此，其并发性显然并不高，<strong>当向一个有AUTO_INCREMENT关键字的主键插入值的时候，每条语句都要对这个表锁进行竞争</strong>，这样的并发潜力其实是很低下的，所以innodb通过<strong>innodb_autoinc_lock_mode</strong>的不同取值来提供不同的锁定机制，来显著提高SQL语句的可伸缩性和性能</p>
</li>
<li><p>innodb_autoinc_lock_mode有三种取值，分别对应与不同锁定模式:</p>
<ul>
<li><p>(1) <strong>innodb_autoinc_lock_mode &#x3D; 0(“传统”锁定模式)</strong><br>在此锁定模式下，所有类型的insert语句都会获得一个特殊的表级AUTO-INC锁，用于插入具有AUTO_INCREMENT列的表。这种模式其实就如我们上面的例子，即每当执行insert的时候，都会得到一个表级锁(AUTO-INC锁)，使得语句中生成的auto_increment为顺序，且在binlog中重放的时候，可以保证master与slave中数据的auto_increment是相同的。因为是表级锁，当在同一时间多个事务中执行insert的时候，对于AUTO-INC锁的争夺会 <strong>限制并发</strong> 能力</p>
</li>
<li><p>（2) <strong>innodb_autoinc_lock_mode &#x3D; 1(“连续”锁定模式)</strong><br>在 MySQL 8.0 之前，连续锁定模式是<strong>默认</strong>的。在这个模式下，“bulk inserts”仍然使用AUTO-INC表级锁，并保持到语句结束。这适用于所有INSERT …SELECT，REPLACE … SELECT和LOAD DATA语句。同一时刻只有一个语句可以持有AUTO-INC锁</p>
<p>对于“Simple inserts”（要插入的行数事先已知），则通过在 <strong>mutex（轻量锁）</strong> 的控制下获得所需数量的自动递增值来避免表级AUTO-INC锁， 它只在分配过程的持续时间内保持，而不是直到语句完成。不使用表级AUTO-INC锁，除非AUTO-INC锁由另一个事务保持。如果另一个事务保持AUTO-INC锁，则“Simple inserts”等待AUTO-INC锁，如同它是一个“bulk inserts”</p>
</li>
<li><p>（3）<strong>innodb_autoinc_lock_mode &#x3D; 2(“交错”锁定模式)</strong><br>在这种锁定模式下，所有类INSERT语句都不会使用表级AUTO-INC锁，并且可以同时执行多个语句。这是最快和最可扩展的锁定模式，但是当使用基于语句的复制或恢复方案时，<strong>从二进制日志重播SQL语句时，这是不安全的</strong><br>在此锁定模式下，自动递增值<strong>保证</strong>在所有并发执行的所有类型的insert语句中是<strong>唯一</strong>且<strong>单调递增</strong>的。但是，由于多个语句可以同时生成数字(即，跨语句交叉编号），<strong>为任何给定语句插入的行生成的值可能不是连续的</strong><br>如果执行的语句是”simple inserts”，其中要插入的行数已提前知道，除了“Mixed-mode inserts”之外，为单个语句生成的数字不会有间隙。然而，当执行“bulk inserts”时，在由任何给定语句分配的自动递增值中可能存在间隙</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="④-元数据锁（MDL锁）"><a href="#④-元数据锁（MDL锁）" class="headerlink" title="④ 元数据锁（MDL锁）"></a>④ 元数据锁（MDL锁）</h5></blockquote>
<ul>
<li><p>MySQL5.5引入了<strong>meta data lock</strong>，简称MDL锁，属于表锁范畴。MDL的作用是，保证读写的正确性。比如，如果一个查询正在遍历一个表中的数据，而执行期间另一个线程对这个<strong>表结构做变更</strong>，增加了一列，那么查询线程拿到的结果跟表结构对不上，肯定是不行的</p>
</li>
<li><p>因此，<strong>当对一个表做增删改查操作的时候，加MDL读锁;当要对表做结构变更操作的时候，加MDL写锁</strong></p>
</li>
<li><p>读锁之间不互斥，因此可以有多个线程同时对一张表增删改查。读写锁之间、写锁之间是互斥的，用来保证变更表结构操作的安全性，解决了DML和DDL操作之间的一致性问题。<strong>不需要显式使用</strong>，在访问一个表的时候会被自动加上</p>
</li>
<li><p><strong>举例：元数据锁的使用场景模拟</strong></p>
<ul>
<li><p><strong>会话A：</strong>从表中查询数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> teacher;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>会话B：</strong>修改表结构，增加新列</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>；</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> teacher <span class="keyword">add</span> age <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>；</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>会话C：</strong>查看当前MySQL的进程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> processlist；</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过会话C可以看出会话B被阻塞，这是由于会话A拿到了teacher表的元数据读锁，会话B想申请teacher表的元数据写锁，由于<strong>读写锁互斥</strong>，会话B需要等待会话A释放元数据锁才能执行</p>
</li>
</ul>
</li>
<li><p>元数据锁可能带来的问题</p>
<table>
<thead>
<tr>
<th>Session A</th>
<th>Session B</th>
<th>Session C</th>
</tr>
</thead>
<tbody><tr>
<td>begin;select * from teacher;</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>alter table teacher add age int;</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>select * from teacher;</td>
</tr>
</tbody></table>
</li>
<li><p>可以看到session A会对表teacher加一个MDL读锁，之后session B要加MDL写锁会被blocked，因为session A的MDL读锁还没有释放，而session C要在表teacher上新申请MDL读锁的请求也会被session B 阻塞。前面说了，所有对表的增删改查操作都需要先申请MDL读锁，就都被阻塞，等于这个表现在完全不可读写了</p>
</li>
</ul>
<h5 id="8-3-3-2-2-InnoDB中的行锁"><a href="#8-3-3-2-2-InnoDB中的行锁" class="headerlink" title="8.3.3.2.2 InnoDB中的行锁"></a>8.3.3.2.2 InnoDB中的行锁</h5><ul>
<li><p>行锁(Row Lock)也称为记录锁，顾名思义，就是锁住某一行（某条记录row)。需要的注意的是，MySQL服务器层并没有实现行锁机制，<strong>行级锁只在存储引擎层实现</strong></p>
</li>
<li><p><strong>优点：</strong>锁定力度小，发生<strong>锁冲突概率低</strong>，可以实现的<strong>并发度高</strong></p>
</li>
<li><p><strong>缺点：</strong>对于<strong>锁的开销比较大</strong>，加锁会比较慢，容易出现<strong>死锁</strong>情况</p>
</li>
<li><p>InnoDB与MylSAM的最大不同有两点：一是支持事务(TRANSACTION)；二是采用了行级锁</p>
</li>
<li><p>首先创建表如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> student (</span><br><span class="line">    id <span class="type">INT</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">    class <span class="type">varchar</span> (<span class="number">10</span>) ,<span class="keyword">PRIMARY</span> KEY (id)</span><br><span class="line">)Engine<span class="operator">=</span>InnoDB CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>向这个表里插入几条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>,<span class="string">&#x27;张三&#x27;</span> ,<span class="string">&#x27;一班&#x27;</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;李四&#x27;</span> ,<span class="string">&#x27;一班&#x27;</span>),</span><br><span class="line">( <span class="number">8</span>,<span class="string">&#x27;王五&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>),</span><br><span class="line">( <span class="number">15</span>,<span class="string">&#x27;赵六&#x27;</span>,<span class="string">&#x27;二班&#x27;</span>),</span><br><span class="line">(<span class="number">20</span>, <span class="string">&#x27;钱七&#x27;</span>,<span class="string">&#x27;三班&#x27;</span>);</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span><span class="keyword">FROM</span> student;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">+----+--------+--------+</span></span><br><span class="line"><span class="comment">| id | name   | class  |</span></span><br><span class="line"><span class="comment">+----+--------+--------+</span></span><br><span class="line"><span class="comment">|  1 | 张三   | 一班   |</span></span><br><span class="line"><span class="comment">|  3 | 李四   | 一班   |</span></span><br><span class="line"><span class="comment">|  8 | 王五   | 二班   |</span></span><br><span class="line"><span class="comment">| 15 | 赵六   | 二班   |</span></span><br><span class="line"><span class="comment">| 20 | 钱七   | 三班   |</span></span><br><span class="line"><span class="comment">+----+--------+--------+</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>student表中的聚簇索引的简图如下所示：</p>
<p><img src="image-20221213153354537.png" alt="MySQL之性能优化/image-20221213153354537"></p>
</li>
</ul>
<blockquote>
<h5 id="①-记录锁（Record-Locks）"><a href="#①-记录锁（Record-Locks）" class="headerlink" title="① 记录锁（Record Locks）"></a>① 记录锁（Record Locks）</h5></blockquote>
<ul>
<li><p>记录锁也就是仅仅把一条记录锁上，官方的类型名称为： <strong>LOCK_REC_NOT_GAP</strong> 。比如把id值为8的那条记录加一个记录锁的示意图如图所示。仅仅是锁住了id值为8的记录，对周围的数据没有影响</p>
<p><img src="image-20221213145238246.png" alt="MySQL之性能优化/image-20221213145238246"></p>
</li>
<li><p>举例如下：</p>
<p><img src="image-20221213145636771.png" alt="MySQL之性能优化/image-20221213145636771"></p>
</li>
<li><p>记录锁是有S锁和X锁之分的，称之为 <strong>S型记录锁</strong> 和 <strong>X型记录锁</strong> </p>
<ul>
<li>当一个事务获取了一条记录的S型记录锁后，其他事务也可以继续获取该记录的S型记录锁，但不可以继续获取X型记录锁</li>
<li>当一个事务获取了一条记录的X型记录锁后，其他事务既不可以继续获取该记录的S型记录锁，也不可以继续获取X型记录锁</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="②-间隙锁（Gap-Locks）"><a href="#②-间隙锁（Gap-Locks）" class="headerlink" title="② 间隙锁（Gap Locks）"></a>② 间隙锁（Gap Locks）</h5></blockquote>
<ul>
<li><p><strong>MySQL</strong> 在 <strong>REPEATABLE READ</strong> 隔离级别下是可以解决幻读问题的，解决方案有两种，可以使用 <strong>MVCC</strong> 方案解决，也可以采用 <strong>加锁</strong> 方案解决。但是在使用加锁方案解决时有个大问题，就是事务在第一次执行读取操作时，那些幻影记录尚不存在，我们无法给这些 <strong>幻影记录</strong> 加上 <strong>记录锁</strong> 。InnoDB提出了一种称之为<strong>Gap Locks</strong> 的锁，官方的类型名称为： <strong>LOCK_GAP</strong> ，我们可以简称为 <strong>gap锁</strong> 。比如，把id值为8的那条记录加一个gap锁的示意图如下：</p>
<p><img src="image-20221213145758290.png" alt="MySQL之性能优化/image-20221213145758290"></p>
</li>
<li><p>图中id值为8的记录加了gap锁，意味着 <strong>不允许别的事务在id值为8的记录前边的间隙插入新记录</strong> ，其实就是id列的值(3, 8)这个区间的新记录是不允许立即插入的。比如，有另外一个事务再想插入一条id值为4的新记录，它定位到该条新记录的下一条记录的id值为8，而这条记录上又有一个gap锁，所以就会阻塞插入操作，直到拥有这个gap锁的事务提交了之后，id列的值在区间(3, 8)中的新记录才可以被插入</p>
</li>
<li><p><strong>gap锁的提出仅仅是为了防止插入幻影记录而提出的</strong>。虽然有<strong>共享gap锁</strong>和<strong>独占gap</strong>锁这样的说法，但是它们起到的作用是相同的。而且如果对一条记录加了gap锁〈不论是共享gap锁还是独占gap锁)，并不会限制其他事务对这条记录加记录锁或者继续加gap锁</p>
</li>
<li><p><strong>举例：</strong></p>
<table>
<thead>
<tr>
<th>Session1</th>
<th>Session2</th>
</tr>
</thead>
<tbody><tr>
<td>select * from student where id &#x3D; 5 lock in share mode;</td>
<td></td>
</tr>
<tr>
<td></td>
<td>select * from student where id &#x3D; 5 for update;</td>
</tr>
</tbody></table>
</li>
<li><p>这里session 2并不会被堵住。因为表里并没有id&#x3D;5这个记录，因此 session 1加的是间隙锁（3,8)。而session 2也是在这个间隙加的间隙锁。它们有共同的目标，即：保护这个间隙，不允许插入值。但，它们之间是不冲突的</p>
</li>
<li><p>注意，给一条记录加了gap锁只是不允许其他事务往这条记录前边的间隙插入新记录，那对于最后一条记录之后的间隙，也就是student 表中id值为<strong>20</strong>的记录之后的间隙该咋办呢?也就是说给哪条记录加<strong>gap锁</strong>才能阻止其他事务插入<strong>id</strong>值在(**20，正无穷)**这个区间的新记录呢?这时候我们在讲数据页时介绍的两条伪记录派上用场了：</p>
<ul>
<li><strong>Infimum</strong>记录，表示该页面中最小的记录</li>
<li><strong>Supremum</strong>记录，表示该页面中最大的记录</li>
</ul>
</li>
<li><p>为了实现阻止其他事务插入id值在(20, 正无穷)这个区间的新记录，可以给索引中的最后一条记录，也就是id值为20的那条记录所在页面的Supremum记录加上一个gap锁，如图所示：</p>
<p><img src="image-20221213155727207.png" alt="MySQL之性能优化/image-20221213155727207"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&gt;</span><span class="number">20</span> lock <span class="keyword">in</span> share mode ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>检测：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_locks\G</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样就可以阻止其他事务插入id值在(20,正无穷)这个区间的新记录</p>
</li>
<li><p>间隙锁的引入，可能会导致同样的语句锁住更大的范围，这其实是影响了并发度的。下面的例子会产生<strong>死锁</strong>：</p>
<ul>
<li>(1) session 1执行select …for update语句，由于id &#x3D; 5这一行并不存在，因此会加上间隙锁(3，8)</li>
<li>(2) session2执行select … for update语句，同样会加上间隙锁（3，8)，间隙锁之间不会冲突，因此这个语句可以执行成功</li>
<li>(3) session 2试图插入一行(5, ‘宋红康’, ‘二班’)，被session 1的间隙锁挡住了，只好进入<strong>等待</strong></li>
<li>(4) session 1试图插入一行(5. 宋红康’二班)，被 session2的间隙锁挡住了。至此，两个session陷入<strong>死锁</strong></li>
</ul>
<table>
<thead>
<tr>
<th>Session1</th>
<th>Session2</th>
</tr>
</thead>
<tbody><tr>
<td>begin; select *from student where id &#x3D; 5 for update;</td>
<td>begin;select * from student where id &#x3D; 5 for update;</td>
</tr>
<tr>
<td></td>
<td>INSERT INTO student VALUES(5,’宋红康,‘二班’);阻塞</td>
</tr>
<tr>
<td>INSERTINTO student VALUES(5,‘宋红康’,‘二班’);(ERROR 1213(40001):Deadlock found when trying to get lock; try restarting transaction)</td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<h5 id="③-临键锁（Next-Key-Locks）"><a href="#③-临键锁（Next-Key-Locks）" class="headerlink" title="③ 临键锁（Next-Key Locks）"></a>③ 临键锁（Next-Key Locks）</h5></blockquote>
<ul>
<li><p>有时候既想 <strong>锁住某条记录</strong> ，又想 <strong>阻止</strong> 其他事务在该记录前边的 <strong>间隙插入新记录</strong> ，所以InnoDB就提出了一种称之为 <strong>Next-Key Locks</strong> 的锁，官方的类型名称为： <strong>LOCK_ORDINARY</strong> ，我们也可以简称为<strong>next-key锁</strong></p>
</li>
<li><p>Next-Key Locks是在存储引擎 <strong>innodb</strong> 、事务级别在 <strong>可重复读</strong> 的情况下使用的数据库锁，innodb默认的锁就是Next-Key locks</p>
</li>
<li><p>比如，把id值为8的那条记录加一个next-key锁的示意图如下：</p>
<p><img src="image-20221213160505504.png" alt="MySQL之性能优化/image-20221213160505504"></p>
</li>
<li><p><strong>next-key锁</strong>的本质就是一个<strong>记录锁</strong>和一个<strong>gap锁</strong>的合体，它既能保护该条记录，又能阻止别的事务将新记录插入被保护记录前边的<strong>间隙</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&lt;=</span><span class="number">8</span> <span class="keyword">and</span> id <span class="operator">&gt;</span> <span class="number">3</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
<blockquote>
<h5 id="④-插入意向锁（Insert-Intention-Locks）"><a href="#④-插入意向锁（Insert-Intention-Locks）" class="headerlink" title="④ 插入意向锁（Insert Intention Locks）"></a>④ 插入意向锁（Insert Intention Locks）</h5></blockquote>
<ul>
<li><p>说一个事务在 <strong>插入</strong> 一条记录时需要判断一下插入位置是不是被别的事务加了 <strong>gap锁</strong> （ <strong>next-key锁</strong>也包含 gap锁 ），如果有的话，插入操作需要等待，直到拥有 <strong>gap锁</strong> 的那个事务提交。但是<strong>InnoDB规定事务在等待的时候也需要在内存中生成一个锁结构</strong>，表明有事务想在某个 <strong>间隙</strong> 中 <strong>插入</strong> 新记录，但是现在在等待。InnoDB就把这种类型的锁命名为 <strong>Insert Intention Locks</strong> ，官方的类型名称为：<strong>LOCK_INSERT_INTENTION</strong> ，我们称为 <strong>插入意向锁</strong> 。插入意向锁是一种 <strong>Gap锁</strong> ，不是意向锁，在insert操作时产生</p>
</li>
<li><p>插入意向锁是在插入一条记录行前，<strong>由 INSERT 操作产生的一种间隙锁</strong></p>
</li>
<li><p>事实上插入意向锁并不会阻止别的事务继续获取该记录上任何类型的锁</p>
</li>
<li><p>插入意向锁是在插入一条记录行前，由INSERT 操作产生的一种间隙锁。该锁用以表示插入意向，当多个事务在同一区间(gap）插入位置不同的多条数据时，事务之间不需要互相等待。假设存在两条值分别为4和7的记录，两个不同的事务分别试图插入值为5和6的两条记录，每个事务在获取插入行上独占的(排他）锁前，都会获取(4，7）之间的间隙锁，但是因为数据行之间并<strong>不冲突</strong>，所以两个事务之间并不会产生冲突（阻塞等待)。总结来说，插入意向锁的特性可以分成两部分：</p>
<ul>
<li>(1）插入意向锁是一种<strong>特殊的间隙锁</strong>―—间隙锁可以锁定开区间内的部分记录</li>
<li>(2）插入意向锁之间<strong>互不排斥</strong>，所以即使多个事务在同一区间插入多条记录，只要记录本身(主键、唯一索引)不冲突，那么事务之间就不会出现冲突等待</li>
</ul>
</li>
<li><p>注意，虽然插入意向锁中含有意向锁三个字，但是它并不属于意向锁而属于间隙锁，因为意向锁是表锁而插入意向锁是<strong>行锁</strong></p>
</li>
<li><p>比如，把id值为8的那条记录加一个插入意向锁的示意图如下：</p>
<p><img src="image-20221213162123516.png" alt="MySQL之性能优化/image-20221213162123516"></p>
</li>
<li><p>比如，现在T1为id值为8的记录加了一个gap锁，然后T2和T3分别想向student表中插入id值分别为4、5的两条记录，所以现在为id值为8的记录加的锁的示意图就如下所示：</p>
<p><img src="image-20221213162050744.png" alt="MySQL之性能优化/image-20221213162050744"></p>
</li>
<li><p>从图中可以看到，由于T1持有gap锁，所以T2和T3需要生成一个插入意向锁的锁结构并且处于等待状态。当T1提交后会把它获取到的锁都释放掉，这样T2和T3就能获取到对应的插入意向锁了(本质上就是把插入意向锁对应锁结构的is_waiting属性改为false)，T2和T3之间也并不会相互阻塞，它们可以同时获取到id值为8的插入意向锁，然后执行插入操作。<strong>事实上插入意向锁并不会阻止别的事务继续获取该记录上任何类型的锁</strong></p>
</li>
</ul>
<h5 id="8-3-3-2-3-页锁"><a href="#8-3-3-2-3-页锁" class="headerlink" title="8.3.3.2.3 页锁"></a>8.3.3.2.3 页锁</h5><ul>
<li>页锁就是在<strong>页的粒度</strong>上进行锁定，锁定的数据资源比行锁要多，因为一个页中可以有多个行记录。当使用页锁的时候，会出现数据浪费的现象，但这样的浪费最多也就是一个页上的数据行。<strong>页锁的开销介于表锁和行锁之间，会出现死锁。锁定粒度介于表锁和行锁之间，并发度一般</strong></li>
<li>每个层级的锁数量是有限制的，因为锁会占用内存空间， <strong>锁空间的大小是有限的</strong> 。当某个层级的锁数量超过了这个层级的阈值时，就会进行<strong>锁升级</strong>。锁升级就是用更大粒度的锁替代多个更小粒度的锁，比如InnoDB 中行锁升级为表锁，这样做的好处是占用的锁空间降低了，但同时数据的并发度也下降了</li>
</ul>
<h4 id="8-3-3-3-从对待锁的态度划分-乐观锁、悲观锁"><a href="#8-3-3-3-从对待锁的态度划分-乐观锁、悲观锁" class="headerlink" title="8.3.3.3 从对待锁的态度划分:乐观锁、悲观锁"></a>8.3.3.3 从对待锁的态度划分:乐观锁、悲观锁</h4><ul>
<li>从对待锁的态度来看锁的话，可以将锁分成乐观锁和悲观锁，从名字中也可以看出这两种锁是两种看待<strong>数据并发的思维方式</strong> 。需要注意的是，乐观锁和悲观锁并不是锁，而是锁的 <strong>设计思想</strong></li>
</ul>
<blockquote>
<h5 id="1-悲观锁（Pessimistic-Locking）"><a href="#1-悲观锁（Pessimistic-Locking）" class="headerlink" title="1. 悲观锁（Pessimistic Locking）"></a>1. 悲观锁（Pessimistic Locking）</h5></blockquote>
<ul>
<li><p>悲观锁是一种思想，顾名思义，就是很悲观，对数据被其他事务的修改持保守态度，会通过数据库自身的锁机制来实现，从而保证数据操作的排它性</p>
</li>
<li><p>悲观锁总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会 <strong>阻塞</strong> 直到它拿到锁（<strong>共享资源每次只给一个线程使用，其它线程阻塞，用完后再把资源转让给其它线程</strong>）。比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁，当其他线程想要访问数据时，都需要阻塞挂起。Java中 <strong>synchronized</strong> 和 <strong>ReentrantLock</strong> 等独占锁就是悲观锁思想的实现。</p>
</li>
<li><p><strong>秒杀案例1：</strong><br>商品秒杀过程中，库存数量的减少，避免出现<strong>超卖</strong>的情况。比如，商品表中有一个字段为quantity表示当前该商品的库存量。假设商品为华为mate40，id为1001，quantity&#x3D;100个。如果不使用锁的情况下，操作方法如下所示：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#第<span class="number">1</span>步:查出商品库存</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> ;</span><br><span class="line">#第<span class="number">2</span>步:如果库存大于<span class="number">0</span>，则根据商品信息生产订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders (item_id）<span class="keyword">values</span> ( <span class="number">1001</span> ) ;</span><br><span class="line">#第<span class="number">3</span>步:修改商品的库存，num表示购买数量</span><br><span class="line"><span class="keyword">update</span> items <span class="keyword">set</span> quantity <span class="operator">=</span> quantity<span class="operator">-</span>num <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> ;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这样写的话，在并发量小的公司没有大的问题，但是如果在<strong>高并发环境</strong>下可能出现以下问题</p>
<table>
<thead>
<tr>
<th>线程A</th>
<th>线程B</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>step1(查询还有100部手机)</td>
<td>step1(查询还有100部手机)</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>step2(生成订单)</td>
</tr>
<tr>
<td>3</td>
<td>step2(生成订单)</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>step3(减库存1)</td>
</tr>
<tr>
<td>5</td>
<td>step3(减库存2)</td>
<td>.</td>
</tr>
</tbody></table>
</li>
<li><p>其中线程B此时已经下单并且减完库存，这个时候线程A依然去执行step3，就造成了超卖</p>
</li>
<li><p>使用悲观锁可以解决这个问题，商品信息从查询出来到修改，中间有一个生成订单的过程，使用悲观锁的原理就是，在查询items信息后就把当前的数据锁定，直到修改完毕后再解锁。那么整个过程中，因为数据被锁定了，就不会出现有第三者来对其进行修改了。而这样做的前提是<strong>需要将要执行的SQL语句放在同一个事务中，否则达不到锁定数据行的目的</strong></p>
</li>
<li><p>修改如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#第<span class="number">1</span>步:查出商品库存</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> <span class="keyword">for</span> <span class="keyword">update</span>;</span><br><span class="line">#第<span class="number">2</span>步:如果库存大于<span class="number">0</span>，则根据商品信息生产订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders (item_id)<span class="keyword">values</span>(<span class="number">1001</span>);</span><br><span class="line">#第<span class="number">3</span>步:修改商品的库存，num表示购买数量</span><br><span class="line"><span class="keyword">update</span> items <span class="keyword">set</span> quantity <span class="operator">=</span> quantity<span class="operator">-</span>num <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> ;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>select … for update</strong>是MySQL中悲观锁。 此时在items表中，id为1001的那条数据就被锁定了，其他的要执行select quantity from items where id &#x3D; 1001 for update;语句的事务必须等本次事务提交之后才能执行。这样可以保证当前的数据不会被其它事务修改</p>
</li>
<li><p>注意，当执行select quantity from items where id &#x3D; 1001 for update;语句之后，如果在其他事务中执行select quantity from items where id &#x3D; 1001;语句，并不会受第一个事务的影响，仍然可以正常查询出数据</p>
</li>
<li><p><strong>注意：</strong></p>
<ul>
<li><p><strong>select … for update语句执行过程中所有扫描的行都会被锁上，因此在MySQL中用悲观锁必须确定使用了索引，而不是全表扫描，否则将会把整个表锁住</strong></p>
</li>
<li><p>悲观锁不适用的场景较多，它存在一些不足，因为悲观锁大多数情况下依靠数据库的锁机制来实现，以保证程序的并发访问性，同时这样对数据库性能开销影响也很大，特别是<strong>长事务</strong>而言，这样的<strong>开销往往无法承受</strong>，这时就需要乐观锁</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="2-乐观锁（Optimistic-Locking）"><a href="#2-乐观锁（Optimistic-Locking）" class="headerlink" title="2. 乐观锁（Optimistic Locking）"></a>2. 乐观锁（Optimistic Locking）</h5></blockquote>
<ul>
<li><p>乐观锁认为对同一数据的并发操作不会总发生，属于小概率事件，不用每次都对数据上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，也就是<strong>不采用数据库自身的锁机制，而是通过程序来实现</strong>。在程序上，可以采用 <strong>版本号机制</strong> 或者 <strong>CAS机制</strong> 实现。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。在Java中<strong>java.util.concurrent.atomic</strong> 包下的原子变量类就是使用了乐观锁的一种实现方式：CAS实现的</p>
</li>
<li><p><strong>1. 乐观锁的版本号机制</strong><br>在表中设计一个 <strong>版本字段 version</strong> ，第一次读的时候，会获取 version 字段的取值。然后对数据进行更新或删除操作时，会执行 <strong>UPDATE … SET version&#x3D;version+1 WHERE version&#x3D;version</strong> 。此时如果已经有事务对这条数据进行了更改，修改就不会成功</p>
<p>这种方式类似我们熟悉的SVN、CVS版本管理系统，当修改了代码进行提交时，首先会检查当前版本号与服务器上的版本号是否一致，如果一致就可以直接提交，如果不一致就需要更新服务器上的最新代码，然后再进行提交</p>
</li>
<li><p><strong>⒉.乐观锁的时间戳机制</strong><br>时间戳和版本号机制一样，也是在更新提交的时候，将当前数据的时间戳和更新之前取得的时间戳进行比较，如果两者一致则更新成功，否则就是版本冲突</p>
<p>能看到乐观锁就是程序员自己控制数据并发操作的权限，基本是通过给数据行增加一个戳(版本号或者时间戳)，从而证明当前拿到的数据是否最新</p>
</li>
<li><p><strong>秒杀案例2：</strong></p>
<ul>
<li>依然使用上面秒杀的案例，执行流程如下：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#第<span class="number">1</span>步:查出商品库存</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span>;</span><br><span class="line">#第<span class="number">2</span>步:如果库存大于<span class="number">0</span>，则根据商品信息生产订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders (item_id）<span class="keyword">values</span> ( <span class="number">1001</span>);</span><br><span class="line">#第<span class="number">3</span>步:修改商品的库存,num表示购买数量</span><br><span class="line"><span class="keyword">update</span> items <span class="keyword">set</span> quantity <span class="operator">=</span> quantity<span class="operator">-</span>num , version <span class="operator">=</span> version<span class="operator">+</span><span class="number">1</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> <span class="keyword">and</span> version <span class="operator">=</span> #&#123;version&#125; ;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>注意，如果数据表是<strong>读写分离</strong>的表，当matser表中写入的数据没有及时同步到slave表中时，会造成更新一直失败的问题。此时需要<strong>强制读取master表</strong>中的数据（即将select语句放到事务中即可，这时候查询的就是master主库了)</p>
</li>
<li><p>如果对同一条数据进行<strong>频繁的修改</strong>的话，那么就会出现这么一种场景，每次修改都只有一个事务能更新成功，在业务感知上面就有大量的失败操作。把代码修改如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#第<span class="number">1</span>步:查出商品库存</span><br><span class="line"><span class="keyword">select</span> quantity <span class="keyword">from</span> items <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span>;</span><br><span class="line">#第<span class="number">2</span>步:如果库存大于<span class="number">0</span>，则根据商品信息生产订单</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> orders (item_id)<span class="keyword">values</span>( <span class="number">1001</span> );</span><br><span class="line">#第<span class="number">3</span>步:修改商品的库存，num表示购买数量</span><br><span class="line"><span class="keyword">update</span> items <span class="keyword">set</span> quantity <span class="operator">=</span> quantity<span class="operator">-</span>num <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1001</span> <span class="keyword">and</span> quantity<span class="operator">-</span>num<span class="operator">&gt;</span><span class="number">6</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样就会使每次修改都能成功，而且不会出现超卖的现象</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="3-两种锁的适用场景"><a href="#3-两种锁的适用场景" class="headerlink" title="3. 两种锁的适用场景"></a>3. 两种锁的适用场景</h5></blockquote>
<ul>
<li><p>从这两种锁的设计思想中，总结一下乐观锁和悲观锁的适用场景：</p>
<ul>
<li><strong>乐观锁</strong> 适合 <strong>读操作多</strong> 的场景，相对来说写的操作比较少。它的优点在于 <strong>程序实现 ， 不存在死锁</strong>问题，不过适用场景也会相对乐观，因为它阻止不了除了程序以外的数据库操作</li>
<li><strong>悲观锁</strong> 适合 <strong>写操作多</strong> 的场景，因为写的操作具有 <strong>排它性</strong> 。采用悲观锁的方式，可以在数据库层面阻止其他事务对该数据的操作权限，防止 <strong>读 - 写</strong> 和 <strong>写 - 写</strong> 的冲突</li>
</ul>
</li>
<li><p>把乐观锁和悲观锁总结如下图所示：</p>
<p><img src="image-20221213165716908.png" alt="MySQL之性能优化/image-20221213165716908"></p>
</li>
</ul>
<h4 id="8-3-3-4-按加锁的方式划分：显式锁、隐式锁"><a href="#8-3-3-4-按加锁的方式划分：显式锁、隐式锁" class="headerlink" title="8.3.3.4 按加锁的方式划分：显式锁、隐式锁"></a>8.3.3.4 按加锁的方式划分：显式锁、隐式锁</h4><blockquote>
<h4 id="1-隐式锁"><a href="#1-隐式锁" class="headerlink" title="1.隐式锁"></a>1.隐式锁</h4></blockquote>
<ul>
<li><p>一个事务在执行<strong>INSERT</strong>操作时，如果即将插入的<strong>间隙</strong>已经被其他事务加了<strong>gap锁</strong>，那么本次<strong>INSERT</strong>操作会阻塞，并且当前事务会在该间隙上加一个<strong>插入意向锁</strong>，否则一般情况下<strong>INSERT</strong>操作是不加锁的。那如果一个事务首先插入了一条记录（此时并没有在内存生产与该记录关联的锁结构)，然后另一个事务:</p>
<ul>
<li>立即使用<strong>SELECT … LOCK IN SHARE MODE</strong>语句读取这条记录，也就是要获取这条记录的<strong>S锁</strong>，或者使用<strong>SELECT… FOR UPDATE</strong>语句读取这条记录，也就是要获取这条记录的<strong>X锁</strong>，怎么办?<br>如果允许这种情况的发生，那么可能产生<strong>脏读</strong>问题</li>
<li>立即修改这条记录，也就是要获取这条记录的<strong>x锁</strong>，怎么办?<br>如果允许这种情况的发生，那么可能产生<strong>脏写</strong>问题</li>
</ul>
</li>
<li><p>这时候前边提过的<strong>事务id</strong>又要起作用了。把聚簇索引和二级索引中的记录分开看一下：</p>
</li>
<li><p><strong>情景一：</strong>对于聚簇索引记录来说，有一个 <strong>trx_id</strong> 隐藏列，该隐藏列记录着最后改动该记录的 <strong>事务id</strong> 。那么如果在当前事务中新插入一条聚簇索引记录后，该记录的 <strong>trx_id</strong> 隐藏列代表的的就是当前事务的 <strong>事务id</strong> ，如果其他事务此时想对该记录添加 <strong>S锁</strong> 或者 <strong>X锁</strong> 时，首先会看一下该记录的<strong>trx_id</strong> 隐藏列代表的事务是否是当前的活跃事务，如果是的话，那么就帮助当前事务创建一个 <strong>X锁</strong> （也就是为当前事务创建一个锁结构， <strong>is_waiting</strong> 属性是 <strong>false</strong> ），然后自己进入等待状态（也就是为自己也创建一个锁结构， <strong>is_waiting</strong> 属性是 <strong>true</strong> ）</p>
</li>
<li><p><strong>情景二：</strong>对于二级索引记录来说，本身并没有 <strong>trx_id</strong> 隐藏列，但是在二级索引页面的 <strong>Page Header</strong> 部分有一个 <strong>PAGE_MAX_TRX_ID</strong> 属性，该属性代表对该页面做改动的最大的 <strong>事务id</strong> ，如果 <strong>PAGE_MAX_TRX_ID</strong> 属性值小于当前最小的活跃 <strong>事务id</strong> ，那么说明对该页面做修改的事务都已经提交了，否则就需要在页面中定位到对应的二级索引记录，然后回表找到它对应的聚簇索引记录，然后再重复 <strong>情景一</strong> 的做法</p>
</li>
<li><p>即：一个事务对新插入的记录可以不显式的加锁（生成一个锁结构），但是由于<strong>事务id</strong>的存在，相当于加了一个<strong>隐式锁</strong>。别的事务在对这条记录加<strong>S锁</strong>或者<strong>X锁</strong>时，由于<strong>隐式锁</strong>的存在，会先帮助当前事务生成一个锁结构，然后自己再生成一个锁结构后进入等待状态。隐式锁是一种<strong>延迟加锁</strong>的机制，从而减少加锁的数量</p>
</li>
<li><p>隐式锁在实际内存对象中并不含有这个锁信息。只有当产生锁等待时，隐式锁转化为显式锁</p>
</li>
<li><p>InnoDB的insert操作，对插入的记录不加锁，但是此时如果另一个线程进行当前读，类似以下的用例，session 2会锁等待session 1，那么这是如何实现的呢?</p>
<ul>
<li><p><strong>session 1：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> ;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">INTO</span> student <span class="keyword">VALUES</span>(<span class="number">34</span>,&quot;周八”,&quot;二班&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>session 2：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student lock <span class="keyword">in</span> share mode;#执行完，当前事务被阻塞</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>执行下述语句，输出结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> performance_schema.data_lock_waits\G;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">SELECT * FROM performance_schema.data_lock_waits\G;</span></span><br><span class="line"><span class="comment">*************************** 1. row ***************************</span></span><br><span class="line"><span class="comment">ENGINE: INNODB</span></span><br><span class="line"><span class="comment">REQUESTING_ENGINE_LOCK_ID: 140562531358232:7:4:9:140562535668584</span></span><br><span class="line"><span class="comment">REQUESTING_ENGINE_TRANSACTION_ID: 422037508068888</span></span><br><span class="line"><span class="comment">REQUESTING_THREAD_ID: 64</span></span><br><span class="line"><span class="comment">REQUESTING_EVENT_ID: 6</span></span><br><span class="line"><span class="comment">REQUESTING_OBJECT_INSTANCE_BEGIN: 140562535668584</span></span><br><span class="line"><span class="comment">BLOCKING_ENGINE_LOCK_ID: 140562531351768:7:4:9:140562535619104</span></span><br><span class="line"><span class="comment">BLOCKING_ENGINE_TRANSACTION_ID: 15902</span></span><br><span class="line"><span class="comment">BLOCKING_THREAD_ID: 64</span></span><br><span class="line"><span class="comment">BLOCKING_EVENT_ID: 6</span></span><br><span class="line"><span class="comment">BLOCKING_OBJECT_INSTANCE_BEGIN: 140562535619104</span></span><br><span class="line"><span class="comment">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>隐式锁的逻辑过程如下：<br>A. InnoDB的每条记录中都一个隐含的trx_id字段，这个字段存在于聚簇索引的B+Tree中<br>B. 在操作一条记录前，首先根据记录中的trx_id检查该事务是否是活动的事务(未提交或回滚)。如果是活动的事务，首先将 <strong>隐式锁</strong> 转换为 <strong>显式锁</strong> (就是为该事务添加一个锁)<br>C. 检查是否有锁冲突，如果有冲突，创建锁，并设置为waiting状态。如果没有冲突不加锁，跳到E<br>D. 等待加锁成功，被唤醒，或者超时<br>E. 写数据，并将自己的trx_id写入trx_id字段</p>
</li>
</ul>
<blockquote>
<h4 id="2-显式锁"><a href="#2-显式锁" class="headerlink" title="2.显式锁"></a>2.显式锁</h4></blockquote>
<ul>
<li><p>通过特定的语句进行加锁，一般称之为显示加锁，例如：<br>显示加共享锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ....lock <span class="keyword">in</span> share mode</span><br></pre></td></tr></table></figure>

<p>显示加排它锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> ....<span class="keyword">for</span> <span class="keyword">update</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-3-3-5-其它锁之：全局锁"><a href="#8-3-3-5-其它锁之：全局锁" class="headerlink" title="8.3.3.5 其它锁之：全局锁"></a>8.3.3.5 其它锁之：全局锁</h4><ul>
<li><p>全局锁就是对<strong>整个数据库实例</strong>加锁。当你需要让整个库处于<strong>只读状态</strong>的时候，可以使用这个命令，之后其他线程的以下语句会被阻塞:数据更新语句(数据的增删改)、数据定义语句（包括建表、修改表结构等）和更新类事务的提交语句。全局锁的典型使用<strong>场景</strong>是：做<strong>全库逻辑备份</strong></p>
</li>
<li><p>全局锁的命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flush tables <span class="keyword">with</span> read lock</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="8-3-3-6-其它锁之：死锁"><a href="#8-3-3-6-其它锁之：死锁" class="headerlink" title="8.3.3.6 其它锁之：死锁"></a>8.3.3.6 其它锁之：死锁</h4><blockquote>
<h5 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h5></blockquote>
<ul>
<li><p>死锁是指两个或多个事务在同一资源上相互占用，并请求锁定对方占用的资源，从而导致恶性循环。死锁举例如下：</p>
</li>
<li><p><strong>举例一：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>事务1</th>
<th>事务2</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>start transaction; <br>update account set money&#x3D;10 where id&#x3D;1;</td>
<td>start transaction;</td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>update account set money&#x3D;10 where id&#x3D;2;</td>
</tr>
<tr>
<td>3</td>
<td>update account set money&#x3D;20 where id&#x3D;2;</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td></td>
<td>update account set money&#x3D;20 where id&#x3D;1;</td>
</tr>
</tbody></table>
<ul>
<li>这时候，事务1在等待事务2释放id&#x3D;2的行锁，而事务2在等待事务1释放id&#x3D;1的行锁。 事务1和事务2在互相等待对方的资源释放，就是进入了死锁状态。当出现死锁以后，有 两种策略：<ul>
<li>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数innodb_lock_wait_timeout 来设置</li>
<li>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务（将持有最少行级排他锁的事务进行回滚），让其他事务得以继续执行。将参数innodb_deadlock_detect 设置为on ，表示开启这个逻辑</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>举例2：</strong></p>
<ul>
<li><p>用户A给用户B转账100，在此同时，用户B也给用户A转账100。这个过程，可能导致死锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#事务<span class="number">1</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">108</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;A&#x27;</span>;#操作<span class="number">1</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>;#操作<span class="number">3</span></span><br><span class="line">#事务<span class="number">2</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> balance <span class="operator">=</span> balance <span class="operator">-</span> <span class="number">100</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>;#操作<span class="number">2</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> balance <span class="operator">=</span> balance <span class="operator">+</span> <span class="number">100</span> <span class="keyword">where</span> name <span class="operator">=</span> <span class="string">&#x27;A’;#操作4</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="2-产生死锁的必要条件"><a href="#2-产生死锁的必要条件" class="headerlink" title="2.产生死锁的必要条件"></a>2.产生死锁的必要条件</h5></blockquote>
<ul>
<li>两个或者两个以上事务</li>
<li>每个事务都已经持有锁并且申请新的锁</li>
<li>锁资源同时只能被同一个事务持有或者不兼容</li>
<li>事务之间因为持有锁和申请锁导致彼此循环等待</li>
</ul>
<blockquote>
<blockquote>
<p>死锁的关键在于:两个(或以上)的Session加锁的顺序不一致</p>
</blockquote>
</blockquote>
<blockquote>
<h5 id="3-如何处理死锁"><a href="#3-如何处理死锁" class="headerlink" title="3.如何处理死锁"></a>3.如何处理死锁</h5></blockquote>
<ul>
<li><p><strong>方式1：等待，直到超时( innodb_lock_wait_timeout&#x3D;50s)</strong></p>
<ul>
<li>即当两个事务互相等待时，当一个事务等待时间超过设置的阈值时，就将其<strong>回滚</strong>，另外事务继续进行。这种方法简单有效，在innodb中，参数<strong>innodb_lock_wait_timeout</strong>用来设置超时时间</li>
<li>缺点:对于在线服务来说，这个等待时间往往是无法接受的。那将此值修改短一些，比如1s，0.1s是否合适?不合适，容易误伤到普通的锁等待</li>
</ul>
</li>
<li><p><strong>方式2：使用死锁检测进行死锁处理</strong></p>
<ul>
<li><p>方式1检测死锁太过被动，innodb还提供了<strong>wait-for graph</strong>算法来主动进行死锁检测，每当加锁请求无法立即满足需要并进入等待时，<strong>wait-for graph</strong>算法都会被触发。</p>
</li>
<li><p>这是一种较为<strong>主动的死锁检测机制</strong>，要求数据库保存<strong>锁的信息链表</strong>和<strong>事务等待链表</strong>两部分信息：</p>
<p><img src="image-20221213203902215.png" alt="MySQL之性能优化/image-20221213203902215"></p>
</li>
<li><p>基于这两个信息，可以绘制 <strong>wait-for graph</strong> (等待图)：</p>
<p><img src="image-20221213204012588.png" alt="MySQL之性能优化/image-20221213204012588"></p>
</li>
</ul>
<blockquote>
<blockquote>
<p>死锁检测的原理是构建一个以事务为顶点、锁为边的有向图，判断有向图是否存在环，存在即有死锁</p>
</blockquote>
</blockquote>
<ul>
<li><p>一旦检测到回路、有死锁，这时候InnoDB存储引擎会选择<strong>回滚undo量最小的事务</strong>，让其他事务继续执行( innodb_deadlock_detect&#x3D;on表示开启这个逻辑)</p>
</li>
<li><p>缺点：每个新的被阻塞的线程，都要判断是不是由于自己的加入导致了死锁，这个操作时间复杂度是o(n)。如果100个并发线程同时更新同一行，意味着要检测100*100&#x3D; 1万次，1万个线程就会有1千万次检测</p>
</li>
<li><p><strong>如何解决?</strong></p>
<ul>
<li>方式1:关闭死锁检测，但意味着可能会出现大量的超时，会导致业务有损。</li>
<li>方式2:控制并发访问的数量。比如在中间件中实现对于相同行的更新，在进入引擎之前排队，这样在InnoDB内部就不会有大量的死锁检测工作</li>
</ul>
</li>
<li><p><strong>进一步的思路：</strong><br>可以考虑通过将一行改成逻辑上的多行来减少<strong>锁冲突</strong>。比如，连锁超市账户总额的记录，可以考虑放到多条记录上。账户总额等于这多个记录的值的总和</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<h5 id="4-如何避免死锁"><a href="#4-如何避免死锁" class="headerlink" title="4.如何避免死锁"></a>4.如何避免死锁</h5></blockquote>
<ul>
<li>合理设计索引，使业务SQL尽可能通过索引定位更少的行，减少锁竞争</li>
<li>调整业务逻辑SQL执行顺序，避免update&#x2F;delete长时间持有锁的SQL在事务前面</li>
<li>避免大事务，尽量将大事务拆成多个小事务来处理，小事务缩短锁定资源的时间，发生锁冲突的几率也更小</li>
<li>在并发比较高的系统中，不要显式加锁，特别是是在事务里显式加锁。如select … for update语句，如果是在事务里运行了start transaction或设置了autocommit等于0，那么就会锁定所查找到的记录</li>
<li>降低隔离级别。如果业务允许，将隔离级别调低也是较好的选择，比如将隔离级别从RR调整为RC，可以避免掉很多因为gap锁造成的死锁</li>
</ul>
<h3 id="8-3-4-锁的内存结构"><a href="#8-3-4-锁的内存结构" class="headerlink" title="8.3.4 锁的内存结构"></a>8.3.4 锁的内存结构</h3><ul>
<li><p>前边说对一条记录加锁的本质就是在内存中创建一个<strong>锁结构</strong>与之关联，那么是不是一个事务对多条记录加锁，就要创建多个<strong>锁结构</strong>呢？比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#事务T1</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">user</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br></pre></td></tr></table></figure>
</li>
<li><p>理论上创建多个<strong>锁结构</strong>没问题，但是如果一个事务要获取10000条记录的锁，生成10000个锁结构也太崩溃了!所以决定在对不同记录加锁时，如果符合下边这些条件的记录会放到一个<strong>锁结构</strong>中</p>
<ul>
<li>在同一个事务中进行加锁操作</li>
<li>被加锁的记录在同一个页面中</li>
<li>加锁的类型是一样的</li>
<li>等待状态是一样的</li>
</ul>
</li>
<li><p><strong>InnoDB</strong>存储引擎中的<strong>锁结构</strong>如下：</p>
<p><img src="image-20221213205547251.png" alt="MySQL之性能优化/image-20221213205547251"></p>
<ul>
<li><h4 id="结构解析："><a href="#结构解析：" class="headerlink" title="结构解析："></a>结构解析：</h4><ul>
<li><p><strong>1.锁所在的事务信息 ：</strong></p>
<ul>
<li>不论是 <strong>表锁</strong> 还是 <strong>行锁</strong> ，都是在事务执行过程中生成的，哪个事务生成了这个 <strong>锁结构</strong> ，这里就记录这个事务的信息</li>
<li>此<strong>锁所在的事务信息</strong>在内存结构中只是一个指针，通过指针可以找到内存中关于该事务的更多信息，比方说事务id等</li>
</ul>
</li>
<li><p><strong>2.索引信息 ：</strong></p>
<ul>
<li>对于 <strong>行锁</strong> 来说，需要记录一下加锁的记录是属于哪个索引的。这里也是一个指针。</li>
</ul>
</li>
<li><p><strong>3.表锁／行锁信息 ：</strong><br><strong>表锁结构</strong> 和 <strong>行锁结构</strong> 在这个位置的内容是不同的：</p>
<ul>
<li>表锁：<br>记载着是对哪个表加的锁，还有其他的一些信息</li>
<li>行锁：<br>记载了三个重要的信息：<br><strong>Space ID：</strong>记录所在表空间。<br><strong>Page Number</strong>：记录所在页号。<br><strong>n_bits：</strong>对于行锁来说，一条记录就对应着一个比特位，一个页面中包含很多记录，用不同的比特位来区分到底是哪一条记录加了锁。为此在行锁结构的末尾放置了一堆比特位，这个<strong>n_bits</strong> 属性代表使用了多少比特位</li>
</ul>
<blockquote>
<p>n_bits的值一般都比页面中记录条数多一些。主要是为了之后在页面中插入了新记录后也不至于重新分配锁结构</p>
</blockquote>
</li>
<li><p><strong>4.type_mode ：</strong></p>
<ul>
<li>这是一个32位的数，被分成了 <strong>lock_mode</strong> 、 <strong>lock_type</strong> 和 <strong>rec_lock_type</strong> 三个部分，如图所示：</li>
</ul>
<p><img src="image-20221213205841242.png" alt="MySQL之性能优化/image-20221213205841242"></p>
<ul>
<li><p>锁的模式（ <strong>lock_mode</strong> ），占用低4位，可选的值如下：</p>
<ul>
<li><strong>LOCK_IS</strong> （十进制的 <strong>0</strong> ）：表示共享意向锁，也就是 <strong>IS锁</strong></li>
<li><strong>LOCK_IX</strong> （十进制的 <strong>1</strong> ）：表示独占意向锁，也就是 <strong>IX锁</strong></li>
<li><strong>LOCK_S</strong> （十进制的 <strong>2</strong> ）：表示共享锁，也就是 <strong>S锁</strong></li>
<li><strong>LOCK_X</strong> （十进制的 <strong>3</strong> ）：表示独占锁，也就是 <strong>X锁</strong></li>
<li><strong>LOCK_AUTO_INC</strong> （十进制的 4 ）：表示 AUTO-INC锁</li>
</ul>
<p>在InnoDB存储引擎中，LOCK_IS,LOCK_IX，LOCK_AUTO_INC都算是表级锁的模式，LOCK_S和LOCK_X既可以算是表级锁的模式，也可以是行级锁的模式</p>
</li>
<li><p>锁的类型（ <strong>lock_type</strong> ），占用第5～8位，不过现阶段只有第5位和第6位被使用：</p>
<ul>
<li><strong>LOCK_TABLE</strong> （十进制的 <strong>16</strong> ），也就是当第5个比特位置为1时，表示表级锁。</li>
<li><strong>LOCK_REC</strong> （十进制的 <strong>32</strong> ），也就是当第6个比特位置为1时，表示行级锁。</li>
</ul>
</li>
<li><p>行锁的具体类型（ <strong>rec_lock_type</strong> ），使用其余的位来表示。只有在 <strong>lock_type</strong> 的值为<strong>LOCK_REC</strong> 时，也就是只有在该锁为行级锁时，才会被细分为更多的类型：</p>
<ul>
<li><strong>LOCK_ORDINARY</strong> （十进制的 <strong>0</strong> ）：表示 <strong>next-key锁</strong></li>
<li><strong>LOCK_GAP</strong> （十进制的 <strong>512</strong> ）：也就是当第10个比特位置为1时，表示 <strong>gap锁</strong></li>
<li><strong>LOCK_REC_NOT_GAP</strong> （十进制的 <strong>1024</strong> ）：也就是当第11个比特位置为1时，表示正经<strong>记录锁</strong> </li>
<li><strong>LOCK_INSERT_INTENTION</strong> （十进制的 <strong>2048</strong>）：也就是当第12个比特位置为1时，表示插入意向锁。其他的类型：还有一些不常用的类型</li>
</ul>
</li>
<li><p><strong>is_waiting</strong> 属性呢？基于内存空间的节省，所以把 <strong>is_waiting</strong> 属性放到了 <strong>type_mode</strong> 这个32<br>位的数字中：</p>
<ul>
<li><strong>LOCK_WAIT</strong> （十进制的 <strong>256</strong> ） ：当第9个比特位置为 <strong>1</strong> 时，表示 <strong>is_waiting</strong> 为 <strong>true</strong> ，也就是当前事务尚未获取到锁，处在等待状态；当这个比特位为 <strong>0</strong> 时，表示 <strong>is_waiting</strong> 为<strong>false</strong> ，也就是当前事务获取锁成功</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>5.其他信息：</strong></p>
<ul>
<li>为了更好的管理系统运行过程中生成的各种锁结构而设计了各种哈希表和链表</li>
</ul>
</li>
<li><p><strong>6.一堆比特位：</strong></p>
<ul>
<li>如果是 <strong>行锁结构</strong> 的话，在该结构末尾还放置了一堆比特位，比特位的数量是由上边提到的 <strong>n_bits</strong> 属性表示的。InnoDB数据页中的每条记录在 <strong>记录头信息</strong> 中都包含一个 <strong>heap_no</strong> 属性，伪记录 <strong>Infimum</strong> 的<strong>heap_no</strong> 值为 <strong>0</strong> ， <strong>Supremum</strong> 的 <strong>heap_no</strong> 值为 <strong>1</strong> ，之后每插入一条记录， <strong>heap_no</strong> 值就增1。<strong>锁结构</strong>最后的一堆比特位就对应着一个页面中的记录，一个比特位映射一个 <strong>heap_no</strong> ，即一个比特位映射到页内的一条记录</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="8-3-5-锁监控"><a href="#8-3-5-锁监控" class="headerlink" title="8.3.5 锁监控"></a>8.3.5 锁监控</h3><ul>
<li><p>关于MySQL锁的监控，我们一般可以通过检查 <strong>InnoDB_row_lock</strong> 等状态变量来分析系统上的行锁的争夺情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> status <span class="keyword">like</span> <span class="string">&#x27;innodb_row_lock%&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Variable_name <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_current_waits <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_avg <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_time_max <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Innodb_row_lock_waits <span class="operator">|</span> <span class="number">0</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------------+-------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对各个状态量的说明如下：</p>
<p>Innodb_row_lock_current_waits：当前正在等待锁定的数量；<br><strong>Innodb_row_lock_time：</strong>从系统启动到现在锁定总时间长度；（等待总时长）<br><strong>Innodb_row_lock_time_avg：</strong>每次等待所花平均时间；（等待平均时长）<br>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；<br><strong>Innodb_row_lock_waits：</strong>系统启动后到现在总共等待的次数；（等待总次数）</p>
</li>
<li><p>对于这5个状态变量，比较重要的3个见上面（加粗）</p>
</li>
<li><p>其他监控方法：</p>
<ul>
<li>MySQL把事务和锁的信息记录在了 <strong>information_schema</strong> 库中，涉及到的三张表分别是<strong>INNODB_TRX</strong> 、 <strong>INNODB_LOCKS</strong> 和 <strong>INNODB_LOCK_WAITS</strong> </li>
<li><strong>MySQL5.7及之前</strong> ，可以通过information_schema.INNODB_LOCKS查看事务的锁情况，但只能看到阻塞事务的锁；如果事务并未被阻塞，则在该表中看不到该事务的锁情况</li>
<li>MySQL8.0删除了information_schema.INNODB_LOCKS，添加了 <strong>performance_schema</strong>.data_locks ，可以通过performance_schema.data_locks查看事务的锁情况，和MySQL5.7及之前不同，performance_schema.data_locks不但可以看到阻塞该事务的锁，还可以看到该事务所持有的锁。</li>
<li>同时,information_schema.INNODB_LOCK_WAITS也被 <strong>performance_schema.data_lock_waits</strong> 所代替</li>
</ul>
</li>
<li><p>模拟一个锁等待的场景，以下是从这三张表收集的信息锁等待场景，我们依然使用记录锁中的案例，当事务2进行等待时，查询情况如下：</p>
<ul>
<li><p>1.查询正在被锁阻塞的sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.INNODB_TRX\G;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2.查询锁等待情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> data_lock_waits\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">ENGINE: INNODB</span><br><span class="line">REQUESTING_ENGINE_LOCK_ID: <span class="number">139750145405624</span>:<span class="number">7</span>:<span class="number">4</span>:<span class="number">7</span>:<span class="number">139747028690608</span></span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: <span class="number">13845</span> #被阻塞的事务ID</span><br><span class="line">REQUESTING_THREAD_ID: <span class="number">72</span></span><br><span class="line">REQUESTING_EVENT_ID: <span class="number">26</span></span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: <span class="number">139747028690608</span></span><br><span class="line">BLOCKING_ENGINE_LOCK_ID: <span class="number">139750145406432</span>:<span class="number">7</span>:<span class="number">4</span>:<span class="number">7</span>:<span class="number">139747028813248</span></span><br><span class="line">BLOCKING_ENGINE_TRANSACTION_ID: <span class="number">13844</span> #正在执行的事务ID，阻塞了<span class="number">13845</span></span><br><span class="line">BLOCKING_THREAD_ID: <span class="number">71</span></span><br><span class="line">BLOCKING_EVENT_ID: <span class="number">24</span></span><br><span class="line">BLOCKING_OBJECT_INSTANCE_BEGIN: <span class="number">139747028813248</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>3.查询锁的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">from</span> performance_schema.data_locks\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: <span class="number">139750145405624</span>:<span class="number">1068</span>:<span class="number">139747028693520</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">13847</span></span><br><span class="line">THREAD_ID: <span class="number">72</span></span><br><span class="line">EVENT_ID: <span class="number">31</span></span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: <span class="keyword">user</span></span><br><span class="line">PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139747028693520</span></span><br><span class="line">LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">LOCK_MODE: IX</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">2.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: <span class="number">139750145405624</span>:<span class="number">7</span>:<span class="number">4</span>:<span class="number">7</span>:<span class="number">139747028690608</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">13847</span></span><br><span class="line">THREAD_ID: <span class="number">72</span></span><br><span class="line">EVENT_ID: <span class="number">31</span></span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: <span class="keyword">user</span></span><br><span class="line">PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139747028690608</span></span><br><span class="line">LOCK_TYPE: RECORD</span><br><span class="line">LOCK_MODE: X,REC_NOT_GAP</span><br><span class="line">LOCK_STATUS: WAITING</span><br><span class="line">LOCK_DATA: <span class="number">1</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">3.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: <span class="number">139750145406432</span>:<span class="number">1068</span>:<span class="number">139747028816304</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">13846</span></span><br><span class="line">THREAD_ID: <span class="number">71</span></span><br><span class="line">EVENT_ID: <span class="number">28</span></span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: <span class="keyword">user</span></span><br><span class="line">PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">INDEX_NAME: <span class="keyword">NULL</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139747028816304</span></span><br><span class="line">LOCK_TYPE: <span class="keyword">TABLE</span></span><br><span class="line">LOCK_MODE: IX</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: <span class="keyword">NULL</span></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">4.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: <span class="number">139750145406432</span>:<span class="number">7</span>:<span class="number">4</span>:<span class="number">7</span>:<span class="number">139747028813248</span></span><br><span class="line">ENGINE_TRANSACTION_ID: <span class="number">13846</span></span><br><span class="line">THREAD_ID: <span class="number">71</span></span><br><span class="line">EVENT_ID: <span class="number">28</span></span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: <span class="keyword">user</span></span><br><span class="line">PARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">SUBPARTITION_NAME: <span class="keyword">NULL</span></span><br><span class="line">INDEX_NAME: <span class="keyword">PRIMARY</span></span><br><span class="line">OBJECT_INSTANCE_BEGIN: <span class="number">139747028813248</span></span><br><span class="line">LOCK_TYPE: RECORD</span><br><span class="line">LOCK_MODE: X,REC_NOT_GAP</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: <span class="number">1</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line">ERROR:</span><br><span class="line"><span class="keyword">No</span> query specified</span><br></pre></td></tr></table></figure>

<ul>
<li>从锁的情况可以看出来，两个事务分别获取了IX锁，从意向锁章节可以知道，IX锁互相时兼容的。所以这里不会等待，但是事务1同样持有X锁，此时事务2也要去同一行记录获取X锁，他们之间不兼容，导致等待的情况发生</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="8-4-多版本并发控制（MVCC）"><a href="#8-4-多版本并发控制（MVCC）" class="headerlink" title="8.4 多版本并发控制（MVCC）"></a>8.4 多版本并发控制（MVCC）</h2><h3 id="8-4-1-什么是MVCC"><a href="#8-4-1-什么是MVCC" class="headerlink" title="8.4.1 什么是MVCC"></a>8.4.1 什么是MVCC</h3><ul>
<li>MVCC (<strong>Multiversion Concurrency Control</strong>)，多版本并发控制。顾名思义，MVCC是通过数据行的多个版本管理来实现数据库的<strong>并发控制</strong>。这项技术使得在InnoDB的事务隔离级别下执行<strong>一致性读</strong>操作有了保证。换言之，就是为了查询一些正在被另一个事务更新的行，并且可以看到它们被更新之前的值，这样在做查询的时候就不用等待另一个事务释放锁</li>
<li>MVCC没有正式的标准，在不同的DBMS中 MVCC的实现方式可能是不同的，也不是普遍使用的(大家可以参考相关的DBMS文档)。这里讲解InnoDB 中 MVCC的实现机制（MySQL其它的存储引擎并不支持它)</li>
</ul>
<h3 id="8-4-2-快照读与当前读"><a href="#8-4-2-快照读与当前读" class="headerlink" title="8.4.2 快照读与当前读"></a>8.4.2 快照读与当前读</h3><ul>
<li>MVCC在MySQL InnoDB中的实现主要是为了提高数据库并发性能，用更好的方式去处理<strong>读-写冲突</strong>，做到即使有读写冲突时，也能做到<strong>不加锁，非阻塞并发读</strong>，而这个读指的就是<strong>快照读</strong>，而非<strong>当前读</strong>。当前读实际上是一种加锁的操作，是悲观锁的实现。而MVCC本质是采用乐观锁思想的一种方式</li>
</ul>
<h4 id="8-4-2-1-快照读"><a href="#8-4-2-1-快照读" class="headerlink" title="8.4.2.1 快照读"></a>8.4.2.1 快照读</h4><ul>
<li><p>快照读又叫一致性读，读取的是快照数据。<strong>不加锁的简单的 SELECT 都属于快照读</strong>，即不加锁的非阻塞读；比如这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> player <span class="keyword">WHERE</span> ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于MVCC，它在很多情况下，避免了加锁操作，降低了开销</p>
</li>
<li><p>既然是基于多版本，那么快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本</p>
</li>
<li><p>快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读</p>
</li>
</ul>
<h4 id="8-4-2-2-当前读"><a href="#8-4-2-2-当前读" class="headerlink" title="8.4.2.2 当前读"></a>8.4.2.2 当前读</h4><ul>
<li><p>当前读读取的是记录的最新版本（最新数据，而不是历史版本的数据），读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。加锁的 SELECT，或者对数据进行增删改都会进行当前读。比如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student LOCK <span class="keyword">IN</span> SHARE MODE; # 共享锁</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>; # 排他锁</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> student <span class="keyword">values</span> ... # 排他锁</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> ... # 排他锁</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> ... # 排他锁</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="8-4-3-复习"><a href="#8-4-3-复习" class="headerlink" title="8.4.3 复习"></a>8.4.3 复习</h3><h4 id="8-4-3-1-再谈隔离级"><a href="#8-4-3-1-再谈隔离级" class="headerlink" title="8.4.3.1 再谈隔离级"></a>8.4.3.1 再谈隔离级</h4><ul>
<li><p>事务有 4 个隔离级别，可能存在三种并发问题：</p>
<p><img src="image-20221214211411508.png" alt="MySQL之性能优化/image-20221214211411508"></p>
</li>
<li><p>在MySQL中，默认的隔离级别是可重复读，可以解决脏读和不可重复读的问题，如果仅从定义的角度来看，它并不能解决幻读问题。如果想要解决幻读问题，就需要采用串行化的方式，也就是将隔离级别提升到最高，但这样一来就会大幅降低数据库的事务并发能力</p>
</li>
<li><p>MVCC可以不采用锁机制，而是通过乐观锁的方式来解决不可重复读和幻读问题!它可以在大多数情况下替代行级锁，降低系统的开销</p>
<p><img src="image-20221214211504868.png" alt="MySQL之性能优化/image-20221214211504868"></p>
</li>
</ul>
<h4 id="8-4-3-2-隐藏字段、Undo-Log版本链"><a href="#8-4-3-2-隐藏字段、Undo-Log版本链" class="headerlink" title="8.4.3.2 隐藏字段、Undo Log版本链"></a>8.4.3.2 隐藏字段、Undo Log版本链</h4><ul>
<li><p>回顾一下undo日志的版本链，对于使用<strong>InnoDB</strong>存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列</p>
<ul>
<li><strong>trx_id:</strong> 每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的<strong>事务id</strong>赋值给<strong>trx_id</strong>隐藏列</li>
<li><strong>roll_pointer：</strong>每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到<strong>undo日志</strong>中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息</li>
</ul>
</li>
<li><p><strong>举例:</strong> student表数据如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student ;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>假设插入该记录的事务<code>id</code>为<code>8</code>，那么此刻该条记录的示意图如下所示：</p>
<p><img src="image-20221214212057046.png" alt="MySQL之性能优化/image-20221214212057046"></p>
<blockquote>
<p>insert undo只在事务回滚时起作用，当事务提交后，该类型的undo日志就没用了，它占用的Undo Log Segment也会被系统回收（也就是该undo日志占用的Undo页面链表要么被重用，要么被释放)</p>
</blockquote>
</li>
<li><p>假设之后两个事务id分别为<code>10</code>、<code>20</code>的事务对这条记录进行<code>UPDATE</code> 操作，操作流程如下：</p>
<table>
<thead>
<tr>
<th>发生时间顺序</th>
<th>事务10</th>
<th>事务20</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>BEGIN;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>BEGIN;</td>
</tr>
<tr>
<td>3</td>
<td>UPDATE student SET name&#x3D;“李四” WHERE id&#x3D;1;</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>UPDATE student SET name&#x3D;“王五” WHERE id&#x3D;1;</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>COMMIT;</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>UPDATE student SET name&#x3D;“钱七” WHERE id&#x3D;1;</td>
</tr>
<tr>
<td>7</td>
<td></td>
<td>UPDATE student SET name&#x3D;“宋八” WHERE id&#x3D;1;</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td>COMMIT;</td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<p>能不能在两个事务中交叉更新同一条记录呢?<br>不能!这不就是一个事务修改了另一个未提交事务修改过的数据，脏写</p>
<p>InnoDB使用锁来保证不会有脏写情况的发生，也就是在第一个事务更新了某条记录后，就会给这条记录加锁，另一个事务再次更新时就需要等待第一个事务提交了，把锁释放之后才可以继续更新</p>
</blockquote>
<ul>
<li><p>每次对记录进行改动，都会记录一条undo日志，每条undo日志也都有一个<strong>roll_pointer</strong>属性（<strong>INSERT</strong>操作对应的<strong>undo日志</strong>没有该属性，因为该记录并没有更早的版本)，可以将这些<strong>undo日志</strong>都连起来，串成一个链表：update写的时候应该是默认加了x锁的,20会等待10</p>
<p><img src="image-20221214212713433.png" alt="MySQL之性能优化/image-20221214212713433"></p>
</li>
<li><p>对该记录每次更新后，都会将旧值放到一条<code>undo日志</code>中，就算是该记录的一个旧版本，随着更新次数的增多，所有的版本都会被<code>roll_pointer</code>属性连接成一个链表，把这个链表称之为<code>版本链</code>，版本链的头节点就是当前记录最新的值</p>
</li>
<li><p>每个版本中还包含生成该版本时对应的<strong>事务id</strong></p>
</li>
</ul>
<h3 id="8-4-4-MVCC的实现原理之ReadView"><a href="#8-4-4-MVCC的实现原理之ReadView" class="headerlink" title="8.4.4 MVCC的实现原理之ReadView"></a>8.4.4 MVCC的实现原理之ReadView</h3><ul>
<li>MVCC 的实现依赖于：<strong>隐藏字段、Undo Log、Read View</strong></li>
</ul>
<h4 id="8-4-4-1-什么是ReadView"><a href="#8-4-4-1-什么是ReadView" class="headerlink" title="8.4.4.1 什么是ReadView"></a>8.4.4.1 什么是ReadView</h4><ul>
<li>在MVCC机制中，多个事务对同一个行记录进行更新会产生多个历史快照，这些历史快照保存在Undo Log里。如果一个事务想要查询这个行记录，需要读取哪个版本的行记录呢?这时就需要用到ReadView了，它解决了行的可见性问题</li>
<li>ReadView就是事务A在使用MVCC机制进行快照读操作时产生的读视图。当事务启动时，会生成数据库系统当前的一个快照，InnoDB为每个事务构造了一个数组，用来记录并维护系统当前<strong>活跃事务</strong>的ID（“活跃”指的就是，启动了但还没提交)</li>
</ul>
<h4 id="8-4-4-2-设计思路"><a href="#8-4-4-2-设计思路" class="headerlink" title="8.4.4.2 设计思路"></a>8.4.4.2 设计思路</h4><ul>
<li><p>使用<strong>READ UNCONNMITTED</strong>隔离级别的事务，由于可以读到未提交事务修改过的记录，所以直接读取记录的最新版本就好了</p>
</li>
<li><p>使用<strong>SERIALIZABLE</strong>隔离级别的事务，InnoDB规定使用加锁的方式来访问记录</p>
</li>
<li><p>使用 <strong>READ COMMITTED</strong> 和 <strong>REPEATABLE READ</strong> 隔离级别的事务，都必须保证读到 <strong>已经提交了的</strong> 事务修改过的记录。假如另一个事务已经修改了记录但是尚未提交，是不能直接读取最新版本的记录的，核心问题就是需要判断一下版本链中的哪个版本是当前事务可见的，这是ReadView要解决的主要问题</p>
</li>
<li><p>这个ReadView中主要包含4个比较重要的内容，分别如下：</p>
<ul>
<li><p>1.<strong>creator_trx_id</strong> ，创建这个 Read View 的事务 ID</p>
<blockquote>
<p>说明：只有在对表中的记录做改动时（执行INSERT、DELETE、UPDATE这些语句时）才会为事务分配事务id，否则在一个只读事务中的事务id值都默认为0</p>
</blockquote>
</li>
<li><p>2.<strong>trx_ids</strong> ，表示在生成ReadView时当前系统中活跃的读写事务的<strong>事务id列表</strong> </p>
</li>
<li><p>3.<strong>up_limit_id</strong> ，活跃的事务中最小的事务 ID</p>
</li>
<li><p>4.<strong>low_limit_id</strong> ，表示生成ReadView时系统中应该分配给下一个事务的 <strong>id</strong> 值。low_limit_id 是系统最大的事务id值，这里要注意是系统中的事务id，需要区别于正在活跃的事务ID</p>
<blockquote>
<p>注意：low_limit_id并不是trx_ids中的最大值，事务id是递增分配的。比如，现在有id为1，2，3这三个事务，之后id为3的事务提交了。那么一个新的读事务在生成ReadView时，trx_ids就包括1和2，up_limit_id的值就是1，low_limit_id的值就是4</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>举例:</strong></p>
<ul>
<li>trx_ids为trx2、trx3、trx5和trx8的集合，系统的最大事务ID (low_limit_id)为trx8+1(如果之前没有其他的新增事务)，活跃的最小事务ID (up_limit_id)为trx2</li>
</ul>
<p><img src="image-20221214213212941.png" alt="MySQL之性能优化/image-20221214213212941"></p>
</li>
</ul>
<h4 id="8-4-4-3-ReadView的规则"><a href="#8-4-4-3-ReadView的规则" class="headerlink" title="8.4.4.3 ReadView的规则"></a>8.4.4.3 ReadView的规则</h4><ul>
<li><p>有了这个ReadView，这样在访问某条记录时，只需要按照下边的步骤判断记录的某个版本是否可见。</p>
<ul>
<li>如果被访问版本的trx_id属性值与ReadView中的 <strong>creator_trx_id</strong> 值相同，意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问。20可以访问自己</li>
<li>如果被访问版本的trx_id属性值小于ReadView中的 <strong>up_limit_id</strong>值，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本可以被当前事务访问。10可以访问最新</li>
<li>如果被访问版本的trx_id属性值大于或等于ReadView中的 <strong>low_limit_id</strong>值，表明生成该版本的事务在当前事务生成ReadView后才开启，所以该版本不可以被当前事务访问。（20被10阻塞）</li>
<li>如果被访问版本的trx_id属性值在ReadView的 <strong>up_limit_id</strong> 和 <strong>low_limit_id</strong>之间，那就需要判断一下trx_id属性值是不是在 <strong>trx_ids</strong> 列表中<ul>
<li>如果在，说明创建ReadView时生成该版本的事务还是活跃的，该版本不可以被访问。(10没提交，不能访问最新)</li>
<li>如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版本可以被访问。(10提交之后，就能访问最新)</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="8-4-4-4-MVCC整体操作流程"><a href="#8-4-4-4-MVCC整体操作流程" class="headerlink" title="8.4.4.4 MVCC整体操作流程"></a>8.4.4.4 MVCC整体操作流程</h4><ul>
<li><p>了解了这些概念之后，来看下当查询一条记录的时候，系统如何通过MVCC找到它：</p>
<ul>
<li>1.首先获取事务自己的版本号，也就是事务 ID</li>
<li>2.获取 ReadView</li>
<li>3.查询得到的数据，然后与 ReadView 中的事务版本号进行比较</li>
<li>4.如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照</li>
<li>5.最后返回符合规则的数据</li>
</ul>
</li>
<li><p>如果某个版本的数据对当前事务不可见的话，那就顺着版本链找到下一个版本的数据，继续按照上边的步骤判断可见性，依此类推，直到版本链中的最后一个版本。如果最后一个版本也不可见的话，那么就意味着该条记录对该事务完全不可见，查询结果就不包含该记录</p>
<blockquote>
<p>InnoDB中，MVCC是通过Undo Log + Read View进行数据读取，Undo Log保存了历史快照，而Read View规则帮我们判断当前版本的数据是否可见</p>
</blockquote>
</li>
<li><p>在隔离级别为读已提交（Read Committed）时，一个事务中的每一次 SELECT 查询都会重新获取一次Read View</p>
</li>
<li><p>如表所示：</p>
<table>
<thead>
<tr>
<th>事务</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>begin;</td>
<td></td>
</tr>
<tr>
<td>select * from student where id &gt;2;</td>
<td>获取一次Read View</td>
</tr>
<tr>
<td>…</td>
<td></td>
</tr>
<tr>
<td>select * from student where id &gt;2;</td>
<td>获取一次Read View</td>
</tr>
<tr>
<td>commit;</td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<blockquote>
<p>注意，此时同样的查询语句都会重新获取一次Read View，这时如果Read View 不同，就可能产生不可重复读或者幻读的情况</p>
</blockquote>
<ul>
<li><p>当<strong>隔离级别为可重复读</strong>的时候，就避免了不可重复读，这是因为<strong>一个事务只在第一次SELECT的时候会获取一次Read View</strong>，而后面所有的SELECT都会复用这个Read View，如下表所示：</p>
<p><img src="image-20221214213739544.png" alt="MySQL之性能优化/image-20221214213739544"></p>
</li>
</ul>
<h3 id="8-4-5-举例说明"><a href="#8-4-5-举例说明" class="headerlink" title="8.4.5 举例说明"></a>8.4.5 举例说明</h3><ul>
<li><p>假设现在student表中只有一条由<code>事务id</code>为<code>8</code>的事务插入的一条记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> class  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> 张三   <span class="operator">|</span> 一班    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>MVCC只能在READ COMMITTED和REPEATABLE READ两个隔离级别下工作。接下来看一下<code>READ COMMITTED</code>和<code>REPEATABLE READ</code>所谓的生成ReadView的时机不同到底不同在哪里</p>
</li>
</ul>
<h4 id="8-4-5-1-读已提交隔离级别下"><a href="#8-4-5-1-读已提交隔离级别下" class="headerlink" title="8.4.5.1 读已提交隔离级别下"></a>8.4.5.1 读已提交隔离级别下</h4><ul>
<li><p><strong>READ COMMITTED ：每次读取数据前都生成一个ReadView</strong></p>
</li>
<li><p>现在有两个 <code>事务id</code> 分别为 <code>10</code> 、 <code>20</code> 的事务在执行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">10</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;李四&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;王五&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"># Transaction <span class="number">20</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"># 更新了一些别的表的记录(为了分配事务id)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明:事务执行过程中，只有在第一次真正修改记录时(比如使用INSERT、DELETE、UPDATE语句)，才会被分配一个单独的事务id，这个事务id是递增的。所以我们才在事务2中更新一些别的表的记录，目的是让它分配事务id</p>
</blockquote>
</li>
<li><p>此刻，表student 中<strong>id为1</strong>的记录得到的版本链表如下所示：</p>
<p><img src="image-20221215162610380.png" alt="MySQL之性能优化/image-20221215162610380"></p>
</li>
<li><p>假设现在有一个使用 <strong>READ COMMITTED</strong> 隔离级别的事务开始执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用READ COMMITTED隔离级别的事务</span><br><span class="line"></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"># SELECT1：Transaction <span class="number">10</span>、<span class="number">20</span>未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值为<span class="string">&#x27;张三&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这个<strong>SELECT1</strong>的执行过程如下:</p>
<ul>
<li><p>步骤1：在执行SELECT语句时会先生成一个<strong>ReadView</strong> ，ReadView的<strong>trx_ids</strong>列表的内容就是**[10，20]<strong>，</strong>up_limit_id<strong>为</strong>10,** <strong>low_limit_id</strong>为<strong>21</strong>, <strong>creator_trx_id</strong>为<strong>0</strong></p>
</li>
<li><p>步骤2：从版本链中挑选可见的记录，从图中看出，最新版本的列<strong>name</strong>的内容是’<strong>王五’</strong>，该版本的<strong>trx_id</strong>值为<strong>10</strong>，在<strong>trx_ids</strong>列表内，所以不符合可见性要求，根据<strong>roll_pointer</strong>跳到下一个版本</p>
</li>
<li><p>步骤3：下一个版本的列<strong>name</strong>的内容是<strong>’李四’</strong>，该版本的<strong>trx_id</strong>值也为<strong>10</strong>，也在<strong>trx_ids</strong>列表内，所以也不符合要求，继续跳到下一个版本</p>
</li>
<li><p>步骤4：下一个版本的列<strong>name</strong>的内容是<strong>’张三’</strong>，该版本的<strong>trx_id</strong>值为<strong>8</strong>，小于<strong>ReadView</strong>中的<strong>up_limit_id</strong>值<strong>10</strong>，所以这个版本是符合要求的，最后返回给用户的版本就是这条列<strong>name</strong>为<strong>‘张三’</strong>的记录</p>
</li>
</ul>
</li>
<li><p>之后，把 <strong>事务id</strong> 为 <strong>10</strong> 的事务提交一下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">10</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;李四&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;王五&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再到 <code>事务id</code> 为 <code>20</code> 的事务中更新一下表 <code>student</code> 中 <code>id</code> 为 <code>1</code> 的记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">20</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"># 更新了一些别的表的记录</span><br><span class="line">...</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;钱七&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;宋八&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此刻，表student中 <code>id</code> 为 <code>1</code> 的记录的版本链就长这样：</p>
<p><img src="image-20221215162852815.png" alt="MySQL之性能优化/image-20221215162852815"></p>
</li>
<li><p>然后再到刚才使用 <code>READ COMMITTED</code> 隔离级别的事务中继续查找这个 <code>id</code> 为 <code>1</code> 的记录，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用READ COMMITTED隔离级别的事务</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"># SELECT1：Transaction <span class="number">10</span>、<span class="number">20</span>均未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值为<span class="string">&#x27;张三&#x27;</span></span><br><span class="line"></span><br><span class="line"># SELECT2：Transaction <span class="number">10</span>提交，Transaction <span class="number">20</span>未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值为<span class="string">&#x27;王五&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>SELECT2流程：</p>
<ul>
<li><p>步骤1：在执行<strong>SELECT</strong>语句时会又会单独生成一个<strong>ReadView</strong>，该<strong>ReadView</strong>的<strong>trx_ids</strong>列表的内容就是**[20]<strong>，</strong>up_limit_id<strong>为</strong>20<strong>，</strong>low_limit_id<strong>为</strong>21**, <strong>creator_trx_id</strong>为<strong>0</strong></p>
</li>
<li><p>步骤2：从版本链中挑选可见的记录，从图中看出，最新版本的列<strong>name</strong>的内容是<strong>’宋八’</strong>，该版本的<strong>trx_id</strong>值为<strong>20，</strong>在<strong>trx_ids</strong>列表内，所以不符合可见性要求，根据<strong>roll_pointer</strong>跳到下一个版本</p>
</li>
<li><p>步骤3：下一个版本的列<strong>name</strong>的内容是<strong>‘钱七’</strong>，该版本的<strong>trx_id</strong>值为<strong>20</strong>，也在<strong>trx_ids</strong>列表内，所以也不符合要求，继续跳到下一个版本</p>
</li>
<li><p>步骤4：下一个版本的列<strong>name</strong>的内容是<strong>’王五’</strong>，该版本的<strong>trx_id</strong>值为<strong>10</strong>，小于<strong>ReadView</strong>中的<strong>up_limit_id</strong>值<strong>20</strong>，所以这个版本是符合要求的，最后返回给用户的版本就是这条列<strong>name</strong>为<strong>’王五’</strong>的记录</p>
</li>
</ul>
</li>
<li><p>以此类推，如果之后<strong>事务id</strong>为<strong>20</strong>的记录也提交了，再次在使用<strong>READ COMMITED</strong> 隔离级别的事务查询表<strong>student</strong>中<strong>id</strong>值为<strong>1</strong>的记录时，得到的结果就是’**宋八’**了，具体流程就不分析了</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>强调：使用READ COMMITTED隔离级别的事务在每次查询开始时都会生成一个独立的ReadView</strong></p>
</blockquote>
<h4 id="8-4-5-2-可重复读隔离级别下"><a href="#8-4-5-2-可重复读隔离级别下" class="headerlink" title="8.4.5.2 可重复读隔离级别下"></a>8.4.5.2 可重复读隔离级别下</h4><ul>
<li><p>使用 <code>REPEATABLE READ</code> 隔离级别的事务来说，只会在第一次执行查询语句时生成一个 <code>ReadView</code> ，之后的查询就不会重复生成了</p>
</li>
<li><p>比如，系统里有两个 <code>事务id</code> 分别为 <code>10</code> 、 <code>20</code> 的事务在执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">10</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;李四&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;王五&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"># Transaction <span class="number">20</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"># 更新了一些别的表的记录</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>此刻，表student 中 <code>id</code> 为 <code>1</code> 的记录得到的版本链表如下所示：</p>
<p><img src="image-20221215163159618.png" alt="MySQL之性能优化/image-20221215163159618"></p>
</li>
<li><p>假设现在有一个使用 <code>REPEATABLE READ</code> 隔离级别的事务开始执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用REPEATABLE READ隔离级别的事务</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"># SELECT1：Transaction <span class="number">10</span>、<span class="number">20</span>未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值为<span class="string">&#x27;张三&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这个<strong>SELECT1</strong>的执行过程如下:</p>
<ul>
<li>步骤1：在执行SELECT语句时会先生成一个ReadView，ReadView的trx_ids列表的内容就是[10，20]，up_limit_id为10, low_limit_id为21, creator_trx_id为0</li>
<li>步骤2：然后从版本链中挑选可见的记录，从图中看出，最新版本的列name的内容是’王五’，该版本的trx_id值为10，在trx_ids列表内，所以不符合可见性要求，根据roll_pointer跳到下一个版本</li>
<li>步骤3：下一个版本的列name的内容是’李四’，该版本的trx_id值也为10，也在trx_ids列表内，所以也不符合要求，继续跳到下一个版本</li>
<li>步骤4：下一个版本的列name的内容是’张三’，该版本的trx_id值为8，小于ReadView中的up_limit_id值10，所以这个版本是符合要求的，最后返回给用户的版本就是这条列name为’张三’的记录</li>
</ul>
</li>
<li><p>之后，我们把<code>事务id</code>为<code>10</code>的事务提交一下，就像这样：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">10</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;李四&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;王五&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后再到 <code>事务id</code> 为 <code>20</code> 的事务中更新一下表 student 中 id 为 1 的记录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Transaction <span class="number">20</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"># 更新了一些别的表的记录</span><br><span class="line">...</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;钱七&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> student <span class="keyword">SET</span> name<span class="operator">=</span>&quot;宋八&quot; <span class="keyword">WHERE</span> id<span class="operator">=</span><span class="number">1</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>此刻，表student 中 id 为 1 的记录的版本链长这样：</p>
<p><img src="image-20221215163411336.png" alt="MySQL之性能优化/image-20221215163411336"></p>
</li>
<li><p>然后再到刚才使用 <code>REPEATABLE READ</code> 隔离级别的事务中继续查找这个<code>id</code> 为 <code>1</code> 的记录，如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用REPEATABLE READ隔离级别的事务</span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"></span><br><span class="line"># SELECT1：Transaction <span class="number">10</span>、<span class="number">20</span>均未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值为<span class="string">&#x27;张三&#x27;</span></span><br><span class="line"></span><br><span class="line"># SELECT2：Transaction <span class="number">10</span>提交，Transaction <span class="number">20</span>未提交</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> student <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span>; # 得到的列name的值仍为<span class="string">&#x27;张三&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>SELECT2</strong>的执行过程如下:</p>
<ul>
<li>步骤1：因为当前事务的隔离级别为<strong>REPEATABLE READ</strong>，而之前在执行SELECT1时已经生成过ReadView了，所以此时直接<strong>复用之前的ReadView</strong>，之前的ReadView的trx_ids列表的内容就是[10，20]，up_limit_id为10，low_limit_id为21, creator_trx_id为0</li>
<li>步骤2：然后从版本链中挑选可见的记录，从图中可以看出，最新版本的列name的内容是’宋八’，该版本的trx_id值为20，在trx_ids列表内，所以不符合可见性要求，根据roll_pointer跳到下一个版本</li>
<li>步骤3：下一个版本的列name的内容是’钱七’，该版本的trx_id值为20，也在trx_ids列表内，所以也不符合要求，继续跳到下一个版本</li>
<li>步骤4：下一个版本的列name的内容是’王五’，该版本的trx_id值为10，而trx_ids列表中是包含值为10的事务id的，所以该版本也不符合要求，同理下一个列name的内容是‘李四’的版本也不符合要求。继续跳到下一个版本</li>
<li>步骤5：下一个版本的列name的内容是’张三’，该版本的trx_id值为8，小于ReadView中的up_limit_id值10，所以这个版本是符合要求的，最后返回给用户的版本就是这条列c为‘张三’的记录</li>
</ul>
</li>
<li><p>两次SELECT查询得到的结果是重复的，记录的列c值都是‘张三’，这就是可重复读的含义。如果我们之后再把事务id为20的记录提交了，然后再到刚才使用REPEATABLE READ隔离级别的事务中继续查找这个id为1的记得到的结果还是‘张三’</p>
</li>
</ul>
<h4 id="8-4-5-3-如何解决幻读"><a href="#8-4-5-3-如何解决幻读" class="headerlink" title="8.4.5.3 如何解决幻读"></a>8.4.5.3 如何解决幻读</h4><ul>
<li><p>假设现在表 student 中只有一条数据，数据内容中，主键 id&#x3D;1，隐藏的 trx_id&#x3D;10，它的 undo log 如下图所示</p>
<p><img src="image-20221215163626736.png" alt="MySQL之性能优化/image-20221215163626736"></p>
</li>
<li><p>假设现在有事务 A 和事务 B 并发执行， <code>事务 A</code> 的事务 id 为 <code>20</code> ， <code>事务 B</code> 的事务 id 为 <code>30</code> </p>
<ul>
<li><p>步骤1：事务 A 开始第一次查询数据，查询的 SQL 语句如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> student <span class="keyword">where</span> id <span class="operator">&gt;=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>在开始查询之前，MySQL 会为事务 A 产生一个 ReadView，此时 ReadView 的内容如下： trx_ids&#x3D;[20,30] ，up_limit_id&#x3D;20 ， low_limit_id&#x3D;31 ， creator_trx_id&#x3D;20 </li>
<li>由于此时表 student 中只有一条数据，且符合 where id&gt;&#x3D;1 条件，因此会查询出来。然后根据 ReadView机制，发现该行数据的trx_id&#x3D;10，小于事务 A 的 ReadView 里 up_limit_id，这表示这条数据是事务 A 开启之前，其他事务就已经提交了的数据，因此事务 A 可以读取到</li>
<li>结论：事务 A 的第一次查询，能读取到一条数据，id&#x3D;1</li>
</ul>
</li>
<li><p>步骤2：接着事务 B(trx_id&#x3D;30)，往表 student 中新插入两条数据，并提交事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id,name) <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;李四&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> student(id,name) <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;王五&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>此时表student 中就有三条数据了，对应的 undo 如下图所示：</p>
<p><img src="image-20221215163829177.png" alt="MySQL之性能优化/image-20221215163829177"></p>
</li>
</ul>
</li>
<li><p>步骤3：接着事务 A 开启第二次查询，根据可重复读隔离级别的规则，此时事务 A 并不会再重新生成ReadView。此时表 student 中的 3 条数据都满足 where id&gt;&#x3D;1 的条件，因此会先查出来。然后根据ReadView 机制，判断每条数据是不是都可以被事务 A 看到</p>
<ul>
<li><p>1）首先 id&#x3D;1 的这条数据，前面已经说过了，可以被事务 A 看到</p>
</li>
<li><p>2）然后是 id&#x3D;2 的数据，它的 trx_id&#x3D;30，此时事务 A 发现，这个值处于 up_limit_id 和 low_limit_id 之间，因此还需要再判断 30 是否处于 trx_ids 数组内。由于事务 A 的 trx_ids&#x3D;[20,30]，因此在数组内，这表示 id&#x3D;2 的这条数据是与事务 A 在同一时刻启动的其他事务提交的，所以这条数据不能让事务 A 看到</p>
</li>
<li><p>3）同理，id&#x3D;3 的这条数据，trx_id 也为 30，因此也不能被事务 A 看见</p>
<p><img src="image-20221215163940901.png" alt="MySQL之性能优化/image-20221215163940901"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>结论：最终事务 A 的第二次查询，只能查询出 id&#x3D;1 的这条数据。这和事务 A 的第一次查询的结果是一样的，因此没有出现幻读现象，所以说在 MySQL 的可重复读隔离级别下，不存在幻读问题</p>
</li>
</ul>
<h3 id="8-4-6-小结"><a href="#8-4-6-小结" class="headerlink" title="8.4.6 小结"></a>8.4.6 小结</h3><ul>
<li><p>这里介绍了 <strong>MVCC</strong> 在 <strong>READ COMMITTD</strong> 、 <strong>REPEATABLE READ</strong> 这两种隔离级别的事务在执行快照读操作时访问记录的版本链的过程。这样使不同事务的 <strong>读-写</strong> 、 <strong>写-读</strong> 操作并发执行，从而提升系统性能</p>
</li>
<li><p>核心点在于 <strong>ReadView</strong> 的原理， <strong>READ COMMITTD</strong> 、 <strong>REPEATABLE READ</strong> 这两个隔离级别的一个很大不同就是生成<strong>ReadView</strong>的时机不同：</p>
<ul>
<li><strong>READ COMMITTD</strong> 在每一次进行普通SELECT操作前都会生成一个ReadView</li>
<li><strong>REPEATABLE READ</strong>只在第一次进行普通SELECT操作前生成一个ReadView，之后的查询操作都重复使用这个ReadView就好了</li>
</ul>
<blockquote>
<p>说明:之前说执行DELETE语句或者更新主键的UPDATE语句并不会立即把对应的记录完全从页面中删除，而是执行一个所谓的delete mark操作，相当于只是对记录打上了一个删除标志位，这主要就是为MVCC服务的</p>
</blockquote>
</li>
<li><p>通过 MVCC 可以解决：</p>
<ul>
<li>1.<strong>读写之间阻塞的问题。</strong>通过MVCC 可以让读写互相不阻塞，即读不阻塞写，写不阻塞读，这样就可以提升事务并发处理能力</li>
<li>2.<strong>降低了死锁的概率</strong>。这是因为MVCC采用了乐观锁的方式，读取数据时并不需要加锁，对于写操作，也只锁 定必要的行</li>
<li>3.<strong>解决快照读的问题。</strong>当查询数据库在某个时间点的快照时，只能看到这个时间点之前事务提交更新的结果，而不能看到这个时间点之后事务提交的更新结果</li>
</ul>
</li>
</ul>
<h1 id="9-日志与备份"><a href="#9-日志与备份" class="headerlink" title="9.日志与备份"></a>9.日志与备份</h1><h2 id="9-1-其它数据库日志"><a href="#9-1-其它数据库日志" class="headerlink" title="9.1 其它数据库日志"></a>9.1 其它数据库日志</h2><h3 id="9-1-1-MySQL支持的日志"><a href="#9-1-1-MySQL支持的日志" class="headerlink" title="9.1.1 MySQL支持的日志"></a>9.1.1 MySQL支持的日志</h3><h3 id="9-1-2-慢查询日志-slow-query-log"><a href="#9-1-2-慢查询日志-slow-query-log" class="headerlink" title="9.1.2 慢查询日志(slow query log)"></a>9.1.2 慢查询日志(slow query log)</h3><h3 id="9-1-3-通用查询日志-general-query-log"><a href="#9-1-3-通用查询日志-general-query-log" class="headerlink" title="9.1.3 通用查询日志(general query log)"></a>9.1.3 通用查询日志(general query log)</h3><h3 id="9-1-4-错误日志-error-log"><a href="#9-1-4-错误日志-error-log" class="headerlink" title="9.1.4 错误日志(error log)"></a>9.1.4 错误日志(error log)</h3><h3 id="9-1-5-二进制日志-bin-log"><a href="#9-1-5-二进制日志-bin-log" class="headerlink" title="9.1.5 二进制日志(bin log)"></a>9.1.5 二进制日志(bin log)</h3><h3 id="9-1-6-再谈二进制日志-binlog"><a href="#9-1-6-再谈二进制日志-binlog" class="headerlink" title="9.1.6 再谈二进制日志(binlog)"></a>9.1.6 再谈二进制日志(binlog)</h3><h3 id="9-1-7-中继日志-relay-log"><a href="#9-1-7-中继日志-relay-log" class="headerlink" title="9.1.7  中继日志(relay log)"></a>9.1.7  中继日志(relay log)</h3><h2 id="9-2-主从复制"><a href="#9-2-主从复制" class="headerlink" title="9.2 主从复制"></a>9.2 主从复制</h2><h2 id="9-3-数据库的备份与回复"><a href="#9-3-数据库的备份与回复" class="headerlink" title="9.3 数据库的备份与回复"></a>9.3 数据库的备份与回复</h2>
    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>峡谷杨爹
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xiaguyangdie.github.io/2023/02/26/MySQL%E4%B9%8B%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" title="MySQL提升篇">https://xiaguyangdie.github.io/2023/02/26/MySQL之性能优化/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="fa fa-tag"></i> 数据库</a>
              <a href="/tags/MySQL/" rel="tag"><i class="fa fa-tag"></i> MySQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/26/MySQL%E4%B9%8B%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E7%90%86%E8%A7%A3/" rel="prev" title="MySQL之底层实现理解">
      <i class="fa fa-chevron-left"></i> MySQL之底层实现理解
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/26/MySQL%E5%AE%89%E8%A3%85/" rel="next" title="MySQL安装">
      MySQL安装 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%BF%B0%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="nav-text">1.数据库概述与安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%BF%B0"><span class="nav-text">1.1 数据库概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-DB%E4%B8%8EDBMS"><span class="nav-text">1.2 DB与DBMS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%88DBMS%EF%BC%89"><span class="nav-text">1.3 常见数据库管理系统（DBMS）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-MySQL%E4%BB%8B%E7%BB%8D"><span class="nav-text">1.4 MySQL介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-5-RDBMS-%E4%B8%8E-%E9%9D%9ERDBMS"><span class="nav-text">1.5 RDBMS 与 非RDBMS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-6-MySQL%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">1.6 MySQL环境搭建</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-7-MySQL%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-text">1.7 MySQL目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-8-cmd%E4%BD%BF%E7%94%A8MySQL"><span class="nav-text">1.8 cmd使用MySQL</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-SQL%E4%B9%8BSELECT"><span class="nav-text">2.SQL之SELECT</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E5%9F%BA%E6%9C%AC%E7%9A%84SELECT%E8%AF%AD%E5%8F%A5"><span class="nav-text">2.1 基本的SELECT语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">2.2 运算符</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">2.2.1 算术运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">2.2.2 比较运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">2.2.3 逻辑运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-4-%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="nav-text">2.2.4 位运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-5-%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">2.2.5 运算符优先级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E6%8E%92%E5%BA%8F%E4%B8%8E%E5%88%86%E9%A1%B5"><span class="nav-text">2.3 排序与分页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-1-%E6%8E%92%E5%BA%8F"><span class="nav-text">2.3.1 排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-2-%E5%88%86%E9%A1%B5"><span class="nav-text">2.3.2 分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-3-%E6%8E%92%E5%BA%8F%E4%B8%8E%E5%88%86%E9%A1%B5%E5%A3%B0%E6%98%8E%E9%A1%BA%E5%BA%8F"><span class="nav-text">2.3.3 排序与分页声明顺序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E5%A4%9A%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.4 多表查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-1-%E7%AD%89%E5%80%BC%E8%BF%9E%E6%8E%A5%E4%B8%8E%E9%9D%9E%E7%AD%89%E5%80%BC%E8%BF%9E%E6%8E%A5"><span class="nav-text">2.4.1 等值连接与非等值连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-2-%E8%87%AA%E8%BF%9E%E6%8E%A5%E4%B8%8E%E9%9D%9E%E8%87%AA%E8%BF%9E%E6%8E%A5"><span class="nav-text">2.4.2 自连接与非自连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-3-%E5%86%85%E8%BF%9E%E6%8E%A5%E4%B8%8E%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="nav-text">2.4.3  内连接与外连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-4-UNION%E4%B8%8EUNION-ALL"><span class="nav-text">2.4.4 UNION与UNION ALL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-5-7%E7%A7%8DJOIN%E5%AE%9E%E7%8E%B0"><span class="nav-text">2.4.5 7种JOIN实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-6-SQL99%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-text">2.4.6 SQL99新特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-7-%E6%89%A9%E5%B1%95"><span class="nav-text">2.4.7 扩展</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-5-%E5%8D%95%E8%A1%8C%E5%87%BD%E6%95%B0"><span class="nav-text">2.5 单行函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-1-%E6%95%B0%E5%80%BC%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.1 数值函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-2-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.2 字符串函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-3-%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.3 日期和时间函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-4-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.4 流程控制函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-5-%E5%8A%A0%E5%AF%86%E5%92%8C%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.5 加密和解密函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-6-MySQL%E4%BF%A1%E6%81%AF%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.6 MySQL信息函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-7-%E5%85%B6%E5%AE%83%E5%87%BD%E6%95%B0"><span class="nav-text">2.5.7 其它函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-6-%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="nav-text">2.6 聚合函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-7-group-by"><span class="nav-text">2.7 group by</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-8-having"><span class="nav-text">2.8 having</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-SQL%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="nav-text">2.9 SQL执行过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-9-%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.9 子查询</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-1-%E5%8D%95%E8%A1%8C%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.9.1 单行子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-2-%E5%A4%9A%E8%A1%8C%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.9.2 多行子查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-3-%E7%9B%B8%E5%85%B3%E5%AD%90%E6%9F%A5%E8%AF%A2"><span class="nav-text">2.9.3 相关子查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-SQL%E4%B9%8BDDL%E3%80%81DML%E3%80%81DCL"><span class="nav-text">3.SQL之DDL、DML、DCL</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">3.1 基础知识</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%84%E7%90%86%E4%B9%8B%E5%A2%9E%E5%88%A0%E6%94%B9"><span class="nav-text">3.2 数据库处理之增删改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%88%9B%E5%BB%BA%E5%92%8C%E7%AE%A1%E7%90%86%E8%A1%A8"><span class="nav-text">3.3 创建和管理表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-DML%E4%B9%8Binsert"><span class="nav-text">3.4 DML之insert</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-DML%E4%B9%8Bdelete"><span class="nav-text">3.5 DML之delete</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-DML%E4%B9%8Bupdate"><span class="nav-text">3.6 DML之update</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-MySQL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-text">3.7 MySQL数据类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-%E7%BA%A6%E6%9D%9F"><span class="nav-text">3.8 约束</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-%E5%85%B6%E5%AE%83%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AF%B9%E8%B1%A1"><span class="nav-text">4.其它数据库对象</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1 视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1.1 为什么使用视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-%E8%A7%86%E5%9B%BE%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-text">4.1.2 视图的理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-3-%E5%88%9B%E5%BB%BA%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1.3 创建视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-4-%E6%9F%A5%E7%9C%8B%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1.4 查看视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-4-%E6%9B%B4%E6%96%B0%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1.4 更新视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-5-%E4%BF%AE%E6%94%B9%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%86%E5%9B%BE"><span class="nav-text">4.1.5 修改、删除视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-6-%E6%80%BB%E7%BB%93"><span class="nav-text">4.1.6 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-text">4.2 存储过程与存储函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">4.2.1 存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">4.2.1.1 概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-2-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">4.2.1.2 创建存储过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-3-%E8%B0%83%E7%94%A8%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">4.2.1.3 调用存储过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-text">4.2.2 存储函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-3-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E5%92%8C%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0%E7%9A%84%E6%9F%A5%E7%9C%8B%E3%80%81%E4%BF%AE%E6%94%B9%E3%80%81%E5%88%A0%E9%99%A4"><span class="nav-text">4.2.3 存储过程和存储函数的查看、修改、删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-4-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">4.2.4 存储过程的优缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E5%8F%98%E9%87%8F%E3%80%81%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E4%B8%8E%E6%B8%B8%E6%A0%87"><span class="nav-text">4.3 变量、流程控制与游标</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E5%8F%98%E9%87%8F"><span class="nav-text">4.3.1 变量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-text">4.3.1.1 系统变量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-1-2-%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="nav-text">4.3.1.2 用户变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6%E4%B8%8E%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-text">4.3.2 定义条件与处理程序</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-1-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">4.3.2.1 案例分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-2-%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6"><span class="nav-text">4.3.2.2 定义条件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-3-%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-text">4.3.2.3 定义处理程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-2-4-%E6%A1%88%E4%BE%8B%E8%A7%A3%E5%86%B3"><span class="nav-text">4.3.2.4 案例解决</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-3-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="nav-text">4.3.3 流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-1-%E5%88%86%E6%94%AF%E6%9C%BA%E6%9E%84%E4%B9%8Bif"><span class="nav-text">4.3.3.1 分支机构之if</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-2-%E5%88%86%E6%94%AF%E6%9C%BA%E6%9E%84%E4%B9%8Bcase"><span class="nav-text">4.3.3.2 分支机构之case</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-3-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8B-loop"><span class="nav-text">4.3.3.3 循环结构之 loop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-4-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8B-while"><span class="nav-text">4.3.3.4 循环结构之 while</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-5-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8B-repeat"><span class="nav-text">4.3.3.5 循环结构之 repeat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-6-%E8%B7%B3%E8%BD%AC%E8%AF%AD%E5%8F%A5%E4%B9%8Bleave%E8%AF%AD%E5%8F%A5"><span class="nav-text">4.3.3.6 跳转语句之leave语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-3-7-%E8%B7%B3%E8%BD%AC%E8%AF%AD%E5%8F%A5%E4%B9%8Biterate%E8%AF%AD%E5%8F%A5"><span class="nav-text">4.3.3.7 跳转语句之iterate语句</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-4-%E6%B8%B8%E6%A0%87"><span class="nav-text">4.3.4 游标</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%B8%B8%E6%A0%87%EF%BC%88%E6%88%96%E5%85%89%E6%A0%87%EF%BC%89"><span class="nav-text">4.3.4.1 什么是游标（或光标）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-2-%E4%BD%BF%E7%94%A8%E6%B8%B8%E6%A0%87%E6%AD%A5%E9%AA%A4"><span class="nav-text">4.3.4.2 使用游标步骤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-3-%E4%B8%BE%E4%BE%8B"><span class="nav-text">4.3.4.3 举例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-3-4-4-%E5%B0%8F%E7%BB%93"><span class="nav-text">4.3.4.4 小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">4.4 触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">4.4.1 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">4.4.2 创建触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-2-1-%E5%88%9B%E5%BB%BA%E8%A7%A6%E5%8F%91%E5%99%A8%E8%AF%AD%E6%B3%95"><span class="nav-text">4.4.2.1 创建触发器语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-2-2-%E4%BB%A3%E7%A0%81%E4%B8%BE%E4%BE%8B"><span class="nav-text">4.4.2.2 代码举例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-%E6%9F%A5%E7%9C%8B%E3%80%81%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">4.4.3 查看、删除触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-1-%E6%9F%A5%E7%9C%8B%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">4.4.3.1 查看触发器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-3-2-%E5%88%A0%E9%99%A4%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">4.4.3.2 删除触发器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-4-%E8%A7%A6%E5%8F%91%E5%99%A8%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">4.4.4 触发器的优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-4-1-%E4%BC%98%E7%82%B9"><span class="nav-text">4.4.4.1 优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-4-4-2-%E7%BC%BA%E7%82%B9"><span class="nav-text">4.4.4.2 缺点</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-MySQL8%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-text">5.MySQL8新特性</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-MySQL%E6%9E%B6%E6%9E%84"><span class="nav-text">6.MySQL架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-Linux%E4%B8%8BMySQL%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-text">6.1 Linux下MySQL的安装和使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-%E5%8D%B8%E8%BD%BDMySQL"><span class="nav-text">6.1.1 卸载MySQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-%E5%AE%89%E8%A3%85MySQL5-7"><span class="nav-text">6.1.2 安装MySQL5.7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-3-%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="nav-text">6.1.3 字符集的相关操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-1-%E4%BF%AE%E6%94%B9MySQL5-7%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="nav-text">6.1.3.1 修改MySQL5.7字符集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-2-%E5%90%84%E7%BA%A7%E5%88%AB%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86"><span class="nav-text">6.1.3.2 各级别的字符集</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-3-%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8E%E6%AF%94%E8%BE%83%E8%A7%84%E5%88%99"><span class="nav-text">6.1.3.3 字符集与比较规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-3-4-%E8%AF%B7%E6%B1%82%E5%88%B0%E5%93%8D%E5%BA%94%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%AD%97%E7%AC%A6%E9%9B%86%E7%9A%84%E5%8F%98%E5%8C%96"><span class="nav-text">6.1.3.4 请求到响应过程中字符集的变化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-4-SQL%E5%A4%A7%E5%B0%8F%E5%86%99%E8%A7%84%E8%8C%83"><span class="nav-text">6.1.4 SQL大小写规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-4-1-Windows%E5%92%8CLinux%E5%B9%B3%E5%8F%B0%E5%8C%BA%E5%88%AB"><span class="nav-text">6.1.4.1 Windows和Linux平台区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-4-2-Linux%E4%B8%8B%E5%A4%A7%E5%B0%8F%E5%86%99%E8%A7%84%E5%88%99%E8%AE%BE%E7%BD%AE"><span class="nav-text">6.1.4.2 Linux下大小写规则设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-4-3-SQL%E7%BC%96%E5%86%99%E5%BB%BA%E8%AE%AE"><span class="nav-text">6.1.4.3 SQL编写建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-5-sql-mode%E7%9A%84%E5%90%88%E7%90%86%E8%AE%BE%E7%BD%AE"><span class="nav-text">6.1.5 sql_mode的合理设置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-5-1-%E4%BB%8B%E7%BB%8D"><span class="nav-text">6.1.5.1 介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-5-2-%E5%AE%BD%E6%9D%BE%E6%A8%A1%E5%BC%8F-vs-%E4%B8%A5%E6%A0%BC%E6%A8%A1%E5%BC%8F"><span class="nav-text">6.1.5.2 宽松模式 vs 严格模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-5-3-%E6%A8%A1%E5%BC%8F%E6%9F%A5%E7%9C%8B%E5%92%8C%E8%AE%BE%E7%BD%AE"><span class="nav-text">6.1.5.3 模式查看和设置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-1-5-4-sql-mode%E5%B8%B8%E7%94%A8%E5%80%BC"><span class="nav-text">6.1.5.4 sql_mode常用值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-MySQL%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9B%AE%E5%BD%95"><span class="nav-text">6.2 MySQL的数据目录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-MySQL5-7%E7%9A%84%E4%B8%BB%E8%A6%81%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-text">6.2.1 MySQL5.7的主要目录结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6%E7%9A%84%E5%AD%98%E6%94%BE%E8%B7%AF%E5%BE%84"><span class="nav-text">6.2.1.1 数据库文件的存放路径</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-2-%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4%E7%9B%AE%E5%BD%95"><span class="nav-text">6.2.1.2 相关命令目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-1-3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95"><span class="nav-text">6.2.1.3 配置文件目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-text">6.2.2 数据库与文件系统的关系</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-1-%E6%9F%A5%E7%9C%8B%E9%BB%98%E8%AE%A4%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">6.2.2.1 查看默认数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="nav-text">6.2.2.2 数据库在文件系统中的表示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-3-%E8%A1%A8%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="nav-text">6.2.2.3 表在文件系统中的表示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-4-%E5%B0%8F%E7%BB%93"><span class="nav-text">6.2.2.4 小结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-5-%E8%A7%86%E5%9B%BE%E5%9C%A8%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="nav-text">6.2.2.5 视图在文件系统中的表示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-2-2-6-%E5%85%B6%E5%AE%83%E6%96%87%E4%BB%B6"><span class="nav-text">6.2.2.6 其它文件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-text">6.3 用户和权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="nav-text">6.3.1 用户管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-1-%E7%99%BB%E5%BD%95MySQL%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-text">6.3.1.1 登录MySQL服务器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-2-%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7"><span class="nav-text">6.3.1.2 创建用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-3-%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7"><span class="nav-text">6.3.1.3 修改用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-4-%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7"><span class="nav-text">6.3.1.4 删除用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-5-%E8%AE%BE%E7%BD%AE%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="nav-text">6.3.1.5 设置当前用户密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-6-%E4%BF%AE%E6%94%B9%E5%85%B6%E4%BB%96%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="nav-text">6.3.1.6 修改其他用户密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-1-7-MySQL8%E5%AF%86%E7%A0%81%E7%AE%A1%E7%90%86"><span class="nav-text">6.3.1.7 MySQL8密码管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86"><span class="nav-text">6.3.2 权限管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-1-%E6%9D%83%E9%99%90%E5%88%97%E8%A1%A8"><span class="nav-text">6.3.2.1 权限列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-2-%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90%E7%9A%84%E5%8E%9F%E5%88%99"><span class="nav-text">6.3.2.2 授予权限的原则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-3-%E6%8E%88%E4%BA%88%E6%9D%83%E9%99%90"><span class="nav-text">6.3.2.3 授予权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-4-%E6%9F%A5%E7%9C%8B%E6%9D%83%E9%99%90"><span class="nav-text">6.3.2.4 查看权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-2-5-%E6%94%B6%E5%9B%9E%E6%9D%83%E9%99%90"><span class="nav-text">6.3.2.5 收回权限</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-3-%E6%9D%83%E9%99%90%E8%A1%A8"><span class="nav-text">6.3.3 权限表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-3-1-user%E8%A1%A8"><span class="nav-text">6.3.3.1 user表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-3-2-db%E8%A1%A8"><span class="nav-text">6.3.3.2 db表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-3-3-tables-priv%E8%A1%A8%E5%92%8Ccolumns-priv%E8%A1%A8"><span class="nav-text">6.3.3.3 tables_priv表和columns_priv表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-3-4-procs-priv%E8%A1%A8"><span class="nav-text">6.3.3.4 procs_priv表</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-4-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6"><span class="nav-text">6.3.4 访问控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-4-1-%E8%BF%9E%E6%8E%A5%E6%A0%B8%E5%AE%9E%E9%98%B6%E6%AE%B5"><span class="nav-text">6.3.4.1 连接核实阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-4-2-%E8%AF%B7%E6%B1%82%E6%A0%B8%E5%AE%9E%E9%98%B6%E6%AE%B5"><span class="nav-text">6.3.4.2 请求核实阶段</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-5-%E8%A7%92%E8%89%B2%E7%AE%A1%E7%90%86"><span class="nav-text">6.3.5 角色管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-1-%E8%A7%92%E8%89%B2%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-text">6.3.5.1 角色的理解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-2-%E5%88%9B%E5%BB%BA%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.2 创建角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-3-%E7%BB%99%E6%9D%83%E9%99%90%E8%B5%8B%E4%BA%88%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.3 给权限赋予角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-4-%E6%9F%A5%E7%9C%8B%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90"><span class="nav-text">6.3.5.4 查看角色权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-5-%E5%9B%9E%E6%94%B6%E8%A7%92%E8%89%B2%E6%9D%83%E9%99%90"><span class="nav-text">6.3.5.5 回收角色权限</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-6-%E5%88%A0%E9%99%A4%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.6 删除角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-7-%E7%BB%99%E7%94%A8%E6%88%B7%E8%B5%8B%E4%BA%88%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.7 给用户赋予角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-8-%E6%BF%80%E6%B4%BB%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.8 激活角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-9-%E6%92%A4%E9%94%80%E7%94%A8%E6%88%B7%E7%9A%84%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.9 撤销用户的角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-10-%E8%AE%BE%E7%BD%AE%E5%BC%BA%E5%88%B6%E8%A7%92%E8%89%B2"><span class="nav-text">6.3.5.10 设置强制角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-5-11-%E5%B0%8F%E7%BB%93"><span class="nav-text">6.3.5.11 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-6-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">6.3.6 配置文件的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-6-1-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="nav-text">6.3.6.1 配置文件格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-6-2-%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%E5%92%8C%E9%80%89%E9%A1%B9%E7%BB%84"><span class="nav-text">6.3.6.2 启动命令和选项组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-6-3-%E7%89%B9%E5%AE%9AMySQL%E7%89%88%E6%9C%AC%E7%9A%84%E4%B8%93%E7%94%A8%E9%80%89%E9%A1%B9%E7%BB%84"><span class="nav-text">6.3.6.3 特定MySQL版本的专用选项组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-6-4-%E5%90%8C%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%A4%9A%E4%B8%AA%E7%BB%84%E7%9A%84%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">6.3.6.4 同一个配置文件中的多个组的优先级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-3-6-5-%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E5%90%AF%E5%8A%A8%E9%80%89%E9%A1%B9%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-text">6.3.6.5 命令行和配置文件中的启动选项的区别</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84"><span class="nav-text">6.4 逻辑架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-1-%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E5%89%96%E6%9E%90"><span class="nav-text">6.4.1 逻辑架构剖析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-1-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E8%AF%B7%E6%B1%82"><span class="nav-text">6.4.1.1 服务器处理客户端的请求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-2-Connectors"><span class="nav-text">6.4.1.2 Connectors</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-3-%E7%AC%AC%E4%B8%80%E5%B1%82%EF%BC%9A%E8%BF%9E%E6%8E%A5%E5%B1%82"><span class="nav-text">6.4.1.3 第一层：连接层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-4-%E7%AC%AC%E4%BA%8C%E5%B1%82%EF%BC%9A%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="nav-text">6.4.1.4 第二层：服务层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-5-%E7%AC%AC%E4%B8%89%E5%B1%82%EF%BC%9A%E5%BC%95%E6%93%8E%E5%B1%82"><span class="nav-text">6.4.1.5 第三层：引擎层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-6-%E5%AD%98%E5%82%A8%E5%B1%82"><span class="nav-text">6.4.1.6 存储层</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-1-7-%E5%B0%8F%E7%BB%93"><span class="nav-text">6.4.1.7 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-2-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">6.4.2 执行流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-1-MySQL%E4%B8%AD%E7%9A%84SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-text">6.4.2.1 MySQL中的SQL执行流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-2-MySQL8%E4%B8%ADSQL%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-text">6.4.2.2 MySQL8中SQL执行原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-3-MySQL5-7%E4%B8%ADSQL%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%90%86"><span class="nav-text">6.4.2.3 MySQL5.7中SQL执行原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-4-SQL%E8%AF%AD%E6%B3%95%E9%A1%BA%E5%BA%8F"><span class="nav-text">6.4.2.4 SQL语法顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-2-5-Oracle%E4%B8%AD%E7%9A%84SQL%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-%E4%BA%86%E8%A7%A3"><span class="nav-text">6.4.2.5 Oracle中的SQL执行流程(了解)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-4-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%86%B2%E6%B1%A0-buffer-pool"><span class="nav-text">6.4.3  数据库缓冲池(buffer pool)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-1-%E7%BC%93%E5%86%B2%E6%B1%A0-vs-%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="nav-text">6.4.3.1  缓冲池 vs 查询缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-2-%E7%BC%93%E5%86%B2%E6%B1%A0%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="nav-text">6.4.3.2 缓冲池如何读取数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-3-%E6%9F%A5%E7%9C%8B-x2F-%E8%AE%BE%E7%BD%AE%E7%BC%93%E5%86%B2%E6%B1%A0%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-text">6.4.3.3 查看&#x2F;设置缓冲池的大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-4-%E5%A4%9A%E4%B8%AABuffer-Pool%E5%AE%9E%E4%BE%8B"><span class="nav-text">6.4.3.4 多个Buffer Pool实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-4-3-5-%E5%BC%95%E7%94%B3%E9%97%AE%E9%A2%98"><span class="nav-text">6.4.3.5 引申问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-5-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5 存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-1-%E6%9F%A5%E7%9C%8B%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.1 查看存储引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-2-%E8%AE%BE%E7%BD%AE%E7%B3%BB%E7%BB%9F%E9%BB%98%E8%AE%A4%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.2 设置系统默认的存储引擎</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-3-%E8%AE%BE%E7%BD%AE%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.3 设置表的存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-3-1-%E5%88%9B%E5%BB%BA%E8%A1%A8%E6%97%B6%E6%8C%87%E5%AE%9A%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.3.1 创建表时指定存储引擎</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-3-2-%E4%BF%AE%E6%94%B9%E8%A1%A8%E7%9A%84%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.3.2 修改表的存储引擎</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-5-4-%E5%BC%95%E6%93%8E%E4%BB%8B%E7%BB%8D"><span class="nav-text">6.5.4 引擎介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-4-1-InnoDB-%E5%BC%95%E6%93%8E%EF%BC%9A%E5%85%B7%E5%A4%87%E5%A4%96%E9%94%AE%E6%94%AF%E6%8C%81%E5%8A%9F%E8%83%BD%E7%9A%84%E4%BA%8B%E5%8A%A1%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.4.1 InnoDB 引擎：具备外键支持功能的事务存储引擎</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-5-4-2-MyISAM-%E5%BC%95%E6%93%8E%EF%BC%9A%E4%B8%BB%E8%A6%81%E7%9A%84%E9%9D%9E%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">6.5.4.2 MyISAM 引擎：主要的非事务处理存储引擎</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98"><span class="nav-text">7.索引及调优</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-%E7%B4%A2%E5%BC%95"><span class="nav-text">7.1 索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="nav-text">7.1.1 为什么使用索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-2-%E7%B4%A2%E5%BC%95%E5%8F%8A%E5%85%B6%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">7.1.2 索引及其优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-1-%E7%B4%A2%E5%BC%95%E6%A6%82%E8%BF%B0"><span class="nav-text">7.1.2.1 索引概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-2-%E4%BC%98%E7%82%B9"><span class="nav-text">7.1.2.2 优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-2-3-%E7%BC%BA%E7%82%B9"><span class="nav-text">7.1.2.3 缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-3-InnoDB%E4%B8%AD%E7%B4%A2%E5%BC%95%E7%9A%84%E6%8E%A8%E6%BC%94"><span class="nav-text">7.1.3 InnoDB中索引的推演</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-1-%E7%B4%A2%E5%BC%95%E4%B9%8B%E5%89%8D%E7%9A%84%E6%9F%A5%E6%89%BE"><span class="nav-text">7.1.3.1 索引之前的查找</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-2-%E8%AE%BE%E8%AE%A1%E7%B4%A2%E5%BC%95"><span class="nav-text">7.1.3.2 设计索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-3-%E5%B8%B8%E8%A7%81%E7%9A%84%E7%B4%A2%E5%BC%95%E6%A6%82%E5%BF%B5"><span class="nav-text">7.1.3.3 常见的索引概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-3-4-InnoDB%E7%9A%84B-%E6%A0%91%E7%B4%A2%E5%BC%95%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-text">7.1.3.4 InnoDB的B+树索引的注意事项</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-4-MyISAM%E4%B8%AD%E7%9A%84%E7%B4%A2%E5%BC%95%E6%96%B9%E6%A1%88"><span class="nav-text">7.1.4 MyISAM中的索引方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-4-1-MyISAM%E7%B4%A2%E5%BC%95%E7%9A%84%E5%8E%9F%E7%90%86"><span class="nav-text">7.1.4.1 MyISAM索引的原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-4-2-MyISAM-%E4%B8%8E-InnoDB%E5%AF%B9%E6%AF%94"><span class="nav-text">7.1.4.2 MyISAM 与 InnoDB对比</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-5-%E7%B4%A2%E5%BC%95%E7%9A%84%E4%BB%A3%E4%BB%B7"><span class="nav-text">7.1.5 索引的代价</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-6-MySQL%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%80%89%E6%8B%A9%E7%9A%84%E5%90%88%E7%90%86%E6%80%A7"><span class="nav-text">7.1.6 MySQL数据结构选择的合理性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-1-%E5%85%A8%E8%A1%A8%E9%81%8D%E5%8E%86"><span class="nav-text">7.1.6.1 全表遍历</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-2-Hash%E7%BB%93%E6%9E%84"><span class="nav-text">7.1.6.2 Hash结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-3-%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91"><span class="nav-text">7.1.6.3 二叉搜索树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-4-AVL%E6%A0%91"><span class="nav-text">7.1.6.4 AVL树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-5-B-Tree"><span class="nav-text">7.1.6.5 B-Tree</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-6-B-Tree"><span class="nav-text">7.1.6.6 B+Tree</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-7-R%E6%A0%91"><span class="nav-text">7.1.6.7 R树</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-8-%E5%B0%8F%E7%BB%93"><span class="nav-text">7.1.6.8 小结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-1-6-9-%E7%AE%97%E6%B3%95%E7%9A%84%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="nav-text">7.1.6.9 算法的时间复杂度</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-InnoDB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-text">7.2 InnoDB数据存储结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84%EF%BC%9A%E9%A1%B5"><span class="nav-text">7.2.1 数据库的存储结构：页</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-1-%E7%A3%81%E7%9B%98%E4%B8%8E%E5%86%85%E5%AD%98%E4%BA%A4%E4%BA%92%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8D%95%E4%BD%8D%EF%BC%9A%E9%A1%B5"><span class="nav-text">7.2.1.1 磁盘与内存交互的基本单位：页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-2-%E9%A1%B5%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">7.2.1.2 页的概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-3-%E9%A1%B5%E7%9A%84%E5%A4%A7%E5%B0%8F"><span class="nav-text">7.2.1.3 页的大小</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-1-4-%E9%A1%B5%E7%9A%84%E4%B8%8A%E5%B1%82%E7%BB%93%E6%9E%84"><span class="nav-text">7.2.1.4 页的上层结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-%E9%A1%B5%E7%9A%84%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84"><span class="nav-text">7.2.2 页的内部结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-1-%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9AFile-Header%EF%BC%88%E6%96%87%E4%BB%B6%E5%A4%B4%E9%83%A8%EF%BC%89%E5%92%8CFile-Trailer%EF%BC%88%E6%96%87%E4%BB%B6%E7%BB%93%E5%B0%BE%EF%BC%89"><span class="nav-text">7.2.2.1 第一部分：File Header（文件头部）和File Trailer（文件结尾）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-2-%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9AUser-Records%EF%BC%88%E7%94%A8%E6%88%B7%E8%AE%B0%E5%BD%95%EF%BC%89%E3%80%81%E6%9C%80%E5%A4%A7%E6%9C%80%E5%B0%8F%E8%AE%B0%E5%BD%95%E3%80%81Free-Space%EF%BC%88%E7%A9%BA%E9%97%B2%E7%A9%BA%E9%97%B4%EF%BC%89"><span class="nav-text">7.2.2.2 第二部分：User Records（用户记录）、最大最小记录、Free Space（空闲空间）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-3-%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%9APage-Directory%EF%BC%88%E9%A1%B5%E7%9B%AE%E5%BD%95%EF%BC%89%E3%80%81Page-Header%EF%BC%88%E9%A1%B5%E9%9D%A2%E5%A4%B4%E9%83%A8%EF%BC%89"><span class="nav-text">7.2.2.3 第三部分：Page Directory（页目录）、Page Header（页面头部）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-2-4-%E4%BB%8E%E6%95%B0%E6%8D%AE%E9%A1%B5%E7%9A%84%E8%A7%92%E5%BA%A6%E7%9C%8BB-%E6%A0%91%E5%A6%82%E4%BD%95%E6%9F%A5%E8%AF%A2"><span class="nav-text">7.2.2.4 从数据页的角度看B+树如何查询</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-3-InnoDB%E8%A1%8C%E6%A0%BC%E5%BC%8F%EF%BC%88%E6%88%96%E8%AE%B0%E5%BD%95%E6%A0%BC%E5%BC%8F%EF%BC%89"><span class="nav-text">7.2.3 InnoDB行格式（或记录格式）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-1-%E6%8C%87%E5%AE%9A%E8%A1%8C%E6%A0%BC%E5%BC%8F%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="nav-text">7.2.3.1 指定行格式的语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-2-COMPACT%E8%A1%8C%E6%A0%BC%E5%BC%8F"><span class="nav-text">7.2.3.2 COMPACT行格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-3-3-Dynamic%E5%92%8CCompressed%E8%A1%8C%E6%A0%BC%E5%BC%8F"><span class="nav-text">7.2.3.3 Dynamic和Compressed行格式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-4-%E5%8C%BA%E3%80%81%E6%AE%B5%E5%92%8C%E7%A2%8E%E7%89%87%E5%8C%BA"><span class="nav-text">7.2.4 区、段和碎片区</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-4-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E5%8C%BA%EF%BC%9F"><span class="nav-text">7.2.4.1 为什么要有区？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-4-2-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E6%AE%B5%EF%BC%9F"><span class="nav-text">7.2.4.2 为什么要有段？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-4-3-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%9C%89%E7%A2%8E%E7%89%87%E5%8C%BA%EF%BC%9F"><span class="nav-text">7.2.4.3 为什么要有碎片区？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-4-4-%E5%8C%BA%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-text">7.2.4.4 区的分类</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-5-%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="nav-text">7.2.5 表空间</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-5-1-%E7%8B%AC%E7%AB%8B%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="nav-text">7.2.5.1 独立表空间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-2-5-2-%E7%B3%BB%E7%BB%9F%E8%A1%A8%E7%A9%BA%E9%97%B4"><span class="nav-text">7.2.5.2 系统表空间</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">7.3 索引的创建和设计原则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-1-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%A3%B0%E6%98%8E%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-text">7.3.1 索引的声明和使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-1-%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%86%E7%B1%BB"><span class="nav-text">7.3.1.1 索引的分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-2-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="nav-text">7.3.1.2 创建索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-1-3-%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="nav-text">7.3.1.3 删除索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-2-MySQL8%E7%B4%A2%E5%BC%95%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-text">7.3.2 MySQL8索引的新特性</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-1-%E6%94%AF%E6%8C%81%E9%99%8D%E5%BA%8F%E7%B4%A2%E5%BC%95"><span class="nav-text">7.3.2.1 支持降序索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-2-2-%E9%9A%90%E8%97%8F%E7%B4%A2%E5%BC%95"><span class="nav-text">7.3.2.2 隐藏索引</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-3-3-%E7%B4%A2%E5%BC%95%E7%9A%84%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">7.3.3 索引的设计原则</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">7.3.3.1 数据准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-2-%E9%80%82%E5%90%88%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">7.3.3.2 适合创建索引的情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-3-%E9%99%90%E5%88%B6%E7%B4%A2%E5%BC%95%E7%9A%84%E6%95%B0%E7%9B%AE"><span class="nav-text">7.3.3.3 限制索引的数目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-3-3-4-%E4%B8%8D%E9%80%82%E5%90%88%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">7.3.3.4 不适合创建索引的情况</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-4-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="nav-text">7.4 性能分析工具和使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E4%BC%98%E5%8C%96%E6%AD%A5%E9%AA%A4"><span class="nav-text">7.4.1 数据库服务器的优化步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-2-%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E5%8F%82%E6%95%B0"><span class="nav-text">7.4.2 查看系统性能参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-3-%E7%BB%9F%E8%AE%A1SQL%E7%9A%84%E6%9F%A5%E8%AF%A2%E6%88%90%E6%9C%AC%EF%BC%9Alast-query-cos"><span class="nav-text">7.4.3 统计SQL的查询成本：last_query_cos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-4-%E5%AE%9A%E4%BD%8D%E6%89%A7%E8%A1%8C%E6%85%A2%E7%9A%84-SQL%EF%BC%9A%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">7.4.4 定位执行慢的 SQL：慢查询日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-1-%E5%BC%80%E5%90%AF%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E5%8F%82%E6%95%B0"><span class="nav-text">7.4.4.1 开启慢查询日志参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-2-%E6%9F%A5%E7%9C%8B%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%95%B0%E7%9B%AE"><span class="nav-text">7.4.4.2 查看慢查询数目</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-3-%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="nav-text">7.4.4.3 案例演示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-4-%E6%B5%8B%E8%AF%95%E5%8F%8A%E5%88%86%E6%9E%90"><span class="nav-text">7.4.4.4 测试及分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-5-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7mysqldumslow"><span class="nav-text">7.4.4.5 慢查询日志分析工具mysqldumslow</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-6-%E5%85%B3%E9%97%AD%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">7.4.4.6 关闭慢查询日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-4-7-%E5%88%A0%E9%99%A4%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">7.4.4.7 删除查询日志</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-5-%E6%9F%A5%E7%9C%8B-SQL-%E6%89%A7%E8%A1%8C%E6%88%90%E6%9C%AC%EF%BC%9ASHOW-PROFILE"><span class="nav-text">7.4.5 查看 SQL 执行成本：SHOW PROFILE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-6-%E5%88%86%E6%9E%90%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%EF%BC%9AEXPLAIN"><span class="nav-text">7.4.6  分析查询语句：EXPLAIN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-6-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">7.4.6.1 概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-6-2-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">7.4.6.2 基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-6-3-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">7.4.6.3 数据准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-6-4-EXPLAIN%E5%90%84%E5%88%97%E4%BD%9C%E7%94%A8"><span class="nav-text">7.4.6.4 EXPLAIN各列作用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-table"><span class="nav-text">1.table</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-id"><span class="nav-text">2.id</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-select-type"><span class="nav-text">3.select_type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-partitions-%E5%8F%AF%E7%95%A5-%E5%8C%B9%E9%85%8D%E7%9A%84%E5%88%86%E5%8C%BA%E4%BF%A1%E6%81%AF"><span class="nav-text">4. partitions (可略) :匹配的分区信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-type"><span class="nav-text">5. type</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-possible-keys%E5%92%8Ckey"><span class="nav-text">6. possible_keys和key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-key-len"><span class="nav-text">7. key_len</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-ref"><span class="nav-text">8. ref</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-rows"><span class="nav-text">9. rows</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-filtered"><span class="nav-text">10.filtered</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-Extra"><span class="nav-text">11.Extra</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-%E5%B0%8F%E7%BB%93"><span class="nav-text">12.小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-7-EXPLAIN%E7%9A%84%E8%BF%9B%E4%B8%80%E6%AD%A5%E4%BD%BF%E7%94%A8"><span class="nav-text">7.4.7 EXPLAIN的进一步使用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-7-1-EXPLAIN%E5%9B%9B%E7%A7%8D%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F"><span class="nav-text">7.4.7.1 EXPLAIN四种输出格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E4%BC%A0%E7%BB%9F%E6%A0%BC%E5%BC%8F"><span class="nav-text">1. 传统格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-JSON%E6%A0%BC%E5%BC%8F"><span class="nav-text">2. JSON格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-TREE%E6%A0%BC%E5%BC%8F"><span class="nav-text">3. TREE格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E5%8F%AF%E8%A7%86%E5%8C%96%E8%BE%93%E5%87%BA"><span class="nav-text">4. 可视化输出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-7-2-SHOW-WARNINGS%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">7.4.7.2 SHOW WARNINGS的使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-8-%E5%88%86%E6%9E%90%E4%BC%98%E5%8C%96%E5%99%A8%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%EF%BC%9Atrace"><span class="nav-text">7.4.8 分析优化器执行计划：trace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-9-MySQL%E7%9B%91%E6%8E%A7%E5%88%86%E6%9E%90%E8%A7%86%E5%9B%BE-sys-schema"><span class="nav-text">7.4.9 MySQL监控分析视图-sys schema</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-9-1-Sys-schema%E8%A7%86%E5%9B%BE%E6%91%98%E8%A6%81"><span class="nav-text">7.4.9.1 Sys schema视图摘要</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-4-9-2-Sys-schema%E8%A7%86%E5%9B%BE%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">7.4.9.2 Sys schema视图使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-4-10-%E5%B0%8F%E7%BB%93"><span class="nav-text">7.4.10 小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-5-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E5%92%8C%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-text">7.5 索引优化和查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">7.5.1 数据准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-2-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%A1%88%E4%BE%8B"><span class="nav-text">7.5.2 索引失效案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-1-%E5%85%A8%E5%80%BC%E5%8C%B9%E9%85%8D"><span class="nav-text">7.5.2.1 全值匹配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-2-%E6%9C%80%E4%BD%B3%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99"><span class="nav-text">7.5.2.2 最佳左前缀法则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-3-%E4%B8%BB%E9%94%AE%E6%8F%92%E5%85%A5%E9%A1%BA%E5%BA%8F"><span class="nav-text">7.5.2.3 主键插入顺序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-4-%E8%AE%A1%E7%AE%97%E3%80%81%E5%87%BD%E6%95%B0%E3%80%81%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%EF%BC%88%E8%87%AA%E5%8A%A8%E6%88%96%E6%89%8B%E5%8A%A8%EF%BC%89%E5%AF%BC%E8%87%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.4 计算、函数、类型转换（自动或手动）导致索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-5-%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2%E5%AF%BC%E8%87%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.5 类型转换导致索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-6-%E8%8C%83%E5%9B%B4%E6%9D%A1%E4%BB%B6%E5%8F%B3%E8%BE%B9%E7%9A%84%E5%88%97%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.6 范围条件右边的列索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-7-%E4%B8%8D%E7%AD%89%E4%BA%8E%EF%BC%88-x3D-%E6%88%96%E8%80%85-lt-gt-%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.7 不等于（!&#x3D;或者&lt;&gt;)索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-8-is-null%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95%EF%BC%8Cis-not-null%E6%97%A0%E6%B3%95%E4%BD%BF%E7%94%A8%E7%B4%A2%E5%BC%95"><span class="nav-text">7.5.2.8 is null可以使用索引，is not null无法使用索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-9-like%E4%BB%A5%E9%80%9A%E9%85%8D%E7%AC%A6-%E5%BC%80%E5%A4%B4%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.9 like以通配符%开头索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-10-OR%E5%89%8D%E5%90%8E%E5%AD%98%E5%9C%A8%E9%9D%9E%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%97%EF%BC%8C%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88"><span class="nav-text">7.5.2.10 OR前后存在非索引的列，索引失效</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-11-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86%E7%BB%9F%E4%B8%80%E4%BD%BF%E7%94%A8uf8mb4"><span class="nav-text">7.5.2.11 数据库和表的字符集统一使用uf8mb4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-2-12-%E7%BB%83%E4%B9%A0%E5%8F%8A%E4%B8%80%E8%88%AC%E6%80%A7%E5%BB%BA%E8%AE%AE"><span class="nav-text">7.5.2.12 练习及一般性建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-3-%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.3 关联查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">7.5.3.1 数据准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-2-%E9%87%87%E7%94%A8%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5"><span class="nav-text">7.5.3.2 采用左外连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-3-%E9%87%87%E7%94%A8%E5%86%85%E8%BF%9E%E6%8E%A5"><span class="nav-text">7.5.3.3 采用内连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-4-join%E8%AF%AD%E5%8F%A5%E5%A4%84%E7%90%86"><span class="nav-text">7.5.3.4 join语句处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%A9%B1%E5%8A%A8%E8%A1%A8%E5%92%8C%E8%A2%AB%E9%A9%B1%E5%8A%A8%E8%A1%A8"><span class="nav-text">1.驱动表和被驱动表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-Simple-Nested-Loop-Join-%E7%AE%80%E5%8D%95%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E8%BF%9E%E6%8E%A5"><span class="nav-text">2.Simple Nested-Loop Join(简单嵌套循环连接)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-Index-Nested-Loop-Join-%E7%B4%A2%E5%BC%95%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E8%BF%9E%E6%8E%A5"><span class="nav-text">3.Index Nested-Loop Join(索引嵌套循环连接)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-Block-Nested-Loop-Join-%E5%9D%97%E5%B5%8C%E5%A5%97%E5%BE%AA%E7%8E%AF%E8%BF%9E%E6%8E%A5"><span class="nav-text">4.Block Nested-Loop Join(块嵌套循环连接)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-3-5-%E5%B0%8F%E7%BB%93"><span class="nav-text">7.5.3.5 小结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-Hash-Join"><span class="nav-text">6.Hash Join</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-4-%E5%AD%90%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.4 子查询优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-5-%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.5 排序优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-5-1-%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.5.1 排序优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-5-2-%E6%B5%8B%E8%AF%95"><span class="nav-text">7.5.5.2 测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-5-3-%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%88%98"><span class="nav-text">7.5.5.3 案例实战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-5-4-filesort%E7%AE%97%E6%B3%95%EF%BC%9A%E5%8F%8C%E8%B7%AF%E6%8E%92%E5%BA%8F%E5%92%8C%E5%8D%95%E8%B7%AF%E6%8E%92%E5%BA%8F"><span class="nav-text">7.5.5.4 filesort算法：双路排序和单路排序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-6-GROUP-BY%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.6 GROUP BY优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-7-%E4%BC%98%E5%8C%96%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2-limit%E4%BC%98%E5%8C%96"><span class="nav-text">7.5.7 优化分页查询(limit优化)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-8-%E4%BC%98%E5%85%88%E8%80%83%E8%99%91%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95"><span class="nav-text">7.5.8 优先考虑覆盖索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-8-1-%E4%BB%80%E4%B9%88%E6%98%AF%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%EF%BC%9F"><span class="nav-text">7.5.8.1 什么是覆盖索引？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-8-2-%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E7%9A%84%E5%88%A9%E5%BC%8A"><span class="nav-text">7.5.8.2 覆盖索引的利弊</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-9-%E5%A6%82%E4%BD%95%E7%BB%99%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="nav-text">7.5.9 如何给字符串添加索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-9-1-%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="nav-text">7.5.9.1 前缀索引</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-9-2-%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95%E5%AF%B9%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-text">7.5.9.2 前缀索引对覆盖索引的影响</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-9-3-%E6%8B%93%E5%B1%95%E5%86%85%E5%AE%B9"><span class="nav-text">7.5.9.3 拓展内容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-10-%E7%B4%A2%E5%BC%95%E4%B8%8B%E6%8E%A8"><span class="nav-text">7.5.10 索引下推</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-10-1-%E4%BD%BF%E7%94%A8%E5%89%8D%E5%90%8E%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="nav-text">7.5.10.1 使用前后的对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-10-2-ICP%E7%9A%84%E5%BC%80%E5%90%AF-x2F-%E5%85%B3%E9%97%AD"><span class="nav-text">7.5.10.2 ICP的开启&#x2F;关闭</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-10-3-ICP%E4%BD%BF%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">7.5.10.3 ICP使用案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-10-4-%E5%BC%80%E5%90%AF%E5%92%8C%E5%85%B3%E9%97%ADICP%E7%9A%84%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%94"><span class="nav-text">7.5.10.4 开启和关闭ICP的性能对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-10-5-ICP%E7%9A%84%E4%BD%BF%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="nav-text">7.5.10.5 ICP的使用条件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-11-%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95-vs-%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95"><span class="nav-text">7.5.11 普通索引 vs 唯一索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-11-1-%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B"><span class="nav-text">7.5.11.1 查询过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-11-2-%E6%9B%B4%E6%96%B0%E8%BF%87%E7%A8%8B"><span class="nav-text">7.5.11.2 更新过程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-11-3-change-buffer%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">7.5.11.3 change buffer的使用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-5-12-%E5%85%B6%E5%AE%83%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-text">7.5.12 其它查询优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-12-1-EXISTS-%E5%92%8C-IN-%E7%9A%84%E5%8C%BA%E5%88%86"><span class="nav-text">7.5.12.1 EXISTS 和 IN 的区分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-12-2-COUNT-%E4%B8%8ECOUNT-%E5%85%B7%E4%BD%93%E5%AD%97%E6%AE%B5-%E6%95%88%E7%8E%87"><span class="nav-text">7.5.12.2 COUNT(*)与COUNT(具体字段)效率</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-12-3-%E5%85%B3%E4%BA%8ESELECT"><span class="nav-text">7.5.12.3 关于SELECT(*)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-12-4-LIMIT-1-%E5%AF%B9%E4%BC%98%E5%8C%96%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-text">7.5.12.4 LIMIT 1 对优化的影响</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-5-12-5-%E5%A4%9A%E4%BD%BF%E7%94%A8COMMIT"><span class="nav-text">7.5.12.5 多使用COMMIT</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-6-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AE%BE%E8%AE%A1%E8%A7%84%E8%8C%83"><span class="nav-text">7.6 数据库的设计规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="nav-text">7.6.1 为什么需要数据库设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-2-%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.2 范式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-2-1-%E8%8C%83%E5%BC%8F%E7%AE%80%E4%BB%8B"><span class="nav-text">7.6.2.1 范式简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-2-2-%E8%8C%83%E5%BC%8F%E9%83%BD%E5%8C%85%E6%8B%AC%E5%93%AA%E4%BA%9B"><span class="nav-text">7.6.2.2 范式都包括哪些</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-6-3-%E9%94%AE%E5%92%8C%E7%9B%B8%E5%85%B3%E5%B1%9E%E6%80%A7%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="nav-text">7.6.6.3 键和相关属性的概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-6-4-%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.6.4 第一范式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-6-5-%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.6.5 第二范式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-6-6-%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.6.6 第三范式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-6-7-%E5%B0%8F%E7%BB%93"><span class="nav-text">7.6.6.7 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-3-%E5%8F%8D%E8%8C%83%E5%BC%8F%E5%8C%96"><span class="nav-text">7.6.3 反范式化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">7.6.3.1 概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-2-%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B"><span class="nav-text">7.6.3.2 应用案例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-3-%E5%8F%8D%E8%8C%83%E5%BC%8F%E7%9A%84%E6%96%B0%E9%97%AE%E9%A2%98"><span class="nav-text">7.6.3.3 反范式的新问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-3-4-%E5%8F%8D%E8%8C%83%E5%BC%8F%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">7.6.3.4 反范式的适用场景</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-4-BCNF-%E5%B7%B4%E6%96%AF%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.4 BCNF(巴斯范式)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-4-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">7.6.4.1 概述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-6-4-2-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-text">7.6.4.2 案例分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-5-%E7%AC%AC%E5%9B%9B%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.5 第四范式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-6-6-%E7%AC%AC%E4%BA%94%E8%8C%83%E5%BC%8F%E3%80%81%E5%9F%9F%E9%94%AE%E8%8C%83%E5%BC%8F"><span class="nav-text">7.6.6 第五范式、域键范式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-7-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%85%B6%E5%AE%83%E8%B0%83%E4%BC%98%E7%AD%96%E7%95%A5"><span class="nav-text">7.7 数据库其它调优策略</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-%E4%BA%8B%E5%8A%A1"><span class="nav-text">8.事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E4%BA%8B%E5%8A%A1%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-text">8.1 事务基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E6%A6%82%E8%BF%B0"><span class="nav-text">8.1.1 数据库事务概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-1-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%94%AF%E6%8C%81%E6%83%85%E5%86%B5"><span class="nav-text">8.1.1.1 存储引擎支持情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-2-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">8.1.1.2 基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-3-%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E7%89%B9%E6%80%A7"><span class="nav-text">8.1.1.3 事务的ACID特性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-1-4-%E4%BA%8B%E5%8A%A1%E7%9A%84%E7%8A%B6%E6%80%81"><span class="nav-text">8.1.1.4 事务的状态</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%90%E4%BA%A4%E7%9A%84%EF%BC%88committed%EF%BC%89"><span class="nav-text">提交的（committed）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1"><span class="nav-text">8.1.2 如何使用事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-1-%E6%98%BE%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">8.1.2.1 显式事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-2-%E9%9A%90%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="nav-text">8.1.2.2 隐式事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-3-%E9%9A%90%E5%BC%8F%E6%8F%90%E4%BA%A4%E6%95%B0%E6%8D%AE%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-text">8.1.2.3 隐式提交数据的情况</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%9A%E4%B9%89%E8%AF%AD%E8%A8%80-Data-definition-language%EF%BC%8C%E7%BC%A9%E5%86%99%E4%B8%BA-DDL"><span class="nav-text">数据定义语言(Data definition language，缩写为:DDL)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9A%90%E5%BC%8F%E4%BD%BF%E7%94%A8%E6%88%96%E4%BF%AE%E6%94%B9mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%A1%A8"><span class="nav-text">隐式使用或修改mysql数据库中的表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%88%96%E5%85%B3%E4%BA%8E%E9%94%81%E5%AE%9A%E7%9A%84%E8%AF%AD%E5%8F%A5"><span class="nav-text">事务控制或关于锁定的语句</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-4-%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B1%EF%BC%9A%E6%8F%90%E4%BA%A4%E4%B8%8E%E5%9B%9E%E6%BB%9A"><span class="nav-text">8.1.2.4 使用举例1：提交与回滚</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-5-%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B2%EF%BC%9A%E6%B5%8B%E8%AF%95%E4%B8%8D%E6%94%AF%E6%8C%81%E4%BA%8B%E5%8A%A1%E7%9A%84engine"><span class="nav-text">8.1.2.5 使用举例2：测试不支持事务的engine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-2-6-%E4%BD%BF%E7%94%A8%E4%B8%BE%E4%BE%8B3%EF%BC%9ASAVEPOINT"><span class="nav-text">8.1.2.6 使用举例3：SAVEPOINT</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">8.1.3 事务隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-1-%E6%95%B0%E6%8D%AE%E5%87%86%E5%A4%87"><span class="nav-text">8.1.3.1 数据准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-2-%E6%95%B0%E6%8D%AE%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="nav-text">8.1.3.2 数据并发问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-3-SQL%E4%B8%AD%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">8.1.3.3 SQL中的四种隔离级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-4-MySQL%E6%94%AF%E6%8C%81%E7%9A%84%E5%9B%9B%E7%A7%8D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">8.1.3.4 MySQL支持的四种隔离级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-5-%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">8.1.3.5 如何设置事务的隔离级别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-1-3-6-%E4%B8%8D%E5%90%8C%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%BE%E4%BE%8B"><span class="nav-text">8.1.3.6 不同隔离级别举例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA1-%E8%AF%BB%E6%9C%AA%E6%8F%90%E4%BA%A4%E4%B9%8B%E8%84%8F%E8%AF%BB"><span class="nav-text">演示1. 读未提交之脏读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA2%EF%BC%9A%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4"><span class="nav-text">演示2：读已提交</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA3%EF%BC%9A%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB"><span class="nav-text">演示3：可重复读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%BC%94%E7%A4%BA4%EF%BC%9A%E5%B9%BB%E8%AF%BB"><span class="nav-text">演示4：幻读</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-4-%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%B8%B8%E8%A7%81%E5%88%86%E7%B1%BB"><span class="nav-text">8.1.4 事务的常见分类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-MySQL%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97"><span class="nav-text">8.2 MySQL事务日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-redo%E6%97%A5%E5%BF%97"><span class="nav-text">8.2.1 redo日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81redo%E6%97%A5%E5%BF%97"><span class="nav-text">8.2.1.1 为什么需要redo日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-2-redo%E6%97%A5%E5%BF%97%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-text">8.2.1.2 redo日志的优缺点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-3-redo%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-text">8.2.1.3 redo的组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-4-redo%E7%9A%84%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B"><span class="nav-text">8.2.1.4 redo的整体流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-5-redo-log%E7%9A%84%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="nav-text">8.2.1.5 redo log的刷盘策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-6-%E4%B8%8D%E5%90%8C%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5%E6%BC%94%E7%A4%BA"><span class="nav-text">8.2.1.6 不同刷盘策略演示</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-7-%E5%86%99%E5%85%A5redo-log-buffer%E8%BF%87%E7%A8%8B"><span class="nav-text">8.2.1.7 写入redo log buffer过程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E8%A1%A5%E5%85%85%E6%A6%82%E5%BF%B5-Mini-Transaction"><span class="nav-text">1.补充概念:Mini-Transaction</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-redo-%E6%97%A5%E5%BF%97%E5%86%99%E5%85%A5log-buffer"><span class="nav-text">2. redo 日志写入log buffer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-redo-log-block%E7%9A%84%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-text">3. redo log block的结构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-8-redo-log-file"><span class="nav-text">8.2.1.8 redo log file</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%9B%B8%E5%85%B3%E5%8F%82%E6%95%B0%E8%AE%BE%E7%BD%AE"><span class="nav-text">1.相关参数设置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E7%BB%84"><span class="nav-text">2. 日志文件组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-checkpoint"><span class="nav-text">3. checkpoint</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-1-9-redo-log%E5%B0%8F%E7%BB%93"><span class="nav-text">8.2.1.9 redo log小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-undo%E6%97%A5%E5%BF%97"><span class="nav-text">8.2.2 undo日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-1-%E5%A6%82%E4%BD%95%E7%90%86%E8%A7%A3Undo%E6%97%A5%E5%BF%97"><span class="nav-text">8.2.2.1 如何理解Undo日志</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-2-UNDO%E6%97%A5%E5%BF%97%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="nav-text">8.2.2.2 UNDO日志的作用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A81%EF%BC%9A%E5%9B%9E%E6%BB%9A%E6%95%B0%E6%8D%AE"><span class="nav-text">作用1：回滚数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BD%9C%E7%94%A82%EF%BC%9AMVCC"><span class="nav-text">作用2：MVCC</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-3-undo%E7%9A%84%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-text">8.2.2.3 undo的存储结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%9B%9E%E6%BB%9A%E6%AE%B5%E4%B8%8Eundo%E9%A1%B5"><span class="nav-text">1. 回滚段与undo页</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%9B%9E%E6%BB%9A%E6%AE%B5%E4%B8%8E%E4%BA%8B%E5%8A%A1"><span class="nav-text">2.回滚段与事务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%9B%9E%E6%BB%9A%E6%AE%B5%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%B1%BB"><span class="nav-text">3. 回滚段中的数据分类</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-4-undo%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="nav-text">8.2.2.4 undo的类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-2-5-undo%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">8.2.2.5 undo的生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%AE%80%E8%A6%81%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="nav-text">1.简要生成过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E8%AF%A6%E7%BB%86%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="nav-text">2. 详细生成过程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-undo-log%E6%98%AF%E5%A6%82%E4%BD%95%E5%9B%9E%E6%BB%9A%E7%9A%84"><span class="nav-text">3. undo log是如何回滚的</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-undo-log%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-text">4. undo log的删除</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-2-3-%E5%B0%8F%E7%BB%93"><span class="nav-text">8.2.3 小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E9%94%81"><span class="nav-text">8.3 锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-%E6%A6%82%E8%BF%B0"><span class="nav-text">8.3.1 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-MySQL%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1%E8%AE%BF%E9%97%AE%E7%9B%B8%E5%90%8C%E8%AE%B0%E5%BD%95"><span class="nav-text">8.3.2 MySQL并发事务访问相同记录</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-2-1-%E8%AF%BB-%E8%AF%BB%E6%83%85%E5%86%B5"><span class="nav-text">8.3.2.1 读-读情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-2-2-%E5%86%99-%E5%86%99%E6%83%85%E5%86%B5"><span class="nav-text">8.3.2.2 写-写情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-2-3-%E8%AF%BB-%E5%86%99%E6%88%96%E5%86%99-%E8%AF%BB%E6%83%85%E5%86%B5"><span class="nav-text">8.3.2.3 读-写或写-读情况</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-2-4-%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">8.3.2.4 并发问题的解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-3-%E9%94%81%E7%9A%84%E4%B8%8D%E5%90%8C%E8%A7%92%E5%BA%A6%E5%88%86%E7%B1%BB"><span class="nav-text">8.3.3 锁的不同角度分类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-1-%E4%BB%8E%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E7%9A%84%E7%B1%BB%E5%9E%8B%E5%88%92%E5%88%86%EF%BC%9A%E8%AF%BB%E9%94%81%E3%80%81%E5%86%99%E9%94%81"><span class="nav-text">8.3.3.1 从数据操作的类型划分：读锁、写锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-2-%E4%BB%8E%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C%E7%9A%84%E7%B2%92%E5%BA%A6%E5%88%92%E5%88%86%EF%BC%9A%E8%A1%A8%E7%BA%A7%E9%94%81%E3%80%81%E9%A1%B5%E7%BA%A7%E9%94%81%E3%80%81%E8%A1%8C%E9%94%81"><span class="nav-text">8.3.3.2 从数据操作的粒度划分：表级锁、页级锁、行锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-3-2-1-%E8%A1%A8%E9%94%81-Table-Lock"><span class="nav-text">8.3.3.2.1 表锁(Table Lock)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A0-%E8%A1%A8%E7%BA%A7%E5%88%AB%E7%9A%84S%E9%94%81%E3%80%81X%E9%94%81"><span class="nav-text">① 表级别的S锁、X锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A1-%E6%84%8F%E5%90%91%E9%94%81-%EF%BC%88intention-lock%EF%BC%89"><span class="nav-text">② 意向锁 （intention lock）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A2-%E8%87%AA%E5%A2%9E%E9%94%81%EF%BC%88AUTO-INC%E9%94%81%EF%BC%89"><span class="nav-text">③ 自增锁（AUTO-INC锁）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A3-%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81%EF%BC%88MDL%E9%94%81%EF%BC%89"><span class="nav-text">④ 元数据锁（MDL锁）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-3-2-2-InnoDB%E4%B8%AD%E7%9A%84%E8%A1%8C%E9%94%81"><span class="nav-text">8.3.3.2.2 InnoDB中的行锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A0-%E8%AE%B0%E5%BD%95%E9%94%81%EF%BC%88Record-Locks%EF%BC%89"><span class="nav-text">① 记录锁（Record Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A1-%E9%97%B4%E9%9A%99%E9%94%81%EF%BC%88Gap-Locks%EF%BC%89"><span class="nav-text">② 间隙锁（Gap Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A2-%E4%B8%B4%E9%94%AE%E9%94%81%EF%BC%88Next-Key-Locks%EF%BC%89"><span class="nav-text">③ 临键锁（Next-Key Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%91%A3-%E6%8F%92%E5%85%A5%E6%84%8F%E5%90%91%E9%94%81%EF%BC%88Insert-Intention-Locks%EF%BC%89"><span class="nav-text">④ 插入意向锁（Insert Intention Locks）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#8-3-3-2-3-%E9%A1%B5%E9%94%81"><span class="nav-text">8.3.3.2.3 页锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-3-%E4%BB%8E%E5%AF%B9%E5%BE%85%E9%94%81%E7%9A%84%E6%80%81%E5%BA%A6%E5%88%92%E5%88%86-%E4%B9%90%E8%A7%82%E9%94%81%E3%80%81%E6%82%B2%E8%A7%82%E9%94%81"><span class="nav-text">8.3.3.3 从对待锁的态度划分:乐观锁、悲观锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%82%B2%E8%A7%82%E9%94%81%EF%BC%88Pessimistic-Locking%EF%BC%89"><span class="nav-text">1. 悲观锁（Pessimistic Locking）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%B9%90%E8%A7%82%E9%94%81%EF%BC%88Optimistic-Locking%EF%BC%89"><span class="nav-text">2. 乐观锁（Optimistic Locking）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E4%B8%A4%E7%A7%8D%E9%94%81%E7%9A%84%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">3. 两种锁的适用场景</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-4-%E6%8C%89%E5%8A%A0%E9%94%81%E7%9A%84%E6%96%B9%E5%BC%8F%E5%88%92%E5%88%86%EF%BC%9A%E6%98%BE%E5%BC%8F%E9%94%81%E3%80%81%E9%9A%90%E5%BC%8F%E9%94%81"><span class="nav-text">8.3.3.4 按加锁的方式划分：显式锁、隐式锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E9%9A%90%E5%BC%8F%E9%94%81"><span class="nav-text">1.隐式锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%98%BE%E5%BC%8F%E9%94%81"><span class="nav-text">2.显式锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-5-%E5%85%B6%E5%AE%83%E9%94%81%E4%B9%8B%EF%BC%9A%E5%85%A8%E5%B1%80%E9%94%81"><span class="nav-text">8.3.3.5 其它锁之：全局锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-3-3-6-%E5%85%B6%E5%AE%83%E9%94%81%E4%B9%8B%EF%BC%9A%E6%AD%BB%E9%94%81"><span class="nav-text">8.3.3.6 其它锁之：死锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%A6%82%E5%BF%B5"><span class="nav-text">1.概念</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%BA%A7%E7%94%9F%E6%AD%BB%E9%94%81%E7%9A%84%E5%BF%85%E8%A6%81%E6%9D%A1%E4%BB%B6"><span class="nav-text">2.产生死锁的必要条件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%AD%BB%E9%94%81"><span class="nav-text">3.如何处理死锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E5%A6%82%E4%BD%95%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="nav-text">4.如何避免死锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-4-%E9%94%81%E7%9A%84%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-text">8.3.4 锁的内存结构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90%EF%BC%9A"><span class="nav-text">结构解析：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-5-%E9%94%81%E7%9B%91%E6%8E%A7"><span class="nav-text">8.3.5 锁监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-4-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%EF%BC%88MVCC%EF%BC%89"><span class="nav-text">8.4 多版本并发控制（MVCC）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-1-%E4%BB%80%E4%B9%88%E6%98%AFMVCC"><span class="nav-text">8.4.1 什么是MVCC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-2-%E5%BF%AB%E7%85%A7%E8%AF%BB%E4%B8%8E%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="nav-text">8.4.2 快照读与当前读</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-2-1-%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="nav-text">8.4.2.1 快照读</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-2-2-%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="nav-text">8.4.2.2 当前读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-3-%E5%A4%8D%E4%B9%A0"><span class="nav-text">8.4.3 复习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-3-1-%E5%86%8D%E8%B0%88%E9%9A%94%E7%A6%BB%E7%BA%A7"><span class="nav-text">8.4.3.1 再谈隔离级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-3-2-%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5%E3%80%81Undo-Log%E7%89%88%E6%9C%AC%E9%93%BE"><span class="nav-text">8.4.3.2 隐藏字段、Undo Log版本链</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-4-MVCC%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E4%B9%8BReadView"><span class="nav-text">8.4.4 MVCC的实现原理之ReadView</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-4-1-%E4%BB%80%E4%B9%88%E6%98%AFReadView"><span class="nav-text">8.4.4.1 什么是ReadView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-4-2-%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="nav-text">8.4.4.2 设计思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-4-3-ReadView%E7%9A%84%E8%A7%84%E5%88%99"><span class="nav-text">8.4.4.3 ReadView的规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-4-4-MVCC%E6%95%B4%E4%BD%93%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="nav-text">8.4.4.4 MVCC整体操作流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-5-%E4%B8%BE%E4%BE%8B%E8%AF%B4%E6%98%8E"><span class="nav-text">8.4.5 举例说明</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-5-1-%E8%AF%BB%E5%B7%B2%E6%8F%90%E4%BA%A4%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B"><span class="nav-text">8.4.5.1 读已提交隔离级别下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-5-2-%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8B"><span class="nav-text">8.4.5.2 可重复读隔离级别下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-4-5-3-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%B9%BB%E8%AF%BB"><span class="nav-text">8.4.5.3 如何解决幻读</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-4-6-%E5%B0%8F%E7%BB%93"><span class="nav-text">8.4.6 小结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD"><span class="nav-text">9.日志与备份</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#9-1-%E5%85%B6%E5%AE%83%E6%95%B0%E6%8D%AE%E5%BA%93%E6%97%A5%E5%BF%97"><span class="nav-text">9.1 其它数据库日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-1-MySQL%E6%94%AF%E6%8C%81%E7%9A%84%E6%97%A5%E5%BF%97"><span class="nav-text">9.1.1 MySQL支持的日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-2-%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97-slow-query-log"><span class="nav-text">9.1.2 慢查询日志(slow query log)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-3-%E9%80%9A%E7%94%A8%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97-general-query-log"><span class="nav-text">9.1.3 通用查询日志(general query log)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-4-%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97-error-log"><span class="nav-text">9.1.4 错误日志(error log)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-5-%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97-bin-log"><span class="nav-text">9.1.5 二进制日志(bin log)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-6-%E5%86%8D%E8%B0%88%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97-binlog"><span class="nav-text">9.1.6 再谈二进制日志(binlog)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-7-%E4%B8%AD%E7%BB%A7%E6%97%A5%E5%BF%97-relay-log"><span class="nav-text">9.1.7  中继日志(relay log)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-text">9.2 主从复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-3-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%A4%87%E4%BB%BD%E4%B8%8E%E5%9B%9E%E5%A4%8D"><span class="nav-text">9.3 数据库的备份与回复</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="峡谷杨爹"
      src="/images/%E5%8D%9A%E5%AE%A2.webp">
  <p class="site-author-name" itemprop="name">峡谷杨爹</p>
  <div class="site-description" itemprop="description">write less, do more</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">151</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">52</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/xiaguyangdie" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xiaguyangdie" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:424793597@qq.com" title="E-Mail → mailto:424793597@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
	</div>
	<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=450 src="//music.163.com/outchain/player?type=0&id=7450004106&auto=0&height=430"></iframe>  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">峡谷杨爹</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">46:04</span>
</div>

        






<script>
  (function() {
    function leancloudSelector(url) {
      url = encodeURI(url);
      return document.getElementById(url).querySelector('.leancloud-visitors-count');
    }

    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.id);
      var title = visitors.dataset.flagTitle;

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url })))
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            leancloudSelector(url).innerText = counter.time + 1;
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              });
          } else {
              Counter('post', '/classes/Counter', { title, url, time: 1 })
                .then(response => response.json())
                .then(() => {
                  leancloudSelector(url).innerText = 1;
                })
                .catch(error => {
                  console.error('Failed to create', error);
                });
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.id);
      });

      Counter('get', '/classes/Counter?where=' + encodeURIComponent(JSON.stringify({ url: { '$in': entries } })))
        .then(response => response.json())
        .then(({ results }) => {
          for (let url of entries) {
            let target = results.find(item => item.url === url);
            leancloudSelector(url).innerText = target ? target.time : 0;
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }

    let { app_id, app_key, server_url } = {"enable":true,"app_id":"jc38mXtIY9GP4HNtOg9qT7Fo-gzGzoHsz","app_key":"yDHjFefMRYGX7YloQFcPnw78","server_url":null,"security":false};
    function fetchData(api_server) {
      var Counter = (method, url, data) => {
        return fetch(`${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : app_id,
            'X-LC-Key'    : app_key,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    }

    let api_server = app_id.slice(-9) !== '-MdYXbMMI' ? server_url : `https://${app_id.slice(0, 8).toLowerCase()}.api.lncldglobal.com`;

    if (api_server) {
      fetchData(api_server);
    } else {
      fetch('https://app-router.leancloud.cn/2/route?appId=' + app_id)
        .then(response => response.json())
        .then(({ api_server }) => {
          fetchData('https://' + api_server);
        });
    }
  })();
</script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>











<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'jc38mXtIY9GP4HNtOg9qT7Fo-gzGzoHsz',
      appKey     : 'yDHjFefMRYGX7YloQFcPnw78',
      placeholder: "说说",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
